!***********************************************************************
!  FPA1100:  CALLS FOR CIVIL PENSION OF EMPLOYEES ON SECONDMENT        *
!***********************************************************************
!       No external information management
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
!                                                                      *
! This module contains confidential and proprietary information        *
! of Oracle; it is not to be copied, reproduced, or transmitted        *
! in any form, by any means, in whole or in part, nor is it to         *
! be used for any purpose other than that for which it is              *
! expressly provided under the applicable license agreement.           *
!                                                                      *
! Copyright (C) 2006 Oracle. All Rights Reserved.                      *
!                                                                      *
!***********************************************************************
!----------------------------------------------------------------------
!
!          $Date:  2006/07/19:12:31:28                                 !
!       $Release:  HR9                                                 !
!      $Revision:  101                                                 !
!                                                                      *
!***********************************************************************


!#include 'setup01.sqc'        ! Printer and page-size initialization



!*********************************************************
BEGIN-PROCEDURE Calcul($C_Matricule,#C_Dossier,$C_Debut_Sem,$C_Fin_Sem,$E_SIRH,$Verif)
!------------------------------------------------------------------
!       Calculation of employee share for the semester
!------------------------------------------------------------------
!       IN :    $C_Matricule            Emplid
!               #C_Dossier              Record Number
!               $C_Debut_Sem            Semester Start Date
!               $C_Fin_Sem              Semester End Date
!               $E_SIRH                 Informations from HRMS
!               $Verif                  Calculation procedure is called from a "check"
!
!       OUT :
!
!*********************************************************

#ifdef debugi
    display '---------------------'
    display ' CALCUL du Semestre '
    display '---------------------'
    display 'Avant le Select : '    noline
    display 'Calcul du '            noline
    display $C_Debut_Sem            noline
    display ' au '                  noline
    display $C_Fin_Sem
#endif

!-----------------------------------------------------
! SEMESTER INFORMATIONS -> 'FPACNTRBRES_TBL'
!-----------------------------------------------------

!-- Previous instance information
let $Effdt_Prec         = ''
let $Type_Det_Prec      = ''
let $Echelon_Prec       = ''
let #Indice_Prec        = 0
let #VAT_Prec           = 0
let $Quotite_Prec       = ''
let #FracN_Prec         = 1
let #FracD_Prec         = 1
let $Statut_Prec        = ''
let $Type_Pt_Prec       = ''
let $Title_Prec         = ''

!--------------------------
! INFORMATIONS from HRMS
!--------------------------
IF $E_SIRH = 'Y'

let $sql-statement = 'FPA1100.SQC,Calcul,select,JOB'
BEGIN-SELECT On-Error=SQL-Error

J.EMPLID                                &EMPLID
J.EMPL_RCD                              &DOSSIER
{DATEOUT-PREFIX}J.EFFDT{DATEOUT-SUFFIX} &EFFDT
J.FP_SCND_TYP                           &TYPE_DET       (,1,2) ON-BREAK
                                                                        PRINT=NEVER LEVEL=1
J.FP_TITLE_NUM                          &TITLE_NUM
J.FP_STEP_CD                            &ECHELON
J.FP_INCS_IND                           &INDICE         (,+2,10) ON-BREAK
                                                                        PRINT=NEVER LEVEL=2
M.FP_POINTYP_CD                         &TYPE_POINT
P.FP_POINT_VAL                          &VALEUR
P.CURRENCY_CD                           &CURRENCY
JO.ANNUAL_RT                            &VAT            (,+2,20) ON-BREAK
                                                                        PRINT=NEVER LEVEL=3
J.FP_PT_PCT_DET                         &QUOTITE        (,+2,30) ON-BREAK
                                                                        PRINT=NEVER LEVEL=4
                                                                        BEFORE=Before-Proc($C_Debut_Sem,$C_Fin_Sem,
                                                &EMPLID,&DOSSIER,&EFFDT,&TYPE_DET,&TITLE_NUM,&ECHELON,&INDICE,
                                                &TYPE_POINT,&VALEUR,&CURRENCY,&VAT,&QUOTITE,&POSSTAT,&STATUT,&TX_AG,&TX_EMPLY,
                                                &SETID_RANK,&GRADE,&LIB_GRADE,&PRENOM,&NOM,&SECU,&CLEF,$country,$address1,$address2,
                                                $address3,$address4,$city,$num1,$num2,$house_type,$addr_field1,$addr_field2,
                                                $addr_field3,$county,$state,$postal,$geo_code,$in_city_limit,
                                                &ORG_ORIG,&ORG_ACC,
                                                $Effdt_Prec,$Type_Det_Prec,$Echelon_Prec,#Indice_Prec,#VAT_Prec,
                                                $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Statut_Prec,$Type_Pt_Prec,
                                                $Title_Prec,$E,$T,$Ech,#I,#V,$Q,#FN,#FD,$S,$TP,$TN)
J.FP_LEGALSTAT_CD                       &POSSTAT
S.FP_STATUSEE_CD                        &STATUT
T.FP_CNTRB_AGT                          &TX_AG
TE.FP_CNTRB_EMPLY                       &TX_EMPLY
J.FP_SETID_RANK                         &SETID_RANK
J.FP_RANK_CD                            &GRADE
PG.DESCR                                &LIB_GRADE
NM.FIRST_NAME                           &PRENOM
NM.LAST_NAME                            &NOM
ND.NATIONAL_ID                          &SECU
ND.SSN_KEY_FRA                          &CLEF
J.FP_SOURCE_ORG                         &ORG_ORIG
J.FP_RECEP_ORG                          &ORG_ACC

        !-- Previous "BEFORE" instance informations
        let $Effdt_Prec         = $E
        let $Type_Det_Prec      = $T
        let $Echelon_Prec       = $Ech
        let #Indice_Prec        = #I
        let #VAT_Prec           = #V
        let $Quotite_Prec       = $Q
        let #FracN_Prec         = #FN
        let #FracD_Prec         = #FD
        let $Statut_Prec        = $S
        let $Type_Pt_Prec       = $TP
        let $Title_Prec         = $TN

 
        do Get-Employee-Address ($C_Matricule,$C_Fin_Sem,$address1,$address2,$address3,$address4,$city,$num1,$num2,
        $house_type,$addr_field1,$addr_field2,$addr_field3,$geo_code,$in_city_limit,$postal,$country,$state,$county)
  
    #ifdef debugi
        display '>> Dans le Select '
        display &EFFDT          noline
        display '     '         noline
        display &TYPE_DET       noline
        display '     '         noline
        display &ECHELON        noline
        display '     '         noline
        display &INDICE         noline
        display '     '         noline
        display &QUOTITE        noline
        display '     '         noline
        display &TX_AG          noline
        display '     '         noline
        display &TX_EMPLY       noline
        display '     '         noline
        display '----------------------------------------'

        display $Effdt_Prec             noline
        display '     '                 noline
        display $Type_Det_Prec  noline
        display '     '                 noline
        display $Echelon_Prec   noline
        display '     '                 noline
        display #Indice_Prec    noline
        display '     '                 noline
        display $Quotite_Prec   noline
        display '     '                 noline
        display #FracN_Prec             noline
        display '     '                 noline
        display #FracD_Prec
        display $Statut_Prec    noline
        display $Type_Pt_Prec
        display '----------------------------------------'
   #endif

FROM    PS_JOB_JR               J,
        PS_JOB                  JO,
        PS_FPMPOINTYP_TBL       P,              ! Point value
        PS_FPAEESTATUS          S,              ! Employee status
        PS_FPMSTATUSEE_TBL      T,              ! Employee Contribution Rate
        PS_FPMCNTR_EMP_TBL      TE,             ! Employer Contribution Rate
        PS_FPMRANK_TBL          PG,             ! Grades setup
        PS_FPMSALMATRX_TBL      M,              ! Salary Grade Table
        PS_NAMES                NM,             ! Names
        PS_PERS_NID             ND              ! Personal Data 2
       ,PS_FPFAST_PERS_VW2      SCRTY           ! SQR security

!** Record Number
WHERE   J.EMPLID = $C_Matricule
and             J.EMPL_RCD = #C_Dossier

!** Semester
and             J.EFFDT <= {DATEIN-PREFIX}$C_Fin_Sem{DATEIN-SUFFIX}
and             (J.EFFDT        >= (Select Max(J2.EFFDT)
                                                from    PS_JOB_JR      J2
                                                where   J2.EMPLID = J.EMPLID
                                                and     J2.EMPL_RCD = J.EMPL_RCD
                                                and             J2.EFFDT <= {DATEIN-PREFIX}$C_Debut_Sem{DATEIN-SUFFIX})

or              J.EFFDT >= (Select Max(J2.EFFDT)                ! Hiring during semester
                                        from    PS_JOB_JR      J2
                                        where   J2.EMPLID = J.EMPLID
                                        and     J2.EMPL_RCD = J.EMPL_RCD
                                        and     (J2.EFFDT <= {DATEIN-PREFIX}$C_Fin_Sem{DATEIN-SUFFIX})))

!** Job doesn't leads to Civil Pension
and             J.FP_CIVIL_PENSION = 'N'

!** Highest sequence number
and             J.EFFSEQ = (Select max(J1.EFFSEQ)
                                        from PS_JOB_JR J1
                                        where   J1.EMPLID   = J.EMPLID
                                        and     J1.EMPL_RCD = J.EMPL_RCD
                                        and     J1.EFFDT    = J.EFFDT)
!** Point Value
and             P.FP_POINTYP_CD = M.FP_POINTYP_CD
and     P.EFF_STATUS = 'A'
and             P.EFFDT = (select Max (P1.EFFDT)
                                        from PS_FPMPOINTYP_TBL P1
                                        where   P1.FP_POINTYP_CD = P.FP_POINTYP_CD
                                        and     P1.EFFDT <=     J.EFFDT)
!** Employee status
and             S.EMPLID = J.EMPLID
and             S.EMPL_RCD = J.EMPL_RCD
and             S.EFFDT = (select max(S1.EFFDT)
                                        from PS_FPAEESTATUS S1
                                        where   S1.EMPLID = S.EMPLID
                                        and     S1.EMPL_RCD = S.EMPL_RCD
                                        and     S1.EFFDT <= J.EFFDT)

!** Employee Contribution Rate
and     T.FP_STATUSEE_CD = S.FP_STATUSEE_CD
and     T.EFF_STATUS = 'A'
and             T.EFFDT = (Select max(T1.EFFDT)
                                        from PS_FPMSTATUSEE_TBL T1
                                        where   T1.FP_STATUSEE_CD = T.FP_STATUSEE_CD
                                        and     T1.EFFDT <= J.EFFDT)

!** Employeer Contribution Rate
and             TE.EFF_STATUS = 'A'
and             TE.EFFDT = (Select max(TE1.EFFDT)
                                        from PS_FPMCNTR_EMP_TBL TE1
                                        where   TE1.EFFDT <= J.EFFDT)

!** Grade description
and     PG.FP_RANK_CD = J.FP_RANK_CD
and             PG.SETID = J.FP_SETID_RANK
and             PG.EFF_STATUS = 'A'
and             PG.EFFDT = (Select max(PG1.EFFDT)
                                        from PS_FPMRANK_TBL PG1
                                        where   PG1.FP_RANK_CD = J.FP_RANK_CD
                                        and  PG1.SETID = J.FP_SETID_RANK
                                        and             PG1.EFFDT <= J.EFFDT)
and M.FP_MATRIX_TYP = PG.FP_MATRIX_TYP
and M.FP_MATRIX_CD = PG.FP_MATRIX_CD
and M.FP_SCALE_CD = PG.FP_SCALE_CD
and M.EFF_STATUS = 'A'
and M.EFFDT = (Select max(M1.EFFDT)
                                from PS_FPMSALMATRX_TBL M1
                                where M1.FP_MATRIX_TYP = PG.FP_MATRIX_TYP
                                and   M1.FP_MATRIX_CD = PG.FP_MATRIX_CD
                                and   M1.FP_SCALE_CD = PG.FP_SCALE_CD
                                and   M1.EFFDT <= J.EFFDT)

!** Names
and NM.EMPLID = J.EMPLID
and NM.NAME_TYPE = 'PRI'
and NM.EFFDT = (SELECT MAX(NAME1.EFFDT)
                     FROM PS_NAMES NAME1
                    WHERE NAME1.EMPLID = NM.EMPLID
                      AND NAME1.NAME_TYPE = NM.NAME_TYPE
                      AND NAME1.EFFDT <= {DATEIN-PREFIX}$C_Fin_Sem{DATEIN-SUFFIX})



!** Personala Data 2
and             ND.EMPLID = J.EMPLID

!** Annual Compensation Value
and             JO.EMPLID       = J.EMPLID
and             JO.EMPL_RCD     = J.EMPL_RCD
and             JO.EFFDT        = J.EFFDT
and             JO.EFFSEQ       = J.EFFSEQ

and S.EMPLID = SCRTY.EMPLID     !SQR security
[$_SecurityClause]               !SQR security

ORDER BY J.EFFDT

END-SELECT



! Determine the last semester instance
!---------------------------------------------
let $sql-statement = 'FPA1100.SQC,Calcul,select,FPACNTRBRES_TBL'
BEGIN-Select On-Error=SQL-Error
{DATEOUT-PREFIX}R.FP_BEGIN_DT_PER{DATEOUT-SUFFIX}       &M_EFFDT
R.FP_TITLE_NUM                                                  &M_TITLE
R.FP_STEP_CD                                                    &M_ECHELON
R.FP_INCS_IND                                                   &M_INDICE
R.FP_POINT_VAL                                                  &M_VAL
R.CURRENCY_CD                                                   &M_CURRENCY
R.ANNUAL_RT                                                             &M_VAT
R.FP_PT_PCT_DET                                                 &M_QUOTITE
R.FP_FRACPYMT_NOM1                                              &M_FRACN
R.FP_FRACPYMT_DEN1                                              &M_FRACD
R.FP_STATUSEE_CD                                                &M_STATUT
R.FP_CNTRB_AGT                                                  &M_TX_AG
R.FP_CNTRB_EMPLY                                                &M_TX_EMPLY
R.FP_SETID_RANK                                                 &M_SETID_RANK
R.FP_RANK_CD                                                    &M_GRADE
R.FP_RANK_DESCR                                                 &M_LIB_GRADE
R.FIRST_NAME_SRCH                                               &M_PRENOM
R.LAST_NAME_SRCH                                                &M_NOM
R.NATIONAL_ID                                                   &M_SECU
R.SSN_KEY_FRA                                                   &M_CLEF
R.COUNTRY                                                               &M_PAYS
R.ADDRESS1                                                              &M_ADDR1
R.ADDRESS2                                                              &M_ADDR2
R.ADDRESS3                                                              &M_ADDR3
R.ADDRESS4                                                              &M_ADDR4
R.CITY                                                                  &M_CITY
R.NUM1                                                                  &M_NUM1
R.NUM2                                                                  &M_NUM2
R.HOUSE_TYPE                                                    &M_HOUSE
R.ADDR_FIELD1                                                              &M_ADDRF1
R.ADDR_FIELD2                                                              &M_ADDRF2
R.ADDR_FIELD3                                                              &M_ADDRF3
R.COUNTY                                                                &M_COMMUNE
R.STATE                                                                 &M_STATE
R.POSTAL                                                                &M_POSTAL
R.GEO_CODE                                                              &M_GEO_CODE
R.IN_CITY_LIMIT                                                 &M_IN_CITY
R.FP_SOURCE_ORG                                                 &M_ORG_ORIG
R.FP_RECEP_ORG                                                  &M_ORG_ACC

        let $M_Effdt = &M_EFFDT
        let $Devise = rtrim(&M_CURRENCY,' ')


        ! If last instance isn't the Semester End Date and isn't a Secondment End Date
        If ($M_EFFDT <> $C_Fin_Sem) AND ((&M_INDICE <> 0) OR (&M_VAT <> 0))
                display 'Derniere occurrence : ' noline
                display $M_EFFDT noline
                display $C_Fin_Sem

                do Affiche-LIS ($C_Fin_Sem,'',&M_QUOTITE,&M_TX_AG,0,0,&M_VAL,0,&M_TX_EMPLY,0)



                ! Determine point value updates (if employee has a step), employee and
                ! employer Contribution Rates for the current period (including Semester End Date)

                do Convert-To-DTU-Date($C_Fin_Sem,$C_Fin_Sem_dtu)
                do Add-Date($C_Fin_Sem_dtu,0,0,1,$Fin_Sem_dtu)
                do Convert-From-DTU-Date($Fin_Sem_dtu,$Fin_Sem)

                display ' Periode de Determina° des Ruptures : '        noline
                display &M_EFFDT        noline
                display $Fin_Sem

                let #M_VAT1 = &M_VAT

                If #M_VAT1 = 0
                        display '- Determine Rupture Point'
                        do Determine-Rupture-Point (&M_EFFDT,$Fin_Sem,$Type_Pt_Prec,&M_STATUT,
                                                                $C_Matricule,#C_Dossier,$C_Debut_Sem,$C_Fin_Sem,
                                                                &M_TITLE,&M_ECHELON,&M_INDICE,&M_VAL,&M_VAT,&M_QUOTITE,&M_FRACN,
                                                                &M_FRACD,&M_SETID_RANK,&M_GRADE,&M_LIB_GRADE,&M_PRENOM,&M_NOM,
                                                                &M_SECU,&M_CLEF,&M_PAYS,&M_ADDR1,&M_ADDR2,&M_ADDR3,&M_ADDR4,&M_CITY,&M_NUM1,
                                                                &M_NUM2,&M_HOUSE,&M_ADDRF1,&M_ADDRF2,&M_ADDRF3,&M_COMMUNE,&M_STATE,&M_POSTAL,
                                                                &M_GEO_CODE,&M_IN_CITY,&M_ORG_ORIG,&M_ORG_ACC)
                End-If

                display '-  Determine the Employee Rate break'
                do Determine-Rupture-Taux (&M_EFFDT,$Fin_Sem,$Type_Pt_Prec,&M_STATUT,
                                                        $C_Matricule,#C_Dossier,$C_Debut_Sem,$C_Fin_Sem,
                                                        &M_TITLE,&M_ECHELON,&M_INDICE,&M_VAL,&M_VAT,&M_QUOTITE,&M_FRACN,
                                                        &M_FRACD,&M_SETID_RANK,&M_GRADE,&M_LIB_GRADE,&M_PRENOM,&M_NOM,
                                                        &M_SECU,
                                                        &M_CLEF,&M_PAYS,&M_ADDR1,&M_ADDR2,&M_ADDR3,&M_ADDR4,&M_CITY,&M_NUM1,
                                                        &M_NUM2,&M_HOUSE,&M_ADDRF1,&M_ADDRF2,&M_ADDRF3,&M_COMMUNE,&M_STATE,&M_POSTAL,&M_GEO_CODE,
                                                        &M_IN_CITY,&M_ORG_ORIG,&M_ORG_ACC)

                display '- Determine the Employer Rate break'
                do Determine-Rupture-Taux-Emply (&M_EFFDT,$Fin_Sem,$Type_Pt_Prec,&M_STATUT,
                                                        $C_Matricule,#C_Dossier,$C_Debut_Sem,$C_Fin_Sem,
                                                        &M_TITLE,&M_ECHELON,&M_INDICE,&M_VAL,&M_VAT,&M_QUOTITE,&M_FRACN,
                                                        &M_FRACD,&M_SETID_RANK,&M_GRADE,&M_LIB_GRADE,&M_PRENOM,&M_NOM,
                                                        &M_SECU,
                                                        &M_CLEF,&M_PAYS,&M_ADDR1,&M_ADDR2,&M_ADDR3,&M_ADDR4,&M_CITY,&M_NUM1,
                                                        &M_NUM2,&M_HOUSE,&M_ADDRF1,&M_ADDRF2,&M_ADDRF3,&M_COMMUNE,&M_STATE,&M_POSTAL,&M_GEO_CODE,
                                                        &M_IN_CITY,&M_ORG_ORIG,&M_ORG_ACC)


                do Determine-Fin-Semestre($C_Matricule,#C_Dossier,$C_Fin_Sem,$Trouve)

                If $Trouve = 'N'
                        do Insert-Resultat('PS_FPACNTRBRES_TBL',$C_Matricule,#C_Dossier,$C_Fin_Sem,&M_TITLE,'',
                                                                $C_Debut_Sem,$C_Fin_Sem,&M_ECHELON,0,&M_VAL,0,&M_QUOTITE,
                                                                &M_FRACN,&M_FRACD,&M_STATUT,&M_TX_AG,0,&M_TX_EMPLY,0,$Devise,
                                                                &M_SETID_RANK,&M_GRADE,&M_LIB_GRADE,
                                                                'Fin Semestre',
                                                                &M_NOM,&M_SECU,&M_CLEF,&M_PAYS,&M_ADDR1,&M_ADDR2,&M_ADDR3,
                                                                &M_ADDR4,&M_CITY,&M_NUM1,&M_NUM2,&M_HOUSE,&M_ADDRF1,&M_ADDRF2,&M_ADDRF3,&M_COMMUNE,&M_STATE,
                                                                &M_POSTAL,&M_GEO_CODE,&M_IN_CITY,&M_ORG_ORIG,&M_ORG_ACC)
                End-If

        End-If

From PS_FPACNTRBRES_TBL R               ! Calls Results
     ,PS_FPFAST_PERS_VW2 SCRTY             !SQR security

!** Employee file
Where   R.EMPLID        = $C_Matricule
and     R.EMPL_RCD      = #C_Dossier

!** Semester
and     R.FP_BEGIN_DT_PER = (Select Max(R1.FP_BEGIN_DT_PER)
                             from   PS_FPACNTRBRES_TBL R1
                             where  R1.EMPLID = R.EMPLID
                             and    R1.EMPL_RCD = R.EMPL_RCD
                             and    R1.FP_BEGIN_DT_PER >= {DATEIN-PREFIX}$C_Debut_Sem{DATEIN-SUFFIX}
                             and    R1.FP_BEGIN_DT_PER <= {DATEIN-PREFIX}$C_Fin_Sem{DATEIN-SUFFIX})

and R.EMPLID = SCRTY.EMPLID     !SQR security
[$_SecurityClause]               !SQR security

END-SELECT

ELSE
!-------------------------------------------------------------
! INFORMATIONS ARE FROM AN EXTERNAL SOURCE 'FPA_EXT_INF_TBL
!-------------------------------------------------------------

END-IF


!-------------------------------------------------------------
! PREVIOUS RECORDED SEMESTER INFORMATIONS UPDATE
!-------------------------------------------------------------
display ''
display '-- MISE A JOUR DES INFOS PRECEDEMMENT STOCKEES DU SEMESTRE'


        DISPLAY '<< CAS DUNE VERIF ?: ' NOLINE
        DISPLAY $Verif

! Calculation done for check
If $Verif = 'Y'

        ! Determine highest title number for this employee during semester
        do Determine-Title-Max ($C_Matricule,#C_Dossier,$C_Debut_Sem,$Title_Max)
        display '- Title Num Max : '    noline
        display $Title_Max

End-If


let $Fin_Periode = ''
let $Prenom_Prec = ''


let $sql-statement = 'FPA1100.SQC,Calcul,select,FPACNTRBRES_TBL'
BEGIN-SELECT On-Error=SQL-Error
{DATEOUT-PREFIX}FP_BEGIN_DT_PER{DATEOUT-SUFFIX}                 &T_EFFDT
FP_TITLE_NUM                                                    &T_TITLE
FP_STEP_CD                                                      &T_ECHELON
FP_INCS_IND                                                     &T_INDICE
FP_POINT_VAL                                                    &T_VAL
CURRENCY_CD                                                     &T_CURRENCY
ANNUAL_RT                                                       &T_VAT
FP_PT_PCT_DET                                                   &T_QUOTITE
FP_FRACPYMT_NOM1                                                &T_FRACN
FP_FRACPYMT_DEN1                                                &T_FRACD
FP_STATUSEE_CD                                                  &T_STATUT
FP_CNTRB_AGT                                                    &T_TX_AG
FP_CNTRB_EMPLY                                                  &T_TX_EMPLY
FP_SETID_RANK                                                   &T_SETID_RANK
FP_RANK_CD                                                      &T_GRADE
FP_RANK_DESCR                                                   &T_LIB_GRADE
FIRST_NAME_SRCH                                                 &T_PRENOM
LAST_NAME_SRCH                                                  &T_NOM
NATIONAL_ID                                                     &T_SECU
SSN_KEY_FRA                                                     &T_CLEF
COUNTRY                                                         &T_PAYS
ADDRESS1                                                        &T_ADDR1
ADDRESS2                                                        &T_ADDR2
ADDRESS3                                                        &T_ADDR3
ADDRESS4                                                        &T_ADDR4
CITY                                                            &T_CITY
NUM1                                                            &T_NUM1
NUM2                                                            &T_NUM2
HOUSE_TYPE                                                      &T_HOUSE
ADDR_FIELD1                                                        &T_ADDRF1
ADDR_FIELD2                                                        &T_ADDRF2
ADDR_FIELD3                                                        &T_ADDRF3
COUNTY                                                          &T_COMMUNE
STATE                                                           &T_STATE
POSTAL                                                          &T_POSTAL
GEO_CODE                                                        &T_GEO_CODE
IN_CITY_LIMIT                                                   &T_IN_CITY
FP_SOURCE_ORG                                                   &T_ORG_ORIG
FP_RECEP_ORG                                                    &T_ORG_ACC

        let #T_Ind = &T_INDICE
        let #T_VAT = &T_VAT
        let $Title_Num = rtrim(&T_TITLE,' ')
        let $Devise = rtrim(&T_CURRENCY,' ')
        let $T_ORG_ACC = rtrim(&T_ORG_ACC,' ')

        DISPLAY '<< TITLE NUM : ' NOLINE
        DISPLAY $Title_Num

        let $Effdt_Occ = &T_EFFDT

        display ''
        display $Effdt_Occ
        display $C_Fin_Sem
        display 'Fin de Sem Prec ? : ' noline
        display $Prenom_Prec


        If $Verif = 'Y'
                let $Title_Num = $Title_Max
        End-If

        display '#T_Ind = ' noline
        display #T_Ind
        display '#T_Vat = ' noline
        display #T_Vat
        display '&T_VAL = ' noline
        display &T_VAL



        ! Not a Secondment End Date, not a Semester End Date
        If (#T_Ind <> 0) OR (#T_Vat <> 0)

                ! 1 Action = 1 Semester End Date
                ! => contribution calculation period End Date = Semester End Date
                If $Effdt_Occ = $C_Fin_Sem
                        let $Fin_Periode = $C_Fin_Sem
                else
                        if $Prenom_Prec <> 'Fin Semestre'
                                do Convert-To-DTU-Date($Fin_Periode,$Fin_Periode_dtu)
                                do Substr-Date($Fin_Periode_dtu,0,0,1,$Fin_Periode_sub)
                                do Convert-From-DTU-Date($Fin_Periode_sub,$Fin_Periode)
                        end-if
                End-If

                ! Employee Contribution Amount Calculation
                display 'Before contribution calc'
                do Calculs-Cotisations ($C_Matricule,#C_Dossier,&T_EFFDT,$Fin_Periode,&T_INDICE,&T_VAT,
                                                                &T_VAL,&T_QUOTITE,&T_FRACN,&T_FRACD,&T_TX_AG,&T_TX_EMPLY,$T_ORG_ACC,
                                                                #Mtt_Ag,#Mtt_Emply)

                display 'After contribution calc'

                do Affiche-LIS (&T_EFFDT,$Fin_Periode,&T_QUOTITE,&T_TX_AG,&T_INDICE,&T_VAT,&T_VAL,
                                                #Mtt_Ag,&T_TX_EMPLY,#Mtt_Emply)


                ! Current instance Update (Employee / Employer contribution amounts + period end date)
                do Update-Resultat ($C_Matricule,#C_Dossier,&T_EFFDT,$Fin_Periode,#Mtt_Ag,#Mtt_Emply)




        DISPLAY '<< TITLE NUM : ' NOLINE
        DISPLAY $Title_Num
                ! Archive record in "Calls Records"
                do Insert-Resultat('PS_FPACNTRBARC_TBL',$C_Matricule,#C_Dossier,&T_EFFDT,$Title_Num,
                                                $Fin_Periode,$C_Debut_Sem,$C_Fin_Sem,&T_ECHELON,&T_INDICE,&T_VAL,&T_VAT,
                                                &T_QUOTITE,&T_FRACN,&T_FRACD,&T_STATUT,
                                                &T_TX_AG,#Mtt_Ag,&T_TX_EMPLY,#Mtt_Emply,$Devise,
                                                &T_SETID_RANK,&T_GRADE,&T_LIB_GRADE,&T_PRENOM,&T_NOM,&T_SECU,&T_CLEF,
                                                &T_PAYS,&T_ADDR1,
                                                &T_ADDR2,&T_ADDR3,&T_ADDR4,&T_CITY,&T_NUM1,&T_NUM2,&T_HOUSE,&T_ADDRF1,
                                                &T_ADDRF2,&T_ADDRF3,&T_COMMUNE,
                                                &T_STATE,&T_POSTAL,&T_GEO_CODE,&T_IN_CITY,&T_ORG_ORIG,$T_ORG_ACC)
        End-If

        let $Fin_Periode = &T_Effdt
        let $Prenom_Prec = rtrim(&T_PRENOM,' ')


From PS_FPACNTRBRES_TBL         ! Calls Results

! Record Number
Where   EMPLID          = $C_Matricule
and             EMPL_RCD       = #C_Dossier

! Current Semester
and             FP_BEGIN_DT_SEM = {DATEIN-PREFIX}$C_Debut_Sem{DATEIN-SUFFIX}

! Order by EFFDT, descending
Order By FP_BEGIN_DT_PER        DESC

END-SELECT




!-------------------------------------------------------------
! CALLS TOTAL
!-------------------------------------------------------------

let $sql-statement = 'FPA1100.SQC,Calcul,select-SUM,FPACNTRBRES_TBL'
display 'MONTANT TOTAL DES COTISATIONS AGENT'

BEGIN-SELECT On-Error=SQL-Error
SUM(FP_AGT_AMT)         &Total
FP_TITLE_NUM            &Title
CURRENCY_CD                     &TOT_CURRENCY

        let $Devise = rtrim(&TOT_CURRENCY,' ')

        ! Check if employee contributions amounts have already been calculated for this employee / semester
        do Verif-Exist-Tot ($C_Matricule,#C_Dossier,$C_Debut_Sem,#Nb)

        ! Insert a new record in "Calls Total" with EffSeq = #Nb and Paiement = 'N'
        do Insert-Total($C_Matricule,#C_Dossier,$C_Debut_Sem,#Nb,$C_Fin_Sem,&Title,&Total,$Devise,'N')

From PS_FPACNTRBRES_TBL

! Record Number
Where   EMPLID          = $C_Matricule
and     EMPL_RCD       = #C_Dossier

! Current Semester
and             FP_BEGIN_DT_SEM = {DATEIN-PREFIX}$C_Debut_Sem{DATEIN-SUFFIX}

! No Secondment End Date
and     FP_TITLE_NUM <> ' '

Group By FP_TITLE_NUM,CURRENCY_CD

END-SELECT

END-PROCEDURE Calcul



!********************************************************************************************
BEGIN-PROCEDURE Before-Proc ($BP_Debut_Sem,$BP_Fin_Sem,$Matricule,#Dossier,$Effdt,$Type_Det,
                                                        $Title_Num,$Echelon,#Indice,$Type_Point,#Valeur,$Devise,#VAT,$Quotite,
                                                        $PosStat,$Statut,#Tx_Ag,#Tx_Emply,$Setid_Rank,$Grade,$Lib_Grade,
                                                        $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,
                                                        $Num1,$Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc,$Effdt_Prec,$Type_Det_Prec,$Echelon_Prec,
                                                        #Indice_Prec,#VAT_Prec,$Quotite_Prec,
                                                        #FracN_Prec,#FracD_Prec,$Statut_Prec,$Type_Pt_Prec,$Title_Prec,
                                                        :$E,:$T,:$Ech,:#I,:#V,:$Q,:#FN,:#FD,:$S,:$TP,:$TN)
!------------------------------------------------------------------
!       Procedure impacting all records from "ON-BREAK"
!------------------------------------------------------------------
!       IN :    Employee informations (previously selected)
!
!       OUT :           $E              Previous Effdt
!                       $T                  "    Secondment Type
!                       $Ech                "    Step
!                       #I                  "    Index
!                       #V              Annual compensation value      "
!                       $Q                  "    %PT
!                       #FN                 "    Fraction Numerator
!                       #FD                 "    Fraction Denominator
!                       $S                  "    Status
!                       $TP                 "    Point Type
!                       $TN                 "    Title Number
!
!********************************************************************************************

DISPLAY '<< TITLE NUM ENTREE BEFORE: ' noline
DISPLAY $Title_Num


do Convert-To-DTU-Date($Effdt,$Effdt_dtu)
do Convert-To-DTU-Date($BP_Debut_Sem,$BP_Debut_Sem_dtu)

!-- Determine the instance insert date in "Calls Results"
If $Effdt_dtu < $BP_Debut_Sem_dtu                       ! Semester Start Date
        let $Date_Insert = $BP_Debut_Sem

! Determine setup values (Point, Employee Contribution, Employer Contribution) at semester start date
let $sql-statement = 'FPA1100.SQC,Before-Proc,select,Parameter'
BEGIN-SELECT On-Error=SQL-Error
P.FP_POINT_VAL                                                  &VALEUR1
T.FP_CNTRB_AGT                                                  &TX_AG1
TE.FP_CNTRB_EMPLY                                               &TX_EMPLY1

        let #Valeur = &VALEUR1
        let #Tx_Ag = &TX_AG1
        let #Tx_Emply = &TX_EMPLY1


FROM    PS_FPMPOINTYP_TBL       P,              ! Point Value
                PS_FPMSTATUSEE_TBL      T,      ! Employee Contribution Rate
                PS_FPMCNTR_EMP_TBL  TE          ! Employer Contribution Rate

!** Point Value
Where   P.FP_POINTYP_CD = $Type_Point
and     P.EFF_STATUS = 'A'
and             P.EFFDT = (select Max (P1.EFFDT)
                                        from PS_FPMPOINTYP_TBL P1
                                        where   P1.FP_POINTYP_CD = P.FP_POINTYP_CD
                                        and     P1.EFFDT <=     {DATEIN-PREFIX}$BP_Debut_Sem{DATEIN-SUFFIX})

!** Employee Contribution Rate
and     T.FP_STATUSEE_CD = $Statut
and     T.EFF_STATUS = 'A'
and             T.EFFDT = (Select max(T1.EFFDT)
                                        from PS_FPMSTATUSEE_TBL T1
                                        where   T1.FP_STATUSEE_CD = T.FP_STATUSEE_CD
                                        and     T1.EFFDT <= {DATEIN-PREFIX}$BP_Debut_Sem{DATEIN-SUFFIX})

!** Employer Contribution Rate
and             TE.EFF_STATUS = 'A'
and             TE.EFFDT = (Select max(TE1.EFFDT)
                                        from PS_FPMCNTR_EMP_TBL TE1
                                        where   TE1.EFFDT <= {DATEIN-PREFIX}$BP_Debut_Sem{DATEIN-SUFFIX})
End-Select

else
        let $Date_Insert = $Effdt
End-if



display '**> Before sur : ' noline
display $Effdt noline
display $Date_Insert


! Determine compensation fraction linked to Working Time Percentage
do Determine-Fraction($Quotite,$PosStat,$Date_Insert,#FracN,#FracD)
display 'FRACN -> ' noline
display #FracN
display 'FRACD -> ' noline
display #FracD


do Get-Employee-Address ($Matricule,$Effdt,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$num1,$num2,
        $house,$adrF1,$adrF2,$adrF3,$geo_code,$in_city,$postal,$pays,$state,$commune)

display $Matricule
display $effdt
display $pays

let $in_city = ' '

!-- Employee on secondment (External or Internal )
If ($Type_Det = 'E') OR ($Type_Det = 'I')
        do Affiche-LIS ($Date_Insert,'',$Quotite,#Tx_Ag,#Indice,#VAT,#Valeur,0,#Tx_Emply,0)

        display 'AVANT INSERTION 1'
        

        ! Insert instance into table "Calls Results"
        let $sql-statement = 'FPA1100.SQC, Before-Proc, Insert, PS_FPACNTRBRES_TBL'

        BEGIN-SQL On-Error=SQL-Error            ! DateFinPeriode,Mtt Ag = 0
                INSERT INTO PS_FPACNTRBRES_TBL (EMPLID, EMPL_RCD, FP_BEGIN_DT_PER, FP_TITLE_NUM, FP_END_DT_PER,     
                           FP_BEGIN_DT_SEM, FP_END_DT_SEM, FP_STEP_CD, FP_INCS_IND, FP_POINT_VAL, ANNUAL_RT,         
                           FP_PT_PCT_DET, FP_FRACPYMT_NOM1, FP_FRACPYMT_DEN1, FP_STATUSEE_CD, FP_CNTRB_AGT,      
                           FP_AGT_AMT, FP_CNTRB_EMPLY, FP_EMPLY_AMT, CURRENCY_CD, FP_SETID_RANK, FP_RANK_CD, 
                           FP_RANK_DESCR, FIRST_NAME_SRCH, LAST_NAME_SRCH, NATIONAL_ID, SSN_KEY_FRA, COUNTRY,           
                           ADDRESS1, ADDRESS2, ADDRESS3, ADDRESS4, CITY, NUM1, NUM2, HOUSE_TYPE, ADDR_FIELD1, ADDR_FIELD2,       
                           ADDR_FIELD3, COUNTY, STATE, POSTAL, GEO_CODE, IN_CITY_LIMIT, FP_SOURCE_ORG, FP_RECEP_ORG)      

                values ($Matricule,#Dossier,{DATEIN-PREFIX}$Date_Insert{DATEIN-SUFFIX},$Title_Num,null,
                                {DATEIN-PREFIX}$BP_Debut_Sem{DATEIN-SUFFIX},{DATEIN-PREFIX}$BP_Fin_Sem{DATEIN-SUFFIX},
                                $Echelon,#Indice,#Valeur,#VAT,$Quotite,#FracN,#FracD,$Statut,
                                #Tx_Ag,0,#Tx_Emply,0,$Devise,
                                $Setid_Rank,$Grade,$Lib_Grade,$Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,
                                $Adr4,$Ville,$Num1,$Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                $Org_Orig,$Org_Acc)
        END-SQL


        DISPLAY '<< TITLE NUM : ' noline
        DISPLAY $Title_Num

        display 'APRES INSERTION 1'

        ! Employee on secondment on previous instance
        If ($Type_Det_Prec = 'E') OR ($Type_Det_Prec = 'I')

                ! Determine Point Values updates (if employee has a step),
                ! Employee / Employer Contribution Rates for the current period

                If #VAT_Prec = 0
                        display '- Determine Rupture Point'
                        do Determine-Rupture-Point ($Effdt_Prec,$Effdt,$Type_Pt_Prec,$Statut_Prec,
                                                                $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                                $Title_Num,$Echelon,#Indice_Prec,#Valeur,#VAT_Prec,
                                                                $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Setid_Rank,$Grade,$Lib_Grade,
                                                                $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                                $Org_Orig,$Org_Acc)
                End-If

                display '- Determine Rupture Taux Agent'
                do Determine-Rupture-Taux ($Effdt_Prec,$Effdt,$Type_Pt_Prec,$Statut_Prec,
                                                        $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                        $Title_Num,$Echelon,#Indice_Prec,#Valeur,#VAT_Prec,
                                                        $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Setid_Rank,$Grade,$Lib_Grade,
                                                        $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                        $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc)

                display '- Determine Rupture Taux Employeur'
                do Determine-Rupture-Taux-Emply ($Effdt_Prec,$Effdt,$Type_Pt_Prec,$Statut_Prec,
                                                        $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                        $Title_Num,$Echelon,#Indice_Prec,#Valeur,#VAT_Prec,
                                                        $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Setid_Rank,$Grade,$Lib_Grade,
                                                        $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                        $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc)

        End-if

!-- Employee not on secondment on current instance, but on secondment on previous instance
!--     = Secondment End Date
Else

        If ($Type_Det_Prec = 'E') OR ($Type_Det_Prec = 'I')

                do Affiche-LIS ($Date_Insert,'',$Quotite,#Tx_Ag,0,0,#Valeur,0,#Tx_Emply,0)


                ! Insert instance in table "Calls Results"
                let $sql-statement = 'FPA1100.SQC, Before-Proc, Insert, PS_FPACNTRBRES_TBL'

                BEGIN-SQL On-Error=SQL-Error            ! DateFinPeriode, Mtt Ag, Indice, Vat = 0
                INSERT INTO PS_FPACNTRBRES_TBL (EMPLID, EMPL_RCD, FP_BEGIN_DT_PER, FP_TITLE_NUM, FP_END_DT_PER,     
                           FP_BEGIN_DT_SEM, FP_END_DT_SEM, FP_STEP_CD, FP_INCS_IND, FP_POINT_VAL, ANNUAL_RT,         
                           FP_PT_PCT_DET, FP_FRACPYMT_NOM1, FP_FRACPYMT_DEN1, FP_STATUSEE_CD, FP_CNTRB_AGT,      
                           FP_AGT_AMT, FP_CNTRB_EMPLY, FP_EMPLY_AMT, CURRENCY_CD, FP_SETID_RANK, FP_RANK_CD, 
                           FP_RANK_DESCR, FIRST_NAME_SRCH, LAST_NAME_SRCH, NATIONAL_ID, SSN_KEY_FRA, COUNTRY,           
                           ADDRESS1, ADDRESS2, ADDRESS3, ADDRESS4, CITY, NUM1, NUM2, HOUSE_TYPE, ADDR_FIELD1, ADDR_FIELD2,       
                           ADDR_FIELD3, COUNTY, STATE, POSTAL, GEO_CODE, IN_CITY_LIMIT, FP_SOURCE_ORG, FP_RECEP_ORG)
                values ($Matricule,#Dossier,{DATEIN-PREFIX}$Date_Insert{DATEIN-SUFFIX},$Title_Num,null,
                                {DATEIN-PREFIX}$BP_Debut_Sem{DATEIN-SUFFIX},{DATEIN-PREFIX}$BP_Fin_Sem{DATEIN-SUFFIX},
                                $Echelon,0,#Valeur,0,$Quotite,#FracN,#FracD,$Statut,
                                #Tx_Ag,0,#Tx_Emply,0,$Devise,$Setid_Rank,$Grade,$Lib_Grade,
                                $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,$Org_Orig,$Org_Acc)
                END-SQL

                ! Determine Point Value updates (if employee has a step),
                ! Employee / Employer Contribution Rates for the current period

                If #VAT_Prec <> 0
                        display '- Determine Rupture Point'
                        do Determine-Rupture-Point ($Effdt_Prec,$Effdt,$Type_Pt_Prec,$Statut_Prec,
                                                                $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                                $Title_Prec,$Echelon,#Indice_Prec,#Valeur,#VAT_Prec,
                                                                $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Setid_Rank,$Grade,$Lib_Grade,
                                                                $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                                $Org_Orig,$Org_Acc)
                End-If

                display '- Determine Employee Rate break'
                do Determine-Rupture-Taux ($Effdt_Prec,$Effdt,$Type_Pt_Prec,$Statut_Prec,
                                                        $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                        $Title_Prec,$Echelon,#Indice_Prec,#Valeur,#VAT_Prec,
                                                        $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Setid_Rank,$Grade,$Lib_Grade,
                                                        $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                        $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc)

                display '- Determine Employer Rate break'
                do Determine-Rupture-Taux ($Effdt_Prec,$Effdt,$Type_Pt_Prec,$Statut_Prec,
                                                        $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                        $Title_Prec,$Echelon,#Indice_Prec,#Valeur,#VAT_Prec,
                                                        $Quotite_Prec,#FracN_Prec,#FracD_Prec,$Setid_Rank,$Grade,$Lib_Grade,
                                                        $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                        $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc)
        End-If
End-if

!-- Previous instance informations Update
let $E          =       $Date_Insert
let $T          =       $Type_Det
let $Ech        =       $Echelon
let #I          =       #Indice
let #V          =       #VAT
let $Q          =       $Quotite
let #FN         =       #FracN
let #FD         =       #FracD
let $S          =       $Statut
let $TP         =       $Type_Point
let $TN         =       $Title_Num

END-PROCEDURE   Before-Proc




!*******************************************************************
BEGIN-PROCEDURE Determine-Fraction($Quotite,$PosStat,$Effdt,:#FracN,:#FracD)
!------------------------------------------------------------------
!       Determine Compensation Fraction linked to a working time
!       percentage and a statutory position
!------------------------------------------------------------------
!       IN :    $Quotite                Working time percentage on secondment
!               $PosStat                Statutory Position
!               $Effdt                  Insert date
!
!       OUT :   #FracN                  Ppal Compensation Numerator
!               #FracD                  Ppal Compensation Denominator..
!
!*******************************************************************
let $sql-statement = 'FPA1100.SQC,Determine-Fraction,Select,FPMFRACPYMT_TBL'


BEGIN-Select On-Error=SQL-Error
FP_FRACPYMT_NOM1        &Numerateur
FP_FRACPYMT_DEN1        &Denominateur

        let #FracN = &Numerateur
        let #FracD = &Denominateur


From    PS_FPMFRACPYMT_TBL F

Where   F.FP_LEGALSTAT_CD = $PosStat
and             F.FP_PT_PCT = $Quotite
and             F.EFFDT = (Select max(F1.EFFDT)
                                        from PS_FPMFRACPYMT_TBL F1
                                        where   F1.FP_LEGALSTAT_CD = $PosStat
                                        and             F1.FP_PT_PCT = $Quotite
                                        and             F1.EFFDT <= {DATEIN-PREFIX}$Effdt{DATEIN-SUFFIX})
End-Select



END-PROCEDURE Determine-Fraction



!*******************************************************************
BEGIN-PROCEDURE
Determine-Rupture-Point ($DRP_DP,$DRP_FP,$DRP_TP,$DRP_STATUT,
                                                $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                $Title_Num,$Echelon,#Indice,#Valeur,#VAT,
                                                $Quotite,#FracN,#FracD,$Setid_Rank,$Grade,$Lib_Grade,
                                                $Prenom,$Nom,$Secu,$Clef,
                                                $Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                $Org_Orig,$Org_Acc)
!------------------------------------------------------------------
!       Determine the possible employee Point value updates
!       during a period
!------------------------------------------------------------------
!       IN :    $DRP_DP                 Period Start Date
!               $DRP_FP                 Period End Date
!               $DRP_TP                 Point Type
!               $DRP_STATUT             Employee Status
!               ...                     Informations to insert in "Calls Results"
!
!       OUT :
!
!*******************************************************************

let $sql-statement = 'FPA1100.SQC,Determine-Rupture-Point,Select,FPMPOINTYP_TBL'
BEGIN-Select On-Error=SQL-Error

{DATEOUT-PREFIX}P.EFFDT{DATEOUT-SUFFIX}         &EFFDT
P.FP_POINT_VAL                                  &VAL
P.CURRENCY_CD                                   &P_CURRENCY
T.FP_CNTRB_AGT                                  &TX_AG
TE.FP_CNTRB_EMPLY                               &TX_EMPLY

        display &VAL            noline
        display '     '         noline
        display &TX_AG          noline
        display '     '         noline
        display &EFFDT

        do Affiche-LIS (&EFFDT,'',$Quotite,&TX_AG,#Indice,#VAT,&VAL,0,&TX_EMPLY,0)
        display 'Title Num ds Deter Pt : '      noline
        display $Title_Num

        let $Devise = rtrim(&P_CURRENCY,' ')

        do Insert-Resultat('PS_FPACNTRBRES_TBL',$Matricule,#Dossier,&EFFDT,$Title_Num,'',
                                                $BP_Debut_Sem,$BP_Fin_Sem,
                                                $Echelon,#Indice,&VAL,#VAT,$Quotite,#FracN,#FracD,$DRP_STATUT,
                                                &TX_AG,0,&TX_EMPLY,0,$Devise,$Setid_Rank,$Grade,$Lib_Grade,
                                                $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                $Org_Orig,$Org_Acc)


from    PS_FPMPOINTYP_TBL P,                    ! Point Types
                PS_FPMSTATUSEE_TBL T,           ! Employee Contribution Rate
                PS_FPMCNTR_EMP_TBL TE           ! Employer Contribution Rate

!** active Point Type
where   P.FP_POINTYP_CD = $DRP_TP
and             P.EFF_STATUS = 'A'

!** Period
and             P.EFFDT > {DATEIN-PREFIX}$DRP_DP{DATEIN-SUFFIX}
and             P.EFFDT < {DATEIN-PREFIX}$DRP_FP{DATEIN-SUFFIX}

!** Last Employee Contribution Rate
and             T.FP_STATUSEE_CD = $DRP_STATUT
and             T.EFF_STATUS = 'A'
and     T.EFFDT = (Select max(T1.EFFDT)
                                        from PS_FPMSTATUSEE_TBL T1
                                        where   T1.FP_STATUSEE_CD = T.FP_STATUSEE_CD
                                        and             T1.EFFDT <= P.EFFDT)

!** Last Employer Contribution Rate
and             TE.EFF_STATUS = 'A'
and     TE.EFFDT = (Select max (TE1.EFFDT)
                                        from PS_FPMCNTR_EMP_TBL TE1
                                        where   TE1.EFFDT <= P.EFFDT)

END-Select
END-PROCEDURE Determine-Rupture-Point



!*******************************************************************
BEGIN-PROCEDURE Determine-Rupture-Taux ($DRT_DP,$DRT_FP,$DRT_TP,$DRT_STATUT,
                                                        $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                        $Title_Num,$Echelon,#Indice,#Valeur,#VAT,
                                                        $Quotite,#FracN,#FracD,$Setid_Rank,$Grade,$Lib_Grade,$Prenom,$Nom,
                                                        $Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                        $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc)
!------------------------------------------------------------------
!       Determine the possible employee contribution rate updates
!       during the period
!------------------------------------------------------------------
!       IN :    $DRT_DP                 Period Start Date
!               $DRT_FP                 Period End Date
!               $DRT_TP                 Point Type
!               $DRT_STATUT             Employee Status
!               ...                     Informations to insert in "Calls Results"
!
!       OUT :
!
!*******************************************************************
let $sql-statement = 'FPA1100.SQC,Determine-Rupture-Taux,Select,FPMSTATUSEE_TBL'


BEGIN-Select On-Error=SQL-Error
{DATEOUT-PREFIX}T.EFFDT{DATEOUT-SUFFIX}         &EFFDT
T.FP_CNTRB_AGT                                  &TX_AG
P.FP_POINT_VAL                                  &VAL
P.CURRENCY_CD                                   &TT_CURRENCY
TE.FP_CNTRB_EMPLY                               &TX_EMPLY

        display &TX_AG          noline
        display '     '         noline
        display &VAL            noline
        display '     '         noline
        display &EFFDT

        let $Exist = 'N'
        let $EFFDT = &EFFDT
        let $Devise = rtrim(&TT_CURRENCY,' ')


        do Verif-Exist-Res ($Matricule,#Dossier,$EFFDT,$Title_Num,$Exist)

        ! If no record is found at this date
        IF $Exist = 'N'
                do Affiche-LIS ($EFFDT,'',$Quotite,&TX_AG,#Indice,#VAT,&VAL,0,&TX_EMPLY,0)

                display 'Title Num ds Deter Tx : '      noline
                display $Title_Num

                do Insert-Resultat('PS_FPACNTRBRES_TBL',$Matricule,#Dossier,$EFFDT,$Title_Num,'',
                                                $BP_Debut_Sem,$BP_Fin_Sem,
                                                $Echelon,#Indice,&VAL,#VAT,$Quotite,#FracN,#FracD,$DRT_STATUT,
                                                &TX_AG,0,&TX_EMPLY,0,$Devise,$Setid_Rank,$Grade,$Lib_Grade,
                                                $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                $Org_Orig,$Org_Acc)
        END-IF

from    PS_FPMSTATUSEE_TBL T,                   ! Employee Contribution Rate
                PS_FPMPOINTYP_TBL P,            ! Point Type
                PS_FPMCNTR_EMP_TBL TE           ! Employer Contribution Rate

!** Employee Contribution Rate
Where   T.FP_STATUSEE_CD = $DRT_STATUT
and             T.EFF_STATUS = 'A'

!** Period
and             T.EFFDT > {DATEIN-PREFIX}$DRT_DP{DATEIN-SUFFIX}
and             T.EFFDT < {DATEIN-PREFIX}$DRT_FP{DATEIN-SUFFIX}

!** Last active Point Type
and             P.FP_POINTYP_CD = $DRT_TP
and             P.EFF_STATUS = 'A'
and     P.EFFDT = (Select max(P1.EFFDT)
                                        from PS_FPMPOINTYP_TBL P1
                                        where   P1.FP_POINTYP_CD = P.FP_POINTYP_CD
                                        and             P1.EFFDT <= T.EFFDT)

!** Last Employer Contribution Rate
and             TE.EFF_STATUS = 'A'
and     TE.EFFDT = (Select max (TE1.EFFDT)
                                        from PS_FPMCNTR_EMP_TBL TE1
                                        where   TE1.EFFDT <= T.EFFDT)

END-Select

END-PROCEDURE Determine-Rupture-Taux



!*******************************************************************
BEGIN-PROCEDURE Determine-Rupture-Taux-Emply ($DRTE_DP,$DRTE_FP,$DRTE_TP,$DRTE_STATUT,
                                                        $Matricule,#Dossier,$BP_Debut_Sem,$BP_Fin_Sem,
                                                        $Title_Num,$Echelon,#Indice,#Valeur,#VAT,
                                                        $Quotite,#FracN,#FracD,$Setid_Rank,$Grade,$Lib_Grade,$Prenom,$Nom,
                                                        $Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                        $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                        $Org_Orig,$Org_Acc)
!------------------------------------------------------------------
!       Determine the possible Employer Contribution rate updates
!       during the period
!------------------------------------------------------------------
!       IN :    $DRTE_DP               Period Start Date
!               $DRTE_FP               Period End Date
!               $DRTE_TP               Point Type
!               $DRTE_STATUT           Employee Status
!               ...                    Informations to insert in "Calls Results"
!
!       OUT :
!
!*******************************************************************
let $sql-statement = 'FPA1100.SQC,Determine-Rupture-Taux-Emply,Select,FPMCNTR_EMP_TBL'


BEGIN-Select On-Error=SQL-Error
{DATEOUT-PREFIX}TE.EFFDT{DATEOUT-SUFFIX}                &EFFDT
TE.FP_CNTRB_EMPLY                                                               &TX_EMPLY
T.FP_CNTRB_AGT                                                                  &TX_AG
P.FP_POINT_VAL                                                                  &VAL
P.CURRENCY_CD                                                                   &TT_CURRENCY


        display &TX_EMPLY       noline
        display '     '         noline
        display &VAL            noline
        display '     '         noline
        display &EFFDT

        let $Exist = 'N'
        let $EFFDT = &EFFDT
        let $Devise = rtrim(&TT_CURRENCY,' ')


        do Verif-Exist-Res ($Matricule,#Dossier,$EFFDT,$Title_Num,$Exist)

        ! If no records is found at this date
        IF $Exist = 'N'
                do Affiche-LIS ($EFFDT,'',$Quotite,&TX_AG,#Indice,#VAT,&VAL,0,&TX_EMPLY,0)

                display 'Title Num ds Deter Tx Emply : '        noline
                display $Title_Num

                do Insert-Resultat('PS_FPACNTRBRES_TBL',$Matricule,#Dossier,$EFFDT,$Title_Num,'',
                                                $BP_Debut_Sem,$BP_Fin_Sem,
                                                $Echelon,#Indice,&VAL,#VAT,$Quotite,#FracN,#FracD,$DRTE_STATUT,
                                                &TX_AG,0,&TX_EMPLY,0,$Devise,$Setid_Rank,$Grade,$Lib_Grade,
                                                $Prenom,$Nom,$Secu,$Clef,$Pays,$Adr1,$Adr2,$Adr3,$Adr4,$Ville,$Num1,
                                                $Num2,$House,$AdrF1,$AdrF2,$AdrF3,$Commune,$State,$Postal,$Geo_Code,$In_City,
                                                $Org_Orig,$Org_Acc)
        END-IF

from    PS_FPMSTATUSEE_TBL T,           ! Employee Contribution Rate
                PS_FPMPOINTYP_TBL P,            ! Point Types
                PS_FPMCNTR_EMP_TBL TE           ! Employer Contribution Rate

!** Employer Contribution Rate
Where   TE.EFF_STATUS = 'A'

!** Period
and             TE.EFFDT > {DATEIN-PREFIX}$DRTE_DP{DATEIN-SUFFIX}
and             TE.EFFDT < {DATEIN-PREFIX}$DRTE_FP{DATEIN-SUFFIX}

!** Last active Point Type
and             P.FP_POINTYP_CD = $DRTE_TP
and             P.EFF_STATUS = 'A'
and     P.EFFDT = (Select max(P1.EFFDT)
                                        from PS_FPMPOINTYP_TBL P1
                                        where   P1.FP_POINTYP_CD = P.FP_POINTYP_CD
                                        and             P1.EFFDT <= TE.EFFDT)

!** Last Employee Contribution Rate
and             T.FP_STATUSEE_CD = $DRTE_STATUT
and             T.EFF_STATUS = 'A'
and     T.EFFDT = (Select max(T1.EFFDT)
                                        from PS_FPMSTATUSEE_TBL T1
                                        where   T1.FP_STATUSEE_CD = T.FP_STATUSEE_CD
                                        and             T1.EFFDT <= TE.EFFDT)

END-Select
END-PROCEDURE Determine-Rupture-Taux-Emply



!*******************************************************************
BEGIN-PROCEDURE Determine-Fin-Semestre($Mat,#Dos,$Fin_Sem,:$Trouve)
!------------------------------------------------------------------
!       Determine if an instance due to a setup update (Point,
!       (Employee / Employer Contrib. Rate) exists in the the "Calls Results"
!       table at Semester End Date
!-----------------------------------------------------------------!
!       IN :    $Mat                    Emplid
!               #Dos                    Record Number
!               $Fin_Sem                Semester End Date
!
!       OUT :   $Trouve                 An instance already exists (Y/N)
!
!*******************************************************************

let $Trouve = 'N'

let $sql-statement = 'FPA1100.SQC,Determine-Fin-Semestre,Select,FPACNTRBRES_TBL'

BEGIN-Select On-Error=SQL-Error
FP_BEGIN_DT_PER

        let $Trouve = 'Y'

From    PS_FPACNTRBRES_TBL
Where   EMPLID = $Mat
and     EMPL_RCD = #Dos
and             FP_BEGIN_DT_PER = {DATEIN-PREFIX}$Fin_Sem{DATEIN-SUFFIX}

END-Select

END-PROCEDURE Determine-Fin-Semestre





!*******************************************************************
BEGIN-PROCEDURE Determine-Title-Max ($Mat,#Dos,$DS,:$Title_Max)
!------------------------------------------------------------------
!       Determine the highest Title Number for a semester
!-----------------------------------------------------------------!
!       IN :    $Mat                    Emplid
!               #Dos                    Record Number
!               $DS                     Semester End Date
!
!       OUT :   $Title                  Maximum Title Number
!
!*******************************************************************

! Determine Max Title number for an employee during the semester
let $sql-statement = 'FPA1100.SQC,Determine-Title-Max,Select,FPACNTRBARC_TBL'

BEGIN-Select On-Error=SQL-Error
Max(FP_TITLE_NUM)                       &TITRE_MAX

        ! Title Number = char, beginning with several 0
        let $Titre_Max = rtrim(&TITRE_MAX,' ')

        move $Titre_Max to #Titre_Max
        display '- Titre Max Num : '    noline
        display #Titre_Max

        let #Titre_Max = #Titre_Max + 1
        move #Titre_Max to $Title_Max 9999999999
!        let $Title_Max = to_char (#Titre_Max)
        display '- Titre Max Char : '   noline
        display $Title_Max

        let #Taille = length($Title_Max)
        display '- Taille : '   noline
        display #Taille

        let $Title_Max = lpad ($Title_Max,11-#Taille,'0')
        display 'Pad : '        noline
        display $Title_Max

From PS_FPACNTRBARC_TBL

Where   EMPLID = $Mat
and             EMPL_RCD = #Dos
and             FP_BEGIN_DT_SEM = {DATEIN-PREFIX}$DS{DATEIN-SUFFIX}

END-Select

END-PROCEDURE Determine-Title-Max




!*******************************************************************
BEGIN-PROCEDURE Verif-Exist-Res ($Mat,#Dos,$Effdt,$Title,:$Trouve)
!------------------------------------------------------------------
!       Check in table "Calls Results " an existing instance
!       at the same Effdt for the current employee
!-----------------------------------------------------------------!
!       IN :            $Mat                    Emplid
!                       #Dos                    Record Number
!                       $Effdt                  Effdt
!                       $Title                  Title Number
!
!       OUT :   $Trouve         = 'Y' if record already exists in table
!
!*******************************************************************
let $sql-statement = 'FPA1100.SQC,Verif-Exist-Res,Select,FPACNTRBRES_TBL'
display '- Verif Existance dans Resultats'

BEGIN-Select On-Error=SQL-Error
LAST_NAME_SRCH          &Nom

        let $Trouve = 'Y'

from PS_FPACNTRBRES_TBL

where   EMPLID                  = $Mat
and     EMPL_RCD               = #Dos
and             FP_BEGIN_DT_PER = {DATEIN-PREFIX}$Effdt{DATEIN-SUFFIX}
and     FP_TITLE_NUM    = $Title

END-Select
END-PROCEDURE Verif-Exist-Res



!*******************************************************************
BEGIN-PROCEDURE Verif-Exist-Tot ($Mat,#Dos,$DS,:#Nb)
!------------------------------------------------------------------
!       Determine in "Calls Results" the record numbers about 1 employee
!       for a semester (retroactive events)
!-----------------------------------------------------------------!
!       IN :    $Mat                    Emplid
!               #Dos                    Record Number
!               $DS                     Semester Start Date
!
!       OUT :   #Nb                     Number of records already existing in the table
!
!*******************************************************************
let $sql-statement = 'FPA1100.SQC,Verif-Exist-Tot,Select,FPACNTRBRES_TBL'
display '- Verif Existance dans Total'

BEGIN-Select On-Error=SQL-Error
COUNT(*)               &Nb

        let #Nb = &Nb

from PS_FPACNTRBTOT_TBL

where   EMPLID                  = $Mat
and     EMPL_RCD               = #Dos
and             FP_BEGIN_DT_SEM = {DATEIN-PREFIX}$DS{DATEIN-SUFFIX}

END-Select
END-PROCEDURE Verif-Exist-Tot








!*******************************************************************
BEGIN-PROCEDURE Insert-Resultat($I_Table,$I_Matricule,#I_Dossier,$I_DP,
                                                                $Title_Num,$I_FP,$I_DS,$I_FS,
                                                                $I_Ech,#I_Ind,#I_Val,#I_VAT,$I_Qte,#I_FracN,#I_FracD,$I_Statut,
                                                                #I_Tx_Ag,#I_Mtt_Ag,#I_Tx_Emply,#I_Mtt_Emply,$I_Devise,
                                                                $I_Setid_Rank,$I_Gr,$I_Lib_Gr,
                                                                $I_Prenom,$I_Nom,$I_Secu,$I_Clef,$I_Pays,$I_Adr1,$I_Adr2,
                                                                $I_Adr3,$I_Adr4,$I_Ville,
                                                                $I_Num1,$I_Num2,$I_House,$I_AdrF1,$I_AdrF2,$I_AdrF3,$I_Commune,$I_State,$I_Postal,
                                                                $I_Geo_Code,$I_In_City,$I_Orig,$I_Accueil)
!------------------------------------------------------------------
!       Insert informations in table "Calls Results" ou "Calls Records"
!------------------------------------------------------------------
!       IN :    All information to insert
!
!       OUT :
!
!*******************************************************************

! Insert instance in table "Calls Results"
let $sql-statement = 'FPA1100.SQC, Insert-Resultat, Insert, FPACNTRBRES_TBL ou ARC'

BEGIN-SQL On-Error=SQL-Error
INSERT INTO [$I_Table]
values ($I_Matricule,#I_Dossier,{DATEIN-PREFIX}$I_DP{DATEIN-SUFFIX},
                $Title_Num,{DATEIN-PREFIX}$I_FP{DATEIN-SUFFIX},{DATEIN-PREFIX}$I_DS{DATEIN-SUFFIX},
                {DATEIN-PREFIX}$I_FS{DATEIN-SUFFIX},
                $I_Ech,#I_Ind,#I_Val,#I_VAT,$I_Qte,#I_FracN,#I_FracD,$I_Statut,
                #I_Tx_Ag,#I_Mtt_Ag,#I_Tx_Emply,#I_Mtt_Emply,$I_Devise,
                $I_Setid_Rank,$I_Gr,$I_Lib_Gr,
                $I_Prenom,$I_Nom,$I_Secu,$I_Clef,$I_Pays,$I_Adr1,$I_Adr2,
                $I_Adr3,$I_Adr4,$I_Ville,
                $I_Num1,$I_Num2,$I_House,$I_AdrF1,$I_AdrF2,$I_AdrF3,$I_Commune,$I_State,$I_Postal,
                $I_Geo_Code,$I_In_City,$I_Orig,$I_Accueil)
END-SQL

END-PROCEDURE Insert-Resultat




!*******************************************************************
BEGIN-PROCEDURE Insert-Total($Mat,#Dos,$DS,#EffSeq,$FS,$Title,#Total,$Devise,$Paiement)
!------------------------------------------------------------------
!       Insert information in table "Calls Total"
!------------------------------------------------------------------
!       IN :    All information to insert
!
!       OUT :
!
!*******************************************************************

! Insert instance in table "Calls Total"
let $sql-statement = 'FPA1100.SQC, Insert-Total, Insert, FPACNTRBTOT_TBL'

BEGIN-SQL On-Error=SQL-Error
INSERT INTO PS_FPACNTRBTOT_TBL (EMPLID, EMPL_RCD, FP_BEGIN_DT_SEM, EFFSEQ, FP_END_DT_SEM, FP_TITLE_NUM, FP_AGT_AMT_TOT, CURRENCY_CD, FP_PAYMENT)
        Values ($Mat,#Dos,{DATEIN-PREFIX}$DS{DATEIN-SUFFIX},#EffSeq,
                        {DATEIN-PREFIX}$FS{DATEIN-SUFFIX},$Title,#Total,$Devise,$Paiement)
END-SQL

END-PROCEDURE Insert-Total




!*******************************************************************
BEGIN-PROCEDURE Calculs-Cotisations ($CC_Mat,#CC_Dossier,$CC_DP,$CC_FP,#CC_Indice,#CC_VAT,
                                                                        #CC_Val,$CC_Qte,#CC_FracN,#CC_FracD,#CC_Tx_Ag,#CC_Tx_Emply,$CC_Org,
                                                                        :#CC_Mtt_Ag,:#CC_Mtt_Emply)
!------------------------------------------------------------------
!       Calulations : Employee Contribution Amount
!------------------------------------------------------------------
!       IN :            $CC_Matricule                   Emplid
!                       #CC_Dossier                     Record Number
!                       $CC_DP                          Period Start Date
!                       $CC_FP                          Period End Date
!                       #CC_Indice                      Index
!                       #CC_Val                         Point Value
!                       #CC_VAT                         Annual Compensation Value
!                       #CC_Qte                         Working Time Percentage on secondment
!                       #CC_FracN                       Ppal Compensation Numerator
!                       #CC_FracD                       Ppal Compensation Denominator
!                       #CC_Tx_Ag                       Employee Contribution Rate
!                       #CC_Tx_Emply                    Employer Contribution Rate
!                       $CC_Org                         Receiving Organization
!
!       OUT :           #CC_Mtt_Ag                      Employee Contribution Amount for this period
!                       #CC_Mtt_Emply                   Employer Contribution Amount for this period
!
!*******************************************************************

do Convert-To-DTU-Date($CC_DP,$CC_DP_dtu)
do Convert-To-DTU-Date($CC_FP,$CC_FP_dtu)

!-- Calculation :  period duration
do FP-Calc-Dur ('T',$CC_DP_dtu,$CC_FP_dtu,#Ans,#Mois,#Jours)

display 'Begin : ' noline
display $CC_DP_dtu
display 'End : ' noline
display $CC_FP_dtu

display 'Year : ' noline
display #Ans
display 'Mois : ' noline
display #Mois
display 'Days : ' noline
display #Jours

display 'Indice : ' noline
display #CC_Indice
display 'Valeur : ' noline
display #CC_Val

!-- Calculation : Compensation
IF #CC_VAT = 0                                  ! No Annual Compensation Value
        let #Rem = (#CC_Indice * #CC_Val * #Ans)        + (#CC_Indice * #CC_Val / 12 * #Mois)
                                                                                                + (#CC_Indice * #CC_Val / 360 * #Jours)
else
        let #Rem = (#CC_VAT * #Ans) + (#CC_VAT / 12 * #Mois) + (#CC_VAT / 360 * #Jours)
END-IF

display '- Contribution Calculation'
display '  Compensation : ' noline
display #Rem

display '  Proration Ratio : ' noline
display #CC_FracN                       noline
display ' / ' noline
display #CC_FracD

display '  Employee Rate   : ' noline
display #CC_Tx_Ag
display '  Employer Rate : ' noline
display #CC_Tx_Emply

let #ratio =  #CC_FracN / #CC_FracD

display #ratio

!-- Calculation : Employee Contribution Amount
let #CC_Mtt_Ag = #Rem * #ratio * (#CC_Tx_Ag / 100)

let #CC_Mtt_Ag = trunc(#CC_Mtt_Ag,0)

display #CC_Mtt_Ag

display $CC_Org

! Calculation : Employer Contribution Amount if Organization is liable
!-------------------------------------------------------------------------
let $sql-statement = 'FPA1100.SQC, Calc-Contrib, Select, FPMINDBTORG_TBL'
BEGIN-SELECT On-Error=SQL-Error

FP_INDEBTED             &REDEV

        let $Redevable = rtrim(&REDEV,' ')

        display $Redevable

        IF $Redevable = 'Y'
                let #CC_Mtt_Emply = #Rem * #ratio * (#CC_Tx_Emply / 100)
                let #CC_Mtt_Emply = trunc(#CC_Mtt_Emply,0)
        else
                let #CC_Mtt_Emply = 0
        END-IF

from PS_FPMINDBTORG_TBL O               ! Organization table

Where   O.FP_INDEBT_ORG_CD = $CC_Org
and     O.EFF_STATUS = 'A'
and     O.EFFDT = (Select max(O1.EFFDT)
             from PS_FPMINDBTORG_TBL O1
             where O1.FP_INDEBT_ORG_CD = O.FP_INDEBT_ORG_CD
             and     O1.EFFDT <= {DATEIN-PREFIX}$CC_FP{DATEIN-SUFFIX})

END-SELECT

END-PROCEDURE Calculs-Cotisations



!*******************************************************************************************
BEGIN-PROCEDURE Update-Resultat ($UR_Mat,#UR_Dossier,$UR_DP,$UR_FP,#UR_Mtt_Ag,#UR_Mtt_Emply)
!---------------------------------------------------------------------
!       Update : Period End Date, Employee / Employer Contribution Amounts
!       in table "Calls Results"
!---------------------------------------------------------------------
!       IN :            $UR_Mat                         Emplid
!                       #UR_Dossier                     Record Number
!                       $UR_DP                          Period Start Date
!                       $UR_FP                          Periode End Date
!                       #UR_Mtt_Ag                      Employee Contribution Amount for the period
!                       #UR_Mtt_Emply                   Employer Contribution Amount for the period
!
!       OUT :   record from "FPACNTRBRES_TBL" updated
!
!*******************************************************************
let $sql-statement = 'FPA1100.SQC, Update-Resultat, Update, FPACNTRBRES_TBL'
BEGIN-SQL On-Error=SQL-Error

UPDATE PS_FPACNTRBRES_TBL
        Set     FP_END_DT_PER   = {DATEIN-PREFIX}$UR_FP{DATEIN-SUFFIX},
                        FP_AGT_AMT              = #UR_Mtt_Ag,
                        FP_EMPLY_AMT    = #UR_Mtt_Emply
        Where   EMPLID                  = $UR_Mat
        and             EMPL_RCD               = #UR_Dossier
        and     FP_BEGIN_DT_PER = {DATEIN-PREFIX}$UR_DP{DATEIN-SUFFIX}
END-SQL

END-PROCEDURE Update-Resultat



!*******************************************************************
!
!       Affiche-LIS
!
!------------------------------------------------------------------
!       Display main information in file .LIS
!------------------------------------------------------------------
!       IN :    Inforamtions about each period
!
!       OUT :   file FPA1100.Lis updated
!
!*******************************************************************
BEGIN-PROCEDURE Affiche-LIS ($Debut_Periode,$Fin_Periode,$Quotite,
                                                        #Tx_Ag,#Indice,#VAT,#Valeur,#Mtt
                                                        #Tx_Emply,#Mtt_Emply)

do Get_Field_Information($ReportID, 'FP_PT_PCT_DET',    $FP_PT_PCT_DET_LBL,     #DW)
do Get_Field_Information($ReportID, 'INDEX',            $INDEX_LBL,             #DW)
do Get_Field_Information($ReportID, 'POINT_VAL',        $POINT_VAL_LBL,         #DW)
do Get_Field_Information($ReportID, 'ANNUAL_RT',        $ANNUAL_RT_LBL,         #DW)
do Get_Field_Information($ReportID, 'CNTRB_EMPLYEE_RT', $CNTRB_EMPLYEE_RT_LBL,  #DW)
do Get_Field_Information($ReportID, 'CNTRB_EMPLYEE',    $CNTRB_EMPLYEE_LBL,     #DW)
do Get_Field_Information($ReportID, 'CNTRB_EMPLYER_RT', $CNTRB_EMPLYER_RT_LBL,  #DW)
do Get_Field_Information($ReportID, 'CNTRB_EMPLYER',    $CNTRB_EMPLYER_LBL,     #DW)

print $Debut_Periode            (+2,1)
print '->'                      (,13)
print $Fin_Periode              (,16)

print $FP_PT_PCT_DET_LBL        (,30)   !noline
print ' : '                     (,37)
print $Quotite                  (,42)

If #VAT = 0
        print $INDEX_LBL        (+1,30) !noline
        print ' : '             (,37)
        print #Indice           (,42)   edit 9999
        print $POINT_VAL_LBL    (,59)   !noline
        print ' : '             (,65)
        print #Valeur           (,69)
else
        print $ANNUAL_RT_LBL    (+1,30) !noline
        print ' : '             (,37)
        print #VAT              (,42)
End-if

print $CNTRB_EMPLYEE_RT_LBL     (+1,30) !noline
print ' : '                     (,37)
print #Tx_Ag                    (,42)
print $CNTRB_EMPLYEE_LBL        (,59)   !noline
print ' : '                     (,65)
print #Mtt                      (,69)

print $CNTRB_EMPLYER_RT_LBL     (+1,30) !noline
print ' : '                     (,37)
print #Tx_Emply                 (,42)
print $CNTRB_EMPLYER_LBL        (,59)   !noline
print ' : '                     (,65)
print #Mtt_Emply                (,69)

END-PROCEDURE Affiche-LIS



!*************************************************************
BEGIN-PROCEDURE Verification($V_Matricule,#V_Dossier,$V_Debut_Verif,
                                                        $V_Debut_Calc,$E_SIRH)
!-------------------------------------------------------------
!       Check : Employee Contribution Amount for a period
!       --> in case of retroactive events
!-------------------------------------------------------------
!
!       IN :            $V_Matricule            Emplid
!                       #V_Dossier              Record Number
!                       $V_Debut_Verif          Check Start Date
!                       $V_Debut_Calc           Semester Start Date on which calculations are done
!                       $E_SIRH                 Information from HRMS ?
!
!       OUT :
!
!**************************************************************
display '-------------------------------------'
display ' VERIFICATION des Annees Anterieures '
display '-------------------------------------'

display 'Date de Debut du Calcul : ' noline
display $V_Debut_Calc


let $Debut = 'Y'        ! Indicates semester start date for check
let $Modif_Det = 'N'
display 'sqc modif'


let $sql-statement = 'FPA1100.SQC,Verification,Select,FPACNTRBRES_TBL'
BEGIN-SELECT On-Error=SQL-Error

{DATEOUT-PREFIX}FP_BEGIN_DT_PER{DATEOUT-SUFFIX}                 &V_EFFDT
FP_INCS_IND                                                     &V_INDICE
FP_POINT_VAL                                                    &V_VAL          ! Point Value
ANNUAL_RT                                                       &V_VAT          ! Annual compensation value
FP_PT_PCT_DET                                                   &V_QUOTITE
FP_STATUSEE_CD                                                  &V_STATUT       ! Employee Status
FP_CNTRB_AGT                                                    &V_TX_AG        ! Employee Contribution Rate
FP_CNTRB_EMPLY                                                  &V_TX_EMPLY     ! Employer Contribution Rate
{DATEOUT-PREFIX}FP_BEGIN_DT_SEM{DATEOUT-SUFFIX}                 &V_DS           ! Semester Start Date
{DATEOUT-PREFIX}FP_END_DT_SEM{DATEOUT-SUFFIX}                   &V_FS           ! Semester End Date

        let $V_Effdt    = &V_EFFDT
        do Convert-To-DTU-Date($V_Effdt,$V_Effdt_dtu)

        let #V_Ind              = &V_INDICE
        let #V_Val              = &V_VAL
        let #V_Vat              = &V_VAT
        let $V_Qte              = &V_QUOTITE
        let $V_Statut   = &V_STATUT
        let #V_Tx_Ag    = &V_TX_AG
        let #V_Tx_Emply = &V_TX_EMPLY
        let $V_DS               = &V_DS
        let $V_FS               = &V_FS

        display '** Effdt : ' noline
        display $V_Effdt
        display '$V_DS : ' noline
        display $V_DS

        IF $Debut = 'Y'                 ! Semester Start Date for check

                !-- SELECT : MAIN DATA VALUES EVOLUTION
                do Next-Qte ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,$V_Qte,$N_Effdt_Qte,$N_Qte)
                do Next-Ind ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,#V_Ind,$N_Effdt_Ind,#N_Ind)
                do Next-Vat ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,#V_Vat,$N_Effdt_Vat,#N_Vat)

                do Next-Val-Point ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,$N_Effdt_Val,#N_Val)
                do Next-Tx-Ag ($V_Statut,$V_Effdt,$V_Debut_Calc,$E_SIRH,$N_Effdt_Tx_Ag,#N_Tx_Ag)
                do Next-Tx-Emply ($V_Effdt,$V_Debut_Calc,$E_SIRH,$N_Effdt_Tx_Emply,#N_Tx_Emply)

                display $N_Effdt_Qte
                display $N_Qte
                display $N_Effdt_Ind
                display #N_Ind
                display $N_Effdt_Vat
                display #N_Vat
                display $N_Effdt_Val
                display #N_Val

                display $N_Effdt_Tx_Ag
                display #N_Tx_Ag

                !-- Check : Index and Point
                ! Except for : Secondment End Date, Semester End Date, or employee with sub-scale
                If (#V_Ind <> 0) AND (#V_Vat = 0)
                        do Verif-Ind-Val($V_Matricule,#V_Dossier,$V_Effdt,$E_SIRH,#V_Ind,#V_Val,
                                                        $Modif_Ind,$Modif_Val)
                End-If
                !-- Check : Working Time percentage, Annual compensation value, Employee / Employer Contribution Rate
                do Verif-Infos ($V_Matricule,#V_Dossier,$V_Effdt,$E_SIRH,$V_Qte,#V_Vat,#V_Tx_Ag,#V_Tx_Emply,
                                                $Modif_Qte,$Modif_Vat,$Modif_Tx_Ag,$Modif_Tx_Emply,$Scnd_Typ,$Civil_Pension)


                if $V_DS = $V_Effdt
                !-- if first instance date = semester start date : check secondment is active at this date
                    if  $Scnd_Typ = 'B' or $Civil_Pension = 'Y'
                        let $Modif_Det = 'Y'
                    end-if
                else
                !-- if secondment start date happens during semester, check the similarity of dates
                    do Begin-Scnd ($V_Matricule,#V_Dossier,$V_DS ,$SIRH,$Effdt_beg)
                    if $Effdt_beg <>  $V_Effdt_dtu
                        let  $Modif_Det = 'Y'
                    end-if
                end-if

                if $modif_det != 'Y'
                    do End-Scnd ($V_Matricule,#V_Dossier,$V_Effdt,$SIRH,$Effdt_end)
                    let $Effdt_beg = $V_Effdt_dtu
                end-if


        ELSE    ! During Semester


                !-- Check Start / End Secondment
                display 'dep / ret'
                display $Effdt_beg
                display $Effdt_end
                if $Effdt_end <> ''
                    if $Effdt_end < $Effdt_beg
                    ! instance after secondment end date : new secondment
                        if $Effdt_beg = $V_Effdt_dtu
                            do End-Scnd ($V_Matricule,#V_Dossier,$V_Effdt,$SIRH,$Effdt_end)
                        else
                            let $Modif_Det = 'Y'
                        end-if
                    end-if
                    if $V_Effdt_dtu > $Effdt_end
                    ! secondment end date change
                        let $Modif_Det = 'Y'
                    else
                        if $V_Effdt_dtu = $Effdt_end
                        ! instance correspond to secondment end date
                            if (#V_Ind = 0) AND (#V_Vat = 0)
                                do Begin-Scnd ($V_Matricule,#V_Dossier,$V_Effdt,$SIRH,$Effdt_beg)
                            else
                                let $Modif_Det = 'Y'
                            end-if
                        end-if
                    end-if
                end-if


                if $Effdt_beg <> '' and $Effdt_beg < $V_Effdt_dtu
                !-- Check : Index and Point
                ! EXCEPT FOR secondment end date, semester end date or employee with sub-scale


                        !-- INDEX
                        IF ($N_Effdt_Ind <> '')                                                         ! An Update will happen
                                If $V_Effdt_dtu > $N_Effdt_Ind                                          ! Retroactive event
                                       let $Modif_Ind = 'Y'
                                Else
                                    if $V_Effdt_dtu = $N_Effdt_Ind
                                        If (#V_Ind <> #N_Ind) and (#V_Ind <> 0) AND (#V_Vat = 0)        ! Instance update
                                               let $Modif_Ind = 'Y'
                                        else
                                                ! Determine next Update
                                                do Next-Ind ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,#V_Ind,
                                                                                $N_Effdt_Ind,#N_Ind)
                                        end-if
                                    End-if
                                End-IF
                        END-IF


                        !-- POINT VALUE
                        IF ($N_Effdt_Val <> '')                                                                 ! An Update will happen
                                If $V_Effdt_dtu > $N_Effdt_Val                                                  ! Retroactive event
                                        let $Modif_Val = 'Y'
                                Else
                                    if $V_Effdt_dtu = $N_Effdt_Val
                                        If (#V_Val <> #N_Val)                                                   ! Instance update
                                                let $Modif_Val = 'Y'

                                         else
                                               ! Determine next Update
                                               do Next-Val-Point ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,
                                                                                                $N_Effdt_Val,#N_Val)
                                         end-if
                                    End-if
                                End-If
                        END-IF





                !-- Check : Working Time Percentage, Annual Compensation Value, Employee / Employer Contribution Rates
                !-- WORKING TIME PERCENTAGE

                IF ($N_Effdt_Qte <> '')                                                         ! An update will happen
                        If $V_Effdt_dtu > $N_Effdt_Qte                                          ! Retroactive event
                                let $Modif_Qte = 'Y'
                        Else
                            if $V_Effdt_dtu = $N_Effdt_Qte
                                If ($V_Qte <> $N_Qte)                                           ! Instance update

                                        let $Modif_Qte = 'Y'
                                else
                                        ! Determine next Update
                                        do Next-Qte ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,$V_Qte,
                                                                        $N_Effdt_Qte,$N_Qte)
                                end-if
                            End-if
                        End-If
                END-IF



                !-- ANNUAL COMPENSATION VALUE
                IF ($N_Effdt_Vat <> '')                                                         ! An update will happen
                        If $V_Effdt_dtu > $N_Effdt_Vat                                          ! Retroactive event
                                let $Modif_Vat = 'Y'
                        Else
                            if $V_Effdt_dtu = $N_Effdt_Vat
                                If (#V_Vat <> #N_Vat)                                           ! Instance update
                                        let $Modif_Vat = 'Y'
                                else
                                    ! Determine next Update
                                    do Next-Vat ($V_Matricule,#V_Dossier,$V_Effdt,$V_Debut_Calc,$E_SIRH,#V_Vat,
                                                                        $N_Effdt_Vat,#N_Vat)
                                end-if
                            End-if
                        End-If
                END-IF


                !-- EMPLOYEE CONTRIBUTION RATE
                IF ($N_Effdt_Tx_Ag <> '')                                                       ! An update will happen
                        If $V_Effdt_dtu > $N_Effdt_Tx_Ag                                        ! Retroactive event
                                let $Modif_Tx_Ag = 'Y'
                        Else
                            if $V_Effdt_dtu = $N_Effdt_Tx_Ag
                                If (#V_Tx_Ag <> #N_Tx_Ag)                                       ! Instance update
                                        let $Modif_Tx_Ag = 'Y'

                                               display #V_Tx_Ag
                                               display #N_Tx_Ag
                                else
                                                ! Determine next Update
                                                do Next-Tx-Ag ($V_Statut,$V_Effdt,$V_Debut_Calc,$E_SIRH,$N_Effdt_Tx_Ag,#N_Tx_Ag)
                                end-if
                            End-if
                        End-If
                END-IF


                !-- EMPLOYER CONTRIBUTION RATE
                IF ($N_Effdt_Tx_Emply <> '')                                                    ! An update will happen
                        If $V_Effdt_dtu > $N_Effdt_Tx_Emply                                     ! Retroactive event
                                let $Modif_Tx_Emply = 'Y'
                        Else
                            if $V_Effdt_dtu = $N_Effdt_Tx_Emply
                                If (#V_Tx_Emply <> #N_Tx_Emply)                                 ! Instance update
                                        let $Modif_Tx_Emply = 'Y'

                                else
                                    ! Determine next Update
                                    do Next-Tx-Emply ($V_Effdt,$V_Debut_Calc,$E_SIRH,$N_Effdt_Tx_Emply,#N_Tx_Emply)
                               end-if
                           End-if
                        END-IF
                END-IF

                end-if
        END-IF

        let $Debut = 'N'


        !** Change detected (a retroactive event was inserted)
        display $Modif_Ind
        display $Modif_Val
        display $Modif_Qte
        display $Modif_Vat
        display $Modif_Tx_Ag
        display $Modif_Det

        If ($Modif_Ind = 'Y')   OR ($Modif_Val = 'Y') OR ($Modif_Qte = 'Y')
                                                        OR ($Modif_Vat = 'Y') OR ($Modif_Tx_Ag = 'Y')
                                                        OR ($Modif_Tx_Emply = 'Y') OR ($Modif_Det = 'Y')
                let $Retro = 'Y'
                Exit-Select
        End-If

From    PS_FPACNTRBRES_TBL              ! Contribution Results

! Record Number
Where   EMPLID          = $V_Matricule
and     EMPL_RCD       = #V_Dossier

! Check Period
and             FP_BEGIN_DT_PER >= {DATEIN-PREFIX}$V_Debut_Verif{DATEIN-SUFFIX}
and             FP_BEGIN_DT_PER < {DATEIN-PREFIX}$V_Debut_Calc{DATEIN-SUFFIX}

Order By FP_BEGIN_DT_PER

END-SELECT


! 1 retroactive event inserted
!-------------------------------
IF $Retro = 'Y'

        do Get_Field_Information($ReportID, 'MODIF_DETECT',     $MODIF_DETECT_LBL,      #DW)
        do Get_Field_Information($ReportID, 'TO',               $TO_LBL,                #DW)
        do Get_Field_Information($ReportID, 'INDEX',            $INDEX_LBL,             #DW)
        do Get_Field_Information($ReportID, 'POINT',            $POINT_LBL,             #DW)
        do Get_Field_Information($ReportID, 'ANNUAL_RT',        $ANNUAL_RT_LBL,         #DW)
        do Get_Field_Information($ReportID, 'CNTRB_EMPLYEE_RT', $CNTRB_EMPLYEE_RT_LBL,  #DW)
        do Get_Field_Information($ReportID, 'CNTRB_EMPLYER_RT', $CNTRB_EMPLYER_RT_LBL,  #DW)
        do Get_Field_Information($ReportID, 'SCDMT_RETURN',     $SCDMT_RETURN_LBL,      #DW)

        print $MODIF_DETECT_LBL         (+2,1)  !noline
        print ' : '                     (,20)
        print $V_DS                     (,25)
        print $TO_LBL                   (,37)
        print $V_FS                     (,40)
        print ' '                       (+1,1)

        if ($Modif_Ind = 'Y')                           ! Change : Index
                print '('               (,2)    !noline
                print  $INDEX_LBL       (,5)        !noline
                print ')'               (,8)
        end-if
        if ($Modif_Val = 'Y')                           ! Change : Point Value
                print '('               (,10)   !noline
                print  $POINT_LBL       (,13)        !noline
                print ')'               (,18)
        end-if
        if ($Modif_Qte = 'Y')                           ! Change : Working Time percentage during secondment
                print '('               (,20)   !noline
                print  $FP_PT_PCT_DET_LBL (,23)      !noline
                print ')'                 (,28)
        end-if
        if ($Modif_Vat = 'Y')                           ! Change : Annual Compensation Value
                print '('               (,30)   !noline
                print  $ANNUAL_RT_LBL   (,33)        !noline
                print ')'               (,38)
        end-if
        if ($Modif_Tx_Ag = 'Y')                         ! Change : Employee Contribution Rate
                print '('               (,40)   !noline
                print  $CNTRB_EMPLYEE_RT_LBL  (,43)  !noline
                print ')'                     (,48)
        end-if
        if ($Modif_Tx_Emply = 'Y')                      ! Change : Employer Contribution Rate
                print '('               (,50)   !noline
                print  $CNTRB_EMPLYER_RT_LBL  (,53)  !noline
                print ')'                     (,58)
        end-if
        if ($Modif_Det = 'Y')                           ! Change : secondment start / end Dates
                print '('               (,65)   !noline
                print  $SCDMT_RETURN_LBL (,68)       !noline
                print ')'                (,73)
        end-if


        ! Delete : old semester results
        !-----------------------------------------------
        let $sql-statement = 'FPA1100.SQC, Verification, Delete, FPACNTRBRES_TBL'
BEGIN-SQL On-Error=SQL-Error

DELETE From PS_FPACNTRBRES_TBL
Where   EMPLID                  = $V_Matricule
and     EMPL_RCD               = #V_Dossier
and     FP_BEGIN_DT_SEM = {DATEIN-PREFIX}$V_DS{DATEIN-SUFFIX}

END-SQL

        ! Calculation : new contributions for this semester
        !--------------------------------------------------
        display ''
        display 'VERIFICATION du Semestre '
        display '-------------------------'

        Do Calcul($V_Matricule,#V_Dossier,$V_DS,$V_FS,$E_SIRH,'Y')

        let $Retro = 'N'

        ! - Check : next semesters contributions, prior to the captured semester from the run control panel
        do Convert-To-DTU-Date($V_FS,$V_FS_dtu)
        do Add-Date($V_FS_dtu,0,0,1,$Fin_Verif_dtu)
        do Convert-From-DTU-Date($Fin_Verif_dtu,$Fin_Verif)
        do Convert-To-DTU-Date($V_Debut_Calc,$V_Debut_Calc_dtu)

        display '$Fin_Verif    : ' noline
        display $Fin_Verif_dtu
        display '$V_Debut_Calc : ' noline
        display $V_Debut_Calc_dtu

        If $Fin_Verif_dtu < $V_Debut_Calc_dtu
                ! Next semesters contributions have to be checked
                !--------------------------------------------------------------
                Do Verification($V_Matricule,#V_Dossier,$Fin_Verif,$V_Debut_Calc,$E_SIRH)
        End-If

END-IF

END-PROCEDURE Verification



!--------------------------------------------------------------------------
!       Select : next Working Time Percentage update in the system
!               (Tables JOB or FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :            $NQ_Mat                         Emplid
!                       #NQ_Dos                         Record Number
!                       $NQ_Effdt                       Effdt
!                       $NQ_Debut_Calc                  Semester Start Date used for this batch
!                       $SIRH                           Informations from HRMS
!                       $NQ_Qte                         Last working time percentage
!
!       OUT :           $Effdt                          working time percentage update Effdt in dtu format
!                       $Qte                            working time percentage value after update
!
!---------------------------------------------------------------------------
BEGIN-PROCEDURE Next-Qte ($NQ_Mat,#NQ_Dos,$NQ_Effdt,$NQ_Debut_Calc,$SIRH,$NQ_Qte,
                                                        :$Effdt,:$Qte)
display '- Next Number of Days'

let $Effdt = ''
let $Qte = ''

let $sql-statement = 'FPA1100.SQC,Next-Qte,Select,FPA_JOB'
BEGIN-SELECT On-Error=SQL-Error

{DATEOUT-PREFIX}J.EFFDT{DATEOUT-SUFFIX}     &J_EFFDT
J.FP_PT_PCT_DET                             &J_QTE

        let $Effdt_nat  = &J_EFFDT
        do Convert-To-DTU-Date($Effdt_nat,$Effdt)

        let $Qte = &J_QTE

From PS_JOB_JR J
    ,PS_FPFAST_PERS_VW2 SCRTY              !SQR security

Where J.EMPLID = $NQ_Mat
and J.EMPL_RCD = #NQ_Dos

and J.FP_PT_PCT_DET <> $NQ_Qte          ! New working time percentage <> old one

and J.EFFDT = (select Min(J1.EFFDT)
               from    PS_JOB_JR J1
               where   J1.EMPLID = J.EMPLID
               and     J1.EMPL_RCD = J.EMPL_RCD
               and     J1.FP_PT_PCT_DET = J.FP_PT_PCT_DET
               and     J1.EFFDT > {DATEIN-PREFIX}$NQ_Effdt{DATEIN-SUFFIX}
               and     J1.EFFDT < {DATEIN-PREFIX}$NQ_Debut_Calc{DATEIN-SUFFIX})

and J.EMPLID = SCRTY.EMPLID             !SQR security
[$_SecurityClause]                       !SQR security

END-SELECT

END-PROCEDURE Next-Qte



!--------------------------------------------------------------------------
!       Select : next Index update in the system (Tables JOB or FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :            $NI_Mat                                 Emplid
!                       #NI_Dos                                 Record Number
!                       $NI_Effdt                               Effdt
!                       $NI_Debut_Calc                          Semester Start Date used for this batch
!                       $SIRH                                   Informations from HRMS
!                       #NI_Ind                                 Last index
!
!       OUT :           $Effdt                                  Index Update Effdt in dtu format
!                       #Ind                                    Index value after update
!
!---------------------------------------------------------------------------
BEGIN-PROCEDURE Next-Ind ($NI_Mat,#NI_Dos,$NI_Effdt,$NI_Debut_Calc,$SIRH,#NI_Ind,
                                                        :$Effdt,:#Ind)
display '- Next Indice'

let $Effdt = ''
let #Ind = 0

let $sql-statement = 'FPA1100.SQC,Next-Ind,Select,FPA_JOB'
BEGIN-SELECT On-Error=SQL-Error

{DATEOUT-PREFIX}J.EFFDT{DATEOUT-SUFFIX}     &J_EFFDT
J.FP_INCS_IND                               &J_IND

        let $Effdt_nat  = &J_EFFDT
        do Convert-To-DTU-Date($Effdt_nat,$Effdt)

        let #Ind        = &J_IND

From PS_JOB_JR J
    ,PS_FPFAST_PERS_VW2 SCRTY              !SQR security

Where J.EMPLID = $NI_Mat
and J.EMPL_RCD = #NI_Dos

and J.FP_INCS_IND <> #NI_Ind            ! New Index <> old one

and J.EFFDT = (select Min(J1.EFFDT)
               from    PS_JOB_JR J1
               where   J1.EMPLID = J.EMPLID
               and     J1.EMPL_RCD = J.EMPL_RCD
               and     J1.FP_INCS_IND = J.FP_INCS_IND
               and     J1.EFFDT > {DATEIN-PREFIX}$NI_Effdt{DATEIN-SUFFIX}
               and     J1.EFFDT < {DATEIN-PREFIX}$NI_Debut_Calc{DATEIN-SUFFIX})

and J.EMPLID = SCRTY.EMPLID             !SQR security
[$_SecurityClause]                       !SQR security

END-SELECT

END-PROCEDURE   Next-Ind



!--------------------------------------------------------------------------
!       Select : next Annual Compensation Value update in the system
!                        (Tables JOB ou FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :    $NV_Mat                     Emplid
!               #NV_Dos                     Record Number
!               $NV_Effdt                   Effdt
!               $NV_Debut_Calc              Semester Start Date used for this batch
!               $SIRH                       Informations from HRMS
!               #NV_Vat                     Last Annual Compensation Value
!
!       OUT :   $Effdt                      Annual Compensation Value Update Effdt in dtu forma
!               #Vat                        Annual Compensation Value after update
!
!---------------------------------------------------------------------------
BEGIN-PROCEDURE Next-Vat ($NV_Mat,#NV_Dos,$NV_Effdt,$NV_Debut_Calc,$SIRH,#NV_Vat,
                                                        :$Effdt_Vat,:#Vat)
display '- Next VAT'

let $Effdt = ''
let #Vat = 0

let $sql-statement = 'FPA1100.SQC,Next-Vat,Select,FPA_JOB'
BEGIN-SELECT On-Error=SQL-Error

{DATEOUT-PREFIX}J.EFFDT{DATEOUT-SUFFIX}   &J_EFFDT
J.ANNUAL_RT                     &J_VAT

        let $Effdt_nat  = &J_EFFDT
        do Convert-To-DTU-Date($Effdt_nat,$Effdt)

        let #Vat        = &J_VAT

From PS_JOB J
    ,PS_FPFAST_PERS_VW2 SCRTY              !SQR security

Where J.EMPLID = $NV_Mat
and J.EMPL_RCD = #NV_Dos
and J.ANNUAL_RT <> #NV_Vat              ! New VAT <> old one

and J.EFFDT = (select Min(J1.EFFDT)
               from    PS_JOB J1
               where   J1.EMPLID = J.EMPLID
               and     J1.EMPL_RCD = J.EMPL_RCD
               and     J1.ANNUAL_RT = J.ANNUAL_RT
               and     J1.EFFDT > {DATEIN-PREFIX}$NV_Effdt{DATEIN-SUFFIX}
               and     J1.EFFDT < {DATEIN-PREFIX}$NV_Debut_Calc{DATEIN-SUFFIX})

and J.EMPLID = SCRTY.EMPLID             !SQR security
[$_SecurityClause]                       !SQR security

END-SELECT

END-PROCEDURE   Next-Vat



!--------------------------------------------------------------------------
!       Select : next Type value update in the system
!               (Tables JOB ou FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :            $NVP_Mat                                Emplid
!                       #NVP_Dos                                Record Number
!                       $NVP_Effdt                              Effdt
!                       $NVP_Debut_Calc                         Semester Start Date used for this batch
!                       $SIRH                                   Informations from HRMS
!
!       OUT :   $Effdt                                          Point value update Effdt in dtu format
!                       #Val                                    Point Value after update
!
!---------------------------------------------------------------------------
BEGIN-PROCEDURE Next-Val-Point ($NVP_Mat,#NVP_Dos,$NVP_Effdt,$NVP_Debut_Calc,$SIRH,
                                                                :$Effdt,:#Val)
display '- Next Valeur du Point'

let $Effdt = ''
let #Val = 0

let $sql-statement = 'FPA1100.SQC,Next-Val-Point,Select,FPMPOINTYP_TBL'
BEGIN-SELECT On-Error=SQL-Error

{DATEOUT-PREFIX}P.EFFDT{DATEOUT-SUFFIX}     &P_EFFDT
P.FP_POINT_VAL                              &P_VAL

        let $Effdt_nat  = &P_EFFDT
        do Convert-To-DTU-Date($Effdt_nat,$Effdt)

        let #Val        = &P_VAL

From    PS_JOB_JR               J,
        PS_FPMPOINTYP_TBL       P,               ! Point value
        PS_FPMRANK_TBL          R,
        PS_FPMSALMATRX_TBL      M
        ,PS_FPFAST_PERS_VW2     SCRTY           ! SQR security

!** Employee Record
Where   J.EMPLID = $NVP_Mat
and             J.EMPL_RCD = #NVP_Dos

!** Most recent effdt
and             J.EFFDT = (Select Max(J2.EFFDT)
                           from    PS_JOB_JR      J2
                           where   J2.EMPLID = J.EMPLID
                           and     J2.EMPL_RCD = J.EMPL_RCD
                           and     J2.EFFDT <= {DATEIN-PREFIX}$NVP_Effdt{DATEIN-SUFFIX})

!** highest sequence number
and             J.EFFSEQ = (Select max(J1.EFFSEQ)
                            from PS_JOB_JR J1
                            where   J1.EMPLID       = J.EMPLID
                            and     J1.EMPL_RCD = J.EMPL_RCD
                            and     J1.EFFDT = J.EFFDT)

!** Grade
and     R.FP_RANK_CD = J.FP_RANK_CD
and     R.SETID = J.FP_SETID_RANK
and     R.EFF_STATUS = 'A'
and             P.EFFDT = (select Max (R1.EFFDT)
                           from PS_FPMRANK_TBL R1
                           where   R1.FP_RANK_CD = J.FP_RANK_CD
                           and     R1.SETID = J.FP_SETID_RANK
                           and     R1.EFFDT <= J.EFFDT)
!Salary Grade Table

and M.FP_MATRIX_TYP = R.FP_MATRIX_TYP
and M.FP_MATRIX_CD = R.FP_MATRIX_CD
and M.FP_SCALE_CD = R.FP_SCALE_CD
and M.EFF_STATUS = 'A'
and M.EFFDT = (Select max(M1.EFFDT)
                                from PS_FPMSALMATRX_TBL M1
                                where M1.FP_MATRIX_TYP = R.FP_MATRIX_TYP
                                and   M1.FP_MATRIX_CD = R.FP_MATRIX_CD
                                and   M1.FP_SCALE_CD = R.FP_SCALE_CD
                                and   M1.EFFDT <= J.EFFDT)


!** Point value
and     P.FP_POINTYP_CD = M.FP_POINTYP_CD
and     P.EFF_STATUS = 'A'
and     P.EFFDT = (select Min (P1.EFFDT)
                           from PS_FPMPOINTYP_TBL P1
                           where   P1.FP_POINTYP_CD = P.FP_POINTYP_CD
                           and     P1.EFFDT >      {DATEIN-PREFIX}$NVP_Effdt{DATEIN-SUFFIX}
                           and     P1.EFFDT < {DATEIN-PREFIX}$NVP_Debut_Calc{DATEIN-SUFFIX})

and J.EMPLID = SCRTY.EMPLID     !SQR security
[$_SecurityClause]               !SQR security

END-SELECT

END-PROCEDURE Next-Val-Point





!**************************************************************************
BEGIN-PROCEDURE Next-Tx-Ag($NTA_Statut,$NTA_Effdt,$NTA_Debut_Calc,$SIRH,
                                                        :$Effdt,:#Tx_Ag)
!--------------------------------------------------------------------------
!       Select : next employee contribution rate in the system
!               (Tables JOB or FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :            $NTA_Statut                     Status
!                       $NTA_Effdt                      Effdt
!                       $NTA_Debut_Calc                 Semester Start Date used for this batch
!                       $SIRH                           Informations from HRMS
!
!       OUT :           $Effdt                          Employee contribution rate update Effdt in dtu format
!                       #Tx_Ag                          Employee contribution rate after update
!
!---------------------------------------------------------------------------
display '- Next Taux Agent'

let $Effdt = ''
let #Tx_Ag = 0


let $sql-statement = 'FPA1100.SQC,Next-Tx-Ag,Select,FPMSTATUSEE_TBL'

BEGIN-SELECT On-Error=SQL-Error
{DATEOUT-PREFIX}S.EFFDT{DATEOUT-SUFFIX}     &S_EFFDT
S.FP_CNTRB_AGT                  &S_FP_CNTRB_AGT

        let $Effdt_nat  = &S_EFFDT
        do Convert-To-DTU-Date($Effdt_nat,$Effdt)

        let #Tx_Ag      = &S_FP_CNTRB_AGT


From PS_FPMSTATUSEE_TBL S

Where S.FP_STATUSEE_CD = $NTA_Statut
and S.EFF_STATUS = 'A'

and S.EFFDT = (select Min(S1.EFFDT)
                                from    PS_FPMSTATUSEE_TBL S1
                                where   S1.FP_STATUSEE_CD = S.FP_STATUSEE_CD
                                and     S1.EFFDT > {DATEIN-PREFIX}$NTA_Effdt{DATEIN-SUFFIX}
                                and     S1.EFFDT < {DATEIN-PREFIX}$NTA_Debut_Calc{DATEIN-SUFFIX})
END-SELECT

END-PROCEDURE Next-Tx-Ag






!**************************************************************************
BEGIN-PROCEDURE Next-Tx-Emply($NTE_Effdt,$NTE_Debut_Calc,$SIRH,
                                                                :$Effdt,:#Tx_Emply)
!--------------------------------------------------------------------------
!       Select : next employer contribution rate in the system
!               (Tables JOB or FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :            $NTE_Effdt              Effdt
!                       $NTE_Debut_Calc         Semester Start Date used for this batch
!                       $SIRH                   Informations from HRMS
!
!       OUT :           $Effdt                  Employer contribution rate update Effdt in dtu format
!                       #Tx_Emply               Employer contribution rate after update
!
!---------------------------------------------------------------------------
display '- Next Taux Employeur'

let $Effdt = ''
let #Tx_Emply = 0


let $sql-statement = 'FPA1100.SQC,Next-Tx-Emply,Select,FPMCNTR_EMP_TBL'

BEGIN-SELECT On-Error=SQL-Error
{DATEOUT-PREFIX}E.EFFDT{DATEOUT-SUFFIX}        &E_EFFDT
E.FP_CNTRB_EMPLY_CD                     &E_FP_CNTRB_EMPLY_CD

        let $Effdt_nat          = &E_EFFDT
        do Convert-To-DTU-Date($Effdt_nat,$Effdt)

        let #Tx_Emply   = &E_FP_CNTRB_EMPLY_CD


From PS_FPMCNTR_EMP_TBL E

Where E.EFF_STATUS = 'A'

and E.EFFDT = (select Min(E1.EFFDT)
                                from    PS_FPMCNTR_EMP_TBL E1
                                where   E1.EFFDT > {DATEIN-PREFIX}$NTE_Effdt{DATEIN-SUFFIX}
                                and     E1.EFFDT < {DATEIN-PREFIX}$NTE_Debut_Calc{DATEIN-SUFFIX})
END-SELECT

END-PROCEDURE Next-Tx-Emply



!--------------------------------------------------------------------------
!       Check : Index and Point value from the "Calls Results" table
!        with current system at the same Effdt
!               (Tables JOB ou FPA_EXT_INF_TBL)
!--------------------------------------------------------------------------
!
!       IN :    $VI_Mat             Emplid
!               #VI_Dos             Record Number
!               $VI_Effdt           Effdt
!               $SIRH               Informations from HRMS
!               #VI_Ind             Index
!               #VI_Val             Point value
!
!       OUT :   $Modif_Ind          Index update (Y/N)
!               $Modif_Val          Point Value update (Y/N)
!
!---------------------------------------------------------------------------
BEGIN-PROCEDURE Verif-Ind-Val ($VI_Mat,#VI_Dos,$VI_Effdt,$SIRH,#VI_ind,
                                                                #VI_Val,:$Modif_Ind,:$Modif_Val)
display '- Verification Indice / Point'

let $sql-statement = 'FPA1100.SQC,Verif-Ind-Val,Select,FPA_JOB'
BEGIN-SELECT On-Error=SQL-Error

J.FP_INCS_IND                   &VI_J.INDICE
P.FP_POINT_VAL                  &VI_J.VAL

        let #J_Indice   = &VI_J.INDICE
        let #J_Val              = &VI_J.VAL

        If #J_Indice <> #VI_Ind
                let $Modif_Ind = 'Y'            ! Index updated
                display 'Indice Ancien / Actuel: ' noline
                display #VI_Ind noline
                display '  /  '                                         noline
                display #J_Indice
        else
                let $Modif_Ind = 'N'            ! Indice unchanged
        End-If

        If #J_Val <> #VI_Val
                let $Modif_Val = 'Y'            ! Point value modified
                display 'Point Ancien / Actuel: ' noline
                display #VI_Val noline
                display '  /  '                                         noline
                display #J_Val
        else
                let $Modif_Val = 'N'            ! Point value unchanged
        End-If

From    PS_JOB_JR              J,
        PS_FPMPOINTYP_TBL       P,               ! Point value
        PS_FPMRANK_TBL          R,               ! Grade
        PS_FPMSALMATRX_TBL      M                ! Salary Grade Table
        ,PS_FPFAST_PERS_VW2        SCRTY           !SQR security

!** Employee Record
Where   J.EMPLID = $VI_Mat
and             J.EMPL_RCD = #VI_Dos

!** most recent Effdt
and             J.EFFDT = (Select Max(J2.EFFDT)
                                        from    PS_JOB_JR J2
                                        where   J2.EMPLID   = J.EMPLID
                                        and     J2.EMPL_RCD = J.EMPL_RCD
                                        and     J2.EFFDT    <= {DATEIN-PREFIX}$VI_Effdt{DATEIN-SUFFIX})

!** Highest sequence number
and             J.EFFSEQ = (Select max(J1.EFFSEQ)
                                        from PS_JOB_JR J1
                                        where   J1.EMPLID   = J.EMPLID
                                        and     J1.EMPL_RCD = J.EMPL_RCD
                                        and     J1.EFFDT    = J.EFFDT)

!** Point value
and     P.FP_POINTYP_CD = M.FP_POINTYP_CD
and     P.EFF_STATUS = 'A'
and     P.EFFDT = (select Max (P1.EFFDT)
                                        from PS_FPMPOINTYP_TBL P1
                                        where   P1.FP_POINTYP_CD = P.FP_POINTYP_CD
                                        and     P1.EFFDT <=     {DATEIN-PREFIX}$VI_Effdt{DATEIN-SUFFIX})

!** Grade
and     R.FP_RANK_CD = J.FP_RANK_CD
and     R.SETID = J.FP_SETID_RANK
and     R.EFF_STATUS = 'A'
and             P.EFFDT = (select Max (R1.EFFDT)
                           from PS_FPMRANK_TBL R1
                           where   R1.FP_RANK_CD = J.FP_RANK_CD
                           and     R1.SETID = J.FP_SETID_RANK
                           and     R1.EFFDT <= J.EFFDT)
!Salary Grade Table

and M.FP_MATRIX_TYP = R.FP_MATRIX_TYP
and M.FP_MATRIX_CD = R.FP_MATRIX_CD
and M.FP_SCALE_CD = R.FP_SCALE_CD
and M.EFF_STATUS = 'A'
and M.EFFDT = (Select max(M1.EFFDT)
                                from PS_FPMSALMATRX_TBL M1
                                where M1.FP_MATRIX_TYP = R.FP_MATRIX_TYP
                                and   M1.FP_MATRIX_CD = R.FP_MATRIX_CD
                                and   M1.FP_SCALE_CD = R.FP_SCALE_CD
                                and   M1.EFFDT <= J.EFFDT)

and J.EMPLID = SCRTY.EMPLID     !SQR security
[$_SecurityClause]               !SQR security

END-SELECT

END-PROCEDURE Verif-Ind-Val



!-----------------------------------------------------------------------------------------------------
!       Check : Working time percentage, Annual Compensation Value, employee / employer contribution
!       rates from table "Calls Results", with actual system values at the same effdt
!                        (Tables JOB,FPMSTATUSEE_TBL and FPMCNTR_EMP_TBL)
!------------------------------------------------------------------------------------------------------
!
!       IN :    $VQ_Mat                         Emplid
!               #VQ_Dos                         Record Number
!               $VQ_Effdt                       Effdt
!               $SIRH                           Informations from HRMS
!               $VQ_Qte                         Working time percentage
!               #VQ_Vat                         Annual Compensation Value
!               #VQ_Tx_Ag                       Employee Contribution Rate
!               #VQ_Tx_Emply                    Employer Contribution Rate
!
!       OUT :   $Modif_Qte                      working time percentage update (Y/N)
!               $Modif_Vat                      Annual Compensation Value update(Y/N)
!               $Modif_Tx_Ag                    Employee Contribution Rate update (Y/N)
!               $Modif_Tx_Emply                 Employer Contribution Rate update (Y/N)
!
!------------------------------------------------------------------------------------------------------
BEGIN-PROCEDURE Verif-Infos ($VQ_Mat,#VQ_Dos,$VQ_Effdt,$E_SIRH,$VQ_Qte,#VQ_Vat,#VQ_Tx_Ag,#VQ_Tx_Emply,
                                         :$Modif_Qte,:$Modif_Vat,:$Modif_Tx_Ag,:$Modif_Tx_Emply,:$J_Scnd_Typ,:$J_Civil_Pension)
display '- Verification des autres Infos'

let $sql-statement = 'FPA1100.SQC,Verif-Infos,Select,FPA_JOB...'
BEGIN-SELECT On-Error=SQL-Error

J.FP_SCND_TYP                                                   &VQ_J.SCND_TYP
J.FP_CIVIL_PENSION                                              &VQ_J.CIVIL_PENSION
J.FP_PT_PCT_DET                                                 &VQ_J.QUOTITE
JO.ANNUAL_RT                                                    &VQ_J.VAT
T.FP_CNTRB_AGT                                                  &VQ_J.TX_AG
TE.FP_CNTRB_EMPLY                                               &VQ_J.TX_EMPLY

        let $J_Qte              = &VQ_J.QUOTITE
        let #J_Vat              = &VQ_J.VAT
        let #J_Tx_Ag    = &VQ_J.TX_AG
        let #J_Tx_Emply = &VQ_J.TX_EMPLY

        let $J_Scnd_Typ = rtrim(&VQ_J.SCND_TYP ,' ')
        let $J_Civil_Pension = rtrim(&VQ_J.CIVIL_PENSION ,' ')

        IF $J_Qte <> $VQ_Qte
                let $Modif_Qte = 'Y'                            ! Working time percentage updated
                display 'Qte Ancienne / Actuelle : '    noline
                display $VQ_Qte                                 99      noline
                display '  /  '                                         noline
                display $J_Qte                                  99
        else
                let $Modif_Qte = 'N'                            ! Working time percentage unchanged
        END-IF

        IF #J_Vat <> #VQ_Vat
                let $Modif_Vat = 'Y'                            ! Annual Compensation Value updated
                display 'VAT Ancienne / Actuelle : '    noline
                display #VQ_Vat                                         noline
                display '  /  '                                         noline
                display #J_Vat
        else
                let $Modif_Vat = 'N'                            ! Annual compensation value unchanged
        END-IF

        IF #J_Tx_Ag <> #VQ_Tx_Ag
                let $Modif_Tx_Ag = 'Y'                          ! Employee Contribution Rate updated
                display 'Tx Agent Ancien / Actuel : '   noline
                display #VQ_Tx_Ag                       99.99           noline
                display '  /  '                                                 noline
                display #J_Tx_Ag                        99.99
        else
                let $Modif_Tx_Ag = 'N'                          ! Employee Contribution Rate unchanged
        END-IF

        IF #J_Tx_Emply <> #VQ_Tx_Emply
                let $Modif_Tx_Emply = 'Y'                               ! Employer Contribution Rate updated
                display 'Tx Employeur Ancien / Actuel : '       noline
                display #VQ_Tx_Emply                    99.99           noline
                display '  /  '                                                         noline
                display #J_Tx_Emply                             99.99
        else
                let $Modif_Tx_Emply = 'N'                               ! Employer Contribution Rate unchanged
        END-IF



FROM    PS_JOB_JR               J,
        PS_JOB                  JO,             ! JOB General
        PS_FPAEESTATUS          S,              ! Employee Status
        PS_FPMSTATUSEE_TBL      T,              ! Employee Contribution Rate
        PS_FPMCNTR_EMP_TBL      TE              ! Employer Contribution Rate
        ,PS_FPFAST_PERS_VW2     SCRTY           ! SQR security

!** Employee record
WHERE   J.EMPLID = $VQ_Mat
and             J.EMPL_RCD = #VQ_Dos

!** moste recent Effdt
and             J.EFFDT = (Select Max(J2.EFFDT)
                                        from    PS_JOB_JR J2
                                        where   J2.EMPLID   = J.EMPLID
                                        and     J2.EMPL_RCD = J.EMPL_RCD
                                        and     J2.EFFDT    <= {DATEIN-PREFIX}$VQ_Effdt{DATEIN-SUFFIX})

!** highest sequence number
and             J.EFFSEQ = (Select max(J1.EFFSEQ)
                                        from PS_JOB_JR J1
                                        where   J1.EMPLID   = J.EMPLID
                                        and     J1.EMPL_RCD = J.EMPL_RCD
                                        and     J1.EFFDT    = J.EFFDT)

!** Employee status
and             S.EMPLID = J.EMPLID
and             S.EMPL_RCD = J.EMPL_RCD
and             S.EFFDT = (select max(S1.EFFDT)
                                        from PS_FPAEESTATUS S1
                                        where   S1.EMPLID = S.EMPLID
                                        and     S1.EMPL_RCD = S.EMPL_RCD
                                        and     S1.EFFDT <= {DATEIN-PREFIX}$VQ_Effdt{DATEIN-SUFFIX})

!** Employee Contribution Rate
and     T.FP_STATUSEE_CD = S.FP_STATUSEE_CD
and     T.EFF_STATUS = 'A'
and             T.EFFDT = (Select max(T1.EFFDT)
                                        from PS_FPMSTATUSEE_TBL T1
                                        where   T1.FP_STATUSEE_CD = T.FP_STATUSEE_CD
                                        and     T1.EFFDT <= {DATEIN-PREFIX}$VQ_Effdt{DATEIN-SUFFIX})

!** Employer Contribution Rate
and             TE.EFF_STATUS = 'A'
and             TE.EFFDT = (Select max(TE1.EFFDT)
                                        from PS_FPMCNTR_EMP_TBL TE1
                                        where   TE1.EFFDT <= {DATEIN-PREFIX}$VQ_Effdt{DATEIN-SUFFIX})

!** Annual Compensation Value
and             JO.EMPLID       = J.EMPLID
and             JO.EMPL_RCD     = J.EMPL_RCD
and             JO.EFFDT        = J.EFFDT
and             JO.EFFSEQ       = J.EFFSEQ

and J.EMPLID = SCRTY.EMPLID     !SQR security
[$_SecurityClause]               !SQR security

END-SELECT

END-PROCEDURE Verif-Infos




!***********************************
begin-procedure Get-Employee-Address ($emplid,$effdt,:$address1,:$address2,:$address3,:$address4,:$city,:$num1,:$num2,
 :$house_type,:$addr_field1,:$addr_field2,:$addr_field3,:$geo_code,:$in_city_limit,:$postal,:$country,:$state,:$county)
!***********************************
begin-select
ADDR.ADDRESS_TYPE
ADDR.ADDRESS1
ADDR.ADDRESS2
ADDR.ADDRESS3
ADDR.ADDRESS4
ADDR.CITY
ADDR.NUM1
ADDR.NUM2
ADDR.HOUSE_TYPE
ADDR.ADDR_FIELD1
ADDR.ADDR_FIELD2
ADDR.ADDR_FIELD3
ADDR.GEO_CODE
ADDR.IN_CITY_LIMIT
ADDR.STATE
ADDR.POSTAL
ADDR.COUNTRY
ADDR.COUNTY



  let $address1 = RTRIM(&ADDR.address1,' ')


  let $address2 = RTRIM(&ADDR.address2,' ')

  let $address3 = RTRIM(&ADDR.address3,' ')

  let $address4 = RTRIM(&ADDR.address4,' ')

  let $city = RTRIM(&ADDR.city,' ')

  let $num1 = RTRIM(&ADDR.num1,' ')

  let $num2 = RTRIM(&ADDR.num2,' ')

  let $house_type = RTRIM(&ADDR.house_type,' ')


  let $addr_field1 = RTRIM(&ADDR.addr_field1,' ')

  let $addr_field2 = RTRIM(&ADDR.addr_field2,' ')

  let $addr_field3 = RTRIM(&ADDR.addr_field3,' ')

  let $geo_code = RTRIM(&ADDR.geo_code,' ')

  let $in_city_limit = RTRIM(&ADDR.in_city_limit,' ')

  let $country = RTRIM(&ADDR.COUNTRY,' ')

  let $postal = RTRIM(&ADDR.postal,' ')

  let $state = RTRIM(&ADDR.STATE,' ')

  let $county = RTRIM(&ADDR.COUNTY,' ')





  exit-select   !use the first row returned

 FROM PS_ADDRESSES ADDR
WHERE ADDR.EMPLID = $current_emplid
  AND ADDR.ADDRESS_TYPE IN ('HOME','MAIL')
  AND ADDR.EFFDT = (SELECT MAX(ADDR1.EFFDT)
                      FROM PS_ADDRESSES ADDR1
                     WHERE ADDR1.EMPLID = ADDR.EMPLID
                       AND ADDR1.ADDRESS_TYPE = ADDR.ADDRESS_TYPE
                       AND ADDR1.EFFDT <=  {DATEIN-PREFIX}$effdt {DATEIN-SUFFIX})
ORDER BY ADDR.ADDRESS_TYPE DESC
end-select


  if $address1 = ''
      move ' ' to $address1
  end-if

  if $address2 = ''
      move ' ' to $address2
  end-if


  if $address3 = ''
      move ' ' to $address3
  end-if

  if $address4 = ''
      move ' ' to $address4
  end-if

  if $city = ''
      move ' ' to $city
  end-if


  if $num1 = ''
      move ' ' to $num1
  end-if

  if $num2 = ''
      move ' ' to $num2
  end-if


  if $house_type = ''
      move ' ' to $house_type
  end-if

  if $addr_field1 = ''
      move ' ' to $addr_field1
  end-if


  if $addr_field2 = ''
      move ' ' to $addr_field2
  end-if


  if $addr_field3 = ''
      move ' ' to $addr_field3
  end-if


  if $geo_code = ''
    move ' ' to $geo_code
  end-if

  if $in_city_limit = ''
    move ' ' to $in_city_limit
  end-if

  if $country = ''
      move ' ' to $country
  end-if


  if $postal = ''
      move ' ' to $postal
  end-if


  if $state = ''
      move ' ' to $state
  end-if

  if $county = ''
      move ' ' to $county
  end-if

End-Procedure






!------------------------------
! Needed includes
!------------------------------

!YVG? #Include 'datetime.sqc'    ! Routines for date and time formatting
!#include 'curdttim.sqc'         ! Get-Current-DateTime procedure
!#include 'stdapi.sqc'           ! Routines to update run status
!#Include 'number.sqc'           ! Routines to format numbers
!YVG? #Include 'datemath.sqc'    ! Routines for date arithmetic
!#Include 'fptestdt.sqc'       ! Routines for date and time formatting
!#Include 'fpparam.sqc'          ! Recupere donnees tbl parametres
!#Include 'fpa1105.sqc'          ! fonctions depart / retour detachement
!#Include 'hrsecty.sqc'          ! Get SQR Security parameters
