!***********************************************************************
!  CTX910AM: CANADA Magnetic Media Reporting - T4A                     *
!                                                                      *
!             NOTE: "#IFDEF TAXTEST" in main SELECT is used for        *
!                   testing this report against DEMO database          *
!***********************************************************************
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
!                                                                      *
! This module contains confidential and proprietary information        *
! of Oracle; it is not to be copied, reproduced, or transmitted        *
! in any form, by any means, in whole or in part, nor is it to         *
! be used for any purpose other than that for which it is              *
! expressly provided under the applicable license agreement.           *
!                                                                      *
! Copyright (C) 2006 Oracle. All Rights Reserved.                      *
!                                                                      *
!***********************************************************************
!***********************************************************************
!                                                                      *
!          $Date:  2006/07/20:03:28:13                                 !
!       $Release:  HR9                                                 !
!      $Revision:  101                                                 !
!                                                                      *
!***********************************************************************

#include 'setenv.sqc' !Set environment

#Include 'setup32.sqc'  !printer and page-size init
#Include 'ctxrnctl.sqc'  !Get-Tax-Reporting-Run-Controls procedure

begin-report
  do Init-Report

  do Process-Main

  close 10
  if $FileType = 'D'
    close 20
  end-if

 #ifdef PRCSSCHD
  do StdAPI-Term
 #endif

end-report

begin-heading 3
  #Include 'stdhdg01.sqc'
  print 'Business Number  '  (3,1)
  print $ReportingID       (0,33)
  print $CalYear           (3,,)      center
end-heading

begin-procedure Init-Report
  do Init-DateTime
  do Init-Number
  do Get-Current-DateTime

 #ifdef PRCSSCHD
  do StdAPI-Init
 #endif

  do Initialization
  move 'CTX910AM' to $ReportID

 if $FileType = 'D'
  display ''
  display 'Creating Diskette File for CANADA T4A Reporting'
 else
  display ''
  display 'Creating Tape File for CANADA T4A Reporting'
 end-if

end-procedure

begin-procedure Initialization

  do Get-Can-Tax-Processing-Params
  let $FirstRecord = 'Y'
  let $FoundNegative = 'N'
  let $Box16Code = '00'
  let $Box18Code = '00'
  let $Box24Code = '00'
  let $Box26Code = '00'
  let $Box27Code = '00'
  let $Box28Code = '00'
  let $Box32Code = '00'
  let $Box40Code = '00'

  move 'Canada T4A Magnetic Media Summary Report' to $ReportTitle
  move &TX.Balance_Year to $RptYear 9999
  move $RptYear          to $CalendarYr
  move $RptYear          to $RptYear ~~xx
  move $PeriodEndDate    to $AsOfDate

  move &TX.Balance_Year to $CalYear 9999
  let $AsOfDate = $CalYear || '1231'
  do Format-DateTime($AsOfDate, $AsOfDate, {DEFCMP}, '', 'native')

  display 'As of Today = ' noline
  display $AsOfToday

  move '1' to $MMLZero
  move '1' to $Year4
  move '-' to $DDelimiter
  do Format-DateTime($AsOfToday, $AsOfDateYMD, {DEFYMD},'','')
  move $AsOfDateYMD to $AsOfYear xxxx

  move $AsOfYear  to #AsOfYear
  move #AsOfYear  to #saveAsOfYear
  subtract 1 from #AsOfYear

  if &TX.Balance_Year <> #AsOfYear and $Prcs_Process_Instance = ''
    display ''
    display 'Current Year is not one greater than Tax Reporting Year.'
    display 'Current Year is    ' noline
    display  #saveAsOfYear  9999
    display 'Tax Reporting Year ' noline
    display &TX.Balance_Year
    input $Answer maxlen=1 'Current Year is not one greater than Tax Reporting Year. Do you want to continue? (Y/N)'
    uppercase $Answer
    if $Answer <> 'Y'
      stop
    end-if
  end-if

   move 744 to #RecordLength
   add 2 to #RecordLength

  if $PRCS_Process_Instance = ''
     do Prompts
     do Evaluate-File-Type
  else
#ifdef PRCSSCHD
     do Select-Canadian-YrEnd-Parameters
     do Convert-Parameters
#endif
  end-if

  if $FileType = 'D'
      do Calculate-Diskette-Capacity
  end-if

  do Open-File

  do Initialize-Detail
  do Initialize-Summary

end-procedure

begin-procedure Open-File
if $FileType = 'D'
   move 0 to #RecordCount
   if #FileExtension <> 0
      close 20
   else
#ifdef MPE
  let $feq='FILE CTXAM.DAT; REC=-744,,F,ASCII'
  call system using $feq #status
  open 'CTXAM.DAT' as 10 for-writing record=744:fixed
#else
  open '{IMPORTPREFIX}CTXAM{IMPORTSUFFIX}' as 10 for-writing record=744:fixed
#endif

   end-if
   add 1 to #FileExtension
#ifdef MPE
   move #FileExtension to $FileExtension 9
   let $FileID = 'CTXAM' || $FileExtension || '.DAT'
   let $feq='FILE ' || $FileID || '; REC=-744,,F,ASCII'
   call system using $feq #status
#else
   #ifdef OS400
      move #FileExtension to $FileExtension 099
      let $FileID = 'CTXAM' || '(D' || $FileExtension || ')'
   #else
      #ifdef MVS
         move #FileExtension to $FileExtension 099
         let $FileID = 'CTXAM' || $FileExtension
      #else
         move #FileExtension to $FileExtension 099
         let $FileID = '{IMPORTPREFIX}' || 'CTXAM.' || $FileExtension
      #endif
   #endif
#endif
   open $FileID as 20 for-writing record=744:fixed
else
#ifdef MPE
  let $feq='FILE CTXAM.DAT; REC=-744,,F,ASCII'
  call system using $feq #status
  open 'CTXAM.DAT' as 10 for-writing record=744:fixed
#else
  open '{IMPORTPREFIX}CTXAM{IMPORTSUFFIX}' as 10 for-writing record=744:fixed
#endif

end-if
end-procedure


begin-procedure Process-Main
  do Write-Transmitter-Record


begin-SELECT
S.COMPANY
S.REPORTING_ID
S.WAGE_LOSS_PLAN
S.PROVINCE
S.SEQUENCE_NUMBER
S.TAXFORM_ID
S.UI_EXEMPT
E.EMPLID
E.SIN
E.SLIP_SURNAME
E.SLIP_FIRST_NAME
E.SLIP_INITIAL
E.ADDRESS1
E.ADDRESS2
E.CITY
E.PROVINCE
E.COUNTRY
E.POSTAL
E.DECEASED

  do Check-For-Negative-Amt

  if (&E.EmplID <> $EmplID and
      $FirstRecord <> 'Y') or
     (&S.Reporting_ID <> $ReportingID and
      $FirstRecord <> 'Y')

     if $E_FoundNegative = 'N'
        do Get-Box38
        do Write-T4A-Record
     else
        do Error-Report
        do Initialize-Detail
     end-if
  end-if

  if &S.Reporting_ID <> $ReportingID and
     $FirstRecord <> 'Y'
     do Write-Summary-Record
  end-if

  let $FirstRecord = 'N'
  do Save-Employee-Data

  if $FoundNegative = 'N'
    do Get-Detail-Data
  end-if

FROM PS_CAN_YE_EMPL  E,
     PS_CAN_YE_SLIP  S
WHERE E.CALENDAR_YEAR = &TX.Balance_Year
  AND S.CALENDAR_YEAR = &TX.Balance_Year
  AND S.TAXFORM_ID = 'A'
  AND S.COMPANY = E.COMPANY
  AND E.EMPLID = S.EMPLID
  AND E.SEQUENCE_NUMBER = S.SEQUENCE_NUMBER
  AND S.YE_SLIP_PROCESS = 'O'
ORDER BY S.REPORTING_ID ASC, E.SLIP_SURNAME ASC,
         E.SLIP_FIRST_NAME ASC, E.EMPLID ASC
end-SELECT

     if $E_FoundNegative = 'N'
        do Get-Box38
        do Write-T4A-Record
     else
        do Error-Report
        do Initialize-Detail
     end-if
     do Write-Summary-Record

end-procedure

begin-procedure Save-Employee-Data

  if &S.Company <> $PriorCompany
     move &S.Company to $Company
     do Get-Company-Data
     move &CT.Descr to $CompanyName
  end-if
  move &S.Company to $PriorCompany

  move &S.Reporting_ID to $ReportingID

  let $E_Surname = substr(&E.SLIP_Surname, 1, 20)
  do convert-to-char($E_Surname, $E_Surname)

  move &E.SLIP_First_Name to $E_FirstName
  do convert-to-char($E_FirstName, $E_FirstName)

  move &E.SLIP_Initial to $E_Initial
  do convert-to-char($E_Initial, $E_Initial)

  move &E.SIN to $SIN
  if  rtrim($SIN, ' ') = '' OR
      rtrim($SIN, ' ') = '999999999'
      move '000000000' to $SIN
  end-if
  move &E.EmplID to $EmplID
  move &E.Address1 to $E_Street
  do convert-to-char($E_Street, $E_Street)

  move &E.Address2 to $E_Street2
  do convert-to-char($E_Street2, $E_Street2)

  move &E.City to $E_City
  do convert-to-char($E_City, $E_City)

  let $E_Province = rtrim(&E.Province, ' ')
  move &E.Country to $E_Country
  let $WorkProvince = rtrim(&S.Province, ' ')
  if $E_Country = 'CAN'
     move &E.Postal to $PostalCd
     do Check-Postal-Code
     move $PostalCd to $E_PostalCode
  else
     move &E.Postal to $E_PostalCode
  end-if

  uppercase $E_Surname
  uppercase $E_FirstName
  uppercase $E_Initial
  uppercase $E_Street
  uppercase $E_Street2
  uppercase $E_City
  uppercase $E_Province
  uppercase $E_Country
  uppercase $E_PostalCode
  uppercase $E_WorkProvince

  move $FoundNegative to $E_FoundNegative

end-procedure


begin-procedure Check-For-Negative-Amt

  move 'N' to $FoundNegative

begin-SELECT
NA.BOX
NA.CAN_YE_BOX_AMT

  if &NA.CAN_YE_BOX_AMT < 0
    move 'Y' to $FoundNegative
  end-if

FROM PS_CAN_YE_DETAIL  NA
WHERE NA.COMPANY = &S.Company
  AND NA.EMPLID  = &E.EmplID
  AND NA.CALENDAR_YEAR = &TX.Balance_Year
  AND NA.TAXFORM_ID = &S.Taxform_ID
  AND NA.WAGE_LOSS_PLAN = &S.Wage_Loss_Plan
  AND NA.PROVINCE = &S.Province
  AND NA.SEQUENCE_NUMBER = &S.Sequence_Number

end-SELECT

end-procedure


begin-procedure Get-Detail-Data

begin-SELECT
D.BOX
D.CAN_YE_BOX_TEXT
D.CAN_YE_BOX_AMT

  do Save-Detail-Data

FROM PS_CAN_YE_DETAIL  D
WHERE D.COMPANY = &S.Company
  AND D.EMPLID  = &E.EmplID
  AND D.CALENDAR_YEAR = &TX.Balance_Year
  AND D.TAXFORM_ID = &S.Taxform_ID
  AND D.WAGE_LOSS_PLAN = &S.Wage_Loss_Plan
  AND D.PROVINCE = &S.Province
  AND D.SEQUENCE_NUMBER = &S.Sequence_Number

end-SELECT

end-procedure

begin-procedure Save-Detail-Data

  let $Box = RTRIM(&D.Box, ' ')

  if $Box = '36'
     let $PensionPlanID = RTRIM(&D.CAN_YE_Box_Text, ' ')
     let $PensionPlanID = lpad($PensionPlanId, 7, '0')
     do Save-Pension-Plan-ID
  end-if


  let #BoxAmt = 100 * &D.CAN_YE_Box_Amt

  if #BoxAmt > 0 and $FoundNegative = 'N'
    evaluate $Box

       when = '16'
          add #BoxAmt to #Box16Amt
          add #BoxAmt to #SumPension

       when = '16A'
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '16B'
          add #BoxAmt to #Box16BAmt
          if $Box16Code = '00' or
             $Box16Code = '09'
             move '09' to $Box16Code
          else
             move '13' to $Box16Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '16C'
          add #BoxAmt to #Box16CAmt
          if $Box16Code = '00' or
             $Box16Code = '11'
             move '11' to $Box16Code
          else
             move '13' to $Box16Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '16D'
          add #BoxAmt to #Box16DAmt
          if $Box16Code = '00' or
             $Box16Code = '14'
             move '14' to $Box16Code
          else
             move '13' to $Box16Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18'
          add #BoxAmt to #Box18Amt
          add #BoxAmt to #SumLumpSum

       when = '18A'
          add #BoxAmt to #Box18AAmt
          if $Box18Code = '00' or
             $Box18Code = '02'
             move '02' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18B'
          add #BoxAmt to #Box18BAmt
          if $Box18Code = '00' or
             $Box18Code = '08'
             move '08' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18C'
          add #BoxAmt to #Box18CAmt
          if $Box18Code = '00' or
             $Box18Code = '08'
             move '08' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18D'
          add #BoxAmt to #Box18DAmt
          if $Box18Code = '00' or
             $Box18Code = '09'
             move '09' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18E'
          add #BoxAmt to #Box18EAmt
          if $Box18Code = '00' or
             $Box18Code = '10'
             move '10' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18F'
          add #BoxAmt to #Box18FAmt
          if $Box18Code = '00' or
             $Box18Code = '08'
             move '08' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '18G'
          add #BoxAmt to #Box18GAmt
          if $Box18Code = '00' or
             $Box18Code = '14'
             move '14' to $Box18Code
          else
             move '13' to $Box18Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '20'
          add #BoxAmt to #Box20Amt
          add #BoxAmt to #SumCommissions

       when = '22'
          add #BoxAmt to #Box22Amt
          add #BoxAmt to #SumIncomeTax

       when = '24'
          add #BoxAmt to #Box24Amt
          add #BoxAmt to #SumAnnuities

       when = '24A'
          add #BoxAmt to #Box24AAmt
          if $Box24Code = '00' or
             $Box24Code = '10'
             move '10' to $Box24Code
          else
             move '13' to $Box24Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '24B'
          add #BoxAmt to #Box24BAmt
          if $Box24Code = '00' or
             $Box24Code = '15'
             move '15' to $Box24Code
          else
             move '13' to $Box24Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '26'
          add #BoxAmt to #Box26Amt
          add #BoxAmt to #SumRetiringAllow

       when = '26A'
          add #BoxAmt to #Box26AAmt
          if $Box26Code = '00' or
             $Box26Code = '14'
             move '14' to $Box26Code
          else
             move '13' to $Box26Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '27'
          add #BoxAmt to #Box27Amt
          add #BoxAmt to #SumNonRetiringAllow

       when = '27A'
          add #BoxAmt to #Box27AAmt
          if $Box27Code = '00' or
             $Box27Code = '14'
            move '14' to $Box27Code
          else
            move '13' to $Box27Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28'
          add #BoxAmt to #Box28Amt
          add #BoxAmt to #SumOther

       when = '28A'
          if $Box28Code = '00' or
             $Box28Code = '02'
             move '02' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28B'
          if $Box28Code = '00' or
             $Box28Code = '03'
             move '03' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28C'
          add #BoxAmt to #Box28CAmt
          if $Box28Code = '00' or
             $Box28Code = '04'
             move '04' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28D'
          add #BoxAmt to #Box28DAmt
          if $Box28Code = '00' or
             $Box28Code = '05'
             move '05' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28E'
          add #BoxAmt to #Box28EAmt
          if $Box28Code = '00' or
             $Box28Code = '06'
             move '06' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28F'
          add #BoxAmt to #Box28FAmt
          if $Box28Code = '00' or
             $Box28Code = '07'
             move '07' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28G'
          if $Box28Code = '00' or
             $Box28Code = '08'
             move '08' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28H'
          if $Box28Code = '00' or
             $Box28Code = '09'
             move '09' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28I'
          if $Box28Code = '00' or
             $Box28Code = '11'
             move '11' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28J'
          add #BoxAmt to #Box28JAmt
          if $Box28Code = '00' or
             $Box28Code = '14'
             move '14' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28R'
          add #BoxAmt to #Box28RAmt
          if $Box28Code = '00' or
             $Box28Code = '23'
             move '23' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28M'
          add #BoxAmt to #Box28MAmt
          if $Box28Code = '00' or
             $Box28Code = '16'
             move '16' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28N'
          add #BoxAmt to #Box28NAmt
          if $Box28Code = '00' or
             $Box28Code = '17'
             move '17' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28O'
          add #BoxAmt to #Box28OAmt
          if $Box28Code = '00' or
             $Box28Code = '18'
             move '18' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28S'
          add #BoxAmt to #Box28SAmt
          if $Box28Code = '00' or
             $Box28Code = '24'
             move '24' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28T'
          add #BoxAmt to #Box28TAmt
          if $Box28Code = '00' or
             $Box28Code = '25'
             move '25' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '28U'
          add #BoxAmt to #Box28UAmt
          if $Box28Code = '00' or
             $Box28Code = '19'
             move '19' to $Box28Code
          else
             move '13' to $Box28Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '30'
          add #BoxAmt to #Box30Amt
          add #BoxAmt to #SumPatronage

       when = '32'
          add #BoxAmt to #Box32Amt
          add #BoxAmt to #SumPPContribPast

       when = '32A'
          add #BoxAmt to #Box32AAmt
          if $Box32Code = '00' or
             $Box32Code = '26'
             move '26' to $Box32Code
          else
             move '13' to $Box32Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '34'
          add #BoxAmt to #Box34Amt
          add #BoxAmt to #SumPensionAdj

       when = '40'
          add #BoxAmt to #Box40Amt
          add #BoxAmt to #SumRESPIncomePay

       when = '40A'
          if $Box40Code = '00' or
             $Box40Code = '22'
             move '22' to $Box40Code
          else
             move '13' to $Box40Code
          end-if
          move $Box to $SaveBox
          add 1 to #FNCount

       when = '42'
          add #BoxAmt to #Box42Amt
          add #BoxAmt to #SumRESPAssistPay

       when = '46'
          add #BoxAmt to #Box46Amt
          add #BoxAmt to #SumCharity

     end-evaluate
  end-if

end-procedure

begin-procedure Get-Box38

   if #FNCount > 1
      move '13' to $Box38Code
      move 'MULTIPLE FOOTNOTES' to $FNDescr
   else
      if #FNCount = 0
         move '00' to $Box38Code
      else
         do Find-Box-Descr
      end-if
   end-if

end-procedure

begin-procedure Find-Box-Descr

begin-SELECT
FN.BOX_NOTE_CD
FN.BOX_NOTE_TEXT

  move &FN.Box_Note_Cd to $Box38Code
  move &FN.Box_Note_Text to $FNDescr

FROM PS_TAXFORM_NOTES  FN
WHERE BOX = $SaveBox
  AND TAXFORM_ID = 'A'
  AND  EFFDT = (SELECT MAX(EFFDT)
                FROM PS_TAXFORM_BOX
                WHERE TAXFORM_ID = 'A'
                  AND BOX = $SaveBox
                  AND EFFDT <= $AsOfDate)
end-SELECT

end-procedure


begin-Procedure Save-Pension-Plan-ID

  if $PlanA = '0000000'
     move $PensionPlanID to $PlanA
  else
     if $PensionPlanID <> $PlanA
        if $PlanB = '0000000'
           move $PensionPlanID to $PlanB
        else
          if $PensionPlanID <> $PlanB
             if $PlanC = '0000000'
                move $PensionPlanID to $PlanC
             end-if
          end-if
        end-if
     end-if
  end-if

end-procedure

begin-Procedure Write-Transmitter-Record
  move &TX.Company       to $Company  !TX.Company is the Transmitter
  if RTRIM($Company,' ') = ''
    display '*** Company field blank on Tax Run Control Record ***'
    display '***************** Processing stopped ****************'
    stop
  end-if

  do Get-Company-Data                 !Transmitter identifying data
  move &TX.Transmitter_ID to $TransmitterID

  move &TX.Comm_Language     to $Language
  move &TX.Tech_Contact_Name to $ContactName
  uppercase $ContactName

  if &TX.Tech_Contact_Acode <> 0
     let $TechContactAc = &TX.Tech_Contact_Acode
  else
     move '000' to $TechContactAc
  end-if

  if &TX.Tech_Contact_Phone <> 0
     let $TechContactPhone = &TX.Tech_Contact_Phone
  else
     move '0000000' to $TechContactPhone
  end-if

  If $CO_FOUND = 'Y'
     move $CompanyName     to $TransmitterName
     move $CompnyAdd1      to $TransmitterStreet
     move $CompnyAdd2      to $TransmitterStreet2
     move $CompnyCity      to $TransmitterCity
     let $TransmitterProvince = rtrim(&CT.State, ' ')
     move &CT.Country      to $TransmitterCountry

     if &CT.Country = 'CAN'
        move &CT.Postal to $PostalCd
        do Check-Postal-Code
        move $PostalCd to $TransmitterPostalCode
     else
        move &CT.Postal to $TransmitterPostalCode
     end-if
  else
     move &TX.Descr        to  $TransmitterName
     move &TX.Address1     to  $TransmitterStreet
     move &TX.Address2     to  $TransmitterStreet2
     move &TX.City         to  $TransmitterCity

     let $TransmitterProvince = rtrim(&TX.Province, ' ')
     move &TX.Country      to $TransmitterCountry
     move &TX.Postal to $TransmitterPostalCode
  end-if

  move &TX.Transm_Type  to $TransmitterType
  move ' '              to $DataType
  do Count-ReportingID-Numbers
  do format-number(#SummaryCounter, $SummaryCounter, '099999')
  display ' '
  display 'Total number of summaries is ' noline
  display $SummaryCounter
  display ' '


  uppercase $TransmitterName
  uppercase $TransmitterStreet
  uppercase $TransmitterStreet2
  uppercase $TransmitterCity
  uppercase $TransmitterProvince
  uppercase $TransmitterCountry
  uppercase $TransmitterPostalCode

  write 10 from    '901':3           !Pos   1 -   3
               $DataType:1           !Pos   4
          $TransmitterID:8           !Pos   5 -  12
        $TransmitterType:1           !Pos  13
         $SummaryCounter:6           !Pos  14 -  19
        $TransmitterName:30          !Pos  20 -  49
                     $Sp:30          !Pos  50 -  79
      $TransmitterStreet:30          !Pos  80 - 109
     $TransmitterStreet2:30          !Pos 110 - 139
        $TransmitterCity:28          !Pos 140 - 167
    $TransmitterProvince:2           !Pos 168 - 169
     $TransmitterCountry:3           !Pos 170 - 172
  $TransmitterPostalCode:10          !Pos 173 - 182
            $ContactName:22          !Pos 183 - 204
          $TechContactAc:3           !Pos 205 - 207
       $TechContactPhone:7           !Pos 208 - 214
               $Language:1           !Pos 215
                     $Sp:529         !Pos 216 - 744

  if $FileType = 'D'
  write 20 from    '901':3           !Pos   1 -   3
               $DataType:1           !Pos   4
          $TransmitterID:8           !Pos   5 -  12
        $TransmitterType:1           !Pos  13
         $SummaryCounter:6           !Pos  14 -  19
        $TransmitterName:30          !Pos  20 -  49
                     $Sp:30          !Pos  50 -  79
      $TransmitterStreet:30          !Pos  80 - 109
     $TransmitterStreet2:30          !Pos 110 - 139
        $TransmitterCity:28          !Pos 140 - 167
    $TransmitterProvince:2           !Pos 168 - 169
     $TransmitterCountry:3           !Pos 170 - 172
  $TransmitterPostalCode:10          !Pos 173 - 182
            $ContactName:22          !Pos 183 - 204
          $TechContactAc:3           !Pos 205 - 207
       $TechContactPhone:7           !Pos 208 - 214
               $Language:1           !Pos 215
                     $Sp:529         !Pos 216 - 744

   end-if

end-procedure

begin-procedure Write-T4A-Record
  do Format-Number(#Box16Amt, $Pension, '099999999')
  do Format-Number(#Box16BAmt, $UnregPension, '099999999')
  do Format-Number(#Box16DAmt, $PensionIndian, '099999999')
  do Format-Number(#Box18Amt, $LumpSum, '099999999')
  do Format-Number(#Box18EAmt, $LumpSumTo71, '099999999')
  do Format-Number(#Box18GAmt, $LumpSumIndian, '099999999')
  do Format-Number(#Box18BAmt, $LumpSumRPPNotElg, '099999999')
  do Format-Number(#Box18CAmt, $LumpSumDPSPNotElg, '099999999')
  do Format-Number(#Box18AAmt, $LumpSumPara60, '099999999')
  do Format-Number(#Box18DAmt, $LumpSumUnregPen, '099999999')
  do Format-Number(#Box18FAmt, $LumpSumNoTrnsfr, '099999999')
  do Format-Number(#Box20Amt, $Commissions, '099999999')
  do Format-Number(#Box22Amt, $IncomeTax, '099999999')
  do Format-Number(#Box24Amt, $Annuities, '099999999')
  do Format-Number(#Box24AAmt, $IAACAnnuity, '099999999')
  do Format-Number(#Box24BAmt, $DPSPAnnuity, '099999999')
  do Format-Number(#Box26Amt, $RetireAllow, '099999999')
  do Format-Number(#Box26AAmt, $RetireAllowIndian, '099999999')
  do Format-Number(#Box27Amt,  $NonEligRetireAllow, '099999999')
  do Format-Number(#Box27AAmt, $StatIndNonEligRetAll, '099999999')
  do Format-Number(#Box28Amt, $Other, '099999999')
  do Format-Number(#Box28JAmt, $OtherIndian, '099999999')
  do Format-Number(#Box28RAmt, $InstallDPSP, '099999999')
  do Format-Number(#Box28MAmt, $MedicalTravel, '099999999')
  do Format-Number(#Box28NAmt, $Loan, '099999999')
  do Format-Number(#Box28OAmt, $MedicalPrem, '099999999')
  do Format-Number(#Box28CAmt, $ResearchGrts, '099999999')
  do Format-Number(#Box28DAmt, $Scholarships, '099999999')
  do Format-Number(#Box28FAmt, $IncomeWLRP, '099999999')
  do Format-Number(#Box28EAmt, $DeathBen, '099999999')
  do Format-Number(#Box28SAmt, $BoardLodge, '099999999')
  do Format-Number(#Box28TAmt, $DisabilityBen, '099999999')
  do Format-Number(#Box28UAmt, $GrpLifeIns, '099999999')
  do Format-Number(#Box30Amt,  $Patronage, '099999999')
  do Format-Number(#Box32Amt,  $PensionPast, '099999999')
  do Format-Number(#Box32AAmt, $PensionPre1990, '099999999')
  do Format-Number(#Box34Amt,  $PensionAdj, '0999999')
  do Format-Number(#Box40Amt,  $RESPIncomePay, '099999999')
  do Format-Number(#Box42Amt,  $RESPAssistPay, '099999999')

  do Format-Number(#Box46Amt, $Charity, '099999999')

  if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
  end-if
  add 1 to #RecordCount

  write 10 from   '100':3          !Pos   1 -   3
             $E_Surname:20         !Pos   4 -  23
           $E_FirstName:12         !Pos  24 -  35
             $E_Initial:1          !Pos  36
                   $SIN:9          !Pos  37 -  45
              $E_BusNum:15         !Pos  46 -  60
               $E_Corp1:30         !Pos  61 -  90
               $E_Corp2:30         !Pos  91 - 120
                    $Sp:1          !Pos 121
              $E_Street:30         !Pos 122 - 151
             $E_Street2:30         !Pos 152 - 181
                $E_City:28         !Pos 182 - 209
            $E_Province:2          !Pos 210 - 211
             $E_Country:3          !Pos 212 - 214
          $E_PostalCode:10         !Pos 215 - 224
                $EmplID:20         !Pos 225 - 244
           $ReportingID:15         !Pos 245 - 259
               $Pension:9          !Pos 260 - 268
             $Box16Code:2          !Pos 269 - 270
          $UnregPension:9          !Pos 271 - 279
         $PensionIndian:9          !Pos 280 - 288
               $LumpSum:9          !Pos 289 - 297
             $Box18Code:2          !Pos 298 - 299
           $LumpSumTo71:9          !Pos 300 - 308
         $LumpSumIndian:9          !Pos 309 - 317
      $LumpSumRPPNotElg:9          !Pos 318 - 326
     $LumpSumDPSPNotElg:9          !Pos 327 - 335
         $LumpSumPara60:9          !Pos 336 - 344
       $LumpSumUnregPen:9          !Pos 345 - 353
       $LumpSumNoTrnsfr:9          !Pos 354 - 362
           $Commissions:9          !Pos 363 - 371
             $IncomeTax:9          !Pos 372 - 380
             $Annuities:9          !Pos 381 - 389
             $Box24Code:2          !Pos 390 - 391
           $DPSPAnnuity:9          !Pos 392 - 400
           $IAACAnnuity:9          !Pos 401 - 409
           $RetireAllow:9          !Pos 410 - 418
             $Box26Code:2          !Pos 419 - 420
     $RetireAllowIndian:9          !Pos 421 - 429
    $NonEligRetireAllow:9          !Pos 430 - 438
             $Box27Code:2          !Pos 439 - 440
  $StatIndNonEligRetAll:9          !Pos 441 - 449
                 $Other:9          !Pos 450 - 458
             $Box28Code:2          !Pos 459 - 460
           $OtherIndian:9          !Pos 461 - 469
           $InstallDPSP:9          !Pos 470 - 478
            $BoardLodge:9          !Pos 479 - 487
         $MedicalTravel:9          !Pos 488 - 496
                  $Loan:9          !Pos 497 - 505
           $MedicalPrem:9          !Pos 506 - 514
          $ResearchGrts:9          !Pos 515 - 523
          $Scholarships:9          !Pos 524 - 532
            $IncomeWLRP:9          !Pos 533 - 541
              $DeathBen:9          !Pos 542 - 550
         $DisabilityBen:9          !Pos 551 - 559
            $GrpLifeIns:9          !Pos 560 - 568
             $Patronage:9          !Pos 569 - 577
           $PensionPast:9          !Pos 578 - 586
             $Box32Code:2          !Pos 587 - 588
        $PensionPre1990:9          !Pos 589 - 597
            $PensionAdj:7          !Pos 598 - 604
         $PensionPlanID:7          !Pos 605 - 611
             $Box38Code:2          !Pos 612 - 613
               $FNDescr:60         !Pos 614 - 673
         $RESPIncomePay:9          !Pos 674 - 682
             $Box40Code:2          !Pos 683 - 684
         $RESPAssistPay:9          !Pos 685 - 693
               $Charity:9          !Pos 694 - 702
                    $Sp:42         !Pos 703 - 744

  if $FileType = 'D'
  write 20 from   '100':3          !Pos   1 -   3
             $E_Surname:20         !Pos   4 -  23
           $E_FirstName:12         !Pos  24 -  35
             $E_Initial:1          !Pos  36
                   $SIN:9          !Pos  37 -  45
              $E_BusNum:15         !Pos  46 -  60
               $E_Corp1:30         !Pos  61 -  90
               $E_Corp2:30         !Pos  91 - 120
                    $Sp:1          !Pos 121
              $E_Street:30         !Pos 122 - 151
             $E_Street2:30         !Pos 152 - 181
                $E_City:28         !Pos 182 - 209
            $E_Province:2          !Pos 210 - 211
             $E_Country:3          !Pos 212 - 214
          $E_PostalCode:10         !Pos 215 - 224
                $EmplID:20         !Pos 225 - 244
           $ReportingID:15         !Pos 245 - 259
               $Pension:9          !Pos 260 - 268
             $Box16Code:2          !Pos 269 - 270
          $UnregPension:9          !Pos 271 - 279
         $PensionIndian:9          !Pos 280 - 288
               $LumpSum:9          !Pos 289 - 297
             $Box18Code:2          !Pos 298 - 299
           $LumpSumTo71:9          !Pos 300 - 308
         $LumpSumIndian:9          !Pos 309 - 317
      $LumpSumRPPNotElg:9          !Pos 318 - 326
     $LumpSumDPSPNotElg:9          !Pos 327 - 335
         $LumpSumPara60:9          !Pos 336 - 344
       $LumpSumUnregPen:9          !Pos 345 - 353
       $LumpSumNoTrnsfr:9          !Pos 354 - 362
           $Commissions:9          !Pos 363 - 371
             $IncomeTax:9          !Pos 372 - 380
             $Annuities:9          !Pos 381 - 389
             $Box24Code:2          !Pos 390 - 391
           $DPSPAnnuity:9          !Pos 392 - 400
           $IAACAnnuity:9          !Pos 401 - 409
           $RetireAllow:9          !Pos 410 - 418
             $Box26Code:2          !Pos 419 - 420
     $RetireAllowIndian:9          !Pos 421 - 429
    $NonEligRetireAllow:9          !Pos 430 - 438
             $Box27Code:2          !Pos 439 - 440
  $StatIndNonEligRetAll:9          !Pos 441 - 449
                 $Other:9          !Pos 450 - 458
             $Box28Code:2          !Pos 459 - 460
           $OtherIndian:9          !Pos 461 - 469
           $InstallDPSP:9          !Pos 470 - 478
            $BoardLodge:9          !Pos 479 - 487
         $MedicalTravel:9          !Pos 488 - 496
                  $Loan:9          !Pos 497 - 505
           $MedicalPrem:9          !Pos 506 - 514
          $ResearchGrts:9          !Pos 515 - 523
          $Scholarships:9          !Pos 524 - 532
            $IncomeWLRP:9          !Pos 533 - 541
              $DeathBen:9          !Pos 542 - 550
         $DisabilityBen:9          !Pos 551 - 559
            $GrpLifeIns:9          !Pos 560 - 568
             $Patronage:9          !Pos 569 - 577
           $PensionPast:9          !Pos 578 - 586
             $Box32Code:2          !Pos 587 - 588
        $PensionPre1990:9          !Pos 589 - 597
            $PensionAdj:7          !Pos 598 - 604
         $PensionPlanID:7          !Pos 605 - 611
             $Box38Code:2          !Pos 612 - 613
               $FNDescr:60         !Pos 614 - 673
         $RESPIncomePay:9          !Pos 674 - 682
             $Box40Code:2          !Pos 683 - 684
         $RESPAssistPay:9          !Pos 685 - 693
               $Charity:9          !Pos 694 - 702
                    $Sp:42         !Pos 703 - 744

   end-if

  add 1 to #T4ACount
  do Initialize-Detail

end-procedure

begin-procedure Initialize-Detail

  move 0 to #Box16Amt
  move 0 to #Box16BAmt
  move 0 to #Box16CAmt
  move 0 to #Box16DAmt
  move 0 to #Box18Amt
  move 0 to #Box18AAmt
  move 0 to #Box18BAmt
  move 0 to #Box18CAmt
  move 0 to #Box18DAmt
  move 0 to #Box18GAmt
  move 0 to #Box18EAmt
  move 0 to #Box18FAmt
  move 0 to #Box20Amt
  move 0 to #Box22Amt
  move 0 to #Box24Amt
  move 0 to #Box24AAmt
  move 0 to #Box24BAmt
  move 0 to #Box26Amt
  move 0 to #Box26AAmt
  move 0 to #Box27Amt
  move 0 to #Box27AAmt
  move 0 to #Box28Amt
  move 0 to #Box28CAmt
  move 0 to #Box28DAmt
  move 0 to #Box28EAmt
  move 0 to #Box28FAmt
  move 0 to #Box28JAmt
  move 0 to #Box28MAmt
  move 0 to #Box28NAmt
  move 0 to #Box28OAmt
  move 0 to #Box28RAmt
  move 0 to #Box28SAmt
  move 0 to #Box28TAmt
  move 0 to #Box28UAmt
  move 0 to #Box30Amt
  move 0 to #Box32Amt
  move 0 to #Box32AAmt
  move 0 to #Box34Amt
  move 0 to #Box40Amt
  move 0 to #Box42Amt
  move 0 to #Box46Amt
  move 0 to #FNCount

  move '000000000' to $Pension
  move '000000000' to $UnregPension
  move '000000000' to $PensionIndian
  move '000000000' to $LumpSum
  move '000000000' to $LumpSumTo71
  move '000000000' to $LumpSumIndian
  move '000000000' to $LumpSumRPPNotElg
  move '000000000' to $LumpSumDPSPNotElg
  move '000000000' to $LumpSumPara60
  move '000000000' to $LumpSumUnregPen
  move '000000000' to $LumpSumNoTrnsfr
  move '000000000' to $Commissions
  move '000000000' to $IncomeTax
  move '000000000' to $Annuities
  move '000000000' to $IAACAnnuity
  move '000000000' to $DPSPAnnuity
  move '000000000' to $RetireAllow
  move '000000000' to $NonEligRetireAllow
  move '000000000' to $RetireAllowIndian
  move '000000000' to $StatIndNonEligRetAll
  move '000000000' to $Other
  move '000000000' to $OtherIndian
  move '000000000' to $InstallDPSP
  move '000000000' to $BoardLodge
  move '000000000' to $MedicalTravel
  move '000000000' to $Loan
  move '000000000' to $MedicalPrem
  move '000000000' to $ResearchGrts
  move '000000000' to $Scholarships
  move '000000000' to $IncomeWLRP
  move '000000000' to $DeathBen
  move '000000000' to $DisabilityBen
  move '000000000' to $GrpLifeIns
  move '000000000' to $Patronage
  move '000000000' to $PensionPast
  move '000000000' to $PensionPre1990
  move '0000000'   to $PensionAdj
  move '000000000' to $RESPIncomePay
  move '000000000' to $RESPAssistPay
  move '000000000' to $Charity

  move '000000000' to $SIN
  move '000000000000000' to $E_BusNum
  move '00' to $Box16Code
  move '00' to $Box18Code
  move '00' to $Box24Code
  move '00' to $Box26Code
  move '00' to $Box27Code
  move '00' to $Box28Code
  move '00' to $Box32Code
  move '00' to $Box38Code
  move '00' to $Box40Code
  move ' ' to $FNDescr
  move '0000000' to $PensionPlanID

  move ' ' to $E_Surname
  move ' ' to $E_FirstName
  move ' ' to $E_Initial
  move ' ' to $E_Street
  move ' ' to $E_Street2
  move ' ' to $E_City
  move ' ' to $E_Province
  move ' ' to $E_Country
  move ' ' to $E_PostalCode
  move ' ' to $EmplID
  move ' ' to $E_Corp1
  move ' ' to $E_Corp2

  move ' ' to $E_FoundNegative

end-procedure

begin-procedure Write-Summary-Record

  do Format-Number(#SumPension, $SumPension, '0999999999999')
  do Format-Number(#SumLumpSum, $SumLumpSum, '0999999999999')
  do Format-Number(#SumCommissions, $SumCommissions, '0999999999999')
  do Format-Number(#SumPatronage, $SumPatronage, '0999999999999')
  do Format-Number(#SumPPContribPast, $SumPPContribPast, '0999999999999')
  do Format-Number(#SumAnnuities, $SumAnnuities, '0999999999999')
  do Format-Number(#SumOther, $SumOther, '0999999999999')
  do Format-Number(#SumRetiringAllow, $SumRetiringAllow, '0999999999999')
  do Format-Number(#SumNonRetiringAllow, $SumNonRetiringAllow, '0999999999999')
  do Format-Number(#SumIncomeTax, $SumIncomeTax, '0999999999999')
  do Format-Number(#SumPensionAdj, $SumPensionAdj, '0999999999999')
  do Format-Number(#SumRESPIncomePay, $SumRESPIncomePay, '0999999999999')
  do Format-Number(#SumRESPAssistPay, $SumRESPAssistPay, '0999999999999')

  do Format-Number(#T4ACount, $T4ACount, '0999999')

  move &CT.Descr to $CompanyName
  uppercase $CompanyName
  move $CompnyAdd1 to $C_Street
  move $CompnyAdd2 to $C_Street2
  move $CompnyCity to $C_City
  let $C_Province = rtrim(&CT.State, ' ')
  move &CT.Country to $C_Country


  move &CT.Postal to $PostalCd
  do Check-Postal-Code
  move $PostalCd to $C_PostalCode


  move &TX.Acct_Contact_Name to $AcctContactName

  if &TX.Acct_Contact_Acode <> 0
     let $AcctContactAc = &TX.Acct_Contact_Acode
  else
     move '000' to $AcctContactAc
  end-if

  if &TX.Acct_Contact_Phone <> 0
     let $AcctContactPhone = &TX.Acct_Contact_Phone
  else
     move '0000000' to $AcctContactPhone
  end-if

  if &TX.Acct_Contact_Ext <> 0
     let $AcctContactExt = &TX.Acct_Contact_Ext
  else
     move '0000' to $AcctContactExt
  end-if

  uppercase $C_Street
  uppercase $C_Street2
  uppercase $C_City
  uppercase $C_Province
  uppercase $C_Country
  uppercase $C_PostalCode
  uppercase $AcctContactName

  write 10  from               '301':3       !Pos   1 -   3
                        $ReportingID:15      !Pos   4 -  18
                        $CompanyName:30      !Pos  19 -  48
                      $CoNameLineTwo:30      !Pos  49 -  78
                    $CoNameLineThree:30      !Pos  79 - 108
                           $C_Street:30      !Pos 109 - 138
                          $C_Street2:30      !Pos 139 - 168
                             $C_City:28      !Pos 169 - 196
                         $C_Province:2       !Pos 197 - 198
                          $C_Country:3       !Pos 199 - 201
                       $C_PostalCode:10      !Pos 202 - 211
                    $AcctContactName:22      !Pos 212 - 233
                      $AcctContactAc:3       !Pos 234 - 236
                   $AcctContactPhone:7       !Pos 237 - 243
                     $AcctContactExt:4       !Pos 244 - 247
                            $CalYear:4       !Pos 248 - 251
                           $T4ACount:7       !Pos 252 - 258
                         $SumPension:13      !Pos 259 - 271
                         $SumLumpSum:13      !Pos 272 - 284
                     $SumCommissions:13      !Pos 285 - 297
                       $SumPatronage:13      !Pos 298 - 310
                   $SumPPContribPast:13      !Pos 311 - 323
                       $SumAnnuities:13      !Pos 324 - 336
                           $SumOther:13      !Pos 337 - 349
                   $SumRetiringAllow:13      !Pos 350 - 362
                $SumNonRetiringAllow:13      !Pos 363 - 375
                       $SumIncomeTax:13      !Pos 376 - 388
                      $SumPensionAdj:13      !Pos 389 - 401
                   $SumRESPIncomePay:13      !Pos 402 - 414
                   $SumRESPAssistPay:13      !Pos 415 - 427
                              $PlanA:7       !Pos 428 - 434
                              $PlanB:7       !Pos 435 - 441
                              $PlanC:7       !Pos 442 - 448
                         '000000000':9       !Pos 449 - 457
                         '000000000':9       !Pos 458 - 466
                                 $Sp:278     !Pos 467 - 744

  if $FileType = 'D'
  write 20  from               '301':3       !Pos   1 -   3
                        $ReportingID:15      !Pos   4 -  18
                        $CompanyName:30      !Pos  19 -  48
                      $CoNameLineTwo:30      !Pos  49 -  78
                    $CoNameLineThree:30      !Pos  79 - 108
                           $C_Street:30      !Pos 109 - 138
                          $C_Street2:30      !Pos 139 - 168
                             $C_City:28      !Pos 169 - 196
                         $C_Province:2       !Pos 197 - 198
                          $C_Country:3       !Pos 199 - 201
                       $C_PostalCode:10      !Pos 202 - 211
                    $AcctContactName:22      !Pos 212 - 233
                      $AcctContactAc:3       !Pos 234 - 236
                   $AcctContactPhone:7       !Pos 237 - 243
                     $AcctContactExt:4       !Pos 244 - 247
                            $CalYear:4       !Pos 248 - 251
                           $T4ACount:7       !Pos 252 - 258
                         $SumPension:13      !Pos 259 - 271
                         $SumLumpSum:13      !Pos 272 - 284
                     $SumCommissions:13      !Pos 285 - 297
                       $SumPatronage:13      !Pos 298 - 310
                   $SumPPContribPast:13      !Pos 311 - 323
                       $SumAnnuities:13      !Pos 324 - 336
                           $SumOther:13      !Pos 337 - 349
                   $SumRetiringAllow:13      !Pos 350 - 362
                $SumNonRetiringAllow:13      !Pos 363 - 375
                       $SumIncomeTax:13      !Pos 376 - 388
                      $SumPensionAdj:13      !Pos 389 - 401
                   $SumRESPIncomePay:13      !Pos 402 - 414
                   $SumRESPAssistPay:13      !Pos 415 - 427
                              $PlanA:7       !Pos 428 - 434
                              $PlanB:7       !Pos 435 - 441
                              $PlanC:7       !Pos 442 - 448
                         '000000000':9       !Pos 449 - 457
                         '000000000':9       !Pos 458 - 466
                                 $Sp:278     !Pos 467 - 744


  end-if

  add #T4ACount to #TotalT4ACount
  do Print-Summary-Data
  do Initialize-Summary
  let $Error-Report = 'N'

end-procedure

begin-procedure Initialize-Summary

   move 0 to #SumPension
   move 0 to #SumLumpSum
   move 0 to #SumCommissions
   move 0 to #SumPatronage
   move 0 to #SumPPContribPast
   move 0 to #SumAnnuities
   move 0 to #SumOther
   move 0 to #SumRetiringAllow
   move 0 to #SumNonRetiringAllow
   move 0 to #SumIncomeTax
   move 0 to #SumPensionAdj
   move 0 to #SumRESPIncomePay
   move 0 to #SumRESPAssistPay

   move 0 to #T4ACount

   move '0000000' to $PlanA
   move '0000000' to $PlanB
   move '0000000' to $PlanC
   move ' ' to $CompanyName
   move ' ' to $CoNameLineTwo
   move ' ' to $CoNameLineThree
   move ' ' to $C_Street
   move ' ' to $C_Street2
   move ' ' to $C_City
   move ' ' to $C_Province
   move ' ' to $C_Country
   move ' ' to $C_PostalCode


end-procedure

begin-procedure Count-ReportingID-Numbers

  move 0     to #SummaryCounter
  move 'xxx' to $PriorID

begin-SELECT

SL.REPORTING_ID

  if &SL.Reporting_ID <> $PriorID
     add 1 to #SummaryCounter
     move &SL.Reporting_ID to $PriorID
  end-if

FROM PS_CAN_YE_SLIP SL
WHERE TAXFORM_ID = 'A'
AND   CALENDAR_YEAR = &TX.BALANCE_YEAR
AND   YE_SLIP_PROCESS = 'O'
ORDER by REPORTING_ID ASC

end-SELECT

end-procedure

begin-procedure Prompts

  while $FileType = ''
    input $FileType 'Tape, cartridge or diskette file? (T, C, D or Q to quit)'
    uppercase $FileType
    if INSTR('TDCQ',$FileType,1) = 0
      display ' '
      display '***** Enter T, D, C or Q *****'
      display ' '
      move '' to $FileType
    end-if
  end-while
end-procedure

begin-procedure Convert-Parameters

move $RC_CAN_YE.Reporting_Medium to $FileType

 if $RC_CAN_YE.Reporting_Medium =  'D'
    move $RC_CAN_YE.Diskette_Type    to $DisketteType
 end-if

end-procedure

begin-procedure Evaluate-File-Type

  evaluate $FileType
    when = 'Q'
      stop

    when = 'D'
      if $Prcs_Process_Instance = ''
         do Get-Diskette-Format
      end-if

  end-evaluate
end-procedure

begin-procedure Print-Summary-Data

  if $Error-Report = 'Y'
    new-page
  end-if

  move '301' to $TypeCode

  divide 100 into #SumPension
  do Format-Number(#SumPension,  $SumPension,  '9999999999999.99')
  divide 100 into #SumLumpSum
  do Format-Number(#SumLumpSum, $SumLumpSum, '9999999999999.99')
  divide 100 into #SumCommissions
  do Format-Number(#SumCommissions, $SumCommissions, '9999999999999.99')
  divide 100 into #SumPatronage
  do Format-Number(#SumPatronage, $SumPatronage, '9999999999999.99')
  divide 100 into #SumPPContribPast
  do Format-Number(#SumPPContribPast, $SumPPContribPast, '9999999999999.99')
  divide 100 into #SumAnnuities
  do Format-Number(#SumAnnuities, $SumAnnuities, '9999999999999.99')
  divide 100 into #SumOther
  do Format-Number(#SumOther, $SumOther, '9999999999999.99')
  divide 100 into #SumRetiringAllow
  do Format-Number(#SumRetiringAllow, $SumRetiringAllow, '9999999999999.99')
  divide 100 into #SumNonRetiringAllow
  do Format-Number(#SumNonRetiringAllow, $SumNonRetiringAllow, '9999999999999.99')
  divide 100 into #SumRESPIncomePay
  do Format-Number(#SumRESPIncomePay, $SumRESPIncomePay, '9999999999999.99')
  divide 100 into #SumRESPAssistPay
  do Format-Number(#SumRESPAssistPay, $SumRESPAssistPay, '9999999999999.99')

  divide 100 into #SumIncomeTax
  do Format-Number(#SumIncomeTax, $SumIncomeTax, '9999999999999.99')
  divide 100 into #SumPensionAdj
  do Format-Number(#SumPensionAdj, $SumPensionAdj, '9999999999999.99')
  do Format-Number(#T4ACount, $T4ACount, '9999999999999')

     print    'T4A Summary Data '          (+1,1)
     print    'TypeCode '                  (+1,1)
     print    $TypeCode                    (0,60)
     print    'Business Number'            (+1,1)
     print    $ReportingID                 (0,60)
     print    'Total Slips'                (+1,1)
     print    $T4ACount                    (0,60)
     print    'Total Pensions - Box 16'    (+1,1)
     print    $SumPension                  (0,60)
     print    'Total Lump Sum - Box 18'    (+1,1)
     print    $SumLumpSum                  (0,60)
     print    'Total Commissions - Box 20' (+1,1)
     print    $SumCommissions              (0,60)
     print    'Total Patronage - Box 30'   (+1,1)
     print    $SumPatronage                (0,60)
     print    'Total Pension Plan Contrib - Past - Box 32'    (+1,1)
     print    $SumPPContribPast            (0,60)
     print    'Total Annuities - Box 24'   (+1,1)
     print    $SumAnnuities                (0,60)
     print    'Total Other Income - Box 28' (+1,1)
     print    $SumOther                    (0,60)
     print    'Total Elig Retiring Allowances - Box 26'  (+1,1)
     print    $SumRetiringAllow            (0,60)
     print    'Total Non-Elig Retiring Allowances - Box 27' (+1,1)
     print    $SumNonRetiringAllow         (0,60)
     print    'Total Income Tax - Box 22'  (+1,1)
     print    $SumIncomeTax                (0,60)
     print    'Total Pension Adj - Box 34' (+1,1)
     print    $SumPensionAdj               (0,60)
     print    'Total RESP Accumulated Income Payments - Box 40'  (+1,1)
     print    $SumRESPIncomePay            (0,60)
     print    'Total RESP Educational Assistance Payments - Box 42' (+1,1)
     print    $SumRESPAssistPay            (0,60)

     new-page

end-procedure

begin-procedure Check-Postal-Code


  find ' ' in $PostalCd 0 #space_loc
  if #space_loc > 0 and #space_loc < 5
     let $Postal1 = substr($PostalCd, 1, #space_loc)
     let #start = #space_loc + 2
     let $Postal2 = substr($PostalCd, #start, 3)
     let $PostalCd = $Postal1 || $Postal2
  end-if

end-procedure

begin-procedure Error-Report

  print 'Negative value found for Emplid'      (+2,2)
  print $Emplid                                (0,+2)
  print '.  No T4A record created.'            (0,+1)

  let $Error-Report = 'Y'
end-procedure



#Include 'getcodta.sqc'  !Get-Company-Data procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'getfrmat.sqc'  !Get-Diskette-Format procedure
#Include 'rotname1.sqc'  !Rotate-Name procedure
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#ifdef PRCSSCHD
#Include 'ctxrctl1.sqc'  !Get-Canadian-Year-End Parameters
#Include 'stdapi.sqc'    !Update Process API
#Include 'txrnctl1.sqc'  !Process Scheduler Run Controls
#endif
