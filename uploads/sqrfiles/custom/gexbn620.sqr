!***********************************************************************
! Interface Name: GEXBN620                                             *
!***********************************************************************
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
! This module is the confidential and proprietary information of       *
! Giant Eagle, Inc.; it is not to be copied, reproduced, or transmitted*
! in any form, by any means, in whole or in part, nor is it to be used *
! for any purpose other than that for which it is expressly provided   *
! without the written permission of Giant Eagle.                       *
!                                                                      *
!***********************************************************************
! GEXBN620:     High Mark Interface File                               *
!                                                                      *
! Narrative:    This program creates a file and report of              *
!               employees enrolled in Highmark.                        *
!***********************************************************************
!                                                                      *
! SQL Tables:   PS_PERSONAL_DATA                                       *
!               PS_JOB                                                 *
!               PS_HEALTH_BENEFIT                                      *
!               PS_BENEF_PLAN_TBL                                      *
!               PS_DEPENDENT_BENEF                                     *
!               PS_HEALTH_DEPENDNT                                     *
!                                                                      *
! Written by:   Carl Buckrop                                           *
!                                                                      *
! Normally Run: Weekly                                                 *
!                                                                      *
!***********************************************************************
!                         MODIFICATION HISTORY                         *
!***********************************************************************
!  ID#         INITIALS    DATE           DESCRIPTION OF THE CHANGE    *
!***********************************************************************
!CSR HR-10770  CWB         09/17/2004     INITIAL CREATION             *
!CSR HR-11301  VENDKXY     11/07/2007     ITG 45099		       *
!              DXS         12/03/2007     create-dep-recs, made        *
!		                          relationship value changes,  *
!                                         as a result of upgrade to 9.0*
!	       VENDKXY     05/05/2010     Done changes for S3 14115146 *
!GEX ISDVNPK 12/05/2010  Changes as part of OE11                       *
!                         -Modifed to remove the Student criteria      *
!                           & age limit is changed from 19 to 26       *
!                         -Added the new Cocerage Codes                *
!                         -Added EMPL_RCD field in EMPLOYMENT join     *
!GEX ISDVNPK 06/15/2013 Changed the file format from IFF to 834 as part*
!                       of HIPPA standards                             *
!GEX_SEC_REENG 2015-04-29 Vahini Katta                                 *
!Changes related to gex_emplid_mapp/7 digit emplid
!***********************************************************************

#include 'setenv.sqc' !Set environment
#include 'setup02.sqc'

!*********************************************************************
!Initial processing, retrieving current dates and calls the main 
!procedure to do the processing.                                     
!*********************************************************************
begin-program

  do Init-DateTime
  do Init-Number
  do stdapi-init
  do open-file 
  do initialization
  move 'GEXBN620' to $ReportID
  move 'High Mark Interface' to $ReportTitle
  show $ReportTitle 
  show '  ' 
  do Get-Current-DateTime

  date-time () mm/dd/yyyy &daybegan
  date-time () hh:mi:ss &timebegan
  show ' '
  show 'Report began on ' &daybegan ' at ' &timebegan
  show ' '
 
  do Report
  
  do finalization
  do stdapi-term
end-program

!*********************************************************************
begin-procedure initialization
!*********************************************************************
#debug9 Show 'initialization'

  do delete-himrk-prior
  do insert-himrk-prior
  do delete-himrk-curr

  let $3_spaces   = rpad($3_spaces,3,' ')
  let $5_spaces   = rpad($5_spaces,5,' ')
  let $7_spaces   = rpad($7_spaces,7,' ')
  let $9_spaces   = rpad($9_spaces,9,' ')
  let $10_spaces  = rpad($10_spaces,10,' ')
  let $18_spaces  = rpad($18_spaces,18,' ')
  let $35_spaces  = rpad($35_spaces,35,' ')
  let $37_spaces  = rpad($37_spaces,37,' ')
  let $40_spaces  = rpad($40_spaces,40,' ')
  let $55_spaces  = rpad($55_spaces,55,' ')
  let $139_spaces = rpad($139_spaces,139,' ')
  let $100_spaces = rpad($100_spaces,100,' ') 
  let $153_spaces = rpad($153_spaces,153,' ')
  let $158_spaces = rpad($158_spaces,158,' ')
  let $246_spaces = rpad($246_spaces,246,' ')
  let $251_spaces = rpad($251_spaces,251,' ')
  let $benef_id = '00'
  let $rec_seq_nbr = $7_spaces
  let $dashes = rpad($dashes,95,'-')
  
  date-time () mm/dd/yyyy &rptdt
  date-time () hh:mi:ss &rpttime
  move &rptdt to $report_date 
  move &rpttime to $report_time 
  show '$report_date: ' $report_date
  show '$report_time: ' $report_time
  
  !GEX ISDVNPK 06/15/2013 Commented and added the below as part of file format change from IFF to 834
   ! do create-header-rec
   Do Select-Seq-Number
   Let $seq_number = edit(#seq_number,'000000000')
   Let $seq_number1 = edit(#seq_number1,'000000000')
   Do Write-ISA-Record
   Do Write-GS-Record
   Do Write-ST-Record
   Do Write-BGN-Record
   Do Write-N1-Record
   do Write-N1A-Record
  !GEX ISDVNPK 06/15/2013 Commented and added the above as part of file format change from IFF to 834
  
  let $first_ee = 'Y'
end-procedure

!**********************************************************
!  Delete the prior week's data from PS_GEX_HIMRK_PRIOR
!**********************************************************
begin-procedure Delete-himrk-prior 
#debug9 Show 'Delete-himrk-prior'
  begin-SQL ON-ERROR=SQL-Error-Found('Delete-himrk-prior')
    delete from PS_GEX_HIMRK_PRIOR
  end-SQL
end-procedure

!*******************************************************************
!  Insert the data from PS_GEX_HIMRK_CURR into PS_GEX_HIMRK_PRIOR
!*******************************************************************
begin-procedure Insert-himrk-prior 
#debug9 Show 'Insert-himrk-prior'
  begin-SQL ON-ERROR=SQL-Error-Found('Insert-himrk-prior')
    Insert into PS_GEX_HIMRK_PRIOR
      (select *
       from PS_GEX_HIMRK_CURR)
  end-SQL
end-procedure

!**********************************************************
!  Delete the prior week's data from PS_GEX_HIMRK_CURR
!**********************************************************
begin-procedure Delete-himrk-curr 
#debug9 Show 'Delete-himrk-curr'
  begin-SQL ON-ERROR=SQL-Error-Found('Delete-himrk-curr')
    delete from PS_GEX_HIMRK_CURR
  end-SQL
end-procedure

begin-procedure create-header-rec
#debug9 Show 'create-header-rec'
  let $agreement_nbr = '0000000000'
  let $rec_type = '000'
  move 0 to #seq_nbr   
  let $purpose_cd = '00'
  let $sender_id = 'Giant Eagle '
  let $out1 = $40_spaces||$rec_type||$7_spaces||$report_date||$report_time||
	$purpose_cd||$report_date||$report_date||$7_spaces||$40_spaces||
	$sender_id
  let $out1 = rpad($out1,254,' ')
  let $out2 = $246_spaces
  do insert-rec
end-procedure
!*********************************************************************
begin-procedure Report
!*********************************************************************

 move 'N' to $Errorfound

  date-time () MM/DD/YYYY &curr_date
  date-time () hh:mi:ss &curr_time

 move &curr_date to $curr_date

  do Format-datetime($curr_date,$curr_Date_dbf_1,{DEFMDY},'','native')
  do Convert-To-DTU-Date($curr_Date_dbf_1,$curr_Date_1)

  let $curr_yy = substr($curr_Date_1,1,4)
  let $curr_mm = substr($curr_Date_1,6,2)
  let $curr_dd = substr($curr_Date_1,9,2)

  if $prcs_process_instance = ''
!    do GEXXX950-Input-Parameters
     do Ask-As-Of-Date
  
  else

     Do GEXRCBN1-SELECT-PARAMETERS
     Let $AsOfDate = &GEX_RC_BEN.AsOfDate

  end-if

  if rtrim($asofdate,' ') = ''
    let $run_dt = $curr_yy||$curr_mm||$curr_dd
    do Format-datetime($run_dt, $run_date, {DEFCMP},'','native')
    do Format-datetime($run_dt, $asofdate, {DEFCMP},'','native')
  end-if
  
  do convert-to-dtu-date($asofdate,$asofdate_dtu)
  let $hdg_yy = substr($asofdate_dtu,1,4)
  let $hdg_mm = substr($asofdate_dtu,6,2)
  let $hdg_dd = substr($asofdate_dtu,9,2)
  let $hdg_asofdate = $hdg_mm||'/'||$hdg_dd||'/'||$hdg_yy
  do dtu-add-days($asofdate_dtu,30,$plus30_date_dtu)
  do convert-from-dtu-date($plus30_date_dtu,$plus30_date)
  show '$asofdate: ' $asofdate
  show '$plus30_date: ' $plus30_date
  
 if $sev-error = 'Y'
    goto Report-exit
 end-if

 do process-data

Report-Exit:

  show ' '

end-procedure

!*********************************************************************
!Prints the header information in the report.
!*********************************************************************

begin-heading 5

  #Include 'stdhdg01.sqc'
  print 'EXCEPTION REPORT' (+0) center 
  let $hdg_tmp = 'As of: ' || $hdg_asofdate 
  print $hdg_tmp           (+1) center 
  print '-'                (+1,1,174) FILL

end-heading

!*********************************************************************
! Select all valid Employee Types for a specific company
!*********************************************************************

begin-procedure process-data
#debug9 Show 'process-data'
!display 'Begin process'


move 'N' to $rowfound
let $end_process = 'N'
let #inputtran = 0
let $contract_id   = rpad($contract_id,30,' ')

begin-select ON-ERROR=SQL-Error-Found('Process-data')

BP.GROUP_NBR                () on-break print=never level=02
                                save=$save_group_nbr  
			        before=before-group-nbr	
                                after=after-group-nbr  

BP.VENDOR_ID
   move &BP.VENDOR_ID        to $provider 

VP.POLICY_NBR
   move &VP.POLICY_NBR       to $policy

HB.EMPLID                   () on-break print=never level=01
                               save=$save_emplid
                               before=before-emplid  
                               after=after-emplid 
                             
HB.EMPL_RCD
   move &HB.EMPL_RCD        to #empl_rcd

PN.NATIONAL_ID
   move &PN.NATIONAL_ID     to $national_id
   let $agreement_nbr       = $national_id||'0'

PD.FIRST_NAME
   move &PD.FIRST_NAME      to $first_name

PD.MIDDLE_NAME
   move &PD.MIDDLE_NAME     to $middle_name
   
PD.LAST_NAME
   move &PD.LAST_NAME      to $last_name
PD.NAME_PREFIX
   move &PD.NAME_PREFIX    to $prefix
PD.NAME_SUFFIX
   move &PD.NAME_SUFFIX    to $suffix
PD.ADDRESS1
   move &PD.ADDRESS1       to $address1
PD.ADDRESS2
   move &PD.ADDRESS2       to $address2
PD.ADDRESS3
   move &PD.ADDRESS3       to $address3
PD.CITY
   move &PD.CITY             to $city
PD.STATE
   move &PD.STATE            to $state
PD.POSTAL 
   move &PD.POSTAL           to $postal
PD.COUNTRY
   move &PD.COUNTRY          to $country
PD.BIRTHDATE
   move &PD.BIRTHDATE        to $birthdate
PD.SEX
   move &PD.SEX              to $sex
PD.MAR_STATUS
   move &PD.MAR_STATUS       to $mar_status
JB.FULL_PART_TIME
   move &JB.FULL_PART_TIME   to $full_part_time
JB.EMPL_TYPE
   move &JB.EMPL_TYPE        to $empl_type
JB.DEPTID
   move &JB.DEPTID           to $deptid
JB.EFFDT
   move &JB.EFFDT            to $job_effdt
EM.HIRE_DT
   move &EM.HIRE_DT          to $hire_dt
HB.COVRG_CD			
HB.EFFDT
HB.COVERAGE_BEGIN_DT

HB.PLAN_TYPE                 () on-break print=never level=03 
                                save=$save_plan_type
                                before=before-plan-type   
                               	after=after-plan-type
HB.COVERAGE_ELECT 

HB.BENEFIT_PLAN         
PP.BENEFIT_PROGRAM     
   Let #emp = #emp+1
   #debug9 show 'empno:' #emp
   move &HB.BENEFIT_PLAN     to $benefit_plan

   move &hb.coverage_elect   to $coverage_elect
   #debug9 show 'coverage elect:' $coverage_elect
   move &HB.PLAN_TYPE        to $plan_type
   #debug9 show 'plantype:' $plan_type
   do create-contract-id
   move &BP.GROUP_NBR        to $group_nbr
   move &HB.EMPLID           to $emplid
   move &HB.EFFDT            to $hb_effdt
   move &HB.COVERAGE_BEGIN_DT to $hb_coverage_begin_dt
   move &HB.COVRG_CD         to $covrg_cd
   #debug9 show 'Coverage code:' $covrg_cd
   do evaluate-covrg-cd		
    
   move &PP.BENEFIT_PROGRAM  to $benefit_program
  if &hb.coverage_elect = 'E'
    move 'Y' to $rowfound
    add 1 to #inputtran
  else
    add 1 to #no_elect_ctr
    #debug9 show '===>> Coverage_elect not = E: ' $emplid
  end-if

FROM PS_JOB JB,
     PS_EMPLOYMENT EM,
     PS_PERS_NID PN, 
     PS_PERSONAL_DATA PD,
     PS_VENDOR_POLICY VP,
     PS_HEALTH_BENEFIT HB,
     PS_BENEF_PLAN_TBL BP,
     PS_BEN_PROG_PARTIC PP
WHERE JB.EMPLID       = PD.EMPLID
AND   JB.EMPLID       = HB.EMPLID
AND   JB.EMPL_RCD     = HB.EMPL_RCD
AND   EM.EMPLID       = JB.EMPLID
AND   EM.EMPL_RCD     = JB.EMPL_RCD ! GEX ISDVNPK 12/05/2010 Added this to fix as the EMPL_RCD was missing
AND   PD.EMPLID       = EM.EMPLID
AND   PN.EMPLID       = PD.EMPLID
AND   PP.EMPLID       = HB.EMPLID
AND   PP.EMPL_RCD     = HB.EMPL_RCD
AND   HB.PLAN_TYPE    in ('10','11','14','15','16','17')!Modified by VENDKXY on 11/15/2007 for ITG  45099
AND   HB.PLAN_TYPE    = BP.PLAN_TYPE
AND   HB.BENEFIT_PLAN = BP.BENEFIT_PLAN
AND   BP.VENDOR_ID    in ('0001','0005')
!#############################################################
and   BP.GROUP_NBR <> ' '
!#############################################################
AND   BP.VENDOR_ID    = VP.VENDOR_ID
AND   BP.GROUP_NBR    = VP.GROUP_NBR
AND   VP.SETID        = 'COMMN'  
AND   JB.EFFDT = (SELECT MAX(EFFDT)
		  FROM PS_JOB
		  WHERE EMPLID    = JB.EMPLID
		  AND   EMPL_RCD = JB.EMPL_RCD
		  AND   EFFDT    <= $asofdate)
!		  AND   EFFDT    <= $plus30_date)
AND   JB.EFFSEQ = (SELECT MAX(EFFSEQ)
		   FROM PS_JOB
		   WHERE EMPLID    = JB.EMPLID
		   AND   EMPL_RCD = JB.EMPL_RCD
		   AND   EFFDT    = JB.EFFDT)
AND   HB.COVERAGE_BEGIN_DT =  (SELECT MAX(COVERAGE_BEGIN_DT) 
                   FROM PS_HEALTH_BENEFIT
                   WHERE HB.EMPLID = EMPLID
                   AND HB.EMPL_RCD = EMPL_RCD
                   AND HB.COBRA_EVENT_ID = COBRA_EVENT_ID
                   AND HB.PLAN_TYPE = PLAN_TYPE
                   AND HB.BENEFIT_NBR = BENEFIT_NBR
                   AND COVERAGE_BEGIN_DT  <= $asofdate)
!                   AND COVERAGE_BEGIN_DT  between $asofdate and $plus30_date)
!                   AND COVERAGE_BEGIN_DT  <= $plus30_date)
!#############################################################
AND   BP.EFFDT =  (SELECT MAX(EFFDT)
                   FROM PS_BENEF_PLAN_TBL
                   WHERE BP.PLAN_TYPE = PLAN_TYPE
                   AND BP.BENEFIT_PLAN = BENEFIT_PLAN
                   AND EFFDT <= $asofdate)  
!                   AND EFFDT <= $plus30_date)  
AND   PP.EFFDT =  (SELECT MAX(EFFDT) 
                   FROM PS_BEN_PROG_PARTIC
                   WHERE PP.EMPLID = EMPLID
                   AND PP.EMPL_RCD = EMPL_RCD
                   AND PP.COBRA_EVENT_ID = COBRA_EVENT_ID
                   AND   EFFDT    <= $asofdate)
!                   AND EFFDT <= $plus30_date)  
!ORDER BY  HB.EMPLID, HB.BENEFIT_PLAN, HB.PLAN_TYPE
!ORDER BY  HB.EMPLID, HB.PLAN_TYPE, HB.BENEFIT_PLAN
ORDER BY  HB.EMPLID, HB.PLAN_TYPE desc

end-select
do before-emplid
if $rowfound = 'N'
   display 'No Employees found for the High Mark File.' 
else
  !do create-trailer-rec  !VENDKXY  Done changes for S3 14115146
  do check-for-cancels
  
 !GEX ISDVNPK 06/15/2013 Commented the below as part of file format change from IFF to 834
 ! do create-trailer-rec  !VENDKXY  Done changes for S3 14115146
 !GEX ISDVNPK 06/15/2013 Commented the above as part of file format change from IFF to 834
  do select-from-curr
  !GEX ISDVNPK 06/15/2013 Added the below as part of file format change from IFF to 834
   Do Write-SE-Trailer-Record
   Do Write-GE-Trailer-Record
   Do Write-IEA-Trailer-Record
  !GEX ISDVNPK 06/15/2013 Added the above as part of file format change from IFF to 834
     
end-if
end-procedure


begin-procedure before-emplid
#debug9 Show 'before-emplid ' $emplid
end-procedure

!begin-procedure after-emplid
!#debug9 Show 'after-emplid ' $emplid
!end-procedure

begin-procedure after-emplid
#debug9 Show 'after-emplid ' $emplid
  if $coverage_elect = 'E'
    move $emplid to $prev_emplid
    let $benef_id = '00'
    Do create-rec-100
    do create-seq-nbr
      if rtrim($emplid,' ') <> ''
        do check-for-existing-row
        if $row_exists = 'N'
          do insert-rec
        end-if
      end-if
    do create-rec-110
    do create-seq-nbr
      if rtrim($emplid,' ') <> ''
        do check-for-existing-row
        if $row_exists = 'N'
          do insert-rec
        end-if
      end-if
    do create-rec-130
    do create-seq-nbr
      if rtrim($emplid,' ') <> ''
        do check-for-existing-row
        if $row_exists = 'N'
          do insert-rec
        end-if 
      end-if
  else
    add 1 to #no_elect_ctr
    show '===>> Coverage_elect not = E: ' $emplid
  end-if
end-procedure

begin-procedure create-contract-id
#debug9 Show 'create-contract-id - $group_nbr: ' $group_nbr
  if rtrim($save_group_nbr,' ') <> ''
    let $contract_id   = '0' || substr($save_group_nbr,1,5) || substr($save_group_nbr,7,2)
  end-if
   let $contract_id   = rpad($contract_id,30,' ')
end-procedure

begin-procedure before-group-nbr
#debug9 Show 'before-group-nbr  $group_nbr = ' $group_nbr ';  $save_group_nbr = ' $save_group_nbr
end-procedure

begin-procedure after-group-nbr
#debug9 Show 'after-group-nbr  $group_nbr: ' $group_nbr
end-procedure

begin-procedure before-plan-type
#debug9 Show 'before-plan-type ' $plan_type
    Let $prev_plantype=$plan_type
    Let $prev_covrg_cat_cd=$covrg_cat_cd
    Let $prev_covrg_cd=$covrg_cd
    Let $prev_relation_cd=$relation_cd
  !  show 'Prev Plantype:' $prev_plantype
  !  show 'PrevCoverage:' $prev_covrg_cat_cd
  !  show 'Prevcoveragecode:' $prev_covrg_cd
end-procedure

begin-procedure after-plan-type
#debug9 Show 'after-plan-type ' $plan_type ', $save_plan_type = ' $save_plan_type
#debug9 do after-plan-display
  if $coverage_elect = 'E'
  if $agreement_nbr <> '0000000000'
  !Changed by VENDKXY on 11/27/2007 For ITG 45099
    if &hb.plan_type='10'! or &hb.plan_type='11' or &hb.plan_type='14'
     if $plan_type='15'
     if &HB.COVRG_CD='1'
       if ($covrg_cd='5' or $covrg_cd = '24' or $covrg_cd = '25') !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='TWO'
       END-IF
       if ($covrg_cd='6' or $covrg_cd = '26' or $covrg_cd = '27'
                      or $covrg_cd = '28' or $covrg_cd = '29')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='ECH'
       END-IF
      if ($covrg_cd='7' or $covrg_cd = '30' or $covrg_cd = '31'
    or $covrg_cd = '32' or $covrg_cd = '33' or $covrg_cd = '34' or $covrg_cd = '35'  or $covrg_cd = '36' or $covrg_cd = '37')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='FAM'
       END-IF
    end-if
    if (&HB.COVRG_CD='3'  or &HB.COVRG_CD =  '10'  or &HB.COVRG_CD =  '11' or &HB.COVRG_CD =  '13' or &HB.COVRG_CD =  '15') 
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
       if ($covrg_cd='5' or $covrg_cd = '24' or $covrg_cd = '25') !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='FAM'
       END-IF
       if ($covrg_cd='6' or $covrg_cd = '26' or $covrg_cd = '27'
                      or $covrg_cd = '28' or $covrg_cd = '29')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='ECH'
      END-IF
      if ($covrg_cd='7' or $covrg_cd = '30' or $covrg_cd = '31'
    or $covrg_cd = '32' or $covrg_cd = '33' or $covrg_cd = '34' or $covrg_cd = '35'  or $covrg_cd = '36' or $covrg_cd = '37')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
         Let $covrg_cat_cd='FAM'
       END-IF
    end-if
    end-if
   end-if
    !show 'Coverage cat code:'$covrg_cat_cd
    !Changed by VENDKXY on 11/2	7/2007 For ITG 45099
    !show $relation_cd '------' $plan_type
!    if $relation_cd <> '29'
    if $plantype<>'15' and $plan_type = '10'
!    if $plan_type <> '14'!VENDKXY for ITG 45099
    let $benef_id = '00' 
     Do create-rec-135
     do create-seq-nbr
     let $curr_out1 = $out1
        do check-for-existing-row
        if $row_exists = 'N'
       ! show 'Kundan'
          do insert-rec
       end-if									!VENDKXY for ITG 45099
  !    end-if
 !     end-if
     else
     if $plan_type<>'10' and $plan_type<>'15' !VENDKXY for ITG 45099
    let $benef_id = '00' 
     Do create-rec-135
     do create-seq-nbr
     let $curr_out1 = $out1
        do check-for-existing-row
        if $row_exists = 'N'
        !show 'Kundan'
          do insert-rec
       end-if									!VENDKXY for ITG 45099
     end-if
     end-if
    move 'N' to $dep_found 
     do get-dependent
  end-if
  end-if
end-procedure

!begin-procedure after-plan-type
!#debug9 Show 'after-plan-type ' $plan-type
!end-procedure

begin-procedure after-plan-display
     show '$emplid: ' $emplid
     show '$benef_id: ' $benef_id
     show '&hb.plan_type: ' &hb.plan_type
     show '&HB.COVRG_CD:' &HB.COVRG_CD
     show '&hb.effdt: ' &hb.effdt
     show '$hb_effdt: ' $hb_effdt
     show '$save_plan_type: ' $save_plan_type
     show '$plan_type: ' $plan_type
     show '$hb_coverage_begin_dt: ' $hb_coverage_begin_dt
end-procedure

!*********************************************************************
begin-procedure create-seq-nbr
#debug9 show 'create-seq-nbr'     
#debug9 show '$emplid: ' $emplid
#debug9 show '$benef_id: ' $benef_id
#debug9 show '$plan_type: ' $plan_type
     if $benef_id = '00'
       if ($rec_type = '100'
       or $rec_type = '110'
       or $rec_type = '130')
         let $seq_plan_type = '10'
       else       
         let $seq_plan_type = $plan_type
       end-if
     else 
       if ($rec_type = '100'
       or $rec_type = '115')
         let $seq_plan_type = '10'
       else
         let $seq_plan_type = $plan_type
       end-if
     end-if

     let $seq_nbr = $benef_id || $seq_plan_type
     move $seq_nbr to #seq_nbr 

end-procedure
!*********************************************************************

!*********************************************************************
begin-procedure evaluate-covrg-cd
  let $covrg_cat_cd = '   '
  evaluate $covrg_cd
    when = '1'
      let $covrg_cat_cd = 'IND'
    when = '2'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
    when = '8'
    when = '9'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
  
      let $covrg_cat_cd = 'ECH'!Changed by VENDKXY on 11/27/2007 For ITG 45099
    when = '3'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
    when = '10'
    when = '11'
    when = '13'
    when = '15'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
   
      let $covrg_cat_cd = 'ECH'
    when = '4'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
    when = '16'
    when = '17'
    when = '18'
    when = '19'
    when = '20'
    when = '21'
    when = '22'
    when = '23'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
        
      let $covrg_cat_cd = 'FAM'
    !Changed by VENDKXY on 11/07/2007 For ITG 45099
    when = '5'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
    when = '24'
    when = '25'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
      let $covrg_cat_cd = 'TWO'
    when = '6'
   !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
    when = '26'
    when = '27'
    when = '28'
    when = '29'
   !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
      let $covrg_cat_cd = 'ECH'
    when = '7'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
    when = '30'
    when = '31'
    when = '32'
    when = '33'
    when = '34'
    when = '35'
    when = '36'
    when = '37'
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
      let $covrg_cat_cd = 'FAM'
  end-evaluate
 if $prev_plantype='15' or $prev_plantype='16' or $prev_plantype='17'
   
     if $covrg_cd='1'
       if ($prev_covrg_cd='5' or $prev_covrg_cd = '24' or $prev_covrg_cd = '25')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='TWO'
       END-IF
       if ($prev_covrg_cd='6' or $prev_covrg_cd = '26' or $prev_covrg_cd = '27'
                      or $prev_covrg_cd = '28' or $prev_covrg_cd = '29')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='ECH'
       END-IF
       if ($prev_covrg_cd='7' or $prev_covrg_cd = '30' or $prev_covrg_cd = '31'
    or $prev_covrg_cd = '32' or $prev_covrg_cd = '33' or $prev_covrg_cd = '34' or $prev_covrg_cd = '35'  or $prev_covrg_cd = '36' or $prev_covrg_cd = '37')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='FAM'
       END-IF
    end-if
    if ($covrg_cd =  '3'  or $covrg_cd =  '10'  or $covrg_cd =  '11' or $covrg_cd =  '13'  or $covrg_cd =  '15') 
    !GEX ISDVNPK 12/05/2010 Added the below new Coverage Code for OE11 changes
       if ($prev_covrg_cd='5' or $prev_covrg_cd = '24' or $prev_covrg_cd = '25')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='FAM'
       END-IF
       if ($prev_covrg_cd='6' or $prev_covrg_cd = '26' or $prev_covrg_cd = '27'
                      or $prev_covrg_cd = '28' or $prev_covrg_cd = '29')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
          Let $covrg_cat_cd='ECH'
       END-IF
       if ($prev_covrg_cd='7' or $prev_covrg_cd = '30' or $prev_covrg_cd = '31'
    or $prev_covrg_cd = '32' or $prev_covrg_cd = '33' or $prev_covrg_cd = '34' or $prev_covrg_cd = '35'  or $prev_covrg_cd = '36' or $prev_covrg_cd = '37')      !GEX ISDVNPK 12/05/2010 Added the new Coverage Code for OE11 changes
         Let $covrg_cat_cd='FAM'
       END-IF
    end-if
  end-if
    #debug9 show 'Coverage Cat Code:'$covrg_cat_cd
  end-procedure

!*********************************************************************
! Create record 100 variables to be inserted into PS_GEX_HRMRK_CURR
!*********************************************************************
begin-procedure Create-rec-100
#debug9 Show 'create-rec-100'
  let $rec_type = '100'
  let $marital_status = ' '
  let $relation_cd    = '20'
  let $subscriber     = 'Y'
  let $ssn = rpad($national_id,17,' ')
  let $f_name = rpad($first_name,25,' ')
  let $m_name = rpad($middle_name,25,' ')
  let $l_name = rpad($last_name,35,' ')
  let $EE_name = rtrim($f_name,' ')||' '||rtrim($m_name,' ')||' '||rtrim($l_name,' ')
  let $p_fix = rpad($prefix,10,' ')
  let $s_fix = rpad($suffix,10,' ')
  let $year4 = '1'
  do Format-datetime($hire_dt,$Hire_Date,{DEFMDY},'','')
  let $year4 = '1'
  do Format-datetime($birthdate,$birth_Date,{DEFMDY},'','')
  
  let $out1 = $agreement_nbr||$contract_id||$rec_type||$rec_seq_nbr||' '||$ssn||
      $birth_date||$f_name||$m_name||$l_name||
      $p_fix||$s_fix||$sex||'      '||$marital_status||$relation_cd||$35_spaces||
      $subscriber||$hire_date
  let $out1 = rpad($out1,254,' ')
  let $out2 = $246_spaces         

!  add 1 to #total_100_recs
!  add 1 to #total_recs

end-procedure


!*********************************************************************
! Create record 110 variables to be inserted into PS_GEX_HRMRK_CURR
!*********************************************************************
begin-procedure Create-rec-110
#debug9 Show 'create-rec-110'
  let $add_qual = 'C9'
  let $address1 = rpad($address1,55,' ')
  let $address2 = rpad($address2,55,' ')
  let $address3 = rpad($address3,55,' ')
  let $city     = rpad($city,30,' ')
  let $zip      = rpad($postal,15,' ')
  do  get-addr-effdt
  let $addr_effdt = rpad($addr_effdt,10,' ')
  let $addr_cancel_dt = $10_spaces
  let $rec_type = '110'
  let $out1 = $agreement_nbr||$contract_id||'110'||$rec_seq_nbr||$add_qual||
	$address1||$address2||$address3
  let $out1 = rpad($out1,254,' ')
  let $out2 = $18_spaces||$city||$state||$zip||$country||
	$addr_effdt||$addr_cancel_dt
  let $out2 = rpad($out2,246,' ')
  let $curr_rec_110 = $out1||$out2
!  add 1 to #total_recs
	
end-procedure


begin-procedure get-addr-effdt
#debug9 Show 'get-addr-effdt'
begin-select 
max(addr.effdt) &addr_effdt
  let $year4 = '1'
  do Format-datetime(&addr_effdt,$addr_effdt,{DEFMDY},'','')
from ps_addresses addr
where addr.emplid = $emplid
and addr.address_type = 'HOME'
end-select
end-procedure

!*********************************************************************
! Create record 130 variables to be inserted into PS_GEX_HRMRK_CURR
!*********************************************************************
begin-procedure Create-rec-130
#debug9 Show 'create-rec-130'
  let $rec_type = '130'
  let $qual_cd = 'AP'
  let $year4 = '1'
!  do Format-datetime($job_effdt,$qual_effdt,{DEFMDY},'','')
  do Format-datetime($asofdate,$qual_effdt,{DEFMDY},'','')
  let $qual_cancel_date = $10_spaces
  do get-gex-div-cd
  let $130_rpt_id = $gex_div_cd
  let $130_rpt_id = rpad($130_rpt_id,30,' ') 
  let $out1 = $agreement_nbr||$contract_id||$rec_type||$rec_seq_nbr||
	'01'||$qual_cd||$qual_effdt||$130_rpt_id||$qual_cancel_date||
	$40_spaces||$10_spaces 
  let $out2 = $246_spaces
  let $curr_rec_130 = $out1||$out2
!  add 1 to #total_recs
end-procedure

begin-procedure get-gex-div-cd
#debug9 Show 'get-gex-div-cd'
begin-select 
gdt.gex_company_div_cd
  let $gex_div_cd = &gdt.gex_company_div_cd
from ps_gex_dept_tbl gdt
where gdt.deptid = $deptid
and gdt.setid = 'COMMN'
and gdt.effdt = 
   (select max(effdt)
    from ps_gex_dept_tbl
    where setid = gdt.setid
    and deptid = gdt.deptid
    and effdt <= $asofdate) 
end-select
end-procedure

!*********************************************************************
! Create record 135 variables to be inserted into PS_GEX_HRMRK_CURR
!*********************************************************************
begin-procedure Create-rec-135
#debug9 Show 'create-rec-135'
  let $rec_type = '135'
  if rtrim($contract_id,' ') = ''
    let $temp1 = &bp.group_nbr 
    let $contract_id   = '0' || substr($temp1,1,5) || substr($temp1,7,2)
    let $contract_id   = rpad($contract_id,30,' ')
  end-if
  if $plan_type = '11'
    let $policy = 'DEN'
  else
  if $plan_type = '14'
    let $policy = 'VIS'
  else
    let $policy = 'BA '
  end-if
  end-if
 !SHOW $policy   				!VENDKXY FOR ITG 45099 
  let $ins_line_cd = $policy   
  let $year4 = '1'
  if $dep_bday_flag = 'Y'
    let $covrg_begin_Date = $dep_covrg_begin_Date
  else
    do Format-datetime($hb_coverage_begin_dt,$covrg_begin_Date,{DEFMDY},'','')
  end-if
  let $dep_bday_flag = 'N'
  let $plan_area = rpad($plan_area,17,' ') 
  let $covrg_cancel_date = $10_spaces
  let $covrg_cancel_cd = '  '
  let $covrg_count = '01'

  let $out1 = $agreement_nbr||$contract_id||$rec_type||$rec_seq_nbr||
	$covrg_count||$ins_line_cd||$covrg_begin_date||$3_spaces||
	$covrg_cat_cd||$3_spaces||$plan_area||'  '||$covrg_cancel_date||
	$covrg_cancel_cd||$report_date 
  let $out1 = rpad($out1,254,' ')
  let $out2 = $246_spaces
  let $curr_rec_135 = $out1||$out2
!  add 1 to #total_recs

end-procedure

!*********************************************************************
begin-procedure Get-Dependent
#debug9 Show 'get-dependent'


begin-select

HD.EMPLID

DB.DEPENDENT_BENEF
   move &DB.DEPENDENT_BENEF to $dependent_benef

DB.FIRST_NAME
   move &DB.FIRST_NAME      to $dep_first_name

DB.MIDDLE_NAME
   move &DB.MIDDLE_NAME     to $dep_mid_name

DB.LAST_NAME
   move &DB.LAST_NAME       to $dep_last_name

DB.RELATIONSHIP
   move &DB.RELATIONSHIP    to $dep_relationship

DB.MAR_STATUS
   move &DB.MAR_STATUS      to $dep_mar_status

DB.STUDENT
   move &DB.STUDENT         to $dep_student
				 
DB.DISABLED
   move &DB.DISABLED        to $dep_disabled

DB.BIRTHDATE
   move &DB.BIRTHDATE       to $dep_birthdate

DB.SEX
   move &DB.SEX             to $dep_sex

NVL(DNID.NATIONAL_ID,' ')   &DNID.NATIONAL_ID
   move &DNID.NATIONAL_ID   to $dep_ssn

HD.PLAN_TYPE
   move &HD.PLAN_TYPE       to $dep_plan_type

HD.EFFDT                    &hd.effdt    
   move &HD.EFFDT           to $hd_effdt


   move 'Y' to $dep_found
   do create-dep-recs

!##############################################################
#debug9  show '$emplid: ' $emplid
#debug9  show '$dependent_benef: ' $dependent_benef
#debug9  show '$plan_type: ' $plan_type
#debug9  show '$hb_effdt: '  $hb_effdt
!##############################################################

FROM PS_DEPENDENT_BENEF DB,
     PS_HEALTH_DEPENDNT HD,
     PS_DEP_BENEF_NID DNID

WHERE DB.EMPLID          = HD.EMPLID
AND   DB.EMPLID          = $emplid
AND   DB.DEPENDENT_BENEF = HD.DEPENDENT_BENEF
AND   DB.EMPLID          = DNID.EMPLID(+)
AND   DB.DEPENDENT_BENEF = DNID.DEPENDENT_BENEF(+)
AND   HD.EMPL_RCD        = #empl_rcd              
AND   HD.PLAN_TYPE       = $plan_type

AND   HD.EFFDT           = $HB_EFFDT

ORDER BY HD.EMPLID, DB.DEPENDENT_BENEF

end-select
end-procedure

!*********************************************************************
begin-procedure create-dep-recs
#debug9 show 'create-dep-recs'
#debug9  show '$emplid: ' $emplid
#debug9  show '$dependent_benef: '  $dependent_benef
#debug9  show '$dep_plan_type: ' $dep_plan_type
#debug9  show '$plan_type: ' $plan_type

! Deepak, FC, 12/03/07. Made changes due to 9.0 upgrade (XLAT values)

  If $DEP_FOUND = 'Y'
  evaluate $dep_relationship
    when = 'SP'
     let $relation_cd   = '01'
     break
    when = 'C'			! D and S = C
    !Changed by VENDKXY on 11/07/2007 For ITG 45099
    when = 'NC'               ! ND and NS = NC
    !Changed by VENDKXY on 11/07/2007 For ITG 45099
    
  !GEX ISDVNPK 06/15/2013 Commented and Added the below as part of file format change from IFF to 834
    when = 'AC'
    when = 'FC'
    when = 'RC'
    when = 'SC'
    when = 'GC'
    when = 'OC'
        let $relation_cd   = '19'
     break 
  !   let $relation_cd   = '02'
  !   break
  !  when = 'P'			! FA and M = P
  !   let $relation_cd   = '03'
  !   break
  !  when = 'GP'			! GF and GM = GP
  !   let $relation_cd   = '04'
  !   break
  !  when = 'GC'			! GS and GD = GC 
  !   let $relation_cd   = '05'
  !   break
  !  when = 'R'			! A and U = R
  !   let $relation_cd   = '06'  ! NI and NE became R  
  !   break
  !  when = 'SB'			! B and SI = SB
  !   let $relation_cd   = '14'
  !   break
  !  when = 'SC'			! SS and SD = SC	
  !   let $relation_cd   = '17'
  !   break
  !  when = 'E'			! E = E
  !   let $relation_cd   = '20'
  !   break
    when = 'NA'			! NA = NA
  !   let $relation_cd   = '29'
      let $relation_cd   = '53'
     break
    when-other
          let $relation_cd   = '99'
     break
!GEX ISDVNPK 06/15/2013 Commented and Added the above as part of file format change from IFF to 834     
  end-evaluate
   let $dep_bdate_flag = 'N'
   #debug9 show 'relation code:' $relation_cd
   do check-dep-birthdate
  if $relation_cd = '01'
    do spouse-rtn
  else 
  if $dep_disabled = 'Y'
    do disabled-rtn
  else 
  ! GEX ISDVNPK 12/05/2010 Commented below to remove the Student criteria for OE11 changes
  !if $dep_student = 'Y' 
  !  do student-rtn
  !else
  ! GEX ISDVNPK 12/05/2010 Commented above to remove the Student criteria for OE11 changes
    do non-stud-rtn    
  !end-if
  end-if
  end-if  
  END-IF
  ! Added by VENDKXY as per Molly Request for ITG 45099
  !GEX ISDVNPK 06/15/2013 Commented and Added the below as part of file format change from IFF to 834
  !if $relation_cd   = '29'
  if $relation_cd   = '53'
  !GEX ISDVNPK 06/15/2013 Commented and Added the below as part of file format change from IFF to 834
   Do create-dep-rec-100
    do create-seq-nbr
    do check-for-existing-row
    if $row_exists = 'N'
      do insert-rec
    end-if
   do create-rec-135
    do create-seq-nbr
    if $agreement_nbr <> '0000000000'
      do check-for-existing-row
        if $row_exists = 'N'
          do insert-rec
        end-if
    end-if
   end-if
   ! Added by VENDKXY as per Molly Request for ITG 45099
end-procedure

Begin-procedure spouse-rtn 
    Do create-dep-rec-100
    do create-seq-nbr
    do check-for-existing-row
    Let $row='Y'			!VENDKXY for ITG 45099 on 111/28/2007
    if $row_exists = 'N'
      do insert-rec
      Let $row='N'			!VENDKXY for ITG 45099 on 111/28/2007
    end-if
    if $prev_plantype<>'15'
    Let $row='N'
    end-if
    do create-rec-135
    do create-seq-nbr
    if $agreement_nbr <> '0000000000' and $row='N' 	!VENDKXY for ITG 45099 on 111/28/2007
        do check-for-existing-row
        if $row_exists = 'N'
          do insert-rec
        end-if
    end-if
end-procedure

Begin-procedure disabled-rtn
      Do create-dep-rec-100
      do create-seq-nbr
      do check-for-existing-row
      if $row_exists = 'N'
        do insert-rec
      end-if
      do create-dep-rec-115 
      do check-for-existing-row
      if $row_exists = 'N'
        do insert-rec
      end-if   
      do create-rec-135
      do create-seq-nbr
      do check-for-existing-row
      if $row_exists = 'N'
        do insert-rec
      end-if
end-procedure

begin-procedure non-stud-rtn
    let $non_stud_over_age = 'N' 
    do calc-non-stud-age 
    if $non_stud_over_age = 'N' 
      Do create-dep-rec-100
      do create-seq-nbr
      do check-for-existing-row
      if $row_exists = 'N'
        do insert-rec
      end-if 
      do create-rec-135
      do create-seq-nbr
      do check-for-existing-row
      if $row_exists = 'N'
        do insert-rec
      end-if 
    end-if
end-procedure

begin-procedure check-dep-birthdate
#debug9 show 'check-fordep-birthdate'
     do Convert-To-DTU-Date($hb_coverage_begin_dt,$covrg_begin_Dt_dtu)
     do Convert-To-DTU-Date($dep_birthdate,$dep_birth_Dt_dtu)
     if $dep_birth_dt_dtu > $covrg_begin_dt_dtu
       let $dep_bday_flag = 'Y' 
       let $dep_name = rtrim($dep_first_name,' ')||' '||rtrim($dep_mid_name,' ')||
		' '||rtrim($dep_last_name,' ')
       let $year4 = '1'
       do Format-datetime($dep_birthdate,$dep_covrg_begin_Date,{DEFMDY},'','')
     end-if
end-procedure

begin-procedure check-for-existing-row
#debug9 show 'check-for-existing-row'
#debug9  show '$Agreement_nbr: ' $agreement_nbr
#debug9  show '$rec_type: '  $rec_type
#debug9  show '#seq_nbr: ' #seq_nbr 
  let $row_exists = 'N'
begin-select
'X'

  let $row_exists = 'Y'

from ps_gex_himrk_curr HC
where hc.agreement_id = $agreement_nbr
and   hc.gex_rec_type = $rec_type
and   hc.seq_nbr      = #seq_nbr
end-select
#debug9  show '$row_exists: '$row_exists
end-procedure


begin-procedure Create-dep-rec-100
#debug9 Show 'create-dep-rec-100'
  let $rec_type = '100'
  let $benef_id = $dependent_benef  
  let $marital_status = ' '
  let $subscriber     = 'N'
  let $hire_date = $10_spaces
  let $dep_ssn = rpad($dep_ssn,17,' ')
  let $dep_first_name = rpad($dep_first_name,25,' ')
  let $dep_mid_name = rpad($dep_mid_name,25,' ')
  let $dep_last_name = rpad($dep_last_name,35,' ')
  let $dep_name = rtrim($dep_first_name,' ')||' '||rtrim($dep_mid_name,' ')||
	' '||rtrim($dep_last_name,' ')
  let $p_fix = ' '
  let $p_fix = rpad($p_fix,10,' ')
  let $s_fix = ' '
  let $s_fix = rpad($s_fix,10,' ')
  let $year4 = '1'
  do Format-datetime($dep_birthdate,$dep_birth_Date,{DEFMDY},'','')
  let $out1 = $agreement_nbr||$contract_id||$rec_type||$rec_seq_nbr||' '||$dep_ssn||
      $dep_birth_date||$dep_first_name||$dep_mid_name||$dep_last_name||
      $p_fix||$s_fix||$dep_sex||'      '||$marital_status||$relation_cd||$35_spaces||
      $subscriber||$hire_date
  let $out1 = rpad($out1,254,' ')
  let $out2 = $246_spaces         

!  add 1 to #total_100_recs
!  add 1 to #total_recs

end-procedure
!*********************************************************************
!*********************************************************************
begin-procedure Create-dep-rec-115
#debug9 Show 'create-dep-rec-115'
  let $rec_type = '115'
  let $benef_id = $dependent_benef  
  let $elig_qual_cd = ' '
  let $elig_effdt = $10_spaces
  ! GEX ISDVNPK 12/05/2010 Commented below to remove the Student criteria for OE11 changes
  !if $dep_student = 'Y'
  !  do calc-stud-age
  !  let $elig_qual_cd = 'F'
  !end-if  
  ! GEX ISDVNPK 12/05/2010 Commented above to remove the Student criteria for OE11 changes
  if $dep_disabled = 'Y'
    let $elig_effdt = $coverage_begin_Date
    let $elig_qual_cd = '3'
  end-if  
  let $elig_count = '01'  
  let $elig_cancel_dt = $10_spaces
  let $cancel_cd = '  '
  let $cert_date = $10_spaces
  let $medical_cond = $10_spaces||$5_spaces
  let $out1 = $agreement_nbr||$contract_id||$rec_type||$rec_seq_nbr||$elig_count||
	$elig_qual_cd||$cert_date||$35_spaces||$elig_effdt||$elig_cancel_dt||
	$cancel_cd||$medical_cond||$report_date
  let $out1 = rpad($out1,254,' ')
  let $out2 = $246_spaces
  let $curr_rec_115 = $out1||$out2
!  add 1 to #total_recs	

end-procedure

!*********************************************************************
Begin-procedure calc-stud-age
#debug9 show 'calc-stud-age'

  do Format-datetime($report_date,$report_Date_dbf,{DEFMDY},'','native')
  do Convert-To-DTU-Date($report_Date_dbf,$report_Date_dtu)
  do Convert-To-DTU-Date($dep_birthDate,$dep_birthDate_dtu)

  do dtu-add-years($dep_birthdate_dtu,23,$23rd_birthday_dtu)  
  do dtu-month-begin($report_date_dtu,$month_begin_dtu)
!  do Dtu-Diff-Years($dep_birthdate_dtu,$report_date_dtu,#Age_Yrs)
  do Dtu-Diff-Years($dep_birthdate_dtu,$month_begin_dtu,#Age_Yrs)

  if $report_date_dtu > $23rd_birthday_dtu
     let $stud_over_23 = 'Y' 
!     let $dep_student = ' '
!     let $elig_effdt = $coverage_begin_Date
  end-if
      do dtu-add-years($dep_birthdate_dtu,19,$19th_birthday_dtu)  

    do dtu-add-months($19th_birthday_dtu,1,$stud_elig_effdt_dtu)  
    let $stud_elig_effdt_dtu = substr($stud_elig_effdt_dtu,1,8)||'01'

    do convert-from-dtu-date($stud_elig_effdt_dtu,$stud_elig_effdt_1)
    let $year4 = '1'
    do Format-datetime($stud_elig_effdt_1,$stud_elig_effdt,{DEFMDY},'','')

    do Convert-To-DTU-Date($hb_coverage_begin_dt,$covrg_begin_Date_dtu)

    let $year4 = '1'
    do Format-datetime($hb_coverage_begin_dt,$coverage_begin_Date,{DEFMDY},'','')

    if $stud_elig_effdt_dtu > $covrg_begin_Date_dtu
       let $elig_effdt = $stud_elig_effdt
    else
!       do convert-from-dtu-date($19th_birthday_dtu,$19th_birthday)
       let $elig_effdt = $coverage_begin_Date
       add 1 to #stud_except_count 
    end-if

end-procedure

!*********************************************************************
Begin-procedure calc-non-stud-age
#debug9 show 'calc-non-stud-age'

!  show 'Name: ' $dep_first_name
!  show '$dep_birthdate: ' $dep_birthdate

  do Format-datetime($report_date,$report_Date_dbf,{DEFMDY},'','native')
  do Convert-To-DTU-Date($report_Date_dbf,$report_Date_dtu)
  do Convert-To-DTU-Date($dep_birthDate,$dep_birthDate_dtu)!
  do dtu-add-years($dep_birthdate_dtu,19,$19th_birthday_dtu)  
  do dtu-add-months($19th_birthday_dtu,1,$stud_elig_effdt_dtu)  
  do dtu-month-begin($report_date_dtu,$month_begin_dtu)
  ! GEX ISDVNPK 12/05/2010 Added the below so that Dep Age limit is obtained from Ben Defn Pgm table for comparing the Age limit for OE11 changes
  do Dtu-Diff-Years($dep_birthdate_dtu,$month_begin_dtu,#dep_age_Yrs)
  do get-dep-age-limit
  ! GEX ISDVNPK 12/05/2010 Added the above so that Dep Age limit is obtained from Ben Defn Pgm table for comparing the Age limit for OE11 changes

! GEX ISDVNPK 12/05/2010 Added the below so that Dep Age limit is fetched from Ben Defn Pgm table for comparing the Age limit for OE11 changes
  if #dep_Age_Yrs >= #dep_age_limit
!  if $report_date_dtu > $19th_birthday_dtu
!  if $month_begin_dtu > $19th_birthday_dtu
! GEX ISDVNPK 12/05/2010 Commenetd above as part of OE11 changes

    let $non_stud_over_age = 'Y' 
    let $dep_name = rtrim($dep_first_name,' ')||' '||rtrim($dep_mid_name,' ')||
		' '||rtrim($dep_last_name,' ')
!    show '$prev_dep_name: ' $prev_dep_name
!    show '$dep_name: ' $dep_name
    if $dep_name <> $prev_dep_name
      add 1 to #over_19_ctr
      let $year4 = '1'
      do Format-datetime($dep_birthdate,$dep_birth_Date,{DEFMDY},'','')
      #debug9 show $dashes  
       ! GEX ISDVNPK 12/05/2010 Commenetd below as part of OE11 changes
       !show 'Non-Student, non-spouse 19 or older - enrollment not sent.'
      #debug9 show 'Dependant age 26 or older - enrollment not sent.'
       ! GEX ISDVNPK 12/05/2010 Commenetd above as part of OE11 changes
      #debug9 show 'EE: ' $national_id  '  Group nbr: ' $group_nbr
      #debug9 show 'Dependent Name: ' $dep_name ', Dep SSN: ' $dep_ssn
      #debug9  show '$dep_birthdate: ' $dep_birth_Date
      #debug9  show $dashes  
       if #current-line > 55
         new-page
       end-if
       ! GEX ISDVNPK 12/05/2010 Commenetd below as part of OE11 changes
       !let $prt1 = 'Non-Student, non-spouse 19 or older - enrollment not sent.'
       ! GEX ISDVNPK 12/05/2010 Commenetd above as part of OE11 changes
       let $prt1 = 'Dependant age 26 or older - enrollment not sent.'
       print $prt1 (+1,5)
       let $prt1 = 'EE: '||$national_id||', Group nbr: '||$group_nbr
       print $prt1 (+1,5)
       let $prt1 = 'Dep Name: '||$dep_name||', Dep SSN: '||$dep_ssn||', Birthdate: '||$dep_birth_Date
       print $prt1 (+1,5)
       let $prt1 = ' '
       print $prt1 (+1,5)
    end-if   
  end-if
  let $prev_dep_name = $dep_name
end-procedure

! GEX ISDVNPK 12/05/2010 Added the below procedure so that Dep Age limit is obtained from Ben Defn Pgm table for comparing the Age limit for OE11 changes
!*********************************************************************
begin-procedure get-dep-age-limit
begin-select 
BDP1.DEP_AGE_LIMIT 
   move &BDP1.DEP_AGE_LIMIT to #dep_age_limit
from PS_BEN_DEFN_PGM BDP1
  where BDP1.BENEFIT_PROGRAM = $benefit_program
    and BDP1.EFF_STATUS = 'A'
    and BDP1.EFFDT =
     (select max(effdt)
      from ps_ben_defn_pgm   
      where BDP1.benefit_program = benefit_program
        and BDP1.EFF_STATUS = eff_status 
        and effdt <=$asofdate)
end-select
end-procedure

!*********************************************************************
!  Insert rows into PS_GEX_HIMRK_CURR
!*********************************************************************
Begin-procedure Insert-rec
#debug9 Show 'insert-rec'
!  do display-variables
#debug9  show 'values: ' $agreement_nbr ', ' $rec_type ', ' #seq_nbr
Begin-sql
  insert into PS_GEX_HIMRK_CURR 
    values($agreement_nbr,
	   $rec_type,
           #seq_nbr,
           $out1,
           $out2)
end-sql
  add 1 to #total_recs
  if $rec_type = '100'
    add 1 to #total_100_recs
  end-if
  let $prior_out1 = $out1
end-procedure  

!*********************************************************************
begin-procedure check-for-cancels
#debug9 Show 'check-for-cancels'
begin-select
ghp.agreement_id
ghp.gex_rec_type
ghp.seq_nbr
ghp.text254
ghp.descr254
	
  let $rev_agreement_id = &ghp.agreement_id
  show 'kundan:' $rev_agreement_id !VENDKXY FOR ITG 45099 added for testing
  let $rev_gex_rec_type = &ghp.gex_rec_type
  move &ghp.seq_nbr to #rev_seq_nbr 
  SHOW 'REV SEQ NO:' #rev_seq_nbr  				!VENDKXY FOR ITG 45099
  move &ghp.seq_nbr to $rev_seq_nbr 9999			!VENDKXY FOR ITG 45099
  let $rev_text254      = &ghp.text254
  let $rev_descr254     = &ghp.descr254
  let $rev_contract_id = substr($rev_text254,11,8)
  let $rev_group_nbr = substr($rev_contract_id,2,7)
  let $cancel_emplid = substr($rev_agreement_id,1,9)
 
  do Check-Seq-Nbr
 
  if &ghp.gex_rec_type = '135'
    let $rev_policy = substr($rev_text254,53,3)
    do eval-prev-policy
    do get-cancel-date 
  end-if
  let $year4 = '1'
  do Format-datetime($cd_coverage_begin_dt,$rev_cancel_dt,{DEFMDY},'','')
  if $already_cancelled = 'N'
!###########################################################
    do get-rev-name
!###########################################################
    do check-contract-change
 
    if $curr_contract_found = 'Y'
      if $gcc_contract_id = $rev_contract_id
         do revised-rec-rtn
      end-if
    else
       do revised-rec-rtn
    end-if
  end-if

  from PS_GEX_HIMRK_PRIOR GHP
  where not exists
    (select 'X'
     from PS_GEX_HIMRK_CURR GHC
     where ghc.agreement_id = ghp.agreement_id
     and ghc.gex_rec_type = ghp.gex_rec_type
     and ghc.seq_nbr = ghp.seq_nbr)
   order by ghp.agreement_id,ghp.seq_nbr,ghp.gex_rec_type desc

end-select
end-procedure

!*********************************************************************
begin-procedure check-seq-nbr
#debug9 show 'check-seq-nbr'
 
  let $compare_nbr = substr($rev_seq_nbr,3,2)
 
  let #compare_nbr = $compare_nbr
 
  if #compare_nbr > 14
    let $already_cancelled = 'Y'
  else
    let $already_cancelled = 'N'
  end-if
 
end-procedure

!*********************************************************************
begin-procedure check-contract-change
#debug9 show 'do check-contract-change'
  let $curr_contract_found = 'N'
  !show 'kundan:' $rev_agreement_id !VENDKXY FOR ITG 45099 added for testing
begin-select
gcc.agreement_id
gcc.gex_rec_type
substr(gcc.text254,11,8) &contract_id


  let $gcc_contract_id = &contract_id
  let $curr_contract_found = 'Y'
	!show 'contract'
from PS_GEX_HIMRK_CURR GCC
where gcc.agreement_id = $rev_agreement_id
!and gcc.gex_rec_type = $rev_gex_rec_type
and gcc.gex_rec_type = '110'
end-select
end-procedure

!*************************************************************************
begin-procedure eval-prev-policy
  evaluate $rev_policy
    when = 'BA '
      let $cancel_plan_type = '10'
      break
    when = 'DEN'
      let $cancel_plan_type = '11'
      break
    when = 'VIS'
      let $cancel_plan_type = '14'
      break
    when-other
      #debug9 show 'BAD $REV_POLICY: ' $rev_policy
      break
  end-evaluate
end-procedure
!*************************************************************************
begin-procedure get-cancel-date
#debug9 Show 'get-cancel-date'

begin-select ON-ERROR=SQL-Error-Found('Get-cancel-date')
CD.EFFDT
CD.COVERAGE_BEGIN_DT
CD.COVERAGE_ELECT
CD.PLAN_TYPE
   move &CD.COVERAGE_BEGIN_DT to $CD_coverage_begin_dt
   move &CD.COVERAGE_ELECT    to $CD_coverage_elect
   move &CD.PLAN_TYPE         to $CD_plan_type
FROM  PS_HEALTH_BENEFIT CD
WHERE CD.EMPLID       = $cancel_EMPLID
AND   CD.PLAN_TYPE    = $cancel_plan_type
AND   CD.COVERAGE_BEGIN_DT =  (SELECT MAX(COVERAGE_BEGIN_DT) 
                   FROM PS_HEALTH_BENEFIT
                   WHERE CD.EMPLID = EMPLID
                   AND CD.EMPL_RCD = EMPL_RCD
                   AND CD.COBRA_EVENT_ID = COBRA_EVENT_ID
                   AND CD.PLAN_TYPE = PLAN_TYPE
                   AND CD.BENEFIT_NBR = BENEFIT_NBR
                   AND COVERAGE_BEGIN_DT  <= $asofdate)
!                   AND COVERAGE_BEGIN_DT  between $asofdate and $plus30_date)
!                   AND COVERAGE_BEGIN_DT  <= $plus30_date)

end-select
end-procedure
!*********************************************************************
begin-procedure get-rev-name
#debug9 show 'get-rev-name'
begin-select
ghpp.text254

  let $rev_f_name = rtrim(substr(&ghpp.text254,79,25),' ')
  let $rev_l_name = rtrim(substr(&ghpp.text254,129,35),' ')
  let $rev_name = $rev_f_name||' '||$rev_l_name

from ps_gex_himrk_prior ghpp
where ghpp.agreement_id = $rev_agreement_id  
  and ghpp.seq_nbr       = #rev_seq_nbr
  and ghpp.gex_rec_type  = '100'
end-select
end-procedure

!*********************************************************************
begin-procedure revised-rec-rtn
#debug9 show 'revised-rec-rtn'
    if $rev_gex_rec_type = '100' 
      add 1 to #cancelled_ctr
      do create-revised-rec-100
    end-if
    if $rev_gex_rec_type = '110' 
      do create-revised-rec-110
    end-if
    if $rev_gex_rec_type = '115' 
      do create-revised-rec-115
    end-if
    if $rev_gex_rec_type = '130' 
      do create-revised-rec-130
    end-if
    if $rev_gex_rec_type = '135' 
      do create-revised-rec-135
    end-if
end-procedure

!*********************************************************************
Begin-procedure Create-revised-rec-100
#debug9 show 'Create-revised-rec-100'
  
  let #new_seq_nbr = #rev_seq_nbr + 5
  
  let $rev_out1 = $rev_text254
  let $rev_out2 = rpad($rev_out2,246,' ')   
  if $hold_agreement_id <> $rev_agreement_id
    show $dashes
  end-if
  if substr($rev_seq_nbr,1,2) = '00'
    let $rev_100_msg = 'Cancelled 100 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			',     name: '||$rev_name 
  else
    let $rev_100_msg = 'Cancelled 100 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			', dep name: '||$rev_name 
  end-if
  do insert-revised-rec
  let $hold_agreement_id = $rev_agreement_id
end-procedure
!*********************************************************************
Begin-procedure Create-revised-rec-110
#debug9 show 'Create-revised-rec-110'
  let #new_seq_nbr = #rev_seq_nbr + 5
  let $addr_cancel_dt = $rev_cancel_dt
  
  let $rev_out1 = $rev_text254
  let $rev_out2 = substr($rev_descr254,1,78)||$addr_cancel_dt
  let $rev_out2 = rpad($rev_out2,246,' ')   
  if $hold_agreement_id <> $rev_agreement_id
    show $dashes
  end-if
  let $rev_110_msg = 'Cancelled 110 rec for emp: '||
		 $rev_agreement_id||', group: '||$rev_group_nbr||
		',     name: '||$rev_name 
  do insert-revised-rec
  let $hold_agreement_id = $rev_agreement_id
end-procedure
!*********************************************************************
Begin-procedure Create-revised-rec-115
#debug9 show 'Create-revised-rec-115'
  
  let #new_seq_nbr = #rev_seq_nbr + 5
  let $elig_cancel_dt = $rev_cancel_dt
  
  let $elig_cancel_code = '01' 
  let $rev_out1 = substr($rev_text254,1,108)||$elig_cancel_dt||
		$elig_cancel_code||substr($rev_text254,121,15)||
		$report_date||substr($rev_text254,146,109)
  let $rev_out2 = $rev_descr254
  let $rev_out2 = rpad($rev_out2,246,' ')   
  if $hold_agreement_id <> $rev_agreement_id
    show $dashes
  end-if
  if substr($rev_seq_nbr,1,2) = '00'
    let $rev_115_msg = 'Cancelled 115 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			',     name: '||$rev_name 
  else 
    let $rev_115_msg = 'Cancelled 115 rec for emp: '||
		  	 $rev_agreement_id||', group: '||$rev_group_nbr||
			', dep name: '||$rev_name 
  end-if
  
  do insert-revised-rec
  let $hold_agreement_id = $rev_agreement_id
end-procedure
!*********************************************************************
Begin-procedure Create-revised-rec-130
#debug9 show 'Create-revised-rec-130'
  
  let #new_seq_nbr = #rev_seq_nbr + 5
  SHOW '#new_seq_nbr :' #new_seq_nbr 					!VENDKXY FOR ITG 45099
  let $qual_cancel_dt = $rev_cancel_dt
  let $rev_out1 = substr($rev_text254,1,94)||$qual_cancel_dt||
		substr($rev_text254,105,150)
  let $rev_out2 = $rev_descr254
  if $hold_agreement_id <> $rev_agreement_id
    show $dashes
  end-if
  if substr($rev_seq_nbr,1,2) = '00'
    let $rev_130_msg = 'Cancelled 130 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			',     name: '||$rev_name 
  else
    let $rev_130_msg = 'Cancelled 130 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			', dep name: '||$rev_name 
  end-if
  do insert-revised-rec
  let $hold_agreement_id = $rev_agreement_id
end-procedure
!*********************************************************************
Begin-procedure Create-revised-rec-135
#debug9 show 'Create-revised-rec-135'
!########################################################################
  
  if $rev_seq_nbr = '0010'
    if $cd_coverage_elect = 'W'
      !let $covrg_cancel_cd = '29'
      let $covrg_cancel_cd = '53'
    end-if
    if $cd_coverage_elect = 'T'
      let $covrg_cancel_cd = '01'
      do check-deceased
      if $jj_empl_status = 'D'
        let $covrg_cancel_cd = '06'
      end-if
    end-if
  else
    if $cd_coverage_elect = 'W'
      !let $covrg_cancel_cd = '29'
      let $covrg_cancel_cd = '53'
    else
      let $covrg_cancel_cd = '01'
    end-if
  end-if    
!########################################################################
  let #new_seq_nbr = #rev_seq_nbr + 5
  SHOW 'NEW SEQ NO:' #new_seq_nbr 					!VENDKXY FOR ITG 45099
  let $covrg_cancel_dt = $rev_cancel_dt
  
  let $rev_out1 = substr($rev_text254,1,93)||$covrg_cancel_dt||$covrg_cancel_cd||
		$report_date||substr($rev_text254,116,149)
  let $rev_out2 = $rev_descr254
  if $hold_agreement_id <> $rev_agreement_id
    show $dashes
  end-if
  if substr($rev_seq_nbr,1,2) = '00'
    let $rev_135_msg = 'Cancelled 135 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			',     name: '||$rev_name 
  else
    let $rev_135_msg = 'Cancelled 135 rec for emp: '||
			 $rev_agreement_id||', group: '||$rev_group_nbr||
			', dep name: '||$rev_name 
  end-if
  do insert-revised-rec
  let $hold_agreement_id = $rev_agreement_id
end-procedure
!*********************************************************************
begin-procedure check-deceased
begin-select  
jj.empl_status
  let $jj_empl_status = &jj.empl_status
from ps_job jj
where jj.emplid = $cancel_emplid
and jj.effdt = (SELECT MAX(EFFDT)
		FROM PS_JOB
		WHERE EMPLID    = JJ.EMPLID
		AND   EMPL_RCD = JJ.EMPL_RCD
		AND   EFFDT    <= $asofdate)
end-select
end-procedure
!*********************************************************************
!*********************************************************************
!  Insert revised rows into PS_GEX_HIMRK_CURR
!*********************************************************************
Begin-procedure Insert-revised-rec
#debug9 Show 'insert-revised-rec'
 show 'insert-revised-rec'
 show '$rev_agreement_id :' $rev_agreement_id
 show '$rev_gex_rec_type :' $rev_gex_rec_type
 show '#new_seq_nbr      :' #new_seq_nbr
 show '$rev_out1         :' $rev_out1
 show '$rev_out2         :' $rev_out2
Begin-sql
  insert into PS_GEX_HIMRK_CURR 
    values($rev_agreement_id,
	   $rev_gex_rec_type,
           #new_seq_nbr,
           $rev_out1,
           $rev_out2)
end-sql
  add 1 to #total_recs
  if $rec_type = '100'
    add 1 to #total_100_recs
  end-if
end-procedure  


!**************************************************************************************************
!GEX ISDVNPK 06/15/2013 Commented the below as part of file format change from IFF to 834
!**************************************************************************************************
!*********************************************************************
!*********************************************************************
!begin-procedure select-from-curr
!#debug9 Show 'select-from-curr'
!begin-select
!CURR.GEX_REC_TYPE
!CURR.TEXT254
!CURR.DESCR254
!
!  let $field1 = &CURR.TEXT254
!  let $field2 = &CURR.DESCR254
!  do write-record
!from PS_GEX_HIMRK_CURR CURR
!order by agreement_id,seq_nbr,gex_rec_type
!end-select
!end-procedure

!*********************************************************************
! Write Record Information for High Mark File
!*********************************************************************
!begin-procedure Write-Record
!#debug9 Show 'write-record'
!write 1 from 
!  $field1:254
!  $field2:246
!end-procedure
!**************************************************************************************************
!GEX ISDVNPK 06/15/2013 Commented the above as part of file format change from IFF to 834
!**************************************************************************************************


!**************************************************************************************************
!GEX ISDVNPK 06/15/2013 Added the below as part of file format change from IFF to 834
!**************************************************************************************************
!*********************************************************************
begin-procedure select-from-curr
#debug9 Show 'select-from-curr'
begin-select Distinct
CURR.agreement_id
  let $834_agreement_id = &CURR.agreement_id
  do Write-Record
from PS_GEX_HIMRK_CURR CURR
order by CURR.agreement_id
end-select
end-procedure


!***********************************************************************
Begin-Procedure Write-Record
!***********************************************************************
  
     do select-834-curr-100-TM
     do select-834-from-curr-100-TM
     do Write-ISA-Member-Record
     do Write-REF-SSN-MEMBER-Record
     do Write-REF-23-MEMBER-Record
     do Write-REF-17-MEMBER-Record
     do Write-DTP-FileDate-Record
     do Write-DTP-HireDate-Record
     do Write-NM1-Record
     do Write-PER-Record
     do Write-N3-Record
     do Write-N4-Record
     do Write-DMG-Record
     do Write-HD-Record
     do Write-DTP-BeginDt-Record
     
     If ltrim($834_cvrgenddt,' ') <> '' 
      Let #Pos8=instr($834_cvrgenddt,'/',1)
      If #pos8 > 0
       let $file_end_dtop = Datetostr(StrtoDate($834_cvrgenddt,'MM/DD/YYYY'),'YYYYMMDD')
       do Write-DTP-EndDt-Record
      End-If    
     End-If    
     do Write-REF-GROUPNBR-Record
     do select-834-curr-100-Dep
	       			 
!***********************************************************************
End-Procedure Write-Record
!***********************************************************************

!*********************************************************************
begin-procedure select-834-curr-100-TM
#debug9 Show 'select-834-curr-100-TM'

   move '' to $834_seq

begin-select
HCUR.SEQ_NBR 

 move &HCUR.SEQ_NBR to $834_seq

from PS_GEX_HIMRK_CURR HCUR
where HCUR.agreement_id = $834_agreement_id
AND HCUR.GEX_REC_TYPE = '100'
AND HCUR.SEQ_NBR in ('10','15')
end-select
end-procedure


!*********************************************************************
begin-procedure select-834-from-curr-100-TM
#debug9 Show 'select-834-from-curr-100-TM'

   move ' ' to $834_ssn
   move '' to $834_tm_birthdate
   move '' to $834_hire_dt
   move ' ' to $834_group

begin-select
substr(TEXT254,1,9) &ssn,
substr(TEXT254,11,8) &Group_nbr,
substr(TEXT254,69,10) &BIRTHDATE,
substr(TEXT254,230,10) &HireDt

 move &ssn to $834_ssn
 move &BIRTHDATE to $834_tm_birthdate
 move &HireDt to $834_hire_dt
 move &Group_nbr to $834_group
 do get-tm-data
 ! do select-834-from-curr-130-TM
 do select-834-from-curr-135-TM

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '100'
AND SEQ_NBR = $834_seq
end-select
end-procedure

!***********************************************************************
begin-procedure get-tm-data
!***********************************************************************
#debug8 display 'get-tm-data'
     
  move '' to $834_name
  move '' to $834_last_name
  move '' to $834_FIRST_NAME
  move '' to $834_MIDDLE_NAME
  move '' to $834_suffix
  move '' to $834_phone
  move '' to $834_map_emplid
  move '' to $834_sex
  move '' to $834_address1
  move '' to $834_address2
  move '' to $834_city
  move '' to $834_state
  move '' to $834_postal
  move '' to $834_FULL_PART_TIME 
  move '' to $834_location
  move '' to $834_rehire_dt

begin-select ON-ERROR=SQL-Error-Found('Process-Active-Enrollments')
B.NAME,
B.LAST_NAME,
B.FIRST_NAME,
B.MIDDLE_NAME,
B.NAME_SUFFIX,
replace(replace(B.PHONE, '/', ''),'-','')  &b.phone
MAP.EMPLID,
B.SEX,
B.ADDRESS1,
B.ADDRESS2,
B.CITY,
B.STATE,
B.POSTAL,
C1.FULL_PART_TIME,
SUBSTR(C1.LOCATION,1,5)  &C1.LOCATION
TO_CHAR(EMPLM.REHIRE_DT,'MM/DD/YYYY')	&EMPLM.REHIRE_DT

  move &b.name to $834_name
  move &B.LAST_NAME to $834_last_name
  move &B.FIRST_NAME to $834_FIRST_NAME
  move &B.MIDDLE_NAME to $834_MIDDLE_NAME
  move &B.NAME_SUFFIX    to $834_suffix
  move &b.phone to $834_phone
  !move &map.emplid to $834_map_emplid !GEX_SEC_REENG 2015-04-29 Vahini Katta
  move &B.emplid to $834_map_emplid !GEX_SEC_REENG 2015-04-29 Vahini Katta
  move &B.SEX to $834_sex
  move &B.ADDRESS1 to $834_address1
  move &B.ADDRESS2 to $834_address2
  move &B.CITY to $834_city
  move &B.STATE to $834_state
  move &B.POSTAL to $834_postal
  move &C1.FULL_PART_TIME to $834_FULL_PART_TIME 
  move &C1.LOCATION to $834_location
  move &EMPLM.REHIRE_DT to $834_rehire_dt
  
!FROM  PS_JOB C1, PS_PERSONAL_DATA B, PS_GEX_EMPLID_MAPP MAP, PS_EMPLOYMENT EMPLM !GEX_SEC_REENG 2015-04-29 Vahini Katta
FROM  PS_JOB C1, PS_PERSONAL_DATA B,  PS_EMPLOYMENT EMPLM !GEX_SEC_REENG 2015-04-29 Vahini Katta
WHERE C1.EMPLID = B.EMPLID
AND C1.EFFDT = (SELECT MAX(EFFDT) FROM PS_JOB
		WHERE EMPLID = C1.EMPLID
		AND EMPL_RCD = C1.EMPL_RCD
		AND EFFDT <= $asofdate)
AND C1.EFFSEQ = (SELECT MAX(EFFSEQ) FROM PS_JOB
		WHERE EMPLID = C1.EMPLID
		AND EMPL_RCD = C1.EMPL_RCD
		AND EFFDT = C1.EFFDT)
AND C1.EMPLID = $834_ssn
			
End-Select
End-Procedure


!*********************************************************************
begin-procedure select-834-from-curr-130-TM
#debug9 Show 'select-834-from-curr-130-TM'

   move ' ' to $834_gex_div_cd

begin-select
substr(TEXT254,65,3) &gex_Div_cd

 move &gex_Div_cd to $834_gex_div_cd

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '130'
AND SEQ_NBR = $834_seq
end-select
end-procedure

!*********************************************************************
begin-procedure select-834-from-curr-135-TM
#debug9 Show 'select-834-from-curr-135-TM'

   move '' to $834_cvrgbgntdt
   move '' to $834_covrg_cd
   move '' to $834_cvrgenddt
    
begin-select
substr(TEXT254,56,10) &cvrgbgntdt
substr(TEXT254,69,3) &covrg_cd
substr(TEXT254,94,10) &cvrgenddt

 move &cvrgbgntdt to $834_cvrgbgntdt
 move &covrg_cd to $834_covrg_cd
 move &cvrgenddt to $834_cvrgenddt

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '135'
AND SEQ_NBR = $834_seq
end-select
end-procedure

!***********************************************************************
Begin-Procedure Write-ISA-Record
!***********************************************************************

  let $date_string = datetostr(datenow(),'YYMMDD')
  let $time_string = datetostr(datenow(),'HH24MI')
  let $outISA = 'ISA*00*          *00*          *30*250698270      *33*54771          *' || $date_string ||'*' || $time_string || '*{*00501*' || $seq_number || '*0*P*:'
  
  write 1 from $outISA
      	       			 
!***********************************************************************
End-Procedure Write-ISA-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-GS-Record
!***********************************************************************

  let $date_string1 = datetostr(datenow(),'YYYYMMDD')
  let $time_string1 = datetostr(datenow(),'HH24MISS')
  let $outGS = 'GS*BE*GIANTM*54771ECS*' || $date_string1 ||'*' || $time_string1 || '*' || $seq_number || '*X*005010X220A1' 
  
  write 1 from $outGS
      	       			 
!***********************************************************************
End-Procedure Write-GS-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-ST-Record
!***********************************************************************

  let $outST = 'ST*834*' || $seq_number1 || '*005010X220A1' 
  
  add 1 to #total_line_count
  write 1 from $outST
      	       			 
!***********************************************************************
End-Procedure Write-ST-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-BGN-Record
!***********************************************************************

  let $outBGN = 'BGN*00*' || $seq_number || '*' || $date_string1 ||'*' || $time_string1 || '*ET***RX' 
  
  add 1 to #total_line_count
  write 1 from $outBGN
      	       			 
!***********************************************************************
End-Procedure Write-BGN-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-N1-Record
!***********************************************************************

  let $outN1 = 'N1*P5*GIANTM*FI*250698270' 
  add 1 to #total_line_count
  write 1 from $outN1
      	       			 
!***********************************************************************
End-Procedure Write-N1-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-N1A-Record
!***********************************************************************

  let $outN1A = 'N1*IN*HIGHMARK*FI*231294723' 
  add 1 to #total_line_count
  write 1 from $outN1A
      	       			 
!***********************************************************************
End-Procedure Write-N1A-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-ISA-Member-Record
!***********************************************************************

  let $outISAMember = 'INS*Y*18*030*XN*A***' || $834_FULL_PART_TIME ||'T*N' 
  add 1 to #total_line_count
  write 1 from $outISAMember
      	       			 
!***********************************************************************
End-Procedure Write-ISA-Member-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-REF-SSN-MEMBER-Record
!***********************************************************************

  let $outREF-SSN = 'REF*0F*' || $834_ssn 
  add 1 to #total_line_count
  write 1 from $outREF-SSN
      	       			 
!***********************************************************************
End-Procedure Write-REF-SSN-MEMBER-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-REF-23-MEMBER-Record
!***********************************************************************

  let $outREF-23 = 'REF*23*' || $834_map_emplid ||'@gianteagle.com' 
  add 1 to #total_line_count
  write 1 from $outREF-23
      	       			 
!***********************************************************************
End-Procedure Write-REF-23-MEMBER-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-REF-17-MEMBER-Record
!***********************************************************************

  let $outREF-17 = 'REF*17*' || $834_location    ! $834_gex_div_cd 
  add 1 to #total_line_count
  write 1 from $outREF-17
      	       			 
!***********************************************************************
End-Procedure Write-REF-17-MEMBER-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DTP-FileDate-Record
!***********************************************************************

  let $outDTP-FileDate = 'DTP*303*D8*' || $date_string1 
  add 1 to #total_line_count
  write 1 from $outDTP-FileDate
      	       			 
!***********************************************************************
End-Procedure Write-DTP-FileDate-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DTP-HireDate-Record
!***********************************************************************
 
  If ltrim($834_hire_dt,' ') <> '' 
   Let #Pos6=instr($834_hire_dt,'/',1)
   If #pos6 > 0
    let $file_hiredt_dtop = Datetostr(StrtoDate($834_hire_dt,'MM/DD/YYYY'),'YYYYMMDD')
   End-if    
  else
  Let #Pos7=instr($834_rehire_dt,'/',1)
   If #pos7 > 0
    let $file_hiredt_dtop = Datetostr(StrtoDate($834_rehire_dt,'MM/DD/YYYY'),'YYYYMMDD')
   End-if
  End-if
  let $outDTP-HireDate = 'DTP*336*D8*' || $file_hiredt_dtop 
  add 1 to #total_line_count
  write 1 from $outDTP-HireDate
      	       			 
!***********************************************************************
End-Procedure Write-DTP-HireDate-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-NM1-Record
!***********************************************************************

  let $834_MIDDLE_NAME_out =''
  let $834_LAST_NAME = rtrim($834_LAST_NAME, ' ')
  let $834_FIRST_NAME = rtrim($834_FIRST_NAME, ' ')
 ! Do SPL-REMOVE ($834_FIRST_NAME, $834_FIRST_NAME_out)
  let $834_MIDDLE_NAME = rtrim($834_MIDDLE_NAME, ' ')
 ! Do SPL-REMOVE ($834_MIDDLE_NAME, $834_MIDDLE_NAME_out)
  let $834_SUFFIX = rtrim($834_SUFFIX, ' ')

  let $outNM1 = 'NM1*IL*1*' || $834_LAST_NAME  || '*' || $834_FIRST_NAME ||'*' || $834_MIDDLE_NAME ||'**' || $834_SUFFIX || '*34*' || $834_ssn 
  add 1 to #total_line_count
  write 1 from $outNM1
      	       			 
!***********************************************************************
End-Procedure Write-NM1-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-PER-Record
!***********************************************************************
 if ltrim($834_phone,' ') <> '' 
  let $outPER = 'PER*IP**HP*' || $834_phone 
  add 1 to #total_line_count
  write 1 from $outPER
 End-if
      	       			 
!***********************************************************************
End-Procedure Write-PER-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-N3-Record
!***********************************************************************
  let $834_address1 = rtrim($834_address1, ' ')
  let $834_address2 = rtrim($834_address2, ' ')
 
  if ltrim($834_address1,' ') <> '' 
   Do SPL-REMOVE ($834_address1, $834_address1_out)
  End-if

  let $834_address2_out = ''

  if ltrim($834_address2,' ') <> '' 
    Do SPL-REMOVE ($834_address2, $834_address2_out)
  End-if
   
  if ltrim($834_address2_out,' ') <> ''  
      let $outN3 = 'N3*' || $834_address1_out || '*' || $834_address2_out 
      add 1 to #total_line_count
      write 1 from $outN3
    else
     if ltrim($834_address1_out,' ') <> ''  
       let $outN3 = 'N3*' || $834_address1_out 
       add 1 to #total_line_count
       write 1 from $outN3
     end-if
  end-if  	       			 
!***********************************************************************
End-Procedure Write-N3-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-N4-Record
!***********************************************************************

  let $834_city = rtrim($834_city, ' ')
  let $834_state = rtrim($834_state, ' ')
  let $834_postal = rtrim($834_postal, ' ')
  let $834_city_out = ''
  let $834_postal_out = ''
  
  If ltrim($834_city,' ') <> '' 
   Do SPL-REMOVE ($834_city, $834_city_out)
  End-if
  
  If ltrim($834_postal,' ') <> ''
   Do SPL-REMOVE-1($834_postal, $834_postal_out)
  End-If
  
  if ltrim($834_city_out,' ') <> '' and ltrim($834_state,' ') <> '' 
    let $outN4 = 'N4*' || $834_city_out || '*' || $834_state || '*' || $834_postal_out 
    add 1 to #total_line_count
    write 1 from $outN4
  End-if
      	       			 
!***********************************************************************
End-Procedure Write-N4-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DMG-Record
!***********************************************************************
 Let #Pos5=instr($834_tm_birthdate,'/',1)
 If #pos5 > 0
  If ltrim($834_tm_birthdate,' ') <> '' 
   let $file_birthdt_dtop = Datetostr(StrtoDate($834_tm_birthdate,'MM/DD/YYYY'),'YYYYMMDD')
  End-If
 End-If
  let $outDMG = 'DMG*D8*' || $file_birthdt_dtop || '*' || $834_sex 
  add 1 to #total_line_count
  write 1 from $outDMG
      	       			 
!***********************************************************************
End-Procedure Write-DMG-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-HD-Record
!***********************************************************************
  
  let $outHD = 'HD*030**HLT**' || $834_covrg_cd
  add 1 to #total_line_count
  write 1 from $outHD
      	       			 
!***********************************************************************
End-Procedure Write-HD-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DTP-BeginDt-Record
!***********************************************************************
 Let #Pos4=instr($834_cvrgbgntdt,'/',1)
 If #pos4 > 0
  If ltrim($834_cvrgbgntdt,' ') <> '' 
   let $file_begin_dtop = Datetostr(StrtoDate($834_cvrgbgntdt,'MM/DD/YYYY'),'YYYYMMDD')
  End-If
 End-If

  let $outDTPBeginDt = 'DTP*348*D8*' || $file_begin_dtop 
  add 1 to #total_line_count
  write 1 from $outDTPBeginDt
      	       			 
!***********************************************************************
End-Procedure Write-DTP-BeginDt-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DTP-EndDt-Record
!***********************************************************************

  let $outDTPEndDt = 'DTP*349*D8*' || $file_end_dtop 
  add 1 to #total_line_count
  write 1 from $outDTPEndDt
      	       			 
!***********************************************************************
End-Procedure Write-DTP-EndDt-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-REF-GROUPNBR-Record
!***********************************************************************

  let $outREF-GROUPNBR = 'REF*1L*' || $834_group 
  add 1 to #total_line_count
  write 1 from $outREF-GROUPNBR
      	       			 
!***********************************************************************
End-Procedure Write-REF-GROUPNBR-Record
!***********************************************************************


!*********************************************************************
begin-procedure select-834-curr-100-Dep
#debug9 Show 'select-834-curr-100-Dep'

   move '' to $834_DEP_seq

begin-select
SEQ_NBR &SEQ_NBR1

 move &SEQ_NBR1 to $834_DEP_seq
 do select-834-from-curr-100-Dep

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '100'
AND SEQ_NBR <> $834_seq
end-select
end-procedure


!*********************************************************************
begin-procedure select-834-from-curr-100-Dep
#debug9 Show 'select-834-from-curr-100-Dep'

   move '' to $834_dep_ssn
   move '' to $834_dep_birthdate
   move '' to $834_dep_fname
   move '' to $834_dep_mname
   move '' to $834_dep_lname
   move '' to $834_dep_suffix
   move '' to $834_dep_sex
   move '' to $834_dep_relationcd

begin-select
substr(TEXT254,52,9) &dep_ssn,
substr(TEXT254,69,10) &dep_BIRTHDATE,
substr(TEXT254,79,25) &dep_fname,
substr(TEXT254,104,25) &dep_mname,
substr(TEXT254,129,35) &dep_lname,
substr(TEXT254,174,10) &dep_suffix,
substr(TEXT254,184,1) &dep_sex,
substr(TEXT254,192,2) &dep_relationcd,

   move &dep_ssn to $834_dep_ssn
   move &dep_BIRTHDATE to $834_dep_birthdate
   move &dep_fname to $834_dep_fname
   move &dep_mname to $834_dep_mname
   move &dep_lname to $834_dep_lname
   move &dep_suffix to $834_dep_suffix
   move &dep_sex to $834_dep_sex
   move &dep_relationcd to $834_dep_relationcd
   
 do select-834-from-curr-115-dep
 do select-834-from-curr-135-Dep
 If $834-from-curr-135-Dep-seq = 'N'
   move $834_DEP_seq to #834_DEP_seq 
   let  #834_DEP_seq =  #834_DEP_seq + 5
   do select-834-from-curr-135-Dep-Seq
 End-If
 do Write-DEP-Record

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '100'
AND SEQ_NBR = $834_DEP_seq
end-select
end-procedure


!*********************************************************************
begin-procedure select-834-from-curr-115-Dep
#debug9 Show 'select-834-from-curr-115-Dep'

   move 'N' to $834_dep_disabled

begin-select
'XY'

 move 'Y' to $834_dep_disabled

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '115'
AND SEQ_NBR = $834_DEP_seq
end-select
end-procedure

!*********************************************************************
begin-procedure select-834-from-curr-135-Dep
#debug9 Show 'select-834-from-curr-135-Dep'

   move '' to $834_dep_cvrgbgntdt
   move '' to $834_dep_covrg_cd
   move '' to $834_dep_cvrgenddt
   move 'N' to $834-from-curr-135-Dep-seq 
   
begin-select
substr(TEXT254,56,10) &dep_cvrgbgntdt
substr(TEXT254,69,3) &dep_covrg_cd
substr(TEXT254,94,10) &dep_cvrgenddt

 move 'Y' to $834-from-curr-135-Dep-seq 
 move &dep_cvrgbgntdt to $834_dep_cvrgbgntdt
 move &dep_covrg_cd to $834_dep_covrg_cd
 move &dep_cvrgenddt to $834_dep_cvrgenddt

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '135'
AND SEQ_NBR = $834_DEP_seq
end-select
end-procedure


!*********************************************************************
begin-procedure select-834-from-curr-135-Dep-seq
#debug9 Show 'select-834-from-curr-135-Dep-seq'

   move '' to $834_dep_cvrgbgntdt
   move '' to $834_dep_covrg_cd
   move '' to $834_dep_cvrgenddt
    
begin-select
substr(TEXT254,56,10) &dep_cvrgbgntdt_seq
substr(TEXT254,69,3) &dep_covrg_cd_seq
substr(TEXT254,94,10) &dep_cvrgenddt_seq

 move &dep_cvrgbgntdt_seq to $834_dep_cvrgbgntdt
 move &dep_covrg_cd_seq to $834_dep_covrg_cd
 move &dep_cvrgenddt_seq to $834_dep_cvrgenddt

from PS_GEX_HIMRK_CURR 
where agreement_id = $834_agreement_id
AND GEX_REC_TYPE = '135'
AND SEQ_NBR = #834_DEP_seq 
end-select
end-procedure

!***********************************************************************
Begin-Procedure Write-DEP-Record
!***********************************************************************
      
     do Write-ISA-Member-Record-Dep
     do Write-REF-SSN-MEMBER-Record-Dep
     do Write-NM1-Record-Dep
     do Write-DMG-Record-Dep
     do Write-HD-Record-Dep
     do Write-DTP-BeginDt-Record-Dep
     
      Let #Pos3=instr($834_dep_cvrgenddt,'/',1)
 
 If #pos3 > 0
     If ltrim($834_dep_cvrgenddt,' ') <> '' 
      let $file_end_dtop_dep = Datetostr(StrtoDate($834_dep_cvrgenddt,'MM/DD/YYYY'),'YYYYMMDD')
      do Write-DTP-EndDt-Record-Dep
     End-If   
  End-If    
     do Write-REF-GROUPNBR-Record-Dep
	       			 
!***********************************************************************
End-Procedure Write-DEP-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-ISA-Member-Record-Dep
!***********************************************************************

 if $834_dep_relationcd = '02' 
  let $834_dep_relationcd = '19'
 End-if
 if $834_dep_relationcd = '29' 
  let $834_dep_relationcd = '53'
 End-if
 
 If $834_dep_disabled = 'Y'
   let $outISAMember = 'INS*N*' || $834_dep_relationcd || '*030*XN*A****' || '*' || $834_dep_disabled 
  else 
   let $outISAMember = 'INS*N*' || $834_dep_relationcd || '*030*XN*A'
 End-if
  add 1 to #total_line_count
  write 1 from $outISAMember
      	       			 
!***********************************************************************
End-Procedure Write-ISA-Member-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-REF-SSN-MEMBER-Record-Dep
!***********************************************************************

  let $outREF-SSN = 'REF*0F*' || $834_ssn
  add 1 to #total_line_count
  write 1 from $outREF-SSN
      	       			 
!***********************************************************************
End-Procedure Write-REF-SSN-MEMBER-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-NM1-Record-Dep
!***********************************************************************
  let $834_dep_fname = rtrim($834_dep_fname, ' ')
  let $834_dep_mname = rtrim($834_dep_mname, ' ')
  let $834_dep_lname = rtrim($834_dep_lname, ' ')
  let $834_dep_suffix = rtrim($834_dep_suffix, ' ')
  If ltrim($834_dep_ssn,' ') <> '' 
    let $outNM1 = 'NM1*IL*1*' || $834_dep_lname  || '*' || $834_dep_fname ||'*' || $834_dep_mname ||'**' || $834_dep_suffix || '*34*' || $834_dep_ssn 
   else
    If ltrim($834_dep_suffix,' ') <> '' 
       let $outNM1 = 'NM1*IL*1*' || $834_dep_lname  || '*' || $834_dep_fname ||'*' || $834_dep_mname ||'**' || $834_dep_suffix 
      else
       If ltrim($834_dep_mname,' ') <> '' 
         let $outNM1 = 'NM1*IL*1*' || $834_dep_lname  || '*' || $834_dep_fname ||'*' || $834_dep_mname 
        else
         let $outNM1 = 'NM1*IL*1*' || $834_dep_lname  || '*' || $834_dep_fname 
       End-If
     End-If
  End-if
  add 1 to #total_line_count
  write 1 from $outNM1
      	       			 
!***********************************************************************
End-Procedure Write-NM1-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DMG-Record-Dep
!***********************************************************************

 Let #Pos=instr($834_dep_birthdate,'/',1)

  If #pos > 0
   let $file_birthdt_dtop_dep = Datetostr(StrtoDate($834_dep_birthdate,'MM/DD/YYYY'),'YYYYMMDD')
   End-if
  let $outDMG = 'DMG*D8*' || $file_birthdt_dtop_dep || '*' || $834_dep_sex 
  add 1 to #total_line_count
  write 1 from $outDMG
      	       			 
!***********************************************************************
End-Procedure Write-DMG-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-HD-Record-Dep
!***********************************************************************
  
  if $834_dep_covrg_cd='' or $834_dep_covrg_cd=' '
     let $outHD = 'HD*030**HLT' 
  else   
     let $outHD = 'HD*030**HLT**' || $834_dep_covrg_cd 
  end-if   
  add 1 to #total_line_count
  write 1 from $outHD
      	       			 
!***********************************************************************
End-Procedure Write-HD-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DTP-BeginDt-Record-Dep
!***********************************************************************

 Let #Pos1=instr($834_dep_cvrgbgntdt,'/',1)
 !show 'pos1' #Pos1
 If  #pos1 > 0
  let $file_begin_dtop_dep = Datetostr(StrtoDate($834_dep_cvrgbgntdt,'MM/DD/YYYY'),'YYYYMMDD')
 end-if
  let $outDTPBeginDt = 'DTP*348*D8*' || $file_begin_dtop_dep 
  add 1 to #total_line_count
  write 1 from $outDTPBeginDt
      	       			 
!***********************************************************************
End-Procedure Write-DTP-BeginDt-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-DTP-EndDt-Record-Dep
!***********************************************************************

  let $outDTPEndDt = 'DTP*349*D8*' || $file_end_dtop_dep 
  add 1 to #total_line_count
  write 1 from $outDTPEndDt
      	       			 
!***********************************************************************
End-Procedure Write-DTP-EndDt-Record-Dep
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-REF-GROUPNBR-Record-Dep
!***********************************************************************

  let $outREF-GROUPNBR = 'REF*1L*' || $834_group 
  add 1 to #total_line_count
  write 1 from $outREF-GROUPNBR
      	       			 
!***********************************************************************
End-Procedure Write-REF-GROUPNBR-Record-Dep
!***********************************************************************


!***********************************************************************
Begin-Procedure Write-SE-Trailer-Record
!***********************************************************************

   add 1 to #total_line_count
  Let $total_line_count = edit(#total_line_count,'0000000')
  let $total_line_count = ltrim($total_line_count, '0')
  let $outSE = 'SE*' || $total_line_count || '*' || $seq_number1 

  write 1 from $outSE
      	       			 
!***********************************************************************
End-Procedure Write-SE-Trailer-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-GE-Trailer-Record
!***********************************************************************

  let $outGE = 'GE*1*' || $seq_number 

  write 1 from $outGE
      	       			 
!***********************************************************************
End-Procedure Write-GE-Trailer-Record
!***********************************************************************

!***********************************************************************
Begin-Procedure Write-IEA-Trailer-Record
!***********************************************************************

  let $outIEA = 'IEA*1*' || $seq_number 

  write 1 from $outIEA
  Do Update-Seq-Number
      	       			 
!***********************************************************************
End-Procedure Write-IEA-Trailer-Record
!***********************************************************************


!***********************************************************************
begin-procedure Select-Seq-Number
!***********************************************************************
#debug9 Show 'Select-Seq-Number'

  let #seq_number = '100000001'
  let #seq_number1 = '999999999'

begin-select 
SEQ.SEQ_NBR
SEQ.SEQ_NBR1

  let #seq_number  = &SEQ.SEQ_NBR
  let #seq_number1 = &SEQ.SEQ_NBR1
  
from PS_GEX_ASSOCIAT_TM SEQ
   
end-select

!***********************************************************************
end-procedure Select-Seq-Number
!***********************************************************************

!***********************************************************************
Begin-Procedure Update-Seq-Number
!***********************************************************************
#debug9 Show  'Update-Seq-Number'

Begin-SQL
 Update PS_GEX_ASSOCIAT_TM
     Set SEQ_NBR = (SEQ_NBR +1), SEQ_NBR1 = (SEQ_NBR1 - 1)
       
End-SQL

!***********************************************************************
End-Procedure Update-Seq-Number
!***********************************************************************

!***********************************************************************
!Procedure for removing special characters from a string
!Here we use the ideology that we have a finite set of
!valid charecters (alpha numeric) while the set of special
!characters is fairly big
!***********************************************************************!
! Procedure : 	SPL-REMOVE
! Desc: Removes special charecters from the source strign - $srcstr.
!	The out put will be stored in the $outputstr
!	To use this procedure use: Do SPL-REMOVE($Source, $outputstr)
!***********************************************************************!
BEGIN-PROCEDURE SPL-REMOVE($srcstr, :$outputstr)
 
LET $valid_chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz 0123456789'
LET $invalid_chars = translate($srcstr, $valid_chars, '')
LET #invalid = length($invalid_chars)
 IF #invalid
  LET $outputstr = translate($srcstr, $invalid_chars, '')
ELSE
 LET $outputstr = $srcstr
END-IF
 
END-PROCEDURE
!***********************************************************************!

!***********************************************************************
!Procedure for removing special characters from a string
!Here we use the ideology that we have a finite set of
!valid charecters (numeric) while the set of special
!characters is fairly big
!***********************************************************************!
! Procedure : 	SPL-REMOVE-1
! Desc: Removes special charecters from the source strign - $srcstr.
!	The out put will be stored in the $outputstr
!	To use this procedure use: Do SPL-REMOVE-1($Source1, $outputstr1)
!***********************************************************************!
BEGIN-PROCEDURE SPL-REMOVE-1($srcstr1, :$outputstr1)
 
LET $valid_chars1 = '0123456789'
LET $invalid_chars1 = translate($srcstr1, $valid_chars1, '')
LET #invalid1 = length($invalid_chars1)
 IF #invalid1
  LET $outputstr1 = translate($srcstr1, $invalid_chars1, '')
ELSE
 LET $outputstr1 = $srcstr1
END-IF
 
END-PROCEDURE
!***********************************************************************!


!**************************************************************************************************
!GEX ISDVNPK 06/15/2013 Added the above as part of file format change from IFF to 834
!**************************************************************************************************


!*********************************************************************
! Open the file for writing              
!*********************************************************************
Begin-procedure Open-file
#debug9 Show 'open-file'

let $filename = '{OUTFILE}'||'gexbn620.dat'
open $filename as 1
     for-writing record=500

if #writestat != 0
   display 'Error Opening output file.  Program terminating.'
   stop
end-if

end-procedure

!*********************************************************************
! Close the file               
!*********************************************************************
Begin-procedure Close-file
#debug9 Show 'close-file'
  close 1
end-procedure

!*********************************************************************
!Displays the error messages and stops execution
!*********************************************************************
 
begin-procedure SQL-Error-Found($Proc_Name) 
!  do error-found
  show 'SQL Error in ' $Proc_Name 
  show '$_sql-error: ' $_sql-error
  show 'sql-status:  '  #_sql-status 

  STOP

end-procedure

begin-procedure create-trailer-rec
#debug9 Show 'create-trailer-rec'
  add 1 to #total_recs		
  move #total_recs to $total_recs 099999999
  move #total_100_recs to $total_100_recs 099999999
  let $agreement_nbr = '9999999990'
  let $rec_type = '900'
  let #seq_nbr = 0  
  let $sender_id = 'Giant Eagle '
  let $out1 = $40_spaces||$rec_type||$7_spaces||$total_recs||$9_spaces||
	$total_100_recs
  let $out1 = rpad($out1,254,' ')
  let $out2 = $246_spaces
  subtract 1 from #total_recs  
  do insert-rec
end-procedure

!########################################
begin-procedure display-variables
    show '########################################'
    show '$national_id: ' $national_id
    show '$emplid: ' $emplid
    show '$group_nbr: ' $group_nbr
    show '$contract_id: ' $contract_id
    show '$plan_type: ' $plan_type
    show '$save_benefit_plan: ' $save_benefit_plan
    show '$benefit_plan: ' $benefit_plan
    show '$first_name: ' $first_name
    show '$last_name: ' $last_name
    show '$p_fix: ' $p_fix
    show '$s_fix: ' $s_fix
    if $relation_cd = '20' 
      show '$sex: ' $sex
    else
      show '$Dep_sex: ' $Dep_sex
    end-if
    show '$marital_status: ' $marital_status
    show '$relation_cd: ' $relation_cd
    show '$subscriber: ' $subscriber
    if $subscriber = 'N'
      show '$dep_name: ' $dep_name
    end-if
    show '$covrg_cd: ' $covrg_cd
    show '$covrg_cat_cd: ' $covrg_cat_cd
    show '$agreement_nbr: ' $agreement_nbr
    show '$rec_type: ' $rec_type
    show 'seq_nbr: ' #seq_nbr
    show '$out1: ' $out1
    show '$out2: ' $out2
!    show '$hire_date: ' $hire_date
!    show '########################################'
end-procedure
!########################################
begin-procedure finalization
  show ' '
  move #no_elect_ctr to $no_elect_display 99,999
  show ' Nbr of EEs with coverage_elect not = E: ' $no_elect_display
  show ' '
  move #over_19_ctr to $over_19_display 99,999
  
  ! GEX ISDVNPK 12/05/2010 Commenetd below as part of OE11 changes
  !show ' Nbr of non-student, non-spouse dependents 19 or older: ' $over_19_display 
  show ' Nbr of dependents 26 or older: ' $over_19_display 
  ! GEX ISDVNPK 12/05/2010 Modified above as part of OE11 changes
  ! GEX ISDVNPK 12/05/2010 Commenetd below as part of OE11 changes
  !show ' '
 ! move #over_stud_age_ctr to $over_stud_age_display 99,999
 ! show ' Nbr of students over age limit: ' $over_stud_age_display 
!  move #stud_except_count to $stud_except_display 99,999
!  show ' Nbr of students using elig based on coverage begin date: ' $stud_except_display 
 ! show ' '
 ! move #under_stud_age_ctr to $under_stud_age_display 99,999
 ! show ' Nbr of deps coded as students, but under age 19: ' $under_stud_age_display 
  ! GEX ISDVNPK 12/05/2010 Commenetd above as part of OE11 changes
  show ' '
  move #cancelled_ctr to $cancelled_display 99,999
  show ' Nbr of employees and/or dependents cancelled: ' $cancelled_display 
  show ' '
  move #total_recs to $total_rec_display 99,999
  show ' Total records written to the file: ' $total_rec_display 
  show ' '
  date-time () MM/DD/YYYY &dayEnded
  date-time () hh:mi:ss &timeEnded

  show 'Report Ended on ' &dayEnded ' at ' &timeEnded
  do close-file
end-procedure


#include 'askaod.sqc'    !Ask as of date
#Include 'tranctrl.sqc'  !Common Transaction Control Procedures
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'stdapi.sqc'    !Update Process API
#Include 'datemath.sqc'  !Does the date-math functions
#Include 'getdatcd.sqc'  !Get-Date-Codes procedure
#Include 'getbalid.sqc'  !Get-Calendar-Year-Id
#Include 'rotname3.sqc'
#include 'gexxx920.sqc'  !Get ben single row run control
