!***********************************************************************
! Interface ID:   GBNI024 - Medco Eligibility                          *
! Interface Name: GEXBN603                                             *
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
! This module is the confidential and proprietary information of       *
! Giant Eagle, Inc.; it is not to be copied, reproduced, or transmitted*
! in any form, by any means, in whole or in part, nor is it to be used *
! for any purpose other than that for which it is expressly provided   *
! without the written permission of Giant Eagle.                       *
!                                                                      *
!***********************************************************************
! GEXBN603:     Medco Eligibility                                       *
!                                                                      *
! Narrative:    This program creates a cartridge file and report of    *
!               employees eligible for drugs for Medco.                *
!***********************************************************************
!                                                                      *
! SQL Tables:   PS_PERSONAL_DATA                                       *
!               PS_JOB                                                 *
!               PS_HEALTH_BENEFIT                                      *
!               PS_BENEF_PLAN_TBL                                      *
!               PS_DEPENDENT_BENEF                                     *
!               PS_HEALTH_DEPENDNT                                     *
!                                                                      *
! Written by:   Gene Davis                                             *
!                                                                      *
! Normally Run: Weekly                                                 *
!                                                                      *
!***********************************************************************
!                         MODIFICATION HISTORY                         *
!***********************************************************************
!  ID#         INITIALS    DATE           DESCRIPTION OF THE CHANGE    *
!***********************************************************************
!  GBNI024     GXD         09/03/1998     INITIAL CREATION             *
!              JDH         12/09/1998     Changed the payroll class    *
!                                          and coverage code mapping.  *
!              SXK         02/03/1999     Break by group and subtotals *
!              CWB         08/02/1999     Corrected the EFFDT logic in *
!                                           the select for EFFSEQ      *
!                                         Changed from EFFDT to        *
!                                           COVERAGE_BEGIN_DT IN       *
!                                           HEALTH_BENEFIT SELECT and  * 
!                                           on the report under EFFDT. *
!                                         Changed from first_of_month  *
!                                           to run_date.               * 
!              CJH         08/09/1999     Correct middle name and      *
!                                         middle initial from both     *
!                                         showing in intfc file.       *
!	       SXK         11/23/1999     Changed from zip to postal   *
!              CJH         12/13/2000     Fix mid initial code         *
!                                                                      *
!              AXL         01/03/2000     Re-visited max effdt logic   *
!                                         for PS_HEALTH_BENEFIT table  *
!                                                                      *  
!              CWB         06/20/2001     Corrected logic to use       *
!                                         $pay_end_dt instead of       *
!                                         $run_date so that EEs wouldn't
!                                         lose coverage too soon.      *
!                                                                      *
! HR-10807     CXA         11/09/2004     Send dependents on selected  *
!                                         groups only.                 *
!                                         Added Health_Benefit.Effdt+5 * 
!                                         day logic to the max effdt   *
!                                         lookup to keepemployees from *
!                                         losing coverage before they  *
!                                         should (effdt's are sync'd   *
!                                         every Sunday using           *
!                                         GEXBN805.SQR). Also put the  *
!                                         same logic in the dependent  *
!                                         lookup.                      *
!                                         Clear middle init variable   *
!                                                                      *
! HR-10843     CXA/AXL     01/05/2005     Do not send asterisks.       *
!                                         That was a one time reset of *
!                                         the middle initial field.    *
!                                                                      *
! HR-11051     NPK         08/28/2006     Changed the logic to use     *
!                                         COVERAGE_ELECT_DT instead of *
!                                         EFFDT                        *
!                                         Uncommented the Get-Dependent*
!                                         Procedure & included         *
!                                         Dependents & also added      *
!                                         procedure to print the report*
!                                                                      *
! HR-11078     NPK         10/14/2006     Reverted back to the EFFDT   *
!                                         logic instead of             *
!                                         COVERAGE_ELECT_DT as there   *
!                                         were employees missed        *
!                                         because of future termination*
!                                         of Health Benefit            *
!                                                                      *
! ITG 38644                                                            *
!  HR-11106    CWB         12/28/2006     Change record layout from    *
!                                         current 423 byte format to   *
!                                         1000 byte format.            *
!                                         Change Employee SSN to GE    * 
!                                         assigned 7-character EMPLID. *
!                                                                      * 
! GEX-CXB 		   10/05/2007     No table structure changed in 9.0.
!								       *
!              DXS         12/03/2007     Changed RELATIONSHIP conditions
!                                         in Print-Dependent-Record and*
!					  Write-Dependent-Record       * 
!	      GEX-TLL      04/23/2008     Upgrade 9.0 Changes          *
!	      Vendkxy 			  for running the code at the yearend
!             ISDVSXP      11-Dec-2009 for running annual file for open enrollment
! GEX ISDVNPK 12/25/2010 Modifed to add new Coverage Code for OE11 changes
! GEXBN_848_P143186_01 2013-11-12 Vahini Katta                         *
! Modifications need to be made to the MEDCO/ESI interface (GEXBN603) 
! so that Giant Eagle can report Highmark HDHP medical participantion on a weekly basis.  
!GEX_SEC_REENG 2015-04-29 Vahini Katta                                 *
!Changes related to gex_emplid_mapp/7 digit emplid
! Modifications by Surya Sobha to include only the Lcl 23 Benefit Programs
! which is NOT part of benefot Focus Pahse 1
! GEXBN_848_B01936766_01 2016-02-24 Vahini Katta                       *
! Remove R03 Benefit program
!***********************************************************************

#include 'setenv.sqc' !Set environment
#include 'setup02.sqc'

!*********************************************************************
!Initial processing, retrieving current dates and calls the main 
!procedure to do the processing.                                     
!*********************************************************************
begin-report

  do Init-DateTime
  do Init-Number
  do stdapi-init
  do Get-Calendar-Year-Id
  move 'GEXBN603' to $ReportID
  move 'Medco Eligibility' to $ReportTitle
  display ' '
  display $ReportTitle noline
  display '  ' noline

  do Get-Current-DateTime

  let #write_rec1 = 0
  let #write_rec2 = 0
  let $debug_flag = 'N'  !GEX-TLL  04/23/2008  Added
  do Report
  do Commit-Transaction
  date-time () hh:mi:ss_AM &timeEnded
  move &timeended to $time_done 
  let $time_ended = substr($time_done,1,8)||' '||substr($time_done,10,2) 
  display ' '
  display 'Report Ended: ' noline
  display $time_Ended
  do stdapi-term
end-report

!*********************************************************************
begin-procedure Report

date-time () hh:mi:ss_AM &timeBegan
  move &timebegan to $time_started
  let $time_began = substr($time_started,1,8)||' '||substr($time_started,10,2) 
  show ' '
  show 'Report Began: '  $time_Began
  show ' '
 move 'N' to $Errorfound

 date-time () MM/DD/YYYY &curr_date

 move &curr_date to $curr_date

  do Format-datetime($curr_date,$curr_Date_dbf_1,{DEFMDY},'','native')
  do Convert-To-DTU-Date($curr_Date_dbf_1,$curr_Date_1)

  let $curr_yy = substr($curr_Date_1,1,4)
  let $curr_mm = substr($curr_Date_1,6,2)
  let $curr_dd = substr($curr_Date_1,9,2)

  let $run_dt = $curr_yy||$curr_mm||$curr_dd
!****************************************************************
  let $curr_date_num = $run_dt
  date-time () HH:MI:SS_AM &curr_time_num
  move &curr_time_num to $curr_time
!  show ' '
!  show '$curr_time: ' $curr_time

  let $curr_hh = substr($curr_time,1,2)
  let $curr_mi = substr($curr_time,4,2)
  let $curr_ss = substr($curr_time,7,2)
  let $curr_am = substr($curr_time,10,2)
  move $curr_hh to #curr_hh 
  if $curr_am = 'PM'
    add 12 to #curr_hh
    let $curr_hh = edit(#curr_hh,'99') 
  end-if

  let $curr_time_num = $curr_hh||$curr_mi||$curr_ss||'00'

!  show '$curr_time_num ' $curr_time_num


!****************************************************************
  do Format-datetime($run_dt, $run_date, {DEFCMP},'','native')

 if $sev-error = 'Y'
    goto Report-exit
 end-if
 !GEXBN_848_P143186_01 Vahini Katta 12/02/2013 Begins
 Do GEXRCBN1-SELECT-PARAMETERS

 Let $AsOfDate = &GEX_RC_BEN.AsOfDate
 If Rtrim (&GEX_RC_BEN.AsOfDate, ' ') = ''
    do select-pay-end-dt
 else
    move $AsOfDate to $pay_end_dt  
 End-If
 show '$AsOfDate :' $AsOfDate
 !do select-pay-end-dt !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
 
 !let $pay_end_dt='03-jan-2009'  !VENDKXY for running the code at the yearend
 !let $pay_end_dt='01-Jan-2010'   !ISDVSXP 11-Dec-2009 for running annual file for open enrollment
 !let $pay_end_dt='01-Jan-2011'   ! GEX ISDVNPK 02-Dec-2010 for testing OE11 changes

 show  '$pay_end_dt: ' $pay_end_dt
 !GEXBN_848_P143186_01 Vahini Katta 12/02/2013 Ends
 
!***********************************************************************

 do init-vars 
 do open-file 
 do write-header 

!***********************************************************************

 do process-data

 do write-trailer 

 close 1

Report-Exit:


!  date-time () hh:mi:ss_AM &timeProcess
!  display ' '
!  display #InputTran 99999 noline
!  display ' Transactions Processed: ' noline
!  display &timeProcess

  show ' '
  move #tot_recs to $total_recs 999,999
  show $total_recs ' records were written to the file gexbn603.dat'

end-procedure

!*********************************************************************
!Prints the header information in the report.
!*********************************************************************

begin-heading 8

  #Include 'stdhdg01.sqc'

  print 'PYRL'             (+2,144)
  print 'COVRG'             (0,151)
  print 'BENEFIT'           (0,168)

  print 'GROUP_NBR'             (+1,1)
  print 'EMPLID'             (0,12)
  print 'PERSON#'            (0,20)
  print 'NAME'               (0,29)
  print 'ADDRESS1'           (0,51)
  print 'CITY'               (0,73)
  print 'STATE'              (0,89)
  print 'ZIP'                (0,99)
  print 'ADDRESS2'          (0,104)
  print 'RELATION'          (0,118)
  print 'BIRTHDATE'         (0,128)
  print 'SEX'               (0,139)
  print 'CLASS'             (0,144)
  print 'CODE'              (0,152)
  print 'EFFDT'             (0,161)
  print 'PLAN'              (0,168)

  print '-'               (+1,1,174) FILL

end-heading

!*********************************************************************
! Select all valid Employee Types for a specific company
!*********************************************************************

begin-procedure process-data

!display 'Begin process'


move 'N' to $rowfound
let $end_process = 'N'
let #inputtran = 0

begin-select ON-ERROR=SQL-Error-Found('Process-data')
BP.GROUP_NBR
   if &BP.GROUP_NBR <> $group and #inputtran <> 0
      do group-change
   end-if
   move &BP.GROUP_NBR           to $group

PD.EMPLID  
   move &PD.EMPLID           to $emplid
   move $emplid              to $pd_emplid 

HB.EMPL_RCD
   move &HB.EMPL_RCD        to #empl_rcd

PD.NAME
   move &PD.NAME             to $name

PD.FIRST_NAME_SRCH
   move &PD.FIRST_NAME_SRCH  to $first_name
   
PD.LAST_NAME_SRCH
   move &PD.LAST_NAME_SRCH   to $last_name

PD.ADDRESS1
   move &PD.ADDRESS1         to $address1
PD.CITY
   move &PD.CITY             to $city
PD.STATE
   move &PD.STATE            to $state
!SXK 11/23/99 Changed from zip to postal
PD.POSTAL 
   move &PD.POSTAL           to $zip
PD.ADDRESS2
   move &PD.ADDRESS2         to $address2        ! #address2  !NPK 09/06/2006 Commented & Fixed this
PD.BIRTHDATE
   move &PD.BIRTHDATE        to $birthdate
PD.SEX
   move &PD.SEX              to $sex
PD.PHONE
   let $phone_nbr = substr(&pd.phone,1,3)||substr(&pd.phone,5,3)||substr(&pd.phone,9,4) 
JB.FULL_PART_TIME
   move &JB.FULL_PART_TIME   to $full_part_time
JB.EMPL_TYPE
   move &JB.EMPL_TYPE        to $empl_type
JB.EMPL_STATUS
   move &jb.empl_status      to $empl_status
HB.COVRG_CD
HB.EFFDT
HB.COVERAGE_BEGIN_DT
HB.BENEFIT_PLAN
HB.COVERAGE_ELECT 
HB.PLAN_TYPE   !GEX-TLL 04/23/2008 Added
!*********************************************************************
  !do get-gex-mapp-emplid !GEX_SEC_REENG 2015-04-29 Vahini Katta
  do get-emp-ssn
!*********************************************************************
       let $prt_emplid = &pd.emplid||'1616'  !GEX_SEC_REENG 2015-04-29 Vahini Katta   
       let $gex_emplid = $prt_emplid                           
       move &HB.COVRG_CD          to $covrg_cd
       move &HB.EFFDT             to $hb_effdt
       move &HB.COVERAGE_BEGIN_DT to $hb_coverage_begin_dt
       move &HB.BENEFIT_PLAN      to $benefit_plan
       move &HB.COVERAGE_ELECT    to $coverage_elct
       move &HB.PLAN_TYPE         to $plan_type   !GEX-TLL 04/23/2008 Added
   
  Do Check-Plan-18    !GEX-TLL 04/23/2008 Added
  
  show '&PD.EMPLID    :' &PD.EMPLID
  show '&HB.PLAN_TYPE :' &HB.PLAN_TYPE
  show '&BP.GROUP_NBR :' &BP.GROUP_NBR
  
  show '$plan_type_18 :' $plan_type_18

  if $empl_type = 'H'
     let $fp_time = '1'
  else
     let $fp_time = '2'
  end-if
 IF  $Row_found = 'N'  !GEX-TLL 04/23/2008 Added
  evaluate $covrg_cd	
     when = '1'
	break
     when = '2'
     !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
     when = '8'
     when = '9'
     !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes

        let $covrg_cd = '4'  
	break
     when = '3'
     !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
     when = '10'
     when = '11'
     when = '13'
     when = '15'
     !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
           let $covrg_cd = '3'  
        break
     when = '4'
     !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
     when = '16'
     when = '17'
     when = '18'
     when = '19'
     when = '20'
     when = '21'
     when = '22'
     when = '23'
     !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
        !let $covrg_cd = '2'  !NPK 09/06/2006 Commented & changed this
        let $covrg_cd = '6'
	break
     when-other
        let $covrg_cd = '2'
	break
  end-evaluate
!GEX-TLL 04/23/2008 Added - Begin
 else
         
      if $covrg_cd =  '1'   and ($covrg_cd_18 = '5' or $covrg_cd_18 = '24' or $covrg_cd_18 = '25')      !GEX ISDVNPK 12/25/2010 Added the new Coverage Code for OE11 changes
                  ! show 'in  when = 1 and 5  '  $covrg_cd    '/' $covrg_cd_18      
                   let $covrg_cd = '4'  
                    ! show '$covrg_cd = '  $covrg_cd
     end-if
           
     if $covrg_cd =  '1'   and ($covrg_cd_18 = '6' or $covrg_cd_18 = '26' or $covrg_cd_18 = '27'
                      or $covrg_cd_18 = '28' or $covrg_cd_18 = '29')      !GEX ISDVNPK 12/25/2010 Added the new Coverage Code for OE11 changes
          ! show 'in  when = 1 and 6 '   $covrg_cd    '/' $covrg_cd_18         
           let $covrg_cd = '3'  
          ! show '$covrg_cd = '  $covrg_cd
     end-if
	
      if $covrg_cd =  '1'   and ($covrg_cd_18 =  '7' or $covrg_cd_18 = '30' or $covrg_cd_18 = '31'
    or $covrg_cd_18 = '32' or $covrg_cd_18 = '33'    or $covrg_cd_18 = '34' or $covrg_cd_18 = '35'  or $covrg_cd_18 = '36' or $covrg_cd_18 = '37')      !GEX ISDVNPK 12/25/2010 Added the new Coverage Code for OE11 changes
            ! show 'in  when = 1 and 7 '   $covrg_cd    '/' $covrg_cd_18          
            let $covrg_cd = '6'  
            ! show '$covrg_cd = '  $covrg_cd
      end-if
	  
	  !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
      if ($covrg_cd =  '3'  or $covrg_cd =  '10'  or $covrg_cd =  '11' or $covrg_cd =  '13'  or $covrg_cd =  '15') 
    !GEX ISDVNPK 12/25/2010 Added the below new Coverage Code for OE11 changes
       
       If ($covrg_cd_18 = '5' or $covrg_cd_18 = '24' or $covrg_cd_18 = '25')      !GEX ISDVNPK 12/25/2010 Added the new Coverage Code for OE11 changes
             !  show 'in  when =3 and 5 '   $covrg_cd    '/' $covrg_cd_18         
               let $covrg_cd = '6' 
              ! show '$covrg_cd = '  $covrg_cd 
      end-if
	   
     ! if $covrg_cd =  '3'   and 
     If ($covrg_cd_18 = '6' or $covrg_cd_18 = '26' or $covrg_cd_18 = '27'
                      or $covrg_cd_18 = '28' or $covrg_cd_18 = '29')      !GEX ISDVNPK 12/25/2010 Added the new Coverage Code for OE11 changes
                   !  show 'in  when = 3 and 6 '  $covrg_cd    '/' $covrg_cd_18       
                     let $covrg_cd = '3'  
                   !  show '$covrg_cd = '  $covrg_cd
      end-if
	       
      ! if $covrg_cd =  '3'   and 
      If ($covrg_cd_18 =  '7' or $covrg_cd_18 = '30' or $covrg_cd_18 = '31'
       or $covrg_cd_18 = '32' or $covrg_cd_18 = '33'    or $covrg_cd_18 = '34' or $covrg_cd_18 = '35'  or $covrg_cd_18 = '36' or $covrg_cd_18 = '37')      !GEX ISDVNPK 12/25/2010 Added the new Coverage Code for OE11 changes
                     ! show 'in  when = 3 and 7 '   $covrg_cd    '/' $covrg_cd_18 
                      let $covrg_cd = '6'  
                     ! show '$covrg_cd = '  $covrg_cd
       end-if
     end-if
    end-if  
   
  if $coverage_elct = 'E'   
    Do Print-Record
    Do Write-Record
    !GEXBN_848_P143186_01 Vahini Katta 12/02/2013 Begins
    !if $plan_type = '1Z'  
    
    if $plan_type = '1Z' or $plan_type='10'  
       show 'Get-Dependent'
       Move $plan_type to $dep_plan_type 
       Do Get-Dependent 
    end-if
  
    if $plan_type_18 = '18' or $plan_type_18 = '15'
       Move $plan_type_18 to $dep_plan_type 
       Move $hb_effdt_18 to $hb_effdt
       Do Get-Dependent	     
    end-if 
    
    !GEXBN_848_P143186_01 Vahini Katta 12/02/2013 Ends
    move 'Y' to $rowfound
    add 1 to #inputtran
  end-if

FROM PS_JOB JB,
     PS_PERSONAL_DATA PD,
     PS_HEALTH_BENEFIT HB,
     PS_BENEF_PLAN_TBL BP,
     PS_BEN_PROG_PARTIC BN  !added by Surya Sobha to include the Ben Programs for lcl 23
WHERE JB.EMPLID       = PD.EMPLID
AND   JB.EMPLID       = HB.EMPLID
AND   JB.EMPL_RCD    = HB.EMPL_RCD
!AND   HB.PLAN_TYPE    = '1Z'     !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND  (HB.PLAN_TYPE = '1Z' OR (HB.PLAN_TYPE = '10' AND BP.GROUP_NBR IN ('12144-31','12144-37'))) !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND   HB.PLAN_TYPE    = BP.PLAN_TYPE
AND   HB.BENEFIT_PLAN = BP.BENEFIT_PLAN
AND   JB.EFFDT = (SELECT MAX(EFFDT)
		  FROM PS_JOB
		  WHERE EMPLID    = JB.EMPLID
		  AND   EMPL_RCD = JB.EMPL_RCD
		  AND   EFFDT    <= $pay_end_dt)
AND   JB.EFFSEQ = (SELECT MAX(EFFSEQ)
		   FROM PS_JOB
		   WHERE EMPLID    = JB.EMPLID
		   AND   EMPL_RCD = JB.EMPL_RCD
		   AND   EFFDT    = JB.EFFDT)
AND   HB.EFFDT =  (SELECT MAX(EFFDT) 
                   FROM PS_HEALTH_BENEFIT
                   WHERE HB.EMPLID = EMPLID
                   AND HB.EMPL_RCD = EMPL_RCD
                   AND HB.COBRA_EVENT_ID = COBRA_EVENT_ID
                   AND HB.PLAN_TYPE = PLAN_TYPE
                   AND HB.BENEFIT_NBR = BENEFIT_NBR
		  AND   EFFDT    <= $pay_end_dt)   !NPK 10/14/2006 uncommented out this and reverted back !NPK 08/28/2006 Commented out this & changed it to COverage Elect Dt
AND   BP.EFFDT =  (SELECT MAX(EFFDT)
                   FROM PS_BENEF_PLAN_TBL
                   WHERE BP.PLAN_TYPE = PLAN_TYPE
                   AND BP.BENEFIT_PLAN = BENEFIT_PLAN
                   AND EFFDT <= HB.EFFDT)
!added by Surya Sobha to include the Ben Programs for lcl 23
AND BN.EMPLID = HB.EMPLID
AND BN.EMPL_RCD = HB.EMPL_RCD
AND BN.COBRA_EVENT_ID = HB.COBRA_EVENT_ID
AND BN.EFFDT =  (SELECT MAX (BN1.EFFDT)
                 FROM PS_BEN_PROG_PARTIC BN1
                 WHERE BN1.EMPLID = BN.EMPLID
                 AND BN1.EMPL_RCD = BN.EMPL_RCD
                 AND BN1.EFFDT <= $pay_end_dt)
!AND BN.BENEFIT_PROGRAM  IN ('G01','G02','G03','G04','G05','G06','G07','G08','G09','R01','R03','R04','R06')
AND BN.BENEFIT_PROGRAM  IN ('G01','G02','G03','G04','G05','G06','G07','G08','G09','R01','R04','R06') !GEXBN_848_B01936766_01 2016-02-24 Vahini Katta
!added by Surya Sobha to include the Ben Programs for lcl 23
ORDER BY BP.GROUP_NBR, JB.EMPLID

end-select

if $rowfound = 'N'
   display 'No Employees found for the Medco Eligibility File.' 
else

   
   move #write_rec1 to $rec1  999,999
   move #write_rec2 to $rec2  999,999

   display 'Employee Records:  ' noline
   display $rec1
   display 'Dependent Records: ' noline
   display $rec2
   let $end_process = 'Y'
   do group-change   
   print 'Total Employees processed:  '  (+2,29)
   print $rec1                                ()
   print 'Total Dependents processed: '  (+2,29)
   print $rec2                                ()

end-if

end-procedure
!GEX-TLL 04/23/2008 Added - Begin
!*********************************************************************
!***********************************************************************
! HR-48049    MXR          03/20/2008     Modifications to include     *
! *************************************** Domestic Partner             *
begin-procedure Check-Plan-18
  let $Row_found = 'N'
  Move ' ' to $plan_type_18
  Move '' to $hb_effdt_18
begin-select
HB1.COVRG_CD,
HB1.EFFDT,
HB1.COVERAGE_BEGIN_DT,
HB1.BENEFIT_PLAN,
HB1.COVERAGE_ELECT,
HB1.PLAN_TYPE,
BP1.EFFDT

   let $Row_found = 'Y'
   
       move &HB1.COVRG_CD to $covrg_cd_18
       move &HB1.PLAN_TYPE to $plan_type_18
   
     !  move &HB1.COVRG_CD          to $covrg_cd
       move &HB1.EFFDT             to $hb_effdt_18
       move &HB1.COVERAGE_BEGIN_DT to $hb_coverage_begin_dt_18
       move &HB1.BENEFIT_PLAN      to $benefit_plan
       move &HB1.COVERAGE_ELECT    to $coverage_elct
   
     move  &HB1.EFFDT to $hb_effdt_18
     

FROM PS_HEALTH_BENEFIT HB1,
     PS_BENEF_PLAN_TBL BP1
WHERE  HB1.EMPLID =  $emplid                                  
!AND   HB1.PLAN_TYPE   ='18' !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND HB1.PLAN_TYPE in ('18','15') !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND   HB1.COVERAGE_ELECT = 'E'
AND   HB1.PLAN_TYPE    = BP1.PLAN_TYPE
AND   HB1.BENEFIT_PLAN = BP1.BENEFIT_PLAN
AND   HB1.EFFDT =  (SELECT MAX(EFFDT) 
                   FROM PS_HEALTH_BENEFIT
                   WHERE HB1.EMPLID = EMPLID
                   AND HB1.EMPL_RCD = EMPL_RCD
                   AND HB1.COBRA_EVENT_ID = COBRA_EVENT_ID
                   AND HB1.PLAN_TYPE = PLAN_TYPE
                   AND HB1.BENEFIT_NBR = BENEFIT_NBR
  		   AND   EFFDT    <= $pay_end_dt) 
AND   BP1.EFFDT =  (SELECT MAX(EFFDT)
                   FROM PS_BENEF_PLAN_TBL
                   WHERE BP1.PLAN_TYPE  =PLAN_TYPE
                   AND BP1.BENEFIT_PLAN =BENEFIT_PLAN)
                  ! AND BP1.EFFDT <= HB1.EFFDT)
ORDER BY  BP1.GROUP_NBR,  HB1.PLAN_TYPE

end-select
end-procedure
!GEX-TLL 04/23/2008 Added - End

!**********************************************************************
!FROM ITG 38644  12/2006 - CWB ***************************************
!*********************************************************************
begin-procedure get-gex-mapp-emplid
begin-select
gm.emplid &gm.emplid
  let $prt_emplid = &gm.emplid||'1616'      ! PHASE 2
!  let $prt_emplid = $pd_emplid               ! PHASE 1
  let $gex_emplid = $prt_emplid                                

from ps_gex_emplid_mapp gm
where gm.ssn = $pd_emplid
end-select
end-procedure

begin-procedure get-emp-ssn
begin-select
pn.national_id
  let $ssn = substr(&pn.national_id,1,9)
from PS_PERS_NID PN
where pn.emplid = $pd_emplid
and pn.primary_nid = 'Y'
end-select
end-procedure

!*********************************************************************

!*********************************************************************
!*********************************************************************
! Print Record for Medco Eligibility Report
!*********************************************************************
begin-procedure Print-Record

  if #current-line > 51
     new-page
  end-if

  let $print_name = substr($name,1,21)
  let $print_address1 = substr($address1,1,20)
  let $print_address2 = substr($address2,1,16)
  let $print_city = substr($city,1,15)
  let $print_zip = substr($zip,1,5)

  Do Convert-to-dtu-date($birthdate,$bdt)
  let $bd_yy = substr($bdt,3,2)
  let $bd_mm = substr($bdt,6,2)
  let $bd_dd = substr($bdt,9,2)
  let $bday = $bd_mm||'/'||$bd_dd||'/'||$bd_yy

  Do Convert-to-dtu-date($hb_effdt,$hbd)
  let $hb_yy = substr($hbd,3,2)
  let $hb_mm = substr($hbd,6,2)
  let $hb_dd = substr($hbd,9,2)
  let $ben_effdt = $hb_mm||'/'||$hb_dd||'/'||$hb_yy
!GEX-TLL 04/23/2008 HCM 9.0 Upgrade Changes - Begin
  LET $datflg ='N'
    
 if strtodate($hb_coverage_begin_dt) < strtodate($hb_coverage_begin_dt_18)
      let $datflg ='Y'
      LET  $hb_coverage_begin_dt = $hb_coverage_begin_dt_18
      ELSE 
      LET $hb_coverage_begin_dt = $hb_coverage_begin_dt
 END-IF
!GEX-TLL 04/23/2008 HCM 9.0 Upgrade Changes - End

  Do Convert-to-dtu-date($hb_coverage_begin_dt,$hbd)
  let $hb_cc = substr($hbd,1,2)
  let $hb_yy = substr($hbd,3,2)
  let $hb_mm = substr($hbd,6,2)
  let $hb_dd = substr($hbd,9,2)
  let $ben_begin_dt = $hb_mm||'/'||$hb_dd||'/'||$hb_yy
  let $elig_effdt = $hb_cc||$hb_yy||$hb_mm||$hb_dd


  let $hb_coverage_begin_dt = ''     !GEX-TLL 04/23/2008 Added
  let $hb_coverage_begin_dt_18 =''   !GEX-TLL 04/23/2008 Added

!  Do Format-Number(#empl_rcd, $empl_rcd,'9')

  print $group               (+1,2)
  print $prt_emplid          (0,09)    ! CWB 12/2006

  print '001'                 (0,24)
  print $print_name          (0,29)
  print $print_address1      (0,51)
  print $print_city          (0,73)
  print $state               (0,92)
  print $print_zip           (0,97)
  print $print_address2     (0,104,15)
  print '1'                (0,124)           !NPK 09/06/2006 Commented & changed this
  print $bday               (0,129)
  print $sex                (0,141)
  print $fp_time            (0,148)
  print $covrg_cd           (0,155)
  print $ben_begin_dt       (0,158)
  print $benefit_plan       (0,168)

  add 1 to #group_count

end-procedure

begin-procedure group-change

print 'TOTALS FOR GROUP '         (+2,1)
print $group                      ()
print #group_count   (0,+2) edit 999,999

move 0 to #group_count
if $end_process = 'N'
   new-page
end-if

end-procedure

!*********************************************************************

!*********************************************************************
!FROM ITG 38644  12/2006 - CWB ***************************************

!*********************************************************************
! Initialize certain variables  for Medco Eligibility File
!*********************************************************************

begin-procedure init-vars
  move 0 to #tot_recs
  let $rec_length = '01000'
  let $block_size = '10000'
  let $contact_person = ' '
  let $contact_phone = ' ' 
  let $process_mode =  'P'
  let $ver_nbr = '02'
  let $rel_nbr = '03'
  let $upd_type = 'P'
  let $txn_cd = 'P'
  let $reserved_1 = ' '
  let $reserved_2 = '  '
  let $reserved_4 = '    '
  let $reserved_8 = '        '
  let $reserved_15 = '               '
  let $cust_id = '1616'
  let $cust_name = 'G EAGLE '
  let $job_name  = 'ENROLLMT'
  let $contact_person = 'GE HELP CENTER  '
  let $contact_phone = '4129672543'
  let $person_num = '001'
  let $status = 'A'

end-procedure

!*********************************************************************
! Open file for writing
!*********************************************************************

begin-procedure open-file

let $filename = '{OUTFILE}'||'gexbn603.dat'  
!let $filename = '//apps/hr/hrms90/hrdev90/outgoing/'||'gexbn603.dat'   !GEX-TLL  testing
open $filename as 1
     for-writing record=1000       

if #writestat != 0
   display 'Error Opening output file.  Program terminating.'
   stop
end-if

end-procedure

!*********************************************************************
! Write Header Record  for Medco Eligibility File
!*********************************************************************
begin-procedure Write-header

        let $rec_type = 'H' 
        add 1 to #tot_recs

	write 1 from 	$rec_type:1
             		$cust_id:4
			$cust_name:8
			$job_name:8
			$Rec_length:5
			$block_size:5
			$curr_date_num:8
			$curr_time_num:8
			$contact_person:16
			$contact_phone:10
			$process_mode:1
                        ' ':2
			$ver_nbr:2
			$rel_nbr:2
			$upd_type:1
			$gen_term_dt:8
			$trans_nbr:5
			' ':906
end-procedure
!*********************************************************************

!*********************************************************************
!FROM ITG 38644  12/2006 - CWB ****************************************
!*********************************************************************
! Write Trailer Record  for Medco Eligibliity File
!*********************************************************************
begin-procedure Write-trailer
        let $rec_type = 'T' 
        add 1 to #tot_recs
        move #tot_recs to $tot_recs 099999999 
	write 1 from 	$rec_type:1
             		$cust_id:4
			$cust_name:8
			$job_name:8
			$Rec_length:5
			$block_size:5
			$curr_date_num:8
			$curr_time_num:8
			$contact_person:16
			$contact_phone:10
			$tot_recs:9
			' ':918

end-procedure
!*********************************************************************

!*********************************************************************
! Write Record Information for Medco Eligibility File
!*********************************************************************
begin-procedure Write-Record

  add 1 to #write_rec1

  let $groupno = 'GEP0'||$group
!  let $alt_groupno = 'GEP0'||$group
  let $alt_groupno = ' '
!  let $alt_id_cd = 'T'
  let $alt_id_cd = ' '
!  let $alt_id_num =  $pd_emplid
  let $alt_id_num =  ' '
!  let $alt_person_cd = $person_num 
  let $alt_person_cd = ' ' 

  let $mid_init = ' '
  let $MidInitial = ' '

  let $Name = rtrim($name,' ')

  Do Rotate-Name
  let $last_name = substr($Last_Name,1,24)
  unstring $name by ' ' into $first_name_1 $mname
  let $first_name = upper(substr($first_name_1,1,15))
  let $mid_init = $MidInitial


!**
  let $address1 = substr($address1,1,24)
  let $city = substr($city,1,26)
  let $state = substr($state,1,2)
!**

!**
  let $address2 = substr($address2,1,24)
!**
  Do Convert-to-dtu-date($birthdate,$bdate)

!  CWB  ITG38644 12/2006   
!  Field expanded to 8 chars. No longer neccessary to manipulate the century.

!  let $b_cc = substr($bdate,1,2)
  let $b_yy = substr($bdate,1,4)
  let $b_mm = substr($bdate,6,2)
  let $b_dd = substr($bdate,9,2)

  let $birth_dt = $b_yy||$b_mm||$b_dd

!**

  Do Convert-to-dtu-date($hb_coverage_begin_dt,$hbdate)
  let $h_cc = substr($hbdate,1,2)
  let $h_yy = substr($hbdate,3,2)
  let $h_mm = substr($hbdate,6,2)
  let $h_dd = substr($hbdate,9,2)

  evaluate $h_cc
     when = '18'
	let $cch = '0'
	break
     when = '19'
	let $cch = '1'
	break
     when = '20'
	let $cch = '2'
	break
     when-other
	let $cch = ' '
	break
  end-evaluate

  let $hb_dt = $cch||$h_yy||$h_mm||$h_dd

!  display 'Employee:  ' noline
!  display $groupno noline
!  display ' ' noline
!  display $emplid

 if $sex = 'M'
    let $sex_1 = 'M'
 else
 if $sex = 'F'
    let $sex_1 = 'F'
 else
    let $sex_1 = 'U'
 end-if
 end-if
 !GEX-TLL 04/23/2008 Added - Begin
 
 Let $groupno=translate($groupno,'-','') !GEXBN_848_P143186_01 2013-11-12 Vahini Katta
 
 if $debug_flag = 'Y'
show    '   $rec_type:1                 '  $rec_type 
show    '   $groupno:15                 '  $groupno
show    '   $gex_emplid:18              '  $gex_emplid
show    '   $person_num:3               '  $person_num
show    '   $txn_seq:2	                '  $txn_seq 
show    '   $txn_dt:8                   '  $txn_dt 
show    '   $txn_cd:1                   '  $txn_cd 
show    '   $ben_grp_num:15             '  $ben_grp_num 
show    '   $elig_effdt:8               '  $elig_effdt 
show    '   $elig_term_dt:8             '  $elig_term_dt 
show    '   $reserved_8:8               '  $reserved_8 
show    '   $reserved_8:8               '  $reserved_8 
show    '   $reserved_8:8               '  $reserved_8 
show    '   $reserved_8:8               '  $reserved_8 
show    '   $relation:1                 '  $relation 
show    '   $last_name:25               '  $last_name 
show    '   $first_name:15              '  $last_name 
show    '   $mid_init:1                 '  $mid_init 
show    '   $title:4                    '  $title 
show    '   $name_ext:6                 '  $name_ext 
show    '   $birth_dt:8                 '  $birth_dt 
show    '   $mult_birth:1               '  $mult_birth 
show    '   $sex_1:1                    '  $sex_1 
show    '   $SSN:11                     '  $SSN 
show    '   $alt_groupno:15             '  $alt_groupno 
show    '   $alt_id_cd:1                '  $alt_id_cd 
show    '   $alt_id_num:18              '  $alt_id_num 
show    '   $alt_person_cd:3            '  $alt_person_cd 
show    '   $address1:30                '  $address1 
show    '   $address2:30                '  $address2 
show    '   $address3:30                '  $address3 
show    '   $city:26                    '  $city 
show    '   $state:2                    '  $state 
show    '   $zip:9                      '  $zip 
show    '                               '   
show    '   ' ':5                       '   
show    '                               '   
show    '   ' ':7                       '   
show    '                               '   
show    '   ' ':4                       '   
show    '   $phone_nbr:10               '  $phone_nbr 
show    '   $COB_ind:1                  '  $COB_ind 
show    '   $COB_effdt:8                '  $COB_effdt 
show    '   $medicare_term_dt:6         '  $medicare_term_dt 
show    '   $primary_care_type:3        '  $primary_care_type 
show    '   $primary_care_id:18         '  $primary_care_id 
show    '   $primary_care_effdt:8       '  $primary_care_effdt 
show    '   $primary_care_term_dt:8     '  $primary_care_term_dt 
show    '                               '   
show    '   $covrg_cd:1                 '  $covrg_cd 
show    '                               '   
show    '   $covrg_cd_effdt:8           '  $covrg_cd_effdt 
show    '   $reserved_1:1               '  $reserved_1 
show    '   $reserved_8:8               '  $reserved_8 
show    '   $reserved_1:1               '  $reserved_1 
show    '   $reserved_8:8               '  $reserved_8 
show    '                               '   
show    '   $reserved_3:3               '  $reserved_3 
show    '                               '   
show    '   $reserved_3:3               '  $reserved_3 
show    '                               '   
show    '   $reserved_3:3               '  $reserved_3 
show    '                               '   
show    '   $reserved_3:3               '  $reserved_3 
show    '                               '   
show    '   $reserved_3:3               '  $reserved_3 
show    '   $user_grp_num:15            '  $user_grp_num 
show    '   $covrg_id:2                 '  $covrg_id 
show    '   $ben_index:4                '  $ben_index 
show    '                               '   
show    '   $reserved_15:15             '  $reserved_15 
show    '   $reserved_15:15             '  $reserved_15 
show    '   $reserved_2:2               '  $reserved_2 
show    '   $reserved_4:4               '  $reserved_4 
show    '   $reserved_15:15             '  $reserved_15 
show    '   $reserved_2:2               '  $reserved_2 
show    '   $reserved_4:4               '  $reserved_4 
show    '   $user_seq_loc:15            '  $user_seq_loc 
show    '   $insurance_cd:20            '  $insurance_cd 
show    '   $empl_type:1                '  $empl_type 
show    '   $status:1                   '  $status 
show    '                               '   
show    '   ' ':2                       '   
show    '   $pkg_ind:1                  '  $pkg_ind 
show    '   $name_print_ind:1           '  $name_print_ind 
show    '   $client_ded_ind:1           '  $client_ded_ind 
show    '   $client_pass_thru:200       '  $client_pass_thru 
show    '   $medicare_B_ind:1           '  $medicare_B_ind 
show    '   $medicare_B_effdt:8         '  $medicare_B_effdt 
show    '   $medicare_B_num:15          '  $medicare_B_num 
show    '   ' ':3                       '   
show    '   $no_copay:1                 '  $no_copay 
show    '   $prior_auth_flag:1          '  $prior_auth_flag 
show    '   $prior_auth_type:1          '  $prior_auth_type 
show    '   $medicare_B_term_cc:2       '  $medicare_B_term_cc 
show    '                               '   
show    '   ' ':18                      '   
show    '   $paid_to_dt:8               '  $paid_to_dt 
show    '   $prim_care_clinic_id:20     '  $prim_care_clinic_id 
show    '   $creditable_cvrg_ind:1      '  $creditable_cvrg_ind 
show    '   ' ':3                       '   
show    '   $primary_subsidy_ind:1      '  $primary_subsidy_ind 
show    '   $primary_subsidy_effdt:8    '  $primary_subsidy_effdt 
show    '   $primary_subsidy_term_dt:8  '  $primary_subsidy_term_dt 
show    '   ' ':16                      '   
show    '   $HIC_or_RRB_cd:1            '  $HIC_or_RRB_cd: 
show    '   $HIC_or_RRB_num:12          '  $HIC_or_RRB_num 
show    '   ' ':7                       '   
show    '                               '   
show    '   ' ':1                       '   
show    '                               '   
show    '   ' ':7                       '   
show    '                               '   
show    '   ' ':8                       '   
show    '                               '   
show    '   ' ':7                       '   
show    '                               '   
show    '   ' ':15                      '   
show    '                               '   
show    '   ' ':15                      '   
show    '   ' ':20                      '   
show    '   ' ':1                       '   
show    '   $medicare_disenroll_type:1  '  $medicare_disenroll_type 
show    '   ' ':2                       '   
 
 end-if
!GEX-TLL 04/23/2008 Added - End 
 
  let $rec_type = 'E' 
  let $relation = '1'
  add 1 to #tot_recs
  write 1 from 	$rec_type:1
	       	$groupno:15
!FROM ITG 38644  12/2006 - CWB ****************************************
!	       	' ':9
!      	  	$emplid:9
                $gex_emplid:18
!***********************************************************************
		$person_num:3
		$txn_seq:2	
		$txn_dt:8
		$txn_cd:1
		$ben_grp_num:15
		$elig_effdt:8
		$elig_term_dt:8
		$reserved_8:8
		$reserved_8:8
		$reserved_8:8
		$reserved_8:8
		$relation:1
	        $last_name:25
	        $first_name:15
	        $mid_init:1
		$title:4
		$name_ext:6
                $birth_dt:8
		$mult_birth:1
                $sex_1:1
		$SSN:11
		$alt_groupno:15
		$alt_id_cd:1
		$alt_id_num:18
		$alt_person_cd:3
	       	$address1:30
	       	$address2:30
	       	$address3:30
	       	$city:26
	       	$state:2
	       	$zip:9
!		$city_cd:5		
	        ' ':5
!		$county_cd:7
	        ' ':7
!		$country_cd:4
		' ':4
		$phone_nbr:10
		$COB_ind:1
		$COB_effdt:8
		$medicare_term_dt:6
		$primary_care_type:3
		$primary_care_id:18
		$primary_care_effdt:8
		$primary_care_term_dt:8
!		$fp_time:1
		$covrg_cd:1
!	       $hb_dt
		$covrg_cd_effdt:8
		$reserved_1:1
		$reserved_8:8
		$reserved_1:1
		$reserved_8:8
!		$NCPDP_cvrg_cd:3
		$reserved_3:3
!		$dep_max_age:3
		$reserved_3:3
!		stud_max_age:3
		$reserved_3:3
!		$dis_dep_max_age:3
		$reserved_3:3
!		$adult_dep_max_age
		$reserved_3:3
		$user_grp_num:15
		$covrg_id:2
		$ben_index:4
!		$patient_rptg_id:15
		$reserved_15:15
		$reserved_15:15
		$reserved_2:2
		$reserved_4:4
		$reserved_15:15
		$reserved_2:2
		$reserved_4:4
		$user_seq_loc:15
		$insurance_cd:20
		$empl_type:1
		$status:1
!		$card_qty:2
		' ':2
		$pkg_ind:1
		$name_print_ind:1
		$client_ded_ind:1
		$client_pass_thru:200
		$medicare_B_ind:1
		$medicare_B_effdt:8
		$medicare_B_num:15
                ' ':3
		$no_copay:1
		$prior_auth_flag:1
		$prior_auth_type:1
		$medicare_B_term_cc:2
!		$patient_id:18
		' ':18
		$paid_to_dt:8
		$prim_care_clinic_id:20
		$creditable_cvrg_ind:1
                ' ':3
		$primary_subsidy_ind:1
		$primary_subsidy_effdt:8
		$primary_subsidy_term_dt:8
                ' ':16 
		$HIC_or_RRB_cd:1
		$HIC_or_RRB_num:12
		' ':7
!		$mail_dir_ind:1
		' ':1
!		$ben_cap_amt:7
		' ':7
!		$ben_cap_effdt:8
                ' ':8
!		$ben_life_amt:7
		' ':7
!		$health_plan_id_num:15
		' ':15
!		$card_grp:15
		' ':15
		' ':20
		' ':1
		$medicare_disenroll_type:1
		' ':2

end-procedure

!*********************************************************************
begin-procedure Get-Dependent

begin-select

HD.EMPLID

DP.DEPENDENT_BENEF       
   move &DP.DEPENDENT_BENEF to $dependent_benef

DP.NAME
   move &DP.NAME            to $dep_name

DP.RELATIONSHIP
   move &DP.RELATIONSHIP    to $relationship

DP.STUDENT
   move &DP.STUDENT         to $student
				 
DP.DISABLED
   move &DP.DISABLED        to $disabled

DP.BIRTHDATE
   move &DP.BIRTHDATE       to $dep_birthdate

DP.SEX
   move &DP.SEX             to $dep_sex

HD.EFFDT
   move &HD.EFFDT           to $hd_effdt

!NPK 09/12/2006 Added the below to print the dependent report
DP.SAME_ADDRESS_EMPL
   move &DP.SAME_ADDRESS_EMPL       to $same_address_empl

DP.ADDRESS1
   move &DP.ADDRESS1         to $dep_address1
DP.CITY
   move &DP.CITY             to $dep_city
DP.STATE
   move &DP.STATE            to $dep_state
DP.POSTAL 
   move &DP.POSTAL           to $dep_zip
DP.ADDRESS2
   move &DP.ADDRESS2         to $dep_address2

 If $same_address_empl = 'Y'
   let $dep_address1 = ' '
   let $dep_city     = ' '
   let $dep_state    = ' '
   let $dep_zip      = ' '
   let $dep_address2 = ' ' 
 End-if

  do get-dep-ssn
  show 'HD.EMPLID          :' &HD.EMPLID
  show 'DP.DEPENDENT_BENEF :' &DP.DEPENDENT_BENEF
 let #dependent_benef = to_number($dependent_benef) + 01  
 
 If #dependent_benef >= 1 and #dependent_benef <= 9 
     let $dependent_benef = '00' || to_char(#dependent_benef)
  else
     let $dependent_benef = '0' || to_char(#dependent_benef)
 end-if

  Do Print-Dependent-Record
  Do Write-Dependent-Record


FROM PS_DEPENDENT_BENEF DP,
     PS_HEALTH_DEPENDNT HD

WHERE DP.EMPLID          = HD.EMPLID
AND   DP.EMPLID          = $emplid
AND   DP.DEPENDENT_BENEF = HD.DEPENDENT_BENEF
AND   HD.EMPL_RCD       = #empl_rcd
!AND   HD.PLAN_TYPE       = '1Z' !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND HD.PLAN_TYPE = $dep_plan_type !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND   HD.EFFDT = $hb_effdt !NPK 08/28/2006 Fix logic to select dependants properly
ORDER BY HD.EMPLID, DP.DEPENDENT_BENEF

end-select
end-procedure
!GEX-TLL 04/23/2008 Added - Begin
!*********************************************************************
begin-procedure Get-Dependent_18
 
begin-select

HD1.EMPLID

DP1.DEPENDENT_BENEF       
   move &DP1.DEPENDENT_BENEF to $dependent_benef   


DP1.NAME
   move &DP1.NAME            to $dep_name

DP1.RELATIONSHIP
   move &DP1.RELATIONSHIP    to $relationship

DP1.STUDENT
   move &DP1.STUDENT         to $student
				 
DP1.DISABLED
   move &DP1.DISABLED        to $disabled

DP1.BIRTHDATE
   move &DP1.BIRTHDATE       to $dep_birthdate

DP1.SEX
   move &DP1.SEX             to $dep_sex

HD1.EFFDT
   move &HD1.EFFDT           to $hd_effdt

!NPK 09/12/2006 Added the below to print the dependent report
DP1.SAME_ADDRESS_EMPL
   move &DP1.SAME_ADDRESS_EMPL       to $same_address_empl

DP1.ADDRESS1
   move &DP1.ADDRESS1         to $dep_address1
DP1.CITY
   move &DP1.CITY             to $dep_city
DP1.STATE
   move &DP1.STATE            to $dep_state
DP1.POSTAL 
   move &DP1.POSTAL           to $dep_zip
DP1.ADDRESS2
   move &DP1.ADDRESS2         to $dep_address2

 If $same_address_empl = 'Y'
   let $dep_address1 = ' '
   let $dep_city     = ' '
   let $dep_state    = ' '
   let $dep_zip      = ' '
   let $dep_address2 = ' ' 
 End-if
  show 'HD1.EMPLID          :' &HD1.EMPLID
  show 'DP1.DEPENDENT_BENEF :' &DP1.DEPENDENT_BENEF
  show '$hb_effdt_18 :' $hb_effdt_18
  do get-dep-ssn

 let #dependent_benef = to_number($dependent_benef) + 01  
 
 If #dependent_benef >= 1 and #dependent_benef <= 9 
     let $dependent_benef = '00' || to_char(#dependent_benef)
  else
     let $dependent_benef = '0' || to_char(#dependent_benef)
 end-if
 
  Do Print-Dependent-Record
  Do Write-Dependent-Record


FROM PS_DEPENDENT_BENEF DP1,
     PS_HEALTH_DEPENDNT HD1

WHERE DP1.EMPLID          = HD1.EMPLID
AND   DP1.EMPLID          = $emplid
AND   DP1.DEPENDENT_BENEF = HD1.DEPENDENT_BENEF
AND   HD1.EMPL_RCD       = #empl_rcd
!AND   HD1.PLAN_TYPE       = '18'  !MXR  04/02/08 !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND   HD1.PLAN_TYPE        = $plan_type_18 !GEXBN_848_P143186_01 Vahini Katta 12/02/2013
AND   HD1.EFFDT = $hb_effdt_18 !NPK 08/28/2006 Fix logic to select dependants properly
ORDER BY HD1.EMPLID, DP1.DEPENDENT_BENEF

end-select

end-procedure

begin-procedure get-dep-ssn
begin-select
dpn.national_id
  let $dep_ssn = substr(&dpn.national_id,1,9)
from PS_DEP_BENEF_NID DPN
where dpn.emplid = $emplid
and dpn.primary_nid = 'Y'
and dpn.dependent_benef = $dependent_benef
end-select
end-procedure

!*****************************************************************



!NPK 09/12/2006 Added the below to print the dependent report
!*********************************************************************
!*********************************************************************
! Print Dependent Record for Medco Eligibility Report
!*********************************************************************
begin-procedure Print-Dependent-Record

  if #current-line > 51
     new-page
  end-if

  let $print_name = substr($dep_name,1,21)
  let $print_address1 = substr($dep_address1,1,20)
  let $print_address2 = substr($dep_address2,1,16)
  let $print_city = substr($dep_city,1,15)
  let $print_zip = substr($dep_zip,1,5)

  Do Convert-to-dtu-date($dep_birthdate,$bdt)
  let $bd_yy = substr($bdt,3,2)
  let $bd_mm = substr($bdt,6,2)
  let $bd_dd = substr($bdt,9,2)
  let $bday = $bd_mm||'/'||$bd_dd||'/'||$bd_yy

!**
  let $r = $relationship

! Deepak, FC, 12/03/07. Made the following changes 
! due to upgrade to 9.0
! replaced GD and GS with GC 
! replaced NC with NI
! replaced SD and SS with SC
! removed NE, NE is now NN
! replaced D and S to C

  if $r = 'C' or $r = 'GC' or $r = 'SC' or
     $r = 'NI' or $r = 'NN' 
     let $relation = '3'
  else
     let $relation = '6'
  end-if

  if $student = 'Y'
     let $relation = '4'
  end-if
  if $disabled = 'Y'
     let $relation = '5'
  end-if
  if $relationship = 'SP'
     let $relation = '2'
  end-if
  !GEX-TLL 04/23/2008 Added - Begin
if $relationship = 'NA'     !ISDVMXR 01/04/2008 ADD new relationship value
     let $relation = '8'
  end-if
  !GEX-TLL 04/23/2008 Added - End

!**

  print $group               (+1,2)
  print $prt_emplid          (0,09)     ! CWB 12/06
  print $dependent_benef     (0,24)
  print $print_name          (0,29)
  print $print_address1      (0,51)
  print $print_city          (0,73)
  print $dep_state           (0,92)
  print $print_zip           (0,97)
  print $print_address2     (0,104,15)
  print $relation           (0,124)
  print $bday               (0,129)
  print $dep_sex            (0,141)
  print ' '                 (0,148)
  print ' '                 (0,155)
  print $ben_begin_dt       (0,158)
  print ' '                 (0,168)

  add 1 to #group_count

end-procedure
!*********************************************************************
!NPK 09/12/2006 Added the above to print the dependent report



!*********************************************************************
! Write Dependent Record Information
!*********************************************************************
begin-procedure Write-Dependent-Record

  add 1 to #write_rec2

  let $groupno = 'GEP0'||$group

  let $dep_person_num = '002'     ! CWB 12/2006

!  let $alt_groupno = 'GEP0'||$group
  let $alt_groupno = ' '
!  let $alt_id_cd = 'T'
  let $alt_id_cd = ' '
!  let $alt_id_num =  $pd_emplid
  let $alt_id_num =  ' '
!  let $alt_person_cd = $dep_person_num 
  let $alt_person_cd = ' ' 

  let $LastName = ' '
  let $FirstName = ' '
  let $MidInitial = ' '        ! 11/09/2004 - CXA - fix mid initial
  let $Name = $dep_name
  Do Rotate-Name
  let $dep_last_name = upper(substr($LastName,1,24))    !NPK 08/28/2006 Added the Upper as the same way as Employee Name
  let $dep_first_name = upper(substr($FirstName,1,15))  !NPK 08/28/2006 Added the Upper as the same way as Employee Name
  let $dep_mid_init = $MidInitial

!**
  let $r = $relationship

! Deepak, FC, 12/03/07. Made the following changes 
! due to upgrade to 9.0
! replaced GD and GS with GC 
! replaced NC with NI
! replaced SD and SS with SC
! removed NE, NE is now NN
! replaced D and S to C

  if $r = 'C' or $r = 'GC' or $r = 'SC' or
     $r = 'NI' or $r = 'NN' 
     let $relation = '3'
  else
     let $relation = '6'
  end-if

  if $student = 'Y'
     let $relation = '4'
  end-if
  if $disabled = 'Y'
     let $relation = '5'
  end-if
  if $relationship = 'SP'
     let $relation = '2'
  end-if
  !GEX-TLL 04/23/2008 Added - Begin  
  if $relationship = 'NA'    
     let $relation = '8'
  end-if
!GEX-TLL 04/23/2008 Added - End

!**
  Do Convert-to-dtu-date($dep_birthdate,$dbdate)

  let $db_yy = substr($dbdate,1,4)
  let $db_mm = substr($dbdate,6,2)
  let $db_dd = substr($dbdate,9,2)


  let $dbirth_dt = $db_yy||$db_mm||$db_dd

!**
  if $dep_sex = 'M'
     move 'M' to $dsex
  else 
  if $dep_sex = 'F'
     move 'F' to $dsex
  else
     move 'U' to $dsex
  end-if
  end-if
!**
  Do Convert-to-dtu-date($hd_effdt,$hd_dt)
  let $hd_cc = substr($hd_dt,1,2)
  let $hd_yy = substr($hd_dt,3,2)
  let $hd_mm = substr($hd_dt,6,2)
  let $hd_dd = substr($hd_dt,9,2)

 let $d_elig_effdt = $hd_cc||$hd_yy||$hd_mm||$hd_dd


!  display 'Dependent: ' noline
!  display $groupno noline
!  display ' ' noline
!  display $emplid

 Let $groupno=translate($groupno,'-','') !GEXBN_848_P143186_01 2013-11-12 Vahini Katta

if $debug_flag = 'Y' 
      show '    $rec_type:1            '$rec_type              
      show '    $groupno:15            '$groupno               
      show '    $gex_emplid:18         '$gex_emplid            
      show '    $dep_person_num:3      '$dep_person_num          
      show '    $txn_seq:2	       '$txn_seq	           
      show '    $txn_dt:8              '$txn_dt                  
      show '    $txn_cd:1              '$txn_cd                  
      show '    $ben_grp_num:15        '$ben_grp_num             
      show '    $elig_effdt:8          '$elig_effdt              
      show '    $d_elig_term_dt:8      '$d_elig_term_dt          
      show '    $reserved_8:8          '$reserved_8              
      show '    $reserved_8:8          '$reserved_8              
      show '    $reserved_8:8          '$reserved_8              
      show '    $reserved_8:8          '$reserved_8              
      show '    $relation:1            '$relation                
      show '    $dep_last_name:25      '$dep_last_name           
      show '    $dep_first_name:15     '$dep_first_name          
      show '    $dep_mid_init:1        '$dep_mid_init            
      show '    $title:4               '$title                   
      show '    $name_ext:6            '$name_ext                
      show '    $dbirth_dt:8           '$dbirth_dt               
      show '    $multi_birth:1         '$multi_birth             
      show '    $dsex:1                '$dsex                    
      show '    $dep_ssn:11            '$dep_ssn                 
      show '    $alt_groupno:15        '$alt_groupno             
      show '    $alt_id_cd:1           '$alt_id_cd               
!** Teshow '    $alt_id_num:18         '$alt_id_num              st fields for spaces - fill in where needed
      show '    $alt_person_cd:3       '$alt_person_cd           
    end-if    
!GEX-TLL 04/23/2008 Added - End    

!**
  add 1 to #tot_recs
  write 1 from  $rec_type:1
                $groupno:15
!FROM ITG 38644  12/2006 - CWB ****************************************
!		' ':9
!		$emplid:9
                $gex_emplid:18
!*********************************************************************** 
		$dep_person_num:3
		$txn_seq:2	
		$txn_dt:8
		$txn_cd:1
		$ben_grp_num:15
		$elig_effdt:8
		$d_elig_term_dt:8
		$reserved_8:8
		$reserved_8:8
		$reserved_8:8
		$reserved_8:8
		$relation:1
		$dep_last_name:25
		$dep_first_name:15
		$dep_mid_init:1
		$title:4
		$name_ext:6
		$dbirth_dt:8
		$multi_birth:1
		$dsex:1
		$dep_ssn:11
		$alt_groupno:15
		$alt_id_cd:1
		$alt_id_num:18
		$alt_person_cd:3
		' ':779
 
let $dep_ssn = ''  !GEX-TLL 04/23/2008 Added
end-procedure

!*********************************************************************
begin-procedure Select-Pay-End-Dt
begin-select
MAX(PC.PAY_END_DT)      &pay_end_dt
  move &pay_end_dt   to $pay_end_dt
  show '&pay_end_dt :' &pay_end_dt
FROM PS_PAY_CHECK PC
where pc.pay_end_dt <= $run_date 
end-select

!display $pay_end_dt

end-procedure

!*********************************************************************
begin-procedure Get-Empl-Name
begin-select
PD2.LAST_NAME_SRCH

  move &PD2.LAST_NAME_SRCH to $last_name

FROM PS_PERSONAL_DATA PD2
WHERE PD2.EMPLID = $emplid

end-select

  let $lname = substr($last_name,1,8)

end-procedure

!*********************************************************************
!Displays the error messages and stops execution
!*********************************************************************
 
begin-procedure SQL-Error-Found($Proc_Name) 
!  do error-found
  display 'SQL Error in ' 
  display $Proc_Name 
  display $_sql-error
  display 'sql-status:' 
  display #_sql-status 

  STOP

end-procedure

#Include 'tranctrl.sqc'  !Common Transaction Control Procedures
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#include 'gexxx920.sqc'  !Get ben single row run control
#Include 'number.sqc'    !Routines to format numbers
#Include 'stdapi.sqc'    !Update Process API
#Include 'datemath.sqc'  !Does the date-math functions
#Include 'getdatcd.sqc'  !Get-Date-Codes procedure
#Include 'getbalid.sqc'  !Get-Calendar-Year-Id
#Include 'rotname3.sqc'
