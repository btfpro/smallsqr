!***********************************************************************
! GEXPY659W  Find differences between BW Table and Batch Inserts-
!
!	    Batch Inserts are not captured through PeopleCode so use this
!	    Program to find the rows that were inserted through Batch Jobs
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
! This module is the confidential and proprietary information of       *
! Giant Eagle, Inc.; it is not to be copied, reproduced, or transmitted*
! in any form, by any means, in whole or in part, nor is it to be used *
! for any purpose other than that for which it is expressly provided   *
! without the written permission of Giant Eagle.                       *
!                                                                      *
!***********************************************************************
!                         MODIFICATION HISTORY                         *
!***********************************************************************
!  INITIALS    DATE           DESCRIPTION OF THE CHANGE                *
!***********************************************************************
!  ISDVPYM    08/05/2008     INITIAL CREATION                          *
!                             Cloned GEXPY659.SQR & modified  to meet  *
!                             Blue Cube requirements for whearhouse.   *
!***********************************************************************

#include 'setenv.sqc' !Set environment
#Include 'setup02.sqc'
!****************************************************************************
begin-report
!****************************************************************************  
  do Alter-Session    !ISDVSRC
  do Init-DateTime
  do Init-Number
  do stdapi-init
  do set-env-var		!Gex-Axg	Added for Upgrade 9.0 !Changed by VENDKXY for ITG 46149 excessive run times on 01/24/2008
  move 'GEXPY659' to $ReportID
  move 'Employee Changes for Blue Cube' to $ReportTitle
  display $ReportID
  display $ReportTitle

  do Get-Current-DateTime
  !for testing only isdvmxr 07/27/2006.
  !let $OprID = 'HRBATCH'
  !LET $Run_Cntl_ID = 'gexpy659'

  Let $GEXXX902_Deptid_Alias   = 'C.DEPTID'    !used in  Select-New-Data procedure
 
  if $prcs_process_instance = ''
      Do Ask-As-Of-Date
      Let $X000_WHERE_SELECT_ASOFDATE = $AsOfDate

  !----------------------------------------------------
    Let $DeptIDString = ''''
    Display 'Enter DeptID or leave blank to exit.'
    While 1=1
      Input $In-DeptID Maxlen=10 'DeptID'
      Uppercase $In-DeptID
      If Rtrim($In-DeptID, ' ') = ''
        Concat '''' With $DeptIDString
        Break
      End-If
      If $DeptIDString <> ''''
        Concat ''',''' With $DeptIDString
      End-If
      Concat $In-DeptID With $DeptIDString
    End-While

 			   If $DeptIDString = ''''''
    				  Let $GEXXX902_INCLUDE_DEPTID_CRITERIA = '1=1'
     				  Let $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA = 'ALL'
      
     			 !Below are used for B Table in MNT-vs-B-Table  procedure
     				 Let $GEXXX902_INCLUDE_DEPTID_CRITERIA_x         = '1=1'   
     				 Let $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x = 'ALL'   
   			 Else
   				 Let $GEXXX902_INCLUDE_DEPTID_CRITERIA = $GEXXX902_Deptid_Alias || ' In (' || $DeptIDString || ')'
    				 Let $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA = $GEXXX902_INCLUDE_DEPTID_CRITERIA
   				 
   						  
      				Let $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x = $GEXXX902_INCLUDE_DEPTID_CRITERIA_x
      
                                    let #length = length($GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA)     !ISDVMXR 05/07/2006
                            !        SHOW ' length ****   '  #length 
     				let $substring = substr($GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA, 3 , #length )
     				!show '    #substring  ' $substring 
     				LET $ALIAS = '(B1'
     				let  $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x = $ALIAS || $substring 
     			  	!Show '$GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x = '  $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x
                       
   			 End-If
    

	    

  Else
        #debug show '*********************** getting values from runcnlt   '  
    Do GEXXX902-Select-Deptid-Parameters
   ! DO GEXXX903-Select-Emp-Stat-Parameters
    !   show ' #GEX_RC_DEPTID_ROWS     ' #GEX_RC_DEPTID_ROWS  VENDKXY
    Do GEXXX922-Select-Parameters
    Let $X000_WHERE_SELECT_ASOFDATE = $GEX_RC_PAY.AsOfDate
    If Rtrim ($GEX_RC_PAY.AsOfDate, ' ') = ''
      Let $X000_WHERE_SELECT_ASOFDATE = $AsOfToday
      #debug show '$X000_WHERE_SELECT_ASOFDATE ' $X000_WHERE_SELECT_ASOFDATE
      
      
      End-If
        
  end-if
   
  date-time () HH:MI:SS &timeBegan
  date-time () MM/DD/YYYY &dateBegan
  #debug show 'Report Began at ' &timeBegan ' on ' &dateBegan

   Do Format-DateTime($X000_WHERE_SELECT_ASOFDATE, $X000_REPORT_HEADING_ASOFDATE, {DEFDATE}, '', '')

  !Show ' '
 #debug Show '$GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA   = '  $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA
 #debug Show '$GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x = '  $GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x
 #debug Show '$X000_WHERE_SELECT_ASOFDATE                 = '  $X000_WHERE_SELECT_ASOFDATE
 #debug Show ' '
  
  let #length = length($GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA)     !ISDVMXR 05/07/2006
        !    SHOW ' length ****   '  #length 
  		let $substring = substr($GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA, 3 , #length )
  	!				show '    #substring  ' $substring 
  			LET $ALIAS = '(B1'
  				let  $GEXXX902_INCLUDE_DEPTID_CRITERIA_x = $ALIAS||$substring 
     			  #debug Show '********************$GEXXX902_INCLUDE_DEPTID_DISPLAY_CRITERIA_x = '  $GEXXX902_INCLUDE_DEPTID_CRITERIA_x

              

  Let $Year4 = '1'
  Do Format-DateTime($X000_WHERE_SELECT_ASOFDATE, $reportdate, {DEFDATE}, '', '')
  
  let $reportdate_mm = substr($reportdate,1,2)
  let $reportdate_dd = substr($reportdate,4,2)
  let $reportdate_yy = substr($reportdate,7,4)
  let $reportdate_ccyy = $reportdate_yy||'-'||$reportdate_mm||'-'||$reportdate_dd
  do Convert-From-DTU-Date($reportdate_ccyy, $reportdate_dbf)

!##################################################################
  let $reportdate_dtu = $reportdate_ccyy
  !let $excep_flag = 'Y' ! isdvmxr   08/09/2006
  let $alert_flag = 'Y'
!##################################################################

  let #subtract_Days = 14

  do dtu-subtract-days($reportdate_ccyy, #subtract_Days, $reportdate_less14)
  do Convert-From-DTU-Date($reportdate_less14, $reportdate_less14_dbf)
  Do Format-DateTime($reportdate_less14_dbf, $reportdate_cmp, {DEFCMP}, '', '')
    
  do Report
  do Commit-Transaction
  
!  DO SQL-COUNTS1
  DO SQL-COUNTS2
  DO SQL-COUNTS3
!  show 'Total rows Inserted into PS_GEX_SMT_TRK_BW Table:' #New-Row-Inserted
   
!  SHOW '#EE_Reached_Anniversary_N :' #EE_Reached_Anniversary_N
!  SHOW '#EE_Reached_Anniversary_Y :' #EE_Reached_Anniversary_Y
   
  date-time () HH:MI:SS &timeEnded
  date-time () MM/DD/YYYY &dateEnded
  show 'Report Ended at ' &timeEnded ' on ' &dateEnded
! show ' '

  do stdapi-term
!****************************************************************************
 end-report
!****************************************************************************
!Gex-Axg Added for upgrade 9.0 - begin 
!new procedure added by VENDKXY for ITG 46149 excessive run times on 01/24/2008
!************************************************************************
Begin-procedure set-env-var
!************************************************************************
Begin-sql
alter session set "_unnest_subquery"=FALSE
End-sql
!************************************************************************
End-procedure set-env-var
!************************************************************************
!Gex-Axg Added for upgrade 9.0 - End 

!************************************************************************
begin-procedure SQL-COUNTS2
!************************************************************************
!show ' '
!show '  SQL-COUNTS2 start Details of NEW Table - Rows inserted today THROUGH THE GEXPY659.SQR ARE :'
begin-select
status_ind      &sts_ind2
count(*)	&count2


  let #cnt2     = &count2
  let $sts_ind2 = &sts_ind2		

!  show 'STATUS_IND :' $sts_ind2 
!  show 'COUNT      :' #cnt2	
 
from PS_GEX_SMTKNEW_W
group by status_ind
end-select

!show ' SQL-COUNTS2 end '
!****************************************************************************
End-Procedure SQL-COUNTS2
!****************************************************************************
!************************************************************************
begin-procedure SQL-COUNTS3
!************************************************************************
!show ' '
!show ' '
! show 'Details of MNT Table  - Difference between HLD and NEW tables:'
begin-select
status_ind      &sts_ind3
count(*)	&count3

 
 let #cnt3     = &count3
 let $sts_ind3 = &sts_ind3

!  show 'STATUS_IND :' $sts_ind3 
!  show 'COUNT      :' #cnt3	
 
from PS_GEX_SMTKMNT_W
group by status_ind
end-select

! show 'end sql counts - Difference between HLD and NEW tables:'
!****************************************************************************
End-Procedure SQL-COUNTS3
!****************************************************************************
!************************************************************************

!************************************************************************
begin-procedure Report
!************************************************************************

 date-time () hh:mi:ss &timeBegan
 display 'Report Began: ' noline
 display &timeBegan

 
 move 'N' to $Errorfound
 move '0' to $filler
 !If we have to start all over again, we need to disable the below procedures
 !which has : Disable for 1-time load
 !This is to maintain a baseline to find the differences
  
 DO GET-DAY-SYSDATE  ! changed by VENDKXY for ITG 44045 on 10/04/2007
  
 !deletes from the PS_GEX_SMTKMNT_W table   
 Do Delete-Prior-Entries        !Disable for 1-time load   
 
 ! delete from PS_GEX_SMTKHLD_W and then inserts into PS_GEX_SMTKHLD_W from  PS_GEX_SMTKNEW_W
 ! then deletes from PS_GEX_SMTKNEW_W
 Do Insert-Current-Data	        !Disable for 1-time load  
 
 
 
 ! This procedure selects from ps tables
 Do Select-New-Data

 !Find the diff between  NEW & HLD and inserts into the MNT table the changes
 Do Find-Changes		!Disable for 1-time load  

 
 Do MNT-vs-B-Table		!Disable for 1-time load    
 Do Select-Final-Data 		!Disable for 1-time load   
 
     
  date-time () hh:mi:ss &timeEnded
  display 'Report Ended: ' noline
  display &timeEnded
!**********************************************************************
end-procedure Report
!**********************************************************************

!**********************************************************************
begin-procedure delete-prior-entries
!**********************************************************************
!wipe out last time MNT to make room for newer
begin-sql
delete from PS_GEX_SMTKMNT_W  

end-sql

!wipe out last time FINAL(FNL) to make room for newer
begin-sql
delete from PS_GEX_SMTKFNL_W   		!ISDVSRC 03/08/2006
end-sql
!**********************************************************************
end-procedure delete-prior-entries
!**********************************************************************

!******************************************************************
begin-procedure Insert-Current-Data
!******************************************************************
!wipe out old data and move last time NEW to HLD (old data)
begin-sql
delete from PS_GEX_SMTKHLD_W 
end-sql

 #debug show ' Insert-Current-Data which selects from PS_GEX_SMTKNEW_W  and inserts into PS_GEX_SMTKHLD_W   starting '  
begin-sql on-error=sql-error-found('Insert-Current-Data')

insert into PS_GEX_SMTKHLD_W
 select EMPLID           ,  
	EMPL_RCD               ,
	COMPANY                ,
	PAYGROUP               ,  
	NEW_DEPTID             ,            
	LAST_NAME              ,        
	FIRST_NAME             ,         
	BIRTH_DT               ,         
	HIRE_DT                ,   
	SENIORITY_DATE         ,
	FLAG                   ,         
	MGR_PWD                ,         
	LOGIN_ID               ,         
	LOGIN_PWD              ,         
	EMPL_TYPE              ,         
	BADGE_NBR              ,         
	SCHEDULE_FLAG          ,         
	EXCEPTION_FLAG         ,         
	ALERTSTATUS            ,         
	DEPTID                 ,   
	nvl(ADDRESS1,' ')      ,         
	nvl(ADDRESS2,' ')      ,         
	nvl(CITY,' ')          ,  
	nvl(ZIP,' ')           ,         
        nvl(PHONE1,' ')        ,         
	nvl(PHONE2,' ')        ,   
	nvl(PAGER_NBR,' ')     ,         
	nvl(STATE,' ')         ,         
	nvl(COUNTRY,' ')       ,         
	JOBID                  ,         
	GEX_BASE_RT            ,      
	ALT_RATE               ,         
	nvl(EXEMPT_FLAG,' ')   ,
	nvl(SALARY_FLAG,' ')   ,
	nvl(FULL_TIME,' ')     ,         
	HOURS_PER_WEEK         ,         
	nvl(DIVISION,' ')      ,     
	BENEFIT_HRS            ,         
	BENEFIT_COST           ,         
	VAC_ACCR_BAL           ,         
	nvl(GEX_BC_PAY_RULE,' '),         
	nvl(GEX_SHIFT_STRGY,' '),
	nvl(GEX_EMPL_HIR_STS,' '),
	nvl(STATUS_IND,' ')    ,          
	nvl(ROLE_ID,' ')       ,	
	nvl(PUNCH_RULE,' ')    ,
	nvl(EMPL_STATUS,' ')   ,
	nvl(EMPL_STATUS_LBL,' '),
	STATUS_DT              ,
	EXPECTED_RETURN_DT     ,
	nvl(GEX_VOLUNTARY_FLAG,' '),
	nvl(SCHED_TYPE,' ')     

FROM PS_GEX_SMTKNEW_W
order by emplid

end-sql
    
!wipe out last times NEW to make room for newer
begin-sql
delete from PS_GEX_SMTKNEW_W  
end-sql
! show ' Insert-Current-Data which selects from PS_GEX_SMTKNEW_W  and inserts into PS_GEX_SMTKHLD_W   ending '  
!**********************************************************************
end-procedure  Insert-Current-Data
!**********************************************************************

!******************************************************************
begin-procedure Select-New-Data
!******************************************************************
 move 'N' to $found
  #debug show ' starting   Select-New-Data procedure from main ps tables '
    
    
begin-select ON-ERROR=SQL-Error-Found('Select-New-Data')
A.EMPLID
M.emplid                    
A.LAST_NAME
A.FIRST_NAME
A.MIDDLE_NAME
A.BIRTHDATE
A.ADDRESS1 &ADDRESS1
A.ADDRESS2 &ADDRESS2
A.CITY &CITY
A.STATE &STATE
A.COUNTRY &country
A.POSTAL
A.PHONE
A.GEX_INACTIVE_TA
B.HIRE_DT
B.REHIRE_DT
C.UNION_CD
C.UNION_SENIORITY_DT   	       
B.CMPNY_SENIORITY_DT
B.SERVICE_DT
B.EXPECTED_RETURN_DT
!B.APPOINT_END_DT  !VENDVKV ITG# 38593 02/28/2007 !B.APPOINT_END_DT  !VENDVKV ITG# 38593 02/28/2007 	!GEX-RBC commented for HCM upgrade 9.0	     	     
ASG.APPOINT_END_DT		!GEX-RBC added for HCM upgrade 9.0
C.JOBCODE
C.JOB_INDICATOR
C.FLSA_STATUS
C.JOB_ENTRY_DT
C.DEPTID
C.EMPL_TYPE
C.HOURLY_RT
C.ANNUAL_RT			 
C.EFFDT
   Do format-datetime (&C.EFFDT,$TRANSFER_DT_CMP,{DEFCMP},'','')   
C.ACTION_DT
   Do format-datetime (&C.ACTION_DT,$ACTION_DT_CMP,{DEFCMP},'','')   
C.ACTION
C.ACTION_REASON			 
C.COMPANY
C.PAYGROUP
C.EMPLID
C.EMPL_RCD
C.ACCT_CD
C.FULL_PART_TIME
C.GEX_DUES_EXEMPT
C.GEX_STUDENT_IND
C.EFFSEQ
c.empl_Status
C.STD_HOURS
D.SI_ACCIDENT_NUM              
PROG.BENEFIT_PROGRAM
C.ELIG_CONFIG1
C.ELIG_CONFIG2
C.GEX_VOLUN_LOW_HRS         
C.GEX_FP_CODE

  Let $GEX_SHIFT_STRGY = ''
  move 'Y' to $Found
  move 'N' to $errorfound
  
  add 1 to #inputtran
  let $job_emplid   = &c.emplid
  Let $STATUS_DATE  = &C.EFFDT 
 ! show '                                                            '
 !show '----------------------------------------------------------------------------------------'
  ! #debug SHOW '      IN MAIN SELECT                                      ' $STATUS_DATE
   #debug show ' $job_emplid  ' $job_emplid
  
  let #job_empl_rcd = &c.empl_rcd
  let $company      = &c.company
  let $paygroup     = &c.paygroup
  ! let $appoint_end_dt = &b.appoint_end_dt  !VENDVKV ITG# 38593 02/28/2007  !GEX-RBC commented for HCM 9.0 Upgrade
  let $appoint_end_dt = &asg.appoint_end_dt                                  !GEX-RBC added for HCM 9.0 Upgrade
  Let $ELIG_CONFIG1 = substr (&C.ELIG_CONFIG1,4,7)
    
  Let $ELIG_CONFIG2 = substr (&C.ELIG_CONFIG2,4,1)
  Let $GEX_FP_CODE  = &C.GEX_FP_CODE 
  
  Let $GEX_VOLUN_LOW_HRS = &C.GEX_VOLUN_LOW_HRS   
  
   let $single_space  = ' '	
   let $first_name   = LTRIM(RTRIM(&A.FIRST_NAME, ' '), ' ') 
   let $last_name    = LTRIM(RTRIM(&A.LAST_NAME, ' '), ' ')  
   let $middle_name  = LTRIM(RTRIM(&A.MIDDLE_NAME, ' '), ' ')  
   
   If $middle_name   <> ''
    let $first_name   = $first_name || $single_space || substr($middle_name ,1,1)
      ! show '$first_name_with_middle_name :' $first_name  
   Else
    let $first_name   = $first_name 
      ! show '$first_name only :' $first_name  
   End-If  
      
   move 'N' to $store_change

  Let $emplid_main = &A.EMPLID
  let $emplid 	   = &m.emplid
  let $jobcode 	   = &c.jobcode
  
 
  

  
  !Always (hire,rehire) use original hire_Dt 
     Let $HIRE_DT   =  &B.HIRE_DT
     
  !SENIORITY DT On B Table(for Blue cube) is :UNIOIN SENIORITY DATE(JOB_LBR_GBL_SBR) on job
  !If it is blank, use SERVICE DATE from PS_EMPLOYMENT
  
    If &C.UNION_SENIORITY_DT = ''
     #debug show '$UNION_SENIORITY_DT is empty'
      Let $SENIORITY_DATE =  &B.SERVICE_DT
    Else
      #debug show '$UNION_SENIORITY_DT is NOT empty:' &C.UNION_SENIORITY_DT
      Let $SENIORITY_DATE =  &C.UNION_SENIORITY_DT
    End-If  
     
  !End of New specs  - ISDVSRC 
  !-------------------------------------------------
  
  
  Let $Year4 = '1'
  Do Format-DateTime(&A.BIRTHDATE, $birth_date, {DEFDATE}, '', '')
  
  Let $Year4 = '1'
  Do Format-DateTime(&B.HIRE_DT, $hire_date, {DEFDATE}, '', '')
 
  Do get-mgr-level

  !move &c.hourly_rt to $hourly_rt 099.999999  !Commented ISDVSRC
  move &c.hourly_rt to #hourly_rt !099.999999  !Commented ISDVSRC
  
  let $address1   = rtrim(&address1,' ') 
  let $address2   = rtrim(&address2,' ') 
  let $city       = rtrim(&city,' ')
  let $state      = rtrim(&state,' ')
  let $country    = rtrim(&country,' ')
  Let $country    = substr($country,1,2)
  let $zip        = substr(&a.postal,1,5)
  let $phone      = rtrim(&a.phone,' ')
    
  Do Find-Cell-Pager
  
  let $job 	  = &c.acct_cd||&c.jobcode
  let $new_jobid  = &c.acct_cd||&c.jobcode  
  
   let $start_dt   = &c.job_entry_dt
 
  !----------------------------------
 #debug show '&c.empl_type ' &c.empl_type 
  If &c.empl_type = 'S'
    let $salaried = 'Y'
    let $excep_flag = 'N'               !ISDVMXR 08/02/2006    itg # 36903 Change excpetion flag to "N" for Salaried emps. 
  Else
    let $salaried = 'N'
    let $excep_flag = 'Y'    !ISDVMXR 08/09/2006
  End-If
 ! show '$excep_flag' $excep_flag
  !----------------------------------
  let $full_part = &c.full_part_time
  let $full_part_time = &c.full_part_time   
    
  !----------------------------------
  If &c.job_indicator = 'P'
    let $primary = 'Y'
  Else
    let $primary = 'N'
  End-If
  
  !----------------------------------
  If &c.flsa_status = 'N'
    let $flsa_exempt = 'N'
  Else
    let $flsa_exempt = 'Y'
  End-If
  
  
  !----------------------------------
!  If $primary = 'Y'               !NEW specs from Debbie on 05/10/2006
  				   !We should always send the flags as the same
  				   ! no matter Primay or Secondary Job
  				   
     let $exempt_flag = $flsa_exempt
     let $salary_flag = $salaried 
     let $ft_pt_flag = $full_part
    
     If $salary_flag = 'Y'			        
        move &c.std_hours to #hrs_per_week !09.99       
     Else                                               
       Let $acct_cd = rtrim(&c.acct_cd,' ')    
	 If (rtrim(&C.UNION_CD,' ') = 'NON') And  ($acct_cd= '008' Or  $acct_cd= '009' Or $acct_cd= '100') 
           Let #hrs_per_week = &c.std_hours        
	 Else 
           let #hrs_per_week  = 0
        End-If                                 
     End-if                                    
                           
!  Else                            !NEW specs from Debbie on 05/10/2006                      
!    let $exempt_flag = ' '                             
!    let $salary_flag = ' '                             
!    let $ft_pt_flag  = ' '                                
!    let #hrs_per_week  = 0        !ISDVSRC                       
!  End-If                                            
                                                              
  !----------------------------------                         
  let $login_id     = $emplid                                 
  let $login_pword  = substr($emplid_main,6,4 )
  let $badge_nbr    = substr($emplid_main,6,4 ) !New requirment on 04/06/06 - earlier: $emplid      
  
  Do get-pay-period
  
  move &PROG.BENEFIT_PROGRAM to $ben_pgm
  
  Do get-check-dt
  Do get-pay-period

  move &C.STD_HOURS to #std_hrs
  
  ! Status Indicator
  let $STATUS_IND ='N'   

  !Schedule Type Code    !ISDVMXR 08/01/2007 added L, P and S 
  If (&c.empl_Status ='A' or &c.empl_Status ='L' or &c.empl_Status ='P' or &c.empl_Status ='S') 
    Let $SCHED_TYPE   = 'a'
  Else
    Let $SCHED_TYPE   = 'n' 
  End-If


  !EMPL_STATUS, EMPL_STATUS_LBL,GEX_VOLUNTARY_FLAG, GEX_EMPL_HIR_STS  

	 If (&c.empl_Status = 'A')
	    Let $EMPL_STATUS ='a'        
	    
	  Evaluate &C.ACTION
	   when = 'REH'
	    ! Let $EMPL_STATUS_LBL    = 'r' ! ITG # 37966 10/18/2006 Debbie Change from r to 'h' ***************************************
	    Let $EMPL_STATUS_LBL    = 'h'
	     Let $EXPECTED_RETURN_DT = ''
	     Let $GEX_VOLUNTARY_FLAG  = ' '
	     Let $GEX_EMPL_HIR_STS   = 'N'
	   break
	   when = 'RET'
	   when = 'RWP'
	     Let $EMPL_STATUS_LBL     = 'h' ! changed from 'w' on 04/25/06 DR spec on 05/28/07 uncommnted back 07/24/2007
	     !Let $EMPL_STATUS_LBL     = 'w' ! isdvmxr changed back to 'w' from 'h' based on DR spec on 05/28/07 Fix leaves commneted back 07/24/2007
	     Let $EXPECTED_RETURN_DT  = ''
	     Let $GEX_VOLUNTARY_FLAG  = 'Y'
	     Let $GEX_EMPL_HIR_STS   =  'N'
	   break
	   When = 'RFL' 
	    ! Let $EMPL_STATUS_LBL     = 'h' ! changed from 'w' on 04/25/06 
	    Let $EMPL_STATUS_LBL     = 'w' ! isdvmxr changed back to 'w' from 'h' based on DR spec on 05/28/07 Fix leaves added for RFL back 07/24/2007
	     Let $EXPECTED_RETURN_DT  = ''
	     Let $GEX_VOLUNTARY_FLAG  = ' '
	     Let $GEX_EMPL_HIR_STS   =  'N'
	     Break
	   When = 'HIR' 
	     Let $EMPL_STATUS_LBL     = 'h'
	     Let $EXPECTED_RETURN_DT  = ''
	     Let $GEX_VOLUNTARY_FLAG  = ' '
	     Let $GEX_EMPL_HIR_STS   =  'Y'
	     let $badge_nbr          = substr($emplid_main,6,4 ) !New requirment on 04/06/06 - earlier: $emplid      
	     Break
	   When = 'XFR' 
	     Let $EMPL_STATUS_LBL     = 'h'
	     Let $EXPECTED_RETURN_DT  = ''
	     Let $GEX_VOLUNTARY_FLAG  = ' '
	     Let $GEX_EMPL_HIR_STS   =  'N'
	     Break
	   When = 'ATO' 
	   When = 'BEN' 
	   When = 'COR' 
	   When = 'DEM' 
	   When = 'DTA' 
	   When = 'FSC' 
	   When = 'PAY' 
	   When = 'POS' 
	   When = 'PRO'    
	    Let $EMPL_STATUS_LBL     = 'h'   
	    Let $EXPECTED_RETURN_DT  = ''    
	    Let $GEX_VOLUNTARY_FLAG  = ' '   
	    Let $GEX_EMPL_HIR_STS   =  'N'   
	    Break
	   End-Evaluate
	 End-If   
	 !----------------------------------------------------
	 If (&c.empl_Status = 'L' or
	 	&c.empl_Status = 'P' or
	 	   &c.empl_Status = 'S')
	 
	 
	 Evaluate &C.ACTION	   
	   When = 'BEN' 
	   When = 'COR' 
	   When = 'DEM' 
	   When = 'DTA' 
	   When = 'FSC' 
	   When = 'PAY' 
	   When = 'POS' 
	   When = 'PRO'    
	   ! ISDVMXR Start - 20/06/2006 CSR 11034  added code based on Revised Spec*/
     When = 'XFR' 
     ! -ISDVMXR End - CSR 11034  added code based on Revised Spec*/
	   
	    Let $EMPL_STATUS	     = 'a'                    
	    Let $EMPL_STATUS_LBL     = 'h' ! changed from 'l' on 04/25/06 
	    Let $EXPECTED_RETURN_DT  = ''    
	    Let $GEX_VOLUNTARY_FLAG  = ' '   
	    Let $GEX_EMPL_HIR_STS    = 'N'   
	    Break
	
	   When = 'ATO'    
	    Let $EMPL_STATUS	     = 'i'
	    Let $EMPL_STATUS_LBL     = 'h' ! changed from 'l' on 04/25/06 
	    Let $EXPECTED_RETURN_DT  = ''    
	    Let $GEX_VOLUNTARY_FLAG  = ' '   
	    Let $GEX_EMPL_HIR_STS    = 'N'   
	    Break
	      
	   When = 'LOA'    
	   When = 'PLA'    
	   When = 'LTD'    
	    !Let $EMPL_STATUS	     = 'a' ! changed from 'i' on 04/25/06 
	    !Let $EMPL_STATUS_LBL     = 'h' ! changed from 'l' on 04/25/06 
	    Let $EMPL_STATUS	     = 'i' !  isdvmxr  changed back to 'i' from 'a' based on DR spec on 05/29/07 Fix leaves
	    Let $EMPL_STATUS_LBL     = 'l' ! isdvmxr changed back to 'l' from 'h' based on DR spec on 05/29/07 Fix leaves
	    Let $EXPECTED_RETURN_DT  = &B.EXPECTED_RETURN_DT    
	    Let $GEX_VOLUNTARY_FLAG  = ' '   
	    Let $GEX_EMPL_HIR_STS    = 'N'   
	    Break   
	  End-Evaluate
	 End-If   
	
	 !----------------------------------------------------
	 If (&c.empl_Status = 'T' or
	 	&c.empl_Status = 'U' or
	 	   &c.empl_Status = 'V')
         
	 Let $EMPL_STATUS  = 'i'                    
	 
	 Evaluate &C.ACTION	   
	   When = 'TWB' 
	    Let $EMPL_STATUS_LBL     = 's'   
	    Let $EXPECTED_RETURN_DT  = ''
	    Let $GEX_EMPL_HIR_STS    = 'N'   
	    
	       Evaluate &C.ACTION_REASON
	        when = 'LOF'
	          Let $GEX_VOLUNTARY_FLAG  = 'N'   
		break
		when-other
	      	  Let $GEX_VOLUNTARY_FLAG  = 'Y'
	      	  break
	        End-Evaluate
	   Break
	  When = 'TER' 
	  When = 'TWP' 
	  When = 'ATO' 
	  When = 'BEN' 
	  When = 'COR' 
	  When = 'DEM' 
	  When = 'DTA' 
	  When = 'FSC' 
	  When = 'PAY' 
	  When = 'POS' 
	  When = 'PRO' 
	   Let $EMPL_STATUS_LBL     = 's'   
	   Let $EXPECTED_RETURN_DT  = ''    
	   Let $GEX_VOLUNTARY_FLAG  = 'Y'   
	   Let $GEX_EMPL_HIR_STS    = 'N'   
	   Break
	  End-Evaluate
	 End-If

     
           If &c.empl_Status  = 'R' 
              Let $EMPL_STATUS = 'i'
               
               Evaluate &C.ACTION	
               When = 'RET' 
                   Let $EMPL_STATUS_LBL    = 's'
                   Let $EXPECTED_RETURN_DT = ''
                   Let $GEX_VOLUNTARY_FLAG = 'Y'
                   Let $GEX_EMPL_HIR_STS   = 'N'
                  Break
               When-Other
                  Let $EMPL_STATUS_LBL    ='s'                                     
                  Let $EXPECTED_RETURN_DT =''                                     
                  Let $GEX_VOLUNTARY_FLAG ='Y'                                     
                  Let $GEX_EMPL_HIR_STS   ='N'                                     
                  Break
               End-Evaluate
            End-If

     
     
    #debug show 'C.EMPL_STATUS ' &C.EMPL_STATUS
    
   
 If (&C.ACTION = 'XFR') or (&C.ACTION = 'ADL') or
    (&C.ACTION = 'DEM') or (&C.ACTION = 'DTA') or
    (&C.ACTION = 'PRO') or (&C.ACTION = 'REH')      
    Do determine-store-change
     
    !create E01 delete record for store transfers that are >= 14 days old only
    !If ($store_change = 'Y') and ($transfer_dt_dtu >= $reportdate_less14)
    If ($store_change = 'Y') and ($TRANSFER_DT_CMP >= $reportdate_cmp)
         !show 'transfer XXX'
       Do Find-New-Deptid
    End-if
 End-if

  #debug show '&D.SI_ACCIDENT_NUM *'  &D.SI_ACCIDENT_NUM 
   
 If &D.SI_ACCIDENT_NUM <> ' ' 
    Do Find-New-Deptid2        !This procedure calls - Do Insert-New-Data 
    			       !Which Insets rows into PS_GEX_SMTKNEW_W Table
    Do Find-New-Deptid3
 End-if


FROM PS_PERSONAL_DATA A,
       PS_EMPLOYMENT B,
       PS_JOB C,
       PS_DEPT_TBL D, 
       PS_BEN_PROG_PARTIC PROG,
       PS_PER_ORG_ASG_HP ASG,	!GEX-RBC added for HCM 9.0 Upgrade
       PS_GEX_EMPLID_MAPP M 
WHERE A.EMPLID      = B.EMPLID
   AND B.EMPLID      = C.EMPLID
!*****************************************************************
!GEX-RBC added for HCM 9.0 Upgrade-begin 								
!*****************************************************************
   !AND A.EMPLID = ASG.EMPLID
   !AND B.EMPLID = ASG.EMPLID
   AND C.EMPLID = ASG.EMPLID(+)
   !AND B.EMPL_RCD = ASG.EMPL_RCD
   AND C.EMPL_RCD = ASG.EMPL_RCD(+)
   !AND PROG.EMPL_RCD = ASG.EMPL_RCD
!******************************************************************
!GEX-RBC added for HCM 9.0 Upgrade- End	
!******************************************************************    
   AND B.EMPL_RCD    = C.EMPL_RCD
   and M.ssn         = C.emplid     
    !and C.empl_rcd    = C.empl_rcd   	!GEX-AXG Commented by Abhishek for unique constraint error 10/04/2007
   and M.empl_rcd    = C.empl_rcd   	!GEX-AXG Added by Abhishek for unique constraint error 10/04/2007   
   AND C.DEPTID      = D.DEPTID
   AND PROG.EMPLID   = C.EMPLID
   AND PROG.EMPL_RCD = C.EMPL_RCD
   AND C.EFFDT  = (SELECT MAX(EFFDT) FROM   PS_JOB WHERE EMPLID    = C.EMPLID
	  	   AND EMPL_RCD = C.EMPL_RCD AND EFFDT <= $X000_WHERE_SELECT_ASOFDATE)
   AND C.EFFSEQ = (SELECT MAX(EFFSEQ) FROM   PS_JOB  WHERE EMPLID    = C.EMPLID
	  	   AND EMPL_RCD = C.EMPL_RCD AND EFFDT    = C.EFFDT)
   AND D.EFFDT  = (SELECT MAX(EFFDT)FROM   PS_DEPT_TBL WHERE DEPTID = C.DEPTID
	  	  AND EFFDT <= $X000_WHERE_SELECT_ASOFDATE)
   AND PROG.EFFDT =  (SELECT MAX(EFFDT) 
         FROM PS_BEN_PROG_PARTIC
         WHERE PROG.EMPLID = EMPLID
         AND PROG.EMPL_RCD = EMPL_RCD
         AND PROG.COBRA_EVENT_ID = COBRA_EVENT_ID
         AND   EFFDT    <= $X000_WHERE_SELECT_ASOFDATE)
   And   [$GEXXX902_INCLUDE_DEPTID_CRITERIA]      ! isdvmxr test
!and C.deptid IN   ( '0002','0003','0004','0008','0009','0010','0025','0031','0033','0034','0038','0039','0041','0045','0052','0058','0059',
!                    '0060','0061','0063','0064','0065','0067','0070','0072','0074','0076','0077','0078','0081','3002','3008','3009','3010',
!                   '3034','3039''3041','3058','3060','3070','3352','3379','3535','3536','6379','6508','6510','6511','6514','6520','6535',
!                    '6536')

!AND   [$GEXXX903_INCLUDE_EMP_STAT_CRITERIA]
!and C.deptid ='W010'
and C.empl_status in ('A','L','P','S')     
!AND C.EFFDT BETWEEN '01-JUN-2004'  and '08-JUN-2006'
!and C.emplid in ( '272883028','144587108','145746208','172706509','187720658','234744780','236255472')! !	isdvmxr  testing 11/15/2007
!and A.emplid = '187720658'  
!AND M.EMPLID in ('1170643','1171530','1002534','1170567','1172369','1066239','1066944')          !	isdvmxr  testing
!AND M.EMPLID = ='1104191'
order by M.emplid

End-select

 If $found = 'N'
   add #1 to #errorcount
   !do error-found ('one')
   
 !    show 'No employees found for any store' 
 End-If

! show ' starting   Select-New-Data procedure from main ps tables '
!**********************************************************************
End-Procedure  Select-New-Data
!**********************************************************************

!*********************************************************************
!This procedure determines if there is a change in the stores for the 
!employee job rows in the table. The logic uses the previous job row 
!and the current row for the employee to determine the store change.
!*********************************************************************
begin-procedure determine-store-change
!**********************************************************************
move 'N' to $found
move 'N' to $store_Change
move 'N' to $errorfound

begin-select ON-ERROR=SQL-ERROR-FOUND('Determine-store-change')
P.DEPTID

   move 'Y' to $found
   if &P.DEPTID <> &C.DEPTID
      move 'Y' to $store_change
      move &P.DEPTID to $prev_dept_id
   end-if

from PS_JOB P
WHERE P.EMPLID = &A.EMPLID
  AND P.EMPL_RCD = &C.EMPL_RCD
  AND P.EFFDT = &C.EFFDT
  AND P.EFFSEQ = 
	(SELECT MAX(EFFSEQ)
	   FROM PS_JOB 
	  WHERE EMPLID = &A.EMPLID
	    AND EMPL_RCD = &C.EMPL_RCD
	    AND EFFDT = &C.EFFDT
	    AND EFFSEQ < &C.EFFSEQ)
  AND P.DEPTID in (select pp.deptid from ps_dept_tbl pp
                   where pp.si_accident_num <> ' ')
end-select

if $found = 'N'
   do get-prev-job-row
end-if
!**********************************************************************
end-procedure    determine-store-change
!**********************************************************************

!*********************************************************************
!This procedure retrieves the previous job row for the employee
!*********************************************************************
!**********************************************************************
begin-procedure get-prev-job-row
!**********************************************************************
move 'N' to $found
move 'N' to $store_change
move 'N' to $errorfound

begin-select ON-ERROR=SQL-ERROR-FOUND('get-prev-job-row')
R.DEPTID

   move 'Y' to $found
   if &R.DEPTID <> &C.DEPTID
      move 'Y' to $store_change
      move &R.DEPTID to $prev_dept_id
      do Convert-to-DTU-date(&C.EFFDT, $transfer_dt_dtu)
   end-if

from PS_JOB R
WHERE R.EMPLID = &A.EMPLID
  AND R.EMPL_RCD = &C.EMPL_RCD
  AND R.EFFDT =
	(SELECT MAX(EFFDT)
	   FROM PS_JOB
	  WHERE EMPLID = &A.EMPLID
	    AND EMPL_RCD = &C.EMPL_RCD
	    AND EFFDT < &C.EFFDT)
  AND R.EFFSEQ = 
	(SELECT MAX(EFFSEQ)
	   FROM PS_JOB
	  WHERE EMPLID = &A.EMPLID
	    AND EMPL_RCD = &C.EMPL_RCD
	    AND EFFDT = R.EFFDT)
  AND R.DEPTID in (select rr.deptid from ps_dept_tbl rr
                   where rr.si_accident_num <> ' ')
 

end-select

 
!**********************************************************************
end-procedure    get-prev-job-row
!**********************************************************************

!********************************************************************
!This procedure creates the E01 record for the employees whose records
!need to be deleted from the store files
!******************************************************************** 

!******************************************************************** 
begin-procedure Find-New-Deptid
!********************************************************************

  if $store_change = 'Y'
     move $prev_dept_id to $deptid
  else
     move &c.deptid to $deptid
  end-if
 
  if substr($deptid,4,1) = 'I'
     do convert-deptid($deptid,$new_deptid)
  else
     let $new_deptid = $deptid
  end-if
!**********************************************************************
end-procedure Find-New-Deptid
!**********************************************************************

!********************************************************************
!This procedure creates E02 records for the employees whose records
!need to be sent to the stores where they are working 
!********************************************************************
begin-procedure Find-New-Deptid2
!****************************************************************************
  #debug show ' starting Find-New-Deptid2 procedure          ' 
  
!********************************************************************
!Employee types need to be converted to CCS stores format before 
!sending the E02 records to the stores
!********************************************************************
   Do convert-empl-type
 
   !If $ccs_empl_type = 'P' or $ccs_empl_type = 'S'     !isdvsrc 09/14/05
   

   
   If &C.EMPL_TYPE = 'S'				
      Let #base_rate  = &C.ANNUAL_RT			
   Else
      let #base_rate = &C.HOURLY_RT
   End-If
   
   Do get-alt-rate    





   move #base_Rate to $base_rate
   move #alt_rate to $alt_Rate

   Do prefix_zeros($base_rate,$base_Rate_prefix)
   Do prefix_zeros($alt_Rate,$alt_Rate_prefix)
   Do get-division-code
   

   Do get-string-date(&B.SERVICE_DT, $hire_Dt_Str, $hire_date_ymd)      
   Do get-string-date(&A.BIRTHDATE, $birthdt_Str, $birthdt_ymd)

   !CJH - 02/05/1999 - begin
   !convert deptid like %I to original deptid
   move &C.DEPTID to $deptid
  
   If substr($deptid,4,1) = 'I'
     let $convert_deptid = substr($deptid,4,1)
     do convert-deptid($deptid,$new_deptid)
   Else
     let $new_deptid = $deptid
   End-If
   
   Do calc-minor-age   
   
   !CJH - 02/05/1999 - end

   move &C.EMPL_RCD to #empl_rcd
   move #empl_rcd to $empl_rcd
 
   Do Insert-New-Data    ! Insert into PS_GEX_SMTKNEW_W Table
   
   
  ! SHOW ' ENDING PROCEDURE   Find-New-Deptid2 '
!**********************************************************************
End-Procedure Find-New-Deptid2
!**********************************************************************

!*********************************************************************
!This creates the E04 record for the employees whose records need to 
!be sent to the stores where they are working along with the E02 records
!*********************************************************************
begin-procedure Find-New-Deptid3
!****************************************************************************
let $phone_cd = translate(&A.PHONE,'-','')
let $phone_cd = translate($phone_cd,'/','')
let $phone_cd = translate($phone_cd,' ','')
let $phone = lpad($phone_cd,10,'0')

! CJH - 02/05/1999 - begin
! max_hrs should be set to std_hrs from current job row
!let #max_hrs = 40
let #max_hrs = #std_hrs
! CJH - 02/05/1999 - end
move #max_hrs to $max_hrs
do prefix_zeros_no_dec($max_hrs,$max_hrs_prefix)

! CJH - 02/05/1999 - begin
! convert deptid like %I to original deptid
  move &C.DEPTID to $deptid
  if substr($deptid,4,1) = 'I'
     do convert-deptid($deptid,$new_deptid)
  else
     let $new_deptid = $deptid
  end-if
! CJH - 02/05/1999 - end

let $stat = &C.EMPL_STATUS
!**********************************************************************
end-procedure Find-New-Deptid3
!**********************************************************************

!********************************************************************
!This procedure converts employee types from people soft to CCS store
!format before sending the employee records to the CCS stores
!********************************************************************
Begin-procedure convert-empl-type
!****************************************************************************
 Evaluate &C.EMPL_TYPE
   when = 'E'
      If &C.PAYGROUP = 'PH4' or
         (&C.PAYGROUP = 'PHM' and &C.UNION_CD = 'NON')          
	 let $ccs_empl_type = 'P'
      Else
	 let $ccs_empl_type = 'H'
      End-If
      break
      
   when = 'H'
      If &C.PAYGROUP = 'PH4' or
         (&C.PAYGROUP = 'PHM' and &C.UNION_CD = 'NON')  
        let $ccs_empl_type = 'P'  !isdvmxr 06/28/2007        uncommented back   ccs sc prod issue
      Else                          !  isdvmxr 06/28/2007          ccs sc prod issue
	let $ccs_empl_type = 'H'
      End-if
      break
   when = 'S'
      let $ccs_empl_type = 'S'
      break
 End-Evaluate
!**********************************************************************
End-procedure convert-empl-type
!*********************************************************************

!*********************************************************************
!For Employees other than type 'P', need to get the additional pay 
!hourly rate from the ADDITIONAL record. If there is no additional record
!exists for the employee, uses the base rate as the alternate rate.
!*********************************************************************
begin-procedure get-alt-rate
!****************************************************************************
move 'N' to $found
move 'N' to $errorfound

begin-select ON-ERROR=SQL-ERROR-FOUND('Get-alt-rate')
I.HOURLY_RT

   move 'Y' to $found
   move &I.HOURLY_RT to #alt_rate

FROM PS_ADDL_PAY_DATA I
WHERE I.EMPLID = &A.EMPLID
  AND I.EMPL_RCD = &C.EMPL_RCD
  AND I.ERNCD IN( '176', '170')
  AND I.EFFDT = 
	(SELECT MAX(EFFDT)
	   FROM PS_ADDL_PAY_DATA
	  WHERE EMPLID = &A.EMPLID
	    AND EMPL_RCD = &C.EMPL_RCD
	    AND ERNCD IN( '176', '170'))
  AND I.ADDL_SEQ =
	 (SELECT MAX(ADDL_SEQ)
	    FROM PS_ADDL_PAY_DATA 
	   WHERE EMPLID = &A.EMPLID
	     AND EMPL_RCD = &C.EMPL_RCD
	     AND ERNCD IN( '176', '170')
	     AND EFFDT = I.EFFDT)
 and I.earnings_end_Dt is NULL	     
   

end-select




if $found = 'N'
    ! show 'Match not found : N, So assign base_rate to alt_rate'
   !move #base_rate to #alt_rate
   let #alt_rate = 0  ! new requirement
end-if
!**********************************************************************
end-procedure get-alt-rate
!**********************************************************************
!********************************************************************
!This procedure retrieves all the rows from DIVISION table for the 
!selected contract group and attempts to find the division code for 
!the employee where the business rules are satisfied
!********************************************************************
!****************************************************************************
begin-procedure get-division-code
 ! show ' START  Entered into  get-division-code '
!****************************************************************************
move 'N' to $errorfound
move 'N' to $found

begin-select ON-ERROR=SQL-ERROR-FOUND('Get-Division-code')
L.GEX_CONTRACT_GRP
L.GEX_SEQ_NUM
L.GEX_DIVISION_CD
L.GEX_UNION_CD
L.FULL_PART_TIME
L.GEX_STUDENT_IND
L.GEX_DEPTID
L.GEX_JOBCODE
L.GEX_PAY_TYPE
L.GEX_AFTER_HIRE_DT
L.GEX_BEFORE_HIRE_DT
L.GEX_AFTER_PERS_DT
L.GEX_BEFORE_PERS_DT
L.GEX_HIRE_DT_OPER
L.GEX_CONTRACT_DT
L.GEX_SERV_DT_OPER
L.GEX_SERVICE_DAYS
L.GEX_BC_PAY_RULE    

      move 'Y' to $found
      move ' ' to $division_cd
      
      ! SHOW '    L.GEX_DIVISION_CD  ==============================' &L.GEX_DIVISION_CD
      ! SHOW '    L.GEX_BC_PAY_RULE  ============================= ' &L.GEX_BC_PAY_RULE 
      ! show '    L.GEX_SEQ_NUM      ==============================' &L.GEX_SEQ_NUM
     
   
    ! show ' calling    find-division-code  find-division-code  find-division-code  find-division-code  find-division-code'
      do find-division-code
      if $match-found = 'Y'
 !        show '$match-found   = Y           IN get-division-code  = ' $division_cd
        !  show 'division code             ===============================               =' $division_cd
	 exit-select
      end-if 

FROM PS_GEX_DIV_TBL L

WHERE L.GEX_CONTRACT_GRP = &D.SI_ACCIDENT_NUM

ORDER BY L.GEX_SEQ_NUM

end-select

  if $found = 'N'
     add 1 to #errorcount
     !do error-found ('two')
     print 'No match found for the Contract Number in Division table:' (,132)
     print &d.si_Accident_num ()
  else
     if $match-found = 'N'
        add 1 to #errorcount
        !do error-found !('Three')
        print 'No Division Code found' (,132)
     end-if
  end-if
  !show 'END    get-division-code '
end-procedure get-division-code
!**********************************************************************
!*********************************************************************
!This procedure tries to match every non-null column with the source
!values and if everything matches, passes that row's division code 
!as the employee division code
!*********************************************************************
!****************************************************************************   
begin-procedure find-division-code
!****************************************************************************
 !   show ' start begin-procedure find-division-code **************** '

move 'Y' to $match-found   
move 'N' to $errorfound

        
if RTRIM(&L.GEX_UNION_CD,' ') <> ''
   ! SHOW  'IN L.GEX_UNION_CD '  &L.GEX_UNION_CD '/' &C.UNION_CD
   if &L.GEX_UNION_CD <> &C.UNION_CD  !JNB 01/25/00
!      print 'No match for union code' ()
      move 'N' to $match-found
      goto skip-match
   end-if
end-if

if RTRIM(&L.FULL_PART_TIME,' ') <> ''
  ! SHOW 'IN L.FULL_PART_TIME ' &L.FULL_PART_TIME '/' &C.FULL_PART_TIME
   if &L.FULL_PART_TIME <> &C.FULL_PART_TIME
    
!      print 'No match for Full/Part Status' ()      
      move 'N' to $match-found
      goto skip-match
   end-if
end-if

if RTRIM(&L.GEX_STUDENT_IND,' ') <> ''
  ! SHOW 'IN L.GEX_STUDENT_IND ' &L.GEX_STUDENT_IND '/' &C.GEX_STUDENT_IND
   if &L.GEX_STUDENT_IND <> &C.GEX_STUDENT_IND
!      print 'No match for Student Indicator' ()      
      move 'N' to $match-found
      goto skip-match
   end-if
end-if

if RTRIM(&L.GEX_DEPTID,' ') <> ''
 ! SHOW 'IN L.GEX_DEPTID '  &L.GEX_DEPTID '/' &C.ACCT_CD
   if &L.GEX_DEPTID <> &C.ACCT_CD
!      print 'No match for Store id' ()
      move 'N' to $match-found
      goto skip-match
   end-if
end-if

if RTRIM(&L.GEX_JOBCODE,' ') <> ''
! CJH - 02/05/1999 - begin
!   if &L.GEX_JOBCODE <> &C.ACCT_CD
  ! SHOW 'IN L.GEX_JOBCODE '  &L.GEX_JOBCODE '/' &C.JOBCODE
   if &L.GEX_JOBCODE <> &C.JOBCODE
! CJH - 02/05/1999 - end
!      print 'No match for Job code ' ()
      move 'N' to $match-found
      goto skip-match
   end-if
end-if

if RTRIM(&L.GEX_PAY_TYPE,' ') <> ''

 !SHOW 'IN L.GEX_PAY_TYPE ' &L.GEX_PAY_TYPE '/' $ccs_empl_type
   if &L.GEX_PAY_TYPE <> $ccs_empl_type
!      print 'No match for Pay type' ()
      move 'N' to $match-found
      goto skip-match
   end-if
end-if
 
      !show ' L.GEX_AFTER_HIRE_DT'&L.GEX_AFTER_HIRE_DT
 if RTRIM(&L.GEX_AFTER_HIRE_DT,' ') <> ''
 
! show ' in RTRIM(&L.GEX_AFTER_HIRE_DT <> 0 '   &L.GEX_AFTER_HIRE_DT
    do get-string-date(&L.GEX_AFTER_HIRE_DT, $after_hire_str_date, $after_hire_Date_ymd)
    do get-string-date(&B.SERVICE_DT, $hire_Dt_Str, $hire_date_ymd)      !SCM 02/07/2002
    let $appoint_str_date = $appoint_end_dt
   
   !show '$appoint_str_date = $appoint_end_dt  ' $appoint_str_date 
  ! Do get-string-date(&B.APPOINT_END_DT, $appoint_Dt_Str, $appoint_Date_ymd)  !GEX-RBC commented for HCM 9.0 Upgrade
   Do get-string-date(&ASG.APPOINT_END_DT, $appoint_Dt_Str, $appoint_Date_ymd)	!GEX-RBC added for HCM 9.0 Upgrade
  ! show '$appoint_Dt_Str' $appoint_Dt_Str
     !show '$appoint_Date_ymd  = ' $appoint_Date_ymd
      ! SHOW 'IN GEX_AFTER_HIRE_DT ' $hire_Date_ymd '/'  $after_hire_Date_ymd
       !IF &B.APPOINT_END_DT <> ''     !isdvmxr    div issue   !GEX-RBC commented for HCM 9.0 Upgrade
       	IF &ASG.APPOINT_END_DT <> ''			!GEX-RBC added for HCM 9.0 Upgrade
         If $appoint_Date_ymd < $after_hire_Date_ymd   !vendvkv itg 37966 06/15/2007
           !SHOW '$appoint_Date_ymd < $after_hire_Date_ymd ' $appoint_Date_ymd 
               ! if $hire_Date_ymd < $after_hire_Date_ymd
              move 'N' to $match-found
             !  show '$appoint_Date_ymd < $after_hire_Date_ymd ' $match-found
              goto skip-match
         end-if
         ELSE               !isdvmxr    div issue
           If  $hire_Date_ymd < $after_hire_Date_ymd  !isdvmxr
             ! SHOW ' $hire_Date_ymd < $after_hire_Date_ymd '$hire_Date_ymd
        
          move 'N' to $match-found
        ! show '$hire_Date_ymd < $after_hire_Date_ymd ' $match-found
        goto skip-match
      END-IF
   End-if
 end-if


 ! show ' &L.GEX_BEFORE_HIRE_DT  ' &L.GEX_BEFORE_HIRE_DT
 If RTRIM(&L.GEX_BEFORE_HIRE_DT,' ') <> ''
 !show ' in RTRIM(&L.GEX_BEFORE_HIRE_DT <> 0 '   &L.GEX_BEFORE_HIRE_DT
    Do get-string-date(&L.GEX_BEFORE_HIRE_DT, $before_hire_str_date, $before_hire_Date_ymd)
   Do get-string-date(&B.SERVICE_DT, $hire_Dt_Str, $hire_date_ymd)      !SCM 02/07/2002  isdvmxr
   ! Do get-string-date(&B.APPOINT_END_DT, $appoint_Dt_Str, $appoint_Date_ymd)  !GEX-RBC commented for HCM 9.0 Upgrade
    Do get-string-date(&ASG.APPOINT_END_DT, $appoint_Dt_Str, $appoint_Date_ymd) !GEX-RBC added for HCM 9.0 Upgrade
   !  show $appoint_Date_ymd                                    ' / '                  $before_hire_Date_ymd
     
    ! IF &B.APPOINT_END_DT <> ''            !isdvmxr    div issue  !GEX-RBC commented for HCM 9.0 Upgrade
    IF &ASG.APPOINT_END_DT <> '' 	 !GEX-RBC added for HCM 9.0 Upgrade
        if $appoint_Date_ymd > $before_hire_Date_ymd
           !  SHOW '$appoint_Date_ymd > $before_hire_Date_ymd ' $appoint_Date_ymd 
             move 'N' to $match-found
            !  show '$appoint_Date_ymd > $before_hire_Date_ymd  ' $match-found
             goto skip-match
          END-IF 
        ELSE              !isdvmxr    div issue
           If $hire_Date_ymd > $before_hire_Date_ymd  !isdvmxr
           !   SHOW ' $hire_Date_ymd > $before_hire_Date_ymd '$hire_Date_ymd
        
          move 'N' to $match-found
       !  show '$hire_Date_ymd > $before_hire_Date_ymd ' $match-found
        goto skip-match
      END-IF
   End-if
 End-if



 ! show      ' in &L.GEX_AFTER_PERS_DT          ' &L.GEX_AFTER_PERS_DT
if RTRIM(&L.GEX_AFTER_PERS_DT,' ') <> ''
   do get-string-date(&L.GEX_AFTER_PERS_DT, $after_pers_str_date, $after_pers_date_ymd)

! if CMPNY_SENIORITY_DT is null, use HIRE_DT
   if &B.CMPNY_SENIORITY_DT = ''
      do get-string-date(&B.HIRE_DT, $seniority_date_str, $seniority_date_ymd)
   else
      do get-string-date(&B.CMPNY_SENIORITY_DT, $seniority_date_str, $seniority_date_ymd)
   end-if
   ! SHOW 'IN CMPNY_SENIORITY_DT  ' $seniority_Date_ymd '/' $after_pers_Date_ymd
   if $seniority_Date_ymd < $after_pers_Date_ymd
      move 'N' to $match-found
      goto skip-match
   end-if
end-if

                                                                              
       ! show      ' in &L.GEX_BEFORE_PERS_DT          ' &L.GEX_BEFORE_PERS_DT 
if RTRIM(&L.GEX_BEFORE_PERS_DT,' ') <> ''
   do get-string-date(&L.GEX_BEFORE_PERS_DT, $before_pers_str_date, $before_pers_date_ymd)
  !if CMPNY_SENIORITY_DT is null, use HIRE_DT
   if &B.CMPNY_SENIORITY_DT = ''
      do get-string-date(&B.HIRE_DT, $seniority_date_str, $seniority_date_ymd)
   else
      do get-string-date(&B.CMPNY_SENIORITY_DT, $seniority_date_str, $seniority_date_ymd)
   end-if
    ! SHOW ' IN GEX_BEFORE_PERS_DT '$seniority_Date_ymd '/' $before_pers_Date_ymd
   if $seniority_Date_ymd > $before_pers_Date_ymd
!      print 'No match for seniority dates' ()
      move 'N' to $match-found
      goto skip-match
   end-if
end-if
 ! show   'in          &L.GEX_HIRE_DT_OPER  '  &L.GEX_HIRE_DT_OPER
if RTRIM(&L.GEX_HIRE_DT_OPER,' ') <> ''
   if RTRIM(&L.GEX_CONTRACT_DT,' ') <> ''
     do get-string-date(&L.GEX_CONTRACT_DT, $contract_str_date, $contract_Date_ymd)
     do get-string-date(&B.SERVICE_DT, $hire_Dt_Str, $hire_date_ymd)      !SCM 02/07/2002

     if (&L.GEX_HIRE_DT_OPER = 'GT') or (&L.GEX_HIRE_DT_OPER = 'GE')
         !SHOW 'IN GEX_HIRE_DT_OPER '  $hire_date_ymd '/' $contract_Date_ymd
        if $hire_date_ymd < $contract_Date_ymd
           move 'N' to $match-found
           goto skip-match
        end-if
     else
           ! show         '  $hire_date_ymd > $contract_Date_ymd  '   $hire_date_ymd  '/'         $contract_Date_ymd   
        if $hire_date_ymd > $contract_Date_ymd
           move 'N' to $match-found
	   goto skip-match
        end-if
     end-if           
   end-if
end-if

        !  show 'after all div code ' $match-found 
 
 if RTRIM(&L.GEX_SERV_DT_OPER,' ') <> ''
if RTRIM(&L.GEX_SERVICE_DAYS,' ') <> ''
 
   
    move &L.GEX_SERVICE_DAYS to #gex_service_Days 



   if RTRIM(&B.SERVICE_DT, ' ') <> ''

         do get-the-difference

             if (&L.GEX_SERV_DT_OPER = 'GT')  or (&L.GEX_SERV_DT_OPER = 'GE')
      
       	!New Requirement Start 04/10/06
 	
  !    	show '#diff_days            :' #diff_days 
  !    	show '#GEX_SERVICE_DAYS     :' #GEX_SERVICE_DAYS 	
 
 	
 	
 	If #diff_days > #GEX_SERVICE_DAYS 	
      
 	
 		
 	  !If an EE has crossed his Anniversary, then use the
 	  !STATUS_DT as the date of the job 659 ran 
 	  Let $STATUS_DATE    = $X000_WHERE_SELECT_ASOFDATE    
 	  !SHOW '    IN    #diff_days > #GEX_SERVICE_DAYS    '   $STATUS_DATE
 	  
 	 ! show '********************* $STATUS_DATE   **********'$STATUS_DATE
 	  Let $EE_Reached_Anniversary = 'Y'
!	  show 'EE reached Anniversary:' $emplid_main
	End-If
	!New Requirement End  04/10/06
	

	if #diff_days < #GEX_SERVICE_DAYS
!	 show 'EE did not reach Anniversary:' $emplid_main
	   move 'N' to $match-found
	   goto skip-match
	end-if
      else
	if #diff_days > #GEX_SERVICE_DAYS
          move 'N' to $match-found
	   goto skip-match
	end-if
      end-if 
   else
      move 'N' to $match-found
      goto skip-match
   end-if
 end-if
end-if
 !        show ' reached end of the line  match found is still '   $match-found
skip-match:

 If $match-found = 'Y'
    
   move &L.GEX_DIVISION_CD to $division_cd
   move &L.GEX_BC_PAY_RULE  to $GEX_BC_PAY_RULE  
   
   Let $GEX_BC_PAY_RULE =  LTRIM(RTRIM($GEX_BC_PAY_RULE, ' '), ' ')
   
   If $GEX_BC_PAY_RULE =''
     Let $GEX_BC_PAY_RULE = ' '
   End-If
   
!    show '$match-found =Y'
!    show '$division_cd     :' $division_cd
!    show '$GEX_BC_PAY_RULE :' $GEX_BC_PAY_RULE   VENDKXY
 Else
!     show 'Match Not Found ' 	    VENDKXY
end-if
!show ' end begin-procedure find-division-code  '
!****************************************************************************
end-procedure   find-division-code
!****************************************************************************


!****************************************************************************
begin-procedure calc-minor-age
!****************************************************************************
  !find $blue_empl_type
  !find $Punch_Rule

  Do convert-to-dtu-date(&A.birthdate,$birthDate_dtu) 
  
  Do dtu-diff-years($birthdate_dtu,$reportdate_dtu,#age_years)
      
  If #age_years >= 18
     let $blue_empl_type = 'a'
     !If an employee is an adult (18 years old +) their punch rule is simply their 4 digit store number - 0067  6535  etc
     
       If $salary_flag = 'Y'
        Let $Punch_Rule = 'SALARIED'
       Else
        Let $Punch_Rule = $deptid 
       End-If 
  Else	  
      let $blue_empl_type = 'm'
         
      Evaluate #age_years
        when > 15			  
         If $salary_flag = 'Y'
           Let $Punch_Rule = 'SALARIED'
          Else
           Let $Punch_Rule =  &state || '_MINOR_16_17'
         End-If 
          break			  
          
        when > 13		
         If $salary_flag = 'Y'
           Let $Punch_Rule = 'SALARIED'
         Else	  
          Let $Punch_Rule = &state || '_MINOR_14_15'
         End-If 
         break		
         	  
        when-other
        break 
     End-Evaluate                        
  End-if
!**************************************************************************** 
End-procedure calc-minor-age
!****************************************************************************

!*********************************************************************
!This procedure determines whether an employee is at manager level.
!*********************************************************************
Begin-procedure get-mgr-level
!****************************************************************************
begin-select
jc.MANAGER_LEVEL

  If &jc.manager_level = '99'
    let $mgr_flag = 'N'
    let $mgr_sched_flag = 'N'
    let $mgr_pword = ''
    Let $Role_Id = 'Employee'
    If &c.jobcode ='40087' !ITG # 37966 ISDVMXR 10/18/2006 
      Let $Role_Id = 'Payroll Clerk'
     end-if   !ITG # 37966 ISDVMXR 10/18/2006 
  Else 
    !isdvsrc 08/31
    Evaluate &jc.MANAGER_LEVEL
    when ='9'
      Let $Role_Id = 'GE Store Director'
     break
    when ='10'
      Let $Role_Id = 'GE Store Manager'
     break
    when ='11'
    !when ='07'         !ISDVMXR  07/11/2006 based on Debbie input added code   
      when ='7'         !ISDVMXR  11/15/2007 based on Debbie input fix   
       If &c.jobcode ='10026'
         Let $Role_Id = 'HR Manager'
        break             
       Else
	 Evaluate &C.ACCT_CD
	  when ='001'
	   Let $Role_Id = 'Grocery Manager'
	   break
	  when ='002'
	   Let $Role_Id = 'Prepared Foods Manager'
	   break
	  when ='003'
	   Let $Role_Id = 'Deli Manager'
	   break
	  when ='004'
	   Let $Role_Id = 'Produce Manager'
	   break
	  when ='005'
	   Let $Role_Id = 'Meat Manager'
	   break
	  when ='006'
	   Let $Role_Id = 'Floral Manager'       
 	   break
	  when ='007'
	   Let $Role_Id = 'Bakery Manager'       
	   break
	  when ='008'
	   Let $Role_Id = 'Pharmacy Manager'       
	   break
	  when ='009'
	   Let $Role_Id = 'Photo Lab Manager'       
	   break
	  when ='015'
	   Let $Role_Id = 'Entertainment Manager'       
	   break
	  when ='023'
	   Let $Role_Id = 'Seafood Manager'       
	   break
	  when ='041'
	   Let $Role_Id = 'Fuel Manager'       
	   break
	  when ='100'
	   Let $Role_Id = 'Eagles Nest Manager'       
	   break
	  when ='104'
	   Let $Role_Id = 'Front End Manager'
	   break
	!  when ='104'   commented out as duplicate
	!   Let $Role_Id = 'Front End Manager'
	!   break    
	  when-other
	   Let $Role_Id = 'Employee'
	   break
	 End-evaluate 
         break
     End-If 
   when-other
    Let $Role_Id = 'Employee'
    break    
   End-evaluate 
    !isdvsrc 08/31
  ! ISDVMXR 07/20/2006  new change requested to blank out role_id if the action != HIR OR REH
  !asked to comment out 08/04/2006
  !show '###########################'  &C.ACTION
   !  if (&C.ACTION != 'HIR') or  (&C.ACTION !='REH') 
   !    LET  $Role_Id = ''
    !   show '$Role_Id =  ============================='  $Role_Id 
    ! end-if
  ! ISDVMXR 07/25/2006  CODE COMPLETE
    
    let $mgr_flag = 'Y'
    let $mgr_sched_flag = 'Y'
    let $mgr_pword = substr($emplid_main,6,4 )
  End-if

from ps_jobcode_tbl jc
where  JC.SETID            = 'COMMN'
And    JC.JOBCODE          = $JOBCODE
And    JC.EFF_STATUS       = 'A'
And    JC.EFFDT            =
      (Select Max(EFFDT)
       From   PS_JOBCODE_TBL
       Where SETID       = JC.SETID
       And  JOBCODE      = JC.JOBCODE
       And  EFF_STATUS   = JC.EFF_STATUS
       And  EFFDT       <= $X000_WHERE_SELECT_ASOFDATE)

end-select
!****************************************************************************
end-procedure  get-mgr-level
!****************************************************************************

!****************************************************************************
!This procedure retrieves the days difference between two dates
!****************************************************************************
Begin-procedure get-the-difference
!****************************************************************************
  Do convert-to-dtu-date(&B.SERVICE_DT, $service_Date_dtu)

 !do MakeYear4Digits ($service_dt_yy)
  move $service_Date_dtu to $service_Dt_ccyy
  Do dtu-diff-days($service_Dt_ccyy, $reportdate_ccyy, #diff_Days)
  
   !SHOW '   IN            get-the-difference    '  #diff_Days
  move #diff_days to $diff_Days
   !SHOW 
!****************************************************************************
End-procedure get-the-difference
!****************************************************************************
!***********************************************************************
! Convert DEPT ids that end in 'I' to the original deptid
!***********************************************************************
begin-procedure convert-deptid($deptid_in, :$deptid_out)
!****************************************************************************
 let $found = 'N'
begin-SELECT
GDT.DEPARTMENT
 
   let $deptid_out = &GDT.DEPARTMENT
   let $found = 'Y'

From PS_GEX_DEPT_TBL GDT
where GDT.deptid = $deptid_in
end-SELECT

 if $found = 'N'
    display 'Department ID unable to be converted: ' noline
    display $deptid_in
    !do error-found !('Four')
 end-if
!**************************************************************************** 
end-procedure convert-deptid($deptid_in, :$deptid_out)
!****************************************************************************

!****************************************************************************
begin-procedure get-check-dt
!****************************************************************************
  !show 'gexpy659.get-check-dt'
Begin-Select
Max(cal.check_dt) &check_dt

  Let $check_dt = &check_dt
  do Convert-to-DTU-date($check_dt, $check_dt_dtu)

  let $check_dt_min_dbf = '01'||substr($check_dt,3,9)
  let $check_dt_max_dbf = $check_dt
  let $checkdt_yy = substr($check_dt_dtu,1,4)
  let $checkdt_mm = substr($check_dt_dtu,6,2)

From   ps_pay_calendar cal

Where  cal.pay_end_dt <= $X000_Where_Select_AsOfDate
and    cal.company = $company
and    cal.paygroup = $paygroup
And    cal.pay_confirm_run = 'Y'
End-Select
!****************************************************************************
end-procedure get-check-dt
!****************************************************************************

!****************************************************************************
begin-procedure get-pay-period
!****************************************************************************
  !show 'gexpy659.get-pay-period'
!***********************************************************************
!  Need to determine the number of pay periods for the BP's Company
!   and Paygroup specifically
!***********************************************************************
Begin-select on-error=sql-error-found('get-pay-period')

DISTINCT(MAX(PC.PAY_PERIOD)) &pay_period


    move &pay_period to #pay_period
    move #pay_period to $pay_Period 9
  if #pay_period > 0
    move 'Y' to $found
  end-if

FROM PS_PAY_CALENDAR PC

WHERE PC.CHECK_DT >= $check_dt_min_dbf 
  AND PC.CHECK_DT <= $check_Dt_max_dbf 
  AND PC.PAY_OFF_CYCLE_CAL = 'N'
  AND PC.COMPANY = $Company
  AND PC.PAYGROUP = $Paygroup
end-select

if $found = 'N'
   !do error-found !('Five')
   print 'No Pay Period Data found for the previous month in pay_calendar table' (,34)
end-if   
!****************************************************************************   
end-procedure  get-pay-period
!****************************************************************************


!****************************************************************************
!This procedure takes the database format date and gives back date in 
!mm/dd/yyyy and yyyymmdd formats
!****************************************************************************
!****************************************************************************
Begin-procedure get-string-date($date, :$str_date_mdy, :$str_Date_ymd)
!****************************************************************************
 Do format-datetime($date,$str_date_mdy,{DEFMDY},'','')

 let $date_dd_mm = substr($str_Date_mdy,1,2)
 !let $date_dd_yyyy = substr($str_Date_mdy,7,2)    JNB 08/13/1999
 let $date_dd_yyyy = substr($date,8,4)            !JNB 08/13/1999 
 let $date_dd_dd = substr($str_date_mdy,4,2)
  !display '$date_dd_yyyy ' noline                  JNB 08/13/1999
  !display $date_dd_yyyy                            JNB 08/13/1999
  !do MakeYear4Digits($date_Dd_yyyy)                JNB 08/13/1999
 let $str_Date_mdy = $date_dd_mm||'/'||$date_dd_dd||'/'||$date_dd_yyyy
  !do format-datetime($date,$str_date_ymd,{DEFCMP},'','')
 let $str_Date_ymd = $date_dd_yyyy||$date_dd_mm||$date_dd_dd
!****************************************************************************
End-procedure
!****************************************************************************

!********************************************************************
!This procedure prefixes the string values with zeros as the CCS 
!format of base rate and alternate rate needs to be
!********************************************************************
!****************************************************************************
Begin-procedure prefix_zeros($string,:$string_prefix)
!****************************************************************************
 UNSTRING $string BY '.' INTO $string_int $string_after_Dec
 move 0 to #string_int_len

 let #string_int_len = length($string_int)

 while #string_int_len < 5
   let $string_prefix = '0'||$string_int
   move $string_prefix to $string_int
   add 1 to #string_int_len
 end-while

 move $string_int to $string_prefix

 let $string_after_Dec2 = substr($string_After_Dec,1,2)
 let $string_prefix = $string_prefix||'.'||$string_after_dec2

End-procedure
!****************************************************************************

!********************************************************************
!This procedure takes a numeric value with no decimals and prefixes
!it with zeros.
!********************************************************************

Begin-procedure prefix_zeros_no_Dec($string_no_Dec,:$string_prefix_no_dec)
 move 0 to #string_int_len
 let #string_int_len = length($string_no_Dec)

 While #string_int_len < 4
  let $string_prefix_no_Dec = '0'||$string_no_Dec
  move $string_prefix_no_Dec to $string_no_Dec
  add 1 to #string_int_len
 End-while
 
 move $string_no_Dec to $string_prefix_no_Dec
!**************************************************************************** 
End-procedure
!****************************************************************************

!*****************************************************************************
Begin-Procedure Insert-New-Data
!*****************************************************************************
  #debug show 'Entered into Insert-New-Data'
 
  If $badge_nbr    = ''
   Let $badge_nbr  = ' '
  End-If
 
  Let #ben_cost     = 0  
  Let #vac_accr_bal = 0  
 
      Do get-weekly-ben-hrs    
      Do get-shift-strgy-code  
 #debug show '$errorfound2    :' $errorfound2
 #debug show '$found2         :' $found2      
 #debug show '$match-found2   :' $match-found2
 #debug show '$GEX_SHIFT_STRGY:' $GEX_SHIFT_STRGY !VENDKXY
 
 If $GEX_SHIFT_STRGY = '' or $match-found2 = 'N'
 #debug show ' $shift-strgy-found is N, assign default: GE01-FT '
  Let $GEX_SHIFT_STRGY = 'GE01-FT'
 End-If

 If $EE_Reached_Anniversary = 'Y' 
  Add 1 to #EE_Reached_Anniversary_Y
  let $STATUS_IND ='X'        !Do not process these rows - let debbie verify and then process
 Else
  Add 1 to #EE_Reached_Anniversary_N
  let $STATUS_IND ='N'   
 End-If
 
   If $ft_pt_flag = 'F' 
      Let $ft_pt_flag = 'Y'
   Else
      Let $ft_pt_flag = 'N'
   End-If

 #ifdef debug8
    SHOW '*********************************************'
    show '              $job_emplid     ' $job_emplid 
    SHOW 'EMPLID        $emplid         ' $emplid     
    SHOW 'EMPL_RCD      $job_empl_rcd   ' #job_empl_rcd 
    SHOW 'COMPANY       $company        ' $company      
    SHOW 'PAYGROUP      $paygroup       ' $paygroup     
    SHOW 'NEW_DEPTID    $new_deptid     ' $new_deptid     
    SHOW 'LAST_NAME     $last_name      ' $last_name      
    SHOW 'FIRST_NAME    $first_name     ' $first_name     
    SHOW 'BIRTH_DT      &A.BIRTHDATE    ' &A.BIRTHDATE   
    SHOW 'HIRE_DT                       ' $HIRE_DT 	   
    SHOW 'FLAG          $mgr_flag       ' $mgr_flag       
    SHOW 'PASSWORD      $mgr_pword      ' $mgr_pword      
    SHOW 'LOGIN_ID      $login_id       ' $login_id       
    SHOW 'LOGIN_PWD     $login_pword    ' $login_pword    
    SHOW 'EMPL_TYPE     $blue_empl_type ' $blue_empl_type 
    SHOW 'BADGE_NBR     $badge_nbr      ' $badge_nbr      
    SHOW 'SCHEDULE_FLAG $mgr_sched_flag ' $mgr_sched_flag 
    SHOW 'EXCEPTION_FLAG$excep_flag     ' $excep_flag     
    SHOW 'ALERTSTATUS   $alert_flag     ' $alert_flag       
    SHOW 'DEPTID        $deptid         ' $deptid         
    SHOW 'ADDRESS1      $address1       ' $address1       
    SHOW 'ADDRESS2      $address2       ' $address2       
    SHOW 'CITY          $city           ' $city           
    SHOW 'ZIP           $zip            ' $zip            
    sHOW 'PHONE1        $phone          ' $phone          
    SHOW 'PHONE2        $cell_phone     ' $cell_phone     
    SHOW 'PAGER_NBR     $pager          ' $pager          
    SHOW 'STATE         $state          ' $state          
    SHOW 'COUNTRY       $country        ' $country        
    SHOW 'JOBID         $job            ' $job            
    SHOW '#base_rate                    > ' #base_rate 
    show '#alt_Rate                     > ' #alt_Rate
    SHOW 'EXEMPT_FLAG   $exempt_flag    ' $exempt_flag    
    SHOW 'SALARY_FLAG   $salary_flag    ' $salary_flag    
    SHOW 'FULL_PART_TIME$ft_pt_flag     ' $ft_pt_flag     
    SHOW 'HOURS_PER_WEEK#hrs_per_week   ' #hrs_per_week
    SHOW 'DIVISION      $division_Cd    ' $division_Cd    
    SHOW 'BENEFIT_HRS   $ben_hrs        ' #ben_hrs        
    SHOW 'VAC_ACCR_BAL  $vac_accr_bal   ' #vac_accr_bal   
    show 'GEX_BC_PAY_RULE               ' $GEX_BC_PAY_RULE 
    SHOW 'GEX_SHIFT_STRGY               ' $GEX_SHIFT_STRGY
    SHOW 'GEX_EMPL_HIR_STS              ' $GEX_EMPL_HIR_STS
    SHOW 'STATUS_IND                    ' $STATUS_IND
    show '$Role_Id                      ' $Role_Id 
    show '$Punch_Rule                   ' $Punch_Rule 
    SHOW 'EMPL_STATUS                   ' $EMPL_STATUS            
    SHOW 'EMPL_STATUS_LBL        	' $EMPL_STATUS_LBL        
    SHOW 'STATUS_DT              	' $STATUS_DATE  
    !&C.EFFDT
    SHOW 'EXPECTED_RETURN_DT     	' $EXPECTED_RETURN_DT     
    SHOW 'SCHED_TYPE                    ' $SCHED_TYPE     
    SHOW 'GEX_VOLUNTARY_FLAG     	' $GEX_VOLUNTARY_FLAG     
    SHOW '*********************************************'
 #endif
 
 
 !Start: ISDVSRC 03/08/2006
 ! we will be comparing deptid on HLD vs NEW tables using the below procedures
 !  Do Get-Old-Jobid-Dept-HrlyRt
 !  Do Get-New-Jobid-Dept-HrlyRt 
 ! and then determine whether the DEPTID is changed, But for now, use $new_deptid as nothing
 !And this will always be nothing on HLD ,NEW,MNT,FNL tables
 !Changes are inserted  directly into B table 
 
  Let $new_deptid = ' ' 
 
 !End ISDVSRC 03/08/2006
 



begin-SQL ON-ERROR=SQL-Error-Found('Insert-Gex-Table')
insert into PS_GEX_SMTKNEW_W
(
EMPLID                 ,    
EMPL_RCD               ,        
COMPANY                ,        
PAYGROUP               ,        
NEW_DEPTID             ,            
LAST_NAME              ,        
FIRST_NAME             ,         
BIRTH_DT               ,               
HIRE_DT                ,      
SENIORITY_DATE         ,        
FLAG                   ,         
MGR_PWD                ,         
LOGIN_ID               ,         
LOGIN_PWD              ,         
EMPL_TYPE              ,         
BADGE_NBR              ,         
SCHEDULE_FLAG          ,         
EXCEPTION_FLAG         ,         
ALERTSTATUS            ,         
DEPTID                 ,         
ADDRESS1               ,         
ADDRESS2               ,         
CITY                   ,        
ZIP                    ,        
PHONE1                 ,         
PHONE2                 ,         
PAGER_NBR              ,         
STATE                  ,       
COUNTRY                ,       
JOBID                  ,         
GEX_BASE_RT            ,         
ALT_RATE               ,         
EXEMPT_FLAG            ,        
SALARY_FLAG            ,        
FULL_TIME              ,             
HOURS_PER_WEEK         ,         
DIVISION               ,         
BENEFIT_HRS            ,         
BENEFIT_COST           ,         
VAC_ACCR_BAL           ,         
GEX_BC_PAY_RULE        ,         
GEX_SHIFT_STRGY        ,        
GEX_EMPL_HIR_STS       ,        
STATUS_IND             ,          
ROLE_ID		       ,	            
PUNCH_RULE	       ,	            
EMPL_STATUS            ,        
EMPL_STATUS_LBL        ,      
STATUS_DT              ,      
EXPECTED_RETURN_DT     ,        
GEX_VOLUNTARY_FLAG     ,
SCHED_TYPE              
)                               
VALUES                          
($emplid                         
,#job_empl_rcd                  
,$company                       
,$paygroup                      
,$new_deptid                    
,$last_name                     
,$first_name                    
,&A.BIRTHDATE 	                
,$HIRE_DT 			
,$SENIORITY_DATE		
,$mgr_flag                      
,nvl($mgr_pword,' ')            
,$login_id                      
,$login_pword                   
,$blue_empl_type                
,$badge_nbr                     
,$mgr_sched_flag                
,$excep_flag                    
,$alert_flag                    
,$deptid                        
,nvl($address1,' ')             
,nvl($address2,' ')             
,nvl($city,' ')            
,nvl($zip,' ')                   
,nvl($phone,' ')                
,nvl($cell_phone,' ')            
,nvl($pager,' ')            
,nvl($state,' ')           
,nvl($country,' ')   		         
,$job                            
,#base_rate                      
,#alt_Rate                       
,nvl($exempt_flag,' ')           
,nvl($salary_flag,' ')           
,nvl($ft_pt_flag,' ')            
,#hrs_per_week                   
,nvl($division_Cd,' ')           
,#ben_hrs                        
,#ben_cost                       
,#vac_accr_bal         
,nvl($GEX_BC_PAY_RULE,' ')       
,$GEX_SHIFT_STRGY                
,nvl($GEX_EMPL_HIR_STS,' ')      
,nvl($STATUS_IND,' ')            
,nvl($Role_Id,' ')               
,nvl($Punch_Rule,' ')            
,nvl($EMPL_STATUS,' ')     
,nvl($EMPL_STATUS_LBL,' ')       
,$STATUS_DATE  			!,&C.EFFDT		         
,$EXPECTED_RETURN_DT             
,nvl($GEX_VOLUNTARY_FLAG,' ')                               
,nvl($SCHED_TYPE,' ')     
)

END-SQL                          

 let #recs_loaded = #recs_loaded + 1    
                                 
     !show '****************************   Row Inserted: *****************************************'
 Let $EE-on-top-level1       = ''      
 Let $EE-on-top-level2       = ''      
 Let $EE-on-top-level3       = ''      
 Let $EE_Reached_Anniversary = ''
                                 
   !show 'ending procedure   Insert-New-Data' 
!****************************************************************************                              
End-procedure  Insert-New-Data                   
!****************************************************************************

                                 
!*****************************************************************************
Begin-Procedure Find-Cell-Pager 
!*****************************************************************************
   !Show 'Entred into Find-Cell-Pager'
   !SHOW ' $job_emplid :'  $job_emplid 
 
 Let $cell-found = 'N'
 Let $pgr-found  = 'N'
 
Begin-Select ON-ERROR=SQL-Error-Found('Find-Cell-Pager')
PH.EMPLID
PH.PHONE_TYPE
PH.PHONE 

 Evaluate &PH.PHONE_TYPE
  when = 'CELL'
    If &PH.PHONE <> ''
     Let $cell-found = 'Y'
      Let $cell_phone = rtrim(&PH.PHONE,' ') 
    Else
     Let $cell_phone = ' '
    End-If  
    break
  when = 'PGR1'
    If &PH.PHONE <> ''
      Let $pgr-found  = 'Y'
      Let $pager  = rtrim(&PH.PHONE,' ') 
    Else
     Let $pager = ' '
    End-If  
    break
  when-other
 !    show 'do nothing'  
 End-Evaluate

   !SHOW '$pager      :' $pager 
   !SHOW '$cell_phone :' $cell_phone 

FROM PS_PERSONAL_PHONE PH
WHERE PH.EMPLID = $job_emplid 
  AND PH.PHONE_TYPE IN ( 'PGR1', 'CELL')
  ORDER BY PH.PHONE_TYPE 
End-Select 

    !show '$cell-found:'  $cell-found
    !show '$pgr-found :'  $pgr-found  

  If $cell-found = 'N' and $pgr-found  = 'N'
   !display 'cell and pager are not found ' 
   !do error-found ('personal_phone1')
    Let $cell_phone = ' '
    Let $pager      = ' '
  Else
    If $cell-found = 'Y' and $pgr-found  = 'N'
      !display 'pager not found '
      !do error-found ('personal_phone2')
      Let $pager      = ' '
    Else
      If $cell-found = 'N' and $pgr-found  = 'Y'
       !display 'Cell phone not found '
       !do error-found ('personal_phone3')      
	 Let $cell_phone = ' '
      End-if    
    End-if    
  End-if
!**************************************************************************** 
End-procedure Find-Cell-Pager
!****************************************************************************


!******************************************************************
begin-procedure Find-Changes
!******************************************************************
  #debug show 'In Proc Find changes started which inserts into the MNT table the diff between NEW & HLD'

begin-sql on-error=sql-error-found('Find-Changes')
INSERT INTO PS_GEX_SMTKMNT_W
(SELECT NEW.EMPLID,NEW.EMPL_RCD,NEW.COMPANY,NEW.PAYGROUP,NEW.NEW_DEPTID,
	NEW.LAST_NAME,NEW.FIRST_NAME,NEW.BIRTH_DT,NEW.HIRE_DT,NEW.SENIORITY_DATE,NEW.FLAG,
	!NEW.MGR_PWD,NEW.LOGIN_ID,NEW.LOGIN_PWD,NEW.EMPL_TYPE,NEW.BADGE_NBR,  isdvmxr 07/25/2006 08/15/2006 add three back
	NEW.MGR_PWD,NEW.LOGIN_ID,NEW.LOGIN_PWD,NEW.EMPL_TYPE,' ',  ! isdvmxr 08/11/2006 add back in compare 08/15/2006 removed
	NEW.SCHEDULE_FLAG,NEW.EXCEPTION_FLAG,NEW.ALERTSTATUS,NEW.DEPTID,
	NEW.ADDRESS1,NEW.ADDRESS2,NEW.CITY,NEW.ZIP,NEW.PHONE1,NEW.PHONE2,
	NEW.PAGER_NBR,NEW.STATE,NEW.COUNTRY,NEW.JOBID,NEW.GEX_BASE_RT,
	NEW.ALT_RATE,NEW.EXEMPT_FLAG,NEW.SALARY_FLAG,NEW.FULL_TIME,
	NEW.HOURS_PER_WEEK,NEW.DIVISION,NEW.BENEFIT_HRS,NEW.BENEFIT_COST,
	NEW.VAC_ACCR_BAL,NEW.GEX_BC_PAY_RULE,NEW.GEX_SHIFT_STRGY,
	!NEW.GEX_EMPL_HIR_STS, !'X', ! ISDVMXR 08/01/2006
	' ',
	'N', !NEW.STATUS_IND,
	NEW.ROLE_ID,NEW.PUNCH_RULE, !isdvmxr 08/03/2006  NEW.ROLE_ID put back
	NEW.EMPL_STATUS,NEW.EMPL_STATUS_LBL,
	'',! $X000_WHERE_SELECT_ASOFDATE     !isdvmxr 07/25/2006 put null in status date field
	NEW.EXPECTED_RETURN_DT,
	NEW.GEX_VOLUNTARY_FLAG,NEW.SCHED_TYPE
   FROM PS_GEX_SMTKNEW_W NEW
   !where new.status_ind ='N' - NEW COMMENT
   )
   minus
(SELECT OLD.EMPLID,OLD.EMPL_RCD,OLD.COMPANY,OLD.PAYGROUP,OLD.NEW_DEPTID,
	OLD.LAST_NAME,OLD.FIRST_NAME,OLD.BIRTH_DT,OLD.HIRE_DT,OLD.SENIORITY_DATE,OLD.FLAG,
	!OLD.MGR_PWD,OLD.LOGIN_ID,OLD.LOGIN_PWD,OLD.EMPL_TYPE,OLD.BADGE_NBR,  isdvmxr 07/25/2006 08/15/2006 add 3 back
	OLD.MGR_PWD,OLD.LOGIN_ID,OLD.LOGIN_PWD,OLD.EMPL_TYPE,' ', ! isdvmxr 08/11/2006 add back in compare 08/15/2006 remove badgenbr
	OLD.SCHEDULE_FLAG,OLD.EXCEPTION_FLAG,OLD.ALERTSTATUS,OLD.DEPTID,
	OLD.ADDRESS1,OLD.ADDRESS2,OLD.CITY,OLD.ZIP,OLD.PHONE1,OLD.PHONE2,
	OLD.PAGER_NBR,OLD.STATE,OLD.COUNTRY,OLD.JOBID,OLD.GEX_BASE_RT,
	OLD.ALT_RATE,OLD.EXEMPT_FLAG,OLD.SALARY_FLAG,OLD.FULL_TIME,
	OLD.HOURS_PER_WEEK,OLD.DIVISION,OLD.BENEFIT_HRS,OLD.BENEFIT_COST,
	OLD.VAC_ACCR_BAL,OLD.GEX_BC_PAY_RULE,OLD.GEX_SHIFT_STRGY,
	!OLD.GEX_EMPL_HIR_STS, !'X', ! ISDVMXR 08/01/2006
	' ',
	'N', !OLD.STATUS_IND,
	OLD.ROLE_ID,OLD.PUNCH_RULE,   !isdvmxr 08/03/2006 OLD.ROLE_ID
	OLD.EMPL_STATUS,OLD.EMPL_STATUS_LBL,
	'',                        ! isdvmxr 07/25/2006   put null in status date OLD.STATUS_DT,  
	OLD.EXPECTED_RETURN_DT,
	OLD.GEX_VOLUNTARY_FLAG,OLD.SCHED_TYPE
   FROM PS_GEX_SMTKHLD_W OLD
   !where old.status_ind ='N'
   )

end-sql


  ! Show 'In Proc Find changes ended*************' 
!****************************************************************************
end-procedure Find-Changes
!****************************************************************************

!******************************************************************
begin-procedure MNT-vs-B-Table 
!****************************************************************************
!ISDVSRC 03/08/2006
!Compare changes between B & MNT Table and Insert into FNL Table
!
!******************************************************************
  #debug show 'In Proc MNT-vs-B-Table  started'
 
 begin-sql on-error=sql-error-found('MNT-vs-B-Table')
INSERT INTO PS_GEX_SMTKFNL_W 
(SELECT MNT.EMPLID, MNT.EMPL_RCD, MNT.COMPANY, MNT.PAYGROUP, MNT.NEW_DEPTID,
 MNT.LAST_NAME, MNT.FIRST_NAME,
 MNT.BIRTH_DT, MNT.HIRE_DT, MNT.SENIORITY_DATE,   !MNT.FLAG,MNT.MGR_PWD,MNT.LOGIN_ID,MNT.LOGIN_PWD,MNT.EMPL_TYPE,' ' ,ISDVMXR 07/28/2006 commented 3 fields 08/15/2006 add 3 back
 MNT.FLAG, MNT.MGR_PWD, MNT.LOGIN_ID, MNT.LOGIN_PWD, MNT.EMPL_TYPE,' ',           !08/11/2006    ISDVMXR Add Badge_nbr  Was not there before 08/15/2006 remove
 MNT.SCHEDULE_FLAG, MNT.EXCEPTION_FLAG, MNT.ALERTSTATUS, MNT.DEPTID,
 MNT.ADDRESS1, MNT.ADDRESS2, MNT.CITY,
 MNT.ZIP, MNT.PHONE1, MNT.PHONE2,
 MNT.PAGER_NBR, MNT.STATE, MNT.COUNTRY, MNT.JOBID, MNT.GEX_BASE_RT,
 MNT.ALT_RATE, MNT.EXEMPT_FLAG, MNT.SALARY_FLAG, MNT.FULL_TIME,
 MNT.HOURS_PER_WEEK, MNT.DIVISION, MNT.BENEFIT_HRS,  
 MNT.BENEFIT_COST, MNT.VAC_ACCR_BAL, MNT.GEX_BC_PAY_RULE, MNT.GEX_SHIFT_STRGY, !MNT.GEX_EMPL_HIR_STS,!'X', ISDVMXR 08/01/2006
 ' ',
 'N' ,            !MNT.STATUS_IND,
 MNT.ROLE_ID, MNT.PUNCH_RULE, MNT.EMPL_STATUS, MNT.EMPL_STATUS_LBL,               !isdvmxr 08/03/2006 MNT.ROLE_ID
 '',        !MNT.STATUS_DT, isdvmxr 07/25/2006 put null in status date field
 MNT.EXPECTED_RETURN_DT, MNT.GEX_VOLUNTARY_FLAG, MNT.SCHED_TYPE
 FROM PS_GEX_SMTKMNT_W MNT 
    )  
 minus
(SELECT B1.EMPLID, B1.EMPL_RCD, B1.COMPANY, B1.PAYGROUP, B1.NEW_DEPTID,
 B1.LAST_NAME, B1.FIRST_NAME,
 B1.BIRTH_DT, B1.HIRE_DT, B1.SENIORITY_DATE,  !B1.FLAG, B1.MGR_PWD, B1.LOGIN_ID, B1.LOGIN_PWD,B1.EMPL_TYPE,' ',  ISDVMXR 07/28/2006 commented 3 fields 08/15/2006  add back
 B1.FLAG,B1.MGR_PWD, B1.LOGIN_ID, B1.LOGIN_PWD, B1.EMPL_TYPE, ' ',                !08/11/2006  add badge number 08/15/2006 remove bdgenbr
 B1.SCHEDULE_FLAG, B1.EXCEPTION_FLAG, B1.ALERTSTATUS, B1.DEPTID,
 B1.ADDRESS1, B1.ADDRESS2, B1.CITY,
 B1.ZIP, B1.PHONE1, B1.PHONE2,
 B1.PAGER_NBR, B1.STATE, B1.COUNTRY, B1.JOBID, B1.GEX_BASE_RT,
 B1.ALT_RATE, B1.EXEMPT_FLAG, B1.SALARY_FLAG, B1.FULL_TIME,
 B1.HOURS_PER_WEEK, B1.DIVISION, B1.BENEFIT_HRS,  
 B1.BENEFIT_COST, B1.VAC_ACCR_BAL, B1.GEX_BC_PAY_RULE, B1.GEX_SHIFT_STRGY,  !B1.GEX_EMPL_HIR_STS,!'X', ISDVMXR 08/01/2006
 ' ',
 'N',               !B1.STATUS_IND,
 B1.ROLE_ID, B1.PUNCH_RULE, B1.EMPL_STATUS, B1.EMPL_STATUS_LBL,                !isdvmxr 08/03/2006 B1.ROLE_ID
 '', !B1.STATUS_DT, isdvmxr 07/25/2006 put null in status date field
 B1.EXPECTED_RETURN_DT, B1.GEX_VOLUNTARY_FLAG, B1.SCHED_TYPE
 FROM PS_GEX_SMT_TRK_BW B1  
 WHERE  B1.seqno = (SELECT MAX(B2.seqno) 
                                 FROM  PS_GEX_SMT_TRK_BW B2  
 	                               WHERE B1.EMPLID = B2.EMPLID 
 	                               AND B1.seqno < = B2.seqno )
                                 And   [$GEXXX902_INCLUDE_DEPTID_CRITERIA_x]
)
!and  B1.DEPTID In ('0002','0003','0004','0008','0009','0010','0025','0031','0033','0034',
!'0038','0039','0041','0045','0052','0058','0059','0060','0061','0063','0064','0065','0067',
!'0070','0072','0074','0076','0077','0078','0081','3002','3008','3009','3010','3034','3039',
!'3041','3058','3060','3070','3352','3379','3535','3536','6379','6508','6510','6511','6514','6520','6535','6536')
                                                                                                                
!)             
end-sql
  #debug show 'In Proc MNT-vs-B-Table  ended'
!****************************************************************************
end-procedure MNT-vs-B-Table
!****************************************************************************


!******************************************************************
begin-procedure Select-Final-Data
!****************************************************************************
!ISDVSRC 03/08/2006
! Select Data from PS_GEX_SMTKFNL_W and insert into PS_GEX_SMT_TRK_BW table
! And while inserting.. we need to find the differences of
! OLD JOBID/NEW JOBID, OLD DEPTID/DEPTID, OLD_HOURSY_RT/GEX_BASE_RT
! Using the below procedures
!   Get-Old-Jobid-Dept-HrlyRt
!   Get-New-Jobid-Dept-HrlyRt
!******************************************************************
  #debug show 'In Proc Select-Final-Data   started  which selects data from PS_GEX_SMTKFNL_W table  '
  
     

Begin-select  on-error=sql-error-found('Select-Final-Data')
B3.EMPLID             
B3.EMPL_RCD           
B3.COMPANY            
B3.PAYGROUP           
B3.NEW_DEPTID         
B3.LAST_NAME          
B3.FIRST_NAME         
B3.BIRTH_DT           
B3.HIRE_DT            
B3.SENIORITY_DATE    
B3.FLAG              
B3.MGR_PWD            
B3.LOGIN_ID           
B3.LOGIN_PWD          
B3.EMPL_TYPE          
B3.BADGE_NBR          
B3.SCHEDULE_FLAG      
B3.EXCEPTION_FLAG     
B3.ALERTSTATUS        
B3.DEPTID             
B3.ADDRESS1           
B3.ADDRESS2           
B3.CITY               
B3.ZIP                
B3.PHONE1             
B3.PHONE2             
B3.PAGER_NBR          
B3.STATE              
B3.COUNTRY            
B3.JOBID              
B3.GEX_BASE_RT        
B3.ALT_RATE           
B3.EXEMPT_FLAG        
B3.SALARY_FLAG        
B3.FULL_TIME          
B3.HOURS_PER_WEEK     
B3.DIVISION           
B3.BENEFIT_HRS        
B3.BENEFIT_COST       
B3.VAC_ACCR_BAL       
B3.GEX_BC_PAY_RULE    
B3.GEX_SHIFT_STRGY    
B3.GEX_EMPL_HIR_STS   
B3.STATUS_IND         ! CHANGE THIS BACK TO ! !B3.STATUS_IND - COMMENT
B3.ROLE_ID            
B3.PUNCH_RULE         
B3.EMPL_STATUS        
B3.EMPL_STATUS_LBL    
B3.STATUS_DT          
B3.EXPECTED_RETURN_DT
B3.GEX_VOLUNTARY_FLAG 
B3.SCHED_TYPE

 Add 1 to #tran_read
 
  Let $Curr_Deptid = &B3.DEPTID                     
  Let $emplid_cmp     = &B3.EMPLID  
  let  $B3.STATUS_DT  = &B3.STATUS_DT                    
   
  Do Get-Old-Jobid-Dept-HrlyRt
  Do Get-New-Jobid-Dept-HrlyRt
  
!    SHOW '*******************************************************'
!   SHOW '$OD.JOBID      :' $OD.JOBID        
!   SHOW '$OD.DEPTID     :' $OD.DEPTID	
!   SHOW '#OD.GEX_BASE_RT:' #OD.GEX_BASE_RT 
!   SHOW '-----------------------'
!   SHOW '$NW.JOBID      :' $NW.JOBID               
!   SHOW '$NW.DEPTID     :' $NW.DEPTID		
!   SHOW '#NW.GEX_BASE_RT:' #NW.GEX_BASE_RT         
!   SHOW '*******************************************************'       VENDKXY
         
 !----------------------------------------------         
  If  $NW.JOBID <> $OD.JOBID         
     ! show 'entered into $NW.JOBID <> $OD.JOBID  ' 
    Let $OLD_JOBID =$OD.JOBID      
  Else
     ! show 'entered into ELSE $NW.JOBID <> $OD.JOBID  ' 
    Let $OLD_JOBID = ' '    	  
  End-If         

 !----------------------------------------------
 
 If $OD.DEPTID = ''                  !First time load
     ! show ' First time load -- '
    Let $Current_Deptid = $NW.DEPTID ! OR $Curr_Deptid OR &B3.DEPTID  
    Let $New_Department = ' '
    
     ! show '$Current_Deptid  ::' $Current_Deptid 
     ! show '$New_Department  ::' $New_Department 
 Else   
  If  $NW.DEPTID <>  $OD.DEPTID 
     ! show ' First Second and future load -- '
     ! show 'entered into  $NW.DEPTID <>  $OD.DEPTID ' 
    
    Let $Current_Deptid = $OD.DEPTID
    Let $New_Department = $NW.DEPTID
      ! show '$Current_Deptid:' $Current_Deptid
      ! show '$New_Department:' $New_Department
   Else
      ! show 'entered into Else $NW.DEPTID <>  $OD.DEPTID ' 
      ! show 'Previous and current DeptID are the same:'
   
     Let $Current_Deptid = $NW.DEPTID ! or $OD.DEPTID  - Since the DEPTID has not changed
     Let $New_Department = ' '
   End-If         
 End-If           
 
 !---------------------------------------------- 
  
  If  (#NW.GEX_BASE_RT <> #OD.GEX_BASE_RT) and ( #OD.GEX_BASE_RT <> 0.000000 ) 
  !isdvmxr added to the above line  and ( #OD.GEX_BASE_RT <> 0.000000 ) and (
    !  SHOW 'entered into #NW.GEX_BASE_RT <> #OD.GEX_BASE_RT  ' 
 !     SHOW ' #NW.GEX_BASE_RT  ' #NW.GEX_BASE_RT 
 !     SHOW '#OD.GEX_BASE_RT  ' #OD.GEX_BASE_RT
    Let #OLD_HOURLY_RT = #OD.GEX_BASE_RT     
    
    
    ! ISDVMXR 07/18/2006 added new procedure to get the day of the week           
    
    !DO GET-DAY-SYSDATE  ! changed by VENDKXY for ITG 44045 on 10/04/2007 
  
       
        
        Move $reportdate_less2_dbf to $B3.STATUS_DT
  
!   	   show '$reportdate_less2_dbf to $B3.STATUS_DT '  $B3.STATUS_DT
	  
  Else
      ! SHOW 'entered into ELSE #NW.GEX_BASE_RT<> #OD.GEX_BASE_RT  ' 
    Let #OLD_HOURLY_RT = 0  
      DO GET-JOB-EMPLID  	
      DO GET-JOB-EFFDT
        if  &J.EFFDT <= $X000_WHERE_SELECT_ASOFDATE
          	let $B3.STATUS_DT = $X000_WHERE_SELECT_ASOFDATE
!       	show    ' &J.EFFDT < $X000_WHERE_SELECT_ASOFDATE logic  '$B3.STATUS_DT  VENDKXY
	end-if 
   ! LET  $B3.STATUS_DT   = &J.EFFDT                         !ISDVMXR 07/26/2006
    
   ! SHOW '                                    8888             ' $B3.STATUS_DT
  End-If         
 !----------------------------------------------
 
 

  ! show ' calling  ************** Insert-Into-B-Tbl routine '  
  Do Insert-Into-B-Tbl               
   
   Let $OD.JOBID           = ''
   Let $OD.DEPTID 	   = ''
   Let #OD.GEX_BASE_RT     = 0

   Let $NW.JOBID           = ''  
   Let $NW.DEPTID	   = ''  
   Let #NW.GEX_BASE_RT     = 0   
   
    Let $Current_Deptid = ''
    Let $New_Department = ''

FROM PS_GEX_SMTKFNL_W B3  
end-select
  
   #DEBUG show 'In Proc Select-Final-Data  ending '
!****************************************************************************
end-procedure Select-Final-Data
!****************************************************************************



!*********************************************************************              
!This procedure gets the day of the week from sysdate          
!*********************************************************************              
begin-procedure GET-DAY-SYSDATE                                            
!**********************************************************************             
                                                      
                                                                                    
             
begin-select               

to_char(sysdate,'DAY') &day                                                                        
                                                                                    
      #DEBUG show &day     
	  
	 move  &day  to $day 
	 !let $day='WEDNESDAY'     !VENDKXY TESTING PURPOSE
	 !let $day = 'SATURDAY'   ! isdvmxr test
	 
	 let $day    = ltrim($day,' ')
	 let $day = rtrim ($day,' ')
	   Evaluate $day
	   when = 'WEDNESDAY' 
	     let #subtract_Days1 = 3 
		 LET #subtract_Days1 = EDIT(#subtract_Days1,'9')
	   #DEBUG SHOW '*****************' #subtract_Days1 
	   break
	   when = 'SATURDAY'
	  
	    let #subtract_Days1 = 6
	    LET #subtract_Days1 = EDIT(#subtract_Days1,'9')
	    #DEBUG SHOW '*****************' #subtract_Days1 
	  break 
	   End-Evaluate
		
	Let $X000_WHERE_SELECT_ASOFDATE = $AsOfToday
	#DEBUG show ' $X000_WHERE_SELECT_ASOFDATE   '  $X000_WHERE_SELECT_ASOFDATE 
	
	  Do Format-DateTime($X000_WHERE_SELECT_ASOFDATE, $reportdate, {DEFDATE}, '', '')
	
	let $reportdate_mm = substr($reportdate,1,2)
    let $reportdate_dd = substr($reportdate,4,2)
	
    let $reportdate_yy = substr($reportdate,7,4)
        
    let $reportdate_yy = '20' ||$reportdate_yy !GEX-RBC commented for HCM 9.0 Upgrade !GEX-MXT uncommented for the date format

	
    let $reportdate_ccyy = $reportdate_yy||'-'||$reportdate_mm||'-'||$reportdate_dd   
  
     do Convert-From-DTU-Date($reportdate_ccyy, $reportdate_dbf)

     do dtu-subtract-days($reportdate_ccyy, #subtract_Days1, $reportdate_less2)

	 do Convert-From-DTU-Date($reportdate_less2, $reportdate_less2_dbf)

      Do Format-DateTime($reportdate_less2_dbf, $reportdate_cmp, {DEFCMP}, '', '')
      	#DEBUG show ' in get sysdate logic '  $reportdate_less2_dbf  
	    
   
	                                                                        
from dual                                                               
                                
end-select                                       
                                                                
!**********************************************************************             
end-procedure    GET-DAY-SYSDATE                                            
!**********************************************************************             

!*********************************************************************              
!This procedure gets the EFF DT FROM  JOB          
!*********************************************************************              
begin-procedure GET-JOB-EMPLID                                            
!**********************************************************************   

  ! SHOW '     GET-JOB-EMPLID  $emplid_cmp = ' $emplid_cmp     
begin-select               
SSN                                                                      
                                                                                      
   ! SHOW ' IN GET GET-JOB-EMPLID LOGIC '  &SSN
	                                                                        
from PS_GEX_EMPLID_MAPP 
WHERE EMPLID = $emplid_cmp    
                                                     
                                
end-select                                       
                                                               
!**********************************************************************             
end-procedure    GET-JOB-EMPLID                                             
!**********************************************************************             

!*********************************************************************              
!This procedure gets the EFF DT FROM  JOB          
!*********************************************************************              
begin-procedure GET-JOB-EFFDT                                           
!**********************************************************************   

!   SHOW '     GET-JOB-EFFDT = ' &SSN    '/'  $emplid_cmp      VENDKXY
begin-select               
J.EFFDT                                                                      
                                                                                    
!    SHOW ' IN GET JOB EFFDT LOGIC '  &J.EFFDT 	VENDKXY
	                                                                        
from PS_JOB J
WHERE J.EMPLID = &SSN       
AND J.EFFDT  = (SELECT MAX(EFFDT) FROM   PS_JOB WHERE EMPLID    = J.EMPLID                                                                                                                                                              
	  	   AND EMPL_RCD = J.EMPL_RCD AND EFFDT <= $X000_WHERE_SELECT_ASOFDATE)                                                                                                                                                            
   AND J.EFFSEQ = (SELECT MAX(EFFSEQ) FROM   PS_JOB  WHERE EMPLID    = J.EMPLID                                                                                                                                                            
	  	   AND EMPL_RCD = J.EMPL_RCD AND EFFDT    = J.EFFDT)                                                                                                                                                                                        
     	!  AND EFFDT <= '25-JUL-2006'        isdvmxr 10/02/2006                                                 
                                
end-select                                       
                                                               
!**********************************************************************             
end-procedure    GET-DAY-SYSDATE                                            
!**********************************************************************             


!******************************************************************
begin-procedure Get-Old-Jobid-Dept-HrlyRt
!******************************************************************
   ! show 'In Proc Get-Old-Jobid-Dept-HrlyRt'
   ! show '$emplid_cmp:' $emplid_cmp
Begin-select DISTINCT  on-error=sql-error-found('Get-Old-Jobid-Dept-HrlyRt')
OD.JOBID
OD.DEPTID
OD.GEX_BASE_RT

    ! show 'OLD JOBID      :' &OD.JOBID       
    ! show 'OLD DEPTID     :' &OD.DEPTID     
    ! show 'OLD GEX_BASE_RT:' &OD.GEX_BASE_RT

                                            
 Let $OD.JOBID           =  &OD.JOBID        
 Let $OD.DEPTID		 =  &OD.DEPTID     
 Let #OD.GEX_BASE_RT     =  &OD.GEX_BASE_RT  

   
FROM PS_GEX_SMTKHLD_W OD  
WHERE OD.EMPLID =  $emplid_cmp

End-Select
!****************************************************************************
end-procedure Get-Old-Jobid-Dept-HrlyRt
!****************************************************************************


!******************************************************************
begin-procedure Get-New-Jobid-Dept-HrlyRt
!******************************************************************
   ! show 'In Proc Get-New-Jobid-Dept-HrlyRt'
   ! show '$emplid_cmp:' $emplid_cmp
Begin-select DISTINCT  on-error=sql-error-found('Get-New-Jobid-Dept-HrlyRt')
NW.JOBID
NW.DEPTID
NW.GEX_BASE_RT

    ! show 'NEW JOBID      :' &NW.JOBID       
    ! show 'NEW DEPTID     :' &NW.DEPTID     
    ! show 'NEW GEX_BASE_RT:' &NW.GEX_BASE_RT

 Let $NW.JOBID           =  &NW.JOBID        
 Let $NW.DEPTID		 =  &NW.DEPTID       
 Let #NW.GEX_BASE_RT     =  &NW.GEX_BASE_RT  

   
FROM PS_GEX_SMTKNEW_W NW  
WHERE NW.EMPLID =  $emplid_cmp

End-Select
!****************************************************************************
end-procedure Get-New-Jobid-Dept-HrlyRt
!****************************************************************************


!******************************************************************
begin-procedure Insert-Into-B-Tbl
!******************************************************************
   #DEBUG show 'In Proc Insert-Into-BW-Tbl starting    which inserts into  B table  '

   #DEBUG show '$Current_Deptid :' $Current_Deptid 
   #DEBUG show '$New_Department :' $New_Department 

 Let $OPRID ='BATCH_' || $X000_WHERE_SELECT_ASOFDATE

!Let $OPRID ='BATCH_New_06192006_2'
#ifdef debug8 
 show '&B3.STATUS_IND              '   &B3.STATUS_IND 
 show '&B3.EMPLID                  '   &B3.EMPLID                  
 show '&B3.EMPL_RCD                '   &B3.EMPL_RCD                 
 show '&B3.COMPANY                 '   &B3.COMPANY                  
 show '&B3.PAYGROUP                '   &B3.PAYGROUP                 
 show 'nvl($New_Department,' ')    '   $New_Department             
 show '&B3.LAST_NAME               '   &B3.LAST_NAME                
 show '&B3.FIRST_NAME              '   &B3.FIRST_NAME               
 show '&B3.BIRTH_DT                '   &B3.BIRTH_DT                 
 show '&B3.HIRE_DT                 '   &B3.HIRE_DT                  
 show '&B3.SENIORITY_DATE          '   &B3.SENIORITY_DATE           
 show '&B3.FLAG                    '   &B3.FLAG                     
 show '&B3.MGR_PWD                 '   &B3.MGR_PWD                  
 show '&B3.LOGIN_ID                '   &B3.LOGIN_ID                 
 show '&B3.LOGIN_PWD               '   &B3.LOGIN_PWD                
 show '&B3.EMPL_TYPE               '   &B3.EMPL_TYPE                
 show '&B3.BADGE_NBR               '   &B3.BADGE_NBR                
 show '&B3.SCHEDULE_FLAG           '   &B3.SCHEDULE_FLAG            
 show '&B3.EXCEPTION_FLAG          '   &B3.EXCEPTION_FLAG           
 show '&B3.ALERTSTATUS             '   &B3.ALERTSTATUS              
 show 'nvl($Current_Deptid,' ')    '   $Current_Deptid             
 show '&B3.ADDRESS1                '   &B3.ADDRESS1                 
 show '&B3.ADDRESS2                '   &B3.ADDRESS2                 
 show '&B3.CITY                    '   &B3.CITY                     
 show '&B3.STATE                   '   &B3.STATE                    
 show '&B3.ZIP                     '   &B3.ZIP                      
 show '&B3.COUNTRY                 '   &B3.COUNTRY                  
 show '&B3.PHONE1                  '   &B3.PHONE1                   
 show '&B3.PHONE2                  '   &B3.PHONE2                   
 show '&B3.PAGER_NBR               '   &B3.PAGER_NBR                
 show '&B3.JOBID                   '   &B3.JOBID                    
 show 'nvl($OLD_JOBID,' ')         '   $OLD_JOBID                  
 show '&B3.GEX_BASE_RT             '   &B3.GEX_BASE_RT              
 show '&B3.ALT_RATE                '   &B3.ALT_RATE                 
 show 'nvl(#OLD_HOURLY_RT, 0)      '   #OLD_HOURLY_RT              
 show '&B3.EXEMPT_FLAG             '   &B3.EXEMPT_FLAG              
 show '&B3.SALARY_FLAG             '   &B3.SALARY_FLAG              
 show '&B3.FULL_TIME               '   &B3.FULL_TIME                
 show '&B3.HOURS_PER_WEEK          '   &B3.HOURS_PER_WEEK           
 show '&B3.DIVISION                '   &B3.DIVISION                 
 show '&B3.BENEFIT_HRS             '   &B3.BENEFIT_HRS              
 show '&B3.BENEFIT_COST            '   &B3.BENEFIT_COST             
 show '&B3.VAC_ACCR_BAL            '   &B3.VAC_ACCR_BAL             
 show '&B3.GEX_BC_PAY_RULE         '   &B3.GEX_BC_PAY_RULE          
 show '&B3.GEX_SHIFT_STRGY         '   &B3.GEX_SHIFT_STRGY          
 show '&B3.GEX_EMPL_HIR_STS        '   &B3.GEX_EMPL_HIR_STS         
 show '&B3.ROLE_ID                 '   &B3.ROLE_ID                  
 show '&B3.PUNCH_RULE              '   &B3.PUNCH_RULE               
 show '&B3.EMPL_STATUS             '   &B3.EMPL_STATUS              
 show '&B3.EMPL_STATUS_LBL         '   &B3.EMPL_STATUS_LBL          
 show '$B3.STATUS_DT               '   $B3.STATUS_DT                
 show '&B3.EXPECTED_RETURN_DT      '   &B3.EXPECTED_RETURN_DT       
 show '&B3.GEX_VOLUNTARY_FLAG      '   &B3.GEX_VOLUNTARY_FLAG       
 show '&B3.SCHED_TYPE              '   &B3.SCHED_TYPE               
 show 'SYSDATE                     '   $X000_WHERE_SELECT_ASOFDATE                   
 SHOW '&B3.STATUS_DT               '   &B3.STATUS_DT
 show '$OPRID:                     '   $OPRID
#end-if 
Begin-Sql  !on-error=sql-error-found('In Proc Insert-Into-B-Tbl')
INSERT INTO PS_GEX_SMT_TRK_BW 
(SEQNO             ,           
EMPLID             ,                             
EMPL_RCD           ,                             
COMPANY            ,                             
PAYGROUP           ,                             
NEW_DEPTID         ,                             
LAST_NAME          ,                             
FIRST_NAME         ,                             
BIRTH_DT           ,                             
HIRE_DT            ,                             
SENIORITY_DATE     ,                             
FLAG               ,                             
MGR_PWD            ,                             
LOGIN_ID           ,                             
LOGIN_PWD          ,                             
EMPL_TYPE          ,                             
BADGE_NBR          ,                             
SCHEDULE_FLAG      ,                             
EXCEPTION_FLAG     ,                             
ALERTSTATUS        ,                             
DEPTID             ,                             
ADDRESS1           ,                             
ADDRESS2           ,                             
CITY               ,                             
STATE              ,                             
ZIP                ,                             
COUNTRY            ,                             
PHONE1             ,                             
PHONE2             ,                             
PAGER_NBR          ,                             
JOBID              ,           
OLD_JOBID          ,           
GEX_BASE_RT        ,                             
ALT_RATE           ,           
OLD_HOURLY_RT      ,           
EXEMPT_FLAG        ,                           
SALARY_FLAG        ,                           
FULL_TIME          ,                           
HOURS_PER_WEEK     ,                           
DIVISION           ,                           
BENEFIT_HRS        ,                           
BENEFIT_COST       ,                           
VAC_ACCR_BAL       ,                           
GEX_BC_PAY_RULE    ,                           
GEX_SHIFT_STRGY    ,                           
GEX_EMPL_HIR_STS   ,                           
STATUS_IND         ,                           
ROLE_ID            ,                           
PUNCH_RULE         ,                           
EMPL_STATUS        ,                           
EMPL_STATUS_LBL    ,                           
STATUS_DT          ,                           
EXPECTED_RETURN_DT ,                           
GEX_VOLUNTARY_FLAG ,      
SCHED_TYPE         ,                     
TIME_STAMP         ,    
!GEX_RANK	   ,                       
OPRID    )                           
VALUES             
(gex_smt_trk_seq.nextval ,               
&B3.EMPLID               ,                      
&B3.EMPL_RCD             ,                      
&B3.COMPANY              ,                      
&B3.PAYGROUP             ,                      
nvl($New_Department,' ') ,                      
&B3.LAST_NAME            ,                      
&B3.FIRST_NAME           ,                      
&B3.BIRTH_DT             ,                      
&B3.HIRE_DT              ,                      	
&B3.SENIORITY_DATE       ,                      
&B3.FLAG                 ,                      
&B3.MGR_PWD              ,                      
&B3.LOGIN_ID             ,                      
&B3.LOGIN_PWD            ,                      
&B3.EMPL_TYPE            ,                      
&B3.BADGE_NBR            ,               !' '                      ,        isdvmxr 08/11/2006 add badge nbr                
&B3.SCHEDULE_FLAG        ,                      
&B3.EXCEPTION_FLAG       ,                      
&B3.ALERTSTATUS          ,                      
nvl($Current_Deptid,' ') ,                      
&B3.ADDRESS1             ,                      
&B3.ADDRESS2             ,                      
&B3.CITY                 ,                      
&B3.STATE                ,                      
&B3.ZIP                  ,                      
&B3.COUNTRY              ,                      
&B3.PHONE1               ,                      
&B3.PHONE2               ,                      
&B3.PAGER_NBR            ,                      
&B3.JOBID                ,                      
nvl($OLD_JOBID,' ')      ,                      
&B3.GEX_BASE_RT          ,                      
&B3.ALT_RATE             ,                      
nvl(#OLD_HOURLY_RT, 0)   ,                      
&B3.EXEMPT_FLAG          ,                      
&B3.SALARY_FLAG          ,                      
&B3.FULL_TIME            ,                      
&B3.HOURS_PER_WEEK       ,                      
&B3.DIVISION             ,                      
&B3.BENEFIT_HRS          ,                      
&B3.BENEFIT_COST         ,                      
&B3.VAC_ACCR_BAL         ,                      
&B3.GEX_BC_PAY_RULE      ,                      
&B3.GEX_SHIFT_STRGY      ,                      
'N'                      ,     !&B3.GEX_EMPL_HIR_STS     ,    !ISDVMXR 08/01/2006 HARDCODED VALUE TO "N"            
&B3.STATUS_IND           , 
&B3.ROLE_ID              ,                      
&B3.PUNCH_RULE           ,                      
&B3.EMPL_STATUS          ,                      
&B3.EMPL_STATUS_LBL      ,                      
$B3.STATUS_DT            ,       !ISDVMXR 07/24/2006 changed from  &B3.STATUS_DT to $B3.STATUS_DT
nvl(&B3.EXPECTED_RETURN_DT, NULL),              
&B3.GEX_VOLUNTARY_FLAG   ,                      
&B3.SCHED_TYPE           ,                      
&B3.STATUS_DT            , 
!' '                      ,                      
$OPRID                                          
)                                               
                
End-sql            
 ADD 1 TO #New-Row-Inserted
  ! let $B3.STATUS_DT  =''   !isdvmxr 07/26/2006  initialize to null
 
      !show 'In Proc Insert-Into-B-Tbl ending      '
!**************************************************************************** 
end-procedure Insert-Into-B-Tbl      
!****************************************************************************
                   
                   
!********************************************************************
!This procedure displays in the error report if there are any sql erros
!happened in the program
!********************************************************************
begin-procedure SQL-Error-Found($Proc_Name) 
!*********************************************************************
! SHOW 'Entered into procedure SQL-Error-Found: '  $Proc_Name
  do error-found('SQL-Error-Found')
  #DEBUG show 'SQL Error in ' 
  #DEBUG show $Proc_Name   
  #DEBUG show $_sql-error 
  #DEBUG show 'sql-status:' 
  #DEBUG show #_sql-status 
!****************************************************************************
end-procedure
!****************************************************************************

!*********************************************************************
!This procedure displays the error message for the records that are in
!progress
!*********************************************************************
begin-procedure Error-Found($Proc_Name2) 
!*********************************************************************
! SHOW 'Entered into  Procedure Error-Found'
  #DEBUG show 'SQL Error in ' 
  #DEBUG show $Proc_Name2   
  #DEBUG show $_sql-error 
  #DEBUG show 'sql-status:' 
  #DEBUG show #_sql-status 
 
 
  move 'Y' to $ErrorFound
  do Format-Number(#InputTran, $out, '99999')
  #DEBUG show $out 
  
!  show &C.DEPTID 
  !move &M.EMPLID to $EmplID     ! CWB 02/22/2005

  #DEBUG Show '$EmplID       ' $_EmplID        
!  show 'EMPL_TYPE     ' &C.EMPL_TYPE 
!  show 'FULL_PART_TIME' &C.FULL_PART_TIME 
!  show 'ACCT_CD       ' &C.ACCT_CD
!  show 'JOBCODE       ' &C.JOBCODE 
!  show 'HIRE_DT       ' &B.HIRE_DT 
!  show 'SERVICE_DT    ' &B.SERVICE_DT 
!  show 'UNION_CD      ' &C.UNION_CD 
!**************************************************************************** 
end-procedure Error-Found($Proc_Name2)
!****************************************************************************


!New Code - Start ISDVSRC 01/16/05
!****************************************************************************
begin-procedure get-weekly-ben-hrs
!****************************************************************************
!Need to take all employees that are part of your T&A selection and based upon emplid and empl_rcd 
!We need to find the employees max row from PS_BEN_PROG_PARTIC <= the pay end date you are 
!processing for - in order to find each employees benefit_program.
!****************************************************************************

 !Determine, whether the Benefit Program is  one that is applicable for 
 !Actual Hours Thresholds for the Blue Cube Scheduling 

  Let $GEX_SMT_TRK_FLAG = 'N'

Begin-select distinct on-error=sql-error-found('Determ-Emp-Hlth-Welf-Ben')
PR.GEX_SMT_TRK_FLAG 
 Let $GEX_SMT_TRK_FLAG = 'Y'
FROM PS_GEX_SQR_PROCESS PR WHERE PR.BENEFIT_PROGRAM =$ben_pgm
End-Select

 ! SHOW '$GEX_SMT_TRK_FLAG ::' $GEX_SMT_TRK_FLAG 

If  $GEX_SMT_TRK_FLAG = 'Y'   ! Ben Program is applicable
 			       !This means the EE is enrolled in a BNFT Program 
   
 !Determine, whether the Employee is enrolled in Health Benefits or not
  
 Let $Determ-Emp-Hlth-Welf-Ben = 'N'

Begin-select distinct on-error=sql-error-found('Determ-Emp-Hlth-Welf-Ben')
A.COVERAGE_ELECT

 Let $Determ-Emp-Hlth-Welf-Ben = 'Y'
 Let $COVERAGE_ELECT           = &A.COVERAGE_ELECT
   ! show '>> $Determ-Emp-Hlth-Welf-Ben = Y'
 
FROM PS_HEALTH_BENEFIT A
WHERE A.EMPLID   = $emplid_main  !A1.EMPLID
  AND A.EMPL_RCD = #job_empl_rcd !A1.EMPL_RCD
  AND A.PLAN_TYPE NOT IN ('1Q','1R','1S','1X')
  AND A.COVERAGE_ELECT = 'E'
  AND A.EFFDT = (SELECT MAX(A_ED.EFFDT) FROM PS_HEALTH_BENEFIT A_ED
        	WHERE A.EMPLID = A_ED.EMPLID
          	AND A.EMPL_RCD = A_ED.EMPL_RCD
          	AND A.COBRA_EVENT_ID = A_ED.COBRA_EVENT_ID
          	AND A.PLAN_TYPE = A_ED.PLAN_TYPE
          	AND A.BENEFIT_NBR = A_ED.BENEFIT_NBR
          	AND A_ED.EFFDT <= $X000_WHERE_SELECT_ASOFDATE) 
End-Select

!  show '========================================'
!  show '$COVERAGE_ELECT    :' $COVERAGE_ELECT 
!  show '$GEX_VOLUN_LOW_HRS :' $GEX_VOLUN_LOW_HRS 
!  show '$ELIG_CONFIG2      :' $ELIG_CONFIG2 
!  show '========================================'
     
     !^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     If $Determ-Emp-Hlth-Welf-Ben = 'Y'
         ! show '$Determ-Emp-Hlth-Welf-Ben =Y'
       Add 1 to #EE_Is_Enrolled_In_HW
       !keep processing - 
       !Need to determine where the EE falls in the Eligibility Config Field2  based on Actual Hours Worked panel:
       !Query PS_BEN_DEFN_PGM and PS_GEX_CONFG2_RULE
       !And on PS_BEN_DEFN_PGM need to determine if we need to use 
       !Related to Field/Field2 (fieldname and fieldname2)
       !And If the Benefit Program = G01,G03 or C10 then we don't need JOB the info. to be
       !referenced other than elig_config2 for processing
       
        !--------------------------------------------------------
        Evaluate $ben_pgm
           When = 'G01'
	   When = 'G03'
	   When = 'C10'
	   !newly added 
	   When = 'G05'         
	   When = 'C06'
	   When = 'C15'
	   When = 'R04' 	   
   	     Do Determ-EE-EligConf-Fld2-Proc1
   	        !show '$Determ-EE-EligConf-Fld2-Proc1 >'  $Determ-EE-EligConf-Fld2-Proc1 
   	   break

   	   When = 'R11'
	   When = 'R12'
	    !newly added 
	   When = 'R01' 
           When = 'R03' 
           When = 'R04' 
           When = 'R06' 
           When = 'R07' 
           When = 'R08' 
           When = 'R09' 
           When = 'R10' 
           When = 'R11' 
           When = 'R12' 
           When = 'R15' 
           When = 'R16' 
           When = 'R17' 
           When = 'R18' 
           When = 'R19' 
           When = 'R20' 
           When = 'R21' 
           When = 'R22' 
           When = 'R23' 
           When = 'R24' 
           When = 'R25' 
           When = 'R28' 
           When = 'R29' 
           When = 'R30' 
           When = 'R31' 
           When = 'R32' 
           When = 'R33' 
           When = 'R34' 
           When = 'R35' 
           When = 'R36' 
           When = 'R37' 
           When = 'R38' 
           When = 'R39' 
           When = 'R40' 
           When = 'R41' 
           When = 'R42' 
           When = 'R43' 
           When = 'R44' 
           When = 'R45' 
           When = 'R46' 
           When = 'R47' 
           When = 'R48' 	   
   	          !SHOW ' When-other BEN programs '
               If $full_part_time = 'F'
                    !show 'EE is a Full Time Employee:' $emplid_main
                  !If Employee is FT, Stop processing, don't send hours for EE
                  Let #ben_hrs  = 40 
               Else  
                    If $full_part_time = 'P'
	               Do Determ-EE-EligConf-Fld2-Proc2
                    Else
		         !show 'Other $full_part_time ::' $full_part_time
                    End-If       
   	       End-If  
           break
	 When-other
!	      SHOW '************************************************'
!     	      SHOW 'Employee is not in the above mentioned ben programs, so use default 40 ben hours'
!              show 'Entered into other Ben program: ' $ben_pgm
!              SHOW '************************************************'
	   Let #ben_hrs   = 40 
         End-Evaluate	
         !----------------------------------------------------
         
     Else
!           show ':: $Determ-Emp-Hlth-Welf-Ben :: ' $Determ-Emp-Hlth-Welf-Ben

       !If $Determ-Emp-Hlth-Welf-Ben ='N' 
   	Let $EE-cvg-elect-not-E ='Y'
!   	  SHOW '$EE-cvg-elect-not-E            :' $EE-cvg-elect-not-E 
   	Let #ben_hrs = 40
  	
   	Let $EE-on-top-level1 = 'Y'
   	
   	Add 1 to #EE-on-top-level1 
	Add 1 to #EE_Not_Enrolled_In_HW
	
!	  SHOW 'EE is not enrolled in H&W / $EE-on-top-level1 = Y / EE do not have any rows retrieved with coverage_elect E'
!   	  show 'Stop processing the Hours determination for the EE     :' $emplid_main
       ! End-If
     
     End-If 
     !^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
Else
! SHOW '$GEX_SMT_TRK_FLAG = N - So assing default #ben_hrs (40)'   
 
 Let #ben_hrs   = 40 ! i.e., $GEX_SMT_TRK_FLAG = 'N'   Ben Program is NOT applicable     
End-If

!**************************************************************************** 
End-procedure      
!****************************************************************************


!****************************************************************************
begin-procedure Determ-EE-EligConf-Fld2-Proc1
!   show '----> Entred into Determ-EE-EligConf-Fld2-Proc1'
!   show '<<$ELIG_CONFIG2 >>: '  $ELIG_CONFIG2
 
Let $Determ-EE-EligConf-Fld2-Proc1 = 'N'
 
 
 
 If $GEX_VOLUN_LOW_HRS  ='N'							 !New specs 01/30/06
!    show ' STOP Processing - Employees $GEX_VOLUN_LOW_HRS  =N :'  $emplid_main     !New specs 01/30/06
 
! If $ELIG_CONFIG2  <> 'C'
!   
!   show ' EE is either already at the TOP level of benefit: A for their group, or they have not been set at all:'  $emplid_main
!   show 'EE $ELIG_CONFIG2 is:' $ELIG_CONFIG2 
!         	!stop Processing
!   	        !EE is either already at the TOP level of benefit ('A') for their group 
!   	        !or they have not been set at all 
!   	        ! (This logic should also work to accommodate the C10 employees - for this group we only have actual hours logic for 
!   	        ! PT employees, however I don't think we need to include any extra logic for this.  The FP employees in C10 will not have their config set to C, 
!   	        !they will be at all  zeros so they should fall out).
!   
   
   Let $EE-on-top-level2 = 'Y'
   Let #ben_hrs = 40
   Add 1 to #EE-on-top-level2
!     show '$EE-on-top-level2 = Y'
 Else
!       show 'Continue PROCESSING ...FOR THIS EMPLOYEE:' $emplid_main
   
  If $ELIG_CONFIG2 = 'A' or  $ELIG_CONFIG2 = 'C'   !New specs 01/30/06
!       Show '$ELIG_CONFIG2 :' $ELIG_CONFIG2  !New specs 01/30/06
   
Begin-select on-error=sql-error-found('Determ-EE-EligConf-Fld2-Proc1')
CR.GEX_CONTRACT_HRS1

 Let #ben_hrs  = &CR.GEX_CONTRACT_HRS1
 Let $Determ-EE-EligConf-Fld2-Proc1 = 'Y' 
!   show 'CR.GEX_CONTRACT_HRS1:' &CR.GEX_CONTRACT_HRS1
 
FROM PS_GEX_CONFG2_RULE CR
WHERE CR.EFFDT = (SELECT MAX(A_ED.EFFDT) FROM PS_GEX_CONFG2_RULE A_ED
        WHERE CR.BENEFIT_PROGRAM = A_ED.BENEFIT_PROGRAM
        AND A_ED.EFFDT <= $X000_WHERE_SELECT_ASOFDATE)
        AND CR.GEX_EC2_BYTE_VAL = 'A'
        AND CR.BENEFIT_PROGRAM = $ben_pgm
End-Select
  Else						!New specs 01/30/06	
   Let #ben_hrs = 40
!     show ' '					!New specs 01/30/06
!     show 'Entere into Else condition '		!New specs 01/30/06
!     show '$ELIG_CONFIG2 :' $ELIG_CONFIG2         !New specs 01/30/06   
  End-If					!New specs 01/30/06
  
End-If
!****************************************************************************
End-procedure    
!****************************************************************************


!****************************************************************************
begin-procedure Determ-EE-EligConf-Fld2-Proc2
!   show 'Entred into Determ-EE-EligConf-Fld2-Proc2'
!    show ' <Ben program   >:' $ben_pgm
!    show ' <$ELIG_CONFIG2 >:' $ELIG_CONFIG2 
!    show ' <$ELIG_CONFIG1 >:' $ELIG_CONFIG1
!    show ' <$GEX_FP_CODE  >:' $GEX_FP_CODE 

 Let $Determ-EE-EligConf-Fld2-Proc2 = 'N'
 !Let $Related_Fields_Empty = 'Y'

If $ELIG_CONFIG2 = 'A' or  $ELIG_CONFIG2 = 'B' or  $ELIG_CONFIG2 = 'C' 
   
!     show 'CONTINUE.. PROCESSING FOR THIS EMPLOYEE>>:' $emplid_main
!     show '<$ELIG_CONFIG2 >			  :' $ELIG_CONFIG2  
   
    
Begin-select on-error=sql-error-found('Determ-EE-EligConf-Fld2-Proc2')
CR2.GEX_CONTRACT_HRS1

 Let #ben_hrs  = &CR2.GEX_CONTRACT_HRS1
 Let $Determ-EE-EligConf-Fld2-Proc2 = 'Y' 
  
!    show 'CR2.GEX_CONTRACT_HRS1:' &CR2.GEX_CONTRACT_HRS1
!    SHOW '#ben_hrs             :' #ben_hrs
   
FROM PS_GEX_CONFG2_RULE CR2
WHERE CR2.EFFDT = (SELECT MAX(A_ED2.EFFDT) FROM PS_GEX_CONFG2_RULE A_ED2
        WHERE CR2.BENEFIT_PROGRAM = A_ED2.BENEFIT_PROGRAM
        AND A_ED2.EFFDT <= $X000_WHERE_SELECT_ASOFDATE)
        and CR2.GEX_REL_VALUE  = $ELIG_CONFIG1
        and CR2.GEX_REL_VALUE2 = $GEX_FP_CODE 
        AND CR2.GEX_EC2_BYTE_VAL = 'A'
        AND CR2.BENEFIT_PROGRAM = $ben_pgm
End-Select
  
 Else     
   Let $EE-on-top-level3 = 'Y'
   Let #ben_hrs = 40  
   Add 1 to #EE-on-top-level3 
!     show 'Stop processing the Hours determination for the EE     :' $emplid_main
!     show 'EE $ELIG_CONFIG2 is                                    :' $ELIG_CONFIG2 
   
   
 End-If
!****************************************************************************
end-procedure    
!*****************************************************************************


!********************************************************************
begin-procedure get-shift-strgy-code
!********************************************************************
!   Show 'Entered into get-shift-strgy-code'
!
 #DEBUG show '&D.SI_ACCIDENT_NUM :' &D.SI_ACCIDENT_NUM
 #DEBUG show '$ben_pgm           :' $ben_pgm          
  
 move 'N' to $errorfound2
 move 'N' to $found2

begin-select ON-ERROR=SQL-ERROR-FOUND('get-shift-strgy-code')
SS.GEX_SEQ_NUM  			     
SS.GEX_CONTRACT_GRP                          
SS.UNION_CD   		
SS.GEX_JOBCODE                     
SS.BENEFIT_PROGRAM
SS.FULL_PART_TIME                            
SS.MAX_HRS
SS.GEX_PAY_TYPE                              
SS.GEX_AFTER_HIRE_DT
SS.GEX_BEFORE_HIRE_DT
SS.GEX_ACCT_CD
SS.GEX_VOL_INDICATOR
SS.GEX_SHIFT_STRGY

!   show 'entered inside the procedure'
                         
      move 'Y' to $found2                    
      move ' ' to $GEX_SHIFT_STRGY               
                                                         
     
     Do find-shift-strgy-code
     
     If $match-found2 = 'Y'
	 exit-select
     End-if 

FROM PS_GEX_BC_SH_STRGY SS
WHERE SS.GEX_CONTRACT_GRP = &D.SI_ACCIDENT_NUM
 AND  SS.BENEFIT_PROGRAM  = $ben_pgm
ORDER BY SS.GEX_SEQ_NUM
End-Select


 If $found2 = 'N'
    add 1 to #errorcount2
   !Do error-found !('six')
    print 'No match found for the Contract Number in Shift Strategy Table:' (,132)
    print &d.si_Accident_num ()
 Else
   If $match-found2 = 'N'
     add 1 to #errorcount2
    !Do error-found !('seven')
     print 'No Shift Strategy Code found' (,132)
   End-if
 End-if
!****************************************************************************
End-Procedure get-shift-strgy-code
!****************************************************************************

!*********************************************************************
!This procedure tries to match every non-null column with the source
!values and if everything matches, passes that row's shift strategy code 
!as the employee shift strategy code
!*********************************************************************
  
Begin-procedure find-shift-strgy-code
!  show 'entered into find-shift-strgy-code'

move 'Y' to $match-found2
move 'N' to $errorfound2

!-----------------------------------------------
if RTRIM(&SS.UNION_CD,' ') <> ''
   if &SS.UNION_CD <> &C.UNION_CD  
!   show 'No match for union code'
       move 'N' to $match-found2
      goto skip-match
   end-if
end-if
!-----------------------------------------------
if RTRIM(&SS.FULL_PART_TIME,' ') <> ''
   if &SS.FULL_PART_TIME <> &C.FULL_PART_TIME
   ! show 'No match for Full/Part Status'    
      move 'N' to $match-found2
      goto skip-match
   end-if
end-if

!-----------------------------------------------
If RTRIM(&SS.GEX_JOBCODE,' ') <> ''
   If &SS.GEX_JOBCODE <> &C.JOBCODE
      ! show 'No match for GEX_JOBCODE'    
      move 'N' to $match-found2
      goto skip-match
   End-if
End-if

!-----------------------------------------------

If RTRIM(&SS.GEX_PAY_TYPE,' ') <> ''
 	! new spec from debbie 05/16/06
	!Do not compare the &ccs_empl_type (used for finding Division Code only)
	! with GEX_PAY_TYPE on Shift Strategy Tbl
	!Instead use &EMPL_TYPE, So replaced &ccs_empl_type with &c.empl_type
   If &SS.GEX_PAY_TYPE <> &c.empl_type	!$ccs_empl_type
   ! show 'No match for Pay type'
      move 'N' to $match-found2
      goto skip-match
   End-if
End-if

 !-----------------------------------------------
 If RTRIM(&SS.GEX_AFTER_HIRE_DT,' ') <> ''
   Do get-string-date(&SS.GEX_AFTER_HIRE_DT, $after_hire_str_date, $after_hire_Date_ymd)
   Do get-string-date(&B.SERVICE_DT, $hire_Dt_Str, $hire_date_ymd)      
  If $hire_Date_ymd < $after_hire_Date_ymd
    ! show 'No match for Gex_After_Hire_DT'
      move 'N' to $match-found2
      goto skip-match
  End-if
 End-if
 !-----------------------------------------------
 
 If RTRIM(&SS.GEX_BEFORE_HIRE_DT,' ') <> ''
   Do get-string-date(&SS.GEX_BEFORE_HIRE_DT, $before_hire_str_date, $before_hire_Date_ymd)
   Do get-string-date(&B.SERVICE_DT, $hire_Dt_Str, $hire_date_ymd)      
   
   If $hire_Date_ymd > $before_hire_Date_ymd
     ! show 'No match for Gex_before_Hire_DT'
      move 'N' to $match-found2
      goto skip-match
   End-if
 End-if
 !-----------------------------------------------
  If RTRIM(&SS.GEX_ACCT_CD,' ') <> ''
   If &SS.GEX_ACCT_CD  <> &C.ACCT_CD
     ! show 'No match for SS.GEX_ACCT_CD'
      move 'N' to $match-found2
      goto skip-match
   End-if
 End-if
  !-----------------------------------------------
 If RTRIM(&SS.GEX_VOL_INDICATOR,' ') <> ''
   If &SS.GEX_VOL_INDICATOR  <> &C.GEX_VOLUN_LOW_HRS
     ! show 'No match for SS.GEX_VOL_INDICATOR'
      move 'N' to $match-found2
      goto skip-match
   End-if
 End-if


  ! show '==================2======================'
  ! show '$COVERAGE_ELECT    :' $COVERAGE_ELECT 
  ! show '$GEX_VOLUN_LOW_HRS :' $GEX_VOLUN_LOW_HRS 
  ! show '$ELIG_CONFIG2      :' $ELIG_CONFIG2 
  ! show '==================2======================'
  
  
      
    !---Mail from Diane On Tue 5/9/2006 9:06 AM
    !Employees who are enrolled in a BNFT Program but whose config 2 on job is blank 
    !and their enrollment record is not set to E
    
    !For these employees change the code to ignore max hours if config 2 is not set on job 
    !but a bnft program exists. 
    
    !The code shoud ignore the max hours but USE all of the other employee criteria on the 
    !shift strategy table to determine the correct shift strategy. 
    
   
  If   $GEX_SMT_TRK_FLAG     <> 'Y' 			
    	!Is the Benefit Program (G01/R11/C02/C03/C04 etc.,) eligible for actual hours calculation or NOT
 	!If YES, continue processing
    	!NO - default the benefit hours as 40
        
         or
      	 ($GEX_VOLUN_LOW_HRS  ='N')
      	 !If GEX_VOLUN_LOW_HRS = 'N', then stop processing for this employee
      	 !default the benefit hours as 40

         or
         
   	 ($GEX_SMT_TRK_FLAG     = 'Y' and ($COVERAGE_ELECT    <> 'E' or $ELIG_CONFIG2 = '' ) )
   	 !If the EE BP is applicable for the Actual Hours Calculation($GEX_SMT_TRK_FLAG     = Y)
   	 !But $COVERAGE_ELECT  is not set to E (NOT enrolled into a health and welfare type of benefit)
   	 ! or
   	 ! $ELIG_CONFIG2 is empty
   	 !default the benefit hours as 40
   	 
   	 !Since all the above checks have failed - IGNORE Max_Hrs/Benefit Hrs  criteria
   	 
   	 ! show '	$GEX_SMT_TRK_FLAG :' $GEX_SMT_TRK_FLAG
	 ! show '	$COVERAGE_ELECT   :' $COVERAGE_ELECT
	 ! show '	$ELIG_CONFIG2     :' $ELIG_CONFIG2
	 ! show ' $GEX_VOLUN_LOW_HRS:' $GEX_VOLUN_LOW_HRS
	 
         ! show ' DO NOT - Check for MAX_HRS'

    Else
         ! show ' DO Check for MAX_HRS'
	  !-----------------------------------------------
	   If &SS.MAX_HRS <> 0
	  !  If &SS.MAX_HRS  <> #ben_hrs    ISDVMXR  ITG # 37966   12/11/2006  start
	      show 'No match for MAX_HRS'
	     ! move 'N' to $match-found2
	     ! goto skip-match
	   ! End-if                         ISDVMXR  ITG # 37966   12/11/2006  end
	   End-if       
	  !-----------------------------------------------
   End-If


 If RTRIM(&SS.BENEFIT_PROGRAM,' ') <> ''
   If &SS.BENEFIT_PROGRAM  <> &PROG.BENEFIT_PROGRAM
     ! show 'No match for SS.BENEFIT_PROGRAM'
      move 'N' to $match-found2
      goto skip-match
   End-if
 End-if
  !-----------------------------------------------

 
skip-match:

 
 If $match-found2 = 'Y'
     ! show 'MATCH FOUND----' 
   
!     SHOW 'SS.GEX_SEQ_NUM  		  :'  &SS.GEX_SEQ_NUM  			     
!     SHOW 'SS.GEX_CONTRACT_GRP            :'  &SS.GEX_CONTRACT_GRP                         
!     SHOW 'SS.UNION_CD   		  :'  &SS.UNION_CD   		                    
!     SHOW 'SS.GEX_JOBCODE   		  :'  &SS.GEX_JOBCODE
!     SHOW 'SS.BENEFIT_PROGRAM             :'  &SS.BENEFIT_PROGRAM                          
!     SHOW 'SS.FULL_PART_TIME              :'  &SS.FULL_PART_TIME                           
!     SHOW 'SS.MAX_HRS                     :'  &SS.MAX_HRS                                  
!     SHOW 'SS.GEX_PAY_TYPE                :'  &SS.GEX_PAY_TYPE                             
!     SHOW 'SS.GEX_AFTER_HIRE_DT           :'  &SS.GEX_AFTER_HIRE_DT                        
!     SHOW 'SS.GEX_BEFORE_HIRE_DT          :'  &SS.GEX_BEFORE_HIRE_DT                       
!     SHOW 'SS.GEX_ACCT_CD                 :'  &SS.GEX_ACCT_CD                       
!     SHOW 'SS.GEX_VOL_INDICATOR           :'  &SS.GEX_VOL_INDICATOR                          
!     SHOW 'SS.GEX_SHIFT_STRGY             :'  &SS.GEX_SHIFT_STRGY                          
        
   move &SS.GEX_SHIFT_STRGY  to $GEX_SHIFT_STRGY
 End-if  
 
 ! show '$match-found2        :' $match-found2
 ! show '&SS.GEX_SHIFT_STRGY  :' &SS.GEX_SHIFT_STRGY  
 ! show '$GEX_SHIFT_STRGY     :' &SS.GEX_SHIFT_STRGY
 
!**************************************************************************** 
End-procedure find-shift-strgy-code
!****************************************************************************


!****************************************************************************
begin-procedure Alter-Session
  ! show 'Alter-Session'
begin-sql
  ALTER SESSION SET GLOBAL_NAMES = TRUE 
end-sql
!****************************************************************************
end-procedure Alter-Session
!****************************************************************************

#Include 'gexxx902.sqc'  !Get deptid multiple row table
#Include 'gexxx903.sqc'  !Get Emp_Stat Run Controls
#Include 'gexxx922.sqc'  !Get pay single row run control
#Include 'gexxx951.sqc'  !Get Oracle instance
#Include 'askaod.sqc'    !Ask-As-Of-Date routine
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'stdapi.sqc'    !Get_Run_Control Procedure
#Include 'datemath.sqc'  !Does the date-math functions
#Include 'gexxx971.sqc'  !Email and FTP Parameters   ! CWB 04/05/2004