!********************************************************************** 
! SQR Name:           pbzper.sqr  
! SQR Descr:          ADP Employment Tax Daily/Periodic Filing. 
! Created by:         drmonroe 
! Create date:        03/03/2010 
! Last modified by:   drmonroe
! Last modified date: 09/10/2015
!***********************************************************************
! Aug 31, 2016     Yash - OA Customization to include oaprcsdr.sqc
! ----------------------------------------------------------------------------------
! #define ADPTAX_CONFIG   !enable this if the client uses ADPTAX.SQC not PROBIZ.SQC
! ----------------------------------------------------------------------------------
 
!#define CLIENT_PAYINIT                       ! <------------ enable this and save as pbzpermu.sqr for multi-run   (only change required)

#define ADP_TAX_PERIODIC_SWEEP                ! <------------ enable this and save as pbzperco.sqr, for auto-sweep  (only change required)
#define ADP_TAX_PERIODIC_SWEEP_ONE_COMPANY    ! <-------     enable this (and above) and save as  pbzperad.sqr for auto-sweep with a starting live date
!#define ADP_TAX_PERIODIC_SWEEP_FROM_START_DATE ! <-------     enable this (and ADP_TAX_PERIODIC_SWEEP) and save as  pbzperad.sqr for auto-sweep with a starting live date

!#define ADP_TAX_PERIODIC_CHECK_DATE          ! <------------ enable this and save as pbzpercd.sqr, for check-date  (only change required if std TF_CHK_DT_RC is used)
                                              ! <------------ if both of the above are disabled, save as pbzper.sqr (normal run control)
 
#define ADP_TAX_PERIODIC  !tells the probiz.sqc this is a periodic run
 
#define PBZPER_release     20161116       ! yyyymmddn
 
#define PERIODIC_REPORT_ID PBZPER

#ifdef ADP_TAX_PERIODIC_SWEEP
   #define PERIODIC_REPORT_ID PBZPERAU
#endif
#ifdef ADP_TAX_PERIODIC_SWEEP_FROM_LIVE_DATE
   #define PERIODIC_REPORT_ID PBZPERAD
#endif
#ifdef ADP_TAX_PERIODIC_CHECK_DATE
   #define PERIODIC_REPORT_ID PBZPERCD
#endif
 
#define Program_Version    {PERIODIC_REPORT_ID}.Nov 16, 2016
#ifdef ADPTAX_CONFIG
 #include 'adptax.sqc'
#else
 #include 'probiz.sqc'
 #ifdef ADP_TAX_PERIODIC_SWEEP
   #include 'probizau.sqc'
 #endif
#endif
 
#if {SITE_ID} <> 'WFG1' !Wells is not using new option
   #define ADPNGTUI    ! if the client has at least a stub of the new adptcfg.sqc file.. enable this, allows probiz.sqc options to be overwritten
#endif
 
#ifdef ADPNGTUI
  #include 'adptcfg.sqc'
#endif
 
#ifndef RIMINI_STREET_TAX_UPDATES         
  #ifndef ADP_TAX_DEV
    #define PAACT_32_11F_LOGIC             !Allows the periodic and quarterly to use the new RES_PSD_CD and WORK_PSD_CD fields
    #define PA_ACT_32_SET_X1_FIELD_CODE    !The directs the quarterly extract to populate the Resident PSD code, not the Resident Local taxcode (X2)
  #endif
#endif
 
#ifndef PA_STATE ! tmg added 3/23/2011
 #define PA_STATE PA
#endif
 
#if {SITE_ID} = 'BKR1'
 #include 'fpathbi.sqc'
#endif
 
 
!---------------------------------------------
#if {SITE_ID} = 'USB1'
 #define CLIENT_PAYINIT  ! uses PS_MVP_PARMS run control, in mpayinit.sqc
#endif
   
#ifdef CLIENT_PAYINIT
  #if {SITE_ID} <> 'CRB1'                               ! <-- change pbzper.sqr to pbzpera.sqr for CRB1 10/18/2011
     #if {SITE_ID} <> 'USB1'
        #define CLIENT_PAYINIT_TF_RC_PAYINIT
     #endif
  #endif
#endif
 
 
#ifdef ADP_TAX_PERIODIC_CHECK_DATE  ! Define name of the run control table used for the Check Date version of the program
  #if {SITE_ID} <> 'HHS1'           ! note, Table: TF_PBZPOUT_D needs the PAY_END_DT (Key, Req'd) field for this feature (after the Paygorup field)
    #define CHECK_DATE_RUN_CONTROL_TBL   PS_{Client_Table_Prefix}CHK_DT_RC{Client_Table_Suffix} !OPRID, RUN_CNTL_ID, CHECK_DT, OFF_CYCLE are the fields
  #else
    #define CHECK_DATE_RUN_CONTROL_TBL   PS_N_TAX_RUN
  #endif
#endif
 
 
#if {SITE_ID} = 'WFG1'
  #define DECLARE_VARIABLES
#endif
 
#ifdef DECLARE_VARIABLES
begin-setup
declare-variable
 integer #SlctPageFrom
 integer #SlctPageThru
 integer #Payline_pagen
 integer #Payline_linen
 integer #ADJ_BALANCE_YEAR
 integer #ADJ_BAL_ADJ_SEQ
 integer #ADJ_BALANCE_QTR
 integer #year_out
 integer #qtr_out
 integer #Sweep_year
 integer #Sweep_qtr
 integer #payline_sepchk
end-declare
end-setup
#endif
 
 
#if {SITE_ID} = 'AXA1'
    #Include 'setup32.sqc'  !Landscape, PDF for Axa Financial, setup31 for portrait
#else
    #if {SITE_ID} = 'MLN1'
            #ifdef UNIX
                #Include 'mops177.sqc'  !Page-size initialization
            #else
                #Include 'setup32.sqc'  !printer and page-size initialization
            #endif
    #else
            #if {SITE_ID} = 'PFZ1'
               #Include 'setup02_m1.sqc'  !Printer and page-size initialization
            #else
               #Include 'setup02.sqc'  !Printer and page-size initialization
            #endif
    #endif
#endif
 
#if {SITE_ID} = 'INT1'
 #include 'ibp_proc.sqc'
#endif
 
 !11/10/2008
 !-----------
#if {SITE_ID} <> 'PFZ1'
 #ifdef NEW_TRANSPORTER
  #ifdef PAYGROUP_ROLLUP
   #define PAYGROUP_ROLLUP_EXTRACT
  #endif
 #endif
#endif
 
#define PA_WORKSITE_EXTRACT          !required, V1Q2011
#define PA_WORKSITE_AUTO             !required
#include 'adppaaut.sqc'
 
#ifndef ADPTAX_CONFIG
 #if {SITE_ID} = 'PMT1'
  #include 'z_proadp.sqc'    !New for ADP migration
 #else
  #include 'proadp.sqc'    !New for ADP migration
 #endif
#endif
 
#ifdef GENERAL_SUI_SPLIT_STATE
 #include 'adpuispl.sqc'
 #ifndef GENERAL_SUI_SPLIT_TAX_CLASS
   #define GENERAL_SUI_SPLIT_TAX_CLASS   U
 #endif
#endif

#define EXTRACT_RELEASE          V2Q2016

! --------------------------
!
! Author: Dan Monroe
!
! Version PBZPER.SQR - ADP Periodic extract 
!
! Purpose: This SQR generates a periodic tax extract and report which feed into the
!          ADP Employment Tax in specs 3.03 Format, allowing ADP to
!          handle ongoing tax liabilities.  Compatable for Peoplesoft versions from
!          7.5x through 9.1
!
! PROPERTY of ADP CAPS / A Division of ADP National Accounts
!
!Modification History
!--------------------
!
! Q4, 2010 release
! ------------------
! Nov  17, 2010    CHS1 - splits CT-SUI, with code in probiz.sqc for CHS1 to implement the logic and display results
! Nov  30, 2010    SWEEP_ON_CYCLE_CALENDARS_ONLY
! Dec  03, 2010    move #fm_tot to #associate_count_male --> move #m_tot to #associate_count_male
! Dec  13. 2010    CSX1, don't bypass the '8' and '9' tax classes as this is CSX's RR taxes
! Jan  06, 2011   CSX1
!                   the rate for Tax Class $U6 to 4.2%.  
!                   So the calculation needs to compute the employER tax at 6.2%.
! Jan  19, 2011    MCK1 no Dup for NM0001
! Jan  19, 2011    insert-taxes-into-negative-totals procedure fix to hanging issue @TBN1
! Jan  20, 2011    code added to bypass any future New Hire Act TBA's
! Jan  25, 2011    EXCISE_DEDUCTION added (NXT1)
! Feb  10, 2011    PA_WORKSITE_EXTRACT, PA_WORKSITE_AUTO standardized for V1Q2011
! Mar  14, 2011    SCR1, '50'
! Mar  18, 2011    ADPCUSNM_PERIODIC_OPEN (VFS1)
! Mar  24, 2011    TGP1 - CSST Canada
! Mar  28, 2011    TAXCODE_IN_HISTORY_TABLE option added
! Jun  28, 2011    determine_pa_worksite - prior to call, set the #PA_Txgrs for the PA Act 32 report
! Aug  12, 2011    set $PA_Taxcode for PA Act 32 logic
! Sep  01, 2011    #define TAXCODE_IN_HISTORY_TABLE   !9/1/2011 made standard
! **********************  V3Q2011 ******************************
! Sep  12, 2011    for CZB1 - changed name to match their production run control: PS_RBA_RC_PAY_OUT
! Sep  13, 2011    KEN1
! Sep  15, 2011    VF - change max page # from 9999 to 99999
! Sep  23, 2011    CZB1 company xref
! Sep  30, 2011    RDS1 - liability date issue projecting into last day of NEXT qtr instead of current quarter
! Oct  05, 2011    SCP1 run control 
! Oct  11, 2011    RDS1 updated liability date logic
! Oct  18, 2011    CRB1
! Oct  20, 2011    MASTER_TAX_HEADER - opens the extract with a longer rec length to accomodate header info produced in adpmtp.sqc
! Nov  01, 2011    bypass PA EIT data records if there is only wages (this is to handle the PA Act 32)
!  ************************* V4Q2011, Nov 30, 2011 *******************8888
! Dec 12, 2011     PAACT_32_11F_Logic
! Jan 06, 2012     WHS1
! Jan 12, 2012     add the Empl_rcd to the business unit query for 'BU' clients who write Business Unit into history table
! Feb 29, 2012     Fix PA Act 32 report header
! ************************** V1Q2012, March 6, 2012 *****************************
! Apr 16, 2012     USE_PAY_EARNINGS_TBL reworked (for BU clients - option to use this table (Pay_earnings) not Job
! Apr 18, 2012     new option (G4S) PERIODIC_ANNUAL_RECONCILIATION  (add this definition to the probiz.sqc file)
!
!                  COMPANY	STATE	TAX_CLASS	LOCALITY  	RES_PSD_CD	WORK_PSD_CD	QTD TAXES	QTD TAXABLE   YTD TAXES	YTD TAXABLE TAX DESCRIPTION
!
!                  This will utilize queries to pull the QTD and YTD data from the PS_TF_PBZ_HISTORY and PS_TF_ADP_BALADJ tables.   
!                  This option will not affect any other output files.  
!                  The name and location of the PERIODIC_ANNUAL_RECONCILIATION text file will be listed in the TRACE and the extract report.
!
!                  #ifdef PERIODIC_ANNUAL_RECONCILIATION
!                    #include 'adprecnp.sqc'   !procedure invoked: PERIODIC-ANNUAL-RECONCILIATION, filename: $annual_recon_filename
!                  #endif
! Apr 24, 2012     #ifdef RHI_CORP -  we're forcing the old liability dates to today, and NOT checking to see if we need to force it if quarter boundry exists
! May  1, 2012     PFZ1 Banking requirements
!                   #ifdef PFZ1_2012_BANKING_SPLIT
!                     do Get-Banking-Split-PFZ1  !returns: $HLD_VIRTUAL_CO = 'N'/'Y' and $PFZ1_VIRTUAL_CO would be the virtual company code if 'Y'
!                   #endif
! Aug  8, 2012     COMPANY_BALANCE_ADJUSTMENTS logic updated for Company leve TBA's w/PA Act 32 TBA structure (MTOA)
! ************************** V3Q2012, Sept 4, 2012 *****************************
! Sep 24, 2012     ADJ_REASON_TBAs_TO_EXCLUDE - for TBA's, exclude certain adjustments using the ADJ_REASON field
! Oct 25, 2012     Provide totals for $U6 - State FUTA, and $U7 - Medicare Surcharge rolled out in 12-E
! Nov  1, 2012     HISTORY_TABLE_RETRY, see 20121101
! ************************** V3Q2012, Sept 4, 2012 *****************************
! Dec 20, 2012     MTBI - 20121220
! Jan 29, 2013     SCP1 customized and merged from their Production pbzper.sqr
! Feb 15, 2013     Added Med-Sur to company and hash totals ($U7)
! Feb 20, 2013     #define INCLUDE_STATE_FUTA_IN_PERIODIC    (we will default to NOT including Tax_Class '6')  see 20130220
! Mar 19, 2013     ADP_BYPASS_TABLE option
! Mar 26, 2013     INCLUDE_KS_REGENT - 	This option could be used to pull in taxes from a client 'bolt on' table containing current payroll activity
!                                       See the '\ADP_DEV_Extracts\custom_MT\Kansas\source\probiz.sqc' for details
! Apr 02, 2013     04022013 removed per Sheral, TBA logic  (MC17944)
! May  1, 2013     setup 2012 as a payroll tax holiday year too for the CSX RRT calc
! Oct 29, 2013     WFG1 custom code brought to standard Q4 release
! Nov 22, 2013     ADP_TAX_PERIODIC_PAY_CHECK_CHECK_DT
! Nov 25, 2013     SWEEP_CHECK_DT_FROM_RC_QTR   sweeps based on the $Check_Dt_RC for pbzpercd.sqr runs
!                  USE_DT_ENTERED_FOR_TBAs option added
! Dec 16, 2013     CSX1 - taxcode mapping to handle addl med correctly
! Jan 20, 2014     change JCP1 custom logic for weeks custom front end to PBZPER_WEEK_PROCESSING
! Apr 02, 2014     The way Colonial identifies them in PeopleSoft is by location code equal to:	
!                  if PS_JOB.Location = '0243', company ELS, LA-SUI, change Company code to ELS 0243  (see their probiz.sqc 4/2/2014)
!                  new definition: GENERAL_SUI_SPLIT_STATE
!                       see adpuispl.sqc created for a general solution to splitting a state SUI by Location or tax location cd
! May 02, 2014     bypass memo PR tax balance adjustments
! Oct 02, 2014     Added 'ISNULL' syntax in get-payline for Microsoft db's
! Nov 03, 2014     STATE_EE_COUNT_BREAKDOWN_EMPLID
! Jan 07, 2015     New option to skip insert into PBZ History if it fails   SKIP_PBZ_HISTORY_INSERT_IF_ERROR
! Jan 30, 2015     TBA_SWEEP_BYPASS_CRITERIA option added
! Feb 24, 2015     calendar_check_dates - array keeping calendar check dates for TBA logic (USE_CALENDAR_CHECK_DATE_FOR_TBAs only)
! Apr  8, 2015     payroll report getting called twice for IRC1 see: "April 8, 2015"
! Apr 20, 2015     MASTERTAX_LOG_SENT_PAYLINES
! Jun 13, 2015     GENERAL_SUI_SPLIT_STATE updated
! Jun 17, 2015     USE_CALENDAR_CHECK_DATE_FOR_TBAs  - add option to not pull any TBA's unless the company is in the array
!                    PROCESS_TBAs_for_COMPANIES_IN_CALENDAR_ONLY
! Jul 15, 2015     FORCE_TBAS_TO_FUTURE  
!                  TBAS_INTO_FUTURE         3 
! Sep 10, 2015     CBU1 custom main tax query CUSTOM_US_RUN_TAXES option
! Dec 18, 2015     CBU1 add SEPCHK to PS_TF_PBZ_SENT_SEP
! May 13, 2016     OHIO_COURTESY_WITHHOLDING added for Q2
! Jul  1, 2016     CUSTOM_EMPLOYMENT_TYPE PEN added (map retirees to PEN) see probiz.sqc
! Jul 18, 2016     USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs
! Aug 31, 2016     Standardize MULTIPLE_SITES Option with WG
! Oct 24, 2016     INCLUDE_GL_IN_PBZ_HISTORY, adds  GL_EXPENSE and DESCR to the PS_TF_PBZ_HISTORY (GenPts)
!                      use LWT-Lookup and SWT-Lookup
! Nov 1,  2016     SUBTOTAL_BUSINESS_UNIT_EXTRACT like SRC_BANK
! Nov 16, 2016     Correction to SUBTOTAL_BUSINESS_UNIT_EXTRACT
!---------------------------------------------------------------------------------------------------------------------------- !
 
 #define TAXCODE_IN_HISTORY_TABLE   !9/1/2011 made standard
 #define HISTORY_TABLE_RETRY

 
!#define DEBUG_OH
!#define debug_adj
 
 #if {SITE_ID} <> WFG1'
     #define ADP_RECAP_PERIODIC_REPORT
 #endif
 #define FORCE_FILE_HEADER_AND_TRAILER
 
 !wells - MC20547 - Wells would like to use this option
 #if {SITE_ID} = 'WFG1'
   #define  FULL_PRINT_WAGE_FORMAT
 #endif
 #if {SITE_ID} = 'DOW1'
   #include 'setenv.sqc'
 #endif
 
#ifdef MULTIPLE_SITES	             !default multi-site table and field
  #ifndef WGPS_SITE_FIELD
    #define WGPS_SITE_FIELD {Client_Field_Prefix}WGPS_SITE{Client_Field_Suffix}
  #endif
  #ifndef ALT_SITES_CO_TABLE
    #define ALT_SITES_CO_TABLE PS_TF_ALT_SITES_CO{Client_Table_Suffix}
  #endif
  #ifndef ALT_SITES_TABLE
     #define ALT_SITES_TABLE PS_{Client_Table_Prefix}ALT_SITES{Client_Table_Suffix}
  #endif
  #ifndef INSTALLATION_TABLE
    #define INSTALLATION_TABLE  PS_{Client_Table_Prefix}INSTALLATION{Client_Table_Suffix}
  #endif
  #ifndef PBZPER_RC_TABLE
    #define PBZPER_RC_TABLE  PS_{Client_Table_Prefix}PBZPER_RC{Client_Table_Suffix}
  #endif
#endif
 
 #ifndef Client_ID
  #define Client_ID
 #endif
 
 #ifndef SITE_ID
  #define SITE_ID
 #endif
 
 #ifdef TEST_EMPLID
   #define debug_pbz     ! internal debugging
   #define debugx        ! for datetime debugging
 #endif
 
 #if {SITE_ID} = 'CHB1'
   #Include 'fpsetup.sqc'    !For CHB1 - Modified to export the DAT file into UNIX BOX Specified Location
                             !To Set File Path and Get Parameter Value - 24th Jan 2007
   #define tool_name 'ADPP'
 #endif

! OA Customization - Yash 08/31/2016 - Start
 #if {SITE_ID} = 'OGR1'
   #include 'oaprcsdr.sqc'
 #endif

 #if {SITE_ID} = 'ONA1'
   #include 'oaprcsdr.sqc'
 #endif
! OA Customization - Yash 08/31/2016 - End

 #if {SITE_ID} = 'FMG1'
  #include 'ftptransfer.sqc' ! FTP TRANSFER  for Peoplesoft 8.3
 #endif
 
 #if {SITE_ID} = 'CZB1'
   #define CLIENT_PAYINIT  !11/8/6
   #define CLIENT_PAYINIT_TF_RC_PAYINIT
 #endif
 
 #if {SITE_ID} = 'MAC1'
    #define USE_CALENDAR_CHECK_DATE_FOR_TBAs
 #endif
 
 #if {SITE_ID} = 'CGI1'
    #define USE_CALENDAR_CHECK_DATE_FOR_TBAs
 #endif
 
 #if {SITE_ID} = 'WFG1'
    #define USE_CALENDAR_CHECK_DATE_FOR_TBAs
 #endif
 
 !#define debug_pbz     ! internal debugging
 !#define debugx        ! for datetime debugging
 !#define testing       ! internal testing
 !#define debug_OREGON
 !#define debug_history_table_insert
 !#define debugit
 !#define debug_pdf
 !#define debug_adj_details
 
 #ifndef debug_pbzper_emplid
   #define debug_pbzper_emplid
 #endif

 #ifndef FORM1042_Taxcode
   #define FORM1042_Taxcode    FORM1042   !1042 FIT Taxcode
 #endif
 
 #ifndef FORM945P_Taxcode
   #define FORM945P_Taxcode    FORM945P   !945P FIT Taxcode
 #endif
 
! #define SUBTOTAL_TAXCODES_BY_CHECK_DATE !standard 8/30/07
 
 !comment this out when the newer (> 11/18/98) tax001 tax update has occured
 !--------------------------------------------------------------------------
 !#define Tax001_75_old
 
 !default parameters for client specific data
 !-------------------------------------------
 #ifndef PAYGROUP_FIELD
   #define PAYGROUP_FIELD       A.PAYGROUP
 #endif
 
 #ifndef PERIODIC_REPORT_ID
   #define PERIODIC_REPORT_ID   PBZPER
 #endif
 
 #ifndef PeopleSoft_Version
   #define PeopleSoft_Version 7.51
 #endif
 
 #ifdef LOG_SENT_PAYLINES
   #ifdef CUSTOM_US_RUN_TAXES
     #define SENT_PAYLINE_TABLE   PS_{Client_Table_Prefix}PBZ_SENT_SEP{Client_Table_Suffix}
   #else
     #define SENT_PAYLINE_TABLE   PS_{Client_Table_Prefix}PBZ_SENT{Client_Table_Suffix}
   #endif
 #endif
 
 #ifdef MASTERTAX_LOG_SENT_PAYLINES
  #define MASTERTAX_SENT_PAYLINE_TABLE   PS_Z_MASTERTAX_LOG
  #define debug_sent_pay_lines 100
 #endif
 
 #if {SITE_ID} <> 'SCP1'
  #define DUP_B     t
 #else
  #define DUP_B     f
 #endif
 
 !-------------------------------------------------
 !DUP_UF - duplicate Employee Medicare (for employer)
 !       - EE ($UF) generate the ER (FMCC) tax too
 !DUP_UD - duplicate Employee Soc.Sec (for employer)
 !       - EE ($UD) generate the ER (FSSC) tax too
 !DUP_B  - Duplicate any tax class of "B"
 !-------------------------------------------------
 #define DUP_UF    t
 #define UF_EE_TAXCODE     $UF
 #define UF_ER_TAXCODE     $UQ
 
 #define DUP_UD    t
 #define UD_EE_TAXCODE     $UD
 #define UD_ER_TAXCODE     $UE
 
 #define DUP_PRD    t               !these three defs added 4/3/00
 
 #define PRD_EE_TAXCODE     PRD
 #define PRD_ER_TAXCODE     PRE
 
 #define DUP_CANADIAN_PENSION t
 
 
!if we're not sending the off-cycles as we go..., always use the check date from calendar
!-----------------------------------------------------------------------------------------
#ifndef LOG_SENT_PAYLINES
  #define USE_CHECK_DATE_FROM_CALENDAR_ALWAYS
#endif
 
#if {SITE_ID} = 'FHL1'
  #define DATABASE_NAME_PSDBOWNER_DBNAME
#endif
 
#ifndef ADP_COMPID_EXTRACT_STRIPPED_REPORT
 #ifndef SUBTOTAL_COMPANY
  #ifndef SUBTOTAL_FEIN
   #ifndef SUBTOTAL_SRC_BANK_ID_EXTRACT
    #ifndef SUBTOTAL_BUSINESS_UNIT_EXTRACT
     #define SUBTOTAL_COMPANY
    #endif
   #endif
  #endif
 #endif
#endif
 
 
#if {SITE_ID} = 'SOL1'
 #define USE_CHECK_DATE_FROM_PAY_CHECK
#endif
 
#if {SITE_ID} = 'PFZ1'
 #define USE_CHECK_DATE_FROM_PAY_CHECK
#endif
 
 !----------------- Peoplesoft version specific definitions ---------
 !-------------------------------------------------------------------
 !Note, the following definitions are due to the changes in the
 !name and type of several variables (field names) between
 !PeopleSoft version 6..7.5x
 !          6,7,7.5x                  Definition
 !     -----------------------        ----------
 !     Balance_Year                   BAL_YEAR
 !     Balance_Qtr (numeric)          BAL_QTR
 !     Balance_Period (numeric)       BAL_PERIOD
 !
 
 ! PeopleSoft Version 6 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} = '6'
   #define CAL_QTR                Q.BALANCE_QTR
   #define CAL_YEAR               Q.BALANCE_YEAR
   #define CAL_PERIOD             Q.BALANCE_PERIOD
   #define BAL_PERIOD             BALANCE_PERIOD
   #define BAL_YEAR               BALANCE_YEAR
   #define BAL_QTR                BALANCE_QTR
   #define BAL_QTR_TYPE           #
   #define BAL_PERIOD_TYPE        #
   #define SSN_ID                  A1.SSN
 #endif
 
 ! PeopleSoft Version 7 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} = '7'
   #define CAL_QTR                Q.BALANCE_QTR
   #define CAL_YEAR               Q.BALANCE_YEAR
   #define CAL_PERIOD             Q.BALANCE_PERIOD
   #define BAL_PERIOD             BALANCE_PERIOD
   #define BAL_YEAR               BALANCE_YEAR
   #define BAL_QTR                BALANCE_QTR
   #define BAL_QTR_TYPE           #
   #define BAL_PERIOD_TYPE        #
   #define SSN_ID                  A1.SSN
 #endif
 
 ! PeopleSoft Version 7.5 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} = '7.5'
    #define CAL_QTR                Q.BALANCE_QTR
    #define CAL_YEAR               Q.BALANCE_YEAR
    #define CAL_PERIOD             Q.BALANCE_PERIOD
    #define BAL_PERIOD             BALANCE_PERIOD
    #define BAL_YEAR               BALANCE_YEAR
    #define BAL_QTR                BALANCE_QTR
    #define BAL_QTR_TYPE           #
    #define BAL_PERIOD_TYPE        #
    #define DUP_UD  f
    #define DUP_UF  f
    #define DUP_PRD f
    #define DUP_CANADIAN_PENSION t
    #define SSN_ID                 H.NATIONAL_ID
 
 
    #include 'usarpt.sqc'
 
    !#define TIPS_ROLLUP
    !------------------------------------------------------------
    !Ogden Services has the following tax_class definitions:
    !(new tax classes)    (description)           (Implemented @Ogden)
    !D - OASDI EE       OASDI/Disability - EE                Yes
    !E - OASDI ER       OASDI/Disability - ER                Yes
    !F - Med EE         FICA Medicare - EE                   Yes
    !G - OASDITipEE     FICA OASDI Tips - EE                 Yes
    !J - OASDITipER     FICA OASDI Tips - ER                 Yes
    !Q - Med ER         FICA Medicare - ER                   Yes
    !T - MEDTipEE       FICA Medicare Tips - EE              YES
    !W - VDI EE         Voluntary Disability Plan - EE       No
    !X - VDI ER         Voluntary Disability Plan - ER       No
    !Z - MEDTipER       FICA Medicare Tips - ER              Yes
    !-------------------------------------------------------------------
 
    !-------------------------------------------------------------TaxClass
    !the following defwill rollup OASDI EE TIPS --> OASDI EE FICA  G -> D
    !                         and OASDI ER TIPS --> OASDI ER FICA  J -> E
    !                         and MEDIC EE TIPS --> MEDIC EE FICA  T -> F
    !                         and MEDIC ER TIPS --> MEDIC ER FICA  Z -> Q
    !-------------------------------------------------------------
 
  #endif
 
 
 ! PeopleSoft Version 7.5 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} >= '7.51'
    #define CAL_QTR                Q.BALANCE_QTR
    #define CAL_YEAR               Q.BALANCE_YEAR
    #define CAL_PERIOD             Q.BALANCE_PERIOD
    #define BAL_PERIOD             BALANCE_PERIOD
    #define BAL_YEAR               BALANCE_YEAR
    #define BAL_QTR                BALANCE_QTR
    #define BAL_QTR_TYPE           #
    #define BAL_PERIOD_TYPE        #
    #define DUP_UD  f
    #define DUP_UF  f
    #define DUP_PRD f
    #define DUP_CANADIAN_PENSION t
    #define SSN_ID                 H.NATIONAL_ID
 
    #define GETLCLDATA_751
    #include 'usarpt.sqc'
    !#define TIPS_ROLLUP
 
  #endif
 
 #if {SITE_ID} = 'BTS1'
  #define DUP_UF            t
  #define UF_EE_TAXCODE     $UF
  #define UF_ER_TAXCODE     $UQ
  #define DUP_UD            t
  #define UD_EE_TAXCODE     $UD
  #define UD_ER_TAXCODE     $UE
 #endif
 
 
 #if {PeopleSoft_Version} < '8'
 
 #ifdef INFORMIX                       !Informix Database engine
    #define ln       LINEN
    #define pg       PAGEN
    #define emp_rec  EMPL_RCDN
  #endif
 
 #ifdef DB2ALL
   #define ln       LINE#
   #define pg       PAGE#
   #define emp_rec  EMPL_RCD#
 #endif
 
 #ifdef MICROSOFT                      !SQL Server engine
   #define ln       LINE#
   #define pg       PAGE#
   #define emp_rec  EMPL_RCD#
 #endif
 
 #ifdef SQLBASE                        !SQL Base (Standalone P/S)
   #define ln       LINE#
   #define pg       PAGE#
   #define emp_rec  EMPL_RCD#
 #endif
 
 #ifdef ORACLE                         !Oracle
   #define ln       LINE#
   #define pg       PAGE#
   #define emp_rec  EMPL_RCD#
 #endif
 
 #ifdef SYBASE                         !Sybase
   #define ln       LINE#
   #define pg       PAGE#
   #define emp_rec  EMPL_RCD#
 #endif
 
 #ifndef ln
   #define ln       LINE#
 #endif
 
 #ifndef pg
   #define pg       PAGE#
 #endif
 
 #ifndef chk
   #define chk      CHECK#
 #endif
 
 #else
 
    #define chk      CHECK_NUM
    #define ln       LINE_NUM
    #define pg       PAGE_NUM
    #define emp_rec  EMPL_RCD
    #define DUP_CANADIAN_PENSION t
 
 #endif
 
#define PRINT_HIGHLIGHT                  
#ifdef BOLD_UNDERLINE
  #define PRINT_HIGHLIGHT   bold underline
#endif
 
#include 'curdttim.sqc'  !Get-Current-DateTime procedure
#include 'datetime.sqc'  !general date and time formatting procedures
#include 'datemath.sqc'  !Date Functions
#include 'number.sqc'    !general number formatting procedures
 
 
! *************************************** end of configuration / definitions ********************************
 
 begin-report
 
 #if {SITE_ID} = 'USB1'
  show 'Calling MVP-Track-SQR-Start...'
  do MVP-Track-SQR-Start 
 #endif
 
 do Define-Standard-Vars
 
  show ''
  show '------------------------>  ADP Employment Tax:    begin-report {PERIODIC_REPORT_ID}        Site ID = {Site_ID}         Program_Version: {Program_Version}'
  show ''
 
  let #site_id_len = length('{SITE_ID}')
  if #site_id_len <> 4
     show ''
     show ' ********************** Warning: invalid SITE_ID length.  It must be 4 chacters long. (defined in probiz.sqc).'
     show ''
     stop
  end-if
 
 
  #if {SITE_ID} = 'SIE1'
    DO GET-SQR-VARIABLES !SRT23378
  #endif
 
  !Infosys Modification- Modified code to pick parms from parm file in MF instead of Harcoded values
  !#if {SITE_ID} = 'PSS1'
  !  let $Prcs_Process_Instance = 'MVS'    
  !  let $Prcs_OprID            = 'BATCH2'   ! This is the OPRID in your RC_PAYINIT
  !  let $Prcs_Run_Cntl_ID      = 'PBZPER'   ! This is the RUN_CNTL_ID in your RC_PAYINIT
  !#endif
  
  !UPG9 pss 07/12/2008, Modification begins
    #ifdef SITE_ID
     #if {SITE_ID} = 'PSS1'
      #ifdef MVS
       input $Prcs_OprID maxlen=8 'Enter your oprid'
       uppercase $Prcs_OprID
       input $Prcs_Run_Cntl_ID maxlen=30 'Enter your run control id'
       uppercase $Prcs_Run_Cntl_ID
       show 'prcs_oprid : ' $prcs_oprid
       show 'prcs_run_cntl_id: ' $prcs_run_cntl_id
      #endif
     #endif
    #endif
!UPG9 pss 07/12/2008, Modification ends
!Infosys Modification Ends
 
  #if {SITE_ID} = 'ELI1' 
  !Modification A
    INPUT $LLY_Input_Check_Dt MAXLEN=10 'Input Check Date = YYYY-MM-DD' TYPE=CHAR
    If length($LLY_Input_Check_Dt) < 10
       display 'Missing or Invalid Check Date - 1st Parm Card'
       Move 1 to #Return-Status
       STOP
    End-If
  #end-if
 
 
  #if {SITE_ID} = 'CSX1'
    #ifdef UNIX
      do Set-Prefix-From-Env
    #endif
  #endif
 
 
  #if {PeopleSoft_Version} < '6'
    display 'Peoplesoft Version {PeopleSoft_Version} not supported.'
    stop
  #endif
 
  #if {PeopleSoft_Version} > '9.9'
    display 'Peoplesoft Version {PeopleSoft_Version} not supported (yet).'
    stop
  #endif
 
  let $Release_Version      = '{PBZPER_release}'
 
  show 'Client ID          = ' '{CLIENT_ID}'
  show 'Site ID            = ' '{SITE_ID}'
  show 'Program Version    = ' '{Program_Version}'
  show 'Release Version    = ' $Release_Version
  show 'PeopleSoft Version = ' '{PeopleSoft_Version}'
  show 'Client Setup Vers. = ' '{Client_Setup_Version}'
  show 'Extract Specs      = ' '{Periodic_extract_specs}'
 
  let #site_id_len = length('{SITE_ID}')
  if #site_id_len <> 4
    show ' ********************** Error: invalid SITE_ID (see probiz.sqc) = {SITE_ID}'
  end-if
  
  #ifdef ADP_LIVE_DATE_DTU
  show 'ADP Live Date      = ' '{ADP_LIVE_DATE_DTU}'
  #endif
  #ifdef BYPASS_PRIOR_TO_LIVE_DATE
  show 'Bypassing records prior to live date enabled'
  #endif
 
  #ifdef MULTIPLE_SITES
    show 'MULTIPLE_SITES enabled, must have the SITE_ID in the run control'
  #endif
  
  #ifdef GET_BALANCE_ADJUSTMENTS
    show 'Getting Balance Adjustments'
    #ifdef COMPANY_BALANCE_ADJUSTMENTS
      show 'Getting Balance Adjustments for Companies in this run_id.'
    #endif
    #ifdef EMPLID_BALANCE_ADJUSTMENTS
      show 'Getting Balance Adjustments for employees paid during the run_id.'
    #endif
    #ifdef SWEEP_BALANCE_ADJUSTMENTS
      show 'Sweeping ALL Balance Adjustments'
    #endif
    #ifdef TBA_LIVE_YEAR
      show 'TBA_LIVE_YEAR = {TBA_LIVE_YEAR}'
    #endif
    #ifdef TBA_LIVE_QTR
      show 'TBA_LIVE_QTR = {TBA_LIVE_QTR}'
    #endif
    #ifdef SUBTOTAL_TBAs
      show 'SUBTOTAL_TBAs'
    #endif
    #ifdef SWEEP_BALANCE_ADJUSTMENTS_TAXES_ONLY
      show 'SWEEP_BALANCE_ADJUSTMENTS_TAXES_ONLY'
    #endif
  #endif
 
  #ifdef PAYGROUP_ROLLUP
    show 'Paygroup Rollup Enabled.'
  #endif
  
  #ifdef PAYGROUP_ROLLUP_EXTRACT
    show 'Paygroup Rollup into Extract Enabled.'
    #ifndef PAYGROUP_ROLLUP
      show 'Paygroup Rollup not Enabled.'
      show 'ERROR:  Paygroup_Rollup must be enabled for this feature to function'
      stop
    #endif
  #endif
 
  
  #ifdef NEW_TRANSPORTER
   #ifndef PAYGROUP_ROLLUP
    show 'NEW_TRANSPPORTER option valid with Company level reporting only. PAYGROUP_ROLLUP is required.'
    stop
   #endif
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
    show 'NEW_TRANSPPORTER option valid with Company level reporting only. SUBTOTAL_ADP_COMPID_EXTRACT invalid'
    stop
   #endif
   #ifdef SUBTOTAL_FEIN_EXTRACT
    show 'NEW_TRANSPPORTER option valid with Company level reporting only. SUBTOTAL_FEIN_EXTRACT invalid.'
    stop
   #endif
  #endif
 
  #if {Year4} = '1'
    show '4 char year format enabled'
  #else
    show '2 char year format enabled'
  #endif
 
  #ifdef ADPTAX_CONFIG
   show 'ADPTAX_CONFIG enabled.   adptax.sqc included'
  #endif
  
  #ifdef ADJUST_ZERO_LOCALS                     ! clears wages for zero YTD withholdings on ALL locals
    show 'ADJUST_ZERO_LOCALS enabled.  Wages cleared for Locals with zero taxes withheld.'
  #endif
  
  #ifdef PERIODIC_ANNUAL_RECONCILIATION
   show 'PERIODIC_ANNUAL_RECONCILIATION enabled'
  #endif
 
  #ifdef BYPASS_ZERO_LOCALS_PERIODIC
   show 'BYPASS_ZERO_LOCALS_PERIODIC enabled'
  #endif
  
  #ifdef IGNORE_QUARTERLY_TAXES
  show 'Bypassing All Taxes which are normally funded Quarterly.'
  #endif
 
  #ifdef VALIDATE_CHECK_DATE
  show 'Validating check dates against weekend and holidays (see: validcdt.sqc).'
  #endif
 
  #ifdef LOG_SENT_PAYLINES
  show 'LOG_SENT_PAYLINES.'
  #endif
 
  #ifdef USE_CHECK_DATE_FROM_PAY_CHECK
  show 'USE_CHECK_DATE_FROM_PAY_CHECK'
  #endif
  
  
  #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
  show 'SUBTOTAL_TAXCODES_BY_CHECK_DATE'
  #endif
  
  #ifdef USE_CHECK_DATE_FROM_CALENDAR_ALWAYS
  show 'USE_CHECK_DATE_FROM_CALENDAR_ALWAYS.'
  #endif
 
  #ifdef FORCE_OLD_CHECK_DATES_TO_FUTURE
  show 'FORCE_OLD_CHECK_DATES_TO_FUTURE.'
  #endif
 
  #ifdef DAYS_INTO_FUTURE
  show 'DAYS_INTO_FUTURE = {DAYS_INTO_FUTURE}.'
  #endif
 
  #ifdef CANADA_TOO
  show 'Processing Canadian taxes.'
  #endif
 
 
  #ifdef CANADA_HEALTH_TOO
  show 'Processing Canadian Health too.'
  #endif
 
  #ifdef CUSTOM_RUN_DAILY_BATCH
  show 'CUSTOM_RUN_DAILY_BATCH.'
  #endif
 
  #ifdef CLIENT_PAYINIT
  show 'CLIENT_PAYINIT.'
  #endif
  #ifdef CLIENT_PAYINIT_TF_RC_PAYINIT
  show 'CLIENT_PAYINIT_TF_RC_PAYINIT'
  #endif
  
  #ifdef IGNORE_TAXES_PRO_DOESNT_FILE
  show 'Bypassing All Taxes which are not funded by ADP Employment Tax Extract.'
  #endif
 
  #ifdef GENERATE_BYPASSED_REPORT
  show 'Reporting on Bypassed Taxes.'
  #endif
 
  #ifdef GENERATE_HISTORY_TABLE
  show 'Generating History of periodic extract run.'
  #endif
 
  #ifdef GENERATE_BYPASSED_TABLE
  show 'Generating History of taxes bypassed in periodic extract run.'
  #endif
 
  #ifdef GENERATE_TRANSMIT_TABLE
  show 'Generating History of periodic extract transmissions.'
  #endif
 
  #ifdef BYPASSED_REPORT_FILENAME
  show 'Bypassed Taxes Report: {BYPASSED_REPORT_FILENAME}'
  #endif
 
  #ifdef IGNORE_NYD
  show 'Bypassing NY Disability Insurance.'
  #endif
 
  #ifdef IGNORE_NYW
   show 'Bypassing NY Voluntary DI - EE.'
  #endif
 
  #ifdef IGNORE_NYX
   show 'Bypassing NY Voluntary DI - ER.'
  #endif
 
  #ifdef IGNORE_NYD
  show 'Bypassing NY Disability Insurance.'
  #endif
 
  #ifdef IGNORE_NJD
  show 'Bypassing NJ Disability Insurance EE.'
  #endif
 
  #ifdef IGNORE_NJE
  show 'Bypassing NJ Disability Insurance ER.'
  #endif
 
  #ifdef IGNORE_SUI
  show 'Bypassing State Unemployment Taxes ER, and Special Ui taxes.'
  #endif
  #ifdef IGNORE_SUI_EE
  show 'Bypassing State Unemployment Taxes EE.'
  #endif
 
  #ifdef IGNORE_CLASS_X
  show 'Bypassing Special UI-ER Taxes.'
  #endif
 
  #ifdef IGNORE_FUI
  show 'Bypassing Federal Unemployment Taxes.'
  #endif
 
  show 'Running ADP EmploymentTax Periodic Tax Extract...'
  show '-------------------------------------------------'
 
  #ifdef BY_FROM_THRU_DATES
    show 'Using FROM ... THRU Dates to get Pay Runs...'
  #else
    #ifdef BY_PAYENDDT
      show 'Using PAY-END-DATE to get Pay Runs...'
    #else
      #ifdef MULTIPLE_RUNS
        show 'Using MULTIPLE RUNS to get Periodic Data...'
      #else
        #ifdef INPUT_VIA_CHECK_DATE
          show 'Using Check-Date to get Periodic Data...'
        #else
         #ifdef CUSTOM_RUN_SELECTION
           #ifdef CUSTOM_RUN_DAILY_BATCH
             show 'Using Automated Run Control technique to get Periodic Data...'
           #else
             show 'Using CUSTOM_RUN_SELECTION to get Periodic Data...'
           #endif
         #else
          show 'Using RUN-ID to get Pay Runs...'
         #endif
       #endif
      #endif
    #endif
  #endif
 
  do Init-DateTime
  do Init-Number
  do Get-Current-DateTime
 
  #ifdef PA_WORKSITE_EXTRACT
   show 'PA_WORKSITE_EXTRACT enabled.'
   do init-PA-worksites
  #endif
 
  #ifdef SET_CREDIT_DATE_TO_TODAY
    show 'SET_CREDIT_DATE_TO_TODAY... AsofToday = ' $AsofToday
  #endif
 
  #if {SITE_ID} = 'MCK1'
    do Convert-to-Dtu-date($AsOfToday,$dtutoday)
    do Dtu-Add-Days($dtutoday,1,$Today_Plus1)
    do Convert-from-Dtu-date($Today_Plus1,$Today_Plus1)
    do Format-DateTime($AsOfToday,$Run_Dt_CMP,{DEFCMP},'','')
    show 'MCK1: Run_Dt_CMP = ' $Run_Dt_CMP ', Today_Plus1 = ' $Today_Plus1
  #endif
  
 
  #if {SITE_ID} <> 'SOL1'
    #if {SITE_ID} <> 'WFG1'
     #if {SITE_ID} <> 'VRZ1'
       do StdAPI-Init
     #endif
    #endif
  #endif
 
  display 'Report Began: ' noline
  display $AsOfToday       noline
  display ', Time '        noline
  display $AsOfNow
 
  display 'Program:  ' noline
  display $sqr-program
  display 'Database: ' noline
  display $sqr-database
  display 'Platform: ' noline
  display $sqr-platform
  display 'Username: ' noline
  display $username
  display 'Oprid:    ' noline
  display $Prcs_OprID
  display 'RunCtlID: ' noline
  display $Prcs_Run_Cntl_ID
 
  #if {SITE_ID} = 'WCH1'
    do SET-SQR-ENV                                    !CEB 01/14/04
    do GET-program($sqr-program, $program)            !CEB 01/14/04
  #endif
 
  do Format-Number(#prcs_process_instance, $PgmProcessInstance, '0999999')
  display 'Instance: ' noline
  display $PgmProcessInstance
 
  #ifdef TF_AUDIT
      do Init-TF-Audit
  #endif
 
  #ifdef TAX_CLASS_REPORT
    show 'TAX_CLASS_REPORT, calling Initialize-TAX_CLASS_REPORT (in adptcrpt.sqc)'
    do Initialize-TAX_CLASS_REPORT
  #endif
 
  #ifdef GET_BALANCE_ADJUSTMENTS
   show 'Getting tax reporting run control for Year and Qtr'
 
   do Get-Tax-Reporting-Run-Controls-ADP
   let #TX.BALANCE_YEAR = &TX.BALANCE_YEAR
   let #TX.BALANCE_QTR  = &TX.BALANCE_QTR
   show '  #TX.BALANCE_YEAR = ' #TX.BALANCE_YEAR
   show '  #TX.BALANCE_QTR  = ' #TX.BALANCE_QTR
 
   move #TX.BALANCE_YEAR to $TX.BALANCE_YEAR  xxxx
 
   Evaluate #TX.BALANCE_QTR
    When =  1
        let $Qtr_End_DTU   = $TX.BALANCE_YEAR || '-03-31'
    When =  2
        let $Qtr_End_DTU   = $TX.BALANCE_YEAR || '-06-30'
    When =  3
        let $Qtr_End_DTU   = $TX.BALANCE_YEAR || '-09-30'
    When =  4
        let $Qtr_End_DTU   = $TX.BALANCE_YEAR || '-12-31'
    when-other
      break
   end-evaluate
 
   Do Convert-From-DTU-Date($Qtr_End_DTU,$Qtr_End_Native)
   Show 'Quarter End Date DTU      ' $Qtr_End_DTU
   Show 'Quarter End Date Native   ' $Qtr_End_Native
  #endif
 
  #if {SITE_ID} = 'WFG1'
    do Wells-Fargo-exclude-PER       !in wftfctrl sqc
  #endif
 
 
  #ifdef GL_TAX_CHECK_DATE_BREAKOUT
    show 'GL_TAX_CHECK_DATE_BREAKOUT enabled.'
    do GL-Init
  #endif
  
  do Init-Report
 
  #if {SITE_ID} = 'HWL1'  !added 12/31/08
    do honeywell-exclude-companies  
  #endif
 
  #if {SITE_ID} = 'AXA1'
    do Init_Printer
  #endif
 
  let #details = 1
 
  #if {SITE_ID} = 'WFG1'
    show ' '
    show 'Calling Set-up-Wells-reporting...'
    do Set-up-Wells-reporting
    show 'Set-up-Wells-reporting complete.  $Job_Run_Date = ' $Job_Run_Date
    show '                                  $RunDate      = ' $RunDate
    show '                                  $AsOfToday    = ' $AsOfToday
    show ' '
  #endif
 
  #ifdef INPUT_VIA_CHECK_DATE
    do input-check-dates
    do Report
    goto done_report
  #endif

  #ifdef MULTIPLE_SITES
      show ' Client has Multiple Site IDs'
   if $Prcs_Process_Instance = ''
    or $Prcs_Process_Instance = '0'
      do Prompt-Site-id
   else
    #ifdef process_scheduler_enabled
      do Get-RC-Site-id
    #endif
   end-if
   let $Site_ID_RC = $Site_ID
   do Get-Installation
  #endif

  #ifdef BY_FROM_THRU_DATES
    do input-prompts
  #else
 
   #ifdef CUSTOM_RUN_DAILY_BATCH
     #ifndef SPLIT_RUN_CONTROL_UPDATE
      do Build-Automated-Run-Control  !in adpauto.sqc, builds the 'PBZ_PER' run control containing the list of runs to deal with
      if (#InsertCount = 0)
       show ' '
       show '--------------------------------------------------------------------------'
       show 'No New Payroll data has been confirmed since last extract run.'
       show 'Automated Periodic Extract complete.  No files sent to ADP Employment Tax.'
       show '--------------------------------------------------------------------------'
       show ' '
 
       #ifdef FORCE_FILE_HEADER_AND_TRAILER
        show 'FORCE_FILE_HEADER_AND_TRAILER enabled'
        do Create-Interface-File            !adpstdnm.sqc               
        do Create-Custom-Interface-File     !adpcusnm.sqc       
        do open-periodic-extract-file
        do Write-File-Header-Rec
        do Write-File-Trailer-Rec
        do Wrap-up
       #endif
 
 
       do Reset
       #if {SITE_ID} <> 'SOL1'
        #if {SITE_ID} <> 'VRZ1'
          show 'Calling stdapi-term'
          do Stdapi-Term
        #endif
       #endif
       
       #if {SITE_ID} = 'RCC1'
        #ifdef UNIX 
         do Convert-Files-RCC1
        #endif 
       #endif
 
       goto done_report
 
     end-if
 
    #endif
   #endif
  #endif

  #if {SITE_ID} ='FTO1'
    do frito-startup
    goto done_report
  #endif
   
  #if {SITE_ID} = 'VFS1'   
        display ' '
        display $ReportTitle
        display ' '
        do Select-Parameters
        let $SlctRunID = $RC_PAY.Run_ID
        let $SlctOffCycleA = 'N'
        let $SlctOffCycleB = 'Y'
        let #SlctPageFrom = 1
        let #SlctPageThru = 99999
        move 'A.RUN_ID = ''' to $SlctCalendar
        concat $SlctRunID with $SlctCalendar
        concat '''' with $SlctCalendar
        do Report
        goto done_report
  #endif
 
  #ifdef CLIENT_PAYINIT
 
       #ifdef CLIENT_PAYINIT_TF_RC_PAYINIT
         Do Select-CFG-Params !this is the default client payinit, using the TF_RC_PAYINIT table, and it invokes the 'report' procedure at the end
         show 'Select-CFG-Params procedure complete (CLIENT_PAYINIT_TF_RC_PAYINIT)'
         goto done_client_payinit
       #endif
 
       #if {SITE_ID} = 'USB1'
         do Payroll-Report-Initialization
         show 'USB1: Payroll-Report-Initialization complete (CLIENT_PAYINIT)'
         goto done_client_payinit
       #endif
 
       #if {SITE_ID} = 'CRB1'
         do Payroll-Report-Initialization
         show 'Payroll-Report-Initialization complete (CLIENT_PAYINIT)'
         Do Update_Multi_Page   !This procedure was added by Bard.
         goto done_client_payinit
       #endif
 
  
done_client_payinit:
 
  #else
     #ifdef ADP_TAX_PERIODIC_CHECK_DATE
       #ifndef ADP_TAX_PERIODIC_PAY_CHECK_CHECK_DT
         do Get-Report-Parameters-check-date
         do report
       #else
          do Payroll-Report-Initialization
          show 'ADP_TAX_PERIODIC_PAY_CHECK_CHECK_DT: Payroll-Report-Initialization'
       #endif
     #else
       #if {SITE_ID} = 'WFG1'
        show 'WFG1: skipping Payroll-Report-Initialization'
       #else
           #ifndef CUSTOM_RUN_DAILY_BATCH
             show 'skipping Payroll-Report-Initialization'
           #else
             do Payroll-Report-Initialization
             show 'Payroll-Report-Initialization complete (STANDARD)'
             goto done_report   !April 8, 2015 added
           #endif
           #if {SITE_ID} <> 'VFS1'
              show 'Calling Payroll-Report-Initialization (STANDARD)'
              do Payroll-Report-Initialization
              show 'Payroll-Report-Initialization complete (STANDARD)'
           #endif
       #endif
     #endif
  #endif
   
done_report:
 
 !added procedure to copy to the history foled
 ! #if {SITE_ID} = 'NAS'
 !   let $Filename_history = $Folder || 'Interfaces\ADP\PeriodicTax\History\' || $Filename_prefix || '.dat'
 !	 do E1ADP-Copy-File-Hist
 ! #endif
 
 #if {SITE_ID} = 'INT1'
       !Copy the data file
        do Get-local-Settings
        let $system_id    = 'PBZI'
        let $interface_id = 'PBZPE'
        let $in_parm      = 'copy1'
        let $in_filename  = $Filename
        string &G1.LOCAL_FILE_DIR 'IPAYI44.periodic.dat' by '' into $out_filename1
        do Move-File ($in_parm, $in_filename, $out_filename1)
        let $in_filename = $sqr-report
        string &G1.LOCAL_FILE_DIR 'IPAYI44.periodic.lis' by '' into $out_filename1
        do Move-File ($in_parm, $in_filename, $out_filename1)
 #end-if
 
 
 
 #if {SITE_ID} = 'ICI1'
      do get_ici_prcs_directory     !getprcsd.sqc 
    
      let $CP_SHELL = 'cp ' ||  $filename  ||' '|| $ici_prcs_directory 
      let #CP_UNIX_STATUS = 0 
      SHOW 'Unix script executing: ' $CP_SHELL 
      CALL SYSTEM USING $CP_SHELL #CP_UNIX_STATUS 
 
      if #CP_UNIX_STATUS <> 0 
       let $Error_Message = 'Error copy file to report repository, UNIX SHELL STATUS: '|| rtrim(ltrim(edit(#CP_UNIX_STATUS,'9999999.999999'),' '),'.000000') 
       Show $Error_Message 
      end-if 
 #endif
 
 
 #If {SITE_ID} = 'ITE1'
     do Create-ftp-filenames
     do Create-ftp-batch-file
     do Get-Transmit-Check-Box
     do Setup-FTP
     do Copy-File
 #endif
 
#if {SITE_ID} = 'USB1'
  show 'Calling MVP-Track-SQR-End...'
  do MVP-Track-SQR-End 
 #endif
 
 #if {SITE_ID} = 'AST1'
     ! VG - ASA - Customize to setup PGP and SFTP Steps - 04/14/2008
     if rtrim($Database_name,' ') =  'HCASAP'
        do Get-am-env
        do ASA-File-Encrypt	
        do ASA-File-Transfer	
     end-if
 #endif
 
end-report

#ifdef MULTIPLE_SITES
!***********************************************************************
! PROCEDURE Prompt-Site-id
!***********************************************************************
begin-PROCEDURE Prompt-Site-id
   #ifdef  debugp
      show 'PROCEDURE Prompt-Site-id'
   #endif

   input $Site_ID maxlen=4 'Enter Site ID to Process:'
  let $Alt_Site      =  $Site_ID
  show 'Site ID entered thru prompt: ' $Site_ID

end-PROCEDURE  !Prompt-Site-id

!***********************************************************************
! PROCEDURE Get-RC-Site-id
!***********************************************************************
begin-PROCEDURE Get-RC-Site-id
   #ifdef  debugp
      show 'PROCEDURE Get-RC-Site-id'
   #endif

   let $Alt_Site      = ' '
   let $sql-statement =
     'TFWGPS.SQR, Get-RC-Site-id, SELECT, {PBZPER_RC_TABLE}'

#ifdef debugs
  show '$Prcs_OprID       = ' $Prcs_OprID
  show '$Prcs_Run_Cntl_ID = ' $Prcs_Run_Cntl_ID
#endif

begin-SELECT on-error = SQL-Error

PBZPER_RC.{WGPS_SITE_FIELD}

  let $Alt_Site      =  &PBZPER_RC.{WGPS_SITE_FIELD}
  let $Site_ID       =  &PBZPER_RC.{WGPS_SITE_FIELD}
  show 'PBZPER_RC.{WGPS_SITE_FIELD}     = ' &PBZPER_RC.{WGPS_SITE_FIELD}

FROM  {PBZPER_RC_TABLE} PBZPER_RC

WHERE PBZPER_RC.OPRID       = $Prcs_OprID
AND   PBZPER_RC.RUN_CNTL_ID = $Prcs_Run_Cntl_ID
#ifdef SET_DB2_SQL
 WITH UR
#endif
end-SELECT

end-PROCEDURE  !Get-RC-Site-id
!***********************************************************************
! PROCEDURE Get-Installation
!***********************************************************************
begin-PROCEDURE Get-Installation

begin-SELECT
TFI.{WGPS_SITE_FIELD}

!#ifdef debugs
  #debugd show 'TFI.{WGPS_SITE_FIELD} = ' &TFI.{WGPS_SITE_FIELD}
!#endif

FROM  {INSTALLATION_TABLE} TFI
end-SELECT

  let $TFI_Site = &TFI.{WGPS_SITE_FIELD}
  if rtrim($Site_ID,' ') = ''          !Process Primary Site by Default if no Alt Site is entered on run control page
     let $Site_ID  = $TFI_Site
  end-if

  let $Alt_SITE_Selected = 'N'
  move ' '       to $Alt_Site
  If $TFI_Site <> $Site_ID
    do Get-Alt-Site-ID
  end-if

end-PROCEDURE  !Get-Installation

!***********************************************************************
! PROCEDURE Get-Alt-Site-ID
!***********************************************************************
begin-PROCEDURE Get-Alt-Site-ID

begin-SELECT on-error=SQL-Error
TFAI.{WGPS_SITE_FIELD}

   let $Alt_SITE_Selected             = 'Y'

   move &TFAI.{WGPS_SITE_FIELD}       to $TFI_Site
   move &TFAI.{WGPS_SITE_FIELD}       to $Alt_Site

   #debugd show ' '
   #debugd show 'Running With Alternate Site ID: ' $TFI_Site
   #debugd show ' '

FROM  {ALT_SITES_TABLE} TFAI
WHERE TFAI.{WGPS_SITE_FIELD} = $Site_ID
end-SELECT

  let $TFI_Site = &TFAI.{WGPS_SITE_FIELD}

 if rtrim($TFI_Site, ' ') <> $Site_ID
   #debugd show 'ERROR: Installation Site ID does not match Site ID in run control, aborting'
   #debugd show 'ERROR: Installation Site ID =' $TFI_Site ' Run control Site ID =' $Site_ID
   stop
 end-if

end-PROCEDURE  !Get-Alt-Site-ID
#endif  ! END OF MULTIPLE_SITES

#if {SITE_ID} = 'HWL1'  !added 12/31/08
  
begin-procedure honeywell-exclude-companies
 
    let $HON_COMPANIES_TO_EXCLUDE = ''
 
begin-select
CCHK.COMPANY
 
   let $HON_COMPANIES_TO_EXCLUDE_PRINT = $HON_COMPANIES_TO_EXCLUDE_PRINT ||' '|| &CCHK.COMPANY
   if $HON_COMPANIES_TO_EXCLUDE = ''
       let $HON_COMPANIES_TO_EXCLUDE = ' and q.COMPANY not in ('''|| &CCHK.COMPANY ||''''
   else
       let $HON_COMPANIES_TO_EXCLUDE = $HON_COMPANIES_TO_EXCLUDE ||','''|| &CCHK.COMPANY ||''''
   end-if
 
   FROM {HONEYWELL_EXCLUDE_TBL} CCHK
   WHERE CCHK.EFF_STATUS = 'A'
     AND CCHK.EFFDT      = (SELECT MAX(EFFDT)
                            FROM {HONEYWELL_EXCLUDE_TBL}
                              WHERE COMPANY     = CCHK.COMPANY
                                AND EFF_STATUS  = CCHK.EFF_STATUS
                                AND EFFDT      <= sysdate)
end-select
 
   if $HON_COMPANIES_TO_EXCLUDE <> ''
       let $HON_COMPANIES_TO_EXCLUDE = $HON_COMPANIES_TO_EXCLUDE || ')'
   end-if

   show 'Honeywell exclude string : ' $HON_COMPANIES_TO_EXCLUDE
 
end-procedure
 
 
#endif

#ifdef CLIENT_PAYINIT_TF_RC_PAYINIT  !Citizens uses the standars TF_RC_PAYINIT table
 
!******************************************************************************
!
! Procedure Name:	Select-CFG-Params
! Procedure Summary: This procedure reads the run control parameters and populates $SlctCalendar
!                    with Runid's and other PS runcontrol variables to default values.
!******************************************************************************
begin-procedure Select-CFG-Params
 
  show 'PROCEDURE Select-CFG-Params'
 
  Let $Found-Run-ID     = 'N'
  let $CRC_First_Run_ID = 'Y'
  move  'A.RUN_ID in (' to $SlctCalendar     !Build  $SlctCalendar for Where clause
 
  move 1 to #SlctPageFrom                    !Defaults values for all data
  move 99999 to #SlctPageThru
  move 'N'  to $SlctOffCycleA
  move 'Y'  to $SlctOffCycleB
  move ' '  to $SlctRunID
 
  let $client_payinit_rc =  'PS_{Client_Table_Prefix}RC_PAYINIT{Client_Table_Suffix}'
 
  #if {SITE_ID} = 'ANC1'
    let $client_payinit_rc =  'PS_TF_RC_PAYINIT'
  #endif
 
  #if {SITE_ID} = 'CZB1'
    let $client_payinit_rc =  'PS_RBA_RC_PAY_OUT'
  #endif
 
  show 'Select-CFG-Params, SELECTING from: ' $client_payinit_rc
  show '  $prcs_oprid                    : ' $prcs_oprid
  show '  $prcs_run_cntl_id              : ' $prcs_run_cntl_id
 
  #if {SITE_ID} = 'SCP1'
   if $prcs_oprid = 'BATCH'
  
     ! --------------------------------------------------------------------
     !SCI - BATCH job here needs to populate
     !   $SlctCalendar     !Build  $SlctCalendar for Where clause
     !   #SlctPageFrom                    !Defaults values for all data
     !   #SlctPageThru
     !   $SlctOffCycleA
     !   $SlctOffCycleB
     !   $SlctRunID
     ! --------------------------------------------------------------------
     
     ! do get-SCI-run-params !Provided by SCI in custom SQC file
     
     goto done_select_custom_params
   end-if
  #endif
  
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.1: ' $display_dt
 #endif
 
BEGIN-SELECT
CRC.RUN_ID
#if {SITE_ID} <> 'CZB1'
CRC.CYCLE_SELECT
#endif
#if {SITE_ID} = 'SCP1'	!AS121311 - Added for SCI-SDC Requirement						
CRC.TF_SDC_ONLINE_CHK   
#endif                  
 
 show 'CRC.RUN_ID = ' &CRC.RUN_ID
 Let $Found-Run-ID     = 'Y'
  
 #if {SITE_ID} = 'SCP1'	 !AS121311 - Added for SCI-SDC Requirement
    show 'TF_RC_PAYINIT.TF_SDC_ONLINE_CHK = ' &CRC.TF_SDC_ONLINE_CHK 
    let $OnlineChkInd = &CRC.TF_SDC_ONLINE_CHK 
    
    	EVALUATE $OnlineChkInd 
 	  WHEN = 'L'
 	      let $sdc_select  = 'I.PAY_SHEET_SRC IN (' || '''' || 'O' || '''' || ',' || '''' || 'L' || '''' || ')'
 	      BREAK
 	  WHEN = 'E'
 	      let $sdc_select  = 'I.PAY_SHEET_SRC NOT IN (' || '''' || 'O' || '''' || ',' || '''' || 'L' || '''' || ')'
 	      BREAK        
 	  WHEN-OTHER
 	      let $sdc_select  = 'I.PAY_SHEET_SRC NOT IN (' || '''' || 'ZZ' || '''' || ')'            !AS091310 - Added for SCI-SDC Requirement
 	      BREAK
         END-EVALUATE 
    
 #endif 
  
 If &CRC.RUN_ID > ' '                         !Build  $SlctCalendar for Where clause
      if $CRC_First_Run_ID = 'Y'
   
       #if {SITE_ID} <> 'CZB1'
         show 'CycleInd = ' &CRC.CYCLE_SELECT
         let $CycleInd = rtrim(&CRC.CYCLE_SELECT,' ')
         if $CycleInd = 'O'
           move 'N' to $SlctOffCycleA
           move 'N' to $SlctOffCycleB
         else
            if $CycleInd = 'F'
             move 'Y' to $SlctOffCycleA
             move 'Y' to $SlctOffCycleB
            end-if
         end-if
       #endif
  
        let $CRC_First_Run_ID = 'N'
 
      else  
        concat ','           with $SlctCalendar
        concat '_'           with $SlctRunID
      end-if
 
      concat ''''            with $SlctCalendar
      concat &CRC.RUN_ID     with $SlctCalendar
      concat ''''            with $SlctCalendar
      concat &CRC.RUN_ID     with $SlctRunID
 
   End-If
 
 
    #if {SITE_ID} = 'CZB1'
       from PS_RBA_RC_PAY_OUT CRC
    #else
      #if {SITE_ID} = 'ANC1'
        from PS_TF_RC_PAY_OUT CRC
      #else
        from PS_{Client_Table_Prefix}RC_PAYINIT{Client_Table_Suffix} CRC
      #endif
    #endif
  
     where CRC.OPRID = $prcs_oprid  and CRC.RUN_CNTL_ID = $prcs_run_cntl_id
 
end-select
 
  concat ')'   with $SlctCalendar
 
done_select_custom_params:
 
  show '$Found-Run-ID         : ' $Found-Run-ID
  
  if $Found-Run-ID = 'N'
    show 'No run_id selected. Aborting'
    #if {SITE_ID} = 'TCN1'
        Move 5 to #Return-Status
    #end-if
    stop
  end-if
  
  
  show '$SlctCalendar         : ' $SlctCalendar    
  show '$SlctRunID            : ' $SlctRunID       
  show '$SlctOffCycleA        : ' $SlctOffCycleA
  show '$SlctOffCycleB        : ' $SlctOffCycleB
  show 'Select-CFG-Params complete.'
  show ' '
 
  Do Report
  
end-PROCEDURE  !Select-CFG-Params
#endif
 
begin-heading 9                      !5/14/01
                                     !-------
  #ifdef SUBTOTAL_FEIN
    #ifndef SUBTOTAL_COMPANY
      move ' ' to $Company
    #endif
  #endif
 
 #Include 'stdhdgpi.sqc'
 if #details = 0
   #if {SITE_ID} = 'PFZ1'
      #Include 'stdhdg01_m.sqc'
   #else
     #if {SITE_ID} = 'KEN1'
      #Include 'cvstdhdg01.sqc'   ! 9/6/10-COVIDIEN CHANGE RELATED TO INCOMPATIBLE/CUSTOMIZED STDHDG01.SQC
     #else
      #Include 'stdhdg01.sqc'
     #endif
   #endif
 else
      #if {SITE_ID} = 'WFG1'
         #Include 'stdh01nw.sqc'
      #else
          #if {SITE_ID} = 'PFZ1'
             #Include 'stdhdg02_m1.sqc'
          #else
              #ifdef CUSTOM_RUN_DAILY_BATCH
               #if {SITE_ID} = 'KEN1'
                #Include 'cvstdhdg02.sqc'   ! 9/6/10-COVIDIEN CHANGE RELATED TO INCOMPATIBLE/CUSTOMIZED STDHDG01.SQC
               #else
                #Include 'stdhdg02.sqc'
               #endif
              #else
               #if {SITE_ID} = 'KEN1'
                #Include 'cvstdhdg06.sqc'   ! 9/6/10-COVIDIEN CHANGE RELATED TO INCOMPATIBLE/CUSTOMIZED STDHDG01.SQC
               #else
                #Include 'stdhdg06.sqc'
               #endif
              #endif
          #endif
      #endif
 end-if
 
 
 evaluate #header_type
  when = 0
 
    print '<------ Current Check Process ------>' (+1,125)  !was 130 prior to 5/17/6
    print ' State          SWT/EIN    Locality  Locality-Name                           Locality-County'  (+2,1)
    print 'TaxCode             Tax Descr        Taxable           Gross           Taxes' (0,98)
 
    when = 1   !Check Date Breakouts
       #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         print 'ADP-Compid     Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
       #else
         #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
           print 'Bank-Acct-Cd   Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
         #else
           #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
             print 'BusinessUnit   Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
           #else
             print 'Fed-Ein        Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
           #endif
         #endif
       #endif
       #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
         print '         Taxcode' ()
         print '---------      -------  --------  ----------             -----         -------------        -----------         -------'  (+1,1)
       #else
         print '---------      -------  --------  ----------             -----         -------------        -----------'  (+1,1)
       #endif
       
    when = 2   !Grand-totals page
       print 'Periodic Summary...' (+2,1)
 
    when = 3   !Run ID Breakout
       print 'Company  Paygroup  Pay-End-Date        Run-ID'  (+2,1)
       print '-------  --------  ------------        ------'  (+1,1)
 
    when = 4   !Taxes Bypassed
       print 'Fed-Ein        Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages     Taxcode'  (+2,1)
       print '-------        -------  --------  ----------             -----         -------------        -----------     -------'  (+1,1)
 
    when = 5   !Tax Credits
       print 'Company    Liab-Date        TaxCredit           Taxcode    Status'  (+2,1)
       print '-------    ----------       ---------           -------    ------'  (+1,1)
 
    !   generate-extract-report-summary  (in pbz_cred.sqc)
    when = 15   !Tax Credits & Extract Summary  !changed on 10/27/2010
       print 'FEIN       Comp  Liab-Date  Check-Date-Taxes  TaxCredit-Taxes   Cur-Check-Taxes   Taxcode           Description'  (+2,1)
       print '----       ----  ---------  ----------------  ---------------   ---------------   -------           -----------'  (+1,1)
 
    when = 6   !Tax Credit Table Dump
       print 'Company    Taxcode           Liab-Date           Process-Date        Current-Credit      Last-Modified-Stamp'  (+2,1)
       print '-------    -------           ---------           ------------        --------------      -------------------'  (+1,1)
 
    when = 7  !Negatives
       print 'Company                     Taxcode             Negative Amount  '  (+2,1)
       print '-------                     -------             ---------------  '  (+1,1)
 
    when = 8  !Cross Quarters
       print 'Company  Emplid       Page  Line  Cycle      State Tax_Class Locality             Taxes   Check-Issue-Date   Pay-Calendar-Date  Revers'  (+2,1)
       print '-------  ------       ----  ----  -----      ----- --------- --------             -----   ----------------   -----------------  ------'  (+1,1)
 
    when = 9  !StockOptions bypassed
       print 'Company  Emplid             Taxcode             Stock Option Taxes'  (+2,1)
       print '-------  ------             -------             ------------------'  (+1,1)
 
    when = 10  !Bal Adj
       print 'FEIN       Company   Emplid            Taxcode             Taxes Adjusted       Taxable Adjusted     Gross Adjusted    DT_ENTERED LIAB_DATE'  (+2,1)
       print '----       -------   ------            -------             ---------------      ----------------     ---------------   ---------- ---------'  (+1,1)
 
    when = 11  !Bal Adj Summary
       print 'FEIN       Company                     Taxcode             Taxes Adjusted       Taxable Adjusted     Gross Adjusted               LIAB_DATE'  (+2,1)
       print '----       -------                     -------             ---------------      ----------------     ---------------              ---------'  (+1,1)
 
    when = 18  !off cycle details, OFF_CYCLE_DETAIL_PRINT
       print 'Company  Paygroup  Pay_End_Dt     Cal-Check_Dt   PayLn-Issue_Dt Liability_Dt   Emplid         Paycheck_option'  (+2,1)
       print '-------  --------  ----------     ------------   -------------- ------------   ------         ---------------'  (+1,1)
   
    when = 20  !ADP TAXSERVICE TAX FILING LOCALITY AUDIT REPORT
       print 'Co.  Pay End Dt  Code   Locality    Locality Description            Resident  Emplid          ExceptionTaxes'  (+2,1)
       print '---  ----------  ------ ----------- ------------------------------- --------- ------          --------------'  (+1,1)
 
    when = 24   !Tax recap - CGP1
       print '               Company                                   Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
       print '               -------                                   -----         -------------        -----------'  (+1,1)
 
    when = 25   !Tax recap - CHS1
       print '               Company        TaxLocation                Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
       print '               -------        -----------                -----         -------------        -----------'  (+1,1)

#ifdef GENERAL_SUI_SPLIT_STATE
    when = 26   !Tax recap - 
       print '               Company        Location                   Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
       print '               -------        --------                   -----         -------------        -----------'  (+1,1)
#endif

    when = 52   !new Hire act
       print 'Company  Emplid            Exempt_Taxes_Cur    Exempt_Taxable_Cur  Exempt_Subjext_Cur (These amounts Reduced the FICA_ER Taxes and Wages extracted)' (+2,1) 
 
    when = 60   !PA Locals, heading to include PSD codes, 5/23/2011
       print 'Company  Emplid      ResSt ResCounty     Class ResLocal   ResPSD    Res  ResRt    NonResRt TaxesWithheld       TaxableWages   WorkLoc    WorkPSD   WorkSt WorkCounty    WorkDescr' (+2,1)
 
#ifdef PFZ1_2012_BANKING_SPLIT
    when = 61   !PFZ1
       print 'Virtual COMPANY          Total TAXES' (+2,1)
#endif
 
#ifdef CANADA_TOO
    when = 70   !CSST Canada details (see adpcanad.sqc
       print 'Company  Emplid            Assessable          YTD_Assessable      CSST_Taxes          Rate' (+2,1)
#endif
 
    when-other
       break
 
    end-evaluate
 
end-heading
 
 
begin-procedure open-periodic-extract-file
 
  show 'open-periodic-extract-file: Periodic Extract Folder:   ' $Folder
  show 'open-periodic-extract-file: Periodic Extract Filename: ' $FileName
 
 
 let $filename = rtrim($filename,' ')
 
#ifdef ADPCUSNM_PERIODIC_OPEN
  do custom-periodic-open  !in adpcusnm.sqc
#else
 #if {SITE_ID} = 'FHS1'                     
     let $filename = 'DD:OUTFILE1'          
     show 'FHS1: open-periodic-extract-file: Periodic Extract Filename: ' $FileName
     open $Filename as 1 for-writing record=250:FIXED_NOLF status=#filestat
     goto done_with_extract_open
 #endif
 
 #if {SITE_ID} = 'TDB2'
     let $filename = 'DD:OUTFILE1'
     show 'TDB2: open-periodic-extract-file: Periodic Extract Filename: ' $FileName
     open $Filename as 1 for-writing record=250:FIXED_NOLF status=#filestat
     goto done_with_extract_open
 #endif
 
 #if {SITE_ID} = 'WFG1'
  open $Filename as 1 for-writing record=250:fixed_nolf status=#filestat
  goto done_with_extract_open
 #endif
 
 #ifdef MASTER_TAX_HEADER
  open $Filename as 1 for-writing record=500:vary status=#filestat  !Master Tax
  goto done_with_extract_open
 
 #endif
 
 !standard extract file open command
 !-----------------------------------
 open $Filename as 1 for-writing record=250:vary status=#filestat  !ADP U.S.
 
 #ifdef CREATE_TRIGGER_FILE
   let $Trigger_Filename = $Filename || '.trigger'
   show 'CREATE_TRIGGER_FILE, creating ' $Trigger_Filename
   open $Trigger_Filename as 11 for-writing record=250:vary status=#filestat  !ADP U.S.
   close 11
 #endif
#endif 
 
done_with_extract_open:
 
 if #filestat = -1
         display ' '
         display '*** Error on Output File Open ***'
         display $Filename
         display ' '
         stop
 else
         show 'Extract File Created: ' $Filename
 end-if
 
 !open miscellaneous files too
 !----------------------------
 
 let $Add_Cr = 'f'    !for some Unix systems, transferring to
                       !Novell doesn't work unless the extract explicitly
                       !contains a CR at the end of each line. (Coke,PJ)
  #ifdef ADD_CR_UNDER_UNIX
    #ifdef UNIX
      encode <13> into $CR    !Define the carriage return
      let $Add_Cr = 't'
    #endif
  #endif
 
  #ifdef KJDA
 
    #ifdef KJDA_FILENAME
 
      #ifdef Use_Fileprefix
        let $KJDA_Filename   = $Fileprefix || '{KJDA_Filename}'
      #else
        let $KJDA_Filename   = '{KJDA_Filename}'
      #endif
 
      #ifdef APPEND_TO_EXTRACT
        if $Add_Cr = 't'
          open $KJDA_Filename as 2 for-append record=163:fixed status=#filestat
        else
          open $KJDA_Filename as 2 for-append record=162:fixed status=#filestat
        end-if
      #else
        if $Add_Cr = 't'
          open $KJDA_Filename as 2 for-writing record=163:fixed status=#filestat
        else
          open $KJDA_Filename as 2 for-writing record=162:fixed status=#filestat
        end-if
      #endif
 
     !print the KJDA_Filename Header (for Excel...)
     !---------------------------------------------
     move 'COM' to $KJDA_Comp
     move 'EmployeeId' to $KJDA_Emplid
     move 'SSN' to $KJDA_SSN
     move 'LastName' to $LastName
     move 'FirstName' to $FirstName
     move ' ' to $MidInitial
     move 'KyKJDAFee' to $Ky_KJDA_Fee
     move 'JcKJDAFee' to $Jc_KJDA_Fee
     move 'JtKJDAFee' to $Jt_KJDA_Fee
     move 'KJDA Tot.' to $KJDA_Total_Fee
     #ifdef KJDA_Details
       move '   Ky W/H' to $ky_wh
       move '   Jc W/H' to $jc_wh
       move '   Jt W/H' to $jt_wh
       move '    Gross' to $KJDA_Gross
     #endif
 
 
      Write 2 FROM   $KJDA_Comp:3
                     $space:1
                     $KJDA_Emplid:11
                     $space1:1
                     $KJDA_SSN:9
                     $space1:1
                     $LastName:25
                     $space1:1
                     $FirstName:20
                     $space1:1
                     $MidInitial:1
                     $space1:1
                     $ky_KJDA_Fee:9
                     $space1:1
                     $jc_KJDA_Fee:9
                     $space1:1
                     $jt_KJDA_Fee:9
                     $space1:1
                     $KJDA_Total_Fee:9
 
            #ifdef  KJDA_Details
                         $space:1
                         $ky_wh:9
                         $space1:1
                         $jc_wh:9
                         $space1:1
                         $jt_wh:9
                         $space1:1
                         $KJDA_Gross:9
            #endif
       #endif
    #endif
 
    !2/25/04 added - ALWAYS generate a ProBusiness periodic for Balancing and G/L reasons
    !------------------------------------------------------------------------------------
    #ifdef GENERATE_PROBUSINESS_LAYOUT_ALWAYS
 
      let $ProFilename =  $Folder || 'PRO_' || $Filename_prefix || '.dat'
 
      #if {SITE_ID} = 'PFZ1' !Pfizer
         let $ProFilename = getenv('PBZPERA_PROBIZ')
      #endif
 
     display 'Creating ProBusiness formatted File...' noline
     display $ProFilename
 
     open $ProFilename as 7 for-writing record=187:vary status=#filestat
     if #filestat = -1
         display ' '
         display '*** Error on ProBusiness File Open ***'
         display $ProFilename
         display ' '
         stop
     else
         show 'File Created.'
     end-if
 
   #endif
 
    !added March 12, 2003 for SIE1
    !--------------------------------
    #ifdef GENERATE_BYPASSED_REPORT
     #if {SITE_ID} = 'SIE1'
       do get-filename
       let $Folder = $payroll_path || 'vendor\protax\'
       let  $FileDate = substr($ReportDate,1,2) || substr($ReportDate,4,2) || substr($ReportDate,7,4)
       let  $FileTime = substr($ReportTime,1,2) || substr($ReportTime,4,2) || substr($ReportTime,7,2)
       let  $FileDtTm = $FileDate || '_' || $FileTime
       let $Bypassed_FileName = $Folder || 'bypassed_' || $FileDtTm || '.dat'
     #endif
 
 
     #if {SITE_ID} = 'SRC1'
         let  $FileDate = substr($ReportDate,1,2) || substr($ReportDate,4,2) || substr($ReportDate,7,4)
         let  $FileTime = substr($ReportTime,1,2) || substr($ReportTime,4,2) || substr($ReportTime,7,2)
         let  $FileDtTm = $FileDate || '_' || $FileTime
         let $Bypassed_FileName = $Folder || 'bypassed_' || $FileDtTm || '.dat'
         let #kTot_Bypass_Txgrs = 0
         let #kTot_Bypass_Nlgrs = 0
         let #kTot_Bypass_Tax   = 0
     #endif
 
 
     show 'Bypassed_FileName: ' $Bypassed_FileName
 
     open $Bypassed_FileName as 6 for-writing record=93:fixed status=#filestat
     if #filestat = -1
         display ' '
         display '*** Error on Output File Open ***'
         display $Bypassed_FileName
         display ' '
         stop
     else
         show 'Bypassed File Created.'
     end-if
 
     let $hdg = 'Company  Paygroup  Check-Date           Taxes   Taxable-Wages     Gross-Wages Taxcode        '
 
     Write 6 FROM $hdg:93
 
    #endif
 
    #ifdef GENERATE_EMPLOYEE_DETAIL
 
     let $Details_FileName = '{FILEPREFIX}' || 'pbzdetl.dat'
 
     !#if {SITE_ID} = 'MCK1'
     !     let $Details_FileName = $Folder || $Filename_prefix || '.dtl'
     !#endif
 
     #if {SITE_ID} = 'KII1'
        let $Details_FileName = '{FILEPREFIX}' || 'pbzdetl.dat'
     #endif
 
     #if {SITE_ID} = 'PPL'
          let $Details_FileName = $Folder || 'pbzdetl.dat'
     #endif
 
     #if {SITE_ID} = 'AXA1'
       Do Get-Run-Location
       Let $Details_FileName = $WriteDir || 'pbzdetl.dat'
     #endif
  
     
     #if {SITE_ID} = 'ELR1'
       Do getpath
       let $Details_FileName=$py_outbound_data_file_path || 'pbzdetl_' || rtrim($prcs_process_instance,' ') || '.dat'
     #endif
  
     show 'Employee Details Extract Filename: ' $Details_FileName
    
     open $Details_Filename as 3 for-writing record=135:fixed status=#filestat
     if #filestat = -1
         display ' '
         display '*** Error on Output File Open ***'
         display $Details_Filename
         display ' '
         stop
     else
         show 'File Created.'
     end-if
 
     let $hdg = 'FEIN       COMPID    TAX_CODE______R CHK_DATE EMPLOYEE_ID SSN______ TAXABLE_WAGES   '
     let $hdg = $hdg || 'GROSS_WAGES     TAXES_WITHHELD  RUN_ID OFF END_DATE'
     Write 3 FROM $hdg:135
 
    #endif
 
end-procedure
 
 
 
begin-procedure report
 
     display 'Payroll-Report-Initialization complete. --> Starting Report procedure...'
 
      ! 11/13/98  CEH
     #if {SITE_ID} = 'CSX1'
       do Confirm-Run
     #end-if
 
      #if {SITE_ID} ='USB1'
        if $PRCS_PROCESS_INSTANCE = ''
          show 'USB1: Calling Set-USB-Parameters in mtfusbtr.sqc.  $PRCS_PROCESS_INSTANCE is blank'
          do Set-USB-Parameters  !in mtfusbtr.sqc
          if $SlctRunID = '*'
           let $DDelimiter = '/'
           do Format-DateTime($SlctPayEndDt,$SlctPayEnd,{DEFMDY},'','')
           let $SlctPrint = 'Company='  || $SlctCompany  || '  ' ||
                            'Paygroup=' || $SlctPayGroup || '  ' ||
                            'PayEndDt=' || $SlctPayEnd
          else
           let $SlctPrint = 'RunId IN (' || $SlctRunID || ')'
          end-if
        else
          show 'USB1: Process Scheduler / Menu run, ID ' $PRCS_PROCESS_INSTANCE
        end-if
     #endif
 
     #ifdef MULTIPLE_RUNS
       show 'Select Calendar string 1: ' $SlctCalendar1
       show 'Select Calendar string 2: ' $SlctCalendar2
       show 'Select Calendar string 3: ' $SlctCalendar3
       show 'Select Calendar string 4: ' $SlctCalendar4
     #else
       #ifndef BY_FROM_THRU_DATES
         show 'Select Calendar string ' $SlctCalendar
       #endif
     #endif
 
     #if {SITE_ID} = 'WFG1'
       if $Off_Cycle = 'N'
         do Select-From-Job-Sch-Tbl
       else
         let $Paygroup_Like = 'B%'
         do Select-Pay-End-Date
       end-if
     #endif
 
     #if {SITE_ID} = 'CIB1'        
       let $payrunid = &CRC.RUN_ID
     #endif
 
     do Create-Interface-File            !adpstdnm.sqc               
     do Create-Custom-Interface-File     !adpcusnm.sqc       
     do open-periodic-extract-file
     do init-adp303-procedure
 
     let $adp_format = 't'  !this will get set to false if the first balance date is less than live date for ADP
 
     show 'Periodic Extract sqr-report   :   ' $sqr-report
     show 'Periodic Extract NewReportName:   ' $NewReportName
     do PeopleSoft-Defaults
 
     #if {SITE_ID} = 'SCR1'
         do get_database_name-scr1
         display 'Database: ' noline
         display $database
     #endif
 
     do ProBusiness-Defaults
     do Get-Balance-ID
 
     do Create-TaxBalance-Array
     do Create-State-Array
 
     #ifdef BY_FROM_THRU_DATES
       do Load-Possible-Runs
     #else
       #ifdef MULTIPLE_RUNS
         do Load-Multiple-Runs
       #else
         #ifdef CUSTOM_RUN_SELECTION
           do Load-Custom-Runs
         #else
           do Load-Pay-Calendar
         #endif
       #endif
     #endif
 
     do Cleanup-report
 
end-procedure
 
 
 
begin-procedure Cleanup-report
 
     do Wrap-Up
     do Reset
 
     ! ************* Client Specific FTP Code goes here ***************8
      #if {SITE_ID} = 'CHP1'  
         Let $OutputFile = $FHandler_filename 
         do Push-Output-File	!File Handler changes
      #endif
     ! ************* Client Specific FTP Code goes here ***************8
     #if {SITE_ID} = 'AHM1'
       !input parms for encryption & FTP procedure
       let $ReportID       = 'PBZPER'
       let $Directory      = $Folder    !file path
       !$FileName                       !file name & path
       let #SleepPeriod    = 2          !minutes
       do Put-File-on-FTP-Site
       goto Exit-Report
     #endif
 
     #if {SITE_ID} = 'NXT1'
       show 'Cleanup-report: NXT1 output_directory = ' $output_directory ', filename_only = ' $filename_only ', folder = ' $folder
       do Send-Output-File ($FileName_only)
       let $new_filename = 'pbzper.dat'
       let $copy_command = 'cp ' || $folder || $filename_only || ' ' || $output_directory || $new_filename
       show 'Cleanup-report: NXT1: cleaning up report, command = ' $copy_command
       call system using $copy_command #status
     #endif
 
 
     #if {SITE_ID} = 'ACL1'
       
       let $ftp_filename = $Filename_prefix || $filename_extension
       let $arch_folder = $folder || 'Archive\'
       let $arch_folder_file = $folder || 'Archive\' || $ftp_filename
       show ' '
       show 'ACL1: Archival and FTP:             Full Extract filename  : ' $Filename
       show '                                          Filename_prefix  : ' $Filename_prefix
       show '                                       filename_extension  : ' $filename_extension
       show '                                          Original Folder  : ' $Folder
       show '                                          Archival Folder  : ' $arch_Folder
       show '                                             FTP_Filename  : ' $ftp_filename
 
       do archive-file($filename, $arch_folder_file, $archive_success)
       if $archive_success = 'Y'
         do FTP-file($prcs_dbname, 'PBZPER', $arch_Folder, $ftp_filename)
         show 'ACL1: Archive Success: File FTPd. Check for file ' $filename 
         show '$arch_Folder = ' $arch_Folder
       else
         show 'ACL1: Archive Failure: File Not FTPd. Check for file ' $filename
         STOP
       end-if
       
     #endif
 
     #if {SITE_ID} = 'RDS1'
       show 'Insert specific code to handle extract file ($filename) and/or excel file ($excel_filename) here...'
     #endif
     
 
     #ifdef SHELL_CMD_FOR_PERIODIC_UPON_EXIT   !Option added 8/13 for generic script...
       #ifdef UNIX
         display ' '
         display 'Calling, UNIX Shell Script...'
         let $command_line = '{SHELL_CMD_FOR_PERIODIC_UPON_EXIT}' || ' ' || $Filename
         let $display_message = 'UNIX Shell command-line is ' || $command_line
         display $display_message
         call system using $command_line #UNIX_status WAIT
         let $UNIX_status = #UNIX_status
         let $display_message = 'UNIX return code is ' || $UNIX_status
         display $display_message
         display ' '
       #else
         display 'No Shell Script Executed. This job was not run in the UNIX environment'
         let #Unix_status = 0
       #endif
 
       if #Unix_status > 0
          show 'ERROR - Invalid Return Code from UNIX script'
       end-if
     #end-if
 
 
     #ifdef SHELL_CMD_FOR_PERIODIC_UPON_EXIT
      #if {SITE_ID} = 'MCK1'
       #ifdef UNIX
         display ' '
         display 'Send the Employment Tax Periodic Interface file'
         let $command_line = getenv('PS_HOME') || '/Interfaces/' || $OSID || '/script/putPBZ.sh'
         let $display_message = 'FTP command-line is ' || $command_line
         display $display_message
         call system using $command_line #UNIX_status
         let $UNIX_status = #UNIX_status
         let $display_message = 'Call-system return code is ' || $UNIX_status
         display $display_message
         display ' '
       #else
         display 'This job was not run in the UNIX environment'
       #endif
 
       if #Unix_status > 0
          show 'ERROR - Invalid Return Code from FTP script, RERUN script putPBZ.sh'
       end-if
     #endif
    #endif
    
    
    #if {SITE_ID} = 'PROGRESS_ENERGY'
      #ifdef UNIX
        let $FILE2 = $Folder || 'current_periodic.dat'
        let $copycommand = 'cp ' || $Filename || ' ' || $FILE2
        call system using $copycommand #R
        show 'copycommand: ' $copycommand ' ' #R
       #endif
    #endif
 
    #if {SITE_ID} = 'SIE1'
      do encrypt-and-ftp
    #endif
 
    #ifdef STANDARD_FTP
 
      #if {SITE_ID} = 'PRT1'
            do get_database_name
            show 'Perot database: ' $database
            if rtrim($database,' ') <> '{PROD_DATABASE_NAME}'
              show 'Not a Production database {PROD_DATABASE_NAME}, no auto-ftp'
              goto Exit-Report
            else
              show 'Production database {PROD_DATABASE_NAME}, starting auto-ftp'
            end-if
      #endif
 
      Do Create-Standard-ProBiz-FTP-CMD-Text
 
      If $File-Creation-Error = 'Y'
          show '**** ERROR: Aborting due to FTP Command file Create Failure. ****'
          stop
          !Goto Exit-Report
      End-If
 
      #ifndef UNIX
 
         let $CommandLine = 'ftp -n -s:' || $ftp_command_file
         call system using $CommandLine #dos_status  WAIT
 
         if #dos_Status <> 0
            show 'FTP Error, Return Status: ' #dos_Status
            show 'FTP Command Text File:    ' $ftp_command_file
            stop
         else
           show 'Verifying extract and reports were sent successfully to ADP Employment Tax...'
           do verify-ftp-of-extract
           if #ftp_error = 1
             show '**** ERROR: Aborting due to FTP Failure.  Please have FTP Failure analyzed. ****'
             stop
           end-if
         end-if
 
         show ''
 
      #else   !Unix
 
         let $CommandLine = $ftp_command_file                         !   '{FTP_CommandFile}'
         call system using $CommandLine #unix_status
 
         if #unix_status <> 0
            show 'FTP Error, Return Status: ' #unix_status
            show 'FTP Command Text File:    ' $ftp_command_file
            stop
         else
            show 'Verifying extract and reports were sent successfully to ADP Employment Tax...'
            do verify-ftp-of-extract
	    if #ftp_error = 1
               show '**** ERROR: Aborting due to FTP Failure.  Please have FTP Failure analyzed. ****'
               stop
	    end-if
	 end-if
 
      #endif
 
 
      #ifdef DELETE_COMMAND_FILE
        show 'Clearing the command file (for security reasons)'
        Open $ftp_command_file as 3  FOR-WRITING  RECORD=256:VARY STATUS=#FileStatus
        If #FileStatus <> 0
            show ''
            show 'Error opening FTP Command File ' $ftp_command_file
        else
	    close 3
        end-if
      #endif
 
    #endif
 
   !-----------------------------------------------------------------------------------------------------
   !06/24/05     STANDARD_FTS : fdx -q -s required -p -M i -u file ftp://user:pass@fts.probusiness.com/
   ! or
   !    FDX_DIR="/opt/StuAPI_Aetna"                    # Directory for Secure Transport
   !    ${FDX_DIR}/fdx -x internet.ps.net:80 -m tun -u ${OUTFILE}/${OUTFILE_NAME} \
   !        https://${FTP_USER}:${FTP_USER_PW}@${FTP_IP_ADDRESS} >> ${FTP_SCRIPT_LOG} 2>&1
   !-----------------------------------------------------------------------------------------------------
    #ifdef STANDARD_FTS
      #ifdef UNIX
        #if {SITE_ID} = 'PRT1'
            let $file_test_prefix = ''
            do get_database_name
            show 'Perot database: ' $database
            if rtrim($database,' ') <> '{PROD_DATABASE_NAME}'
              show 'Not a Production database {PROD_DATABASE_NAME}, no auto-fts'
              goto Exit-Report
            else
              show 'Production database {PROD_DATABASE_NAME}, starting auto-fts'
            end-if
 
            let $INFILE_NAME =  $Filename
 
            ! encode <35> into $pound_sign
            ! encode <42> into $asterisk_sign
            ! let $Password_fts = 'T2y7' || $asterisk_sign || 'b' || $pound_sign || 'P'
 
            let $Password_fts = '{FTP_Password}'
 
            let $fts_cmd = '{FDX_DIR}/{FDX_executable} -x internet.ps.net:80 -u ' || $INFILE_NAME || ' https://' || '{FTP_USER}:' || $Password_fts || '@{FTP_IP_ADDRESS}'
 
            show 'FTS Command script' $fts_cmd
            call system using $fts_cmd #unix_status
 
            if #unix_status <> 0
             show 'FTP Error, Return Status: ' #unix_status
             show 'FTP Command Text File:    ' $fts_cmd
             stop
            else
             show 'FTS Successfull'
            end-if
        #endif
       #endif
     #endif
 
Exit-Report:
 
   #ifdef ADPCUSNM_PERIODIC_CLOSE
      do custom-periodic-close  !in adpcusnm.sqc
   #endif
   
     #if {SITE_ID} = 'WHS1'
       do WEY-Transmit-File
     #endif
     
     #if {SITE_ID} = 'WCH1'
      #ifdef AUTO_SEND_to_T
        let $OUTFILE = 'periodic.dat'             !CB 01/14/04
        show 'FTPing for Wachovia to ' $Outfile
        do FU-FTP-Process($Outfile,'OUT')         !CB 01/14/04
      #endif
     #endif
 
     #if {SITE_ID} <> 'SOL1'
       #if {SITE_ID} <> 'WFG1'
         do Stdapi-Term
       #endif
     #endif
 
     if #ErrorCnt = 0
        do Commit-Transaction
     end-if
 
     do Get-Current-DateTime
     show  'Periodic specs  {Periodic_extract_specs}'
     show  'ADP Format = ' $adp_format
     show  'Program Version {Program_Version}'
 
     display 'Report Ended: ' noline
     display $AsOfToday       noline
     display ', Time '        noline
     display $AsOfNow
 
 
 !**************************Freddie Mac Customizationa !kmr*********************
 ! Freddie Mac Customization for backup and transfer files..Manohar.k..10/04/2007.!!!!!
      #if {SITE_ID} = 'FHL1'
            !To change  file prefix suffix in backup and transfer
            let $quarterly_sqrprogram= 'N'  
 
            if $TTS_Naming = 'PROD'
               let $adpfileprefix = 'p.fhl1.tax.'
            else
               let $adpfileprefix = 'c.fhl1.tax.test.'
            end-if
  
            do Create-Backup  !kmr
            do Invoke-GCS-FileTransfer  !kmr
      #endif
 !*****************************************************************
 
  #if {SITE_ID} = 'BLB1'
   !V000 05/25/05 changed the Access mode to the file
 
     show 'BLB1 Customization for Unix file Permissions:  APY001P File Name '   $FileName
     let $chmod1P = 'chmod 777 ' || $FileName
     call system using $chmod1P #status
     SHOW '#status APY001P  :' #status
     if #status != 0
        show '  **** WARNING FILE ERROR **** File Permissions NOT Changed...program STOPPED'
     ELSE
        show '  Success Changing File Permission(chmod)  FOR APY001P   '
     end-if
 
  !V000 05/25/05 changed the Access mode to the file
  #endif
 
  #if {SITE_ID} = 'CGI1'
 
    ! CGI1 Specific FTP Code
    ! James Fornshell, 01/12/2005
     
     Let $Dest_Unix=$Dest_Fol || $Filename_prefix || '.dat'
     Let $Source_Unix=$Folder || $Filename_prefix|| '.dat'
 
     LET $Unix_CD = 'mv ' || $Source_Unix || ' ' || $Dest_Unix 
     
     CALL SYSTEM USING $Unix_CD #status
     
     show 'CGI1: Destination Path '  $Dest_Unix
     show 'CGI1: Source Path '  $Source_Unix     
     
     if #status = 0
       show 'CGI1: File Move to Out Folder- Unix Command Sucess'
     else
       show 'CGI1: File Move to Out Folder - Unix Command Fail'
     end-if
     
     ! End CGI1 Customization 
  
  #endif
 
 
 
end-procedure
 
#if {SITE_ID} = 'CSX1'
 
Begin-Procedure Confirm-Run
 
  move ' ' to $PayConfirm
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.3: ' $display_dt
 #endif
 
Begin-Select
PAY_CONFIRM_RUN
 
 if ($PayConfirm = ' ' and &PAY_CONFIRM_RUN = 'Y') or (&PAY_CONFIRM_RUN = 'N')
   move &PAY_CONFIRM_RUN to $PayConfirm
 end-if
 
from PS_PAY_CALENDAR
where run_id  =  $SlctRunId
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
  if $PayConfirm  = 'N' or $PayConfirm = ' '
    display ' '
    Display 'PAYROLL HAS NOT BEEN CONFIRMED'
    Display 'PROGRAM ABENDING'
    display ' '
    let #return-status = 51
    stop quiet
  end-if
 
End-Procedure        !Confirm-Run
 
#endif
 
 
 
 
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-Balance-ID                                             !
! Descr:     get the balance id for this installation for pay calendar  !
!--------------------------------------------------------------------   !
begin-procedure Get-Balance-ID
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.4: ' $display_dt
 #endif
 
 
begin-select
GBI.BAL_ID_FOR_CAL_YR
 
 let $Bal_ID = &GBI.BAL_ID_FOR_CAL_YR
 show 'Balance ID Key = ' $Bal_ID
 
 from PS_INSTALLATION GBI
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-procedure
 
 
#ifdef INPUT_VIA_CHECK_DATE  !fixed 3/17/04
 
! -----------------------------------------------------------
! Procedure to create run selection by unique check date only
! Written by Tom Ghali for Intel 11/7/00
! Modified by Dan Monroe to make this feature a generic opton
! *** runcontrol table.  This table should be defined as:
!       OPRID, RUN_CNTL_ID, CHECK_DATE, OFF_CYCLE, Table name:
!       PS_{Client_Table_Prefix}RC_PBZPER SP
! -----------------------------------------------------------
 
Begin-Procedure input-check-dates
 
  ! is the process scheduler running?
  ! ---------------------------------
  IF $PRCS_PROCESS_INSTANCE = ''
    input $SlctCheckDate_DTU 'Enter Check Date for Periodic Extraction (YYYY-MM-DD) ' type=char
    if RTRIM($SlctCheckDate_DTU, ' ') = ''
      move 'Y' to $Break_Prompt
      show 'Oops.  you must enter the check date'
      stop
    end-if
    do Prompt-Cycles-Check-Date  !renamed 3/17/04
 
    Do Convert-From-DTU-Date($SlctCheckDate_DTU,$SlctCheckDate)
 
  else
 
    ! Use the run control table to get the parameters
    ! -----------------------------------------------
    do Select-Check-Date
    if RTRIM($SlctCheckDate, ' ') = ''
      move 'Y' to $Break_Prompt
      show 'Oops.  you must enter the check date'
      stop
    end-if
 
  end-if
 
  ! Build Pay_Calendar selection criteria
  ! -------------------------------------
  move ' ' to $SlctCalendar
  move 'A.CHECK_DT = ''' to $SlctCalendar
  let $SlctCalendar = $SlctCalendar  || $SlctCheckDate || ''''
 
 
  ! For now, using default selections for remaining "Slct" subst. variables
  move 1 to #SlctPageFrom
  move 99999 to #SlctPageThru
 
  display 'Check Date for Pay Calendar selection: ' noline
  display $SlctCheckDate
  display 'Cycle Indicator                      : ' noline
  display $CycleInd
  display 'Selection criteria                   " ' noline
  display $SlctCalendar
 
End-Procedure
 
begin-procedure Prompt-Cycles-Check-Date  !renamed 3/17/04
 
  while 1 = 1 and $CyclePrompts <> 'N'
    input $CycleInd maxlen=1 'Select On-Cycle(O), Off-Cycle(F) or Both(B)?' type=char
    uppercase $CycleInd
 
    if RTRIM($CycleInd, ' ') = ''
      move 'Y' to $Break_Prompt
      break
    end-if
 
    if $CycleInd = 'O'
      move 'N' to $SlctOffCycleA
      move 'N' to $SlctOffCycleB
      break
    else
      if $CycleInd = 'F'
        move 'Y' to $SlctOffCycleA
        move 'Y' to $SlctOffCycleB
        break
      else
        if $CycleInd = 'B'
          break
        end-if
      end-if
    end-if
  end-while
 
end-procedure
 
 
 
Begin-Procedure Select-Check-Date
 
  move ' ' to $SlctCheckDate_DTU
  move ' ' to $CycleInd
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.5: ' $display_dt
 #endif
 
 
Begin-Select
SP.CHECK_DT
#if {SITE_ID} <> 'INT1'
SP.OFF_CYCLE
#endif
 
 let $SlctCheckDate = rtrim(&SP.CHECK_DT,' ')
 
 #if {SITE_ID} <> 'INT1'
   let $CycleInd = rtrim(&SP.OFF_CYCLE,' ')
   if $CycleInd = 'B'
     move 'Y' to $SlctOffCycleA
     move 'N' to $SlctOffCycleB
   end-if
   if $CycleInd = 'O' !On cycle only
     move 'N' to $SlctOffCycleA
     move 'N' to $SlctOffCycleB
   end-if
   if $CycleInd = 'F' !Off Cycle only
     move 'Y' to $SlctOffCycleA
     move 'Y' to $SlctOffCycleB
   end-if
 #else
   move 'B' to $CycleInd
   move 'Y' to $SlctOffCycleA
   move 'N' to $SlctOffCycleB
 #endif
 
 
 FROM PS_{Client_Table_Prefix}RC_PBZPER SP
 
 WHERE SP.OPRID = $PRCS_OPRID
   AND SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
End-Procedure
 
#endif   !INPUT_VIA_CHECK_DATE
 
 
 
#ifdef BY_FROM_THRU_DATES
 
 
begin-procedure input-prompts
 
 ! is the process scheduler running?
 ! ---------------------------------
 IF $PRCS_PROCESS_INSTANCE = ''
 
  input $SlctOffCycleDt1 'Enter Off-Cycle From-Date (DD-MMM-YYYY) ' type=char
  if RTRIM($SlctOffCycleDt1, ' ') = ''
      move 'Y' to $Break_Prompt
      show 'Oops.  you must enter the Off cycle fromdate'
      stop
  end-if
 
  input $SlctOffCycleDt2 'Enter Off-Cycle Thru-Date (DD-MMM-YYYY) ' type=char
  if RTRIM($SlctOffCycleDt2, ' ') = ''
      move 'Y' to $Break_Prompt
      show 'Oops.  you must enter the Off cycle thrudate'
      stop
  end-if
 
 else
 
  ! Use the run control table to get the parameters
  ! -----------------------------------------------
  DO Select-Parameters-For-Scheduler
 end-if
 
 show ' '
 show 'From / Thru Input Parameters:'
 show '-----------------'
 show 'Off-Cycle Start Date: ' $SlctOffCycleDt1
 show 'Off-Cycle End Date:   ' $SlctOffCycleDt2
 
end-procedure
 
!----------------------------------------
Begin-Procedure Select-Parameters-For-Scheduler
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.6: ' $display_dt
 #endif
 
 
Begin-Select
SP.FROMDATE
SP.THRUDATE
 
  let $SlctOffCycleDt1 = rtrim(&SP.FROMDATE,' ')
  let $SlctOffCycleDt2 = rtrim(&SP.THRUDATE,' ')
 
  show 'Run control, From Date: ' $SlctOffCycleDt1
  show 'Run control, Thru Date: ' $SlctOffCycleDt2
 
 
 from PS_RUN_CNTL_HR SP
 
 Where SP.OPRID       = $PRCS_OPRID
   and SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
    
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
End-Procedure
 
#endif   !BY_FROM_THRU_DATES
 
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Init-Report                                                !
! Descr:     Report initialization procedure.  Prompt for filename.     !
!--------------------------------------------------------------------   !
begin-procedure Init-Report
 
  let $ReportID     = '{PERIODIC_REPORT_ID}'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract'
 
  #ifdef BY_FROM_THRU_DATES
    let $CycleInd = 'F'
    let #SlctPageFrom = 1
    let #SlctPageThru = 99999
  #endif
 
  #if {SITE_ID} = 'PFZ1'
     do Get-Job-Info
     let #PFE_Prior_GL_Run = getenv('PRIOR_GL_RUN')
  #endif
 
  #if {SITE_ID} = 'BKR1'
    let $VARIABLE = 'PBZ_RPT_PREFIX'
    do get-path-name
  #endif
 
end-procedure
 
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: PeopleSoft-Defaults                                        !
! Descr:     Load PeopleSoft Default Values.                            !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure PeopleSoft-Defaults
 
 
end-procedure
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: ProBusiness-Defaults                                       !
! Descr:     Load ProBusiness Default Values.                           !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure ProBusiness-Defaults
 
  let $Client_CompID        = '{SITE_ID}'
  let $Client_PaygroupID    = 'PPP'
  let $space1 = ' '
  let $Space7 = '       '
 
  let #Zero = 0
  do Format-Number(#Zero,$Zero, '999999999999999mi')
 
 
end-procedure
 
 
 
!**********************************************************************!
!---------------------------------------------------------------------- !
! Procedure: Create-TaxBalance_Array                                    !
! Descr:     Create the array to hold Employee's Tax Balances from      !
!            the Tax-Balance table.                                     !
!---------------------------------------------------------------------- !
begin-procedure Create-TaxBalance-Array
 
 #define TAX_LIMIT 7000
 create-array name=TaxBalance size={TAX_LIMIT}
    field=TaxBalance_Check_Dt:char
    field=TaxBalance_State:char
    field=TaxBalance_Locality:char
    field=TaxBalance_Resident:char
    field=TaxBalance_Tax_Class:char
    field=TaxBalance_Nlgrs_Cur:number
    field=TaxBalance_Txgrs_Cur:number
    field=TaxBalance_Tax_Cur:number
    field=TaxBalance_Gross_Cur:number
    field=Female_TaxBalance_Count:number
    field=Male_TaxBalance_Count:number
    field=TaxBalance_Count:number
    field=TaxBalance_ER_Generated:char
    field=TaxBalance_Canada:char
    #ifdef CANADA_TOO
    #ifdef SPLIT_FEDERAL
    field=TaxBalance_wage_loss_plan:char
    #endif
    #endif
    #ifdef CUSTOM_EMPLOYMENT_TYPE
    field=TaxBalance_LLC:char
    #endif
    #if {SITE_ID} = 'PRD1'
    field=TaxBalance_LLC:char
    #endif
    #if {SITE_ID} = 'CHS1'
    field=TaxBalance_LLC:char
    #endif
    #ifdef GENERAL_SUI_SPLIT_STATE
    field=TaxBalance_LLC:char
    #endif
    #if {SITE_ID} = 'TLL1'
    field=TaxBalance_LLC:char
    #endif
    #if {SITE_ID} = 'FTO1'
    field=TaxBalance_LLC:char
    #endif
    #if {SITE_ID} = 'KFC_OLD'
    field=TaxBalance_LLC:char
    #endif
    #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
    field=TaxBalance_LLC:char
    #endif
 
    #if {SITE_ID} = 'CHS1'
     do init-CT-location-CHS1 
    #endif
    #ifdef GENERAL_SUI_SPLIT_STATE
      do init-sui-split-location   !adpuispl.sqc
    #endif
  
  #define RUN_LIMIT 1000
  create-array name=Runs size={RUN_LIMIT} -
    field=Company:char      -
    field=Paygroup:char     -
    field=Pay_End_Dt:char   -
    field=Run_ID:char
 
  #define STATE_EE_COUNT_LIMIT 60
  create-array name=State_EE_Count size={STATE_EE_COUNT_LIMIT} -
    field=State:char      -  
    field=Female_Count:number - 
    field=Male_Count:number 

 
  #define CHECK_LIMIT 10000
  create-array name=CheckDates size={CHECK_LIMIT} -
    field=ADP_Compid:char -
    field=SRC_BANK_ID:char -
    field=BUSINESS_UNIT:char -
    field=Fein:number     -
    field=CompId:char     -
    field=PaygroupId:char -
    field=Check_Dt:char   -
    field=Taxes:number    -
    field=Txgrs:number    -
    field=Nlgrs:number    -
    field=EE_Count:number -
    field=Taxcode:char
    
 
    #ifdef GET_BALANCE_ADJUSTMENTS
     #if {SITE_ID} = 'WFG1'
      #define BAL_ADJ_LIMIT 15000
     #else
      #ifndef BAL_ADJ_LIMIT
        #define BAL_ADJ_LIMIT 10000
      #endif
     #endif
     create-array name=Bal_Adj size={BAL_ADJ_LIMIT} -
       field=Company:char    -
       field=Emplid:char     -
       field=Taxcode:char    -
       field=Taxes:number    -
       field=Txgrs:number    -
       field=Nlgrs:number    -
       field=DT_Entered:char -
       field=Liab_date:char
 
       do Get-Calendar-Year-Id
       display '$Calendar_Year_Id  : ' noline
       display $Calendar_Year_Id
 
    #endif
 
  #define Negative_LIMIT 1000
  create-array name=NegTaxes size={Negative_LIMIT} -
    field=Company:char    -
    field=Taxcode:char    -
    field=Taxes:number    -
    field=Check_Dt:char
 
  #define CrossQtr_LIMIT 10000
  create-array name=CrossQtr size={CrossQtr_LIMIT} -
    field=Company:char    -
    field=Emplid:char     -
    field=Page:number     -
    field=Line:number     -
    field=Off_cycle:char  -
    field=Pay_end_Dt:char -
    field=State:char      -
    field=Tax_Class:char  -
    field=Locality:char   -
    field=Taxes:number    -
    field=Check_Dt:char   -
    field=Calen_Dt:char   -
    field=Reversal:char
 
  #ifdef BYPASS_FED_STOCK_OPTION_TAXES
   #define StockOptions_limit 10000
   create-array name=StockOptions size={StockOptions_limit} -
    field=Company:char    -
    field=Emplid:char     -
    field=Taxcode:char    -
    field=Taxes:number
  #endif
 
  #define BYPASSED_LIMIT 10000
  create-array name=TaxesBypassed size={BYPASSED_LIMIT} -
    field=Fein:number     -
    field=CompId:char     -
    field=PaygroupId:char -
    field=Check_Dt:char   -
    field=Taxes:number    -
    field=Txgrs:number    -
    field=Nlgrs:number    -
    field=Taxcode:char
 
  create-array name=TaxTotal size={TAX_LIMIT} -
    field=TaxTotal_Check_Dt:char              -
    field=TaxTotal_State:char                 -
    field=TaxTotal_Locality:char              -
    field=TaxTotal_Resident:char              -
    field=TaxTotal_Tax_Class:char             -
    field=TaxTotal_Nlgrs_Cur:number:4         -
    field=TaxTotal_Txgrs_Cur:number:4         -
    field=TaxTotal_Tax_Cur:number:4           -
    field=TaxTotal_ER_Generated:char          -
    field=TaxTotal_Canada:char                -
    field=TaxTotal_Taxcode_sort:char
 
 
 #ifdef OFF_CYCLE_DETAIL_PRINT
    #define OFF_CYCLE_DETAIL_PRINT_LIMIT 3000
    create-array name=off_cycle_detail size={OFF_CYCLE_DETAIL_PRINT_LIMIT} -
      field=Company:char      -
      field=Paygroup:char     -
      field=Pay_end_dt:char   -
      field=Cal_Check_dt:char -
      field=Issue_dt:char     -
      field=Liab_dt:char      -
      field=Emplid:char       -
      field=Paycheck_option:char
 #endif
 
 #ifdef HOLD_CREDITS
   do init-credit-array
   let #header_type = 0
 #endif
 
 
 #ifdef CANADA_HEALTH_TOO
  do Init-province-Array
 #endif
 
 #ifdef USE_CALENDAR_CHECK_DATE_FOR_TBAs
    #ifndef calendar_check_dates_limit
      #define calendar_check_dates_limit 1000
    #endif
    create-array name=calendar_check_dates size={calendar_check_dates_limit} -
      field=Company:char      -
      field=Check_dt:char 
 
 #endif
 
end-procedure
 
 
 
#ifdef CANADA_HEALTH_TOO
 
begin-procedure Init-province-Array
 
create-array name=ProvinceHealthTotals size=20  -
             field=Prov:char               -
             field=Hlth_Ins_Rt:number
 
move 0 to #ProvCodes
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.10: ' $display_dt
 #endif
 
 
begin-SELECT DISTINCT
PTC.PROVINCE
 
  let $Province = rtrim(&PTC.PROVINCE,' ')
 
  if #ProvCodes < 20
     put $Province into ProvinceHealthTotals(#ProvCodes) Prov
     do Get-Health-Ins-Rt
     put #Hlth_Ins_Rt into ProvinceHealthTotals(#ProvCodes) Hlth_Ins_Rt
 
     display 'Initing ProvinceHealthTotals array... province: ' noline
     display $Province      noline
     display ', Ins rate: ' noline
     display #Hlth_Ins_Rt
 
     add 1 to #ProvCodes
  else
     display '***Array overflow; limited to 20 provinces***'
  end-if
 
 FROM PS_PAY_TAX_CAN PTC
 ORDER BY PTC.PROVINCE ASC
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 
 
begin-procedure Get-Health-Ins-Rt
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.11: ' $display_dt
 #endif
 
begin-SELECT
CNPROV.HEALTH_INS_RT
 
  move &CNPROV.Health_Ins_Rt to #Hlth_Ins_Rt
 
 FROM PS_CAN_TAX_PROV CNPROV
 WHERE CNPROV.PROVINCE  = $Province AND
     CNPROV.EFFDT = (SELECT MAX(EFFDT)
        FROM PS_CAN_TAX_PROV CNPROV2
         WHERE CNPROV2.PROVINCE  = $Province
           AND CNPROV2.EFFDT     <= $AsofToday)
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-procedure
 
 
#endif
 
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Create-State-Array                                         !
! Descr:     Create the array to hold ordered list of states for output !
!            50 States + Washington DC                                  !
!---------------------------------------------------------------------- !
begin-procedure Create-State-Array
 
  create-array name=States size=52 field=State:char
  put 'AL' into States(0) State
  put 'AK' into States(1) State
  put 'AR' into States(2) State
  put 'AZ' into States(3) State
  put 'CA' into States(4) State
  put 'CO' into States(5) State
  put 'CT' into States(6) State
  put 'DC' into States(7) State
  put 'DE' into States(8) State
  put 'FL' into States(9) State
  put 'GA' into States(10) State
  put 'HI' into States(11) State
  put 'IA' into States(12) State
  put 'ID' into States(13) State
  put 'IL' into States(14) State
  put 'IN' into States(15) State
  put 'KY' into States(16) State
  put 'KS' into States(17) State
  put 'LA' into States(18) State
  put 'MA' into States(19) State
  put 'MD' into States(20) State
  put 'ME' into States(21) State
  put 'MI' into States(22) State
  put 'MN' into States(23) State
  put 'MO' into States(24) State
  put 'MS' into States(25) State
  put 'MT' into States(26) State
  put 'NC' into States(27) State
  put 'ND' into States(28) State
  put 'NE' into States(29) State
  put 'NH' into States(30) State
  put 'NJ' into States(31) State
  put 'NM' into States(32) State
  put 'NV' into States(33) State
  put 'NY' into States(34) State
  put 'OH' into States(35) State
  put 'OK' into States(36) State
  put 'OR' into States(37) State
  put 'PA' into States(38) State
  put 'RI' into States(39) State
  put 'SC' into States(40) State
  put 'SD' into States(41) State
  put 'TN' into States(42) State
  put 'TX' into States(43) State
  put 'UT' into States(44) State
  put 'VA' into States(45) State
  put 'VT' into States(46) State
  put 'WA' into States(47) State
  put 'WI' into States(48) State
  put 'WV' into States(49) State
  put 'WY' into States(50) State
  put 'PR' into States(51) State
 
 end-procedure
 
 
 
!--------------------------------------------------
!If necessary,  to track paylines already sent...
!--------------------------------------------------
#ifdef LOG_SENT_PAYLINES
 
!********************************************************
!Procedure; Insert-Error
!********************************************************
begin-procedure Insert-Error
 
   show 'ERROR: inserting record: {SENT_PAYLINE_TABLE}'
   show 'Company       ' $Payline_Company
   show 'Paygroup      ' $Payline_paygroup
   show 'Pay_End_Dt    ' $payline_pay_end_dt
   show 'Off_Cycle     ' $Payline_off_cycle
   show 'PAGE          ' #payline_pagen
   show 'LINE          ' #payline_linen
   show 'Emplid        ' $payline_emplid
   #ifdef CUSTOM_US_RUN_TAXES
   show 'Sepchk        ' #Payline_Sepchk
   #endif
   show 'Process dt    ' $Proc_dt
   show 'Program aborting.  (Run the PBZPUR - Purge process)'
   #ifdef MVS
        Move 5 to #Return-Status
   #end-if
   stop
 
end-procedure
 
!********************************************************
!Procedure; Insert-Payline-History-Record
!********************************************************
begin-procedure Insert-Payline-History-Record
 
 do Get-Current-DateTime
   move $AsOfToday to $Proc_dt
   #if {SITE_ID} = 'WFG1'
     do Format-DateTime($Proc_dt,$Check_Dt_CMP,{DEFCMP},'','')
     if $Check_Dt_CMP < $RunDate
       move $AsOfToday to $Proc_dt
     else
       move $job_run_date to $Proc_dt
     end-if
   #endif
 
   if $Payline_Emplid = rtrim('{debug_pbzper_emplid}',' ')
     show ' Insert-Payline-History-Record emplid ' $payline_emplid
   end-if
 
begin-SQL on-error=Insert-Error
#if {SITE_ID} = 'MCK1'
  INSERT INTO {SENT_PAYLINE_TABLE}
                            (COMPANY,
                             PAYGROUP,
                             PAY_END_DT,
                             OFF_CYCLE,
                             {pg},
                             {ln},
                             EMPLID,
                             {Client_Field_Prefix}PROCESS_DT{Client_Field_Suffix},
                             Z_ITAX_IND)                     !**MCK** - ver 1.00
                     VALUES ($Payline_Company,
                             $Payline_paygroup,
                             $payline_pay_end_dt,
                             $Payline_off_cycle,
                             #payline_pagen,
                             #payline_linen,
                             $payline_emplid,
                             $Proc_dt,
                             'N')
#else
  INSERT INTO {SENT_PAYLINE_TABLE}
                            (COMPANY,
                             PAYGROUP,
                             PAY_END_DT,
                             OFF_CYCLE,
                             {pg},
                             {ln},
                             #ifdef CUSTOM_US_RUN_TAXES
                             SEPCHK,
                             #endif
                             EMPLID,
                             {Client_Field_Prefix}PROCESS_DT{Client_Field_Suffix})
                     VALUES ($Payline_Company,
                             $Payline_paygroup,
                             $payline_pay_end_dt,
                             $Payline_off_cycle,
                             #payline_pagen,
                             #payline_linen,
                             #ifdef CUSTOM_US_RUN_TAXES
                             #payline_sepchk,
                             #endif
                             $payline_emplid,
                             $Proc_dt)
 
#endif
                             
end-SQL
 
end-procedure
 
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Check-if-payline-processed                                     !
!----------------------------------------------------------------------     !
begin-procedure Check-if-payline-processed
 
  let $Payline_processed = 'f'
 
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.12: ' $display_dt
 #endif
 
   if $Payline_Emplid = rtrim('{debug_pbzper_emplid}',' ')
    show ' '
    show 'Check-if-payline-processed '
    show ' Emplid     ' $Payline_emplid
    show ' Company    ' $Payline_Company
    show ' Paygroup   ' $Payline_Paygroup
    show ' pay end dt ' $Payline_Pay_End_dt
    show ' off cycle  ' $Payline_off_cycle
    show ' page #     ' #Payline_pagen
    show ' line #     ' #Payline_linen
    #ifdef CUSTOM_US_RUN_TAXES
    show ' Sepchk #   ' #Payline_sepchk
    #endif
   end-if
 
begin-select
{Client_Field_Prefix}PROCESS_DT{Client_Field_Suffix}
 
  if $Payline_Emplid = rtrim('{debug_pbzper_emplid}',' ')
    show ' Payline previously confirmed on: ' &{Client_Field_Prefix}PROCESS_DT{Client_Field_Suffix}
  end-if
 
  let $Payline_processed = 't'
 
  FROM {SENT_PAYLINE_TABLE}
 
  WHERE COMPANY    = $Payline_Company      AND
        PAYGROUP     = $Payline_Paygroup   AND
        PAY_END_DT   = $Payline_Pay_End_dt AND
        OFF_CYCLE    = $Payline_Off_Cycle  AND
        {pg}         = #Payline_pagen      AND
        {ln}         = #Payline_linen      AND
        #ifdef CUSTOM_US_RUN_TAXES
        SEPCHK       = #Payline_sepchk     AND
        #endif
        EMPLID       = $Payline_emplid
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select

  if $Payline_processed <> 't'

#ifdef MASTERTAX_LOG_SENT_PAYLINES  !check the Master Tax table too
 
begin-select
MTL.Z_BATCH_NBR
 
  let $Payline_processed = 't'
 
  #ifdef debug_sent_pay_lines
   if #debug_sent_pay_lines <= {debug_sent_pay_lines}
     show #debug_sent_pay_lines edit 999 '. MASTERTAX_LOG_SENT_PAYLINES, check already processed in Batch: ' &MTL.Z_BATCH_NBR
   end-if
  #endif
 
  FROM {MASTERTAX_SENT_PAYLINE_TABLE} MTL
 
  WHERE MTL.COMPANY      = $Payline_Company    AND
        MTL.PAYGROUP     = $Payline_Paygroup   AND
        MTL.PAY_END_DT   = $Payline_Pay_End_dt AND
        MTL.OFF_CYCLE    = $Payline_Off_Cycle  AND
        MTL.{pg}         = #Payline_pagen      AND
        MTL.{ln}         = #Payline_linen      AND
        MTL.SEPCHK       = #Payline_Sepchk
                    
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select

#endif  !end check Master Tax table

  end-if
 
end-procedure
 
#endif  !LOG_SENT_PAYLINES
 
 
#ifdef GENERATE_HISTORY_TABLE
 
!********************************************************
!Procedure; Insert-Error-History
!********************************************************
begin-procedure Insert-Error-History
 
   #ifdef HISTORY_TABLE_RETRY                              !20121101
     show 'Warning: inserting record: {HISTORY_TABLE}'
   #else
     show 'ERROR: inserting record: {HISTORY_TABLE}'
   #endif
   show '{Client_Field_Prefix}PBZ_TYPE{Client_Field_Suffix}    ' $PBZ_Type !3/25/03 added.  'B'-Bypassed, 'T'-Transmitted
   show 'RUNID                 ' $RUNID_For_History
   show 'COMPANY               ' $Payline_Company
   show 'PAYGROUP              ' $Payline_paygroup
   #ifdef INCLUDE_BUSINESS_UNIT_IN_HISTORY
   show 'Business Unit         ' $Payline_Bus_unit
   #endif
   #ifdef INCLUDE_GL_IN_PBZ_HISTORY
   show 'GL_Expense            ' $GL_Expense
   show 'GL_Descr              ' $GL_Descr
   #endif
   show 'PAY_END_DT            ' $payline_pay_end_dt
   show 'OFF_CYCLE             ' $Payline_off_cycle
   show '{pg}                  ' #payline_pagen
   show '{ln}                  ' #payline_linen
   show 'EMPLID                ' $payline_emplid
   show 'SEPCHK                ' #payline_sepchk
   show '{Client_Field_Prefix}LIABILITY_DT{Client_Field_Suffix} ' $Check_Date_Real
   show '{Client_Field_Prefix}PROCESS_DT{Client_Field_Suffix}   ' $Proc_dt
   show 'STATE                 ' $Trimmed_State
   #ifdef CANADA_TOO
   show 'TAX_CLASS_CAN         ' $Trimmed_Tax_Class
   #else
   show 'TAX_CLASS             ' $Trimmed_Tax_Class
   #endif
   show 'Taxcode               ' $Trimmed_taxcode
   show 'LOCALITY              ' $LocIns
   show 'TAX_CUR               ' #Tax_Cur
   show 'TXGRS_CUR             ' #Txgrs_Cur
   show 'NLGRS_CUR             ' #Nlgrs_Cur
 
   show 'SQL Status            ' #sql-status
 
   show 'Bypassed inserts   =  ' #Bypassed_inserts
   show 'Transmit inserts   =  ' #Transmit_inserts
   show 'Program aborting due to insert error.'
   #ifdef MVS
        Move 5 to #Return-Status
   #end-if
   #if {SITE_ID} = 'WFG1'   
         Move 0 to #Return-Status
   #end-if
 
   #ifdef HISTORY_TABLE_RETRY      !20121101
      if #pa_counter < 9
        add 1 to #pa_counter
        do Format-Number(#pa_counter, $pa_counter, '9')
        let $Trimmed_taxcode = substr($Trimmed_taxcode,1,13) || substr($pa_counter,1,1) || substr($Trimmed_taxcode,15,1)
        show 'Retry insert with Taxcode string ' $Trimmed_taxcode
        do Insert-History-Record
      else
       #ifdef SKIP_PBZ_HISTORY_INSERT_IF_ERROR
          show 'Program could not insert after 9 attempts.  SKIP_PBZ_HISTORY_INSERT_IF_ERROR.  Insert into History table for this row not successful. '
       #else
        #if {SITE_ID} = 'WFG1'
          !remove stop to continue program after 9 attemps             
          !stop
          show 'Program could not insert after 9 attempts.'
        #else
          stop
        #endif
       #endif
      end-if
   #else
     stop
   #endif
end-procedure
 
 
 
!********************************************************
!Procedure; Insert-History-Record
!********************************************************
begin-procedure Insert-History-Record
 
! #define debug_history_table_insert
 
 
 do Get-Current-DateTime
 move $AsOfToday to $Proc_dt
 
 if   $Payline_Company <> $History_Company
   or $Payline_paygroup <> $History_Paygroup
   or $payline_pay_end_dt <> $History_pay_end_dt
 
     move $Payline_Company to $History_Company
     move $Payline_paygroup to $History_Paygroup
     move $payline_pay_end_dt to $History_pay_end_dt
     do get-Runid-for-history   ! RUNID_For_History
 end-if
 
 #ifdef INCLUDE_GL_IN_PBZ_HISTORY
     do Include-GL-in-History !returns $GL_Expense, $GL_Descr
 #endif
 
 if rtrim($Trimmed_Locality,' ') = ''
    move '-' to $LocIns
 else
    let $LocIns = substr($Trimmed_Locality,1,10)  !it's only 10 chars long
 end-if
 
 #ifdef debug_history_table_insert
 
    show ' --- Inserting record: {HISTORY_TABLE} ---'
    show $PBZ_Type
    show $RUNID_For_History
    show $Payline_Company
    show $Payline_paygroup
    #ifdef INCLUDE_BUSINESS_UNIT_IN_HISTORY
    show 'Business Unit         ' $Payline_Bus_unit
    #endif
    show $payline_pay_end_dt
    show $Payline_off_cycle
    show #payline_pagen
    show #payline_linen
    show $payline_emplid
    show #payline_sepchk
    show $Check_Date_Real
    show $Proc_dt
 
    show $trimmed_taxcode
    show $Trimmed_State
    show $Trimmed_Tax_Class
    show $LocIns
    show #Tax_Cur
    show #Txgrs_Cur
    show #Nlgrs_Cur
 
   #ifdef INCLUDE_GL_IN_PBZ_HISTORY
    show $GL_Expense
    show $GL_Descr
   #endif
 
 #endif
 
 
 begin-SQL on-error=Insert-Error-History
  INSERT INTO {HISTORY_TABLE}
                            ({Client_Field_Prefix}PBZ_TYPE{Client_Field_Suffix},
                         #ifndef NO_RUN_ID_IN_HISTORY
                             RUN_ID,
                         #endif
                             COMPANY,
                             PAYGROUP,
                         #ifdef INCLUDE_BUSINESS_UNIT_IN_HISTORY
                             BUSINESS_UNIT,
                         #endif
                             PAY_END_DT,
                             OFF_CYCLE,
                             {pg},
                             {ln},
                             EMPLID,
                             SEPCHK,
                             {Client_Field_Prefix}LIABILITY_DT{Client_Field_Suffix},
                             {Client_Field_Prefix}PROCESS_DT{Client_Field_Suffix},
                             STATE,
                         #ifdef CANADA_TOO
                             TAX_CLASS_CAN,
                         #else
                             TAX_CLASS,
                         #endif
                             LOCALITY,
                         #ifdef TAXCODE_IN_HISTORY_TABLE
                             {Client_Field_Prefix}TAXCODE{Client_Field_Suffix},
                         #endif
                         #ifdef INCLUDE_GL_IN_PBZ_HISTORY
                             GL_EXPENSE,
                             DESCR,
                         #endif
                             TAX_CUR,
                             TXGRS_CUR,
                             NLGRS_CUR )
                     VALUES ($PBZ_Type,
                        #ifndef NO_RUN_ID_IN_HISTORY
                             $RUNID_For_History,
                        #endif
                             $Payline_Company,
                             $Payline_paygroup,
                        #ifdef INCLUDE_BUSINESS_UNIT_IN_HISTORY
                             $Payline_Bus_unit,
                        #endif
                             $payline_pay_end_dt,
                             $Payline_off_cycle,
                             #payline_pagen,
                             #payline_linen,
                             $payline_emplid,
                             #payline_sepchk,
                             $Check_Date_Real,
                             $Proc_dt,
                             $Trimmed_State,
                             $Trimmed_Tax_Class,
                             $LocIns,
                         #ifdef TAXCODE_IN_HISTORY_TABLE
                             $Trimmed_taxcode,
                         #endif
                         #ifdef INCLUDE_GL_IN_PBZ_HISTORY
                             $GL_EXPENSE,
                             $GL_DESCR,
                         #endif
                             #Tax_Cur,
                             #Txgrs_Cur,
                             #Nlgrs_Cur )
end-SQL
 
   if rtrim($PBZ_Type,' ') = 'B'
     add 1 to #Bypassed_inserts
     add #Tax_Cur to #Bypassed_taxes_inserts
   else
     add 1 to #Transmit_inserts
     add #Tax_Cur to #transmit_taxes_inserts
   end-if
 
   let #pa_counter = 0
   
end-procedure
 
#endif  !GENERATE_HISTORY_TABLE
 
 
 
 
begin-procedure get-Runid-for-history
 
#if {SITE_ID} <> 'WFG1'
  move ' ' to $RUNID_For_History
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.13: ' $display_dt
 #endif
 
BEGIN-SELECT
HIST_CAL.RUN_ID
 
  move &HIST_CAL.RUN_ID to $RUNID_For_History
 
  show ' '
  show 'Company      :  ' $Payline_Company
  show 'Paygroup     :  ' $Payline_paygroup
  show 'Pay end date :  ' $payline_pay_end_dt
  show 'History RunID:  ' $RUNID_For_History
 
  From PS_PAY_CALENDAR HIST_CAL
   Where HIST_CAL.COMPANY    = $Payline_Company
     AND HIST_CAL.PAYGROUP   = $Payline_paygroup
     AND HIST_CAL.PAY_END_DT = $Payline_pay_end_dt
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
#end-if
 
#if {SITE_ID} = 'WFG1'
BEGIN-SELECT
HIST_CAL.SEQNUM
 
  move &HIST_CAL.SEQNUM to $RUNID_For_History
 
  show ' '
  show 'Company      :  ' $Payline_Company
  show 'Paygroup     :  ' $Payline_paygroup
  show 'Pay end date :  ' $payline_pay_end_dt
  show 'SEQNUM       :  ' $RUNID_For_History
 
  From PS_TF_PBZ_ADP  HIST_CAL
#ifdef SELECT_WITH_UR
 with ur
#end-if
END-SELECT
#end-if
 
end-procedure
 
 
#ifdef BY_FROM_THRU_DATES
 
!*********************************************************************** !
!----------------------------------------------------------------------  !
! Procedure: Load-Possible-Runs                                          !
! Desc:      This procedure extracts possible pay runs from the calendar !
!                                                                        !
!----------------------------------------------------------------------  !
begin-procedure Load-Possible-Runs
 
  let #Last_PayCalendar_Cnt     = 0
  Let #Last_TaxTotal_Cnt        = 0
 
 
  show 'looking for possible run dates...'
  show '----------------------------------'
  show 'Start Date: ' $SlctOffCycleDt1
  show 'End Date:   ' $SlctOffCycleDt2
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.14: ' $display_dt
 #endif
 
 
begin-select
AA.COMPANY
AA.RUN_ID
AA.PAY_END_DT
AA.PAY_BEGIN_DT
#ifdef SUBTOTAL_FEIN
COA.FEDERAL_EIN
#endif
 
  let $Possible_Run = &AA.RUN_ID
  !show 'New Run to Process: ' $Possible_Run
 
  if rtrim(&AA.COMPANY,' ') <> $Current_Company
    #ifdef SUBTOTAL_COMPANY
      if rtrim($Current_Company,' ') <> ''
        if #Last_TaxTotal_Cnt > 0
         if round(#Company_Total_Tax,2) <> 0              OR
            round(#Company_Total_Taxable_Wages,2) <> 0    OR
            round(#Company_Total_Gross_Wages,2) <> 0
          let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $Possible_Run
          let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, COMPANY ' || $Current_Company
          Let #Tot = 1
          Let $State = ' '
          Let $Locality = ' '
          Do Print-TaxBalance-Recap
          New-Page
         end-if
        end-if
     End-if
    #endif
 
    let $Current_Company = rtrim(&AA.COMPANY,' ')
 
    show 'New company to process: ' $Current_Company
    let $Client_CompID = $Current_Company
    let $Company = $Current_Company
 
    move &AA.PAY_END_DT to $AsofDate
    do get-company-data
 
    move &CT.COUNTRY to $Current_Country
    add 1 to #Company_cnt
    Do Init-Report
 
   End-if
 
 
  #ifdef SUBTOTAL_FEIN
    if &COA.FEDERAL_EIN <> #Current_FEIN
      if #Current_FEIN <> 0
        if #Last_TaxTotal_Cnt > 0
         let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
         let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, FEIN ' || $Current_FEIN
         Let #Tot = 2
         Let $State = ' '
         Let $Locality = ' '
         Do Print-TaxBalance-Recap
         New-Page
        end-if
      End-if
 
    let #Current_FEIN = &COA.FEDERAL_EIN              !3/28/01 changes
    if #Current_FEIN <> 0
      move #Current_FEIN to $FedEIN 099999999
      move $FedEIN to $Current_FEIN xx-xxxxxxx
    else
      move ' ' to $Current_FEIN
    end-if
 
 
    display 'Processing Next FEIN --> ' noline
    display $Current_Fein
 
    Do Init-Report
 
   End-if
  #else
    let #Current_FEIN = &CT.FEDERAL_EIN              !3/28/01 changes
    if #Current_FEIN <> 0
      move #Current_FEIN to $FedEIN 099999999
      move $FedEIN to $Current_FEIN xx-xxxxxxx
    else
      move ' ' to $Current_FEIN
    end-if
 
 
  #endif
 
  if rtrim($Possible_Run,' ') <> ''
    show 'Checking Run: ' $Possible_Run
    show '  PayDates:   ' &AA.PAY_BEGIN_DT ' ... ' &AA.PAY_END_DT
    do Load-Next-From-Calendar
  end-if
 
  #ifdef SUBTOTAL_FEIN
    FROM PS_PAY_CALENDAR AA, PS_COMPANY_TBL COA
  #else
    FROM PS_PAY_CALENDAR AA
  #endif
  !------------------------------------------------------------
  !make sure that the begin date or the end date out of the
  !calendar is somewhere in the range specified by the operator
  !------------------------------------------------------------
 
  WHERE  ($SlctOffCycleDt1 BETWEEN AA.PAY_BEGIN_DT
                                AND    AA.PAY_END_DT)
 
       OR ($SlctOffCycleDt2 BETWEEN AA.PAY_BEGIN_DT
                                AND     AA.PAY_END_DT)
 
       or (AA.PAY_BEGIN_DT BETWEEN $SlctOffCycleDt1
                                AND    $SlctOffCycleDt2)
 
       or (AA.PAY_END_DT   BETWEEN $SlctOffCycleDt1
                                AND    $SlctOffCycleDt2)
 
     #ifdef COMPANY_TO_PROCESS
         AND AA.COMPANY = '{COMPANY_TO_PROCESS}'
     #endif
 
     #ifdef COMPANIES_TO_PROCESS
         AND AA.COMPANY in {COMPANIES_TO_PROCESS}
     #endif
 
    #ifdef SUBTOTAL_FEIN
 
     AND AA.COMPANY = COA.COMPANY
     AND COA.EFFDT =
       (SELECT MAX(EFFDT)
        FROM   PS_COMPANY_TBL COA1
        WHERE  COA.COMPANY = COA1.COMPANY
          AND  COA.EFFDT  <= AA.PAY_END_DT)
    #endif
 
  #ifdef SUBTOTAL_FEIN
    ORDER BY COA.FEDERAL_EIN, AA.COMPANY, AA.PAYGROUP
  #else
    ORDER BY AA.COMPANY, AA.PAYGROUP
  #endif
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
 display 'Printing final totals...'
 
 if rtrim($Current_Company,' ') <> ''
  if #Last_TaxTotal_Cnt > 0
 
    !Paygroup sub-totals
    !------------------
    #ifndef PAYGROUP_ROLLUP
      if round(#Paygroup_Total_Tax,2) <> 0              OR
         round(#Paygroup_Total_Taxable_Wages,2) <> 0    OR
         round(#Paygroup_Total_Gross_Wages,2) <> 0
       Let $State = ' '
       Let $Locality = ' '
       let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $Possible_Run
       let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, PAYGROUP ' || $Current_Paygroup
       Let #Tot = 0
       do Print-TaxBalance-Recap    !print out the rpt for this last paygroup
       New-Page
     end-if
    #endif
 
    !Company sub-totals
    !------------------
    #ifdef SUBTOTAL_COMPANY
     if round(#Company_Total_Tax,2) <> 0              OR
        round(#Company_Total_Taxable_Wages,2) <> 0    OR
        round(#Company_Total_Gross_Wages,2) <> 0
      Let $State = ' '
      Let $Locality = ' '
      let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $Possible_Run
      let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, COMPANY ' || $Current_Company
      Let #Tot = 1
      Do Print-TaxBalance-Recap      !and the last company totals
     end-if
    #endif
 
    !Fein sub-totals
    !------------------
    #ifdef SUBTOTAL_FEIN
     Let $State = ' '
     Let $Locality = ' '
     let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
     let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, FEIN ' || $Current_FEIN
     Let #Tot = 2
     Do Print-TaxBalance-Recap      !and the last FEIN totals
     New-Page
    #endif
 
   end-if
 
   do print-hash-totals
 
 end-if
 
 
end-procedure
 
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: Load-Next-From-Calendar                                   !
! Desc:      This procedure extracts the next pay calendar record      !
!                                                                      !
!----------------------------------------------------------------------!
begin-procedure Load-Next-From-Calendar
 
  show 'loading pay calendar for Run: ' $Possible_Run
  show 'Balance ID                  : ' $Bal_ID
  show '----------------------------------------'
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.15: ' $display_dt
 #endif
 
begin-select
A.COMPANY
{PAYGROUP_FIELD}
A.PAY_END_DT
A.RUN_ID
A.CHECK_DT
{CAL_PERIOD}
{CAL_QTR}
{CAL_YEAR}
 
  let $Client_PaygroupID = &{PAYGROUP_FIELD}
 
  let #Input_Balance_Year                   = &{CAL_YEAR}
  let {BAL_QTR_TYPE}Input_Balance_Qtr       = &{CAL_QTR}
  let {BAL_PERIOD_TYPE}Input_Balance_Period = &{CAL_PERIOD}
  let $Input_Pay_End_Dt     = &A.PAY_END_DT
  let $PayEndDate           = &A.Pay_End_Dt
  let $Current_Paygroup       = &A.PAYGROUP
  let $RunID = &A.RUN_ID
 
  #ifdef PAYGROUP_ROLLUP
    move '   ' to $PAYGROUP
  #else
    let $PAYGROUP = rtrim(&A.PAYGROUP,' ')
    do get-paygroup-data
  #endif
 
  Let #ErrorCnt = 0
 
 
  show 'New Payline in the calendar'
  show '----------------------------'
  show 'RUN ID         = ' &A.RUN_ID
  show 'Company        = ' $Current_Company
  show 'Paygroup       = ' $Current_Paygroup
  show 'Check Date     = ' &A.CHECK_DT
  show 'Year           = ' #Input_Balance_Year
  show 'Quarter        = ' {BAL_QTR_TYPE}Input_Balance_Qtr
  show 'Period         = ' {BAL_PERIOD_TYPE}Input_Balance_Period
  show 'PayEndDt       = ' $Input_Pay_End_Dt
 
  !-----------------------------------------------------------
  !3/14/98 added to print payline info
  !-----------------------------------
 
  #ifdef debugFD
    print ' *** New Payline Record from Calendar ***  ' (+2,20)
    print $Current_Company      ()
    print ', '                ()
    print $Current_Paygroup     ()
    print 'Pay End Date =  '  (+1,20)
    print $Input_Pay_End_Dt   ()
 
    print ' *** Select Params for this Payline *** ' (+2,20)
    print 'SlctCalendar  = '  (+1,20)
    print $SlctCalendar       ()
    print 'SlctOffCycleA = '  (+1,20)
    print $SlctOffCycleA      ()
    print 'SlctOffCycleB = '  (+1,20)
    print $SlctOffCycleB      ()
 
    print ' *** Please note these Selected Pages *** ' (+2,20)
    print 'SlctPages     = '  (+1,20)
    print #SlctPageFrom       ()
    print ' thru '            ()
    print #SlctPageThru       ()
    !-----------------------------------------------------------
  #endif
 
  do Get-Payline
  if #Last_TaxBalance_Cnt > 0
 
   if round(#Paygroup_Total_Tax,2) <> 0              OR
      round(#Paygroup_Total_Taxable_Wages,2) <> 0    OR
      round(#Paygroup_Total_Gross_Wages,2) <> 0
 
     Let #Tot = 0
 
     #ifndef BY_PAYENDDT
       let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
     #else
       let $ReportID     = '{PERIODIC_REPORT_ID}'
     #endif
 
     let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, PAYGROUP ' || $Current_Paygroup
     Let $State = ' '
     Let $Locality = ' '
     do Print-TaxBalance-Recap    !print out the rpt for this paygroup
     let #last_TaxBalance_Cnt = 0
     New-Page
   end-if
  end-if
 
  FROM PS_PAY_CALENDAR A,
       PS_PAY_CAL_BAL_ID Q
 
   WHERE  (A.RUN_ID = $Possible_Run)
      and (A.COMPANY  = $Current_Company)
      and (A.COMPANY  = Q.COMPANY)
      and (A.PAYGROUP = Q.PAYGROUP)
      and (A.PAY_END_DT = Q.PAY_END_DT)
      and (Q.BALANCE_ID = $Bal_ID)
 
      #ifdef COMPANY_TO_PROCESS
       AND A.COMPANY = '{COMPANY_TO_PROCESS}'
      #endif
 
     #ifdef COMPANIES_TO_PROCESS
       AND A.COMPANY in {COMPANIES_TO_PROCESS}
     #endif
 
     #if {SITE_ID} = 'GE01'       					!Tracker 895810	
     	[$SlctCalendarBy]	  					!Tracker 895810 
     #End-if                      					!Tracker 895810
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 
 
#endif   !if BY_FROM_THRU_DATES
 
 
!*********************************************************************** !
!----------------------------------------------------------------------  !
! Procedure: Load-Cycleind                                               !
!----------------------------------------------------------------------  !
begin-procedure Load-CycleInd
 
    if ($SlctOffCycleA <> $SlctOffCycleB)
       let $CycleInd = 'B'
    else
       if $SlctOffCycleA = 'N'
         let $CycleInd = 'O'
       else
         let $CycleInd = 'F'
       end-if
    end-if
 
end-procedure
 
 
 
#ifdef CUSTOM_RUN_SELECTION
 
!*********************************************************************** !
!----------------------------------------------------------------------  !
! Procedure: Load-Custom-Runs                                            !
! Desc:      This procedure extracts pay runs in a unique way            !
!            for the client                                              !
!----------------------------------------------------------------------  !
begin-procedure Load-Custom-Runs
 
#ifdef PBZPER_WEEK_PROCESSING          
 
   show 'Loading Pay Calendar, via JCPenneys selection criteria...'
   show '  Custom Run-id retrieval  ----> SlctCalendar:  ' $SlctCalendar
   show '  -----------------------        SlctOffCycleA: ' $SlctOffCycleA
   show '                                 SlctOffCycleB: ' $SlctOffCycleB
 
   do Load-Pay-Calendar      !($SlctCalendar, $SlctOffCycleB, $SlctOffCycleA)
   do print-hash-totals
 
#endif  !JCP
 
 
 
#ifdef CUSTOM_RUN_DAILY_BATCH
 
   show 'Loading Pay Calendar, via Auto selection criteria...'
   show '  Custom Run-id retrieval  ----> SlctCalendar:  ' $SlctCalendar
   show '  -----------------------        SlctOffCycleA: ' $SlctOffCycleA
   show '                                 SlctOffCycleB: ' $SlctOffCycleB
 
   do Load-Pay-Calendar      !($SlctCalendar, $SlctOffCycleB, $SlctOffCycleA)
   do print-hash-totals
 
#endif
 
 
 
 
end-procedure
 
#endif  !Custom_run_selection
 
 
!*********************************************************************** !
!----------------------------------------------------------------------  !
! Procedure: Load-Multiple-Runs                                          !
! Desc:      This procedure extracts up to 4 runs from the calendar      !
!                                                                        !
!----------------------------------------------------------------------  !
begin-procedure Load-Multiple-Runs
 
  ! $SlctCalendar1, ... $SlctCalendar4 created in sqc
  ! -------------------------------------------------
  let #run_counter = 1
 
  while #run_counter <= 4
 
     evaluate #run_counter
 
    when = 1
     if rtrim($SlctCalendar1,' ') <> ''
           move $SlctCalendar1 to $SlctCalendar
           move $SlctOffCycleA1 to $SlctOffCycleA
           move $SlctOffCycleB1 to $SlctOffCycleB
           do Load-CycleInd
           do Load-Pay-Calendar
     end-if
     break
 
    when = 2
     if rtrim($SlctCalendar2,' ') <> ''
           move $SlctCalendar2 to $SlctCalendar
           move $SlctOffCycleA2 to $SlctOffCycleA
           move $SlctOffCycleB2 to $SlctOffCycleB
           do Load-CycleInd
           do Load-Pay-Calendar
     end-if
     break
 
    when = 3
     if rtrim($SlctCalendar3,' ') <> ''
           move $SlctCalendar3 to $SlctCalendar
           move $SlctOffCycleA3 to $SlctOffCycleA
           move $SlctOffCycleB3 to $SlctOffCycleB
           do Load-CycleInd
           do Load-Pay-Calendar
     end-if
     break
 
    when = 4
     if rtrim($SlctCalendar4,' ') <> ''
           move $SlctCalendar4 to $SlctCalendar
           move $SlctOffCycleA4 to $SlctOffCycleA
           move $SlctOffCycleB4 to $SlctOffCycleB
           do Load-CycleInd
           do Load-Pay-Calendar
     end-if
     break
 
   when-other
     break
 
   end-evaluate
 
   Add 1 to #run_counter
 
   let #last_TaxBalance_Cnt = 0
   let #Paygroup_Total_Tax = 0
   let #Paygroup_Total_Taxable_Wages = 0
   let #Paygroup_Total_Gross_Wages = 0
 
   Let $State = ' '
   Let $Locality = ' '
 
  end-while
 
  do print-hash-totals
 
 
end-procedure
 
 
 
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: Load-Pay-Calendar                                         !
! Desc:      This procedure extracts the current Pay-Calendar record.  !
!                                                                      !
!----------------------------------------------------------------------!
begin-procedure Load-Pay-Calendar
 
  let #Last_PayCalendar_Cnt     = 0
  ! Let #Last_TaxTotal_Cnt      = 0         ! ****  6/26/01  setting this to 0 will screw up the GRAND TOTAL DETAIL PAGE
  Let $Current_Company          = ' '
  Let #Current_FEIN             = 0
  Let $Current_FEIN             = ''
  let $Current_ADP_Compid       = ''
 
  show 'Load-Pay-Calendar...'
  show '  SlctCalendar           : ' $SlctCalendar
  show '    SlctOffCycleA        : ' $SlctOffCycleA
  show '    SlctOffCycleB        : ' $SlctOffCycleB
  show '    #SlctPageFrom        : ' #SlctPageFrom
  show '    #SlctPageThru        : ' #SlctPageThru
  #ifdef ADP_TAX_PERIODIC_PAY_CHECK_CHECK_DT
  show '    $SlctPayCheckCheckDt : ' $SlctPayCheckCheckDt
  #endif

 
  #if {SITE_ID} = 'RSS1'   
    #ifdef ADP_TAX_PERIODIC_SWEEP
      let $SlctOffCycleA = 'Y'
      let $SlctOffCycleB = 'Y'
      let $CycleInd = 'F'
    #else
      let $SlctOffCycleA = 'N'
      let $SlctOffCycleB = 'N'
      let $CycleInd = 'O'
    #endif
    show 'RSS1: SlctOffCycleA = ' $SlctOffCycleA ', SlctOffCycleB = ' $SlctOffCycleB ', CycleInd = ' $CycleInd 
  #endif
 
  #if {SITE_ID} = 'GE01'   
       show 'GE...Load-Pay-Calendar, Custom $SlctCalendarBy = ' $SlctCalendarBy
       Find 'CONFIRMATION_DT' in $SlctCalendarBy 0 #ColNo
       If #ColNo > 0 
  	let $replaced = replace($SlctDetailby, 'B.', 'I.')			!Tracker 895810
  	Let $SlctDetailbyI = 'AND ' || $replaced                                !Tracker 895810
	let $replaced = replace($SlctDetailby, 'B.', 'PT.')                     !Tracker 895810
	Let $SlctDetailbyPT = 'AND ' || $replaced                               !Tracker 895810
       End-if
  #endif
 
  #if {SITE_ID} = 'SQP1'
     let $_TableAlias = 'I'  ! (PS_PAY_LINE)
     do Security-Param
     show ' '
     show 'SQP1: PS_PAY_LINE: SecurityClauseWithERN = ' $SecurityClauseWithERN
     
     !Let $SecurityClausewithERN = 
     ! ' AND EXISTS (SELECT ' || '''X''' || ' FROM PS_FAST_SQR_SEC_VW SCRTY
     !    WHERE SCRTY.EMPLID = ' || $_TableAlias || '.EMPLID  AND ' || $_TableAlias || '.EMPL_RCD = SCRTY.EMPL_RCD
     !     AND SCRTY.OPRID = ''' || $prcs_oprid  || ''')'
     
     show ' '
 
  #endif
  
  #ifdef INCLUDE_KS_REGENT
      show 'INCLUDE_KS_REGENT... $SlctRunID = ' $SlctRunID
      if (length($SlctRunID) = 8) AND (substr($SlctRunID,7,2) = 'OA')
       let $SlctCalendar_KS = 'RUN_ID like (' || '''' || substr($SlctRunID,1,7) || '%'')'
      else
       let $SlctCalendar_KS = 'RUN_ID = ''' || $SlctRunID || ''''
      end-if
      show 'INCLUDE_KS_REGENT...Load-Pay-Calendar, Custom $SlctCalendar_KS = ' $SlctCalendar_KS   
 
  #endif
  
  #if {SITE_ID} = 'SWF1'
 
      show 'SWF1...$SlctRunID = ' $SlctRunID ',  $RunID = ' $RunID
 
      if (rtrim($SlctRunID,' ') <> '') AND (rtrim($SlctRunID,' ') <> '*')
       move $SlctRunID to $RunID
      end-if
 
      let $SlctCalendar_swift = 'A.RUN_ID like (' || '''' || substr($RunID,1,5) || '%'')'
      show 'SWF1...Load-Pay-Calendar, Custom $SlctCalendar_swift = ' $SlctCalendar_swift
   #endif
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.20 (Load Pay Calendar): ' $display_dt
 #endif
 
   show 'Wells_COMPANIES_TO_EXCLUDE_pc '  $Wells_COMPANIES_TO_EXCLUDE_pc
 
begin-select
A.COMPANY
A.PAYGROUP
A.PAY_BEGIN_DT
A.PAY_END_DT
A.PAY_CONFIRM_RUN               !added 4/30/08
A.RUN_ID
A.CHECK_DT
A.PAY_OFF_CYCLE_CAL
{CAL_PERIOD}
{CAL_QTR}
{CAL_YEAR}
#ifdef SUBTOTAL_FEIN
CO.FEDERAL_EIN
#endif
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT
CT.TF_COMPANY
#endif
#ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
PAYTBL.SRC_BANK_ID
#endif
#ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
CHKTBL.BUSINESS_UNIT
#endif

  #if {SITE_ID} = 'SWF1'
    if substr(&A.RUN_ID,1,5) <> substr($RunID,1,5)
      show 'Skipping RUN_ID ' &A.RUN_ID
      goto skip_company
    end-if
  #endif
 
  #if {SITE_ID} = 'PFZ1'
    move &A.COMPANY to $PFE_Company
    move &A.PAY_END_DT to $PFE_sysdate
    do Check-Company-Catagory
    if $PFE_Catagory <> 'A'
      goto skip_company
    end-if
  #endif
 
  let $Client_PaygroupID = rtrim(&{PAYGROUP_FIELD},' ')
 
  #ifdef SITE_ID
   #if {SITE_ID} = 'TUH1'   ! !TUH-TW1&TB1 remapping 3/20/8
    #ifndef PAYGROUP_ROLLUP
     if rtrim(&A.COMPANY,' ') = 'TUH' and ($Client_PaygroupID = 'TW1' or $Client_PaygroupID = 'TB1')
      show 'Remapping TUH ' $Client_PaygroupID  ' to TUH TW1&TB1'
      let $Client_PaygroupID = 'TW1&TB1'      
     end-if
    #endif
   #endif
  #endif
  
  let #Input_Balance_Year                   = &{CAL_YEAR}
  let {BAL_QTR_TYPE}Input_Balance_Qtr       = &{CAL_QTR}
  let {BAL_PERIOD_TYPE}Input_Balance_Period = &{CAL_PERIOD}
  let $Input_Pay_End_Dt     = &A.PAY_END_DT
  let $PayEndDate           = &A.PAY_END_DT
  let $PayBeginDate         = &A.PAY_BEGIN_DT
  let $Current_Paygroup     = rtrim(&A.PAYGROUP,' ')
  let $Pay_Off_Cycle_Cal    = &A.PAY_OFF_CYCLE_CAL
 
  let $Current_calendar_check_date = &A.CHECK_DT
  let $Current_calendar_company    = &A.COMPANY 
  #ifdef USE_CALENDAR_CHECK_DATE_FOR_TBAs
    do log-calendar-check-date
  #endif
  
  #ifdef THIRD_PARTY_SICK_PERIODIC
!    if #PayCalendar_Cnt = 0
      do init-3PSP-balances     !11/23/2011 moved to adp303p.sqc
!     add 1 to #PayCalendar_Cnt
!    end-if
  #endif
 
  #ifdef CANADA_TOO
   #if {SITE_ID} <> 'PLP1'
    if #Last_PayCalendar_Cnt = 0
       show 'Initing ADP-Canada ' $Input_Pay_End_Dt 
       do Init-ADP-Canada
       add 1 to #Last_PayCalendar_Cnt
    end-if
   #endif
  #endif
 
  let $RunID = &A.RUN_ID
 
  #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
      let $SCM1_Compid = rtrim(&A.COMPANY,' ') || '_' || rtrim(&PAYTBL.SRC_BANK_ID,' ')
      if $SCM1_Compid <> $Current_SRC_BANK_ID
        if $Current_SRC_BANK_ID <> ''
          if #Last_TaxTotal_Cnt > 0
            #ifdef CUSTOM_RUN_SELECTION
               let $ReportID     = '{PERIODIC_REPORT_ID}'
            #else
               let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
            #endif
 
            let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, SRC_BANK_ID ' || $Current_SRC_BANK_ID
            
            Let #Tot = 2
            Let $State = ' '
            Let $Locality = ' '
            let $Company = ' '
            let $CompanyName = ' '
 
            display 'Print-TaxBalance-Recap: SRC_BANK_ID --> ' noline
            display $Current_SRC_BANK_ID
 
            Do Print-TaxBalance-Recap
            New-Page
          end-if
       End-if
 
       let $Current_SRC_BANK_ID = $SCM1_Compid
       display 'Processing Next SRC_BANK_ID --> ' noline
       display $Current_SRC_BANK_ID
       Do Init-Report
      End-if
  #endif
 
  #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
      let $BUSUNIT_Compid = rtrim(&CHKTBL.BUSINESS_UNIT,' ')
      if $BUSUNIT_Compid <> $Current_BusUnit_CompID
        if $Current_BusUnit_CompID <> ''
          if #Last_TaxTotal_Cnt > 0
            #ifdef CUSTOM_RUN_SELECTION
               let $ReportID     = '{PERIODIC_REPORT_ID}'
            #else
               let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
            #endif
 
            let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, Business Unit ' || $Current_BusUnit_CompID
            
            Let #Tot = 1
            Let $State = ' '
            Let $Locality = ' '
            let $Company = ' '
            let $CompanyName = ' '
 
            show 'Print-TaxBalance-Recap: BusinessUnit--> ' $Current_BusUnit_CompID
 
            Do Print-TaxBalance-Recap
            New-Page
          end-if
       End-if
 
       let $Current_BusUnit_CompID = $BUSUNIT_Compid
       display 'Processing Next BusinessUnit--> '  $Current_BusUnit_CompID
       Do Init-Report
      End-if
  #endif
 
  if rtrim(&A.COMPANY,' ') <> $Current_Company
    #ifdef SUBTOTAL_COMPANY
      if rtrim($Current_Company,' ') <> ''
        if #Last_TaxTotal_Cnt > 0
 
 
         if round(#Company_Total_Tax,2) <> 0              OR
            round(#Company_Total_Taxable_Wages,2) <> 0    OR
            round(#Company_Total_Gross_Wages,2) <> 0
 
          #ifdef CUSTOM_RUN_SELECTION
            #ifdef PBZPER_WEEK_PROCESSING
              let $ReportID     = '{PERIODIC_REPORT_ID}'  || ', Week ' || $jcp_week
            #else
              let $ReportID     = '{PERIODIC_REPORT_ID}'
            #endif
          #else
             let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
          #endif
 
          let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, COMPANY ' || $Current_Company
          Let #Tot = 1
          Let $State = ' '
          Let $Locality = ' '
          Do Print-TaxBalance-Recap
          New-Page
         end-if
        end-if
 
      End-if
    #endif
 
    #ifdef SUBTOTAL_FEIN
      if &CO.FEDERAL_EIN <> #Current_FEIN
        if #Current_FEIN <> 0
          if #Last_TaxTotal_Cnt > 0
            #ifdef CUSTOM_RUN_SELECTION
              #ifdef PBZPER_WEEK_PROCESSING
	       let $ReportID     = '{PERIODIC_REPORT_ID}'  || ', Week ' || $jcp_week
              #else
               let $ReportID     = '{PERIODIC_REPORT_ID}'
              #endif
               let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
            #else
              let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
            #endif
            let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, FEIN ' || $Current_FEIN
            Let #Tot = 2
            Let $State = ' '
            Let $Locality = ' '
            let $Company = ' '
            let $CompanyName = ' '
            Do Print-TaxBalance-Recap
            New-Page
          end-if
       End-if
 
       let #Current_FEIN = &CO.FEDERAL_EIN              !3/28/01 changes
       if #Current_FEIN <> 0
         move #Current_FEIN to $FedEIN 099999999
         move $FedEIN to $Current_FEIN xx-xxxxxxx
       else
         move ' ' to $Current_FEIN
       end-if
 
       display 'Processing Next FEIN --> ' noline
       display $Current_Fein
 
       Do Init-Report
 
      End-if
     #endif
    
    #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      if &CT.TF_COMPANY <> $Current_ADP_Compid
        if $Current_ADP_Compid <> ''
          if #Last_TaxTotal_Cnt > 0
            #ifdef CUSTOM_RUN_SELECTION
               let $ReportID     = '{PERIODIC_REPORT_ID}'
            #else
               let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
            #endif
            
            #if {SITE_ID} = 'CZB1'
              let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, Rollup Company ' || $Current_ADP_Compid
            #else
              let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, ADP Compid ' || $Current_ADP_Compid
            #endif
            
            Let #Tot = 2
            Let $State = ' '
            Let $Locality = ' '
            let $Company = ' '
            let $CompanyName = ' '
            Do Print-TaxBalance-Recap
            New-Page
          end-if
       End-if
 
       let $Current_ADP_Compid = rtrim(&CT.TF_COMPANY,' ')
 
       display 'Processing Next ADP Compid --> ' noline
       display $Current_ADP_Compid
 
       Do Init-Report
 
      End-if
     #endif
 
     !----------------------------------------------------
 
     let $Current_Company = rtrim(&A.COMPANY,' ')
 
     let $Client_CompID = $Current_Company
     let $COMPANY = $Current_Company
 
     move &A.PAY_END_DT to $AsofDate
     do get-company-data
     move &CT.COUNTRY to $Current_Country
 
     add 1 to #Company_cnt
 
     #ifndef SUBTOTAL_FEIN
       let #Current_FEIN = &CT.FEDERAL_EIN              !3/28/01 changes
       if #Current_FEIN <> 0
        move #Current_FEIN to $FedEIN 099999999
        move $FedEIN to $Current_FEIN xx-xxxxxxx
       else
        move ' ' to $Current_FEIN
       end-if
     #endif
 
     Do Init-Report
 
  End-if
 
 
  #ifdef PAYGROUP_ROLLUP
    move '   ' to $PAYGROUP
  #else
    let $PAYGROUP = rtrim(&A.PAYGROUP,' ')
    do get-paygroup-data
  #endif
 
  Let #ErrorCnt = 0
 
  move $A_Check_Dt to $Dt_in
  do Get-Quarter
  let #qtr_out = {BAL_QTR_TYPE}Input_Balance_Qtr
  let #Input_Balance_Year = #year_out
 
  show 'New Record from the Pay Calendar --->'
  show ' RunID          = ' $RunID
  show ' Federal EIN    = ' $Current_FEIN
  show ' Company        = ' $Current_Company
  show ' Paygroup       = ' $Current_Paygroup
  show ' Check Date     = ' &A.CHECK_DT
  show ' Year           = ' #Input_Balance_Year
  show ' Quarter        = ' {BAL_QTR_TYPE}Input_Balance_Qtr
  show ' Period         = ' {BAL_PERIOD_TYPE}Input_Balance_Period
  show ' PayBegin date  = ' &A.pay_begin_dt
  show ' PayEndDt       = ' $Input_Pay_End_Dt
  show ' Pay Confirm    = ' &A.PAY_CONFIRM_RUN
  if &A.PAY_CONFIRM_RUN <> 'Y'
    show 'Warning: This record has not been confirmed. PS_PAY_CALENDAR.PAY_CONFIRM_RUN = ' &A.PAY_CONFIRM_RUN
    show ' '
  end-if
  #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
    show ' SRC_BANK_ID    = ' &PAYTBL.SRC_BANK_ID
  #endif
  #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
    show ' Business Unit   = ' &CHKTBL.BUSINESS_UNIT
  #endif
 
  do Get-Payline
  
  #ifndef PAYGROUP_ROLLUP
    if round(#Paygroup_Total_Tax,2) <> 0              OR
       round(#Paygroup_Total_Taxable_Wages,2) <> 0    OR
       round(#Paygroup_Total_Gross_Wages,2) <> 0
 
     Let #Tot = 0
     #ifdef CUSTOM_RUN_SELECTION
       #ifdef PBZPER_WEEK_PROCESSING
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ', Week ' || $jcp_week
       #else
         let $ReportID    = '{PERIODIC_REPORT_ID}'
       #endif
     #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
     #endif
     let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, PAYGROUP ' || $Current_Paygroup
     Let $State = ' '
     Let $Locality = ' '
     do Print-TaxBalance-Recap    !print out the rpt for this paygroup
     New-Page
 
    end-if
 
  #endif
 
  let #last_TaxBalance_Cnt = 0
  let #Paygroup_Total_Tax = 0
  let #Paygroup_Total_Taxable_Wages = 0
  let #Paygroup_Total_Gross_Wages = 0
 
  let $Personal_Emplid = ' '
 
skip_company:
 
  FROM PS_PAY_CALENDAR A,
 
      #ifdef SUBTOTAL_FEIN
       PS_COMPANY_TBL CO,
      #endif
 
      #ifdef MULTIPLE_SITES
       {INSTALLATION_TABLE} TFIC,
       {ALT_SITES_TABLE}    TFAC,
      #endif
      
      #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
       PS_PAYGROUP_TBL PAYTBL,
      #endif

      #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT      
       PS_BUS_UNIT_TBL_HR CHKTBL,
      #endif

      #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
       PS_TF_COMPANY_XREF CT,
      #endif
 
      #if {SITE_ID} = 'GE01'
      	#ifdef GE_DEPT_TYPE_LIST  		!Tracker# 875668 To work even if this is Switched Off
       		PS_COMPANY_TBL CO,
       	#Endif					!Tracker# 875668 To work even if this is Switched Off
      #endif
 
      PS_PAY_CAL_BAL_ID Q
 
  WHERE
   #if {SITE_ID} = 'GE01'       !Tracker # 669108
     [$SlctCalendarBy]		!Tracker # 669108
   #else			!Tracker # 669108
     #if {SITE_ID} = 'SWF1'
       [$SlctCalendar_swift]
     #else
 
       #ifdef INCLUDE_KS_REGENT
          #ifdef MVS
            A.\$SlctCalendar_KS\          !for OS400 - /../, NT - [...],  MVS \...\
          #else
            A.[$SlctCalendar_KS]
          #endif
       #else
 
        #ifdef MVS
          \$SlctCalendar\          !for OS400 - /../, NT - [...],  MVS \...\
        #else
          [$SlctCalendar]
        #endif
        
       #endif
     #endif			!Tracker # 669108
   #endif
 
 
     #if {SITE_ID} = 'WFG1'
       #ifdef MVS
         \$Wells_COMPANIES_TO_EXCLUDE_pc\
       #else
          [$Wells_COMPANIES_TO_EXCLUDE_pc]
       #endif
     #endif
 
     #ifdef MULTIPLE_SITES !7/2/10 reworked due to dupliate rows being pulled
     AND ((TFIC.{WGPS_SITE_FIELD} = $TFI_Site
         AND A.COMPANY NOT IN (SELECT TFICC.COMPANY FROM {ALT_SITES_CO_TABLE} TFICC))
     OR (TFAC.{WGPS_SITE_FIELD} = $Alt_Site
         AND A.COMPANY IN (SELECT TFACC.COMPANY FROM {ALT_SITES_CO_TABLE} TFACC
                           WHERE TFACC.{WGPS_SITE_FIELD} = $Alt_Site)))
     #endif
 
 
     
     #if {SITE_ID} = 'HWL1'  !added 12/31/08
       [$HON_COMPANIES_TO_EXCLUDE]
     #endif
 
     #ifdef COMPANIES_TO_EXCLUDE
       AND NOT A.{COMPANIES_TO_EXCLUDE}
     #endif
 
     #if {SITE_ID} = 'CONVERGYS'
       AND A.COMPANY <> '701'
       AND A.COMPANY <> '703'
       AND A.COMPANY <> '888'
       AND A.COMPANY <> '999'
     #endif
 
     #if {SITE_ID} = 'MTBI'             !TJL - Exclude Puerto Rico  20121220
       AND (A.COMPANY < '300')          !TJL
     #endif                             !TJL
 
     !Sri, 1/11/05 ...Please include companies BETWEEN (650 - 699), added 630 on 8/15/05
     !------------------------------------------------------------------------------------
     #if {SITE_ID} = 'GEC1'
       AND ( (A.COMPANY BETWEEN '650'AND '699') OR (A.COMPANY = '630') )
     #endif
 
    #ifdef COMPANY_TO_PROCESS
       AND A.COMPANY = '{COMPANY_TO_PROCESS}'
     #endif
 
     #ifdef COMPANIES_TO_PROCESS
       AND A.COMPANY in {COMPANIES_TO_PROCESS}
     #endif
 
     AND (A.COMPANY  = Q.COMPANY)
     AND (A.PAYGROUP = Q.PAYGROUP)
     AND (A.PAY_END_DT = Q.PAY_END_DT)
     AND (Q.BALANCE_ID = $Bal_ID)
 
    #ifdef SUBTOTAL_FEIN
     AND CO.COMPANY = A.COMPANY
     AND CO.EFFDT =
      (SELECT MAX(EFFDT)
       FROM   PS_COMPANY_TBL CO1
       WHERE  CO1.COMPANY = CO.COMPANY
         AND  CO1.EFFDT  <= A.PAY_END_DT)
 
    #endif
 
    #if {SITE_ID} <> 'CZB1'
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      AND CT.COMPANY = A.COMPANY
      AND CT.EFFDT = (SELECT MAX(CT2.EFFDT)
           FROM PS_TF_COMPANY_XREF CT2
           WHERE CT2.COMPANY = CT.COMPANY
             #if {SITE_ID} = 'WHS1'
              AND CT2.EFFDT  <= A.CHECK_DT)
             #else
              AND CT2.EFFDT  <= A.PAY_END_DT)
             #endif
     #endif
    #else
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      AND CT.COMPANY = A.COMPANY
      AND CT.TF_EFFDT = (SELECT MAX(CT2.TF_EFFDT)
           FROM PS_TF_COMPANY_XREF CT2
           WHERE CT2.COMPANY = CT.COMPANY
             AND CT2.TF_EFFDT  <= A.PAY_END_DT)
     #endif
    #endif    
 
    #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
      AND PAYTBL.COMPANY  = A.COMPANY
      AND PAYTBL.PAYGROUP = A.PAYGROUP
      AND PAYTBL.EFFDT = (SELECT MAX(PAYTBL2.EFFDT)
           FROM PS_PAYGROUP_TBL PAYTBL2
           WHERE PAYTBL2.COMPANY = PAYTBL.COMPANY
            AND  PAYTBL2.PAYGROUP = PAYTBL.PAYGROUP
            AND  PAYTBL2.EFFDT  <= A.PAY_END_DT)
    #endif

    #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
      AND CHKTBL.BUSINESS_UNIT IN (SELECT DISTINCT CHKTBL1.BUSINESS_UNIT FROM PS_PAY_CHECK CHKTBL1
               WHERE CHKTBL1.COMPANY    = A.COMPANY
                 AND CHKTBL1.PAYGROUP   = A.PAYGROUP
                 AND CHKTBL1.PAY_END_DT = A.PAY_END_DT)                 
    #endif
 
    #if {SITE_ID} = 'GE01'
    	#ifdef GE_DEPT_TYPE_LIST				!Tracker# 875668 To work even if this is Switched Off
     		AND {GE_DEPT_TYPE_LIST}
     		AND CO.COMPANY = A.COMPANY
     		AND CO.EFFDT =
      		(SELECT MAX(EFFDT)
       			FROM   PS_COMPANY_TBL CO1
       			WHERE  CO1.COMPANY = CO.COMPANY
         		AND  CO1.EFFDT  <= A.PAY_END_DT)
         #Endif							!Tracker# 875668 To work even if this is Switched Off
    #endif
 
    #ifdef SUBTOTAL_FEIN
    
     #ifdef ADP_TAX_PERIODIC_CHECK_DATE
      ORDER BY CO.FEDERAL_EIN, A.COMPANY, A.CHECK_DT
     #else
      ORDER BY CO.FEDERAL_EIN, A.COMPANY, A.PAYGROUP
     #endif
    
    #else
       #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         ORDER BY CT.TF_COMPANY, A.COMPANY, A.PAYGROUP
       #else
         #ifdef PAYGROUP_ROLLUP_EXTRACT
           ORDER BY A.COMPANY, A.CHECK_DT
         #else
           #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
             ORDER BY PAYTBL.SRC_BANK_ID, A.COMPANY, A.PAYGROUP
           #else  
              #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
                ORDER BY CHKTBL.BUSINESS_UNIT, A.COMPANY, A.PAYGROUP
              #else
                ORDER BY A.COMPANY, A.PAYGROUP
              #endif
           #endif
         #endif
       #endif
    #endif
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
  #ifdef CUSTOM_RUN_DAILY_BATCH
     do Update-Auto-Run-Control-Record
  #endif
 
 
  if rtrim($Current_Company,' ') <> ''
 
 
  if #Last_TaxTotal_Cnt > 0
 
    #ifndef PAYGROUP_ROLLUP
     if round(#Paygroup_Total_Tax,2) <> 0              OR
        round(#Paygroup_Total_Taxable_Wages,2) <> 0    OR
        round(#Paygroup_Total_Gross_Wages,2) <> 0
 
      Let $State = ' '
      Let $Locality = ' '
      #ifdef CUSTOM_RUN_SELECTION
       #ifdef PBZPER_WEEK_PROCESSING
         let $ReportID     = '{PERIODIC_REPORT_ID}'  || ', Week ' || $jcp_week
       #else
         let $ReportID     = '{PERIODIC_REPORT_ID}'
       #endif
      #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
      #endif
      let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, PAYGROUP ' || $Current_Paygroup
      Let #Tot = 0
      do Print-TaxBalance-Recap    !print out the rpt for this last paygroup
      New-Page
     end-if
    #endif
 
    #ifdef SUBTOTAL_COMPANY
 
     if round(#Company_Total_Tax,2) <> 0              OR
        round(#Company_Total_Taxable_Wages,2) <> 0    OR
        round(#Company_Total_Gross_Wages,2) <> 0
      Let $State = ' '
      Let $Locality = ' '
      #ifdef CUSTOM_RUN_SELECTION
       #ifdef PBZPER_WEEK_PROCESSING
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ', Week ' || $jcp_week
       #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'
       #endif
      #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
      #endif
      let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, COMPANY ' || $Current_Company
      Let #Tot = 1
      Do Print-TaxBalance-Recap      !and the last company totals
      New-Page
     end-if
    #endif
 
    #ifdef SUBTOTAL_FEIN
     Let $State = ' '
     Let $Locality = ' '
      #ifdef CUSTOM_RUN_SELECTION
        #ifdef PBZPER_WEEK_PROCESSING
          let $ReportID    = '{PERIODIC_REPORT_ID}'  || ', Week ' || $jcp_week
        #else
          let $ReportID    = '{PERIODIC_REPORT_ID}'
        #endif
      #else
         let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
      #endif
     let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, FEIN ' || $Current_FEIN
     Let #Tot = 2
     let $Company = ' '
     let $CompanyName = ' '
     Do Print-TaxBalance-Recap      !and the last FEIN totals
     New-Page
    #endif
 
    #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      Let $State = ' '
      Let $Locality = ' '
      #ifdef CUSTOM_RUN_SELECTION
        let $ReportID     = '{PERIODIC_REPORT_ID}'
      #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
      #endif
 
      #if {SITE_ID} = 'CZB1'
       let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, Rollup Company ' || $Current_ADP_Compid
      #else
       let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, ADP Compid ' || $Current_ADP_Compid
      #endif
 
      Let #Tot = 2
      let $Company = ' '
      let $CompanyName = ' '
      Do Print-TaxBalance-Recap
      New-Page
 
    #endif
 
    #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
      Let $State = ' '
      Let $Locality = ' '
      #ifdef CUSTOM_RUN_SELECTION
        let $ReportID     = '{PERIODIC_REPORT_ID}'
      #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
      #endif
 
      let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, SRC_BANK_ID ' || $Current_SRC_BANK_ID
      Let #Tot = 2
      let $Company = ' '
      let $CompanyName = ' '
 
      display 'Final: Print-TaxBalance-Recap: SRC_BANK_ID --> ' noline
      display $Current_SRC_BANK_ID
 
      Do Print-TaxBalance-Recap
      New-Page
 
    #endif

 
    #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
      Let $State = ' '
      Let $Locality = ' '
      #ifdef CUSTOM_RUN_SELECTION
        let $ReportID     = '{PERIODIC_REPORT_ID}'
      #else
        let $ReportID     = '{PERIODIC_REPORT_ID}'  || ' - ' || $RunID
      #endif
 
      let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, Business Unit ' || $Current_BusUnit_CompID
      Let #Tot = 2
      let $Company = ' '
      let $CompanyName = ' '
 
      display 'Final: Print-TaxBalance-Recap: Business Unit --> ' noline
      display $Current_BusUnit_CompID
 
      Do Print-TaxBalance-Recap
      New-Page
 
    #endif

    
   end-if
 
 
 
   #ifndef MULTIPLE_RUNS
     #ifndef CUSTOM_RUN_SELECTION
       do print-hash-totals          !this will be done in Load-Multiple-Runs or Load-Custom-Runs
     #endif
   #endif
 
 end-if
 
 
end-procedure


begin-procedure print-hash-totals
 
   show 'Calling print-hash-totals...'
 
   ! Wells MC08941 - Begin - Added for sweep for b00 off cycles
   ! Wells-If Month-end, do sweep
   ! Wells-If NOT Month-end and off-cycle run, don't sweep
   ! Wells-If NOT Month-end and on-cycle run, sweep all on-cyles and only
   ! Wells    the non pure asset mgmt company off-cyles
   ! Wells-Pure asset mgmt companies do not have a pay calendar set up
   ! Wells    dt_entered needs to match pay_end_dt of on-cycle pay calendar
  #if {SITE_ID} = 'WFG1'
 
     show '  Wells Fargo Month_end = ' $Month_End ', Job_Run_Date = ' $Job_Run_Date, ', Off_Cycle = ' $Off_Cycle
 
     Evaluate $Month_End
       When = 'Y'
         #ifdef SWEEP_BALANCE_ADJUSTMENTS
            show ' '
            show ' **************** TBA SWEEP ***************** '
            show ' It is month-end sweep all transactions '
            show ' '
            show 'Calling Sweep-Adjustments...'
            do Sweep-Adjustments
            show ' **************** TBA SWEEP COMPLETE ******** '
            show ' '
         #endif
         break
       When-Other
         Evaluate $Off_Cycle
           When = 'Y'
             #ifdef SWEEP_BALANCE_ADJUSTMENTS                    !MC15308
             show ' '
             show ' It is not month-end and it is an off-cycle run'
             show 'Calling Sweep-Adjustments...'          !tlk
             do Sweep-Adjustments
             show ' '
             #endif                                              !MC15308
             break
           When-Other
             #ifdef SWEEP_BALANCE_ADJUSTMENTS
                show ' '
                show ' **************** TBA SWEEP ***************** '
                show ' It is not month-end and it is an on-cycle run'
                show ' sweep all on-cycles & only non-pure asset'
                show ' management cos. off-cycles.'
                show ' '
                show 'Calling Sweep-Adjustments...'
                do Sweep-Adjustments
                show ' **************** TBA SWEEP COMPLETE ******** '
                show ' '
             #endif
             break
         End-Evaluate
     End-Evaluate
 
 #else   ! client_id not WFG1
 
   #ifdef SWEEP_BALANCE_ADJUSTMENTS
      !no TBA sweep if this is a Canadian run
     !--------------------------------------
     if $Canadian <> 'Y'
      show ' '
      show ' **************** TBA SWEEP ***************** '
      show 'Calling Sweep-Adjustments...'
      do Sweep-Adjustments
      show ' **************** TBA SWEEP COMPLETE ******** '
      show ' '
     else
      show ' '
      show ' **************** No TBA SWEEP ***************** '
      show 'This is a Canadian run, no sweep of TBAs...'
      show ' '
     end-if
   #endif
 
  #endif   !client_id = WFG1
 
 
 #if {SITE_ID} <> 'RSS1'
   let #details = 0
 #endif
 
 !Full Hash Totals / All Companies
 !--------------------------------
 
 !if (#Company_cnt > 1)
  let #header_type = 0
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, Grand Total Detail'
  let $Company = 'ALL'
  let $CompanyName = ' '
  let $PayEndDate  = ' '
  let $ReportID     = '{PERIODIC_REPORT_ID}'
  Let #Tot = 3
  Let $State = ' '
  Let $Locality = ' '
  Do Print-TaxBalance-Recap
  New-Page
 !end-if
 
 #ifndef BYPASS_DETAILS_ON_REPORT_OFF
  if (#num_taxes_bypassed > 0)
   do Hash-Taxes-Bypassed-Breakout
  end-if
 #endif
 
 if (#Hash_check_cross_quarters > 0)
   do Hash-Cross-Quarter-Breakout
 end-if
 
 #ifdef BYPASS_FED_STOCK_OPTION_TAXES
  if #StockOptions_skipped_count > 0
   do Hash-StockOptions-Breakout
  end-if
 #endif
 
 #ifdef GET_BALANCE_ADJUSTMENTS
  if (#num_Bal_Adj > 0)
   do Bal-Adj-Breakout
  end-if
 #endif
 
 #ifdef TF_AUDIT
   do Print-TF-Audit
 #endif  
 
 do Print-Hire-Associates  !in adpq210.sqc
 
 #ifdef PA_WORKSITE_EXTRACT 
      do print-PA-Locality-Summary  !in adppaloc.sqc
 #endif
 
 #ifdef USE_TF_ADP_CSST_TBL
      do print-Canadian-CSST-Summary  !in adpcanad.sqc
 #endif
 
 do Hash-Check-Date-Breakout
 
 #ifdef PFZ1_2012_BANKING_SPLIT
   do Print-Banking-Split-PFZ1   !save #TaxBalance_Tax_Cur for company $PFZ1_VIRTUAL_CO
 #endif
 
 #ifdef OFF_CYCLE_DETAIL_PRINT 
  if (#off_cycle_detail_cnt > 0)
   do off-cycle-detail-breakout
  end-if
 #endif
 
 #ifdef COBRA
   do print-cobra-hash
 #endif
 
 #ifdef TAX_CLASS_REPORT
    show 'TAX_CLASS_REPORT, calling Print-TAX_CLASS_REPORT (in adptcrpt.sqc)'
    do Print-TAX_CLASS_REPORT
 #endif
 
 
 let #header_type = 2
 let $ReportTitle  = 'ADP Employment Tax, Periodic Extract, Grand Total Summary'
 print 'Summary for All Companies in the Periodic Run (HASH TOTALS):' (+2,1) {PRINT_HIGHLIGHT}
 #if {PERIODIC_REPORT_ID} = 'PBZPER'
 print ' RUN_ID: '  ()  {PRINT_HIGHLIGHT}
 print $RunID       ()  {PRINT_HIGHLIGHT}
 #endif
 
 #ifdef MULTIPLE_SITES
    print ',  Site_ID : '  ()               {PRINT_HIGHLIGHT}
    print $Site_ID_RC      ()               {PRINT_HIGHLIGHT}
    print ',  Alt_SITE: '  ()               {PRINT_HIGHLIGHT}
    print $Alt_Site        ()               {PRINT_HIGHLIGHT}
    print ',  TFI_SITE: '  ()               {PRINT_HIGHLIGHT}
    print $TFI_Site        ()               {PRINT_HIGHLIGHT}
 #endif
 
 #if {SITE_ID} = 'USB1'
     print ',  SlctPrint: '  ()               {PRINT_HIGHLIGHT}
     print $SlctPrint        ()               {PRINT_HIGHLIGHT}
 #endif
 
 #ifdef CUSTOM_RUN_SELECTION
    print 'Custom Run Selection '        (+1,1)
    #ifdef PBZPER_WEEK_PROCESSING
       print 'Week: '                    (0,75)
       print $jcp_week                   ()
    #endif
 #endif
 
 #if {SITE_ID} = 'RSS1'
  print 'SlctOffCycleA = '        (+2,1)
  print $SlctOffCycleA            ()
  print 'SlctOffCycleB = '        (+1,1)
  print $SlctOffCycleB            ()
  print 'Stock Option Count = '   (+1,1)
  print #RSS1_Stock_option_count  () edit 999,999
 #endif
 
 print 'Total Taxes Extracted                        = '  (+2,20)                      {PRINT_HIGHLIGHT}
 print #Hash_Total_Tax                                    () edit 99,999,999,999.99mi  {PRINT_HIGHLIGHT}
 print '   (Total Deposit)'                               ()                           {PRINT_HIGHLIGHT}
 
  #ifdef HOLD_CREDITS
   if  round(#Total_adj_credits,2) <> 0
     print 'Total Credit Adjustment                      = '   (+1,20)
     print #Total_adj_credits                                  () edit 999,999,999.99mi
     print '   (Credits Saved less Credits Applied to this extract run)'   ()
   end-if
  #endif
 

 #if {SITE_ID} = 'ARK1'
    print 'Total Company Pd Taxes                    = ' (+1,20)
    print #CoPaid_Tot                                    ()
    print 'TAX001 Total Taxes                        = ' (+1,20)
    let #Tax001_Hash = #Hash_Total_Tax - #CoPaid_Tot
    print #Tax001_Hash                                   ()
 #endif
 
 if  round(#Hash_Ignore_Tax,2) <> 0
    print 'Total Taxes Not reported                     = '  (+1,20)
    print #Hash_Ignore_Tax                                ()  edit 999,999,999.99mi
    print '   (SUI, FUI, ... not funded until End of Qtr)' ()
  end-if
 
 
 if  round(#Adj_taxes_total,2) <> 0
    print 'Total Taxes from Tax Balance Adjustments     = '  (+1,20)
    print #Adj_taxes_total                                ()  edit 999,999,999.99mi
  end-if
 
 
 #ifdef LOG_SENT_PAYLINES
   if round(#Hash_Taxes_Previously_Extracted,2) <> 0
     print 'Total Taxes Previously Extracted             = ' (+1,20)
     print #Hash_Taxes_Previously_Extracted () edit 999,999,999.99mi
   end-if
 #endif
 
 if round(#CALC-MOH-EMPLOYER-CREDIT_Hash,2) <> 0
     print 'Total Missouri SIT Employer Credit           = ' (+1,20)
     print #CALC-MOH-EMPLOYER-CREDIT_Hash () edit 999,999,999.99mi
 end-if
 
 #ifdef LIVE_DATE_DTU
   if round(#Hash_Taxes_Prior_to_Live_Date,2) <> 0
     print 'Total Taxes Prior to Live Date               = ' (+1,20)
     print #Hash_Taxes_Prior_to_Live_Date () edit 999,999,999.99mi
     print ' , live date ' ()
     print $Live_Date_DTU  ()
   end-if
 #endif
 
 #ifdef DEAD_DATE_DTU
   if round(#Hash_Taxes_After_Dead_Date,2) <> 0
     print 'Total Taxes After Dead Date                  = ' (+1,20)
     print #Hash_Taxes_After_Dead_Date () edit 999,999,999.99mi
     print ' , dead date ' ()
     print $Dead_Date_DTU  ()
   end-if
 #endif
 
 !ER Generated Totals
 !-------------------
 if  round(#Hash_Generated_Taxes,2) <> 0
    print 'Total Employer Generated taxes               = '  (+1,20)
    print #Hash_Generated_Taxes                              () edit 999,999,999.99mi
    print '   (Already included in tax totals)'              ()
 end-if
 
 let #delta = #Hash_Generated_Taxes_into_TaxBalances - #Hash_Generated_Taxes
 if  round(#delta,2) <> 0
      print 'ERROR: Total ER Generated Mismatch. Hash Total = '  (+1,20)
      print #Hash_Generated_Taxes                       () edit 999,999,999.99mi
      print ', TaxBalance Total = '                     ()
      print #Hash_Generated_Taxes_into_TaxBalances      () edit 999,999,999.99mi
      print ', Delta = '                                ()
      print #delta                                      () edit 999,999,999.99mi
 end-if
 !------------------
 
 
 
 #if {PeopleSoft_Version} >= '7.5'
  #ifdef Tax001_75_old
   print 'Total Local ER taxes      = '  (+1,20)
   print #Hash_Local_ER_Tax                ()
  #endif
 #endif
 
 move 'TAX001' to $Balancing_Report
 #if {SITE_ID} = 'BKR1'
   move 'PBZ001BI' to $Balancing_Report
 #endif
 
 print 'To Reconcile: Use Grand Total row on report: ' (+2,10)
 print $Balancing_Report  ()
 print '''Total Deposit'' + ''UI Tax'' ' (+2,1)
 
 #if {PeopleSoft_Version} >= '7.5'
   #ifdef Tax001_75_old
    print ' - ''Other Employer'' ' ()
   #endif
 #endif
 
 #ifdef LOG_SENT_PAYLINES
   print ' = ''Total Taxes Extracted'' + ''Total Taxes Not reported'' + ''Total Taxes Previously Extracted'' ' ()
 
   #ifdef HOLD_CREDITS
     print ' + ''Credits'' ' ()
   #endif
 
   #ifdef GET_BALANCE_ADJUSTMENTS
     print ' - ''Balance Adj'' ' ()
   #endif
 
   #ifdef COBRA_TAXCODE
     if #Cobra_amount_h > 0
       print ' - ''Cobra 65%'' ' ()
     end-if
   #endif
 
 #else
   print ' = ''Total Taxes Extracted'' + ''Total Taxes Not reported '' ' ()
 
   #ifdef HOLD_CREDITS
     print ' + ''Credits'' ' ()
   #endif
 
   #ifdef GET_BALANCE_ADJUSTMENTS
     print ' - ''Balance Adj'' ' ()
   #endif
 
   #ifdef COBRA_TAXCODE
     if #Cobra_amount_h > 0
       print ' - ''Cobra 65%'' ' ()
     end-if
   #endif
 
 #endif
 
 
 #if {PeopleSoft_Version} >= '7.5'
  #ifdef Tax001_75_old
   print ' - ''Total Local ER taxes'' ' ()
  #endif
 #endif
 
 let #reconciliation_total = #Hash_Total_Tax + #Hash_Ignore_Tax + #Hash_Taxes_Previously_Extracted
 #ifdef HOLD_CREDITS
    let #reconciliation_total = #reconciliation_total + #Total_adj_credits     ! adding a negative number
 #endif
 
 #ifdef GET_BALANCE_ADJUSTMENTS
   let #reconciliation_total = #reconciliation_total - #Adj_taxes_total        ! 5/9/05 fix
 #endif
 
 #ifdef COBRA_TAXCODE
   let #reconciliation_total = #reconciliation_total - #Cobra_amount_h        ! 5/9/05 fix
 #endif
 
 #if {PeopleSoft_Version} >= '7.5'
  #ifdef Tax001_75_old
    let #reconciliation_total = #Hash_Total_Tax + #Hash_Ignore_Tax - #Hash_Local_ER_Tax
  #endif
 #endif
 
 print ' = ' ()
 print #reconciliation_total () edit 99,999,999,999.99mi
 
 
 #ifdef HOLD_CREDITS
   #if {SITE_ID} = 'PFZ1'
     let #reconciliation_total_pnu = #reconciliation_total - #Hash_Ignore_Tax
     print 'Balancing for Pfizer'                                           (+2,1)
     print '--------------------'                                           (+1,1)
     print 'Balance to PYR030, Grand Total Taxes. Taxes Extracted + Credits      = ' (+1,1)
     print #reconciliation_total_pnu                                                 () edit $$$,$$$,$$$,$$9.99mi
     print 'Company 200, Paygroups 21L,31L,FSL,PHL,A6S,A7S are the Intl. employees.' (+1,1)
     print 'Total International Fica Taxes (Compid 200 WL-FOR, OASDI-EE, MED-EE) = ' (+1,1)
     print #Hash_Total_Tax_WL_FicaEE_Intl                                            () edit $$$,$$$,$$$,$$9.99mi
     print '--------------------'                                                    (+1,1)
     print ' '                                                                       (+1,1)
   #endif
 #endif
 
 if round(#CALC-MOH-EMPLOYER-CREDIT_Hash,2) <> 0
   show ' '
   show 'Total Missouri SIT Employer Credit = ' #CALC-MOH-EMPLOYER-CREDIT_Hash
   show ' '
   let #Hash_Total_Tax = #Hash_Total_Tax + #CALC-MOH-EMPLOYER-CREDIT_Hash
   let #Hash_Total_STH = #Hash_Total_STH + #CALC-MOH-EMPLOYER-CREDIT_Hash
 end-if
 
 show ' '
 show 'Total Taxes Extracted in run = ' #Hash_Total_Tax
 show '-------------------------------------------------'
 
 !8/21/08 company associate totals
 !---------------------------------
 print 'Associate Count Total        = '  (+1,20)
 print #associate_count                   () edit 999,999
 print '  Female  Count Total        = '  (+1,20)
 print #associate_count_female            () edit 999,999
 print '    Male  Count Total        = '  (+1,20)
 print #associate_count_male              () edit 999,999
 print '  AL-SIT  Count Total        = '  (+1,20)
 print #alfm_tot                          () edit 999,999
 
 #if {SITE_ID} = 'TLL1'
  #ifdef TOLL_FAIRLESS_HILLS_COMPID
     print 'TOLL BROTHERS: Total {TOLL_FAIRLESS_HILLS_COMPID} Taxes = ' (+2,1)
     print #Hash_Total_Tax_NGR2  () edit $$$,$$$,$$$,$$9.99mi
  #endif
 #endif
 
 #if {SITE_ID} = 'CHS1'
     do print-CT-location-CHS1 !probiz.sqc
 #endif
 #ifdef GENERAL_SUI_SPLIT_STATE
     do print-sui-split-location !adpuispl.sqc
 #endif
 
 #ifdef CANADA_TOO
 
   if round(#Hash_T4,2) <> 0
    print 'Total Canadian T4                  = '  (+2,20)
    print  #Hash_T4   () edit 999,999,999.99mi
   end-if
   if round(#Hash_T4A,2) <> 0
    print 'Total Canadian T4A                 = '  (+1,20)
    print  #Hash_T4A   () edit 999,999,999.99mi
   end-if
 
   let #Hash_FIT =   #Hash_T4 + #Hash_T4A
 
   if round(#Hash_FIT,2) <> 0
    print 'Total Canadian FIT                 = '  (+1,20)
    print  #Hash_FIT   () edit 999,999,999.99mi
    print ',  FIT Taxable = ' ()
    print  #Hash_canada_fit_txgrs   () edit 999,999,999.99mi
   end-if
 
   if round(#Hash_QIP,2) <> 0
    print 'Total Quebec   QIP                 = '  (+1,20)
    print  #Hash_QIP   () edit 999,999,999.99mi
   end-if
 
   if round(#Hash_CST,2) <> 0
    print 'Total Quebac CSST                  = '  (+1,20)
    print  #Hash_CST   () edit 999,999,999.99mi
    print ', CSST Taxable = ' ()
    print  #Hash_CST_Taxable        () edit 999,999,999.99mi
   end-if
 
   if round(#Hash_RL1,2) <> 0
    print 'Total Quebec   RL-1                = '  (+1,20)
    print  #Hash_RL1   () edit 999,999,999.99mi
   end-if
   if round(#Hash_RL2,2) <> 0
    print 'Total Quebec   RL-2                = '  (+1,20)
    print  #Hash_RL2   () edit 999,999,999.99mi
   end-if
 
   let #Hash_QIT =   #Hash_RL1 + #Hash_RL2
 
   if round(#Hash_QIT,2) <> 0
    print 'Total Quebac QIT                   = '  (+1,20)
    print  #Hash_QIT   () edit 999,999,999.99mi
    print ',  QIT Taxable = ' ()
    print  #Hash_quebec_fit_txgrs   () edit 999,999,999.99mi
   end-if
 
   if round(#Hash_canada,2) <> 0
    print 'Total Canadian Remitted            = '  (+1,20)
    print  #Hash_canada   () edit 999,999,999.99mi
   end-if
   if round(#Hash_quebec,2) <> 0
    print 'Total Quebec Remitted              = '  (+1,20)
    print  #Hash_quebec   () edit 999,999,999.99mi
   end-if
 
   if round(#Hash_True_T4_TxGrs_Cur,2) <> 0
    print 'Total T4 Taxable Wages             = '  (+1,20)
    print  #Hash_True_T4_TxGrs_Cur   () edit 999,999,999.99mi
   end-if
   if round(#Hash_Payroll_Txgrs_Cur,2) <> 0
    print 'Total Payroll Taxable Wages        = '  (+1,20)
    print  #Hash_Payroll_Txgrs_Cur   () edit 999,999,999.99mi
   end-if
   if round(#Hash_Payroll_Tax_Cur,2) <> 0
    print 'Total Payroll Taxes Withheld       = '  (+1,20)
    print  #Hash_Payroll_Tax_Cur   () edit 999,999,999.99mi
   end-if
 
 !added 1/16/03
  if round(#Hash_Pension_Tax_Cur_ER,2) <> 0
    print 'Total Pension Plan Employer        = '  (+1,20)
    print  #Hash_Pension_Tax_Cur_ER   () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Pension_Tax_Cur_EE,2) <> 0
    print 'Total Pension Plan Employee        = '  (+1,20)
    print  #Hash_Pension_Tax_Cur_EE   () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Pension_Tax_Cur_EE,2) <> 0
    print 'Total Pension Plan EE & ER         = '  (+1,20)
    let #Hash_Pension_Tax_Cur_EE_ER = #Hash_Pension_Tax_Cur_EE + #Hash_Pension_Tax_Cur_ER
    print  #Hash_Pension_Tax_Cur_EE_ER   () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Pension_Tax_Cur_ER_quebec,2) <> 0
    print 'Total Pension Plan Employer QC     = '  (+1,20)
    print  #Hash_Pension_Tax_Cur_ER_quebec   () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Pension_Tax_Cur_EE_quebec,2) <> 0
    print 'Total Pension Plan Employee QC     = '  (+1,20)
    print  #Hash_Pension_Tax_Cur_EE_quebec   () edit 999,999,999.99mi
  end-if
 
 
  if round(#Hash_Pension_Tax_Cur_EE_quebec,2) <> 0
    print 'Total Pension Plan EE & ER  QC     = '  (+1,20)
    let #Hash_Pension_Tax_Cur_EE_ER_quebec = #Hash_Pension_Tax_Cur_EE_quebec + #Hash_Pension_Tax_Cur_ER_quebec
    print  #Hash_Pension_Tax_Cur_EE_ER_quebec   () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Empl_ins_Tax_Cur_EE,2) <> 0
    print 'Total Employment Ins. Employee     = '  (+1,20)
    print  #Hash_Empl_ins_Tax_Cur_EE  () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Empl_ins_Tax_Cur_ER,2) <> 0
    print 'Total Employment Ins. Employer     = '  (+1,20)
    print  #Hash_Empl_ins_Tax_Cur_ER  () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Empl_ins_Tax_Cur_ER,2) <> 0
    print 'Total Employment Ins. EE & ER      = '  (+1,20)
    let #Hash_Empl_ins_Tax_Cur_EE_ER = #Hash_Empl_ins_Tax_Cur_ER + #Hash_Empl_ins_Tax_Cur_EE
    print  #Hash_Empl_ins_Tax_Cur_EE_ER  () edit 999,999,999.99mi
  end-if
 
 
  if round(#Hash_QPIP_Empl_ins_Tax_Cur_EE,2) <> 0
    print 'Total Employment QPIP Employee     = '  (+1,20)
    print  #Hash_QPIP_Empl_ins_Tax_Cur_EE  () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_QPIP_Empl_ins_Tax_Cur_ER,2) <> 0
    print 'Total Employment QPIP Employer     = '  (+1,20)
    print  #Hash_QPIP_Empl_ins_Tax_Cur_ER  () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_QPIP_Empl_ins_Tax_Cur_ER,2) <> 0
    print 'Total Employment QPIP EE & ER      = '  (+1,20)
    let #Hash_QPIP_Empl_ins_Tax_Cur_EE_ER = #Hash_QPIP_Empl_ins_Tax_Cur_ER + #Hash_QPIP_Empl_ins_Tax_Cur_EE
    print  #Hash_QPIP_Empl_ins_Tax_Cur_EE_ER  () edit 999,999,999.99mi
  end-if
 
  if round(#Hash_Health_Tax_Cur_ER,2) <> 0
    print 'Total Health Ins. Employer         = '  (+1,20)
    print  #Hash_Health_Tax_Cur_ER  () edit 999,999,999.99mi
    print ', (including taxes not processed of ' ()
    print  #Hash_Health_Tax_Cur_ER_bypassed () edit 999,999,999.99mi
    print ')' ()
  end-if
 
 
   let #total_remitted = #Hash_canada + #Hash_quebec
   if round(#total_remitted,2) <> 0
    print 'Canada Grand Total Remitted        = '  (+1,20)
    print  #total_remitted   () edit 999,999,999.99mi
   end-if
 
   if round(#total_remitted,2) <> round(#Hash_Cur_Total_Tax_can,2)
    print 'Canada Grand Total (from extract)  = '  (+1,20)
    print  #Hash_Cur_Total_Tax_can   () edit 999,999,999.99mi
   end-if
 
   !10/18/05  breakout of federal split of Taxable and taxes
   #ifdef SPLIT_FEDERAL
    show  'Printing Canada SPLIT of CIT Taxes and Wages'
    print 'Canada SPLIT of CIT Taxes and Wages'       (+2,20)
    print '-----------------------------------'       (+1,20)
    print 'Unit1 - Wage Loss plan defined as: '       (+1,20)
    print '{SPLIT_BUS1_WAGE_LOSS_PLAN}'               ()
    print 'Unit2 - Wage Loss plan defined as: '       (+1,20)
    print '{SPLIT_BUS2_WAGE_LOSS_PLAN}'               ()
    print '  Total Taxes Withheld, Unit1    = '       (+1,20)
    print  #Cit_Tax_Hash                              () edit 999,999,999.99mi
    print '  Total Taxable Wages,  Unit1    = '       (+1,20)
    print  #Cit_Taxable_Hash                          () edit 999,999,999.99mi
    print '  Total Taxes Withheld, Unit2    = '       (+1,20)
    print  #Cit_Tax2_Hash                             () edit 999,999,999.99mi
    print '  Total Taxable Wages,  Unit2    = '       (+1,20)
    print  #Cit_Taxable2_Hash                         () edit 999,999,999.99mi
   #endif
 
 
   print 'Balance above Total to Total Remitted in TAX003CN Submission Summary Report' (+2,10)
 
 #endif
 
   #if {SITE_ID} = 'KFC_OLD'
      print '* KForce Professional Services Breakout'  (+2,1)
      print '---------------------------------------'  (+1,1)
 
      print '  Total Flex Taxes (F)    = ' (+1,10)
      print #Hash_Total_Tax_KFORCE_F           () edit $$$,$$$,$$$,$$9.99mi
 
      print '  Total Core Taxes (C)    = ' (+1,10)
      print #Hash_Total_Tax_KFORCE_C           () edit $$$,$$$,$$$,$$9.99mi
 
      print '  Total Main Taxes (M)    = ' (+1,10)
      print #Hash_Total_Tax_KFORCE_M           () edit $$$,$$$,$$$,$$9.99mi
 
      print '  Total Staf Taxes (S)    = ' (+1,10)
      print #Hash_Total_Tax_KFORCE_S           () edit $$$,$$$,$$$,$$9.99mi
 
      let #Hash_Total_Tax_KFORCE = #Hash_Total_Tax_KFORCE_F + #Hash_Total_Tax_KFORCE_C +
                                   #Hash_Total_Tax_KFORCE_M + #Hash_Total_Tax_KFORCE_S
 
      print '  Total Tax (Core + Flex + Main + Staffing/CA) = ' (+1,10)
      print #Hash_Total_Tax_KFORCE             () edit $$$,$$$,$$$,$$9.99mi
 
    #endif
 
 
 #if {SITE_ID} = 'CONVERGYS'
    print '* CONVERGYS ---->  Note, Company 701,703,888 and 999 are NOT included in extract.' (+2,1)
 #endif
 

 #ifdef COMPANIES_TO_EXCLUDE_PRINT
    print '* Companies excluded from periodic run: ' (+2,1)
    print '{COMPANIES_TO_EXCLUDE_PRINT}' ()
 #endif
 
  if $HON_COMPANIES_TO_EXCLUDE <> ''  !added 12/31/08
   print '* Companies excluded from periodic run:' (+2,1)
   print $HON_COMPANIES_TO_EXCLUDE_PRINT ()
  end-if
 
 
 !#ifdef CANADA_HEALTH_TOO
   !show 'Printing Canada Health insurance rates...'
   !do Print-Health-Totals
 !#endif
 
 
 print 'Total Taxable Wages (all jurisdictions)      = '  (+2,20)
 print #Hash_Total_Taxable_Wages       () edit 99,999,999,999.99mi
 print 'Total Gross Wages (all jurisdictions)        = '  (+1,20)
 print #Hash_Total_Gross_Wages         () edit 99,999,999,999.99mi
 
 if #Hash_check_cross_quarters > 0
    print 'Number of Payline Reversals & Cross-overs from Prior Qtr = ' (+2,20)
    print #Hash_check_cross_quarters ()
 end-if
 
 #ifdef KJDA
  print 'The following KJDA Fees'   (+2,10)
 
  #ifdef KJDA_to_Extract
   print ' have been included in the TaxTotals above' ()
  #else
   print ' have been included in the Non-Reported taxes above' ()
  #endif
 
  print 'KY KJDA Fees             = '  (+2,20)
  print  #Hash_ky_KJDA                   ()
  #if {SITE_ID} = 'PJN1'
  print 'Jefftown KJDA Fees       = '  (+1,20)
  print  #Hash_jt_KJDA                   ()
  #endif
  print 'Jeff County KJDA Fees    = '  (+1,20)
  print  #Hash_jc_KJDA                   ()
  print 'Sum of KJDA Fees         = '  (+1,20)
  let #kjda_total = #Hash_ky_KJDA + #Hash_jt_KJDA + #Hash_jc_KJDA
  print #kjda_total ()
 
  print 'KJDA Employee Count      = '  (+1,20)
  print  #Hash_KJDA_Cnt                  ()
 
  do Calc-Total-KJDA-Credits
 
  #ifdef KJDA_LOCATION_CD
  print 'Plan A Tot. KJDA Credits = ' (+2,20)
  print #KJDAA_YEAR_Total       () edit 99,999,999,999.99mi
  print 'Plan B Tot. KJDA Credits = ' (+1,20)
  print #KJDAB_YEAR_Total       () edit 99,999,999,999.99mi
  print 'Plan C Tot. KJDA Credits = ' (+1,20)
  print #KJDAC_YEAR_Total       () edit 99,999,999,999.99mi
  print 'Plan D Tot. KJDA Credits = ' (+1,20)
  print #KJDAD_YEAR_Total       () edit 99,999,999,999.99mi
  #endif
 
  print 'Grand Total KJDA Credits = ' (+2,20)
  print #KJDA_YEAR_Total       () edit 99,999,999,999.99mi
  print '  for Year '          ()
  print #Input_Balance_Year    () edit 9999
 
  #ifdef KJDA_LOCATION_CD
  print 'If the Total Yearly KJDA Plan A Credit exceeds your limit, add: #define BYPASS_KJDA_PLAN_A into probiz.sqc' (+1,20)
  print 'If the Total Yearly KJDA Plan B Credit exceeds your limit, add: #define BYPASS_KJDA_PLAN_B into probiz.sqc' (+1,20)
  print 'If the Total Yearly KJDA Plan C Credit exceeds your limit, add: #define BYPASS_KJDA_PLAN_C into probiz.sqc' (+1,20)
  print 'If the Total Yearly KJDA Plan D Credit exceeds your limit, add: #define BYPASS_KJDA_PLAN_D into probiz.sqc' (+1,20)
  #else
  print 'If the Total Yearly KJDA Credit exceeds your limit, add: comment out #define KJDA from probiz.sqc' (+1,20)
  #endif
 
 
 #endif
 
 
 #ifdef TIPS_ROLLUP
  print 'The following Tips Wages & Taxes'   (+2,10)
  print ' have been included in the Totals above' ()
 
  if round(#OASDI_Tips_Wages_Tot_EE_Hash,2) <> 0
    print 'OASDI Tips - Taxable EE  = '  (+2,20)
    print  #OASDI_Tips_Wages_Tot_EE_Hash   ()
  end-if
 
  if round(#OASDI_Tips_Taxes_Tot_EE_Hash,2) <> 0
    print 'OASDI Tips - Taxes EE    = '  (+1,20)
    print  #OASDI_Tips_Taxes_Tot_EE_Hash   ()
  end-if
 
  if round(#OASDI_Tips_Wages_Tot_ER_Hash,2) <> 0
    print 'OASDI Tips - Taxable ER  = '  (+1,20)
    print  #OASDI_Tips_Wages_Tot_ER_Hash   ()
  end-if
 
  if round(#OASDI_Tips_Taxes_Tot_ER_Hash,2) <> 0
    print 'OASDI Tips - Taxes ER    = '  (+1,20)
    print #OASDI_Tips_Taxes_Tot_ER_Hash    ()
  end-if
 
  if round(#MEDIC_Tips_Wages_Tot_EE_Hash,2) <> 0
    print 'MEDIC Tips - Taxable EE  = '  (+2,20)
    print  #MEDIC_Tips_Wages_Tot_EE_Hash   ()
  end-if
 
  if round(#MEDIC_Tips_Taxes_Tot_EE_Hash,2) <> 0
    print 'MEDIC Tips - Taxes EE    = '  (+1,20)
    print  #MEDIC_Tips_Taxes_Tot_EE_Hash   ()
  end-if
 
  if round(#MEDIC_Tips_Wages_Tot_ER_Hash,2) <> 0
    print 'MEDIC Tips - Taxable ER  = '  (+1,20)
    print  #MEDIC_Tips_Wages_Tot_ER_Hash   ()
  end-if
 
  if round(#MEDIC_Tips_Taxes_Tot_ER_Hash,2) <> 0
    print 'MEDIC Tips - Taxes ER    = '  (+1,20)
    print #MEDIC_Tips_Taxes_Tot_ER_Hash    ()
  end-if
 
 #endif
 
 if round(#Hash_Total_Tax_Non_941,2) <> 0
   print '   (Note, Non-941 Taxes and Wages are mapped as: {FORM1042_Taxcode} and ' (+2,10)
   print '{FORM945P_Taxcode} in the extract)'  ()
   print 'Total Non-941 Taxes Withheld (FIT)  = '  (+1,20)
   print #Hash_Total_Tax_Non_941                   () edit 999,999,999.99mi
   print 'Total Non-941 Taxable Wages  (FIT)  = '  (+1,20)
   print #Hash_Total_Taxable_Wages_Non_941         () edit 999,999,999.99mi
 end-if
 
 #ifndef PROCESS_TERRITORY_STATE_RECORDS
  if round(#Tax_Total_bypassed_territory,2) <> 0
   print 'Taxes Skipped From Territory Memo Pay_Tax records   = '  (+1,20)
   print #Tax_Total_bypassed_territory    () edit 999,999,999.99mi
  end-if
 #endif
 
 #ifdef THIRD_PARTY_SICK_PERIODIC
   do third-party-sick-periodic-report
 #endif
 
 
 !new totals 4/18/02
 !------------------
 print 'Federal Hash Totals'              (+2,1) {PRINT_HIGHLIGHT}
 print 'Total FIT      ($UH)         = '  (+1,20)
 print #Hash_Total_UH                     () edit 99,999,999,999.99mi
 print 'Total OASDI-EE ($UD)         = '  (+1,20)
 print #Hash_Total_UD                     () edit 99,999,999,999.99mi
 print 'Total OASDI-ER ($UE)         = '  (+1,20)
 print #Hash_Total_UE                     () edit 99,999,999,999.99mi
 print 'Total FICA ERX ($U8)         = '  (+1,20)
 print #Hash_Total_U8                     () edit 99,999,999,999.99mi
 print 'Total MED-EE   ($UF)         = '  (+1,20)
 print #Hash_Total_UF                     () edit 99,999,999,999.99mi
 print 'Total MED-SUR  ($U7)         = '  (+1,20)
 print #Hash_Total_U7                     () edit 99,999,999,999.99mi
 print 'Total MED-ER   ($UQ)         = '  (+1,20)
 print #Hash_Total_UQ                     () edit 99,999,999,999.99mi
 
 if round(#Hash_Total_UC,2) <> 0
 print 'Total EIC      ($UC / $EC)   = '  (+1,20)
 print #Hash_Total_UC                     () edit 99,999,999,999.99mi
 end-if
 
 print 'Total FUTA     ($UU)         = '  (+1,20)
 print #Hash_Total_UU                     () edit 99,999,999,999.99mi
 
 if round(#Hash_Total_UG,2) <> 0
  print 'Tips  OASDI-EE ($UG)         = '  (+1,20)
  print #Hash_Total_UG                     () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_UJ,2) <> 0
  print 'Tips  OASDI-ER ($UJ)         = '  (+1,20)
  print #Hash_Total_UJ                     () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_U9,2) <> 0
  print 'Tips  FICA-ERX ($U9)         = '  (+1,20)
  print #Hash_Total_U9                     () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_UT,2) <> 0
  print 'Tips  MED-ER   ($UT)         = '  (+1,20)
  print #Hash_Total_UT                     () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_UZ,2) <> 0
  print 'Tips  MED-ER   ($UZ)         = '  (+1,20)
  print #Hash_Total_UZ                     () edit 99,999,999,999.99mi
 end-if
 
 print 'State Hash Totals'                (+2,1) {PRINT_HIGHLIGHT}
 print 'Total SIT      (xxH)         = '  (+1,20)
 print #Hash_Total_STH                    () edit 99,999,999,999.99mi
 
 if round(#Hash_Total_STD,2) <> 0
  print 'Total SDI-EE   (xxD)         = '  (+1,20)
  print #Hash_Total_STD                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STE,2) <> 0
  print 'Total SDI-ER   (xxE)         = '  (+1,20)
  print #Hash_Total_STE                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STU,2) <> 0
  print 'Total SUI-ER   (xxU)         = '  (+1,20)
  print #Hash_Total_STU                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STS,2) <> 0
  print 'Total SUI-Spcl (xxS)         = '  (+1,20)
  print #Hash_Total_STS                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STV,2) <> 0
  print 'Total SUI-EE   (xxV)         = '  (+1,20)
  print #Hash_Total_STV                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STL,2) <> 0
  print 'Total SWAF     (xxL)         = '  (+1,20)
  print #Hash_Total_STL                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STM,2) <> 0
  print 'Total WFDP     (xxM)         = '  (+1,20)
  print #Hash_Total_STM                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_STN,2) <> 0
  print 'Total HCSF     (xxN)         = '  (+1,20)
  print #Hash_Total_STN                    () edit 99,999,999,999.99mi
 end-if
 
 !12/11/08 --- FLI-EE (tax class I) and VFLI-EE (tax class O), Vol FLI/ER (tax class Y)
 if round(#Hash_Total_FLIEE,2) <> 0
  print 'Total FLI-EE   (NJI)         = '  (+1,20)
  print #Hash_Total_FLIEE                    () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_VFLIEE,2) <> 0
  print 'Total VFLI-EE  (NJO)         = '  (+1,20)
  print #Hash_Total_VFLIEE                   () edit 99,999,999,999.99mi
 end-if
 if round(#Hash_Total_VFLIER,2) <> 0
  print 'Total VFLI-ER  (NJY)         = '  (+1,20)
  print #Hash_Total_VFLIER                   () edit 99,999,999,999.99mi
 end-if
 
 print 'Local Hash Totals'                (+2,1) {PRINT_HIGHLIGHT}
 print 'Total Local Taxes            = '  (+1,20)
 print #Hash_Total_Local                  () edit 99,999,999,999.99mi
 
 if round(#TaxBalance_Txgrs_locals_cleared_hash,2) <> 0
  print 'Total Local Taxable Wages skipped due to zero Taxes Withheld (ADJUST_ZERO_LOCALS enabled)   = '   (+1,20)
  print #TaxBalance_Txgrs_locals_cleared_hash                                                              () edit 99,999,999,999.99mi
 end-if
 
 #ifdef EXCISE_DEDUCTION       
    print 'Total Excise Taxes in FIT    = '  (+1,20)
    print #excise_deduction_hash             () edit 99,999,999,999.99mi
 #endif
  
 #ifdef GENERATE_HISTORY_TABLE
   print 'History Table Info'               (+2,1) {PRINT_HIGHLIGHT}
   print 'Extract History Table: {HISTORY_TABLE}'                       (+1,10)
   print '  Number of Bypassed records (B) added to history table   = ' (+1,10)
   print #Bypassed_inserts () edit 9,999,999
   print '  Taxes Bypassed written to table                         = ' (+1,10)
   print #Bypassed_taxes_inserts () edit 99,999,999,999.99mi
 
   print '  Number of Processed records (T) added to history table  = ' (+1,10)
   print #Transmit_inserts () edit 9,999,999
   print '  Taxes processed written to table                        = ' (+1,10)
   print #Transmit_taxes_inserts () edit 99,999,999,999.99mi
 #endif
 
 #ifdef LOG_ADJ_HISTORY_TABLE
   print 'Tax Balance Adjustment Info'      (+2,1) {PRINT_HIGHLIGHT}
   print 'Extract Balance Adjustment Table: {LOG_ADJ_HISTORY_TABLE}'    (+1,10)
   print '  Number of Bal Adj. records added to history table       = ' (+1,10)
   print #Tax_baladj_inserts_count                                      () edit 999,999
   print '  Tax Adjustments written to table                        = ' (+1,10)
   print #Tax_baladj_inserts                                            () edit 99,999,999,999.99mi
   print '  Taxable Wage Adjustments written to table               = ' (+1,10)
   print #Txgrs_baladj_inserts                                          () edit 99,999,999,999.99mi
   show  'Number of records added to {LOG_ADJ_HISTORY_TABLE} = ' #Tax_baladj_inserts_count
 
   #ifdef GET_BALANCE_ADJUSTMENTS
    print 'Balance Adjustment logic enabled.'       (+2,10)
    #ifdef EMPLID_BALANCE_ADJUSTMENTS
     print 'Balance Adjustments for employees paid during the run_id included.'       (+1,10)
    #endif
    #ifdef COMPANY_BALANCE_ADJUSTMENTS
     print 'Balance Adjustments for Companies in this run_id included.'       (+1,10)
    #endif
    #ifdef SWEEP_BALANCE_ADJUSTMENTS
     print 'SWEEP of ALL Balance Adjustments included.'       (+1,10)
     print '  For Year and Qtr: '                             ()
     print #sweep_year                                        ()
     print ', '                                               () edit 9999
     print #sweep_qtr                                         () edit 9
     #ifdef SWEEP_CURRENT_QUARTER
      print '  (Using Current Quarter)'                       ()
     #endif
     #ifdef SWEEP_RUNDATE_QUARTER
      print '  (Using SWEEP_RUNDATE_QUARTER'                  ()
     #endif
     #ifdef TBA_LIVE_YEAR
      print ', Starting in {TBA_LIVE_YEAR}' ()
     #endif
     #ifdef TBA_LIVE_QTR
      print ', Q{TBA_LIVE_QTR}.'            ()
     #endif
     #ifdef USE_CALENDAR_CHECK_DATE_FOR_TBAs                 
      print 'Setting TBA liability date to Check Date from Calendar' (+1,10)
     #endif
     #ifdef PROCESS_TBAs_for_COMPANIES_IN_CALENDAR_ONLY                 
      print 'Including TBAs for companies in Calendar only' (+1,10)
     #endif


#ifdef SUBTOTAL_TBAs
      print 'SUBTOTAL_TBAs' (+1,10)
     #endif
     #ifdef SWEEP_BALANCE_ADJUSTMENTS_TAXES_ONLY
      print 'SWEEP_BALANCE_ADJUSTMENTS_TAXES_ONLY' (+1,10)
     #endif
    #endif
   #else
    print 'Balance Adjustments logic not enabled.'    (+1,10)
   #endif
 
#endif
 
 
 #if {Periodic_extract_specs} >= '3.00'  !ADP
  if $adp_format = 't'
   let $extract_mode = 'P'
   if rtrim($Header_rec_compid,' ') <> ''
 
     #ifdef PAYGROUP_ROLLUP_EXTRACT
       do Output-PAYGROUP_ROLLUP_EXTRACT  !in adp303p.sqc
     #endif
     do Write-Company-Trailer-Rec
 
   end-if
   if #reccnt > 0
     do Write-File-Trailer-Rec
   else
    show 'No Data records written to file...'
    #if {SITE_ID} <> 'YRC1'   !1/15/08
      do Write-File-Trailer-Rec
    #endif
   end-if
   end-if
 #endif
 
 #ifdef FORCE_FILE_HEADER_AND_TRAILER  !make sure we have at least a header and trailer
   show 'FORCE_FILE_HEADER_AND_TRAILER, forcing File headers'
   do Write-File-Header-Rec             !these procedures check to make sure only one X and F record is written
   do Write-File-Trailer-Rec
 #endif
     
 !Validate report and extract file match
 !---------------------------------------
 print 'Extract datafile Validation Section' (+2,1) {PRINT_HIGHLIGHT}
 move $Filename to $Verify_Filename
 close 1  !closes extract file
 
 do Sum-Periodic-Extract-Data
 if #filestat = 0
  let #Taxes_going_to_ProBusiness = #TOTAL_PBZPER_TAXES
 
  #ifdef CANADA_TOO
   let #TOTAL_PBZPER_TAXES_US_AND_CANADA = #TOTAL_PBZPER_TAXES + #Hash_Cur_Total_Tax_can
  #else
   let #TOTAL_PBZPER_TAXES_US_AND_CANADA = #TOTAL_PBZPER_TAXES
  #endif
 
  if round(#Hash_Total_Tax,2) <> round(#TOTAL_PBZPER_TAXES_US_AND_CANADA,2)
 
   show 'ERROR: Taxes in Extract    ' #TOTAL_PBZPER_TAXES_US_AND_CANADA
   show '       #TOTAL_PBZPER_TAXES ' #TOTAL_PBZPER_TAXES 
   show '   #Hash_Cur_Total_Tax_can ' #Hash_Cur_Total_Tax_can
   show '       Do not match Report ' #Hash_Total_Tax
 
 
   print 'ERROR: Taxes in Extract    ' (+2,10)
   print #TOTAL_PBZPER_TAXES_US_AND_CANADA () edit 999,999,999.99mi
   print '       Do not match Report ' (+1,10)
   print #Hash_Total_Tax               () edit 999,999,999.99mi
 
  else
   show  'Validation OK.  Extract matches Report.'
   print 'Validation OK.  Extract matches Report.' (+2,10)
  end-if
 end-if
 
 if round(#Regent_tax_hash_total,2) <> 0
   show 'Total Regent taxes ' #Regent_tax_hash_total edit 999,999,999.99mi
   print 'Total Regent taxes         ' (+2,10)
   print #Regent_tax_hash_total        () edit 999,999,999.99mi
 end-if
 
 print 'Versions and Configuration and File Output Section' (+2,1) {PRINT_HIGHLIGHT}
 print 'Program Versions, Releases, and Output Files.' (+1,1) {PRINT_HIGHLIGHT}
 print  'Extract Release Version: ' (+1,10)
 print  $Release_Version            ()
 print  'SQR Program Version:     ' (+1,10)
 print  '{Program_Version}        ' ()
 
 print  'adp303.sqc Version:      ' (+1,10)
 print  '{adp303_version}         ' ()
 print  'adp303p.sqc Version:     ' (+1,10)
 print  '{adp303p_version}        ' ()
 print  'adpq210.sqc Version:     ' (+1,10)
 print  '{adpq210_version}        ' ()
 
 print  '    (Review Trace file for additional SQC versions)' ()
 
 print 'Extract Specifications : ' (+2,10)
 print '{Periodic_extract_specs}'  ()
 
 #ifdef PAYGROUP_ROLLUP
  print 'Paygroup Rollup Enabled.'            (+1,10)
 #else
  print 'Paygroup Level Detail (No Rollup).'  (+1,10)
 #endif
 
 #ifdef USE_TEMP_TABLE_FOR_OUTPUT
  print  'Temp Table (TF_PBZDOUT_D) used to resort output'     (+1,10)
 #endif
 
 
 #ifdef EXCEL_FIXED_PERIODIC_FILENAME
 print  'Excel Data File:        ' (+1,10)
 print  $Excel_Filename            ()
 #endif
 
 #ifdef CANADA_TOO
 #if {SITE_ID} <> 'PLP1'
  print  'Canada Data File:        ' (+1,10)
  print  $Canada_Filename            ()
  print '  <---- send THIS file to ADP Canada' ()
 #endif
 #endif
 
 #ifdef GENERATE_EMPLOYEE_DETAIL
   print 'Extract Details:         ' (+1,10)
   print $Details_FileName           ()
 #endif
 
 #ifdef GENERATE_SUBTOTAL_REPORT
   print 'Extract Subtotals:       ' (+1,10)
   print $RptFilename                ()
 #endif
 
 #ifdef GENERATE_PROBUSINESS_LAYOUT_ALWAYS
   print 'Extract ProBiz format:   ' (+1,10)
   print $ProFilename                ()
 #endif
 
 #ifdef STANDARD_FTP
   print 'Automated FTP Enabled.  Files will be sent now.' (+2,10)
   print 'Verify transmission with SQR Completion Status.' (+1,10)
   print 'Also, verify with transmission confirmation from ADP Employment Tax.' (+1,10)
 #endif
 
 
 #ifdef STANDARD_FTS
   print 'Automated FTS Enabled.  Files will be sent now.' (+2,10)
   print 'Verify transmission with SQR Completion Status.' (+1,10)
   print 'Also, verify with transmission confirmation from ADP.' (+1,10)
 #endif
 
 print 'Extract Report:          '     (+2,10) 
 print $NewReportName                  ()
 print 'Extract Data File:       '     (+2,10) {PRINT_HIGHLIGHT}
 print $Filename                       () {PRINT_HIGHLIGHT}
 print '  <---- send THIS file to ADP' () {PRINT_HIGHLIGHT}
 
 #ifdef GL_TAX_CHECK_DATE_BREAKOUT
   do GL-print-totals
 #endif
 
 #ifdef ADP_RECAP_PERIODIC_REPORT 
  !if #TOTAL_PBZPER_TAXES <> 0
    do hash-taxes-recap-report
  !end-if
 #endif
 
   
   
end-procedure
 
#ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
 
!5/8/7, to sort the CheckDates array
!-----------------------------------
begin-procedure sort-check-dates
 
     !#define debug_sort
 
     do Get-Current-DateTime
     show  ' '
     show 'Starting sort-check-dates ' #num_check_dates ' --> ' $AsOfNow
 
 
     #ifdef MVS
 
      #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         let $company_zzz = '9999'
      #else
        #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
         let $company_zzz = '999999'
        #else
          #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
             let $company_zzz = '99999'
          #else
             let $company_zzz = '999'
          #endif
        #endif
      #endif 
 
      let $paygroup_zzz = '999'
      let $busunit_zzz = '99999'
      let $date_zzz    = '99999999'
      let $taxcode     = '999999999999999'
 
     #else
      #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         let $company_zzz = 'ZZZZ'
      #else
        #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
          let $company_zzz = 'ZZZZZZ'
        #else
          #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
             let $company_zzz = 'ZZZZZ'
          #else
            let $company_zzz = 'ZZZ'
          #endif
        #endif
      #endif 
 
      let $paygroup_zzz = 'ZZZ'
      let $busunit_zzz = 'ZZZZZ'
      let $date_zzz    = 'ZZZZZZZZ'
      let $taxcode     = 'ZZZZZZZZZZZZZZZ'
 
     #endif
 
     let #i = 0
     while (#i < #num_check_dates)
 
        let #j = #i
        let $sorttest = $company_zzz || $paygroup_zzz || $date_zzz || $taxcode_zzz
        let #nextinx = 0
 
        while (#j < #num_check_dates)
  
          #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
            get $cp from CheckDates(#j) ADP_Compid
          #else
            #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
              get $cp from CheckDates(#j) SRC_BANK_ID
              #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
                get $cp from CheckDates(#j) BUSINESS_UNIT
              #else
                 get $cp from CheckDates(#j) Compid
              #endif
            #endif
          #endif
 
          get $py from CheckDates(#j) PaygroupID
          get $dt from CheckDates(#j) Check_Dt
          get $tx from CheckDates(#j) Taxcode
          let $sortfield = $cp || $py || $dt || $tx        !sort by company, paygroup, check_date and taxcode
 
          if ($sortfield < $sorttest)
           let #nextinx = #j
           move $sortfield to $sorttest
          end-if
 
          add 1 to #j
 
        end-while
 
        !save the current i'th entry
        !---------------------------
        get $ADP_Compid      -
            $SRC_BANK_ID     -
            $Business_unit   -
            #Fein            -
            $CompId          -
            $PaygroupId      -
            $Check_Dt        -
            #Taxes           -
            #Txgrs           -
            #Nlgrs           -
            #EE_Count        -
            $taxcd           -
         from CheckDates(#i)  -
            ADP_Compid        -
            SRC_BANK_ID       -
            BUSINESS_UNIT     -
            Fein              -
            CompID            -
            PaygroupID        -
            Check_Dt          -
            Taxes             -
            Txgrs             -
            Nlgrs             -
            EE_Count          -
            Taxcode
      
      
         put $ADP_Compid      -
            #Fein            -
            $SRC_BANK_ID     -
            $Business_Unit   -
            $CompId          -
            $PaygroupId      -
            $Check_Dt        -
            #Taxes           -
            #Txgrs           -
            #Nlgrs           -
            #EE_Count        -
            $taxcd           -
         into CheckDates(#num_check_dates)  -
            ADP_Compid        -
            Fein              -
            SRC_BANK_ID       -
            BUSINESS_UNIT     -
            CompID            -
            PaygroupID        -
            Check_Dt          -
            Taxes             -
            Txgrs             -
            Nlgrs             -
            EE_Count          -
            Taxcode
      
        !replace it with the next lowest
        !-------------------------------
        get $ADP_Compid      -
            #Fein            -
            $SRC_BANK_ID     -
            $Business_Unit   -
            $CompId          -
            $PaygroupId      -
            $Check_Dt        -
            #Taxes           -
            #Txgrs           -
            #Nlgrs           -
            #EE_Count        -
            $taxcd           -
         from CheckDates(#nextinx)  -
            ADP_Compid        -
            Fein              -
            SRC_BANK_ID       -
            BUSINESS_UNIT     -
            CompID            -
            PaygroupID        -
            Check_Dt          -
            Taxes             -
            Txgrs             -
            Nlgrs             -
            EE_Count          -
            Taxcode
      
      
         put $ADP_Compid      -
            #Fein            -
            $SRC_BANK_ID     -
            $Business_Unit   -
            $CompId          -
            $PaygroupId      -
            $Check_Dt        -
            #Taxes           -
            #Txgrs           -
            #Nlgrs           -
            #EE_Count        -
            $taxcd           -
         into CheckDates(#i)  -
            ADP_Compid        -
            Fein              -
            SRC_BANK_ID       -
            BUSINESS_UNIT     -
            CompID            -
            PaygroupID        -
            Check_Dt          -
            Taxes             -
            Txgrs             -
            Nlgrs             -
            EE_Count          -
            Taxcode
 
      
        !move the original i'th entry into the array's 'nextinx' location
        !--------------------------------------------------------------------------
        get $ADP_Compid      -
            #Fein            -
            $SRC_BANK_ID     -
            $Business_Unit   -
            $CompId          -
            $PaygroupId      -
            $Check_Dt        -
            #Taxes           -
            #Txgrs           -
            #Nlgrs           -
            #EE_Count        -
            $taxcd           -
         from CheckDates(#num_check_dates)  -
            ADP_Compid        -
            Fein              -
            SRC_BANK_ID       -
            BUSINESS_UNIT     -
            CompID            -
            PaygroupID        -
            Check_Dt          -
            Taxes             -
            Txgrs             -
            Nlgrs             -
            EE_Count          -
            Taxcode
      
      
         put $ADP_Compid      -
            #Fein            -
            $SRC_BANK_ID     -
            $Business_Unit   -
            $CompId          -
            $PaygroupId      -
            $Check_Dt        -
            #Taxes           -
            #Txgrs           -
            #Nlgrs           -
            #EE_Count        -
            $taxcd           -
         into CheckDates(#nextinx)  -
            ADP_Compid        -
            Fein              -
            SRC_BANK_ID       -
            BUSINESS_UNIT     -
            CompID            -
            PaygroupID        -
            Check_Dt          -
            Taxes             -
            Txgrs             -
            Nlgrs             -
            EE_Count          -
            Taxcode
 
      
        add 1 to #i
 
      end-while
 
     do Get-Current-DateTime
     show 'Ending sort-check-dates ' #num_check_dates ' --> ' $AsofNow
     show  ' '
 
 
end-procedure
 
#endif
 
 
begin-procedure Hash-Check-Date-Breakout
 
#ifdef FULL_PRINT_WAGE_FORMAT
   #define PRINT2_FORMAT 9999999999999.99mi
#else
   #define PRINT2_FORMAT 9,999,999,999.99mi
#endif
 
 
#ifndef ADP_COMPID_EXTRACT_STRIPPED_REPORT
 
 #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
    do Sort-Check-Dates
 #endif
 
 #ifdef HOLD_CREDITS
   do Print-Credits
 #endif
 
 let #header_type = 1
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Check Date Summary'
 
  #ifdef GENERATE_SUBTOTAL_REPORT
 
    let $RptFilename = $Folder || 'periodic.txt'
    let $FTP_RptFilename = 'periodic.txt'
 
    #if {SITE_ID} = 'ANC1'
      let $RptFilename = $Folder || 'pbzper_' || rtrim($prcs_process_instance,' ') || '.txt'
    #endif
 
    #if {SITE_ID} = 'PFZ1'
      let $RptFilename = getenv ('PBZPERA_SUMMARY')
    #endif
 
    !New Default filenaming conventions
    !----------------------------------
    #ifdef STANDARD_EXTRACT_NAME_CONVENTION
     let $RptFilename = $Folder || $Filename_prefix || '.txt'
     let $FTP_RptFilename = $Filename_prefix || '.txt'
    #endif
 
    display 'Creating SubTotal Report File...' noline
    display $RptFilename
 
    open $RptFilename as 5 for-writing record=132:vary status=#filestat
    if #filestat = -1
         display ' '
         display '*** Error on SubTotal Report File Open ***'
         display $RptFilename
         display ' '
         stop
     else
         show 'File Created.'
     end-if
 
     write 5 FROM $ReportTitle
     write 5 FROM ' '
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      #if {SITE_ID} = 'CZB1'
       write 5 FROM   'Rollup Comp    Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'
      #else
       write 5 FROM   'ADP Compid     Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'
      #endif   
     #ELSE
       #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
         write 5 FROM   'SRC_BANK_ID    Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'
       #else
          #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
	    write 5 FROM   'Bus-Unit       Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'
          #else
            write 5 FROM   'Fed-Ein        Company  Paygroup  Check-Date             Taxes         Taxable-Wages        Gross-Wages'
          #endif
       #endif
     #ENDIF
     write 5 FROM   '---------      -------  --------  ----------             -----         -------------        -----------'
     write 5 FROM   ' '
 
  #endif
 
  let #prior_fein = 0
  let $prior_ADP_Compid = ''
  let $comp_date = ''
  let $prior_comp_date = ''
  let $prior_SRC_BANK_ID = ''
  let $prior_Business_unit = ''
  
  let #i = 0
  while (#i < #num_check_dates)
   get $ADP_Compid      -
       $SRC_BANK_ID     -
       $Business_Unit   -
       #Fein            -
       $CompId          -
       $PaygroupId      -
       $Check_Dt        -
       #Taxes           -
       #Txgrs           -
       #Nlgrs           -
       #EE_Count        -
       $taxcd           -
   from CheckDates(#i)  -
      ADP_Compid        -
      SRC_BANK_ID       -
      BUSINESS_UNIT     -
      Fein              -
      CompID            -
      PaygroupID        -
      Check_Dt          -
      Taxes             -
      Txgrs             -
      Nlgrs             -
      EE_Count          -
      Taxcode
 
!   #ifdef debug_sort
     show #i ' Hash-Check-Date-Breakout --> ' $ADP_Compid  '-' $SRC_BANK_ID '-' $Business_Unit '-' $CompId  '-' $PaygroupId   '-' $Check_Dt  '-' $taxcd '=' #Taxes
!   #endif


   do Convert-To-DTU-Date($Check_Dt, $Check_Dt_DTU)
 
   #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
 
      #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         let $comp_date = $ADP_Compid || ' ' || $PaygroupId || ' ' || $Check_dt_DTU
      #else
        #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
         let $comp_date = $SRC_BANK_ID || ' ' || $PaygroupId || ' ' || $Check_dt_DTU
        #else
          #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
             let $comp_date = $Business_Unit || ' ' || $PaygroupId || ' ' || $Check_dt_DTU
          #else
             let $comp_date = $Compid || ' ' || $PaygroupId || ' ' || $Check_dt_DTU
          #endif
        #endif
      #endif
      
      if $comp_date <> $prior_comp_date
       if $prior_comp_date <> ''
 
         print 'Liability Date  --> '           (+1,1)
         print $prior_comp_date                 ()
 
         Print #Check_date_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #Check_date_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}    
         Print #Check_date_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
         let #Check_date_SubTotal_Taxes = 0
         let #Check_date_SubTotal_Txgrs = 0
         let #Check_date_SubTotal_Nlgrs = 0
 
       end-if
      
       let $prior_comp_date = $comp_date
    
      end-if
 
      Add #Taxes    to #Check_date_SubTotal_Taxes
      Add #Txgrs    to #Check_date_SubTotal_Txgrs
      Add #Nlgrs    to #Check_date_SubTotal_Nlgrs
 
   #endif
   
 
    #ifdef SUBTOTAL_FEIN
 
    if #Fein <> #Prior_FEIN
      if #Prior_FEIN <> 0
 
         let $Fein = translate(edit(#Prior_Fein,'999999999'),' 0123456789','00123456789')
         print $Fein             (+1,1) edit  xx-xxxxxxx
         print ' Totals --> '    ()
 
         Print #fein_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #fein_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #fein_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
         let #fein_SubTotal_Taxes = 0
         let #fein_SubTotal_Txgrs = 0
         let #fein_SubTotal_Nlgrs = 0
 
      end-if
      let #Prior_Fein = #Fein
    end-if
 
    Add #Taxes    to #fein_SubTotal_Taxes
    Add #Txgrs    to #fein_SubTotal_Txgrs
    Add #Nlgrs    to #fein_SubTotal_Nlgrs
 
   #endif
 
 
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
 
    if $ADP_Compid <> $prior_ADP_Compid
      if $prior_ADP_Compid <> ''
 
         print $prior_ADP_Compid (+1,1)
         print ' Totals --> '    ()
 
         Print #ADP_Compid_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #ADP_Compid_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #ADP_Compid_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
         let #ADP_Compid_SubTotal_Taxes = 0
         let #ADP_Compid_SubTotal_Txgrs = 0
         let #ADP_Compid_SubTotal_Nlgrs = 0
 
      end-if
      let $prior_ADP_Compid = rtrim($ADP_Compid,' ')
    end-if
 
    Add #Taxes    to #ADP_Compid_SubTotal_Taxes
    Add #Txgrs    to #ADP_Compid_SubTotal_Txgrs
    Add #Nlgrs    to #ADP_Compid_SubTotal_Nlgrs
 
   #endif
 
   #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
 
    if $SRC_BANK_ID <> $prior_SRC_BANK_ID
      if $prior_SRC_BANK_ID <> ''
 
         print $prior_SRC_BANK_ID (+1,1)
         print ' Totals --> '    ()
 
         Print #SRC_BANK_ID_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #SRC_BANK_ID_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #SRC_BANK_ID_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
         let #SRC_BANK_ID_SubTotal_Taxes = 0
         let #SRC_BANK_ID_SubTotal_Txgrs = 0
         let #SRC_BANK_ID_SubTotal_Nlgrs = 0
 
      end-if
      let $prior_SRC_BANK_ID = rtrim($SRC_BANK_ID,' ')
    end-if
 
    Add #Taxes    to #SRC_BANK_ID_SubTotal_Taxes
    Add #Txgrs    to #SRC_BANK_ID_SubTotal_Txgrs
    Add #Nlgrs    to #SRC_BANK_ID_SubTotal_Nlgrs
 
   #endif
 
 
    #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
  
     if $Business_Unit <> $Prior_Business_Unit
       if $Prior_Business_Unit <> ''
  
          print $Prior_Business_Unit (+1,1)
          print ' Totals --> '    ()
  
          Print #Business_Unit_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
          Print #Business_Unit_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
          Print #Business_Unit_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
          Print ' ' (+1,1)
  
          let #Business_Unit_SubTotal_Taxes = 0
          let #Business_Unit_SubTotal_Txgrs = 0
          let #Business_Unit_SubTotal_Nlgrs = 0
  
       end-if
       let $Prior_Business_Unit = rtrim($Business_Unit,' ')
     end-if
  
     Add #Taxes    to #Business_Unit_SubTotal_Taxes
     Add #Txgrs    to #Business_Unit_SubTotal_Txgrs
     Add #Nlgrs    to #Business_Unit_SubTotal_Nlgrs
  
    #endif
 
 
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      if rtrim($ADP_Compid,' ') <> ''
        print $ADP_Compid (+1,1)
      else
        print '          '      (+1,1)
      end-if
   #else
        #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
          if rtrim($SRC_BANK_ID,' ') <> ''
            print $SRC_BANK_ID (+1,1)
          else
            print '          '      (+1,1)
          end-if
        #else
          #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
            if rtrim($Business_Unit,' ') <> ''
              print $Business_Unit (+1,1)
            else
              print '          '      (+1,1)
            end-if
          #else
            if #Fein <> 0
              let $Fein = translate(edit(#Fein,'999999999'),' 0123456789','00123456789')
              print $Fein             (+1,1) edit  xx-xxxxxxx
            else
              print '          '      (+1,1)
            end-if
          #endif
        #endif
   #endif
 
   !----------------------------------------------------------------------
 
   print $CompId           (0,16)
   print $PaygroupId       (0,25)
   print $Check_Dt_DTU     (0,35)
   Print #Taxes            (0,47) edit  {PRINT2_FORMAT}
   Print #Txgrs            (0,69) edit  {PRINT2_FORMAT}
   Print #Nlgrs            (0,88) edit  {PRINT2_FORMAT}
 
   #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
   Print $taxcd            (0,113) 
   #endif
   
   Add #Taxes    to #SubTotal_Taxes
   Add #Txgrs    to #SubTotal_Txgrs
   Add #Nlgrs    to #SubTotal_Nlgrs
   Add #EE_Count to #SubTotal_EE_Count
 
 
   !-------------------------------------------------------------------------------------------
   !7/6/01 option to generate a trailer record into the extract for auto-transporter validation
   !       this would come in quite handy in the case of .pdf files... which are hard to autovalidate
   !6/4/08 modified to not generate the long winded taxcode totals
   !-------------------------------------------------------------------------------------------
   #ifdef GENERATE_SUBTOTAL_REPORT
 
    let $comp_date_t = $Compid || ' ' || $PaygroupId || ' ' || $Check_dt_DTU
    
    if $comp_date_t <> $prior_comp_date_t
 
      if $prior_comp_date_t <> ''
 
        let #T  = #Taxes_t
        do Format-Number(#T,$Taxes, '9999999999999999.99mi')
        let #T  = #Txgrs_t
        do Format-Number(#T,$Txgrs, '9999999999999999.99mi')
        let #T  = #Nlgrs_t
        do Format-Number(#T,$Nlgrs, '9999999999999999.99mi')
 
        Write 5 FROM  $fein_t:15
                      $comp_t:9
                      $pay_t:10
                      $chkdt_t:10
                      $Taxes:20              ! 47-66
                      $Txgrs:20              ! 67-86
                      $Nlgrs:20              !87-106
      end-if
      
      move 0 to #Taxes_t
      move 0 to #Txgrs_t
      move 0 to #Nlgrs_t
   
      do Format-Number(#FEIN, $F, '099999999')
      move $F to $FEIN_t xx-xxxxxxx
 
      let $prior_comp_date_t = $comp_date_t
      let $comp_t  = $Compid
      let $pay_t   = $PaygroupId
      let $chkdt_t = $Check_dt_DTU
 
     end-if
 
     Add #Taxes    to #Taxes_t
     Add #Txgrs    to #Txgrs_t
     Add #Nlgrs    to #Nlgrs_t
   #endif
 
 
   Add 1 to #i
 
  end-while
 
  #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
      if $Prior_comp_date <> ''
 
         print $Prior_ADP_Check_date (+1,1)
         print ' Liability Date  --> '          ()
         print $prior_comp_date                 ()
 
         Print #Check_date_SubTotal_Taxes                   (0,47) edit  {PRINT2_FORMAT}
         Print #Check_date_Compid_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #Check_date_Compid_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
      end-if
  #endif
  
 
  #ifdef SUBTOTAL_FEIN
      if #Prior_FEIN <> 0
 
         let $Fein = translate(edit(#Prior_Fein,'999999999'),' 0123456789','00123456789')
         print $Fein             (+1,1) edit  xx-xxxxxxx
         print ' Totals --> '    ()
 
         Print #fein_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #fein_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #fein_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
      end-if
  #endif
 
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      if $Prior_ADP_Compid <> ''
 
         print $Prior_ADP_Compid (+1,1)
         print ' Totals --> '    ()
 
         Print #ADP_Compid_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #ADP_Compid_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #ADP_Compid_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
      end-if
  #endif
 
 
  #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
      if $Prior_SRC_BANK_ID <> ''
 
         print $Prior_SRC_BANK_ID (+1,1)
         print ' Totals --> '    ()
 
         Print #SRC_BANK_ID_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
         Print #SRC_BANK_ID_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
         Print #SRC_BANK_ID_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
         Print ' ' (+1,1)
 
      end-if
  #endif
 
  
   #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
       if $Prior_Business_Unit <> ''
  
          print $Prior_Business_Unit (+1,1)
          print ' Totals --> '    ()
  
          Print #Business_Unit_SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
          Print #Business_Unit_SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
          Print #Business_Unit_SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
          Print ' ' (+1,1)
  
       end-if
  #endif
  
   !6/4/08 modified to not generate the long winded taxcode totals
   !-------------------------------------------------------------------------------------------
   #ifdef GENERATE_SUBTOTAL_REPORT
 
      if $prior_comp_date_t <> ''
 
        let #T  = #Taxes_t
        do Format-Number(#T,$Taxes, '9999999999999999.99mi')
        let #T  = #Txgrs_t
        do Format-Number(#T,$Txgrs, '9999999999999999.99mi')
        let #T  = #Nlgrs_t
        do Format-Number(#T,$Nlgrs, '9999999999999999.99mi')
 
        Write 5 FROM  $fein_t:15
                      $comp_t:9
                      $pay_t:10
                      $chkdt_t:10
                      $Taxes:20              ! 47-66
                      $Txgrs:20              ! 67-86
                      $Nlgrs:20              !87-106
      end-if
 
   #endif
 
 
  print ' Grand Totals --> '       (+2,1)
 
  Print #SubTotal_Taxes            (0,47) edit  {PRINT2_FORMAT}
  Print #SubTotal_Txgrs            (0,69) edit  {PRINT2_FORMAT}
  Print #SubTotal_Nlgrs            (0,88) edit  {PRINT2_FORMAT}
  Print ' ' (+1,1)
  #ifdef USE_CHECK_DATE_FROM_CALENDAR_ALWAYS
   Print 'Using the Check Date fron the Pay Calendar for all checks' (+1,1)
   Print ' ' (+1,1)
  #endif
  
  #ifdef GENERATE_SUBTOTAL_REPORT
 
    let #T  = #SubTotal_Taxes
    do Format-Number(#T,$Taxes, '9999999999999999.99mi')
    let #T  = #SubTotal_Txgrs
    do Format-Number(#T,$Txgrs, '9999999999999999.99mi')
    let #T  = #SubTotal_Nlgrs
    do Format-Number(#T,$Nlgrs, '9999999999999999.99mi')
    do Format-Number(#SubTotal_EE_Count,$EE_Count, '999999')
 
    write 5 FROM ' '
    Write 5 FROM    'GrandTotals':44     ! 1-46
                    $Taxes:20            !47-66
                    $Txgrs:20            !67-86
                    $Nlgrs:20            !87-106
 
    write 5 FROM ' '
    write 5 FROM 'Extract Filename':40
                 $Filename:80
    write 5 FROM 'SubTotal Report Filename':40
                  $RptFilename:80
    write 5 FROM ' '
    write 5 FROM 'Extract Client ID':40
                 '{SITE_ID}':80
    write 5 FROM 'Extract Program Version':40
                 '{Program_Version}':80
 
    write 5 FROM ' '
 
    do Get-Current-DateTime
    write 5 FROM 'Report Created':40
	              $AsOfToday:15
	              ' ':1
	              $AsOfNow:15
    close 5
  #endif
 
  New-Page
 
#endif 
end-procedure
 
 
 
 
begin-procedure Hash-Taxes-Bypassed-Breakout
 
 #ifndef ADP_COMPID_EXTRACT_STRIPPED_REPORT
  let #header_type = 4
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Taxes Bypassed Summary'
 
  let #i = 0
  while (#i < #num_taxes_bypassed)
   get #Fein            -
       $CompId          -
       $PaygroupId      -
       $Check_Dt        -
       #Taxes           -
       #Txgrs           -
       #Nlgrs           -
       $Taxcode         -
   from TaxesBypassed(#i)  -
      Fein              -
      CompID            -
      PaygroupID        -
      Check_Dt          -
      Taxes             -
      Txgrs             -
      Nlgrs             -
      Taxcode
 
 
   do Convert-To-DTU-Date($Check_Dt, $Check_Dt_DTU)
 
   if #Fein <> 0
     let $Fein = translate(edit(#Fein,'999999999'),' 0123456789','00123456789')
     print $Fein             (+1,1) edit  xx-xxxxxxx
   else
     print '          '      (+1,1)
   end-if
 
   #ifdef CONDENSED_BYPASS_SUMMARY
    print $CompId           (0,16)
    Print #Taxes            (0,47) edit  999,999,999.99mi
    Print #Txgrs            (0,69) edit  999,999,999.99mi
    Print #Nlgrs            (0,88) edit  999,999,999.99mi
    print $Taxcode          (0,109)
   #else
    print $CompId           (0,16)
    print $PaygroupId       (0,25)
    print $Check_Dt_DTU     (0,35)
    Print #Taxes            (0,47) edit  999,999,999.99mi
    Print #Txgrs            (0,69) edit  999,999,999.99mi
    Print #Nlgrs            (0,88) edit  999,999,999.99mi
    print $Taxcode          (0,109)
   #endif
   
   #ifdef GENERATE_BYPASSED_REPORT
 
     do Format-Number(#Txgrs, $PT_TXGRS_CUR, '999999999999.99')
     do Format-Number(#Nlgrs, $PT_NLGRS_CUR, '999999999999.99')
     do Format-Number(#Taxes, $PT_TAX_CUR, '999999999999.99')
 
     !Company  Paygroup  Check-Date           Taxes   Taxable-Wages     Gross-Wages Taxcode
 
     Write 6 FROM $CompId:9
              $PaygroupId:10
            $Check_Dt_DTU:11
              $PT_TAX_CUR:16
            $PT_TXGRS_CUR:16
            $PT_NLGRS_CUR:16
                 $Taxcode:15
 
     #if {SITE_ID} ='KMT1'
        add #Txgrs     to #kTot_Bypass_Txgrs
        add #Nlgrs     to #kTot_Bypass_Nlgrs
        add #Taxes     to #kTot_Bypass_Tax
     #endif
     #if {SITE_ID} = 'SRC1'
        add #Txgrs     to #kTot_Bypass_Txgrs
        add #Nlgrs     to #kTot_Bypass_Nlgrs
        add #Taxes     to #kTot_Bypass_Tax
     #endif
 
   #endif
 
   Add 1 to #i
 
  end-while
 
  New-Page
 #endif
 
end-procedure
 
#ifdef ADP_RECAP_PERIODIC_REPORT
begin-procedure Hash-Taxes-recap-report
 
 New-Page
 
 #ifdef FULL_PRINT_WAGE_FORMAT
   #define PRINT2_FORMAT 9999999999999.99mi
 #else
   #define PRINT2_FORMAT 9,999,999,999.99mi
 #endif
 
  let #header_type = 24
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Periodic Recap Report'
 
  print ' ' (+1,1)
  
  let #i = 0
  let $prior_compid = ''
  while (#i < #num_check_dates)
 
     if #current-line > 56
       New-Page
     end-if
 
     get $CompId          -
       #Taxes           -
       #Txgrs           -
       #Nlgrs           -
     from CheckDates(#i)  -
       CompID            -
       Taxes             -
       Txgrs             -
       Nlgrs             
  
   if $prior_compid <> ''
     if $prior_compid <> $Compid
       Print $prior_compid                        (+1,16)
       Print #recap_SubTotal_Taxes_c              (0,47) edit  {PRINT2_FORMAT}
       Print #recap_SubTotal_Txgrs_c              (0,69) edit  {PRINT2_FORMAT}
       Print #recap_SubTotal_Nlgrs_c              (0,88) edit  {PRINT2_FORMAT}
       move 0 to #recap_SubTotal_Taxes_c
       move 0 to #recap_SubTotal_Txgrs_c
       move 0 to #recap_SubTotal_Nlgrs_c
     end-if
    end-if
    move $Compid to $prior_compid
   
    Add #Taxes    to #recap_SubTotal_Taxes_c
    Add #Txgrs    to #recap_SubTotal_Txgrs_c
    Add #Nlgrs    to #recap_SubTotal_Nlgrs_c
 
    Add #Taxes    to #recap_SubTotal_Taxes
    Add #Txgrs    to #recap_SubTotal_Txgrs
    Add #Nlgrs    to #recap_SubTotal_Nlgrs
   
   !----------------------------------------------------------------------
 
   Add 1 to #i
 
  end-while
 
  if $prior_compid <> ''
   Print $prior_compid                      (+1,16)
   Print #recap_SubTotal_Taxes_c            (0,47) edit  {PRINT2_FORMAT}
   Print #recap_SubTotal_Txgrs_c            (0,69) edit  {PRINT2_FORMAT}
   Print #recap_SubTotal_Nlgrs_c            (0,88) edit  {PRINT2_FORMAT}
  end-if
  
  print ' Grand Totals --> '                (+2,1)
 
  Print #recap_SubTotal_Taxes               (0,47) edit  {PRINT2_FORMAT}
  Print #recap_SubTotal_Txgrs               (0,69) edit  {PRINT2_FORMAT}
  Print #recap_SubTotal_Nlgrs               (0,88) edit  {PRINT2_FORMAT}
  Print ' ' (+1,1)
  
  
  print 'Summary for All Companies in this Periodic Run' (+2,1) {PRINT_HIGHLIGHT}
  #if {PERIODIC_REPORT_ID} = 'PBZPER'
   print ' RUN_ID: '  ()  {PRINT_HIGHLIGHT}
   print $RunID       ()  {PRINT_HIGHLIGHT}
  #endif
  
  print 'Extract Report:          '     (+2,1) 
  print $NewReportName                  ()
  print 'Extract Data File:       '     (+1,1) {PRINT_HIGHLIGHT}
  print $Filename                       ()     {PRINT_HIGHLIGHT}
  print '  <---- send THIS file to ADP' ()     {PRINT_HIGHLIGHT}
  
  New-Page
 
end-procedure
 
#endif
 
 
begin-procedure insert-cross-quarter-entry
 
   display 'Message: Payline CheckDate not in same Quarter as PayCalendar CheckDate'
   display ' Payline Emplid '          noline
   display $payline_emplid             noline
   display ' Payline Issue Date '      noline
   display $payline_check_dt           noline
   display ', PayCalendar CheckDate '  noline
   display $A_Check_Dt                 noline
   display ', Company '                noline
   display $payline_company
 
 
   put     $payline_company          -
           $payline_emplid           -
           &I.{pg}                   -
           &I.{ln}                   -
           &I.OFF_CYCLE              -
           &I.PAY_END_DT             -
           $PT_State                 -
           &PT.TAX_CLASS             -
           $PT_LOCALITY              -
           #Tax_Cur                  -
           $payline_check_dt         -
           $A_Check_Dt               -
           $Check_Reversal           -
     into CrossQtr(#Hash_check_cross_quarters)               -
           Company                   -
           Emplid                    -
           Page                      -
           Line                      -
           Off_cycle                 -
           Pay_end_dt                -
           State                     -
           Tax_class                 -
           Locality                  -
           Taxes                     -
           Check_dt                  -
           Calen_dt                  -
           Reversal
 
 
     add 1 to #Hash_check_cross_quarters
     add 1 to #Company_check_cross_quarters
 
 
end-procedure
 
begin-procedure Hash-Cross-Quarter-Breakout
 
 #ifndef ADP_COMPID_EXTRACT_STRIPPED_REPORT
  let #header_type = 8
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Cross Quarter Summary'
 
  let #i = 0
  while (#i < #Hash_check_cross_quarters)
 
   if #current-line > 56
     New-Page
   end-if
 
   get     $cmpy                     -
           $emplid                   -
           #page                     -
           #line                     -
           $off                      -
           $payend                   -
           $st                       -
           $tc                       -
           $loc                      -
           #tx                       -
           $chkdt                    -
           $caldt                    -
           $Reversal                 -
     from CrossQtr(#i)               -
           Company                   -
           Emplid                    -
           Page                      -
           Line                      -
           Off_cycle                 -
           Pay_end_dt                -
           State                     -
           Tax_class                 -
           Locality                  -
           Taxes                     -
           Check_dt                  -
           Calen_dt                  -
           Reversal
 
   print $cmpy                 (+1,1)
   print $emplid               (0,10)
   print #page                 (0,23) edit 99999
   print #line                 (0,29) edit 99999
   print $off                  (0,35)
   print $payend               (0,42)
   print $st                   (0,55)
   print $tc                   (0,58)
   print $loc                  (0,64)
   print #tx                   (0,77) edit  999999999999.99mi
   Print $chkdt                (0,96)
   print $caldt                (0,115)
   print $reversal             (0,134)
 
 
   Add 1 to #i
 
  end-while
 
  New-Page
 
 #endif
 
end-procedure
 
 
begin-procedure Log-EE-count
    
   let #i = 0
   let $found = 'f'
   while #i < #Log_EE_count
    get $s from State_EE_Count(#i) State
    if rtrim($s,' ') = rtrim($trimmed_state,' ')
      let $found = 't'
      break
    end-if
    add 1 to #i
   end-while
 
   let #f = #female_cnt
   let #m = #male_cnt
   
   if $found = 'f'
    if #Log_EE_count < {STATE_EE_COUNT_LIMIT}
     put   $Trimmed_State                             -
           #f                                         -
           #m                                         -
     into State_EE_Count(#Log_EE_count)               -
           State                                      -
           Female_Count                               -
           Male_Count                
     add 1 to #Log_EE_count
    end-if
   else
     array-add   #f                                 -
                 #m                                 -
     to State_EE_Count(#i)                          -
           Female_Count                             -
           Male_Count                
   end-if
 
end-procedure
 

begin-procedure EE-count-Breakout
 
 if #Log_EE_count > 0
   new-page                       ! commented out 8/20/10
 end-if
 
  print 'ADP Employment Tax, Periodic Extract. Associate Count (State) Summary' (+2,1)
  print '         State     Female Cnt    Male Cnt        Associate Cnt'  (+2,1)
  print '         -----     ----------    --------        -------------'  (+1,1)
 
  let #i = 0
 
  while (#i < #Log_EE_count)
  
      let #j = 0
      let $sorttest = 'ZZ'
      let #nextinx = 0
  
      while (#j < #Log_EE_count)
            get $s from State_EE_Count(#j) State
            if ($s < $sorttest)
             let #nextinx = #j
             move $s to $sorttest
            end-if
            add 1 to #j
      end-while
 
      get $s                  -
           #f                 -
           #m                 -
        from State_EE_Count(#nextinx)  -
           State               -
           Female_Count        -
           Male_Count
   
      put 'ZZ' into State_EE_Count(#nextinx) State       
      
      let #fm = #f + #m
      print $s                (+1,10)
      Print #f                (0,20) edit  999,999
      Print #m                (0,35) edit  999,999
      Print #fm               (0,50) edit  999,999
      Add 1 to #i
 
  end-while
 
  print ' Alabama Counts '     (+2,1)
  Print #alf_tot                (0,20) edit  999,999
  Print #alm_tot                (0,35) edit  999,999
  Print #alfm_tot               (0,50) edit  999,999
  print '  (Alabama (ALH) Withholding Tax Counts)' ()

  print ' Federal Counts '     (+1,1)
  Print #f_tot                (0,20) edit  999,999
  Print #m_tot                (0,35) edit  999,999
  Print #fm_tot               (0,50) edit  999,999
  print '  (Federal ($UH) Withholding Tax Counts)' ()
 
  add #fm_tot to #associate_count
  add #f_tot  to #associate_count_female
  add #m_tot  to #associate_count_male
 
  New-Page
 
  clear-array name=State_EE_Count
  let #Log_EE_count = 0
  let #header_type = 0
  let #f_tot = 0
  let #m_tot = 0
  let #fm_tot = 0
 
end-procedure
 
 
#ifdef BYPASS_FED_STOCK_OPTION_TAXES
 
begin-procedure Log-StockOption
 
   if #StockOptions_skipped_count < {StockOptions_limit}
     put   $Trimmed_company          -
           $payline_emplid           -
           #TAX_CUR                  -
           $Trimmed_Taxcode          -
     into StockOptions(#StockOptions_skipped_count)               -
           Company                   -
           Emplid                    -
           Taxes                     -
           Taxcode
   end-if
 
   !display 'Stock option. Fed taxes for emplid: ' noline
   !display $payline_emplid  noline
   !display ', taxcode '     noline
   !display $Trimmed_Taxcode noline
   !display ', Taxes '       noline
   !display #Tax_Cur
 
   Add #Tax_Cur to #Stock_option_tax_company
   Add #Tax_Cur to #Stock_option_tax_hash
 
   add 1 to #StockOptions_skipped_count
 
 
end-procedure
 
 
begin-procedure Hash-StockOptions-Breakout
 
  let #header_type = 9
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Stock Options (taxes skipped) Summary'
 
  let #i = 0
  while (#i < #StockOptions_skipped_count)
   get $CompId          -
       $E               -
       $Taxcd           -
       #Taxes           -
   from StockOptions(#i)  -
      Company             -
      Emplid              -
      Taxcode             -
      Taxes
 
   print $CompId           (+1,1)
   print $E                (0,10)
   print $Taxcd            (0,29)
   Print #Taxes            (0,49) edit  999,999,999,999.99mi
 
   if substr($Taxcd,1,2) = '$U'
      let $fchar = substr($Taxcd,3,1)
      if $fchar = 'H'
         add #Taxes to #Option_Total_UH
      end-if
      if $fchar = 'D'
         add #Taxes to #Option_Total_UD
      end-if
      if $fchar = 'E'
         add #Taxes to #Option_Total_UE
      end-if
      if $fchar = 'F'
         add #Taxes to #Option_Total_UF
      end-if
      if $fchar = 'Q'
         add #Taxes to #Option_Total_UQ
      end-if
      if $fchar = 'C'
         add #Taxes to #Option_Total_UC
      end-if
      if $fchar = 'U'
         add #Taxes to #Option_Total_UU
      end-if
   end-if
 
 
   Add 1 to #i
 
  end-while
 
 !new totals 4/18/02
 !------------------
 print 'Federal Stock Option Hash Totals'              (+2,1)
 print 'Total FIT      ($UH)         = '  (+1,20)
 print #Option_Total_UH                     () edit 99,999,999,999.99mi
 print 'Total OASDI-EE ($UD)         = '  (+1,20)
 print #Option_Total_UD                     () edit 99,999,999,999.99mi
 print 'Total OASDI-ER ($UE)         = '  (+1,20)
 print #Option_Total_UE                     () edit 99,999,999,999.99mi
 print 'Total MED-EE   ($UF)         = '  (+1,20)
 print #Option_Total_UF                     () edit 99,999,999,999.99mi
 print 'Total MED-ER   ($UQ)         = '  (+1,20)
 print #Option_Total_UQ                     () edit 99,999,999,999.99mi
 print 'Total EIC      ($UC / $EC)   = '  (+1,20)
 print #Option_Total_UC                     () edit 99,999,999,999.99mi
 print 'Total FUTA     ($UU)         = '  (+1,20)
 print #Option_Total_UU                     () edit 99,999,999,999.99mi
 
 
 if  round(#Stock_option_tax_hash,2) <> 0
   print 'Total taxes for stock        = '  (+1,20)
   print #Stock_option_tax_hash             () edit 99,999,999,999.99mi
 end-if
 
 New-Page
 
end-procedure
 
#endif
 
 
 
begin-procedure Sum-Periodic-Extract-Data
 
   let #TOTAL_PBZPER_TAXES = 0
 
   if $adp_format = 't'
     open $Verify_Filename as 1 for-reading record=187:vary status=#filestat
   else
     open $Verify_Filename as 1 for-reading record=250:vary status=#filestat
   end-if
 
 
   if #filestat != 0
     show 'Error reading Periodic Extract file: '$Verify_Filename
   else
   
    !extract the current tax amounts from the periodic.dat file
    !----------------------------------------------------------
    while 1
 
      if $adp_format = 't'
       read 1 into $Pbz_Record:250
      else
        read 1 into $Pbz_Record:187
      end-if
 
      if #end-file
        break
      else
 
     if $adp_format = 't'
       !ignore header and trailers
       !--------------------------
       let $rtype = substr($pbz_record,1,1)
       if ($rtype = 'D')
        do Add-Periodic-Taxes
       end-if
     else
       do Add-Periodic-Taxes
     end-if
 
    end-if
   
   end-while
 
   do Format-Number(#TOTAL_PBZPER_TAXES, $pbzout, '99,999,999,999.99mi')
 
   display 'Verifying... Total Taxes Withheld in Extract file: ' noline
   display $Verify_Filename                         noline
   display ' = '                                    noline
   display $pbzout
 
   !print 'Verifying... Total Taxes Withheld in File: ' (+2,1)
   !print $Verify_Filename ()
   !print ' = '            ()
   !print $pbzout          ()
 
   close 1
  end-if
  
end-procedure
 
 
 
begin-procedure Add-Periodic-Taxes
 
  if $adp_format = 't'
   let $Pbz_tax = substr($Pbz_Record,18,15)
   move $Pbz_tax to #Pbz_tax
   let $Pbz_sign = substr($Pbz_Record,33,1)
  else
   let $Pbz_tax = substr($Pbz_Record,38,15)
   move $Pbz_tax to #Pbz_tax
   let $Pbz_sign = substr($Pbz_Record,53,1)
  end-if
 
 
  if rtrim($Pbz_sign,' ') = '-'
     let #Pbz_tax = -#Pbz_tax
  end-if
 
  !stick in the decimal pt
  !-----------------------
  let #Pbz_tax = #Pbz_tax / 100
  Add #Pbz_Tax to #TOTAL_PBZPER_TAXES
 
 
end-procedure
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Print-TaxBalance-Recap                                     !
! Descr:     Prints a Recap of  Tax Balances                            !
!            If #Tot = 0, we are recapping PAYGROUP data                !
!            If #Tot = 1, we are recapping COMPANY Totals               !
!            If #Tot = 2, we are recapping FEIN Totals                  !
!            If #Tot = 3, we are recapping Grand Totals                 !
!---------------------------------------------------------------------  !
begin-procedure Print-TaxBalance-Recap
 
  let #L1    = 0
  let #next_state_inx = 0
  let $Processed_Feds = 'f'  !we need to process the federal taxes first
  let #CoPaid = 0
  let $Prior_State = ' '
  
  show ' '
  show 'Print-TaxBalance-Recap: ReportID = ' $ReportID ', Tot = ' #tot ', Last_TaxTotal_Cnt = ' #Last_TaxTotal_Cnt
 
  if #Tot = 0
    show 'Printing TaxBalance Recap for Paygroup ' $Current_Paygroup
  end-if
 
  if #Tot = 1
    show 'Printing TaxBalance Recap for Company ' $Current_Company
    show '  Number of Taxes = ' #Last_TaxTotal_Cnt
   end-if
 
  if #Tot = 2
    show 'Printing TaxBalance Recap for Fein ' $Current_Fein
  end-if
 
  if #Tot = 3
    show 'Printing Grand Totals, Total Number of Taxes in Run = ' #Last_TaxTotal_Cnt
  end-if
 
  !show 'Printing data for Company in Country: ' $Current_Country
 
  let $First_char_for_fed_codes = '$'
  #ifdef CANADA_TOO
   if rtrim($Current_Country,' ') = 'CAN'
    let $First_char_for_fed_codes = 'C'
   end-if
  #endif
 
  while #L1 <= #Last_TaxTotal_Cnt   !8/13 change from <
 
   if $Processed_Feds = 't'
 
     #ifdef CANADA_TOO
      if rtrim($Current_Country,' ') = 'CAN'
        do Get-Next-Province
      else
        do Get-Next-State
      end-if
     #else
       do Get-Next-State
     #endif
 
     Add 1 to #next_state_inx
 
     #ifdef debug_pdf
       show 'Next_State  = ' $Next_State
     #endif
 
   end-if
 
   let #ii = 0
 
   while #ii <= #Last_TaxTotal_Cnt    !8/13 change from <
 
    Add 1 to #ii
    get $Test_State from TaxTotal(#ii) TaxTotal_State
 
    #ifdef debug_pdf
      show ''
      show '#ii             ' #ii
      show '  $Test_State   ' $Test_State
    #endif
 
    if ($Processed_Feds = 'f')
      let $First_Char_St = substr($Test_State,1,1)
    end-if
 
    if (($Processed_Feds = 't') AND ($Test_State = $Next_State)) OR
       (($Processed_Feds = 't') AND ($Next_State = '**')) OR
       (($Processed_Feds = 'f') AND ($First_Char_St = $First_char_for_fed_codes))
 
     Add 1 to #L1
 
      get $TaxTotal_State         -
      $TaxTotal_Locality          -
      $TaxTotal_Resident          -
      $TaxTotal_Tax_Class         -
      #TaxTotal_Nlgrs_Cur         -
      #TaxTotal_Txgrs_Cur         -
      #TaxTotal_Tax_Cur           -
      $TaxTotal_ER_Generated      -
      $TaxTotal_Canada            -
      from TaxTotal(#ii)           -
        TaxTotal_State            -
        TaxTotal_Locality         -
        TaxTotal_Resident         -
        TaxTotal_Tax_Class        -
        TaxTotal_Nlgrs_Cur (#Tot) -
        TaxTotal_Txgrs_Cur (#Tot) -
        TaxTotal_Tax_Cur   (#Tot) -
        TaxTotal_ER_Generated     -
        TaxTotal_Canada
 
 
     !do not print out a line of data unless we have either
     !taxes or taxable gross amounts not 0.
     !--------------------------------------------------------
     if (round(#TaxTotal_Txgrs_Cur,2) <> 0) or
        (round(#TaxTotal_Nlgrs_Cur,2) <> 0) or
        (round(#TaxTotal_Tax_Cur,2) <> 0)
 
      if #current-line > 56
        New-Page
      end-if
 
      let $Trimmed_State     = rtrim($TAXTOTAL_STATE,' ')
      let $Trimmed_Tax_Class = rtrim($TAXTOTAL_TAX_CLASS,' ')
      let $Trimmed_Locality  = rtrim($TAXTOTAL_LOCALITY,' ')
      let $Trimmed_Resident  = rtrim($TAXTOTAL_RESIDENT,' ')
      do Build-Taxcode
 
     if rtrim($TaxTotal_Canada,' ') = 'Y'
      do Generate-Canada-Taxcode-Description
      Print $Trimmed_State (+1,1,15)
     else
 
      if rtrim($Taxcode,' ') = '{FORM945P_Taxcode}' OR rtrim($Taxcode,' ') = '{FORM1042_Taxcode}'
        Print 'U.S.Fed Non-941 '            (+1,1)
      else
 
        let $State        = substr($TaxTotal_State,1,2)
        let $Save_Company = $Company
        let $Company      = $Current_Company
        do get-state-tax-data
        let $Company = $Save_Company
 
        if ($State <> $Prior_State)
 
          If $State = '$U' or $State = '$E'
            Print 'U.S. Federal '            (+1,1)
            if #tot <> 3
              Print $Current_FEIN            (0,17,10)
            end-if
          Else
            Print $StateName                 (+1,1,15)
            if (#tot <> 3)
              Print &EMPLOYER_ID_SWT         (0,17,11)  !10/1/04 changed from 10 long
            end-if
          end-if
 
          move $State to $Prior_State
 
        else
         Print ' '                            (+1,1)
        end-if     !if ($State <> $Prior_State)
      end-if     !if rtrim($Taxcode,' ') = '{FORM945P_Taxcode}'...
 
      move ' ' to $TaxClass_Descr
 
      if rtrim($Taxcode,' ') = '{FORM945P_Taxcode}'
        move '945P-FIT' to $TaxClass_Descr
      else
         if rtrim($Taxcode,' ') = '{FORM1042_Taxcode}'
           move '1042-FIT' to $TaxClass_Descr
         else
 
           if (length($TaxTotal_Tax_Class) = 1)
             do Get-XlatTable-Descr
           end-if
 
           let $Locality = substr($Trimmed_Locality,1,10)  !3/31/2011 from = $trimmed_locality (due to PA isue DB2)
 
           If $Locality <> ''
             move ' ' to $Localname
             move ' ' to $Localabbr
             move ' ' to $Localcnty
             move ' ' to $Locality_Abbrv
 
             do get-local-tax-data
             Print $TaxTotal_Locality      (0, 28, 7)
             Print $TaxTotal_Resident      (0,36,1)
 
             if $TaxTotal_ER_Generated = 't'
               Print 'Employer Paid Match'     (0,38,18)
             else
               #ifdef GETLCLDATA_751                      !7.51  (LocalAbbr changed names)
                 Print $Localname              (0,38,40)
                 Print $Localcnty              (0,78,20)
               #else
                 Print &LOCALITY_ABBRV         (0,38,9)
               #endif
             end-if  !$TaxTotal_ER_Generated = 't'
          end-if   !Locality <> ''
       end-if    !if rtrim($Taxcode,' ') = '{FORM1042_Taxcode}'
      end-if    !if rtrim($Taxcode,' ') = '{FORM945P_Taxcode}'
     end-if    !if $TaxTotal_Canada = 'Y'
 
    
     #ifdef FULL_PRINT_WAGE_FORMAT
        #define PRINT1_FORMAT 99999999999.99mi
     #else
        #define PRINT1_FORMAT 999,999,999.99mi
     #endif
 
     Print $Taxcode                         (0,99,20)
     Print $TaxClass_Descr                  (0,119,10)
     Print #TaxTotal_Txgrs_Cur              (0,130) edit  {PRINT1_FORMAT}
     Print #TaxTotal_Nlgrs_Cur              (0,146) edit  {PRINT1_FORMAT}
     Print #TaxTotal_Tax_Cur                (0,162) edit  {PRINT1_FORMAT}
 
     add #TaxTotal_Txgrs_Cur to #temp_txgrs_total
     add #TaxTotal_Nlgrs_Cur to #temp_nlgrs_total
     add #TaxTotal_Tax_Cur   to #temp_tax_total
 
     #if {SITE_ID} = 'ARK'
         !I - California Company Pd, J - New Jersey Company Paid, which
         !are not know to Tax001, so this is for reconciliation
         !--------------------------------------------------------------
         if (($TaxTotal_Tax_Class = 'I') OR ($TaxTotal_Tax_Class = 'J'))
           let #CoPaid     = #CoPaid + #TaxTotal_Tax_Cur
           if (#Tot = 1) !Only sum Comp Paid Hash total at company break
                let #CoPaid_Tot = #CoPaid_Tot + #TaxTotal_Tax_Cur
           end-if
         end-if
 
       #endif
 
       if #tot = 3
        if $TaxTotal_ER_Generated = 't'
          Add #TaxTotal_Tax_Cur to #Hash_Generated_Taxes
        end-if
       end-if
 
 
      else
       Add 1 to #No_tax_cnt
      end-if !if (round(#TaxTotal_Txgrs_Cur,2) <> 0) or ...
 
      Put  0          -
           0          -
           0          -
           Into TaxTotal(#ii)       -
                TaxTotal_Nlgrs_Cur (#Tot) -
                TaxTotal_Txgrs_Cur (#Tot) -
                TaxTotal_Tax_Cur   (#Tot)
 
     end-if  ! if (($Processed_Feds = 't') AND ($Test_State = $Next_State)) OR ...
    end-while
    let $Processed_Feds = 't'
   end-while
 
   if #temp_txgrs_total <> 0 or #temp_nlgrs_total <> 0 or #temp_tax_total
    print 'Column Totals (from above) --> '      (+2,20)
    Print #temp_txgrs_total              (0,130) edit  {PRINT1_FORMAT}
    Print #temp_nlgrs_total              (0,146) edit  {PRINT1_FORMAT}
    Print #temp_tax_total                (0,162) edit  {PRINT1_FORMAT}
    move 0 to #temp_txgrs_total
    move 0 to #temp_nlgrs_total
    move 0 to #temp_tax_total
   end-if
   
   !Paygroup Totals
   !---------------
   if #Tot = 0
 
          print 'Extract Totals for Paygroup: ' (+2,20)
          print $Current_Paygroup                 (0,50)
          print 'Total Taxes              = '   (+1,20)
          print #Paygroup_Total_Tax             ()
 
          #if {SITE_ID} = 'ARK'
            print 'Total Company Pd Taxes = ' (+1,20)
            print #CoPaid                       ()
          #endif
 
          print 'Total Taxable Wages (all jurisdictions)     = '    (+1,20)
          print #Paygroup_Total_Taxable_Wages ()
          print 'Total Gross Wages (all jurisdictions)       = '    (+1,20)
          print #Paygroup_Total_Gross_Wages   ()
 
    end-if
 
   !Company Totals
   !--------------
   if #Tot = 1
 
          New-Page
          print 'Extract Totals for Company. ' (+1,20)
          print $Current_Company                (0,50)
          print 'Total Taxes Extracted    = '  (+1,20)
          print #Company_Total_Tax             () edit 99,999,999,999.99mi
          print '   (Total Deposit)'           ()
 
          #if {SITE_ID} = 'ARK'
            print 'Total Company Pd Taxes = ' (+1,20)
            print #CoPaid                     () edit 999,999,999.99mi
            print 'TAX001 Total Taxes     = ' (+1,20)
            let #Tax001_Tot = #Company_Total_Tax - #CoPaid
            print #Tax001_Tot                 () edit 999,999,999.99mi
          #endif
 

          #ifdef BYPASS_FED_STOCK_OPTION_TAXES
            if  round(#Stock_option_tax_company,2) <> 0
              print 'Taxes for Stock options = '  (+1,20)
              print #Stock_option_tax_company     ()  edit 999,999,999.99mi
            end-if
            let #Stock_option_tax_company   = 0
          #endif
 
          print 'Total Taxable Wages (all jurisdictions)     = '  (+1,20)
          print #Company_Total_Taxable_Wages () edit 99,999,999,999.99mi
          print 'Total Gross Wages (all jurisdictions)       = '  (+1,20)
          print #Company_Total_Gross_Wages   () edit 99,999,999,999.99mi
          if round(#Ignore_Tax,2) <> 0
            print 'Total non reported taxes = '  (+1,20)
            print #Ignore_Tax () edit 999,999,999.99mi
            print '   (SUI, FUI, Special-Assessment Taxes...)' ()
          end-if
 
          #ifdef LOG_SENT_PAYLINES
            if round(#Company_Taxes_Previously_Extracted,2) <> 0
              print 'Taxes Previously Extracted         = ' (+2,20)
              print #Company_Taxes_Previously_Extracted () edit 999,999,999.99mi
              print 'Taxable Wages Previously Extracted (all jurisdictions) = ' (+1,20)
              print #Company_Txgrs_Previously_Extracted () edit 999,999,999.99mi
            end-if
          #endif
 
          if round(#Company_Total_Tax_Non_941,2) <> 0
              print 'Non-941 Taxes Withheld (FIT)       = ' (+2,20)
              print #Company_Total_Tax_Non_941              () edit 999,999,999.99mi
              print 'Non-941 Taxable Wages  (FIT)       = ' (+1,20)
              print #Company_Total_Taxable_Wages_Non_941    () edit 999,999,999.99mi
          end-if
          let #Company_Total_Tax_Non_941 = 0
          let #Company_Total_Taxable_Wages_Non_941 = 0
 
          if round(#TaxBalance_Tax_Cur_Remapped_to_200,2) <> 0
              print 'Taxes Remapped to company 200      = ' (+2,20)
              print #TaxBalance_Tax_Cur_Remapped_to_200     () edit 999,999,999.99mi
          end-if
          LET #TaxBalance_Tax_Cur_Remapped_to_200 = 0
 
          #if {SITE_ID} = 'AXA1'
            if round(#TaxBalance_Tax_Cur_Remapped_to_ADPPRB,2) <> 0
              print 'Taxes Remapped to ADPPRB           = ' (+2,20)
              print #TaxBalance_Tax_Cur_Remapped_to_ADPPRB  () edit 999,999,999.99mi
            end-if
            LET #TaxBalance_Tax_Cur_Remapped_to_ADPPRB = 0
            if round(#TaxBalance_Tax_Cur_Remapped_to_PRPPRB,2) <> 0
              print 'Taxes Remapped to PRPPRB           = ' (+1,20)
              print #TaxBalance_Tax_Cur_Remapped_to_PRPPRB  () edit 999,999,999.99mi
            end-if
            LET #TaxBalance_Tax_Cur_Remapped_to_PRPPRB = 0
          #endif
 
          !4/1/04 RR taxes remapped for this company
          !------------------------------------------
          if round(#TaxBalance_Tax_Cur_Remapped_to_RR,2) <> 0
              print 'Taxes Remapped to RR companies     = ' (+2,20)
              print #TaxBalance_Tax_Cur_Remapped_to_RR      () edit 999,999,999.99mi
          end-if
          LET #TaxBalance_Tax_Cur_Remapped_to_RR = 0
 
          if #Company_check_cross_quarters > 0
            print 'Number of Payline Reversals & Cross-overs from Prior Qtr = ' (+2,20)
            print #Company_check_cross_quarters () edit 999,999,999.99mi
          end-if
 
 
          !print 'Total Local ER taxes     = '  (+1,20)
          !print #Local_ER_Tax ()
 
          #ifdef KJDA
            print 'The following KJDA Fees'   (+2,20)
 
            #ifdef KJDA_to_Extract
              print ' have been included in the TaxTotals above' ()
            #else
              print ' have been included in the Non-Reported taxes above' ()
            #endif
 
            print 'KY KJDA Fees             = '  (+2,20)
            print  #Company_ky_KJDA                   ()
            #if {SITE_ID} = 'PJN1'
            print 'Jefftown KJDA Fees       = '  (+1,20)
            print  #Company_jt_KJDA                   ()
            #endif
            print 'Jeff County KJDA Fees    = '  (+1,20)
            print  #Company_jc_KJDA                   ()
            print 'Sum of KJDA Fees         = '  (+1,20)
            let #kjda_total = #Company_ky_KJDA + #Company_jt_KJDA + #Company_jc_KJDA
            print #kjda_total ()
            print 'KJDA Employee Count      = '  (+1,20)
            print  #Company_KJDA_Cnt                  ()
 
            move 0 to #Company_ky_KJDA
            move 0 to #Company_jt_KJDA
            move 0 to #Company_jc_KJDA
            move 0 to #kjda_total
            move 0 to #Company_KJDA_Cnt
 
          #endif
 
          #if {SITE_ID} = 'FTO1'
            do print-frito-totals
          #endif
 
          #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
             do CSE1-Report-Pensioners-Fica-Med   !added 2/21/10 routine in clients probiz.sqc
          #endif
 
          print 'Federal Company Totals'           (+2,1)
          print '      FIT      ($UH)         = '  (+1,20)
          print #Hash_Total_UH_C                   () edit 99,999,999,999.99mi
          print '      OASDI-EE ($UD)         = '  (+1,20)
          print #Hash_Total_UD_C                   () edit 99,999,999,999.99mi
          print '      OASDI-ER ($UE)         = '  (+1,20)
          print #Hash_Total_UE_C                   () edit 99,999,999,999.99mi
          print '      FICA-ERX ($U8)         = '  (+1,20)
          print #Hash_Total_U8_C                   () edit 99,999,999,999.99mi
          print '      MED-EE   ($UF)         = '  (+1,20)
          print #Hash_Total_UF_C                   () edit 99,999,999,999.99mi
          print '      MED-SUR  ($U7)         = '  (+1,20)
          print #Hash_Total_U7_C                   () edit 99,999,999,999.99mi
          print '      MED-ER   ($UQ)         = '  (+1,20)
          print #Hash_Total_UQ_C                   () edit 99,999,999,999.99mi
          print '      EIC      ($UC+$EC)     = '  (+1,20)
          print #Hash_Total_UC_C                   () edit 99,999,999,999.99mi
          print '      FUTA     ($UU)         = '  (+1,20)
          print #Hash_Total_UU_C                   () edit 99,999,999,999.99mi
 
 
          print ' Tips OASDI-EE ($UG)         = '  (+1,20)
          print #Hash_Total_UG_C                   () edit 99,999,999,999.99mi
          print ' Tips OASDI-ER ($UJ)         = '  (+1,20)
          print #Hash_Total_UJ_C                   () edit 99,999,999,999.99mi
          print ' State FUTA    ($U6)         = '  (+1,20)
          print #Hash_Total_U6_C                   () edit 99,999,999,999.99mi
          print ' Tips FICA-ERX ($U9)         = '  (+1,20)
          print #Hash_Total_U9_C                   () edit 99,999,999,999.99mi
          print ' Tips MED-ER   ($UT)         = '  (+1,20)
          print #Hash_Total_UT_C                   () edit 99,999,999,999.99mi
          print ' Tips MED-ER   ($UZ)         = '  (+1,20)
          print #Hash_Total_UZ_C                   () edit 99,999,999,999.99mi
 
 
          print 'State Company Totals'             (+2,1)
          print '      SIT      (xxH)         = '  (+1,20)
          print #Hash_Total_STH_C                  () edit 99,999,999,999.99mi
          print '      SDI-EE   (xxD)         = '  (+1,20)
          print #Hash_Total_STD_C                  () edit 99,999,999,999.99mi
          print '      SDI-ER   (xxE)         = '  (+1,20)
          print #Hash_Total_STE_C                  () edit 99,999,999,999.99mi
          print '      SUI-ER   (xxU)         = '  (+1,20)
          print #Hash_Total_STU_C                  () edit 99,999,999,999.99mi
          print '      SUI-Spcl (xxS)         = '  (+1,20)
          print #Hash_Total_STS_C                  () edit 99,999,999,999.99mi
          print '      SUI-EE   (xxV)         = '  (+1,20)
          print #Hash_Total_STV_C                  () edit 99,999,999,999.99mi
          print '      SWAF     (xxL)         = '  (+1,20)
          print #Hash_Total_STL_C                  () edit 99,999,999,999.99mi
          print '      WFDP     (xxM)         = '  (+1,20)
          print #Hash_Total_STM_C                  () edit 99,999,999,999.99mi
          print '      HCSF     (xxN)         = '  (+1,20)
          print #Hash_Total_STN_C                  () edit 99,999,999,999.99mi
 
          print '      FLI-EE   (NJI)         = '  (+1,20)
          print #Hash_Total_FLIEE_C                () edit 99,999,999,999.99mi
          print '      VFLI-EE  (NJO)         = '  (+1,20)
          print #Hash_Total_VFLIEE_C               () edit 99,999,999,999.99mi
          print '      VFLI-ER  (NJY)         = '  (+1,20)
          print #Hash_Total_VFLIER_C               () edit 99,999,999,999.99mi
 
          print 'Local Company Totals'             (+2,1)
          print '      Local Taxes            = '  (+1,20)
          print #Hash_Total_Local_C                () edit 99,999,999,999.99mi
 
          if round(#TaxBalance_Txgrs_locals_cleared_company,2) <> 0
            print '    Total Local Taxable Wages skipped due to zero Taxes Withheld (ADJUST_ZERO_LOCALS enabled)   = '   (+1,20)
            print #TaxBalance_Txgrs_locals_cleared_company                                                           () edit 99,999,999,999.99mi
          end-if
 
          move 0 to  #Hash_Total_UH_C
          move 0 to  #Hash_Total_UD_C
          move 0 to  #Hash_Total_UE_C
          move 0 to  #Hash_Total_UF_C
          move 0 to  #Hash_Total_UQ_C
          move 0 to  #Hash_Total_UC_C
          move 0 to  #Hash_Total_UU_C
          move 0 to  #Hash_Total_STH_C
          move 0 to  #Hash_Total_STD_C
          move 0 to  #Hash_Total_STE_C
          move 0 to  #Hash_Total_STU_C
          move 0 to  #Hash_Total_STS_C
          move 0 to  #Hash_Total_STV_C
          move 0 to  #Hash_Total_STL_C
          move 0 to  #Hash_Total_STM_C
          move 0 to  #Hash_Total_STN_C
          move 0 to  #Hash_Total_Local_C
 
          move 0 to  #Hash_Total_UG_C
          move 0 to  #Hash_Total_UJ_C
          move 0 to  #Hash_Total_UT_C
          move 0 to  #Hash_Total_UZ_C
          move 0 to  #Hash_Total_U6_C
          move 0 to  #Hash_Total_U7_C
          move 0 to  #Hash_Total_U8_C
          move 0 to  #Hash_Total_U9_C
 
          move 0 to  #Hash_Total_FLIEE_C
          move 0 to  #Hash_Total_VFLIEE_C
          move 0 to  #Hash_Total_VFLIER_C
          move 0 to  #TaxBalance_Txgrs_locals_cleared_company
          
         #ifdef TIPS_ROLLUP
            print 'The following Tips Wages & Taxes'   (+2,10)
            print ' have been included in the Totals above' ()
 
            if round(#OASDI_Tips_Wages_Tot_EE,2) <> 0
              print 'OASDI Tips - Taxable EE  = '  (+1,20)
              print  #OASDI_Tips_Wages_Tot_EE  ()
            end-if
 
            if round(#OASDI_Tips_Taxes_Tot_EE,2) <> 0
              print 'OASDI Tips - Taxes EE    = '  (+1,20)
              print #OASDI_Tips_Taxes_Tot_EE   ()
            end-if
 
            if round(#OASDI_Tips_Wages_Tot_ER,2) <> 0
              print 'OASDI Tips - Taxable ER  = '  (+1,20)
              print  #OASDI_Tips_Wages_Tot_ER  ()
            end-if
 
            if round(#OASDI_Tips_Taxes_Tot_ER,2) <> 0
              print 'OASDI Tips - Taxes ER    = '  (+1,20)
              print #OASDI_Tips_Taxes_Tot_ER   ()
            end-if
 
            if round(#MEDIC_Tips_Wages_Tot_EE,2) <> 0
              print 'MEDIC Tips - Taxable EE  = '  (+2,20)
              print  #MEDIC_Tips_Wages_Tot_EE  ()
            end-if
 
            if round(#MEDIC_Tips_Taxes_Tot_EE,2) <> 0
              print 'MEDIC Tips - Taxes EE    = '  (+1,20)
              print #MEDIC_Tips_Taxes_Tot_EE   ()
            end-if
 
            if round(#MEDIC_Tips_Wages_Tot_ER,2) <> 0
              print 'MEDIC Tips - Taxable ER  = '  (+1,20)
              print  #MEDIC_Tips_Wages_Tot_ER  ()
            end-if
 
            if round(#MEDIC_Tips_Taxes_Tot_ER,2) <> 0
              print 'MEDIC Tips - Taxes ER    = '  (+1,20)
              print #MEDIC_Tips_Taxes_Tot_ER   ()
            end-if
 
            Add  #OASDI_Tips_Wages_Tot_EE to #OASDI_Tips_Wages_Tot_EE_Hash
            Add  #OASDI_Tips_Taxes_Tot_EE to #OASDI_Tips_Taxes_Tot_EE_Hash
            Add  #OASDI_Tips_Wages_Tot_ER to #OASDI_Tips_Wages_Tot_ER_Hash
            Add  #OASDI_Tips_Taxes_Tot_ER to #OASDI_Tips_Taxes_Tot_ER_Hash
 
            Add  #MEDIC_Tips_Wages_Tot_EE to #MEDIC_Tips_Wages_Tot_EE_Hash
            Add  #MEDIC_Tips_Taxes_Tot_EE to #MEDIC_Tips_Taxes_Tot_EE_Hash
            Add  #MEDIC_Tips_Wages_Tot_ER to #MEDIC_Tips_Wages_Tot_ER_Hash
            Add  #MEDIC_Tips_Taxes_Tot_ER to #MEDIC_Tips_Taxes_Tot_ER_Hash
 
            move 0 to #OASDI_Tips_Wages_Tot_EE
            move 0 to #OASDI_Tips_Taxes_Tot_EE
            move 0 to #OASDI_Tips_Wages_Tot_ER
            move 0 to #OASDI_Tips_Taxes_Tot_ER
 
            move 0 to #MEDIC_Tips_Wages_Tot_EE
            move 0 to #MEDIC_Tips_Taxes_Tot_EE
            move 0 to #MEDIC_Tips_Wages_Tot_ER
            move 0 to #MEDIC_Tips_Taxes_Tot_ER
 
 
          #endif
 
         !2/10/04 ADDED FOR Missouri SIT
         !------------------------------
         if round(#TaxBalance_Tax_YTD_MO_C,2) <> 0
           print 'Total Missouri SIT YTD Taxes       = '  (+2,20)
           print  #TaxBalance_Tax_YTD_MO_C   () edit 999,999,999.99mi
         end-if
         if round(#CALC-MOH-EMPLOYER-CREDIT_C,2) <> 0
           print ', Total Missouri SIT Employer Credit in Extract = '  ()
           print  #CALC-MOH-EMPLOYER-CREDIT_C                          () edit 999,999,999.99mi
         end-if
 
         if round(#TaxBalance_Txgrs_YTD_MO_C,2) <> 0
           print 'Total Missouri SIT YTD Taxable     = '  (+1,20)
           print  #TaxBalance_Txgrs_YTD_MO_C   () edit 999,999,999.99mi
         end-if
         if round(#TaxBalance_Nlgrs_YTD_MO_C,2) <> 0
           print 'Total Missouri SIT YTD NL Gross    = '  (+1,20)
           print  #TaxBalance_Nlgrs_YTD_MO_C   () edit 999,999,999.99mi
         end-if
 
         move 0 to #TaxBalance_Tax_YTD_MO_C
         move 0 to #TaxBalance_Txgrs_YTD_MO_C
         move 0 to #TaxBalance_NlGrs_YTD_MO_C
         move 0 to #CALC-MOH-EMPLOYER-CREDIT_C
 
         #ifdef THIRD_PARTY_SICK_PERIODIC
          do third-party-sick-periodic-report-company
         #endif
 
         #ifdef COBRA
            do print-cobra-company
         #endif
         
         do EE-Count-Breakout
         
         #ifdef CANADA_TOO
 
           if round(#Company_T4,2) <> 0
             print 'Total Canadian T4                  = '  (+1,20)
             print  #Company_T4   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_T4A,2) <> 0
             print 'Total Canadian T4A                 = '  (+1,20)
             print  #Company_T4A   () edit 999,999,999.99mi
           end-if
 
           let #Company_FIT =   #Company_T4 + #Company_T4A
 
           if round(#Company_FIT,2) <> 0
             print 'Total Canadian FIT                 = '  (+1,20)
             print  #Company_FIT   () edit 999,999,999.99mi
             print ',  FIT Taxable = ' ()
             print  #Company_canada_fit_txgrs   () edit 999,999,999.99mi
           end-if
 
 
           if round(#Company_QIP,2) <> 0
             print 'Total Quebec   QIP                 = '  (+1,20)
             print  #Company_QIP   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_CST,2) <> 0
             print 'Total Canadian CSST                = '  (+1,20)
             print  #Company_CST   () edit 999,999,999.99mi
             print ',  CST Taxable = ' ()
             print  #Company_CST_Taxable        () edit 999,999,999.99mi
           end-if
 
           if round(#Company_RL1,2) <> 0
             print 'Total Quebec   RL-1                = '  (+1,20)
             print  #Company_RL1   () edit 999,999,999.99mi
           end-if
           if round(#Company_RL2,2) <> 0
             print 'Total Quebec   RL-2                = '  (+1,20)
             print  #Company_RL2   () edit 999,999,999.99mi
           end-if
 
           let #Company_QIT =   #Company_RL1 + #Company_RL2
 
           if round(#Company_QIT,2) <> 0
             print 'Total Quebac QIT                   = '  (+1,20)
             print  #Company_QIT   () edit 999,999,999.99mi
             print ',  QIT Taxable = ' ()
             print  #Company_quebec_fit_txgrs   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_canada,2) <> 0
             print 'Total Canadian Remitted            = '  (+1,20)
             print  #Company_canada   () edit 999,999,999.99mi
           end-if
           if round(#Company_quebec,2) <> 0
             print 'Total Quebec Remitted              = '  (+1,20)
             print  #Company_quebec   () edit 999,999,999.99mi
           end-if
 
           let #total_remitted = #Company_canada + #Company_quebec
           if round(#total_remitted,2) <> 0
             print 'Total Remitted                     = '  (+1,20)
             print  #total_remitted   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_True_T4_TxGrs_Cur,2) <> 0
             print 'Total T4 Taxable Wages             = '  (+1,20)
             print  #Company_True_T4_TxGrs_Cur   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Payroll_Txgrs_Cur,2) <> 0
             print 'Total Payroll Taxable Wages        = '  (+1,20)
             print  #Company_Payroll_Txgrs_Cur   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Payroll_Tax_Cur,2) <> 0
             print 'Total Payroll Taxes Withheld       = '  (+1,20)
             print  #Company_Payroll_Tax_Cur   () edit 999,999,999.99mi
           end-if
 
           !added 1/16/03
           if round(#Company_Pension_Tax_Cur_ER,2) <> 0
             print 'Total Pension Plan Employer        = '  (+1,20)
             print  #Company_Pension_Tax_Cur_ER   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Pension_Tax_Cur_EE,2) <> 0
             print 'Total Pension Plan Employee        = '  (+1,20)
             print  #Company_Pension_Tax_Cur_EE   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Pension_Tax_Cur_EE,2) <> 0
             print 'Total Pension Plan EE & ER         = '  (+1,20)
             let #Company_Pension_Tax_Cur_EE_ER = #Company_Pension_Tax_Cur_EE + #Company_Pension_Tax_Cur_ER
             print  #Company_Pension_Tax_Cur_EE_ER () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Pension_Tax_Cur_ER_quebec,2) <> 0
             print 'Total Pension Plan Employer QC     = '  (+1,20)
             print  #Company_Pension_Tax_Cur_ER_quebec   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Pension_Tax_Cur_EE_quebec,2) <> 0
             print 'Total Pension Plan Employee QC     = '  (+1,20)
             print  #Company_Pension_Tax_Cur_EE_quebec   () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Pension_Tax_Cur_EE_quebec,2) <> 0
             print 'Total Pension Plan EE & ER QC      = '  (+1,20)
             let #Company_Pension_Tax_Cur_EE_ER_quebec = #Company_Pension_Tax_Cur_EE_quebec + #Company_Pension_Tax_Cur_ER_quebec
             print  #Company_Pension_Tax_Cur_EE_ER_quebec () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Empl_ins_Tax_Cur_EE,2) <> 0
             print 'Total Employment Ins. Employee     = '  (+1,20)
             print  #Company_Empl_ins_Tax_Cur_EE  () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Empl_ins_Tax_Cur_ER,2) <> 0
             print 'Total Employment Ins. Employer     = '  (+1,20)
             print  #Company_Empl_ins_Tax_Cur_ER  () edit 999,999,999.99mi
           end-if
 
           if round(#Company_Empl_ins_Tax_Cur_EE,2) <> 0
             print 'Total Employment Ins. EE & ER      = '  (+1,20)
             let #Company_Empl_ins_Tax_Cur_EE_ER = #Company_Empl_ins_Tax_Cur_EE + #Company_Empl_ins_Tax_Cur_ER
             print  #Company_Empl_ins_Tax_Cur_EE_ER  () edit 999,999,999.99mi
           end-if
 
    !12/12/05 QPIP added
           if round(#Company_QPIP_Empl_ins_Tax_Cur_EE,2) <> 0
             print 'Total Employment QPIP Employee     = '  (+1,20)
             print  #Company_QPIP_Empl_ins_Tax_Cur_EE  () edit 999,999,999.99mi
           end-if
 
           if round(#Company_QPIP_Empl_ins_Tax_Cur_ER,2) <> 0
             print 'Total Employment QPIP Employer     = '  (+1,20)
             print  #Company_QPIP_Empl_ins_Tax_Cur_ER  () edit 999,999,999.99mi
           end-if
 
           if round(#Company_QPIP_Empl_ins_Tax_Cur_EE,2) <> 0
             print 'Total Employment QPIP EE & ER      = '  (+1,20)
             let #Company_QPIP_Empl_ins_Tax_Cur_EE_ER = #Company_QPIP_Empl_ins_Tax_Cur_EE + #Company_QPIP_Empl_ins_Tax_Cur_ER
             print  #Company_QPIP_Empl_ins_Tax_Cur_EE_ER  () edit 999,999,999.99mi
           end-if
 
 
 
           if round(#Company_Health_Tax_Cur_ER,2) <> 0
             print 'Total Health Ins. Employer         = '  (+1,20)
             print  #Company_Health_Tax_Cur_ER  () edit 999,999,999.99mi
             print ', (including taxes not processed of ' ()
             print  #Company_Health_Tax_Cur_ER_bypassed () edit 999,999,999.99mi
             print ')' ()
           end-if
 
           move 0 to #Company_Health_Tax_Cur_ER_bypassed
           move 0 to #Company_Health_Tax_Cur_ER
           move 0 to #Company_Empl_ins_Tax_Cur_ER
           move 0 to #Company_Empl_ins_Tax_Cur_EE
           move 0 to #Company_QPIP_Empl_ins_Tax_Cur_ER
           move 0 to #Company_QPIP_Empl_ins_Tax_Cur_EE
           move 0 to #Company_Pension_Tax_Cur_EE_quebec
           move 0 to #Company_Pension_Tax_Cur_ER_quebec
           move 0 to #Company_Pension_Tax_Cur_EE
           move 0 to #Company_Pension_Tax_Cur_ER
 
           move 0 to #Company_canada_fit_txgrs
           move 0 to #Company_quebec_fit_txgrs
           move 0 to #Company_canada
           move 0 to #Company_quebec
           move 0 to #Company_T4
           move 0 to #Company_T4A
           move 0 to #Company_QIP
           move 0 to #Company_RL1
           move 0 to #Company_RL2
 
           !Peoplesoft 8 sub-totals
           !-------------------------
           move 0 to #Company_True_T4_TxGrs_Cur
           move 0 to #Company_Payroll_Txgrs_Cur
           move 0 to #Company_Payroll_Tax_Cur
 
 
          #endif
 
          move 0 to #Company_Total_Tax
          move 0 to #CoPaid
          move 0 to #Company_Total_Taxable_Wages
          move 0 to #Company_Total_Gross_Wages
          move 0 to #Ignore_Tax
          move 0 to #Local_ER_Tax
          move 0 to #Company_Taxes_Previously_Extracted
          move 0 to #Company_Txgrs_Previously_Extracted
          move 0 to #Company_check_cross_quarters
 
  end-if
 
  #ifdef SUBTOTAL_FEIN
 
   !Fein Totals
   !-----------
   if #Tot = 2
          print 'Extract Totals for Fein:    ' (+2,20)
          print $Current_Fein                  (0,50)
          print 'Total Taxes Extracted    = '  (+1,20)
          print #Fein_Total_Tax                () edit 99,999,999,999.99mi
          print '   (Total Deposit)'           ()
 
          print 'Total Taxable Wages (all jurisdictions)     = '  (+1,20)
          print #Fein_Total_Taxable_Wages () edit 99,999,999,999.99mi
          print 'Total Gross Wages (all jurisdictions)       = '  (+1,20)
          print #Fein_Total_Gross_Wages   () edit 99,999,999,999.99mi
 
          if round(#Fein_Ignore_Tax,2) <> 0
            print 'Total non reported taxes = '  (+1,20)
            print #Fein_Ignore_Tax () edit 999,999,999.99mi
            print '   (SUI, FUI, Special-Assessment Taxes...)' ()
          end-if
 
          #ifdef LOG_SENT_PAYLINES
            if round(#Fein_Taxes_Previously_Extracted,2) <> 0
              print 'Taxes Previously Extracted         = ' (+2,20)
              print #Fein_Taxes_Previously_Extracted () edit 999,999,999.99mi
              print 'Taxable Wages Previously Extracted (all jurisdictions) = ' (+1,20)
              print #Fein_Txgrs_Previously_Extracted () edit 999,999,999.99mi
            end-if
          #endif
 
          if round(#Fein_Total_Tax_Non_941,2) <> 0
              print 'Non-941 Taxes Withheld (FIT)       = ' (+2,20)
              print #Fein_Total_Tax_Non_941              () edit 999,999,999.99mi
              print 'Non-941 Taxable Wages  (FIT)       = ' (+1,20)
              print #Fein_Total_Taxable_Wages_Non_941    () edit 999,999,999.99mi
          end-if
 
          move 0 to #Fein_Total_Tax
          move 0 to #Fein_Total_Taxable_Wages
          move 0 to #Fein_Total_Gross_Wages
          move 0 to #Fein_Ignore_Tax
          move 0 to #Fein_Taxes_Previously_Extracted
          move 0 to #Fein_Txgrs_Previously_Extracted
          move 0 to #Fein_Total_Tax_Non_941
          move 0 to #Fein_Total_Taxable_Wages_Non_941
 
    end-if
  #endif
 
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
 
   !ADP Compid Totals
   !-----------------
   if #Tot = 2
   
          #if {SITE_ID} = 'CZB1'
           print 'Extract Totals for Rollup Company ' (+2,20)
          #else
           print 'Extract Totals for ADP Compid ' (+2,20)
          #endif
 
          print $Current_ADP_Compid              (0,50)
          print 'Total Taxes Extracted    = '    (+1,20)
          print #ADP_Compid_Total_Tax            () edit 99,999,999,999.99mi
          print '   (Total Deposit)'             ()
 
          print 'Total Taxable Wages (all jurisdictions)     = '  (+1,20)
          print #ADP_Compid_Total_Taxable_Wages () edit 99,999,999,999.99mi
          print 'Total Gross Wages (all jurisdictions)       = '  (+1,20)
          print #ADP_Compid_Total_Gross_Wages   () edit 99,999,999,999.99mi
 
          if round(#ADP_Compid_Ignore_Tax,2) <> 0
            print 'Total non reported taxes = '  (+1,20)
            print #ADP_Compid_Ignore_Tax () edit 999,999,999.99mi
            print '   (SUI, FUI, Special-Assessment Taxes...)' ()
          end-if
 
          #ifdef LOG_SENT_PAYLINES
            if round(#ADP_Compid_Taxes_Previously_Extracted,2) <> 0
              print 'Taxes Previously Extracted         = ' (+2,20)
              print #ADP_Compid_Taxes_Previously_Extracted () edit 999,999,999.99mi
              print 'Taxable Wages Previously Extracted (all jurisdictions) = ' (+1,20)
              print #ADP_Compid_Txgrs_Previously_Extracted () edit 999,999,999.99mi
            end-if
          #endif
 
          if round(#ADP_Compid_Total_Tax_Non_941,2) <> 0
              print 'Non-941 Taxes Withheld (FIT)       = ' (+2,20)
              print #ADP_Compid_Total_Tax_Non_941              () edit 999,999,999.99mi
              print 'Non-941 Taxable Wages  (FIT)       = ' (+1,20)
              print #ADP_Compid_Total_Taxable_Wages_Non_941    () edit 999,999,999.99mi
          end-if
 
          move 0 to #ADP_Compid_Total_Tax
          move 0 to #ADP_Compid_Total_Taxable_Wages
          move 0 to #ADP_Compid_Total_Gross_Wages
          move 0 to #ADP_Compid_Ignore_Tax
          move 0 to #ADP_Compid_Taxes_Previously_Extracted
          move 0 to #ADP_Compid_Txgrs_Previously_Extracted
          move 0 to #ADP_Compid_Total_Tax_Non_941
          move 0 to #ADP_Compid_Total_Taxable_Wages_Non_941
 
    end-if
  #endif
 
 
  ! show 'Print Complete.'
 
End-procedure
 
 
begin-procedure Generate-Canada-Taxcode-Description
 
 move ' ' to $TaxClass_Descr
 
 !CANAB PIT     E
 !CANPQ PIT     E
 !CANCN CPP     E
 !CANCN CPP     R
 !CANPQ QPP     E
 !CANPQ QPP     R
 !CANCN UI      E
 !CANCN UI      R
 !CANAB PIT     E
 !CANPQ PIT     E
 !CANP
 
 evaluate $Trimmed_Tax_Class
 
  When = 'I'
   move 'HLTH-ER' to $TaxClass_Descr
   break
 
  When = 'EIE'
   move 'UI-EE' to $TaxClass_Descr
   break
 
  When = 'EIR'
   move 'UI-ER' to $TaxClass_Descr
   break
 
  When = 'CPP'
     let $TaxClass_Descr = 'CPP-BOTH'
   break
 
  When = 'QPP'
     let $TaxClass_Descr = 'QPP-BOTH'
   break
 
  When = 'CST'
     let $TaxClass_Descr = 'QIT-CSST'
   break
 
  When-other
    let $TaxClass_Descr = $Trimmed_State || '-' || $Trimmed_Tax_Class
    break
 
 end-evaluate
 
end-procedure
 
 
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-Next-State                                             !
! Descr:     Get The Next state to printout                             !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure Get-Next-State
 
  if #next_state_inx > 51
  let $Next_State = '**'
  else
    get $Next_State from States(#next_state_inx) State
  end-if
 
end-procedure
 
#ifdef CANADA_TOO
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-Next-Province                                             !
! Descr:     Get The Next Province to printout                             !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure Get-Next-Province
 
  if #next_state_inx > 10
  let $Next_State = '**'
  else
    get $Next_State from Provs(#next_state_inx) Province
  end-if
 
end-procedure
#endif
 
 
 
#if {Peoplesoft_Version} >= '8.8'
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-XlatTable-Descr                                        !
! Descr:     Get The Tax Class Description.                             !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure Get-XlatTable-Descr
 
   move 'TAX_CLASS'          to $FieldName
   move $TaxTotal_Tax_Class  to $FieldValue
   do Read-Translate-Table
   move $XlatShortName to $TaxClass_Descr
 
end-procedure
 
 
#else
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-XlatTable-Descr                                        !
! Descr:     Get The Tax Class Description.                             !
!                                                                       !
!-----------------------------------------------------------------------!
 
begin-procedure Get-XlatTable-Descr
 
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.21: ' $display_dt
 #endif
 
Begin-Select
XLATSHORTNAME
XLATLONGNAME
 
 let $TaxClass_Descr = rtrim(&XLATSHORTNAME,' ')
 
 From XLATTABLE
 where FIELDNAME  = 'TAX_CLASS' And
       LANGUAGE_CD = 'ENG' And
       FIELDVALUE = $TaxTotal_Tax_Class
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-procedure
 
#endif
 
 
 
 
 
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Get-Quarter                                                    !
! Descr:     determines which quarter in the year a date ($Dt_in)           !
!            is in, assigning the result to #qtr_out                        !
!----------------------------------------------------------------------     !
begin-procedure Get-Quarter
 
 !Get the Quarter that the Check date is in, from the pay calendar
 !----------------------------------------------------------------
 do Convert-To-DTU-Date($Dt_in, $Dt_in_DTU)
 
 let $Mo  = substr($Dt_in_DTU,6,2)
 move $Mo to #Mo
 let #i = (#Mo - 1) / 3
 let #qtr_out  = floor(#i) + 1
 let #year_out = substr($Dt_in_DTU,1,4)
 let #year_qtr = (#year_out * 10) + #qtr_out    !19993, 19994, 20001, 20002...
 
end-procedure
 
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Get-PayLine                                               !
! Descr:     Load the Employee Id's that have been paid for the user        !
!            inputted Pay End Date from the Pay-Line table into an          !
!            array.                                                         !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Get-PayLine
 
 
 !Get the Quarter that the Check date is in, from the pay calendar
 !----------------------------------------------------------------
 move &A.CHECK_DT to $A_Check_Dt
 move $A_Check_Dt to $Dt_in
 do Get-Quarter
 move #year_qtr to #Check_Year_Qtr_From_Pay_Calendar
 move #year_out to #Check_Year_From_Pay_Calendar
 move #qtr_out  to #Check_Qtr_From_Pay_Calendar  !added 9/30/2011 for RDS1
 
 move $AsofDate to $Dt_in   !9/14/05 changed from $sysdate, tested @Honeywell
 do Get-Quarter
 move #year_qtr to #Check_Year_Qtr_From_sysdate
 move #year_out to #Check_Year_From_sysdate
 
 !show ' Pay_Cal.Check_Dt = ' $Dt_in
 !show ' Pay_Cal.Year     = ' #year_out
 !show ' Pay_Cal.Qtr      = ' #qtr_out
 !show ' Pay_Cal.Year_Qtr = ' #Check_Year_Qtr_From_Pay_Calendar
 
 #ifdef debug_pbz
    show ' SlctA    '         $SlctOffCycleA
    show ' SlctB    '         $SlctOffCycleB
    show ' SlctPageFrom '     #SlctPageFrom
    show ' SlctPageThru '     #SlctPageThru
    show ' Input Pay End Dt ' $Input_Pay_End_Dt
    show ' Company          ' $Current_Company
    show ' Paygroup         ' $Current_Paygroup
 #endif
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.22 (get payline): ' $display_dt
 #endif
 
 #if {SITE_ID} = 'SCP1'	 !AS121311 - Added for SCI-SDC Requirement
       if $CycleInd = 'B'
             let $sdc_select  = 'I.PAY_SHEET_SRC IN (' || '''' || 'O' || '''' || ',' || '''' || 'L' || '''' || ',' || '''' || 'S' || '''' || ',' || '''' || 'P' || '''' || ',' || '''' || 'F' || '''' || ',' || '''' || 'K' || '''' ||')'
       end-if
 #endif
 
begin-select
I.COMPANY
I.PAYGROUP
I.EMPLID
I.{pg}
I.{ln}
I.OFF_CYCLE
I.PAY_END_DT
#ifdef MICROSOFT
ISNULL(I.CHECK_DT,'') &I.CHECK_DT
#Else
I.CHECK_DT 
#endif
I.BUSINESS_UNIT
I.{emp_rec}    !added 7/11/06
 
  let $Payline_COMPANY    = rtrim(&I.COMPANY,' ')
  let $Payline_paygroup   = rtrim(&I.PAYGROUP,' ')
  let #payline_empl_rcd   = &I.{emp_rec}
  let $payline_emplid     = rtrim(&I.EMPLID,' ')
  let #payline_pagen      = &I.{pg}
  let #payline_linen      = &I.{ln}
  let $payline_off_cycle  = rtrim(&I.OFF_CYCLE,' ')
  let $payline_pay_end_dt = rtrim(&I.PAY_END_DT,' ')
  let $payline_check_dt   = rtrim(&I.CHECK_DT,' ')
  let $Payline_Bus_unit   = rtrim(&I.BUSINESS_UNIT,' ')
  
  let $AsOfDate           = rtrim(&I.PAY_END_DT,' ')

  if $Payline_Emplid = rtrim('{debug_pbzper_emplid}',' ')
    show ' '
    show 'New Record from the pay line table --->'
    show ' company  ' &I.COMPANY
    show ' paygroup ' &I.PAYGROUP
    show ' emplid   ' &I.EMPLID
    show ' page     ' &I.{pg}
    show ' line     ' &I.{ln}
    show ' offcyc   ' &I.OFF_CYCLE
    show ' check_dt ' &I.CHECK_DT
    show ' payenddt ' &I.PAY_END_DT
    show ' busunit  ' &I.BUSINESS_UNIT
    show ' empl_rcd ' &I.{emp_rec}
  end-if

 
 #ifdef USE_CHECK_DATE_FROM_PAY_CHECK
    do Get-Check-Date-From-Pay-Check
 #endif
 
 let $Valid_check = 't'
 #ifdef ADP_TAX_PERIODIC_PAY_CHECK_CHECK_DT
   do Check-for-valid-check-dt
 #endif
 if $Valid_check = 't'  

  #ifdef GENERATE_EMPLOYEE_DETAIL
 
     do get-ssn
 
     let $compid = $PayLine_Company || ' ' || $PayLine_Paygroup
 
     Do Convert-to-DTU-Date($PayLine_pay_end_dt,$PayLine_pay_end_dt_DTU)
 
     let $Mo    = substr($PayLine_pay_end_dt_DTU,6,2)
     let $Day   = substr($PayLine_pay_end_dt_DTU,9,2)
     let $Yr    = substr($PayLine_pay_end_dt_DTU,1,4)
     let $end_dt_DTU = $Yr || $Mo || $Day
 
  #endif
 
  !----------------------------------------------------
  !if the client needs to check if this payline has
  !already been processed by the interface, check here.
  !----------------------------------------------------
  let $process_payline = 't'
 
  #ifdef LOG_SENT_PAYLINES
   #ifndef CUSTOM_US_RUN_TAXES          !the history check is done in the custom U.S. tax routine since it requires SEPCHK
    do Check-if-payline-processed
    if $payline_processed = 't'
      let $process_payline = 'f'
    else
      do Insert-Payline-History-Record
    end-if
   #endif
  #endif
 
  #ifdef KJDA
    if rtrim($PERSONAL_EMPLID,' ') <> rtrim($PayLine_EMPLID,' ')
 
     if (#Last_KJDA_Cnt > 0)
      do Write-KJDA-Taxes
     end-if
 
     let #Fica_Gross = 0           !Added: 1/3/2000
     move $Payline_Emplid to $Personal_Emplid
 
   end-if
  #endif
 

 
  !10/26/06, change.... no US run if we have Canada data
  !-----------------------------------------------------
  #ifdef CANADA_TOO
   do Process-CANADA-Run-Taxes
  #endif
 
  if $Canadian <> 'Y'
    let $Canadian = 'N'
    do Process-US-Run-Taxes       !if $process_payline = 'f', only track taxes previously extracted
  end-if
 
  #ifdef INCLUDE_KS_REGENT
     do Include-KS-Regent-Payline
  #endif
 end-if
 
 FROM PS_PAY_LINE I
     WHERE I.PAY_END_DT = $INPUT_PAY_END_DT AND
      I.COMPANY         = $Current_Company  AND
      I.PAYGROUP        = $Current_Paygroup AND
      I.CONFIRMED       = 'Y' AND
      
      #ifdef TEST_EMPLID
      I.EMPLID = '{TEST_EMPLID}' AND
      #endif
 
      #ifdef OFF_CYCLE_ONLY
        I.OFF_CYCLE = 'Y' AND
      #else
        I.OFF_CYCLE IN ($SlctOffCycleA, $SlctOffCycleB) AND
        #if {SITE_ID} = 'SCP1'	 !AS121311 - Added for SCI-SDC Requirement
	  [$sdc_select]  AND
        #endif
      #endif
 
      I.{pg} BETWEEN #SlctPageFrom AND #SlctPageThru
 
      #if {SITE_ID} = 'PFZ1'
        AND EXISTS
           (SELECT 'X'
            FROM PS_Z_PAY_PAGE Z
            WHERE Z.COMPANY = I.COMPANY AND
             Z.PAYGROUP = I.PAYGROUP AND
             Z.PAY_END_DT = I.PAY_END_DT AND
             Z.OFF_CYCLE = I.OFF_CYCLE AND
             Z.{pg} = I.{pg} AND
             Z.Z_GL_PROCESS_DATE IS NOT NULL AND
             Z.Z_GL_PROCESS_TIME <> 0 AND
             !TO_NUMBER(TO_CHAR(Z.Z_GL_PROCESS_DATE,'YYYYMMDD')||TRIM(TO_CHAR(Z.Z_GL_PROCESS_TIME,'099999'))) <= #PFE_Prior_GL_Run)
	      TO_NUMBER(TO_CHAR(Z.Z_GL_PROCESS_DATE,'YYYYMMDD')) <= #PFE_Prior_GL_Run)
 
      #endif
 
   #If {SITE_ID} = 'GE01'				!Tracker 895810
      [$SlctDetailbyI]                                  !Tracker 895810
   #Endif                                               !Tracker 895810
 
   #if {SITE_ID} = 'SQP1'
     [$SecurityClauseWithERN]       !select just the rows allowed.
   #endif
 
    ORDER BY I.EMPLID  
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
 #ifdef KJDA
   if (#Last_KJDA_Cnt > 0)
 
      #ifdef DEBUG_KJDA8
         display 'Write-KJDA-Taxes outside main payline loop'
         display ' Fica Gross ' noline
         display #Fica_Gross
       end-if
      #endif
 
    do Write-KJDA-Taxes
    let #Fica_Gross = 0           !Added: 1/3/2000
 
   end-if
 #endif
 
 if #Last_TaxBalance_Cnt > 0
   #ifdef EXCISE_DEDUCTION       
     do Get_excise_deduction        !in clients' probiz.sqc: \ADP_DEV_Extracts\custom\NXT1\1_25_2011_excc_ded_code
   #endif
   do Process-Tax-Record           !Output balances for this check date!
   let #Last_TaxBalance_Cnt = 0
 end-if
 
end-procedure
 
 
#ifdef BYPASS_FED_STOCK_OPTION_TAXES
 
begin-procedure Check-for-Stock-option-check
 
 let $Stock_option = ' '
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.23: ' $display_dt
 #endif
 
Begin-Select
PCSO.{chk}
 
 let $Stock_option = 't'
 
 from PS_PAY_CHECK PCSO
 where PCSO.COMPANY         = $Payline_Company
   AND PCSO.PAYGROUP        = $Payline_Paygroup
   AND PCSO.PAY_END_DT      = $Payline_Pay_End_Dt
   AND PCSO.OFF_CYCLE       = $Payline_Off_Cycle
   AND PCSO.{pg}            = #Payline_pagen
   AND PCSO.{ln}            = #Payline_linen
   AND PCSO.EMPLID          = $payline_emplid
 
   #if {SITE_ID} = 'FTO1'
    AND PCSO.{chk} = 9999999
   #endif
 
 #ifdef SELECT_WITH_UR
  with ur
 #end-if
end-select
end-procedure
 
#endif
 
 
begin-procedure Check-for-Reversal
 
 ! PAYCHECK_OPTION & Check and Advice
 ! PAYCHECK_OPTION A Advice
 ! PAYCHECK_OPTION C Check
 ! PAYCHECK_OPTION M Manual Check
 ! PAYCHECK_OPTION R Check Reversal
 
 ! PAYCHECK_STATUS A Adjusted
 ! PAYCHECK_STATUS C Calculated
 ! PAYCHECK_STATUS F Confirmed
 ! PAYCHECK_STATUS R Reversed
 ! PAYCHECK_STATUS V Reversing Check
 ! ------------------------------------------
 
 let $Check_Reversal = ' '
 let #PAYCHECK_NBR_rev     = ''
 let $PAYCHECK_OPTION_rev  = ''
 let $PAYCHECK_STATUS_rev  = ''
 let $PAYCHECK_DT_rev      = ''
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.24: ' $display_dt
 #endif
 
Begin-Select
PC.EMPLID
PC.PAYCHECK_NBR
PC.PAYCHECK_OPTION
PC.CHECK_DT
PC.PAYCHECK_STATUS
#if {SITE_ID} = 'GE01'
PC.GE_CONFIRMATION_DT
#endif
 
 let $Check_Reversal = 't'
 let #PAYCHECK_NBR_rev     = &PC.PAYCHECK_NBR
 let $PAYCHECK_OPTION_rev  = &PC.PAYCHECK_OPTION
 let $PAYCHECK_STATUS_rev  = &PC.PAYCHECK_STATUS
 let $PAYCHECK_DT_rev      = &PC.CHECK_DT

 #ifdef PAY_LINE_DEBUG 
  if {PAY_LINE_DEBUG} 
    show 'Check_Reversal emplid: ' &PC.EMPLID ', PAYCHECK_NBR_rev = ' #PAYCHECK_NBR_rev edit 999999999 ', option = ' $PAYCHECK_OPTION_rev ', status = ' $PAYCHECK_STATUS_rev ', rev check dt = ' $PAYCHECK_DT_rev
   end-if
 #endif
 
 from PS_PAY_CHECK PC
 where PC.COMPANY         = $Payline_Company
   AND PC.PAYGROUP        = $Payline_Paygroup
   AND PC.PAY_END_DT      = $Payline_Pay_End_Dt
   AND PC.OFF_CYCLE       = $Payline_Off_Cycle
   AND PC.{pg}            = #Payline_pagen
   AND PC.{ln}            = #Payline_linen
   AND PC.EMPLID          = $payline_emplid
 
  #if {SITE_ID} = 'GE01'
   AND PC.PAYCHECK_OPTION in ('R')                   !Reversal only
  #else
  ! Wells MC20547Q2 2011 custom begin
     #if {SITE_ID} = 'WFG1'
        AND PC.PAYCHECK_OPTION ='R' and PAYCHECK_STATUS = 'F'
     #else
  ! Wells MC20547Q2 2011 custom end
  ! AND PC.PAYCHECK_OPTION in ('A','R')                                              !See if it's a reversal or reversal adjustment
   AND (PC.PAYCHECK_OPTION = 'R' or PAYCHECK_STATUS = 'R' or PAYCHECK_STATUS = 'A')       !5/14/09 change logic to not see advice checks as adjustments
     #endif
  #endif
 
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 !if (round(#TXGRS_CUR,2) <> 0) or (round(#NLGRS_CUR,2) <> 0) or (round(#TAX_CUR,2) <> 0)
 !
 !  if $Check_Reversal = 't'
 !    display '<--- Check Reversal from seperate Quarter, Emplid '  noline
 !    print '<--- Check Reversal from seperate Quarter, Emplid '  (+2,1)
 !  else
 !    display '<--- Check Cross Over from seperate Quarter, Emplid '  noline
 !    print '<--- Check Cross Over from seperate Quarter, Emplid '  (+2,1)
 !  end-if
 !
 !  display $payline_emplid
 !  print   $payline_emplid ()
 !
 !  display '     Original (Payline) Check Date ' noline
 !  display $payline_check_dt
 !  display '     Changed to Liability (PayCalendar) Check Date ' noline
 !  display &A.CHECK_DT
 !  display '     Tax Amount     ' noline
 !  display #TAX_CUR
 !  display '     Taxable Wages  ' noline
 !  display #TXGRS_CUR
 !  display '     NLGross Wages  ' noline
 !  display #NLGRS_CUR
 !
 !  print '     Original (Payline) Check Date ' (+1,1)
 !  print $payline_check_dt ()
 !  print '     Changed to Liability (PayCalendar) Check Date: ' (+1,1)
 !  print &A.CHECK_DT ()
 !  print '     Tax Amount:     ' ()
 !  print #TAX_CUR                ()
 !  print '     Taxable Wages:  ' ()
 !  print #TXGRS_CUR              ()
 !  print '     NLGross Wages:  ' ()
 !  print #NLGRS_CUR              ()
 !
 !end-if
 
 
end-procedure
 
 
! 4/20/04 customization for Universal Studios
! -------------------------------------------
#if {SITE_ID} = 'GEC1'
begin-procedure get-Universal-studios-residual-check-dt
 
begin-select
FLSDT.M_FLS_DT
 
  let $Check_Date_Real = &FLSDT.M_FLS_DT
 
  FROM PS_M_FLS_DT_TBL FLSDT
    WHERE RUN_ID = $RunID
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
end-procedure
#endif
! -------------------------------------------
 
#ifndef CUSTOM_US_RUN_TAXES
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Process-US-Run-Taxes                              !
! Desc:      This procedure extracts an Employee's Tax Balance table   !
!            data.                                                     !
!----------------------------------------------------------------------!
begin-procedure Process-US-Run-Taxes
 
  let #Male_cnt = 0
  let #Female_cnt = 0
  let #cnt = 0

  #ifdef CUSTOM_EMPLOYMENT_TYPE
   if rtrim($Payline_Emplid,' ') <> rtrim($Payline_Emplid_prior_cust,' ')
     do Get-Custom-Employment_type !returns {CUSTOM_EMPLOYMENT_TYPE} (PEN) in $Paygroup_LLC_Field if a retiree
     let $Payline_Emplid_prior_cust = $Payline_Emplid
   end-if
  #endif
  
  #if {SITE_ID} = 'PRD1'
   if rtrim($Payline_Emplid,' ') <> rtrim($Payline_Emplid_prior_PRD1,' ')
    do Get-PRD1-Employment_type
    let $Payline_Emplid_prior_PRD1 = $Payline_Emplid
   end-if
  #endif
 
  #if {SITE_ID} = 'TLL1'
   #ifdef TOLL_FAIRLESS_HILLS_LOCATION
    #ifdef TOLL_FAIRLESS_HILLS_COMPID
     if rtrim($Payline_Emplid,' ') <> rtrim($Payline_Emplid_prior_toll,' ')
      do Get-Toll-Location
      let $Payline_Emplid_prior_toll = $Payline_Emplid
     end-if
    #endif
   #endif
  #endif
 
 
 #ifdef CALC_TOTAL_GROSS
   do calc-gross
 #endif
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.25 (process US Run Taxes): ' $display_dt
 #endif
 
 
begin-select
PT.STATE
PT.TAX_CLASS
PT.LOCALITY
PT.NLGRS_CUR
PT.TXGRS_CUR
PT.TAX_CUR
PT.TXGRS_AGG        !use for total gross for specs >= 3.00
PT.RESIDENT
PT.OFF_CYCLE
PT.SEPCHK
#ifdef KJDA          !11/6/01 for PJ's
PT.{pg}
PT.{ln}
#endif
#ifdef PAACT_32_11F_Logic
PT.RES_PSD_CD
PT.WORK_PSD_CD
#endif
 
   let $PT_State = rtrim(&PT.STATE,' ')
   let $PT_Locality = rtrim(&PT.LOCALITY,' ')
 
   let $PA_RES_Locality  = ''  
   let $PA_PSD_Locality  = ''  
   let $PA_Work_Locality = ''  
   let $PA_local = rtrim(&PT.LOCALITY,' ')
   let $PA_resid = &PT.RESIDENT
 
   !added 8/12/2011 to populate $PA_Taxcode for the PA Act 32 logic
   let $Trimmed_State          = rtrim(&PT.STATE,' ')
   let $Trimmed_Tax_Class      = rtrim(&PT.TAX_CLASS,' ')
   let $Trimmed_Locality       = rtrim(&PT.LOCALITY,' ')
   let $Trimmed_Resident       = &PT.RESIDENT

   do build-taxcode
    
   #ifdef PA_WORKSITE_EXTRACT
   
       if $PT_State = '{PA_STATE}' and &PT.TAX_CLASS = 'H'
         if $PA_local <> ''
           let $ADJUST_ZERO_LOCALS_PA_EIT = 'f'
           let $PA_Taxcode  = $Taxcode
           let $PA_Emplid   = $Payline_Emplid
           let $PA_Company  = $Payline_Company
           let $PA_State    = $PT_State
           let $PA_Class    = &PT.TAX_CLASS
           let $PA_end_date = $A_Check_Dt
           let #PA_txgrs    = &PT.TXGRS_CUR
           let #PA_taxes    = &PT.TAX_CUR
           #ifdef PAACT_32_11F_Logic
            let $RES_PSD_CD  = rtrim(&PT.RES_PSD_CD,' ')
            let $WORK_PSD_CD = rtrim(&PT.WORK_PSD_CD,' ')
           #endif
           do determine_pa_worksite !$PA_Emplid, $PA_Company, $PA_State, $PA_end_date  --> $PT_Locality
           #ifdef PA_WORKSITE_AUTO
             if $PA_Work_Locality <> ''
                let $PA_resid = ' '
                let $PT_Locality = $PA_Work_Locality
             end-if
           #else
              let $PT_State = $PA_Worksite_Location_code  !PFZ1
           #endif
           if $ADJUST_ZERO_LOCALS_PA_EIT = 't'  !skip the record if it has only PA EIT wages
             goto territory_memo_tax
           end-if
         end-if       
       end-if
   #endif
 
 
      
  !added 10/3/01 due to TaxUpdate E's memo taxes added for the territories
  !------------------------------------------------------------------------
  #ifndef PROCESS_TERRITORY_STATE_RECORDS
   let $State_check = rtrim($PT_State,' ')
   if length($State_check) <> 2
     #ifdef debug_us_territories
      display 'Message: Bypassing Pay_Tax Record: ' noline
      display $payline_company                      noline
      display ' '                                   noline
      display $payline_emplid                       noline
      display ' '                                   noline
      display $PT_State                             noline
      display &PT.TAX_CLASS                         noline
      display $PT_LOCALITY                          noline
      display ' --> Tax = '                         noline
      display &PT.TAX_CUR
     #endif
     add &PT.TAX_CUR to #Tax_Total_bypassed_territory
     goto territory_memo_tax
   end-if
  #endif
 
 
  #ifdef debug_pbz
    show ' '
    show ' New Record from the pay TAX table --->'
    show ' company  ' &I.COMPANY
    show ' paygroup ' &I.PAYGROUP
    show ' emplid   ' &I.EMPLID
    show ' page     ' &I.{pg}
    show ' line     ' &I.{ln}
    show ' offcyc   ' &I.OFF_CYCLE
    show ' payenddt ' &I.PAY_END_DT
    show ' Tot Grs  ' &PT.TXGRS_AGG
    show ' state    ' $PT_State
    show ' taxclass ' &PT.TAX_CLASS
  #endif
 
 let $Check_Reversal = ' '  !10/23/07 reset this each time through
 
 let #payline_sepchk = &PT.SEPCHK
 
 let #Nlgrs_cur = &PT.NLGRS_CUR
 let #Txgrs_cur = &PT.TXGRS_CUR
 let #Tax_cur   = &PT.TAX_CUR
 
 
 #if {Client_ID} = 'OSM1'
  if $PT_State = 'CA' and &PT.TAX_CLASS = 'D'        !calculate CAD taxes, not in PeopleSoft for OSM1
   do Get-CA-SDI-Rate  !in OSM1 probiz.sqc file
   let #Tax_cur   = #Txgrs_cur * #CA_SDI_Rate
  end-if
 #endif
 
 #if {SITE_ID} = 'CHS1'
  let $Paygroup_LLC_Field = ''
  if $PT_State = 'CT' and &PT.TAX_CLASS = 'U'        !Special logic in probiz.sqc for CT
   if rtrim($Payline_Emplid,' ') <> rtrim($Payline_Emplid_prior_CHS1,' ')
     let $CHS1_COMPANY   = $Payline_Company
     let $CHS1_PAYGROUP  = $Payline_Paygroup
     let $CHS1_EMPLID    = $Payline_Emplid
     let $CHS1_EFFDT     = $Payline_Pay_end_dt
     let #CHS1_empl_rcd  = #payline_empl_rcd
     let #CHS1_Tax       = #Tax_cur
     let #CHS1_Txgrs     = #Txgrs_cur
     let #CHS1_Nlgrs     = #Nlgrs_cur
     do get-CT-location-CHS1          !sets $CHS1_Tax_Location_cd, $Paygroup_LLC_Field
     let $Payline_Emplid_prior_CHS1 = $Payline_Emplid
   end-if
  end-if
 #endif

 #ifdef GENERAL_SUI_SPLIT_STATE
  let $Paygroup_LLC_Field = ''
  if ('{GENERAL_SUI_SPLIT_STATE}'     = '*' or $PT_State = '{GENERAL_SUI_SPLIT_STATE}') and 
     ('{GENERAL_SUI_SPLIT_TAX_CLASS}' = '*' or &PT.TAX_CLASS = 'U')
   if rtrim($Payline_Emplid,' ') <> rtrim($Payline_Emplid_prior_Gen_SUI_Split,' ')
     let $Gen_SUI_Split_COMPANY   = $Payline_Company
     let $Gen_SUI_Split_PAYGROUP  = $Payline_Paygroup
     let $Gen_SUI_Split_EMPLID    = $Payline_Emplid
     let $Gen_SUI_Split_EFFDT     = $Payline_Pay_end_dt
     let #Gen_SUI_Split_empl_rcd  = #payline_empl_rcd
     let #Gen_SUI_Split_Tax       = #Tax_cur
     let #Gen_SUI_Split_Txgrs     = #Txgrs_cur
     let #Gen_SUI_Split_Nlgrs     = #Nlgrs_cur
     do get-SUI-Split-Location          !sets $Gen_SUI_Split_Location, $Paygroup_LLC_Field
     let $Payline_Emplid_prior_Gen_SUI_Split = $Payline_Emplid
   end-if
  end-if
 #endif
 
 #ifndef CALC_TOTAL_GROSS
   let #Total_Gross = &PT.NLGRS_CUR    !Temp... maybe something else...9/12/03
 #endif
 
 !ignore fractions of pennies...
 !-------------------------------
 if (round(#TXGRS_CUR,2) <> 0) or (round(#NLGRS_CUR,2) <> 0) or (round(#TAX_CUR,2) <> 0)
 
  if $process_payline = 'f'
   Add #TAX_CUR   to #Company_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #Company_Txgrs_Previously_Extracted
   Add #TAX_CUR   to #Fein_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #Fein_Txgrs_Previously_Extracted
   Add #TAX_CUR   to #ADP_Compid_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #ADP_Compid_Txgrs_Previously_Extracted
   Add #TAX_CUR   to #Hash_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #Hash_Txgrs_Previously_Extracted
  else
 
  ! *********************************************************
  ! --------- Handle the Liability Date logic ---------------
  ! *********************************************************
 
  !Default to using check date for Payroll date
  !--------------------------------------------
  #ifdef USE_CHECK_DATE_FROM_CALENDAR_ALWAYS
    let $Check_Date_Real = rtrim($A_Check_Dt,' ')
 
    #if {SITE_ID} = 'WHS1'
     if &i.off_cycle = 'Y'
        do WEY-Get-Check-Date ($Check_Date_Real, $Check_Date_Real)
     end-if
    #endif
    
    !Universal Studios RESIDUAL Check date comes from a seperate table (see above)
    !-----------------------------------------------------------------------------
    #if {SITE_ID} = 'GEC1'
      if rtrim($PayLine_Paygroup,' ') = 'RES'
        do get-Universal-studios-residual-check-dt
      end-if
    #endif
 
    !--------------------------------------------------------------
    !12/16/02 ... added.this will bypass checks that would be tied
    ! to a check date before the live date.
    !--------------------------------------------------------------
    #ifdef LIVE_DATE_DTU
      Do Convert-to-DTU-Date($Check_Date_Real, $Check_Date_Real_DTU)
 
        #if {SITE_ID} <> 'SIE1'
           let $Live_Date_DTU = '{LIVE_DATE_DTU}'
        #else
          if rtrim($database,' ') = 'PROD8'
           let $Live_Date_DTU = '{LIVE_DATE_DTU_PROD8}'
          else
           let $Live_Date_DTU = '{LIVE_DATE_DTU_NOT_PROD8}'
          end-if
 
        #endif
 
        if $Check_Date_Real_DTU < $Live_Date_DTU
           Add #TAX_CUR   to #Hash_Taxes_Prior_to_Live_Date
           goto territory_memo_tax
        end-if
 
    #endif
 
    #ifdef DEAD_DATE_DTU
          Do Convert-to-DTU-Date($Check_Date_Real, $Check_Date_Real_DTU)
 
            #if {SITE_ID} <> 'SIE1'
               let $Dead_Date_DTU = '{DEAD_DATE_DTU}'
            #else
              if rtrim($database,' ') = 'PROD8'
               let $Dead_Date_DTU = '{DEAD_DATE_DTU_PROD8}'
              else
               let $Dead_Date_DTU = '{DEAD_DATE_DTU_NOT_PROD8}'
              end-if
 
            #endif
 
            if $Check_Date_Real_DTU > $Dead_Date_DTU
               Add #TAX_CUR   to #Hash_Taxes_After_Dead_Date
               goto territory_memo_tax
            end-if
 
    #endif
 
  #else
 
   if ($Payline_off_cycle <> 'Y') or ($payline_check_dt = '')
      #ifdef USE_CHECK_DATE_FROM_PAY_CHECK
        let $Check_Date_Real = $payline_check_dt
      #else
        let $Check_Date_Real = rtrim($A_Check_Dt,' ')
      #endif
   else
 
 
   do Check-for-Reversal
 
   if $Check_Reversal = 't'
 
    !----------------------------------------------------------------------------
    !if the payline's check date is from another quarter, set the liability date
    !to the pay calendar's check date if it is a REVERSAL!   If it's a reversal in
    !the same quarter, use the pay line check issue date.  Up to 7/7/05, the program
    !was setting the liability date to the calendar's date for all reversals.
    !----------------------------------------------------------------------------
 
    move $payline_check_dt to $Dt_in
    do Get-Quarter
    move #year_qtr to #Check_Year_Qtr_From_Pay_Line
    if (#Check_Year_Qtr_From_Pay_Line <> #Check_Year_Qtr_From_Pay_Calendar)
 
    !  #if {SITE_ID} = 'CWC1'
    !    let $Check_Date_Real = $AsOfToday              !  3/2/6
    !  #else
        let $Check_Date_Real = rtrim(&A.CHECK_DT,' ')  !  Reversals in other quarter... use calendar's check date
    !  #endif
 
      #if {SITE_ID} = 'WFG1'
        if &PC.PAYCHECK_OPTION = 'R'
            let $Check_Date_Real = rtrim($Job_Run_Date,' ')
        end-if
      #endif
 
      #ifdef debug_reversals
        show '*** Reversal check, using calendar check date ' $Check_Date_Real
      #endif
 
    else
        let $Check_Date_Real = $payline_check_dt              ! 5/28/02 always pay issue date
    end-if
 
    #if {SITE_ID} = 'PFZ1'
        if &PC.PAYCHECK_OPTION = 'R'
            let $Check_Date_Real = rtrim(&A.CHECK_DT,' ')  !  Always use calendar's check date for reversals
        end-if
    #endif
    
 
    #if {SITE_ID} = 'HWL1'
 
      let $Check_Date_Real = $payline_check_dt              ! 5/28/02 always pay issue date
 
      move $payline_check_dt to $Dt_in
      do Get-Quarter
      move #year_qtr to #Check_Year_Qtr_From_Pay_Line
      move #year_out to #Check_Year_From_Pay_Line
 
      !cross year, use last day of prior year if sysdate is > pay line date
      !----------------------------------------------------
      if #Check_Year_From_sysdate > #Check_Year_From_Pay_Line
        move #Check_Year_From_Pay_Line to $Check_Year_From_Pay_Line 9999
        let $Check_Date_Real = '31-DEC-' || $Check_Year_From_Pay_Line  !last day of prior year
      end-if
 
      !same year, use sysdate if sysdate is > pay line date
      !----------------------------------------------------
      if #Check_Year_From_sysdate = #Check_Year_From_Pay_Line
        do Convert-To-DTU-Date($AsofToday, $sysdate_DTU)                        !changed from sysdate 12/31/08
        do Convert-To-DTU-Date($payline_check_dt, $payline_check_dt_DTU)
        if $sysdate_DTU > $payline_check_dt_DTU
           let $Check_Date_Real = $AsofToday                                    !changed from sysdate 12/31/08
        end-if
      end-if
 
    #endif
 
    !no matter what.... set the reversal  liabilties to today
    !--------------------------------------------------------
     #ifdef REVERSALS_FORCE_CHECK_DATES_TO_TODAY
        show '*** REVERSALS_FORCE_CHECK_DATES_TO_TODAY: Reversal check,  Emplid ' $Payline_emplid ' ' $Check_Date_Real ' --> ' $AsofToday
        move $AsofToday to $Check_Date_Real
     #endif
    
   else
 
    !------------------------------------------------------------
    !Get the Quarter that the Check date is in, from the pay line
    !------------------------------------------------------------
    move $payline_check_dt to $Dt_in
    do Get-Quarter
    move #year_qtr to #Check_Year_Qtr_From_Pay_Line
 
    if (#Check_Year_Qtr_From_Pay_Line <> #Check_Year_Qtr_From_Pay_Calendar)
 
     #if {SITE_ID} = 'WFG1'
           !wells - mc07647 - begin - override check date with JRD
           !wells -  when across quarters
           let $Check_Date_Real = rtrim($Job_Run_Date,' ')
     #else
          #ifdef USE_CHECK_DATE_FROM_PAY_CHECK
           let $Check_Date_Real = $payline_check_dt
          #else
           let $Check_Date_Real = rtrim($A_Check_Dt,' ')         !  Reversals or Off-cycles, set liab date to calendar check date
          #endif
     #endif
 
    else
     let $Check_Date_Real = $payline_check_dt                !  Otherwise use payline's check date
    end-if
   end-if
   !9/15/98 to allow usage of pay end date for check date too
   !---------------------------------------------------------
   #ifdef USE_PAY_END_DT
       let $Check_Date_Real = $payline_pay_end_dt
   #endif
   end-if
  #endif
 
  #if {SITE_ID} = 'CSB1'
   do CSB1-Liab-date
  #endif
 
  #if {SITE_ID} = 'RSS1'
   do RSS1-Liab-date
  #endif
  
  #if {SITE_ID} = 'TDB2'
    do TDB2-liab-date
  #endif
 
  #if {SITE_ID} = 'MDT1'
     if ($Payline_off_cycle = 'Y')
         do Check-for-Reversal
         !if ($Check_Reversal = 't')  ! 9/23/09, changed to :   PAYCHECK_OPTION = 'R'
         if &PC.PAYCHECK_OPTION = 'R'
           move $Check_Date_Real to $orig_Check_Date_Real
           Do Convert-to-DTU-Date($AsofToday,       $cur_dt_DTU)
           do dtu-add-days($cur_dt_DTU, 1, $Check_Date_Forced_DTU)
           do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Real)
           show 'MDT1: off-cycle PAYCHECK_OPTION = R, check date adjusted. From ' $orig_Check_Date_Real ' to ' $Check_Date_Real
         end-if
     end-if
  #endif
 
  #ifdef FORCE_OLD_CHECK_DATES_TO_FUTURE
    Do Convert-to-DTU-Date($AsofToday,       $cur_dt_DTU)
    Do Convert-to-DTU-Date($Check_Date_Real, $chk_dt_DTU)
 
    !if check date is in the past, set it future
    !-------------------------------------------------------
    !KMT1, custom check on days
    #if {SITE_ID} ='KMT1'
      do dtu-add-days($cur_dt_DTU, {DAYS_INTO_FUTURE}, $K_Check_Date_Forced_DTU)
      if $K_Check_Date_Forced_DTU > $chk_dt_DTU and  &I.OFF_CYCLE  = 'Y'
    #else
      #if {SITE_ID} ='SRC1'
        do dtu-add-days($cur_dt_DTU, {DAYS_INTO_FUTURE}, $K_Check_Date_Forced_DTU)
        if $K_Check_Date_Forced_DTU > $chk_dt_DTU and  &I.OFF_CYCLE  = 'Y'
      #else
        #if {SITE_ID} = 'USB1'
         if &I.OFF_CYCLE  = 'Y'                !any off-cycle, force it to tomorrows' date
        #else
         #if {SITE_ID} ='PFZ1'       !kymonl 9898-56
	    if $cur_dt_DTU >= $chk_dt_DTU !kymonl 9898-56
        #else
         if $cur_dt_DTU > $chk_dt_DTU
        #endif
        #endif
      #endif
    #endif
   
    
      !------------------------------------------------------------------------------
      ! Mods for Pfizer (PNU/WL) by ssedwa 01.16.2004 -
      ! Received these new requirements from Pat Blocker:
      !
      ! 1. If the check date is in the past and the check date is not in the current
      !    year, then leave the check date alone.
      ! 2. If the check date is in the past and the check date is in the current
      !    year, then override the check date to be today's date plus one business
      !    day.  Days listed in the Pfizer holiday calendar and weekends are NOT
      !    considered business days, so the new check date should never land on one
      !    of those days.
      !
      ! NOTE: Created new procedure Ensure-Valid-Check-Dt (stored in validcdt.sqc)
      !       to ensure the check date does not fall on a weekend or Pfizer holiday.
      !------------------------------------------------------------------------------
      #ifdef VALIDATE_CHECK_DATE   !for PFE (PNU/WL) 2/25/04 for now
	do DTU-Parse-Date($cur_dt_DTU,#cur_dt_DTU_yr,#cur_dt_DTU_mm,#cur_dt_DTU_dd)
	do DTU-Parse-Date($chk_dt_DTU,#chk_dt_DTU_yr,#chk_dt_DTU_mm,#chk_dt_DTU_dd)
      if #cur_dt_DTU_yr = #chk_dt_DTU_yr
          do dtu-add-days($cur_dt_DTU, {DAYS_INTO_FUTURE}, $Check_Date_Real_DTU)
          do Ensure-Valid-Check-Dt($Payline_Company, $Payline_Paygroup, $Check_Date_Real_DTU, $Valid_Check_Date_Real_DTU)
          let $Check_Date_Real_DTU = $Valid_Check_Date_Real_DTU
          do Convert-From-DTU-Date($Check_Date_Real_DTU, $Check_Date_Real)
  !        show ' '
  !        show ' Changing PAST Liability Date:'
  !        show ' from     ' $chk_dt_DTU
  !        show ' to       ' $Check_Date_Real_DTU
  !        show ' company  ' &I.COMPANY
  !        show ' paygroup ' &I.PAYGROUP
  !        show ' emplid   ' &I.EMPLID
  !        show ' page     ' &I.{pg}
  !        show ' line     ' &I.{ln}
  !        show ' offcyc   ' &I.OFF_CYCLE
  !        show ' payenddt ' &I.PAY_END_DT
	else
  !	    show ' '
  !	    show ' NOT Changing PAST Liability Date Due to Different Check & Current Year:'
  !	    show ' chk dt   ' $chk_dt_DTU
  !	    show ' cur dt   ' $cur_dt_DTU
  !       show ' company  ' &I.COMPANY
  !       show ' paygroup ' &I.PAYGROUP
  !       show ' emplid   ' &I.EMPLID
  !       show ' page     ' &I.{pg}
  !       show ' line     ' &I.{ln}
  !       show ' offcyc   ' &I.OFF_CYCLE
  !        show ' payenddt ' &I.PAY_END_DT
	end-if
      #else
        do dtu-add-days($cur_dt_DTU, {DAYS_INTO_FUTURE}, $Check_Date_Forced_DTU)
        do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Forced)
      #endif
 
     #ifdef RHI_CORP   !4/24/2012 section added
      show ' RHI_CORP: Changing PAST Liability Date: Emplid: ' &I.EMPLID ' Pay_End_dt: ' &I.PAY_END_DT ' from ' $Check_Date_Real ' to ' $Check_Date_Forced
      move $Check_Date_Forced to $Check_Date_Real
     #else
      !added this check on 2/1/03 for Rouse, to make sure we don't force a date
      !that is in a different qtr than the original check date
      !-------------------------------------------------------------------------
      move $Check_Date_Forced to $Dt_in
      do Get-Quarter
      move #year_qtr to #Check_Year_Qtr_Forced
 
      move $Check_Date_Real to $Dt_in
      do Get-Quarter
      move #year_qtr to #Check_Year_Qtr_Real
 
      if (#Check_Year_Qtr_Real = #Check_Year_Qtr_Forced)
        show ' '
        show ' Changing PAST Liability Date: Emplid: ' &I.EMPLID ' Pay_End_dt: ' &I.PAY_END_DT ' from ' $Check_Date_Real ' to ' $Check_Date_Forced
        move $Check_Date_Forced to $Check_Date_Real
      else
        show ' '
        show ' Can Not Change PAST Liability Date: Emplid: ' &I.EMPLID ' Pay_End_dt: ' &I.PAY_END_DT ' from ' $Check_Date_Real ' to ' $Check_Date_Forced
        show '  because the forced date is in a different quarter than the original check date'
      end-if
     #endif
    end-if
  #endif
 
  !6/20/06..    !on cycles will use the calendars' check date, off cycles use payline issue date always
  #if {SITE_ID} = 'AMP1'
   if ($Payline_off_cycle <> 'Y') or ($payline_check_dt = '')
       let $Check_Date_Real = rtrim($A_Check_Dt,' ')            ! <-- oncycles use calendars check date
   else
     #ifdef USE_CHECK_DATE_FROM_PAY_CHECK
       let $Check_Date_Real = $payline_check_dt              
     #else
       let $Check_Date_Real = $payline_pay_end_dt               ! <-- otherwise, use the paylines check date
     #endif
   end-if
  #endif
 
  !10/1/07
  !--------
  #if {SITE_ID} = 'GE01'
   if ($Payline_off_cycle <> 'Y') or ($payline_check_dt = '')
       let $Check_Date_Real = rtrim($A_Check_Dt,' ')            ! <-- oncycles use calendars check date
   else
     #ifdef USE_CHECK_DATE_FROM_PAY_CHECK
       let $Check_Date_Real = $payline_check_dt              
     
       !if #GE_check_count < 10
       !  show 'GE: USE_CHECK_DATE_FROM_PAY_CHECK, using off cycle check date ' $payline_check_dt
       !  add 1 to #GE_check_count
       !end-if
       
     #else
       let $Check_Date_Real = $payline_pay_end_dt               ! <-- otherwise, use the paylines check date
     #endif
 
     do Check-for-Reversal
 
     if $Check_Reversal = 't'
       let $Check_Date_Real = &PC.GE_CONFIRMATION_DT        
       #ifdef debug_GE
        show ' '
        show 'GE: reversal, GE confirmation date = ' $Check_Date_Real ', pc_status:' &PC.PAYCHECK_STATUS ', pc_option:' &PC.PAYCHECK_OPTION
        show ' company:' &I.COMPANY ', paygroup:' &I.PAYGROUP ', pay_end_dt:' &I.PAY_END_DT ', emplid:' &I.EMPLID ', page:' &I.{pg} ', line:' &I.{ln} ', offcyc:' &I.OFF_CYCLE
       #endif
     end-if
   
   end-if
   
  #endif
 
 
  ! FHL1  off-cycles us payline's check date, except for reversals which use check date from calendar
  ! --------------------------------------------------------------------------------------------------------
  #if {SITE_ID} = 'FHL1'
   if ($Payline_off_cycle <> 'Y') or ($payline_check_dt = '')
       let $Check_Date_Real = rtrim($A_Check_Dt,' ')            ! <-- oncycles use calendars check date
   else
     let $Check_Date_Real = $payline_check_dt              
     do Check-for-Reversal
 
     if $Check_Reversal = 't'
       let $Check_Date_Real = rtrim($A_Check_Dt,' ')      
       show 'FHL1: reversal, confirmation date = ' $Check_Date_Real
     end-if
   
   end-if
  #endif
 
  #if {SITE_ID} = 'RDS1'
    do radio-shack-liab-date
  #endif
 
 
  !2/7/7 added for Circuit City
  !----------------------------
  #ifdef SET_CREDIT_DATE_TO_TODAY
    if #TAX_CUR < 0 and &PT.TAX_CLASS <> 'C'  !3/9/10 added the check for EIC . as these are negative normally
      show ''
      show ' Changing Pay_Line CREDIT Liability Date, for emplid: ' &I.EMPLID ' from ' $Check_Date_Real ' to ' $AsofToday
      show '  Company  ' &I.COMPANY
      show '  Paygroup ' &I.PAYGROUP
      show '  Page     ' &I.{pg}
      show '  Line     ' &I.{ln}
      show '  Offcyc   ' &I.OFF_CYCLE
      show '  Payenddt ' &I.PAY_END_DT
      show '  State    ' $PT_State
      show '  Taxclass ' &PT.TAX_CLASS
      show '  Locality ' $PT_LOCALITY 
      show '  Tax_cur  ' #TAX_CUR
 
      move $AsofToday to $Check_Date_Real
 
     show ''
    end-if
  #endif
 
  #if {SITE_ID} = 'MCK1'
   if ($Payline_off_cycle = 'Y')
      move $payline_check_dt to $Check_Date_Real
      do Check-for-Reversal
       do Format-DateTime($payline_check_dt,$payline_check_dt_CMP,{DEFCMP},'','')
       show 'MCK Off-cycle: payline_check_dt_CMP = ' $payline_check_dt_CMP ', Run_Dt_CMP = ' $Run_Dt_CMP
       if $payline_check_dt_CMP <= $Run_Dt_CMP
        move $Today_Plus1 to $Check_Date_Real
        show '***PayLine Past Off-Cycle Check Date ' $payline_check_dt ' passed as ' $Today_Plus1 ' for Emplid ' &I.EMPLID ' in Company ' &I.COMPANY ', pc_option:' &PC.PAYCHECK_OPTION
        #ifdef OFF_CYCLE_DETAIL_PRINT
         do populate-off-cycle-detail
        #endif
      end-if    
   end-if
  #endif
  
   #ifdef CUSTOM_PERIODIC_CHECK_DATE_LOGIC_ENABLED
     do custom-check-date-logic                             !in probiz.sqc 
     if $Check_Date_Real = ''
       goto territory_memo_tax   !this is a way to flag data that should not be processed.
     end-if
   #endif
 
 ! *********************************************************
 
  let $Trimmed_Tax_Class = rtrim(&PT.TAX_CLASS,' ')
  let $Trimmed_State     = rtrim($PT_State,' ')
  let $Trimmed_Locality  = rtrim($PT_LOCALITY,' ')
 
 
  #if {SITE_ID} = 'KFC_OLD'
    let $KForce_Tax_Class = rtrim(&PT.TAX_CLASS,' ')
    let $KForce_State     = rtrim($PT_State,' ')
    let $year = substr($asoftoday,8,4)
    let #year = to_number($year)
    move $Payline_emplid to $Kforce_emplid
    do Handle-KForce-Split                  !in adp_tax_split.sqc, returns $KForce_Group: M-Main, S-CA/Staffing, F-Flex, C-Core
    move $KForce_Group to $Paygroup_LLC_Field
    evaluate $KForce_Group
      when = 'F'
         Add #TAX_CUR to #Hash_Total_Tax_KFORCE_F
         break
      when = 'C'
         Add #TAX_CUR to #Hash_Total_Tax_KFORCE_C
         break
      when = 'M'
         Add #TAX_CUR to #Hash_Total_Tax_KFORCE_M
         break
      when = 'S'
         Add #TAX_CUR to #Hash_Total_Tax_KFORCE_S
         break
      when-other
         break
    end-evaluate
  #endif
 
  #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
     do CSE1-Handle-Pensioners-Fica-Med   !added 2/21/10 routine in clients probiz.sqc
     move $CSE1_remap to $Paygroup_LLC_Field
  #endif
 
  #if {SITE_ID} = 'FTO1'
    do Handle-Farmers-and-Pensioners-943 !remaps to different company and remaps Fed taxcodes
  #endif
 
 
  #if {SITE_ID} = 'FRB1'               ! 11/30/01 changes per Dennis
    if ($Payline_Company = '10J')
      if ($Trimmed_Locality = '20000') AND ($Trimmed_State = 'CO') AND ($Trimmed_Tax_Class = 'H')
        move '20000-E' to $Trimmed_Locality        ! Exempt locality code
      end-if
    end-if
  #endif
 
  !------------------------------------------------------------------------------------------
  !STANDARD LOGIC for RESIDENT: we want to ignore the resident code unless it is associated with a non blank locality code
  !------------------------------------------------------------------------------------------
  if $Trimmed_Locality <> ''
      let $Trimmed_Resident = $PA_resid
    else
      let $Trimmed_Resident = ' '
    end-if
 
  #ifdef KJDA
    if (($Trimmed_Tax_Class = 'F') AND ($Trimmed_State = '$U'))
       do process-fica-gross
    end-if
  #endif
 
  #ifdef IGNORE_TIPS_TAX_CLASSES
   if ($Trimmed_State = '$U') and (($Trimmed_Tax_Class = 'G') OR ($Trimmed_Tax_Class = 'J') OR ($Trimmed_Tax_Class = 'T') OR ($Trimmed_Tax_Class = 'Z'))
     let $Tax_Proceed = 'f'
   end-if
  #endif
  
  !--------------------------------------------------------------------
  !If tips, remap the tax class to one of the OASDI or Medicare classes
  !--------------------------------------------------------------------
  #ifdef TIPS_ROLLUP
    if (($Trimmed_Tax_Class = 'G') AND ($Trimmed_State = '$U'))
          !OASDI TIPS EE goes into FICA OASDI BIN --> $UD Bin
          !---------------------------------------------------
          move 'D' to $Trimmed_Tax_Class
          Add #TXGRS_CUR to #OASDI_Tips_Wages_Tot_EE
          Add #TAX_CUR to #OASDI_Tips_Taxes_Tot_EE
    end-if
 
 
    if (($Trimmed_Tax_Class = 'J') AND ($Trimmed_State = '$U'))
            !OASDI TIPS ER goes into FICA OASDI BIN --> $UE Bin
            !---------------------------------------------------
            move 'E' to $Trimmed_Tax_Class
            Add #TXGRS_CUR to #OASDI_Tips_Wages_Tot_ER
            Add #TAX_CUR to #OASDI_Tips_Taxes_Tot_ER
    end-if
 
    if (($Trimmed_Tax_Class = 'T') AND ($Trimmed_State = '$U'))
          !Medicare TIPS EE goes into FICA OASDI BIN --> $UF Bin
          !---------------------------------------------------
          move 'F' to $Trimmed_Tax_Class
          Add #TXGRS_CUR to #MEDIC_Tips_Wages_Tot_EE
          Add #TAX_CUR to #MEDIC_Tips_Taxes_Tot_EE
    end-if
 
    if (($Trimmed_Tax_Class = 'Z') AND ($Trimmed_State = '$U'))
            !Medicare TIPS ER goes into FICA OASDI BIN --> $UQ Bin
            !---------------------------------------------------
            move 'Q' to $Trimmed_Tax_Class
            Add #TXGRS_CUR to #MEDIC_Tips_Wages_Tot_ER
            Add #TAX_CUR to #MEDIC_Tips_Taxes_Tot_ER
    end-if
  #endif
 
 
 !11/10/98 Papa Johns - breakout KJDA Taxes if necessary
 !------------------------------------------------------
 let $process_kjda_tax = 'f'
 #ifdef KJDA
    if ($Trimmed_State = 'KY') and ($Trimmed_Tax_Class = 'H')
      let $loc = $Trimmed_Locality
      let $last_resident_code = $Trimmed_Resident
      do process-kjda-taxes
   end-if
 #endif
 
 if ($process_kjda_tax = 'f')
 
  !see if we should bypass this tax (ie. IGNORE_FUI, IGNORE_NYD,....)
  !------------------------------------------------------------------
  #ifdef OHIO_COURTESY_WITHHOLDING   
     do Ohio-Courtesy-withholding-Periodic
  #endif     
   
  do Build-Taxcode
  let $Trimmed_TaxCode  = rtrim($Taxcode,' ')
  let $Trimmed_Company  = $PayLine_Company
  let #Tax_Cur          = &PT.TAX_CUR
  do Check-before-processing-tax
 
  #ifdef TAX_CLASS_REPORT
    do Process-TAX_CLASS_REPORT
  #endif
 
  if $Tax_Proceed = 't'
 
    !Now, we can update the TaxBalance array, as this is a valid tax to process
    !--------------------------------------------------------------------------
    let $ER_Generated = 'f'
 
 
    #ifdef GET_BALANCE_ADJUSTMENTS
      #ifdef EMPLID_BALANCE_ADJUSTMENTS
       show 'calling Get-Current-Adj-Data...'
       do Get-Current-Adj-Data
      #endif
    #endif
 
    do Write-to-TaxBalances
 
    #ifdef GENERATE_EMPLOYEE_DETAIL
 
      Do Convert-to-DTU-Date($Check_Date_Real,$Check_Date_Real_DTU)
 
      let $Mo    = substr($Check_Date_Real_DTU,6,2)
      let $Day   = substr($Check_Date_Real_DTU,9,2)
      let $Yr    = substr($Check_Date_Real_DTU,1,4)
      let $chk_dtu = $Yr || $Mo || $Day
 
      do Generate-employee-details
 
 
    #endif
 
    !Do we need to generate ER matching tax record too?
    !--------------------------------------------------
    do Check-for-ER-Generated-Tax
    if $Need_to_Generate_ER_Tax = 't'
 
        let $ER_Generated = 't'
        do Write-to-TaxBalances
 
        #ifdef GENERATE_EMPLOYEE_DETAIL
          let $Taxcode = $Repeat_TaxCode
          do Generate-employee-details
        #endif
 
     end-if  !end-if <-- $Need_to_Generate_ER_Tax = 't'
    end-if  !end-if <-- $Tax Proceed = 't'
   end-if  !end-if <-- $process_kjda_tax = 'f
  end-if  !end-if <-- $process_payline <> 'f'
 end-if  !end-if <-- taxes,gross,taxable not all 0
 
territory_memo_tax:
 
 from PS_PAY_TAX PT
  WHERE PT.COMPANY    = $PayLine_Company     AND
        PT.PAYGROUP   = $PayLine_Paygroup    AND
        PT.{pg}       = #PayLine_pagen       AND
        PT.{ln}       = #PayLine_linen       AND
        PT.OFF_CYCLE  = $PayLine_Off_Cycle   AND
        PT.PAY_END_DT = $PayLine_pay_end_dt
	#If {SITE_ID} = 'GE01'				!Tracker 895810
	[$SlctDetailbyPT]                               !Tracker 895810
	#Endif                                          !Tracker 895810
 
 
  #if {SITE_ID} = 'ACS1'
     ORDER BY PT.OFF_CYCLE, PT.STATE, PT.TAX_CLASS, PT.LOCALITY
  #else
     ORDER BY PT.STATE, PT.TAX_CLASS, PT.LOCALITY
  #endif
  
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure

#endif

#if {SITE_ID} = 'TDB2'
begin-procedure TDB2-liab-date
      if ($Payline_off_cycle = 'Y')
        do Check-for-Reversal
        if ($Check_Reversal = 't')
           let $Check_Date_Real = rtrim($A_Check_Dt,' ')        
           show 'TDB2: off-cycle reversal (uses Calendars CHECK_DT) Payline check date adjusted. ' &I.EMPLID ' From ' $payline_check_dt ' --> ' $Check_Date_Real
        else
           move $payline_check_dt to $Dt_in
           do Get-Quarter
           move #year_qtr to #payline_check_dt_Year_Qtr
 
           move $A_Check_Dt to $Dt_in
           do Get-Quarter
           move #year_qtr to #Check_Year_Qtr_Real
 
           if (#Check_Year_Qtr_Real = #payline_check_dt_Year_Qtr)
            let $Check_Date_Real = $payline_check_dt
            show 'TDB2: off-cycle check (same quarter, uses Pay Lines CHECK_DT) ' &I.EMPLID ' --> ' $Check_Date_Real
           else
            let $Check_Date_Real = rtrim($A_Check_Dt,' ')        
            show 'TDB2: off-cycle check (different quarter, uses Calendars CHECK_DT) ' &I.EMPLID ' --> ' $Check_Date_Real
           end-if
        end-if
      end-if
end-procedure
#endif
 
#if {SITE_ID} = 'RSS1'
 
begin-procedure RSS1-liab-date
 
  let $Check_Date_Real = $A_Check_Dt
 
BEGIN-SELECT 
RSS1B.ERNCD
 
  show 'RSS1: Stock Option check ' $Payline_emplid ' , ERNCD = ' &RSS1B.ERNCD ', payline_check_dt = ' $payline_check_dt
  let $Check_Date_Real = $payline_check_dt     
  
  if $Payline_emplid <> $RSS1_Prior_Payline_emplid
    add 1 to #RSS1_Stock_option_count
    move $Payline_emplid to $RSS1_Prior_Payline_emplid
  end-if
  
  FROM  PS_PAY_OTH_EARNS RSS1B
  WHERE RSS1B.COMPANY    = $PayLine_Company
    AND RSS1B.PAYGROUP   = $PayLine_Paygroup
    AND RSS1B.PAY_END_DT = $PayLine_pay_end_dt
    AND RSS1B.OFF_CYCLE  = $PayLine_Off_Cycle
    AND RSS1B.PAGE_NUM   = #PayLine_pagen
    AND RSS1B.LINE_NUM   = #PayLine_linen
    AND RSS1B.ERNCD      IN ('STK','RST','RSV','RSR') ! RSS1 add an additional earning code to the 'Stock' earning codes RSV

#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-procedure
 
#endif
 
 
#if {SITE_ID} = 'CSB1'
 
begin-procedure CSB1-liab-date
 
   if ($Payline_off_cycle = 'Y')
     show ' '
     let $Check_Date_Real = $payline_check_dt      !10/14/09, this was payline_pay_end_dt  (hasn't been sent to CSB1 yet)
     
     !if ($payline_pay_end_dt = &A.PAY_END_DT)
     !  show 'CSB1: off to on-cycle with pay end date matching calendar pay end date'
     !  show '      Company:' &I.COMPANY ', pay_end_dt: ' &A.PAY_END_DT ', emplid: ' &I.EMPLID ', page: ' &I.{pg} ', line: ' &I.{ln} ' using PayCal.Check_Dt: ' $A_Check_Dt
     !  let $Check_Date_Real = rtrim($A_Check_Dt,' ')         
     !else
 
     do Check-for-Reversal
     if ($Check_Reversal = 't')
       do CSB1-move-reversal-date
     end-if
     
     !end-if
 
     !make sure the new date is in the same quarter as the calendar's check date
     !-----------------------------------------------------------------------------
     move $Check_Date_Real to $Dt_in    
     do Get-Quarter
     move #year_qtr to #Check_Year_Qtr_Calced_for_CSB1
     if (#Check_Year_Qtr_Calced_for_CSB1 <> #Check_Year_Qtr_From_Pay_Calendar)
      show 'CSB1: Cross Quearter logic: ' $Check_Date_Real  ' Q:' #Check_Year_Qtr_Calced_for_CSB1 ', moved to Calendars check date: ' $A_Check_Dt ' Q:' #Check_Year_Qtr_From_Pay_Calendar
      let $Check_Date_Real = rtrim($A_Check_Dt,' ')         
     end-if
 
     show 'CSB1: Check date off-cycle logic Company:' &I.COMPANY ', payline_check_dt: ' $payline_check_dt ', emplid: ' &I.EMPLID ', page: ' &I.{pg} ', line: ' &I.{ln} ', rev ' $Check_Reversal ' --> liab date = ' $Check_Date_Real
 
   else
    let $Check_Date_Real = rtrim($A_Check_Dt,' ')         
   end-if
 
end-procedure
 
begin-procedure CSB1-move-reversal-date                  !bump it out one day... or to beginning of next week (monday)
 
  move $Check_Date_Real to $orig_Check_Date_Real
  move $AsOfToday       to $Check_Date_Real
 
  Do Convert-to-DTU-Date($Check_Date_Real, $chk_dt_DTU)
  do dtu-add-days($chk_dt_DTU, 1, $Check_Date_Real_DTU)
  do Convert-From-DTU-Date($Check_Date_Real_DTU, $Check_Date_Real)
  let #dayofweek = datetostr(strtodate($Check_Date_Real,'DD-MON-YYYY'),'D') !Sunday(1)..Saturday(7)  move it to monday
 
  do CSB1-check-for-holiday
  show 'CSB1: off-cycle reversal check date calced ' $Check_Date_Real ' Check_Date_Real_DTU ' $Check_Date_Real_DTU ' day of week = ' #dayofweek ' AsOfToday = ' $AsOfToday ' holiday = ' $holiday
  
  if (#dayofweek = 1 or #dayofweek = 7 or $holiday = 't') !generate a new date if saturday or sunday or holiday
   let #day_count = 0
   while #day_count < 7
     Do Convert-to-DTU-Date($Check_Date_Real, $chk_dt_DTU)
     do dtu-add-days($chk_dt_DTU, 1, $Check_Date_Real_DTU)
     do Convert-From-DTU-Date($Check_Date_Real_DTU, $Check_Date_Real)
     let #dayofweek = datetostr(strtodate($Check_Date_Real,'DD-MON-YYYY'),'D') 
 
     do CSB1-check-for-holiday
 
     show 'CSB1: off-cycle reversal check date: ' #day_count ', dayofweek = ' #dayofweek ', Check_Date_Real = ' $Check_Date_Real ' holiday = ' $holiday
     if (#dayofweek >= 2 and #dayofweek <= 6) and $holiday <> 't'  !stop when we have a monday..friday date that is not a holiday
       break
     end-if
     add 1 to #day_count
   end-while
  end-if
  
  show 'CSB1: off-cycle reversal check date adjusted from ' $orig_Check_Date_Real ' to ' $Check_Date_Real ' day of week = ' #dayofweek ' AsOfToday = ' $AsOfToday
  
end-procedure
 
begin-procedure CSB1-check-for-holiday
 
  let $holiday = 'f'
 
  if $payline_company = 'BNK'
    let $Holiday_schedule = 'BNK'
  else
    let $Holiday_schedule = 'SCH'
  end-if
  
begin-select
HOL.HOLIDAY
 
 let $holiday = 't'
 
 FROM PS_HOLIDAY_DATE HOL
   WHERE HOL.HOLIDAY_SCHEDULE = $Holiday_schedule
    AND  HOL.HOLIDAY = $Check_Date_Real
    
end-select
 
end-procedure
#endif
 
 
#if {SITE_ID} = 'RDS1'
 
begin-procedure radio-shack-liab-date
 
 
  !1/20/8, always use todays date + 2 for Radio Shack
  !---------------------------------------------------
  
      !Start out by adding 2 days to system date
      !-----------------------------------------
      move $AsOfToday to $AsOfToday_Virtual
      #ifdef RDS1_TEST_SYSDATE  !eg. 30-Jun-2008
        let $AsOfToday_Virtual = '{RDS1_TEST_SYSDATE}'
        if #first_date_generated = 0
          show 'Testing Sysdate = ' $AsOfToday_Virtual
        end-if
      #endif
 
      Do Convert-to-DTU-Date($AsofToday_virtual, $cur_dt_DTU)
      Do dtu-add-days($cur_dt_DTU, 2, $Check_Date_Forced_DTU)
      Do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Forced)
      move $Check_Date_Forced to $Check_Date_Real
      
      !1/21/08 added.. skip to day 2 (Monday) if we generate a liability date on saturday or sunday
      !--------------------------------------------------------------------------------------------
      let #dayofweek = datetostr(strtodate($Check_Date_Real,'DD-MON-YYYY'),'D') !Sunday(1)..Saturday(7)
      if #first_date_generated = 0
        show 'RDS1,             AsOfToday date       = ' $AsofToday_virtual
        show 'RDS1, prelim liability day of week     = ' #dayofweek ', date: ' $Check_Date_Real
        show 'RDS1              Off cycle            = ' $Payline_off_cycle
      end-if
 
      !1/22/08 - Friday Off-Cycle will move out to Tuesday
      !-------------------------------------------------------
      if ($Payline_off_cycle = 'Y') and (#dayofweek = 1)  !off cycle friday.. move to Tuesday (add 4 days)
          Do Convert-to-DTU-Date($AsofToday_virtual, $cur_dt_DTU)
          Do dtu-add-days($cur_dt_DTU, 4, $Check_Date_Forced_DTU)
          Do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Forced)
          move $Check_Date_Forced to $Check_Date_Real
      
      else
      
        if #dayofweek = 7  !Saturday.. move it to monday
          Do Convert-to-DTU-Date($AsofToday_virtual, $cur_dt_DTU)
          Do dtu-add-days($cur_dt_DTU, 4, $Check_Date_Forced_DTU)
          Do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Forced)
          move $Check_Date_Forced to $Check_Date_Real
        end-if
        if #dayofweek = 1  !Sunday.. move it to monday
          Do Convert-to-DTU-Date($AsofToday_virtual, $cur_dt_DTU)
          Do dtu-add-days($cur_dt_DTU, 3, $Check_Date_Forced_DTU)
          Do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Forced)
          move $Check_Date_Forced to $Check_Date_Real
        end-if
      
      end-if
      
      let #dayofweek = datetostr(strtodate($Check_Date_Real,'DD-MON-YYYY'),'D')
 
!--------------------------------------------------------------------------------------------
!  5/13/08 updated:  So based on the PeopleSoft pay calendar if a payroll or off cycle is created on the last day
!                    of the quarter it should not be pushed out an additional 2 days as it normally would. For 
!                    example if a check is created on 03/31 in the pay calendar it should remain dated as 03/31 
!                    rather than being pushed to 04/02
!
! $Current_calendar_check_date, #Check_Year_Qtr_From_Pay_Calendar
!--------------------------------------------------------------------------------------------
 
   move $Check_Date_Real to $Dt_in
   do Get-Quarter
   move #year_qtr to #Check_Year_Qtr_Calced_for_RDS1
 
   do Format-Number(#Check_Year_From_Pay_Calendar, $yyyy, '9999')
 
   if #first_date_generated = 0
      show 'RDS1, final day of week of liabilities = ' #dayofweek ', date: ' $Check_Date_Real
      show 'RDS1, Check_Year_Qtr_Calced_for_RDS1   = ' #Check_Year_Qtr_Calced_for_RDS1
      show 'RDS1, Check_Year_Qtr_From_Pay_Calendar = ' #Check_Year_Qtr_From_Pay_Calendar
      show 'RDS1, Check_Qtr_calced                 = ' #qtr_out
      show 'RDS1, Check_Qtr_From_Pay_Calendar      = ' #Check_Qtr_From_Pay_Calendar
      show 'RDS1, Check_Year_From_Pay_Calendar     = ' #Check_Year_From_Pay_Calendar
      show 'RDS1, Year for final liability (yyyy)  = ' $yyyy
   end-if
 
   !if the projected date is in a different quarter than the calendar's check date.. force it back to the calendars date
   if (#Check_Year_Qtr_Calced_for_RDS1 <> #Check_Year_Qtr_From_Pay_Calendar)
     
     !4/9/10 per Terry E., fixed on 6/30/10
     ! -------------------------------------------------------------------
     !When it approaches the end of the calendar quarter it should not go into the new quarter but 
     !  it should park on the last day of the calendar quarter.
     !
     !6/30/2010 error:
     !Radio Shack: projected date: 01-JUL-2010 in Qtr:3.000000, moved to last day of quarter: 30-JUL-2010
     
      
      evaluate #Check_Qtr_From_Pay_Calendar  !9/30/2011 changed to the current quarter so we don't project it out too far into next quarter
      when = 1
        let $dd = '31'        
        let $mm = '03'
        let $Last_day_of_quarter_DTU = $yyyy || '-' || $mm || '-' || $dd
        break
      when = 2
        let $dd = '30'        
        let $mm = '06'
        let $Last_day_of_quarter_DTU = $yyyy || '-' || $mm || '-' || $dd
        break
      when = 3
        let $dd = '30'        
        let $mm = '09'
        let $Last_day_of_quarter_DTU = $yyyy || '-' || $mm || '-' || $dd
        break
      when = 4
        let $dd = '31'        
        let $mm = '12'
        let $Last_day_of_quarter_DTU = $yyyy || '-' || $mm || '-' || $dd
        break
   end-evaluate
     
   Do Convert-From-DTU-Date($Last_day_of_quarter_DTU, $Last_day_of_quarter)
   if #first_date_generated = 0
      show 'RRD1: projected date: ' $Check_Date_Real  ' in Qtr:' #qtr_out ', moved to last day of prior quarter: ' $Last_day_of_quarter 
      add 1 to #first_date_generated
   end-if
   move $Last_day_of_quarter to $Check_Date_Real
 
  end-if
   
!---------------------------------------------------------------------------------------------
end-procedure
#endif
 
#ifdef CANADA_TOO
 
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: Process-CANADA-Run-Taxes Peoplesoft 8                     !
! Desc:      This procedure extracts an Employee's Tax Balance table   !
!            data.                                                     !
!----------------------------------------------------------------------!
begin-procedure Process-CANADA-Run-Taxes
 
!#define debug_canada
!#define debug_canada_health
 
 let #cnt = 1
 let $Trimmed_Locality  = ' '
 let $Trimmed_Resident  = ' '
 let $Canadian = 'N'
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.26: ' $display_dt
 #endif
 
begin-select
CANPT.PROVINCE
CANPT.TAX_CLASS_CAN
CANPT.NLGRS_CUR
CANPT.TXGRS_CUR
CANPT.TAX_CUR
CANPT.OFF_CYCLE
CANPT.SEPCHK
CANPC.EMPLID
#ifdef SPLIT_FEDERAL
CANPT.WAGE_LOSS_PLAN                                 !added 9/30/05
#endif
 
 let $Canadian = 'Y'  !set this if we get any Canadian data for this run_id
 let #Nlgrs_cur = &CANPT.NLGRS_CUR
 let #Txgrs_cur = &CANPT.TXGRS_CUR
 let #Tax_cur   = &CANPT.TAX_CUR
 let #payline_sepchk = &CANPT.SEPCHK
 
 
 ! *********************************************************
 let $Trimmed_Tax_Class = rtrim(&CANPT.TAX_CLASS_CAN,' ')
 let $Trimmed_State     = rtrim(&CANPT.PROVINCE,' ')
 let $Trimmed_Locality  = ' '
 ! *********************************************************
 
 
 if $Trimmed_State = ''
  show 'Blank Province code for TAX_CLASS_CAN ' $Trimmed_tax_class
  let $Trimmed_State = '$C'  !Fed in Canada
 end-if
 
 #ifdef debug_canada
   show 'Process-CANADA-Run-Taxes: Canada Tax Record, emplid ' $Payline_Emplid
   show '  Emplid                  ' $payline_emplid
   show '  Province                ' $Trimmed_State
   show '  Tax Class               ' $Trimmed_Tax_Class
   show '  NLGross Wages           ' #Nlgrs_cur
   show '  TXGross Wages           ' #Txgrs_cur
   show '  Taxes                   ' #Tax_cur
   #ifdef debug_split
   show '  Wage loss plan          ' $wage_loss_plan
   #endif
 #endif
 
 #ifdef CANADA_HEALTH_TOO
  #ifdef debug_canada_health
   if $Trimmed_Tax_Class = 'CIT' or $Trimmed_Tax_Class = 'QIT'
   show 'Canada Tax Record, emplid ' $Payline_Emplid
   show '  Province                ' $Trimmed_State
   show '  Tax Class               ' $Trimmed_Tax_Class
   show '  NLGross Wages           ' #Nlgrs_cur
   show '  TXGross Wages           ' #Txgrs_cur
   show '  Taxes                   ' #Tax_cur
   end-if
  #endif
 #endif
 
 
 let $health_tax_too = 'f'
 
 #ifdef SPLIT_FEDERAL
      evaluate $Trimmed_Tax_Class
 
      When = 'CIT'
      When = 'CPP'
      When = 'EIE'
      When = 'EIR'
      When = 'T4A'
 
          let $wlp = rtrim(&CANPT.WAGE_LOSS_PLAN,' ')
 
          #ifdef debug_split
            show '  Evaluating Wage loss plan  ' $wlp
          #endif
 
          evaluate $wlp
            when = '{SPLIT_BUS1_WAGE_LOSS_PLAN}'
            when = '{SPLIT_BUS2_WAGE_LOSS_PLAN}'
                let $WAGE_LOSS_PLAN = $wlp
                break
            when = ''
                let $WAGE_LOSS_PLAN = '{SPLIT_BUS1_WAGE_LOSS_PLAN}'
                #ifdef debug_split
                  show '  Defaulting to Bus Unit#1   ' $wage_loss_plan
                #endif
                break
            when-other
                show 'Warning: Invalid Wage Loss Plan for emplid ' $Payline_emplid
                break
          end-evaluate
 
          #ifdef debug_split
            show '  Evaluation complete. Wage loss plan  ' $wage_loss_plan
          #endif
 
          !if rtrim($payline_emplid,' ') = '1411385'
          !  let $WAGE_LOSS_PLAN = '{SPLIT_BUS2_WAGE_LOSS_PLAN}'  !testing
          !end-if
 
          !----------------------
          break
 
      when-other
          let $WAGE_LOSS_PLAN = 'n/a'
          break
     end-evaluate
    #endif
 
 if $Trimmed_Tax_Class = 'CIT'
   do count-ee
 
   #ifdef SPLIT_FEDERAL
     if $WAGE_LOSS_PLAN = '{SPLIT_BUS1_WAGE_LOSS_PLAN}'
       add #txgrs_cur to #Cit_Taxable_Hash
       add #tax_cur   to #Cit_Tax_Hash
     else
       add #txgrs_cur to #Cit_Taxable2_Hash
       add #tax_cur   to #Cit_Tax2_Hash
     end-if
  #else
       add #txgrs_cur to #Cit_Taxable_Hash
       add #tax_cur   to #Cit_Tax_Hash
  #endif
  
  
 end-if
 
 !ignore fractions of pennies...
 !-------------------------------
 if (round(#TXGRS_CUR,2) <> 0) or (round(#NLGRS_CUR,2) <> 0) or (round(#TAX_CUR,2) <> 0)
 
  evaluate $Trimmed_Tax_Class
 
      When = 'CIT'
 
         add #Tax_cur to #Company_t4
         add #Tax_cur to #Hash_t4
         add #Tax_cur to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Txgrs_Cur to #Company_canada_fit_txgrs
         add #Txgrs_Cur to #Hash_canada_fit_txgrs
         break
 
      When = 'T4A'
         add #Tax_cur to #Company_T4A
         add #Tax_cur to #Hash_T4A
         add #Tax_cur to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Txgrs_Cur to #Company_canada_fit_txgrs
         add #Txgrs_Cur to #Hash_canada_fit_txgrs
        break
 
      When = 'QIT'
         add #Tax_cur to #Company_RL1
         add #Tax_cur to #Hash_RL1
         add #Tax_cur to #Company_quebec
         add #Tax_cur to #Hash_quebec
         add #Txgrs_Cur to #Company_quebec_fit_txgrs
         add #Txgrs_Cur to #Hash_quebec_fit_txgrs
         break
 
 
      When = 'QIP'  !10/17/05
         add #Tax_cur to #Company_QIP
         add #Tax_cur to #Hash_QIP
         add #Tax_cur to #Company_quebec
         add #Tax_cur to #Hash_quebec
         break
 
      When = 'RV2'
         add #Tax_cur to #Company_RL2
         add #Tax_cur to #Hash_RL2
         add #Tax_cur to #Company_quebec
         add #Tax_cur to #Hash_quebec
         add #Txgrs_Cur to #Company_quebec_fit_txgrs
         add #Txgrs_Cur to #Hash_quebec_fit_txgrs
         break
 
      When = 'TT4'
         add #Txgrs_Cur to #Company_True_T4_TxGrs_Cur
         add #Txgrs_Cur to #Hash_True_T4_TxGrs_Cur
         break
 
      !When = 'PYT'
      !
         !12/12/05 updated logic
         !--------------------------
         !show 'PYT Tax_Class_Can is not valid for Province ' $Trimmed_State
         !add #Tax_cur to #Company_Payroll_Tax_Cur
         !add #Tax_cur to #Hash_Payroll_Tax_Cur
         !add #Txgrs_Cur to #Company_Payroll_Txgrs_Cur
         !add #Txgrs_Cur to #Hash_Payroll_Txgrs_Cur
      !  break
 
      When = 'CPP'
         add #Tax_cur  to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Tax_cur to #Company_Pension_Tax_Cur_EE
         add #Tax_cur to #Company_Pension_Tax_Cur_ER
         add #Tax_cur to #Hash_Pension_Tax_Cur_EE
         add #Tax_cur to #Hash_Pension_Tax_Cur_ER
         add #Tax_cur  to #Company_canada       !EE and ER
         add #Tax_cur to #Hash_canada
         break
 
      When = 'QPP'
         add #Tax_cur to #Company_quebec
         add #Tax_cur to #Hash_quebec
         add #Tax_cur to #Company_Pension_Tax_Cur_EE_quebec
         add #Tax_cur to #Company_Pension_Tax_Cur_ER_quebec
         add #Tax_cur to #Hash_Pension_Tax_Cur_EE_quebec
         add #Tax_cur to #Hash_Pension_Tax_Cur_ER_quebec
         add #Tax_cur  to #Company_quebec       !EE and ER
         add #Tax_cur to #Hash_quebec
         break
 
      When = 'EIE'
         add #Tax_cur to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Tax_cur to #Company_Empl_ins_Tax_Cur_EE
         add #Tax_cur to #Hash_Empl_ins_Tax_Cur_EE
         break
 
      When = 'EIR'
         add #Tax_cur to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Tax_cur to #Company_Empl_ins_Tax_Cur_ER
         add #Tax_cur to #Hash_Empl_ins_Tax_Cur_ER
         break
 
      !12/12/05 added for QPIP
      When = 'QIE'
         add #Tax_cur to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Tax_cur to #Company_QPIP_Empl_ins_Tax_Cur_EE
         add #Tax_cur to #Hash_QPIP_Empl_ins_Tax_Cur_EE
         break
 
      When = 'QIR'
         add #Tax_cur to #Company_canada
         add #Tax_cur to #Hash_canada
         add #Tax_cur to #Company_QPIP_Empl_ins_Tax_Cur_ER
         add #Tax_cur to #Hash_QPIP_Empl_ins_Tax_Cur_ER
         break
 
      When = 'HTX'
         !12/5/06 .. following section uncommeted
         !----------------------------------------------------------------------------
         ! Taxes in extract:     751,850.39
         ! Do not match Report   788,918.64
         !  The difference above is 37,068.25  which equals:
         !  The amount of "Total Health Insurance Employer" on page 9:  38,648.76
         !  less the "taxes not processed" of 1,580.51
         !----------------------------------------------------------------------------
 
         if $Trimmed_State = 'QC'           
           add #Tax_cur to #Company_quebec  
           add #Tax_cur to #Hash_quebec     
         else   
           add #Tax_cur to #Company_canada
           add #Tax_cur to #Hash_canada
         end-if
 
         !----------------------------------------------------------------------------
 
         add #Tax_cur to #Company_Health_Tax_Cur_ER
         add #Tax_cur to #Hash_Health_Tax_Cur_ER
         break
 
       when-other
          break
 
  end-evaluate
 
 
  if $process_payline = 'f'
   Add #TAX_CUR   to #Company_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #Company_Txgrs_Previously_Extracted
   Add #TAX_CUR   to #Fein_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #Fein_Txgrs_Previously_Extracted
   Add #TAX_CUR   to #Hash_Taxes_Previously_Extracted
   Add #TXGRS_CUR to #Hash_Txgrs_Previously_Extracted
  else
 
  ! *********************************************************
  ! --------- Handle the Liability Date logic ---------------
  ! *********************************************************
 
  !Default to using check date for Payroll date
  !--------------------------------------------
  #ifdef CANADA_USE_CHECK_DATE_FROM_CALENDAR_ALWAYS
    let $Check_Date_Real = rtrim($A_Check_Dt,' ')
  #else
 
   if ($Payline_off_cycle <> 'Y') or ($payline_check_dt = '')
    let $Check_Date_Real = rtrim($A_Check_Dt,' ')
   else
 
   !------------------------------------------------------------
   !Get the Quarter that the Check date is in, from the pay line
   !------------------------------------------------------------
 
   move $payline_check_dt to $Dt_in
   do Get-Quarter
   move #year_qtr to #Check_Year_Qtr_From_Pay_Line
 
   if (#Check_Year_Qtr_From_Pay_Line <> #Check_Year_Qtr_From_Pay_Calendar)
 
     display 'Message: Payline CheckDate not in same Quarter as PayCalendar CheckDate'
     display ' Payline CheckDate '       noline
     display $payline_check_dt           noline
     display ', PayCalendar CheckDate '  noline
 
     display $A_Check_Dt                 noline
     display ', Company '                noline
     display $payline_company            noline
     display ', Emplid '                 noline
     display $payline_emplid
 
     !----------------------------------------------------------------------------
     !if the payline's check date is from another quarter, set the liability date
     !to the pay calendar's check date ONLY if it is a REVERSAL!
     !----------------------------------------------------------------------------
     do Check-for-Reversal
 
     if $Check_Reversal = 't'
         let $Check_Date_Real = rtrim($A_Check_Dt,' ')     !    if reversal, set liability date to calendar's check dt
     else                                                  !
         let $Check_Date_Real = $payline_check_dt          !    if check in diff qtr, and not a reversal, use actual pay check date
     end-if                                                !  ----------------------------------------------------------------------
 
    else
     let $Check_Date_Real = $payline_check_dt              !  Otherwise use payline's check date
    end-if
 
   end-if
 
  #endif
 
 
  !see if we should bypass this tax (ie. IGNORE_FUI, IGNORE_NYD,....)
  !------------------------------------------------------------------
  do Build-Taxcode
  let $Trimmed_TaxCode  = rtrim($Taxcode,' ')
  let $Trimmed_Company  = $PayLine_Company
  do Check-before-processing-tax
 
  if $Tax_Proceed = 't'
 
    !Do we need to generate ER matching tax record too?
    !--------------------------------------------------
    do Check-for-ER-Generated-Tax
    if rtrim($dup_can_pen,' ') = 't'
     let #Tax_cur = #Tax_cur * 2         !ADP Canada, simply dup EE and ER into same taxcode
    end-if  !end-if <-- $Need_to_Generate_ER_Tax = 't'
 
    !Now, we can update the TaxBalance array, as this is a valid tax to process
    !--------------------------------------------------------------------------
    let $ER_Generated = 'f'
    do Write-to-TaxBalances
 
    #ifdef GENERATE_EMPLOYEE_DETAIL
 
      Do Convert-to-DTU-Date($Check_Date_Real,$Check_Date_Real_DTU)
 
      let $Mo    = substr($Check_Date_Real_DTU,6,2)
      let $Day   = substr($Check_Date_Real_DTU,9,2)
      let $Yr    = substr($Check_Date_Real_DTU,1,4)
      let $chk_dtu = $Yr || $Mo || $Day
 
      do Generate-employee-details
 
    #endif
 
    #ifdef USE_TF_ADP_CSST_TBL
      if $Trimmed_Tax_Class = 'HTX' and $Trimmed_State = 'QC'           
        do Init-CSST-Parameters  !returns !#QC-LIMIT, #QC-RATE
        let #Tax_Cur = 0
        let #txgrs_cur = 0
        do generate-CSST-amount
        if #Tax_cur <> 0
          let $Trimmed_Tax_Class = 'QST'
          add #Tax_cur to #Company_CST
          add #Tax_cur to #Hash_CST
          add #Txgrs_cur to #Company_CST_Taxable
          add #Txgrs_cur to #Hash_CST_Taxable
          let $Taxcode = 'QCQST         '
          let $Trimmed_TaxCode  = rtrim($Taxcode,' ')
          do Write-to-TaxBalances
          #ifdef GENERATE_EMPLOYEE_DETAIL
           do Generate-employee-details
          #endif
        end-if
      end-if
    #endif
 
   end-if  !end-if <-- $Tax Proceed = 't'
  end-if  !end-if <-- $process_payline <> 'f'
 end-if  !end-if <-- taxes,gross,taxable not all 0
 
 from PS_PAY_CHECK CANPC, PS_PAY_TAX_CAN CANPT
 
  WHERE CANPT.COMPANY    = $PayLine_Company     AND
        CANPT.PAYGROUP   = $PayLine_Paygroup    AND
        CANPT.{pg}       = #PayLine_pagen       AND
        CANPT.{ln}       = #PayLine_linen       AND
        CANPT.OFF_CYCLE  = $PayLine_Off_Cycle   AND
        CANPT.PAY_END_DT = $PayLine_pay_end_dt  AND
        CANPC.COMPANY    = CANPT.COMPANY	AND
        CANPC.PAYGROUP   = CANPT.PAYGROUP	AND
        CANPC.PAY_END_DT = CANPT.PAY_END_DT	AND
        CANPC.OFF_CYCLE  = CANPT.OFF_CYCLE	AND
        CANPC.{pg}       = CANPT.{pg}    	AND
        CANPC.{ln}       = CANPT.{ln}    	AND
        CANPC.SEPCHK     = CANPT.SEPCHK		AND
        CANPT.PROVINCE   > ' '                  AND
 
        !12/12/05 PYT removed   CANPT.TAX_CLASS_CAN IN ('CIT','QIT','HTX','T4A','RV2','PYT','CPP','QPP','QIP','EIE','EIR','TT4')
 
        CANPT.TAX_CLASS_CAN IN ('CIT','QIT','HTX','T4A','RV2','CPP','QPP','QIP','QIE','QIR','EIE','EIR','TT4')
 
  ORDER BY CANPC.EMPLID
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 
#endif    ! Canada too
 
 
 
 
#ifdef CANADA_HEALTH_TOO
 
begin-procedure Print-Health-Totals
 
  move 0 to #i
 
  print 'Canadian Health Insurance Rates..' (+2,1)
  print 'Province'                          (+2,10)
  print 'Health Ins Rt'                  (0,22)
  while #i < #ProvCodes
           get $Province      from ProvinceHealthTotals(#i) Prov
           get #Hlth_Ins_Rt   from ProvinceHealthTotals(#i) Hlth_Ins_Rt
           if (round(#Hlth_Ins_Rt,2) <> 0)
            do Format-Number(#Hlth_Ins_Rt, $Ins_Rt, 'b99999.999999')
            print $Province           (+1,10)
            print $Ins_Rt             (0,22)
           end-if
       add 1 to #i
   end-while
 
end-procedure
 
#endif
 
 
 
begin-procedure Write-to-TaxBalances
 
 #ifdef BYPASS_NEW_HIRE_TAXCODES  !This gets set automatically in adpq210.sqc if we do not pass New Hire Act data into Periodics
  #if {SITE_ID} <> 'CSX1'
    if  ($Trimmed_State = '$U' or $Trimmed_State = '$E') and 
         ($Trimmed_Tax_Class = '{FICA_EXEMPT_ER_HIRE_ACT_CLASS}' or $Trimmed_Tax_Class = '{FICA_TIPS_EXEMPT_ER_HIRE_ACT_CLASS}')
    
      Add #Tax_Cur to #Ignore_Tax
      Add #Tax_Cur to #Fein_Ignore_Tax
      Add #Tax_Cur to #Hash_Ignore_Tax
      do insert-taxes-into-bypassed-totals  !This creates the ER piece of what we're bypassing
      goto bypass_write_to_taxbalances
    end-if
  #endif
 #endif
 
 !state specific
 let #cnt = 0
 if rtrim($Trimmed_Tax_Class,' ')  = 'H' AND rtrim($Trimmed_Locality,' ')   = '' 
    let #Male_cnt = 0
    let #Female_cnt = 0
    let #cnt = 1
    do Extract-Personal-Data
    if $Gender = 'M'
       let #Male_cnt = 1
    else
       let #Female_cnt = 1
    end-if
    if #debug_write_to_tax_balances < 20
      show #debug_write_to_tax_balances edit 999 '. Write-to-TaxBalances W/H ' $Payline_Emplid ' ' $trimmed_state $Trimmed_Tax_Class ' Gender = ' $Gender
      add 1 to #debug_write_to_tax_balances
    end-if
 
    do Log-EE-count
    if rtrim($trimmed_state,' ') = '$U'
        add #Female_cnt to #f_tot
        add #Male_cnt   to #m_tot
        add 1 to #fm_tot
    end-if
    if rtrim($trimmed_state,' ') = 'AL'
        add #Female_cnt to #alf_tot
        add #Male_cnt   to #alm_tot
        add 1 to #alfm_tot
    end-if

 end-if  !w/h
 
 #ifdef TF_AUDIT
     do TF-Audit
 #endif
   
   !6/18/02 for PPL.... bypass writing to the output if zero withheld for the localities
   !------------------------------------------------------------------------------------
   !#if {SITE_ID} = 'PPL'
   !   if #TAX_CUR = 0 AND $Trimmed_Locality <> ''
   !     goto bypass_write_to_taxbalances
   !   end-if
   !#endif
 
   let #L1 = 0
   let $found = 'f'
 
   while #L1 < #LAST_TAXBALANCE_CNT
    Add 1 to #L1
    get $TEST_CHECK_DT              -
        $TEST_ST                    -
        $TEST_LOCALITY              -
        $TEST_RESIDENT              -
        $TEST_TAX_CLASS             -
       from TAXBALANCE(#L1)         -
             TaxBalance_Check_Dt    -
             TaxBalance_State       -
             TaxBalance_Locality    -
             TaxBalance_Resident    -
             TaxBalance_Tax_Class
 
   if $Canadian = 'Y'
    #ifdef CANADA_TOO
     #ifdef SPLIT_FEDERAL
      get $TEST_TaxBalance_Wage_loss_plan from TAXBALANCE(#L1) TaxBalance_Wage_loss_plan
      #ifdef debug_split
        show 'Write-to-TaxBalances: TEST_TaxBalance_Wage_loss_plan = ' $TEST_TaxBalance_Wage_loss_plan
      #endif
     #endif
    #endif
   else
    move '' to $TEST_TaxBalance_Wage_loss_plan
    move '' to $wage_loss_plan
   end-if

    #ifdef CUSTOM_EMPLOYMENT_TYPE
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #if {SITE_ID} = 'KFC_OLD'
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #if {SITE_ID} = 'PRD1'
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #if {SITE_ID} = 'CHS1'
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #ifdef GENERAL_SUI_SPLIT_STATE
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #if {SITE_ID} = 'TLL1'
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #if {SITE_ID} = 'FTO1'
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
    #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
      get $Paygroup_LLC_Field_Test from TAXBALANCE(#L1) TaxBalance_LLC
    #endif
 
 
    if     rtrim($Trimmed_State,' ')      = rtrim($TEST_ST,' ')
       AND rtrim($Trimmed_Locality,' ')   = rtrim($TEST_LOCALITY,' ')
       AND rtrim($Trimmed_Resident,' ')   = rtrim($TEST_RESIDENT,' ')
       AND rtrim($Trimmed_Tax_Class,' ')  = rtrim($TEST_TAX_CLASS,' ')
       AND rtrim($Check_Date_Real,' ')    = rtrim($TEST_CHECK_DT,' ')
 
       #ifdef CANADA_TOO
        #ifdef SPLIT_FEDERAL
         AND rtrim($TEST_TaxBalance_Wage_loss_plan,' ') = rtrim($Wage_Loss_Plan,' ')
        #endif
       #endif
 
 
       #ifdef CUSTOM_EMPLOYMENT_TYPE
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif

       #if {SITE_ID} = 'KFC_OLD'
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
       #if {SITE_ID} = 'PRD1'
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
       #if {SITE_ID} = 'CHS1'
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
       #ifdef GENERAL_SUI_SPLIT_STATE
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
       #if {SITE_ID} = 'TLL1'
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
       #if {SITE_ID} = 'FTO1'
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
       #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
         AND rtrim($Paygroup_LLC_Field_Test,' ') = rtrim($Paygroup_LLC_Field,' ')
       #endif
 
 
          Array-Add #NLGRS_CUR                    -
                    #TXGRS_CUR                    -
                    #TAX_CUR                      -
                    #TOTAL_GROSS                  -
                    #cnt                          -
                    #Male_cnt                     -
                    #Female_cnt                   -
                  to TaxBalance(#L1)              -
                     TaxBalance_NLGRS_Cur         -
                     TaxBalance_TXGRS_Cur         -
                     TaxBalance_TAX_Cur           -
                     TaxBalance_GROSS_Cur         -
                     TaxBalance_Count             -
                     Male_TaxBalance_Count        -
                     Female_TaxBalance_Count
 
          let $found = 't'
          break
     end-if
 
  end-while
 
  if $found = 'f'
 
    If  #Last_TaxBalance_Cnt < {TAX_LIMIT}
        Add 1 to #Last_TaxBalance_Cnt
    Else
        Display 'Exceeded Maximum Tax Balances -- Expand Array'
        #ifdef MVS
         Move 5 to #Return-Status
        #end-if
        Stop
    End-if
 
    put $Check_Date_Real            -
        $Trimmed_State              -
        $Trimmed_Locality           -
        $Trimmed_Resident           -
        $Trimmed_Tax_Class          -
        #NLGRS_CUR                  -
        #TXGRS_CUR                  -
        #TAX_CUR                    -
        #TOTAL_GROSS                -
        #cnt                        -
        #female_cnt                 -
        #male_cnt                   -
        $ER_Generated               -
        $Canadian                   -
        into TAXBALANCE(#Last_TaxBalance_Cnt)        -
             TaxBalance_Check_Dt    -
             TaxBalance_State       -
             TaxBalance_Locality    -
             TaxBalance_Resident    -
             TaxBalance_Tax_Class   -
             TaxBalance_NLGRS_Cur   -
             TaxBalance_TXGRS_Cur   -
             TaxBalance_TAX_Cur     -
             TaxBalance_GROSS_Cur   -
             TaxBalance_Count       -
             Female_TaxBalance_Count   -
             Male_TaxBalance_Count     -
             TaxBalance_ER_Generated -
             TaxBalance_Canada
 
     if $Canadian = 'Y'
      #ifdef CANADA_TOO
       #ifdef SPLIT_FEDERAL
        put $Wage_loss_plan into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_Wage_loss_plan
       #endif
      #endif
     end-if
 
      #ifdef CUSTOM_EMPLOYMENT_TYPE
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #if {SITE_ID} = 'PRD1'
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #if {SITE_ID} = 'CHS1'
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #ifdef GENERAL_SUI_SPLIT_STATE
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #if {SITE_ID} = 'TLL1'
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #if {SITE_ID} = 'KFC_OLD'
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #if {SITE_ID} = 'FTO1'
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
      #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
        put $Paygroup_LLC_Field into TAXBALANCE(#Last_TaxBalance_Cnt) TaxBalance_LLC
      #endif
 
 
    end-if
 
   !3/25/03 added
   #ifdef GENERATE_TRANSMIT_TABLE
      move 'T' to $PBZ_Type                 !Transmit log
      if $company_adjustment <> 't'   !don't log the adjustments
         do Insert-History-Record
      end-if
   #endif
 
 
bypass_write_to_taxbalances:


end-procedure
 
 
 
 
 
begin-procedure  Generate-employee-details
 
     do Format-Number(#Txgrs_cur,$PT_TXGRS_CUR, '99999999999.99')
     do Format-Number(#Nlgrs_cur,$PT_NLGRS_CUR, '99999999999.99')
     do Format-Number(#Tax_cur  ,$PT_TAX_CUR,   '99999999999.99')
 
     Write 3 FROM $Current_FEIN:10 !1-10      Fein             (10)
                   $space:1        !11
                  $compid:9        !12-20     Company ID       (9)    (Company, or Company || Paygroup)
                   $space:1        !21
                 $Taxcode:15       !22-36     Taxcode          (15)
                   $space:1        !37
                 $chk_dtu:8        !38-45     Liability Date   (8)     (YYYYMMDD)
                   $space:1        !46
          $payline_emplid:11       !47-57     Employee ID      (11)
                   $space:1        !58
                     $ssn:9        !59-67     Employee SSN     (9)
                   $space:1        !68
            $PT_TXGRS_CUR:15       !69-83     Taxable Wages    (15)    (12334.99)
                   $space:1        !84
            $PT_NLGRS_CUR:15       !85-99     NL Gross Wages   (15)    (12300.55)
                   $space:1        !100
              $PT_TAX_CUR:15       !101-115   Taxes Withheld   (15)    (123.33)
                   $space:1        !116
                   $RunID:6        !117-122   PayRun ID        (6)
                   $space:1        !123
       $PayLine_Off_Cycle:3        !124-126   Off-cycle        (3)     (Y/N)
                   $space:1        !127
              $end_dt_DTU:8        !128-135   Payroll End Date (8)     (YYYYMMDD)
 
end-procedure
 
 
 
 
begin-procedure Check-before-processing-tax
 
 !params: $Trimmed_TaxCode
 !        $Trimmed_Locality
 !        $Trimmed_Tax_Class
 !        $Trimmed_State
 !        $Trimmed_company
 !        #Tax_Cur
 !output: $Tax_Proceed = 't' or 'f'
 
 let $Tax_Proceed = 't'
 
 if ($Canadian = 'Y')
 
   !we only handle ON and QC Health insurance taxes, not the others.
   !----------------------------------------------------------------
   if substr($Trimmed_taxcode,3,3) = 'HTX'
     let $Tax_Proceed = 'f'
     if $Trimmed_State = 'QC' OR $Trimmed_State = 'ON'
      let $Tax_Proceed = 't'
     else
       add #Tax_cur to #Company_Health_Tax_Cur_ER_bypassed
       add #Tax_cur to #Hash_Health_Tax_Cur_ER_bypassed
     end-if
   end-if
 
   if $Tax_Proceed = 'f'
    Add #Tax_Cur to #Ignore_Tax
    Add #Tax_Cur to #Fein_Ignore_Tax
    Add #Tax_Cur to #Hash_Ignore_Tax
    do insert-taxes-into-bypassed-totals
   end-if
 
 else
 
  do bypass-tax-check
 
  if $Tax_Proceed = 't'
   #ifdef BYPASS_ZERO_LOCALS_PERIODIC
      do bypass-zero-locals-periodic  !in adplocbp.sqc
   #endif
  end-if
  
  if $Tax_Proceed = 't'
  
  !added 3/9/04 for VF
  #ifdef BYPASS_PRIOR_TO_LIVE_DATE
    Do Convert-to-DTU-Date($Check_Date_Real,$Check_Date_Real_DTU)
    if ($Check_Date_Real_DTU < '{ADP_LIVE_DATE_DTU}')
      let $Tax_Proceed = 'f'
      #if {SITE_ID} = 'BKR1'               !JLG changed to Site_id per ADP 02/17/09
       if ($Trimmed_State <> '$U')
          if ($Trimmed_Tax_Class = 'E') OR
             ($Trimmed_Tax_Class = 'D') OR
             ($Trimmed_Tax_Class = 'J') OR
             ($Trimmed_Tax_Class = 'L') OR
             ($Trimmed_Tax_Class = 'M') OR
             ($Trimmed_Tax_Class = 'N') OR
             ($Trimmed_Tax_Class = 'W')
              if $Trimmed_TaxCode <> 'CAD'       !Keep CA SDI in the file
                 let $Tax_Proceed =  'f'
              end-if
          end-if
        end-if
      #endif
     end-if
  #endif
 
 
  #if {SITE_ID} = 'SOL1'
    if  (($Trimmed_Company = '504') AND
        (($Trimmed_TaxCode = '$UD') OR
         ($Trimmed_TaxCode = '$UE') OR
         ($Trimmed_TaxCode = '$UF') OR
         ($Trimmed_TaxCode = '$UQ') OR
         ($Trimmed_TaxCode = 'PRE')))
 
      let $Tax_Proceed = 'f'
    end-if
  #endif
 
  !9/5/02 Added for Eli Lilly
  #if {SITE_ID} = 'ELI1' 
   if $Trimmed_company = 'LYR'
    do Get-Lilly-Deptid
    if ($Job_DeptId = '1001042')
      let $Trimmed_Taxcode   = '{FORM1042_Taxcode}'
      let $Trimmed_State     = substr('{FORM1042_Taxcode}',1,2)
      let $Trimmed_Tax_Class = substr('{FORM1042_Taxcode}',3,1)
      let $Trimmed_Locality  = substr('{FORM1042_Taxcode}',4,9)
      let $Trimmed_Resident  = ' '
    end-if
   end-if
  #endif
 
  !--------------
  #if {SITE_ID} = 'IDP1'
     if $Trimmed_company = 'RET'
         let $Trimmed_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Trimmed_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Trimmed_Locality  = substr('{FORM945P_Taxcode}',4,9)
         let $Trimmed_Resident  = ' '
     end-if
  #endif
 
  #if {SITE_ID} = 'ALB1'      !11/1/00 logic for Albemarle for 945P ee's
   if rtrim($Trimmed_Taxcode,' ') =  '$UH'
     if $Trimmed_company = 'APT'
         let $Trimmed_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Trimmed_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Trimmed_Locality  = substr('{FORM945P_Taxcode}',4,9)
         let $Trimmed_Resident  = ' '
     end-if
   end-if
  #endif
 
 
 
  !Modification B - Lilly
  !----------------------
  #if {SITE_ID} = 'ELI1'       !4/10/01 logic for Eli Lilly's for 945P ee's
    if rtrim($Trimmed_Taxcode,' ') =  '$UH'
     if $Trimmed_company = 'LYR'
         let $Trimmed_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Trimmed_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Trimmed_Locality  = substr('{FORM945P_Taxcode}',4,9)
         let $Trimmed_Resident  = ' '
     end-if
   end-if
  #endif
 
  !Modification - FirstData
  !----------------------
  #if {SITE_ID} = 'FDC1'          !4/12/01 logic for Eli Lilly's for 945P ee's
   #ifdef REMAP_WUP_NVP_TO_945P
    if rtrim($Trimmed_Taxcode,' ') =  '$UH'
     if $Trimmed_company = 'NVP'  OR $Trimmed_company = 'WUP'
         let $Trimmed_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Trimmed_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Trimmed_Locality  = substr('{FORM945P_Taxcode}',4,9)
         let $Trimmed_Resident  = ' '
     end-if
    end-if
   #endif
  #endif
 
  !Modification - BoA
 
  !Modification - Dow
  !----------------------
  #if {SITE_ID} = 'DOW1'
    if rtrim($Trimmed_Taxcode,' ') =  '$UH'
     if $Trimmed_company = 'C04'
         let $Trimmed_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Trimmed_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Trimmed_Locality  = substr('{FORM945P_Taxcode}',4,9)
         let $Trimmed_Resident  = ' '
     end-if
   end-if
  #endif
 
 
  #if {SITE_ID} = 'ECR1'
     move $Trimmed_Company to $Check_Company
     do Check-EMC-Record
  #endif
 
 end-if
 
 
 !Frito Lay customiation, to bypass federal part of the stock option checks
 !--------------------------------------------------------------------------
 #ifdef BYPASS_FED_STOCK_OPTION_TAXES
    do Check-for-Stock-option-check
    if rtrim($Stock_option,' ') = 't'
     do Log-StockOption
    end-if
 #endif
 
 if $Tax_Proceed = 't'
   #ifndef INCLUDE_STATE_FUTA_IN_PERIODIC   !20130220
    if ($Trimmed_Tax_Class = '6') 
      let $Tax_Proceed = 'f'
    end-if
   #endif
 end-if
 
 if $Tax_Proceed = 'f'
  if $company_adjustment <> 't'   !don't log adjustments that are bypassed 9/7/06
   Add #Tax_Cur to #Ignore_Tax
   Add #Tax_Cur to #Fein_Ignore_Tax
   Add #Tax_Cur to #Hash_Ignore_Tax
   do insert-taxes-into-bypassed-totals
 
   !added 11/14/01 to balance to tax001 when we're bypassing the EE and ER taxes for a local
   !----------------------------------------------------------------------------------------
   if ($Trimmed_Tax_Class = 'B') and ($Trimmed_Locality <> '')
 
     let $Save_Taxcode     = $Trimmed_Taxcode
     let $Save_Locality    = $Trimmed_Locality
     
     !4/10/7 (for Shopko, due to 'WORK COMP' Washington locality)
     !------------------------------------------------------------
     !from:
     !  let $Trimmed_Locality = $Trimmed_Locality || 'ER'
     !   let $Trimmed_Taxcode  = rtrim(substr($Trimmed_Taxcode,1,12),' ') || 'ER'
     !to  :
     !------------------------------------------------------------
     if length($Trimmed_Locality) < 9
        let $Trimmed_Locality = $Trimmed_Locality || 'ER'
        let $Trimmed_Taxcode  = rtrim(substr($Trimmed_Taxcode,1,12),' ') || 'ER'
     else
        let $Trimmed_Locality = 'ER' || substr($Trimmed_Locality,1,8)  !limit it to 10 chars total
        let $Trimmed_Taxcode  = substr($Trimmed_Taxcode,1,3) || substr($Trimmed_Locality,1,10)
     end-if
     !-------------------------------------------------------------
     
     let $Trimmed_Taxcode  = rpad($Trimmed_Taxcode,14,' ') || $Trimmed_Resident
 
     Add #Tax_Cur to #Ignore_Tax
     Add #Tax_Cur to #Fein_Ignore_Tax
     Add #Tax_Cur to #Hash_Ignore_Tax
     do insert-taxes-into-bypassed-totals  !This creates the ER piece of what we're bypassing
 
     let $Trimmed_Taxcode = $Save_Taxcode
     let $Trimmed_Locality = $Save_Locality
    end-if
   end-if
   !----------------------------------------------------------------------------------------
 

 end-if
 
 end-if
 
end-procedure
 
 
 
#if {SITE_ID} = 'ECR1'
 
!***********************************************************************   !
!----------------------------------------------------------------------    !
! Procedure: Check-EMC-Record                                              !
! Desc:      This procedure determines whether or not to handle the        !
!            company / emplid for this record:$Check_Company,$Check_Emplid !
!----------------------------------------------------------------------    !
begin-procedure Check-EMC-Record
 
   let  $Tax_Proceed = 't'
 
begin-select
CCHK.TAX_REPORT_TYPE
 
   let  $Tax_Proceed= 'f'
 
   FROM PS_COMPANY_TBL CCHK
   WHERE CCHK.COMPANY    = $Check_Company
     AND CCHK.EFF_STATUS = 'A'  !Exclude
     AND CCHK.TAX_REPORT_TYPE <> '2'   !W-2s only
     AND CCHK.EFFDT      = (SELECT MAX(EFFDT)
       FROM PS_COMPANY_TBL
         WHERE COMPANY     = CCHK.COMPANY
           AND EFF_STATUS  = CCHK.EFF_STATUS
           AND EFFDT       <= $Input_Pay_End_Dt)
 
 
 #ifdef SELECT_WITH_UR
  with ur
 #end-if
end-select
 
end-procedure
 
 
#endif
 
begin-procedure insert-taxes-into-bypassed-totals
 
   let #i = 0
   let $found = 'f'
 
   while (#i < #num_taxes_bypassed)
 
     get $CompID             -
         $PaygroupID         -
         $Check_Dt           -
         $txcode             -
     from TaxesBypassed(#i)     -
          CompID             -
          PaygroupID         -
          Check_Dt           -
          Taxcode
 
   #ifdef CONDENSED_BYPASS_SUMMARY
     if ($CompID       = $Trimmed_company)     and          !by company and taxcode only
        ($txcode       = $Trimmed_Taxcode)
       let $found = 't'
       break
     end-if
   #else
     if ($Check_Dt     = $Check_Date_Real)     and          !normally by check date, company, paygroup, taxcode
        ($CompID       = $Trimmed_company)     and
        ($PaygroupID   = $Client_PaygroupID)   and
        ($txcode       = $Trimmed_Taxcode)
       let $found = 't'
       break
     end-if
   #endif
 
     add 1 to #i
 
   end-while
 
 
   if $found = 'f'
 
   #ifdef CONDENSED_BYPASS_SUMMARY
     put   #Current_FEIN             -
           $Trimmed_company          -
           #Tax_Cur                  -
           #Txgrs_Cur                -
           #Nlgrs_Cur                -
           $Trimmed_Taxcode          -
     into TaxesBypassed(#i)          -
           Fein                      -
           CompId                    -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           Taxcode
   #else
     put   #Current_FEIN             -
           $Trimmed_company          -
           $Client_PaygroupID        -
           $Check_Date_Real          -
           #Tax_Cur                  -
           #Txgrs_Cur                -
           #Nlgrs_Cur                -
           $Trimmed_Taxcode          -
     into TaxesBypassed(#i)          -
           Fein                      -
           CompId                    -
           PaygroupID                -
           Check_Dt                  -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           Taxcode
    #endif
    
    add 1 to #num_taxes_bypassed
   else
 
     Array-Add #Tax_Cur   -
           #Txgrs_Cur     -
           #Nlgrs_Cur     -
       to TaxesBypassed(#i)          -
           Taxes                     -
           Txgrs                     -
           Nlgrs
   end-if
 
   !3/12/03 added for SIE1
   #ifdef GENERATE_BYPASSED_TABLE
      move 'B' to $PBZ_Type                 !Bypassed
      if $company_adjustment <> 't'   !don't log the adjustments
         do Insert-History-Record
      end-if
   #endif
 
 
end-procedure
 
begin-procedure insert-taxes-into-negative-totals
 
   let #ni = 0
   let $found = 'f'
 
   while (#ni < #num_neg_taxes)
     get $CompID             -
         $txcode             -
         $c_dt               -
     from NegTaxes(#ni)       -
          Company            -
          Taxcode            -
          Check_Dt
 
     if ($CompID       = $Client_CompID)     and
        ($txcode       = $Taxcode)           and
        ($c_dt         = $TaxBalance_Check_Dt)
       let $found = 't'
       break
     end-if
     add 1 to #ni
   end-while
 
   if $found = 'f'
     put   $Client_CompID            -
           #TaxBalance_Tax_Cur       -
           $Taxcode                  -
           $TaxBalance_Check_Dt      -
     into NegTaxes(#ni)              -
           Company                   -
           Taxes                     -
           Taxcode                   -
           Check_Dt
 
     add 1 to #num_neg_taxes
   else
        Array-Add #TaxBalance_Tax_Cur to NegTaxes(#i) Taxes
   end-if
 
end-procedure
 
 
 
begin-procedure Check-for-ER-Generated-Tax
 
 !params: $Trimmed_TaxCode
 !        $Trimmed_Tax_Class
 !        $Trimmed_Resident
 !        $Trimmed_State
 !        #Tax_Cur              I/O   (Tier2C, CSX...)
 !        #Txgrs_Cur            I/O   (Tier2C, CSX...)
 !        #Nlgrs_Cur            I/O   (Tier2C, CSX...)
 !        $Canadian             I     (to gen ER taxes for Pension for Canadian folks)
 
 !output:  $Need_to_Generate_ER_Tax = 't' then $Repeat_TaxCode
 
    let $Need_to_Generate_ER_Tax = 'f'
 
    ! --------------------------------------------------------------------
    ! Following is added to create records for employer tax contributions.
    ! --------------------------------------------------------------------
 
    !Canadian Pension  (CNP)
    !-----------------------
    if rtrim($Canadian,' ') = 'Y'
     #if {DUP_CANADIAN_PENSION} = 't'
      let $dup_can_pen = 'f'
      if (rtrim($Trimmed_Tax_Class,' ') = 'CPP') OR (rtrim($Trimmed_Tax_Class,' ') = 'QPP')
          let $dup_can_pen = 't'
      end-if
      !if (rtrim($dup_can_pen,' ') = 't')
      !  let $RTaxCode = rtrim(substr($Trimmed_Taxcode,1,12),' ') !8/13/98
      !  let $OTaxCode = $RTaxCode              ! August 2, 2005, ADP Canada used to be "|| 'ER'"
      !  Let $Repeat_TaxCode  = rpad($OTaxCode,14,' ') || $Trimmed_Resident
      !  let $Need_to_Generate_ER_Tax = 't'
      !end-if
 
     #endif
    end-if
 
 
    !Medicare ($UF)
    !---------------
    #if {DUP_UF} = 't'
      if rtrim($Trimmed_Taxcode,' ') = '{UF_EE_TAXCODE}'
        Let $Repeat_TaxCode  = rpad('{UF_ER_TAXCODE}',15,' ')
        let $Need_to_Generate_ER_Tax = 't'
      end-if
    #endif
 
    !Social Security ($D)
    !---------------------
    #if {DUP_UD} = 't'
     if rtrim($Trimmed_Taxcode,' ') = '{UD_EE_TAXCODE}'
        Let $Repeat_TaxCode  = rpad('{UD_ER_TAXCODE}',15,' ')
        let $Need_to_Generate_ER_Tax = 't'
     end-if
    #endif
 
    !PR SDI (PRD) - this section added 6/1/00
    !----------------------------------------
    #if {DUP_PRD} = 't'
     if rtrim($Trimmed_Taxcode,' ') = '{PRD_EE_TAXCODE}'
        Let $Repeat_TaxCode  = rpad('{PRD_ER_TAXCODE}',15,' ')
        let $Need_to_Generate_ER_Tax = 't'
     end-if
    #endif
 
    !Tax_Class 'B'
    !-------------
    #if {DUP_B} = 't'
     #if {SITE_ID} <> 'MCK1'
       if (rtrim($Trimmed_Tax_Class,' ') = 'B')
        let $RTaxCode = rtrim(substr($Trimmed_Taxcode,1,12),' ') !8/13/98
        let $OTaxCode = $RTaxCode || 'ER'
        Let $Repeat_TaxCode  = rpad($OTaxCode,14,' ') || $Trimmed_Resident
        let $Need_to_Generate_ER_Tax = 't'
       end-if
     #else
       if (rtrim($Trimmed_Tax_Class,' ') = 'B') and $Trimmed_Locality <> 'NM0001'
        let $RTaxCode = rtrim(substr($Trimmed_Taxcode,1,12),' ') !8/13/98
        let $OTaxCode = $RTaxCode || 'ER'
        Let $Repeat_TaxCode  = rpad($OTaxCode,14,' ') || $Trimmed_Resident
        let $Need_to_Generate_ER_Tax = 't'
       end-if
     #endif
    #endif
 
 
 
 ! CSX specific Tier #2 railroad taxes
 ! -----------------------------------
 #if {SITE_ID} = 'CSX1'
  #if {DUP_Tier2_RR} = 't'
   #if {Peoplesoft_Version} >= '7.5'
     if $Repeat_TaxCode       = '$UI            '!Employee Tier #2 retirement pension
   #else
     if $Repeat_TaxCode       = '$UX            '
   #endif
 
   Let $Repeat_TaxCode  = 'TIER2C         '   !generate the employer contrib
   let $Need_to_Generate_ER_Tax = 't'
 
   let #CSX_Tier2_conversion = {#CSX_Tier2_conversion_const}
   let #Nlgrs_Cur = #Nlgrs_Cur * #CSX_Tier2_conversion
   let #Txgrs_Cur = #Txgrs_Cur * #CSX_Tier2_conversion
   let #Tax_Cur   = #Tax_Cur   * #CSX_Tier2_conversion
 
  end-if
 #endif
 
 #if {DUP_Tier1_Med} = 't'
  if rtrim($Trimmed_Taxcode,' ') = '{EE_Tier1_MED}'        !Employee Tier #1 medicare
      Let $Repeat_TaxCode  = 'TIER1MEDC      '             !generate the employer contrib here
      let $Need_to_Generate_ER_Tax = 't'
  end-if
 #endif
 
 #if {DUP_Tier1_SS} = 't'
   if rtrim($Trimmed_Taxcode,' ') = '{EE_Tier1_SS}'        !Employee Tier #1 soc sec.
     Do Convert-to-DTU-Date($Check_Date_Real,$Yr_chk_DTU)
     let $Yr_chk = substr($Yr_chk_DTU,1,4)
     if $Yr_chk = '2011' or $Yr_chk = '2012'  
       let #Tax_Cur = #Txgrs_Cur * 0.062                   !2011 - 6.2% ER, 4.2% EE
     end-if
     Let $Repeat_TaxCode  = 'TIER1SDIC      '              !generate the employer contrib here
     let $Need_to_Generate_ER_Tax = 't'
   end-if
 #endif
 
#endif          !CSX
 
if $Need_to_Generate_ER_Tax = 't'
    add #Tax_Cur to #Hash_Generated_Taxes_into_TaxBalances
    let $Trimmed_State     = substr($Repeat_TaxCode,1,2)
    let $Trimmed_Tax_Class = substr($Repeat_TaxCode,3,1)
    let $Trimmed_Locality  = substr($Repeat_TaxCode,4,9)
    let $Trimmed_Resident  = substr($Repeat_TaxCode,15,1)
 end-if
 
end-procedure
 
 
 
 
!********************************************************************* !
!----------------------------------------------------------------------!
! Procedure: Process-Tax-Record                                        !
! Desc:      This procedure creates/writes the Detailed extract records!
!                                                                      !
!----------------------------------------------------------------------!
begin-procedure Process-Tax-Record
 
  #ifdef ADJUST_ZERO_LOCALS    !Clear all locals w/zero YTD Withheld
    do adjust-zero-locals
  #endif
  
  #ifdef GET_BALANCE_ADJUSTMENTS
   #ifdef COMPANY_BALANCE_ADJUSTMENTS   !added 2/20/6 to make for less restrictive inclusion
     do Get-Current-Adj-company
   #endif
  #endif
 
  !Cleanup and format COMPID and PAYGROUP for this set of taxbalances first
  !------------------------------------------------------------------------
  uppercase $Client_CompID
 
  !Pfizer's logic, set paygroup to 31L-INTL, if company 200, Paygroup 31L, Fica EE tax...
  !------------------------------------------------------------------------------------
  #if {SITE_ID} <> 'PFZ1'
 
    #ifndef PAYGROUP_ROLLUP
      Let $Client_PaygroupID = rpad($Client_PaygroupID,10,' ')
      uppercase $Client_PaygroupID
    #else
      let $Client_PaygroupID = '          '
    #endif
 
  #else                                              !PFE Mod - 01.23.2006
     move $Client_PaygroupID to $Save_PaygroupID     !PFE Mod - 01.23.2006
  #endif
 
  !------------------------------------------------
  !4/29/99 Added for Albemarle to remap APT --> ALB
  !------------------------------------------------
  #if {SITE_ID} = 'ALB1'
      if rtrim($Client_CompID,' ') = 'APT'
        move 'ALB' to $Client_CompID
      end-if
  #endif
 
  !added 8/1/08
  !-------------
  #if {SITE_ID} = 'TBN1'
      let $Client_CompID_trimmed = rtrim($Client_CompID,' ')
      evaluate $Client_CompID_trimmed
       when = '660'
       when = '661'
       when = '662'
       when = '663'
       when = '664'
       when = '658'
       when = '659'
       when = '669'
          let $Client_CompID = $Client_CompID_trimmed || 'P'     !  (Post Newsday Sale)
          break
       when-other
          break
      end-evaluate
  #endif
 
  show 'Process-Tax-Record: Writing Tax Balances, Company ' $Client_CompID ', TaxBalance Count = ' #Last_TaxBalance_Cnt
 
  #ifndef PAYGROUP_ROLLUP
  show 'Process-Tax-Record:                      Paygroup ' $Client_PaygroupID
  #endif
 
 
  let #tb_inx = 0
  while #tb_inx < #Last_TaxBalance_Cnt
    Add 1 to #tb_inx
    get $TaxBalance_Check_Dt       -
        $TaxBalance_State          -
        $TaxBalance_Locality       -
        $TaxBalance_Resident       -
        $TaxBalance_Tax_Class      -
        #TaxBalance_Nlgrs_Cur      -
        #TaxBalance_Txgrs_Cur      -
        #TaxBalance_Tax_Cur        -
        #TaxBalance_Gross_Cur      -
        #TaxBalance_Count          -
        #Female_TaxBalance_Count   -
        #Male_TaxBalance_Count     -
        $TaxBalance_ER_Generated   -
        $TaxBalance_Canada         -
      from TaxBalance(#tb_inx)    -
           TaxBalance_Check_Dt   -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Resident   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Cur  -
           TaxBalance_Txgrs_Cur  -
           TaxBalance_Tax_Cur    -
           TaxBalance_Gross_Cur    -
           TaxBalance_Count      -
           Female_TaxBalance_Count      -
           Male_TaxBalance_Count      -
           TaxBalance_ER_Generated -
           TaxBalance_Canada
 
  
        if $TaxBalance_Canada = 'Y'
         #ifdef CANADA_TOO
          #ifdef SPLIT_FEDERAL
           get $TaxBalance_Wage_loss_plan from TAXBALANCE(#tb_inx) TaxBalance_Wage_loss_plan
           #ifdef debug_split
            show 'Process-Tax-Record: TaxBalance_Wage_loss_plan ' $TaxBalance_Wage_loss_plan
           #endif
          #endif
         #endif
        else
          move '' to $TaxBalance_Wage_loss_plan
        end-if
 
        #ifdef CUSTOM_EMPLOYMENT_TYPE
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #if {SITE_ID} = 'KFC_OLD'
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #if {SITE_ID} = 'PRD1'
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #if {SITE_ID} = 'CHS1'
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #ifdef GENERAL_SUI_SPLIT_STATE
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #if {SITE_ID} = 'TLL1'
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #if {SITE_ID} = 'FTO1'
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
        #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
          get $Paygroup_LLC_Field from TAXBALANCE(#tb_inx) TaxBalance_LLC
        #endif
 
  let $Trimmed_Tax_Class = rtrim($TaxBalance_Tax_Class,' ')
  let $Trimmed_State    = rtrim($TaxBalance_State,' ')
  let $Trimmed_Locality = rtrim($TaxBalance_Locality,' ')
  let $Trimmed_Resident = rtrim($TaxBalance_Resident,' ')
 
  !Pfizer's logic, set paygroup to WL-FOR (vs 31L-INTL), if company 200, Paygroup 31L, Fica EE tax...
  !---------------------------------------------------------------------------------------------------
  #if {SITE_ID} = 'PFZ1'
 
     let $Client_PaygroupID = $Save_PaygroupID
     
     let $TempPaygroupID = '      '
 
     if (rtrim($Client_CompID,' ') = '200')
      if  (rtrim($Client_PaygroupID,' ') = '31L') or (rtrim($Client_PaygroupID,' ') = '21L')
       or (rtrim($Client_PaygroupID,' ') = 'FSL') or (rtrim($Client_PaygroupID,' ') = 'PHL')
       or (rtrim($Client_PaygroupID,' ') = 'A6S') or (rtrim($Client_PaygroupID,' ') = 'A7S')   !Added 5/1/2012
       if $Trimmed_State = '$U' AND  ( ($Trimmed_Tax_Class = 'D') OR ($Trimmed_Tax_Class = 'F')
                                   OR  ($Trimmed_Tax_Class = 'E') OR ($Trimmed_Tax_Class = 'Q'))
        
        let $TempPaygroupID = 'WL-FOR'
        Add #TaxBalance_Tax_Cur to #Hash_Total_Tax_WL_FicaEE_Intl
       end-if
      end-if
 
     end-if
     
     !we might need to add the 'virtual company code' into the last of the postions 11-14 of the header (2012 acquisition)
     #ifdef PFZ1_2012_BANKING_SPLIT
          do Get-Banking-Split-PFZ1  !returns: $HLD_VIRTUAL_CO = 'N'/'Y' and $PFZ1_VIRTUAL_CO would be the virtual company code if 'Y'
          if $HLD_VIRTUAL_CO = 'Y'
 
            let $TempPaygroupID = $TempPaygroupID || $PFZ1_VIRTUAL_CO 
            do Log-Banking-Split-PFZ1   !save #TaxBalance_Tax_Cur for company $PFZ1_VIRTUAL_CO
          end-if
     #endif
     
     let $Client_PaygroupID = $TempPaygroupID
 
  #endif
 
  do Build-Taxcode
 
  !---------------------------------------------------------------
  !Added for Eli Lilly to use Check Date from control card instead
  !of Check Date from Pay Calendar
  !---------------------------------------------------------------
  #if {SITE_ID} = 'ELI1' 
 
    !Modification A
    Do Convert-to-DTU-Date ($LLY_Input_Check_Dt,$TaxBalance_Check_Dt_DTU)
 
  #else
      Do Convert-to-DTU-Date($TaxBalance_Check_Dt,$TaxBalance_Check_Dt_DTU)
  #end-if
 
  let $CkDt_Mo           = substr($TaxBalance_Check_Dt_DTU,6,2)
  let $CkDt_Day          = substr($TaxBalance_Check_Dt_DTU,9,2)
  let $CkDt_Yr           = substr($TaxBalance_Check_Dt_DTU,1,4)
 
 
  !------------------------------------------------------------
  !if NL Gross is 0, set to Taxable gross
  !------------------------------------------------------------
  if #TaxBalance_Nlgrs_Cur = 0
   Let #TaxBalance_Nlgrs_Cur = #TaxBalance_Txgrs_Cur
  End-if
 
  #ifndef CALC_TOTAL_GROSS
    let #TaxBalance_Gross_Cur = #TaxBalance_Nlgrs_Cur !Gross <-- NLgrs for now
  #endif
 
  do Update-TaxTotals
 
  let #T  = #TaxBalance_Nlgrs_Cur * 100
  do Format-Number(#t,$TaxBalance_Nlgrs_Cur, '999999999999999mi')
 
  let #T = #TaxBalance_Txgrs_Cur * 100
  do Format-Number(#t,$TaxBalance_Txgrs_Cur, '999999999999999mi')
 
  let #T = #TaxBalance_Tax_Cur * 100
  do Format-Number(#t,$TaxBalance_Tax_Cur,   '999999999999999mi')
 
  let #T = #TaxBalance_Gross_Cur * 100
  do Format-Number(#t,$TaxBalance_Gross_Cur,   '999999999999999mi')
 
  !4/10/06 Counts were for just Canada until the AL Sit Requirement
  !--------------------------------------------------------------------
  !  if rtrim($TaxBalance_Canada,' ') <> 'Y'
  !    let #TaxBalance_Count = 0
  !  end-if
  !--------------------------------------------------------------------
 
  do Format-Number(#TaxBalance_Count,$Canada_TaxBalance_Count,        '999999')
  do Format-Number(#Female_TaxBalance_Count,$Female_TaxBalance_Count, '99999')
  do Format-Number(#Male_TaxBalance_Count,$Male_TaxBalance_Count,     '99999')
 
  do Write-Tax-Record
 
 end-while
 
 
 display '.  TaxBalances written.'
 
end-procedure
 
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Write-Tax-Record                                          !
! Desc:      This procedure creates/writes the ProBusiness Tax record  !
!            (specified in the  periodic specs)                        !
!----------------------------------------------------------------------!
 
begin-procedure Write-Tax-Record
 
 
       #ifdef HOLD_CREDITS
        if round(#TaxBalance_Tax_Cur,2) <> 0
          let #orig_TaxBalance_Tax_Cur = #TaxBalance_Tax_Cur
          let $Credit_Compid_in    = $Client_CompID || ' ' || $Client_PaygroupID
          let $Credit_Compid_in    = rtrim($Credit_Compid_in,' ')
          let $Credit_Liab_date_dtu = $CkDt_Yr || '-' || $CkDt_Mo || '-' || $CkDt_Day
          Do Convert-From-DTU-Date($Credit_Liab_date_dtu,$Credit_Liab_date_in)
          let $Credit_Taxcode_in   = rtrim($TaxCode,' ')
          let #Credit_Taxes_in     = #TaxBalance_Tax_Cur
 
          do Check-For-Credits  !returns $Credit Status of 'Y' if a new tax has been computed
 
          if $Credit_status = 'Y'
            let #TaxBalance_Tax_Cur = #Credit_Taxes_out
            let #t = #TaxBalance_Tax_Cur * 100
            do Format-Number(#t,$TaxBalance_Tax_Cur,   '999999999999999mi')
          else
           let #Credit_Taxes_out = 0
          end-if
        
          #ifdef generate-extract-report-summary                     
	   do insert-taxes-into-check-date-totals-for-credit-summary !$Taxcode  $Client_CompID $TaxBalance_Check_Dt #Orig_TaxBalance_Tax_Cur           
	   if #TaxBalance_Tax_Cur < 0
             do insert-taxes-into-negative-totals
           end-if
          #endif
 
        end-if
       #endif
       
       
       do insert-taxes-into-check-date-totals
 
       !Paygroup, Company and Grand Hash Totaling
       !-------------------------------
       Add #TaxBalance_Tax_Cur   to #Paygroup_Total_Tax
       Add #TaxBalance_Txgrs_Cur to #Paygroup_Total_Taxable_Wages
       Add #TaxBalance_Nlgrs_Cur to #Paygroup_Total_Gross_Wages
 
       Add #TaxBalance_Tax_Cur   to #Company_Total_Tax
       Add #TaxBalance_Txgrs_Cur to #Company_Total_Taxable_Wages
       Add #TaxBalance_Nlgrs_Cur to #Company_Total_Gross_Wages
 
       Add #TaxBalance_Tax_Cur   to #Fein_Total_Tax
       Add #TaxBalance_Txgrs_Cur to #Fein_Total_Taxable_Wages
       Add #TaxBalance_Nlgrs_Cur to #Fein_Total_Gross_Wages
 
       Add #TaxBalance_Tax_Cur   to #ADP_Compid_Total_Tax
       Add #TaxBalance_Txgrs_Cur to #ADP_Compid_Total_Taxable_Wages
       Add #TaxBalance_Nlgrs_Cur to #ADP_Compid_Total_Gross_Wages
 
       Add #TaxBalance_Tax_Cur   to #Hash_Total_Tax
       Add #TaxBalance_Txgrs_Cur to #Hash_Total_Taxable_Wages
       Add #TaxBalance_Nlgrs_Cur to #Hash_Total_Gross_Wages
       !---------------------------------
 
       !10/13/98 Mod for Local ER Taxes
       !-------------------------------
       #if {Peoplesoft_Version} >= '7.5'
        if rtrim($TAXBALANCE_STATE,' ') <> '$U'         ! State (not federal)
         if rtrim($TAXBALANCE_TAX_CLASS,' ') = 'R'      ! ER Local
          Add #TaxBalance_Tax_Cur to #Local_ER_Tax
          Add #TaxBalance_Tax_Cur to #Hash_Local_ER_Tax
         end-if
        end-if
       #endif
 
 
       let $output_paygroup = rtrim($Client_PaygroupID,' ')
 
       #ifdef CUSTOM_EMPLOYMENT_TYPE
         let $output_paygroup = $Paygroup_LLC_Field
       #endif
       
       #if {SITE_ID} = 'PRD1'
         let $output_paygroup = $Paygroup_LLC_Field
       #endif
 
       #if {SITE_ID} = 'CHS1'
         let $output_paygroup = $Paygroup_LLC_Field
       #endif
       #ifdef GENERAL_SUI_SPLIT_STATE
         let $output_paygroup = $Paygroup_LLC_Field
       #endif
       
       #if {SITE_ID} = 'TLL1'
        #ifdef TOLL_FAIRLESS_HILLS_COMPID
         let $output_paygroup = $Paygroup_LLC_Field
         if $Paygroup_LLC_Field = '{TOLL_FAIRLESS_HILLS_COMPID}'
           Add #TaxBalance_Tax_Cur   to #Hash_Total_Tax_NGR2
         end-if
        #endif
       #endif
 
       #if {SITE_ID} = 'KFC_OLD'
         let $output_paygroup = $output_paygroup || $Paygroup_LLC_Field
       #endif
 
 
      if rtrim($Taxcode,' ') = '{FORM1042_Taxcode}'
       OR rtrim($Taxcode,' ') = '{FORM945P_Taxcode}'
       OR rtrim($Taxcode,' ') = 'FORM943'
         Add #TaxBalance_Tax_Cur   to #Hash_Total_Tax_Non_941
         Add #TaxBalance_Txgrs_Cur to #Hash_Total_Taxable_Wages_Non_941
         Add #TaxBalance_Tax_Cur   to #Company_Total_Tax_Non_941
         Add #TaxBalance_Txgrs_Cur to #Company_Total_Taxable_Wages_Non_941
         Add #TaxBalance_Tax_Cur   to #Fein_Total_Tax_Non_941
         Add #TaxBalance_Txgrs_Cur to #Fein_Total_Taxable_Wages_Non_941
         Add #TaxBalance_Tax_Cur   to #ADP_Compid_Total_Tax_Non_941
         Add #TaxBalance_Txgrs_Cur to #ADP_Compid_Total_Taxable_Wages_Non_941
 
      else
 
 
       !totals
       !------
       
       #ifdef GL_TAX_CHECK_DATE_BREAKOUT
         do GL-accumulate-totals       
       #endif
       
       
       if $Trimmed_State = '$U' or $Trimmed_State = '$E'  !02B change $EC for EIC too
          evaluate $Trimmed_Tax_Class
           when = 'H'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UH
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UH_C
           when = 'U'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UU
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UU_C
           when = 'D'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UD
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UD_C
           when = 'E'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UE
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UE_C
           when = 'F'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UF
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UF_C
           when = '7'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U7
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U7_C
           when = 'Q'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UQ
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UQ_C
           when = 'C'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UC
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UC_C
           when = 'G'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UG
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UG_C
           when = 'J'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UJ
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UJ_C
           when = 'T'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UT
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UT_C
           when = 'Z'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UZ
             Add #TaxBalance_Tax_Cur   to #Hash_Total_UZ_C
           when = '6'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U6
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U6_C
           when = '8'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U8
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U8_C
           when = '9'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U9
             Add #TaxBalance_Tax_Cur   to #Hash_Total_U9_C
             
           when-other
             break
 
          end-evaluate
 
       else
         if $Trimmed_locality = ''
          evaluate $Trimmed_Tax_Class
           when = 'H'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STH
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STH_C
           when = 'D'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STD
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STD_C
           when = 'E'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STE
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STE_C
           when = 'U'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STU
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STU_C
           when = 'S'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STS
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STS_C
           when = 'V'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STV
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STV_C
           when = 'L'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STL
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STL_C
           when = 'M'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STM
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STM_C
           when = 'N'
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STN
             Add #TaxBalance_Tax_Cur   to #Hash_Total_STN_C
 
           when = 'I'
             if $Trimmed_State = 'NJ' 
               Add #TaxBalance_Tax_Cur   to #Hash_Total_FLIEE
               Add #TaxBalance_Tax_Cur   to #Hash_Total_FLIEE_C
             end-if
           when = 'O'
             if $Trimmed_State = 'NJ' 
               Add #TaxBalance_Tax_Cur   to #Hash_Total_VFLIEE
               Add #TaxBalance_Tax_Cur   to #Hash_Total_VFLIEE_C
             end-if
           when = 'Y'
             if $Trimmed_State = 'NJ' 
               Add #TaxBalance_Tax_Cur   to #Hash_Total_VFLIER
               Add #TaxBalance_Tax_Cur   to #Hash_Total_VFLIER_C
             end-if
 
           when-other
             break
          end-evaluate
        else
             Add #TaxBalance_Tax_Cur   to #Hash_Total_Local
             Add #TaxBalance_Tax_Cur   to #Hash_Total_Local_C
        end-if
       end-if
      end-if
 
      !---------------------------------------------------------------------------
      ! 4/1/04 - 945 & 1042 split too, appending 945 or 1042 onto the company codes
      ! ADP can only handle one 'class' / company (941, 945, 1042, RR,...)
      !---------------------------------------------------------------------------
      #ifndef NO_943_945_1042_COMPID_REMAP
 
       let $TestNon941_Append = ''
       if (rtrim($Taxcode,' ') = '{FORM945P_Taxcode}')
         let $TestNon941_Append = '945'
       else
        if (rtrim($Taxcode,' ') = '{FORM1042_Taxcode}')
         let $TestNon941_Append = '1042'
        else
         if (rtrim($Taxcode,' ') = 'FORM943')
          let $TestNon941_Append = '943'
         end-if
        end-if
       end-if
 
        if rtrim($TestNon941_Append,' ') <> ''
         Let $Extract_compid = $Client_CompID || $TestNon941_Append || ' ' || $output_paygroup
         display 'Form 945/1042 Remapping to company: ' noline
         display $Extract_compid
         goto done_reestablish_compid
        end-if
 
       #endif
 
     #if {SITE_ID} = 'BLB1'  !5/26/05 - $UHMP instead of $UH for company 309, Saipan
        if rtrim($Client_CompID,' ') = '309'
         if rtrim($TaxCode,' ') = '$UH'
          Let $TaxCode  = '$UHMP          '
         end-if
      end-if
     #endif
 
 
 
       !remap all PR Backup W/H taxes to company ADPPRB or PRPPRB 3/31/04
       !------------------------------------------------------------------
       #if {SITE_ID} = 'AXA1'
         move  $Client_CompID to $AXA_Compid
         if rtrim($Client_CompID,' ') = 'ADP' OR rtrim($Client_CompID,' ') = 'PRP'
 
           let $remap_AXA = 'f'
           if ($Trimmed_State = 'PR') AND ($Trimmed_Tax_Class = 'H') AND (substr($Trimmed_Locality,1,4) = 'PRBK')
               let $remap_AXA = 't'
           end-if
 
           if rtrim($remap_AXA,' ') = 't'
             let $AXA_Compid = $Client_CompID || 'PRB'
             display 'Backup PR withholding moved to company: ' noline
             display $AXA_Compid
             if rtrim($AXA_Compid,' ') = 'ADPPRB'
              add #TaxBalance_Tax_CUR to #TaxBalance_Tax_Cur_Remapped_to_ADPPRB
             else
              add #TaxBalance_Tax_CUR to #TaxBalance_Tax_Cur_Remapped_to_PRPPRB
             end-if
           end-if
 
         end-if
       #endif
 
       !1/6/6
       !-----------------------------------------
       #if {SITE_ID} = 'CGI1'
         move  $Client_CompID to $CGI1_Compid
         if rtrim($Client_CompID,' ') = '630'
           move  '029' to $CGI1_Compid
         end-if
       #endif
 
       !3/19/8 change remap MRR and MBR taxcodes to COMPANY || RR
       !----------------------------------------------------------
       #if {SITE_ID} = 'BCD1'
 
         move  $Client_CompID to $Boise_Compid
 
         if rtrim($Client_CompID,' ') = 'MRR' OR rtrim($Client_CompID,' ') = 'BRR'
 
           !MN B TIER1    Tier I Employee Tax
           !MN B TIER1ER  Tier I Employer Tax
           !MN B TIERA    Tier I Medicare Emloyee Tax
           !MN B TIERAER  Tier I Medicare Employer Tax
           !MN H TIER2    Tier II Employee Tax
           !MN R TIERR    Tier II Employer Tax
           !MN R RUIA     RUIA Employer Tax
 
           if  substr($Taxcode,1,7) = 'MNBTIER'
            OR substr($Taxcode,1,7) = 'MNHTIER'
            OR substr($Taxcode,1,7) = 'MNRRUIA'
            OR substr($Taxcode,1,7) = 'MNRTIER'
 
            let $Boise_Compid = $Client_CompID || 'RR'
            display $Boise_Compid
            add #TaxBalance_Tax_CUR to #TaxBalance_Tax_Cur_Remapped_to_RR
           end-if
         end-if
 
       #endif
 
 
       !4/1/04 remap RR taxcodes to COMPANY || RR
       !-----------------------------------------
       #if {SITE_ID} = 'CSX1'
 
           move  $Client_CompID to $CSX_Compid
 
           !Client code	ADP description	Pro description
           !$U6            	EMPLOYEE SOCIAL SECURITY	Tier I Compensation Tax - EE
           !$U7            	EMPLOYER SOCIAL SECURITY	Tier II Compensation Tax -EE
           !$U8            	EMPLOYER SOCIAL SECURITY	Tier II Compensation Tax -ER
           !$U9            	EMPLOYEE FEDERAL MEDICARE	Tier I Medicare - EE
           !TIER1MEDC      	EMPLOYEE FEDERAL MEDICARE
           !TIER1SDIC      	EMPLOYEE SOCIAL SECURITY
 
            !11/26/2013 -Move existing RRTA Tax Classes to other assigned, but unused Tax Classes.
               !6 RRTA Tier I	        ->	G OASDI/EE - Tips
               !7 RRTA Tier II	        ->	T FICA Med Hospital Ins/EE - Tips
               !8 RRTA Tier II Employer	->	J OASDI/ER - Tips
               !9 RRTA Medicare	        ->	Z FICA Med Hospital Ins/ER - Tips
 		 	 	
               !Move previously re-assigned Tax Classes back to their original assignments
               !0 FICA Add. FUTA Tax Expenses	->	6 FICA Add. FUTA Tax Expenses
               !1 FICA Medicare High Earners	->	7 FICA Medicare High Earners
               !2 FICA ER Exempt       	        ->	8 FICA ER Exempt 
               !3 FICA ER Tips Exempt	        ->	9 FICA ER Tips Exempt
 
               ! #define EE_Tier1_MED       $UG
               ! #define EE_Tier1_SS        $UZ
               ! #define EE_Tier1_MED_ADDL  $UK
  
!05312013, $U8 removed on 11/26/2013
 
            if rtrim($Taxcode,' ') = '{EE_Tier1_MED}'   OR
               rtrim($Taxcode,' ') = '{EE_Tier1_SS}'    OR
               rtrim($Taxcode,' ') = '$UT'       OR
               rtrim($Taxcode,' ') = '$UJ'       OR
               rtrim($Taxcode,' ') = 'TIER1MEDC' OR
               rtrim($Taxcode,' ') = 'TIER1SDIC' OR
               rtrim($Taxcode,' ') = '{EE_Tier1_MED_ADDL}'
!--------------              
 
             let $CSX_Compid = $Client_CompID || 'RR'
             display 'CSX RR Remapping to company: ' noline
             display $CSX_Compid
             add #TaxBalance_Tax_CUR to #TaxBalance_Tax_Cur_Remapped_to_RR
           end-if
 
       #endif
 
       #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
         move  $Client_CompID to $CSE1_Compid
         if $Paygroup_LLC_Field = rtrim('{CSE1_REMAP_FICA_MED_TO_COMPANY}',' ')
            Let $CSE1_Compid = $Paygroup_LLC_Field
         end-if
       #endif
 
 
  #if {SITE_ID} = 'FTO1'
        Let $Extract_compid = $Paygroup_LLC_Field
        goto done_reestablish_compid
  #endif
  #if {SITE_ID} = 'AXA1'
        Let $Extract_compid = $AXA_CompID
        goto done_reestablish_compid
  #endif
  #if {SITE_ID} = 'CSX1'
        #ifdef PAYGROUP_ROLLUP
          Let $Extract_compid = $CSX_CompID
        #else
          Let $Extract_compid = $CSX_CompID || ' ' || $output_paygroup
        #endif
        goto done_reestablish_compid
  #endif
  #if {SITE_ID} = 'BCD1'
        Let $Extract_compid = $BOISE_CompID
        goto done_reestablish_compid
  #endif
  #if {SITE_ID} = 'CGI1'
        Let $Extract_compid = $CGI1_CompID
  #endif
  #ifdef CSE1_REMAP_FICA_MED_TO_COMPANY
        Let $Extract_compid = $CSE1_Compid
        goto done_reestablish_compid
  #endif
 
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
        Let $Extract_compid = $Current_ADP_CompID
        goto done_reestablish_compid
  #endif
 
  !5/26/09 added
  #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
        Let $Extract_compid = $Current_SRC_BANK_ID
        goto done_reestablish_compid
  #endif
 
   #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
         Let $Extract_compid = $Current_BusUnit_CompID
         goto done_reestablish_compid
  #endif
  
  Let $Extract_compid = $Client_CompID || ' ' || $output_paygroup
 
done_reestablish_compid:
 
  ! SCR1
  ! ---------
  #ifdef ENABLE_SCR1_REMAPPING
 
         let $SCR1_Compid = $Client_CompID
 
         !if one of the special SCR1 companies... don't use a prefix (added 7/3/03)
         !------------------------------------------------------------------------------
         if    rtrim($Client_CompID,' ') <> '44'   !Renaissance Center Management
           AND rtrim($Client_CompID,' ') <> '51'   !Pinkerton Govt. Services
           AND rtrim($Client_CompID,' ') <> '50'   !Paragon
 
           !otherwise, add the EAST/WEST Coast prefix/designator depending on the database
           !-------------------------------------------------------------------------------
           if rtrim($database,' ') = '{EAST_PROD_DB}'
            let $SCR1_Compid = '{EAST_PREFIX}' || $Client_CompID
           end-if
 
           if rtrim($database,' ') = '{WEST_PROD_DB}'
            let $SCR1_Compid = '{WEST_PREFIX}' || $Client_CompID
           end-if
 
         end-if
 
         Let $Extract_compid = $SCR1_Compid
 
  #endif
 
  #if {Periodic_extract_specs} >= '3.00'  !ADP
 
    if #reccnt = 0                ! *** we're deciding the format on the FIRST tax balance
     #ifdef ADP_LIVE_DATE_DTU
      show 'TaxBalance_Check_Dt_DTU ' $TaxBalance_Check_Dt_DTU
      show 'ADP_LIVE_DATE_DTU       ' '{ADP_LIVE_DATE_DTU}'
      if ($TaxBalance_Check_Dt_DTU < '{ADP_LIVE_DATE_DTU}')
        let $adp_format = 'f'
      end-if
      show 'adp_format              ' $adp_format
     #endif
   else
     !--------------------------------------------------------------------
     !bail out if we have cross ADP live date boundry liability condition
     !--------------------------------------------------------------------
     #ifdef ADP_LIVE_DATE_DTU
      if ( ($adp_format = 'f') AND ($TaxBalance_Check_Dt_DTU >= '{ADP_LIVE_DATE_DTU}') ) OR
         ( ($adp_format = 't') AND ($TaxBalance_Check_Dt_DTU < '{ADP_LIVE_DATE_DTU}') )
 
        show ' '
        show  'Warning: Invalid sequence of liability dates'
        show  '         Dates cross ADP Live Date {ADP_LIVE_DATE_DTU}'
 
        !print 'Warning: Invalid sequence of liability dates'            (+1,10)
        !print '         Dates cross ADP Live Date {ADP_LIVE_DATE_DTU}'  (+1,10)
        !stop
      end-if
     #endif
   end-if
 
  if $adp_format = 't'
 
    if #reccnt = 0
      let $extract_mode = 'P'      !Periodic file header moved to here on 7/18 to have AsofDate set to pay_end_Dt
      show 'Calling Write-File-Header-Rec: $AsofDate = ' $AsOfDate
      do Write-File-Header-Rec     !for 3PSP logic
    end-if
 
    if (rtrim($Header_rec_compid,' ') <> rtrim($Extract_compid,' ')) or
       (rtrim($Header_rec_liab_dt_dtu,' ') <> rtrim($TaxBalance_Check_Dt_DTU,' '))
 
      if rtrim($Header_rec_compid,' ') <> ''      !write preceding trailer if not first set of data
 
        display 'Writing Trailer rec for compid ' noline
        display $Header_rec_compid                noline
        display ', Liability Date '               noline
        display $Header_rec_liab_dt_dtu
 
        #ifdef PAYGROUP_ROLLUP_EXTRACT
          do Output-PAYGROUP_ROLLUP_EXTRACT  !in adp303p.sqc
        #endif
 
        do Write-Company-Trailer-Rec
        let #company_trailer_reccnt = 0
        let #Company_trailer_Total_Tax = 0
 
      end-if
 
      display 'Writing Header rec for compid ' noline
      display $Extract_compid                  noline
      display ', Liability Date '              noline
      display $TaxBalance_Check_Dt_DTU
 
      do Write-Company-Header-Rec
      move $Extract_compid to $Header_rec_compid
      move $TaxBalance_Check_Dt_DTU to $Header_rec_liab_dt_dtu
 
     end-if
 
     !-------------------------------------------------------------------------------------------
     !if GENERATE_PROBUSINESS_LAYOUT_ALWAYS we'll generate a file for the matching ProBusiness
     !records.  If SPLIT_CANADA_TO_PROBUSINESS, then only the canadian taxes will
     !show up in ProBusiness format, and the US taxes will be in the ADP file
     !-------------------------------------------------------------------------------------------
     #ifdef GENERATE_PROBUSINESS_LAYOUT_ALWAYS
      #ifndef SPLIT_CANADA_TO_PROBUSINESS
       let #chan=7
       DO Write-ProBiz-Format-Data-Record         !some clients want BOTH files generated
      #else
        if $TaxBalance_Canada = 'Y'
         let #chan=7
         DO Write-ProBiz-Format-Data-Record       !only Canada going into this file
        end-if
      #endif
     #endif
 
     if $TaxBalance_Canada = 'Y'
      #ifndef SPLIT_CANADA_TO_PROBUSINESS
       DO Write-ADP-Format-Data-Record
      #endif
     else
       DO Write-ADP-Format-Data-Record
     end-if
     !-------------------------------------------------------------------------------------------
 
    else
      let #chan=1
      DO Write-ProBiz-Format-Data-Record
    end-if
 
  #else
    let #chan=1
    DO Write-ProBiz-Format-Data-Record
  #endif
 
 
end-procedure
 
begin-procedure Write-ProBiz-Format-Data-Record
 
    #if {SITE_ID} = 'PFZ1'   
           Write #chan FROM   $Client_CompID:3
                              ' ':1
                              $Save_PaygroupID:3
                              '       ':7
                                 $CkDt_Yr:4                          !check date
                                 $CkDt_Mo:2
                                 $CkDt_Day:2
                                 $TaxCode:15                         !tax code
                                 $TaxBalance_Tax_Cur:16              !current w/h
                                 $TaxBalance_Txgrs_Cur:16            !current taxable
                                 $TaxBalance_Nlgrs_Cur:16            !current subject
                                 $Zero:16                            !QTD w/h
                                 $Zero:16                            !QTD taxable
                                 $Zero:16                            !QTD gross
                                 $Zero:16                            !YTD w/h
                                 $Zero:16                            !YTD taxable
                                 $Zero:16                            !YTD gross
                                 $Canada_TaxBalance_Count:6                 !# of employees who paid this tax
                                 #ifdef ADD_CR_UNDER_UNIX
                                  #ifdef UNIX
                                    $CR:1
                                  #endif
                                 #endif
   #else
         Write #chan FROM   $Extract_compid:14
                          $CkDt_Yr:4                          !check date
                          $CkDt_Mo:2
                          $CkDt_Day:2
                          $TaxCode:15                         !tax code
                          $TaxBalance_Tax_Cur:16              !current w/h
                          $TaxBalance_Txgrs_Cur:16            !current taxable
                          $TaxBalance_Nlgrs_Cur:16            !current subject
                          $Zero:16                            !QTD w/h
                          $Zero:16                            !QTD taxable
                          $Zero:16                            !QTD gross
                          $Zero:16                            !YTD w/h
                          $Zero:16                            !YTD taxable
                          $Zero:16                            !YTD gross
                          $Canada_TaxBalance_Count:6                 !# of employees who paid this tax
                          #ifdef ADD_CR_UNDER_UNIX
                           #ifdef UNIX
                             $CR:1
                           #endif
                          #endif
   #endif
   
end-procedure
 
 
begin-procedure Get-periodic-Job-Data
 
  let $job_tax_location_cd   = ''
  let $job_paygroup          = ''
  let $job_business_unit     = ''
 
BEGIN-SELECT
JB.TAX_LOCATION_CD
JB.BUSINESS_UNIT
JB.PAYGROUP
 
  let $job_tax_location_cd   = rtrim(&JB.TAX_LOCATION_CD,' ')
  let $job_paygroup          = rtrim(&JB.PAYGROUP,' ')
  let $job_business_unit     = rtrim(&JB.BUSINESS_UNIT,' ')
 
  From  PS_JOB JB
  Where JB.EMPLID     = $payline_emplid
    AND JB.COMPANY    = $payline_Company
    AND JB.EFFDT =
      (SELECT MAX(JB1.EFFDT)
       FROM   PS_JOB JB1
       WHERE JB1.EMPLID    = JB.EMPLID
         AND JB1.COMPANY   = JB.COMPANY
         AND JB1.{emp_rec} = JB.{emp_rec}
         AND JB1.EFFDT    <= $INPUT_PAY_END_DT)
         AND JB.EFFSEQ =
          (SELECT MAX(JB2.EFFSEQ)
           FROM  PS_JOB JB2
           WHERE JB2.EMPLID   = JB.EMPLID
            AND JB2.COMPANY   = JB.COMPANY
            AND JB2.{emp_rec} = JB.{emp_rec}
            AND JB2.EFFDT     = JB.EFFDT)
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-procedure
 
 
 
 
#if {SITE_ID} = 'ELI1' 
 
begin-procedure Get-Lilly-Deptid
 
   #ifdef show_selects
     display 'Processing PS_JOB...'
   #endif
 
   let $Job_DeptId   = ' '
 
BEGIN-SELECT
JB.DEPTID
 
  let $Job_DeptId   = rtrim(&JB.DEPTID,' ')
 
  From  PS_JOB JB
  Where JB.EMPLID     = $payline_emplid
    AND JB.COMPANY    = $trimmed_Company
    AND JB.EFFDT =
      (SELECT MAX(JB1.EFFDT)
       FROM   PS_JOB JB1
       WHERE JB1.EMPLID    = JB.EMPLID
         AND JB1.COMPANY   = JB.COMPANY
         AND JB1.{emp_rec} = JB.{emp_rec}
         AND JB1.EFFDT    <= $INPUT_PAY_END_DT)
         AND JB.EFFSEQ =
          (SELECT MAX(JB2.EFFSEQ)
           FROM  PS_JOB JB2
           WHERE JB2.EMPLID   = JB.EMPLID
            AND JB2.COMPANY   = JB.COMPANY
            AND JB2.{emp_rec} = JB.{emp_rec}
            AND JB2.EFFDT     = JB.EFFDT)
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
 #ifdef show_selects
    display '...finished PS_JOB Select...'
 #endif
 
end-procedure
 
#endif
 
 
 
 
#if {SITE_ID} = 'PRD1'
 
begin-procedure Get-PRD1-Employment_type
 
   #ifdef show_selects
     display 'Processing PS_JOB...'
   #endif
 
   let $Employment_type    = ''
   let $Paygroup_LLC_Field = ''
 
   #ifdef TEST_EMPLID
      show 'Get-PRD1-Employment_type ' $payline_emplid
      show '            pay end dt     ' $payline_pay_end_dt
      show '            company        ' $payline_company
   #endif
 
BEGIN-SELECT
JB.Employment_type
 
  let $Employment_type   = rtrim(&JB.Employment_type,' ')
 
  if rtrim($Employment_type,' ') = 'A'
    let $Paygroup_LLC_Field = 'AG'          !Agri. 943 company remapping
  end-if
 
  #ifdef TEST_EMPLID
      show '       Employment_type     ' $Employment_type
      show '       Paygroup_LLC_Field  ' $Paygroup_LLC_Field
  #endif
 
  From  PS_JOB JB
  Where JB.EMPLID     = $payline_emplid
    AND JB.COMPANY    = $payline_company  !2/15/06 was $trimmed_Company, missing first AG taxcode, for first ee
    AND JB.EFFDT =
      (SELECT MAX(JB1.EFFDT)
       FROM   PS_JOB JB1
       WHERE JB1.EMPLID    = JB.EMPLID
         AND JB1.COMPANY   = JB.COMPANY
         AND JB1.{emp_rec} = JB.{emp_rec}
         AND JB1.EFFDT    <= $Payline_pay_end_dt)
         AND JB.EFFSEQ =
          (SELECT MAX(JB2.EFFSEQ)
           FROM  PS_JOB JB2
           WHERE JB2.EMPLID   = JB.EMPLID
            AND JB2.COMPANY   = JB.COMPANY
            AND JB2.{emp_rec} = JB.{emp_rec}
            AND JB2.EFFDT     = JB.EFFDT)
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
 #ifdef show_selects
    display '...finished PS_JOB Select...'
 #endif
 
end-procedure
 
#endif
 
 
 
 
#if {SITE_ID} = 'TLL1'
 
begin-procedure Get-Toll-Location
   #ifdef show_selects
     display 'Processing PS_JOB...'
   #endif
 
   let $Job_Location    = ''
   let $Paygroup_LLC_Field = ''
 
   #ifdef TEST_EMPLID
      show 'Get-PRD1-Employment_type ' $payline_emplid
      show '            pay end dt     ' $payline_pay_end_dt
      show '            company        ' $payline_company
   #endif
 
BEGIN-SELECT
JB.LOCATION
 
  let $Job_Location   = rtrim(&JB.LOCATION,' ')
 
  if rtrim($Job_Location,' ') = rtrim('{TOLL_FAIRLESS_HILLS_LOCATION}',' ')
    let $Paygroup_LLC_Field = '{TOLL_FAIRLESS_HILLS_COMPID}'
  end-if
 
  #ifdef TEST_EMPLID
      show '       Location            ' $Job_Location
      show '       Paygroup_LLC_Field  ' $Paygroup_LLC_Field
  #else
   if $SelectEmplid <> ''
      show '       Location            ' $Job_Location
      show '       Paygroup_LLC_Field  ' $Paygroup_LLC_Field
   end-if
  #endif
 
  From  PS_JOB JB
  Where JB.EMPLID     = $payline_emplid
    AND JB.COMPANY    = $payline_company
    AND JB.EFFDT =
      (SELECT MAX(JB1.EFFDT)
       FROM   PS_JOB JB1
       WHERE JB1.EMPLID    = JB.EMPLID
         AND JB1.COMPANY   = JB.COMPANY
         AND JB1.{emp_rec} = JB.{emp_rec}
         AND JB1.EFFDT    <= $Payline_pay_end_dt)
         AND JB.EFFSEQ =
          (SELECT MAX(JB2.EFFSEQ)
           FROM  PS_JOB JB2
           WHERE JB2.EMPLID   = JB.EMPLID
            AND JB2.COMPANY   = JB.COMPANY
            AND JB2.{emp_rec} = JB.{emp_rec}
            AND JB2.EFFDT     = JB.EFFDT)
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
 #ifdef show_selects
    display '...finished PS_JOB Select...'
 #endif
 
end-procedure
 
#endif
 
#ifdef ADJUST_ZERO_LOCALS
begin-procedure adjust-zero-locals
 
  let #tb_inx = 0
  while #tb_inx < #Last_TaxBalance_Cnt
    Add 1 to #tb_inx
    get $TaxBalance_State          -
        $TaxBalance_Locality       -
        $TaxBalance_Resident       -
        $TaxBalance_Tax_Class      -
        #TaxBalance_Txgrs_Cur      -
        #TaxBalance_Tax_Cur        -
        $TaxBalance_Canada         -
      from TaxBalance(#tb_inx)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Resident   -
           TaxBalance_Tax_Class  -
           TaxBalance_Txgrs_Cur  -
           TaxBalance_Tax_Cur    -
           TaxBalance_Canada
 
        if $TaxBalance_Canada <> 'Y'
 
           let $state_trimmed	 = rtrim($TaxBalance_State,' ')
           let $Local_trimmed    = rtrim($TaxBalance_Locality,' ')
           let $class_trimmed	 = rtrim($TaxBalance_Tax_Class,' ')
           let $res_trimmed	 = rtrim($TaxBalance_resident,' ')
 
           if ($Local_trimmed <> '') and (#TaxBalance_Tax_Cur = 0)
            show 'adjust-zero-locals: Clearing locals, Txgrs = ' #TaxBalance_Txgrs_cur ', for Taxcode: ' $state_trimmed $class_trimmed $local_trimmed 
            add #TaxBalance_Txgrs_Cur to #TaxBalance_Txgrs_locals_cleared_company
            add #TaxBalance_Txgrs_Cur to #TaxBalance_Txgrs_locals_cleared_hash
            put 0   into TaxBalance(#tb_inx) TaxBalance_Nlgrs_Cur
            put 0   into TaxBalance(#tb_inx) TaxBalance_Txgrs_Cur
            put 0   into TaxBalance(#tb_inx) TaxBalance_Tax_Cur
           end-if
 
         end-if           
 
    end-while
 
end-procedure
 
#endif
 
 
 
begin-procedure insert-taxes-into-check-date-totals
 
   let #i = 0
   let $found = 'f'
   let $Current_BusUnit_CompID = rtrim($Current_BusUnit_CompID,' ')
   
   while (#i < #num_check_dates)
 
     #ifdef SUBTOTAL_TAXCODES_BY_CHECK_DATE
     
      get $CompID             -
          $PaygroupID         -
          $BusUnitID          -
          $Check_Dt           -
          $tx                 -
      from CheckDates(#i)     -
           CompID             -
           PaygroupID         -
           Business_Unit      -
           Check_Dt           -
           Taxcode
 
      if ($Check_Dt     = $TaxBalance_Check_Dt) and
         ($CompID       = $Client_CompID)       and
         ($PaygroupID   = $Client_PaygroupID)   and
         ($BusUnitID    = $Current_BusUnit_CompID) and
         ($tx           = $Taxcode)
       let $found = 't'
       break
      end-if
 
     #else
     
      get $CompID             -
          $PaygroupID         -
          $BusUnitID          -
          $Check_Dt           -
      from CheckDates(#i)     -
           CompID             -
           PaygroupID         -
           Business_Unit      -
           Check_Dt           
 
      if ($Check_Dt    = $TaxBalance_Check_Dt) and
        ($CompID       = $Client_CompID)       and
        ($BusUnitID    = $Current_BusUnit_CompID) and
        ($PaygroupID   = $Client_PaygroupID)   
       let $found = 't'
       break
      end-if
 
     #endif
     
     add 1 to #i
 
   end-while
 
 
   if $found = 'f'
 
     put   $Current_ADP_Compid       -
           #Current_FEIN             -
           $Client_CompID            -
           $Client_PaygroupID        -
           $Current_BusUnit_CompID     -
           $TaxBalance_Check_Dt      -
           #TaxBalance_Tax_Cur       -
           #TaxBalance_Txgrs_Cur     -
           #TaxBalance_Nlgrs_Cur     -
           #TaxBalance_Count         -
           $Taxcode                  -
     into CheckDates(#i)             -
           ADP_Compid                -
           Fein                      -
           CompId                    -
           PaygroupID                -
           Business_Unit             -
           Check_Dt                  -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           EE_Count                  -
           Taxcode
 
 
     add 1 to #num_check_dates
 
   else
 
     Array-Add #TaxBalance_Tax_Cur   -
           #TaxBalance_Txgrs_Cur     -
           #TaxBalance_Nlgrs_Cur     -
           #TaxBalance_Count         -
       to CheckDates(#i)             -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           EE_Count
 end-if
 
end-procedure
 
 
 
 
 
!************************************************************************  !
!----------------------------------------------------------------------    !
! Procedure: Update-TaxTotals                                              !
! Desc:      This procedure Updates the PAYGROUP, COMPANY, FEIN, and GRAND !
!            Totals in the TaxTotal Array. Note, the TaxTotals arry does   !
!            not get reset/cleared at all.  The amounts do, not the key    !
!            fields (state, locality, tax class, resident).                !
!----------------------------------------------------------------------    !
begin-procedure Update-TaxTotals
  Let #L1 = 0
  Let $MatchFound = 'N'
 
    #ifdef debug_pdf
       show 'updating totals... State ' $TaxBalance_State
       show 'Class ' $TaxBalance_Tax_Class
       show 'tax   ' #TaxBalance_Tax_Cur
    #endif
 
  while #L1 <= #LAST_TAXTOTAL_CNT    !changed from < to M= 8/13/02
     Add 1 to #L1
 
     get $TEST_ST                    -
         $TEST_LOCALITY              -
         $TEST_RESIDENT              -
         $TEST_TAX_CLASS             -
         from TAXTOTAL(#L1)          -
              TaxTotal_State         -
              TaxTotal_Locality      -
              TaxTotal_Resident      -
              TaxTotal_Tax_Class
 
    if    $Test_St        = $TaxBalance_State
      And $Test_Locality  = $TaxBalance_Locality
      And $Test_Resident  = $TaxBalance_Resident
      And $Test_Tax_Class = $TaxBalance_Tax_Class
       Let $MatchFound  = 'Y'
       break
    End-if
 
  end-while
 
 
  !----------------3/9/06 new sort  ------------------------------------
  let $taxcode_sort = $TaxBalance_State || $TaxBalance_Tax_Class ||
                      $TaxBalance_Locality || $TaxBalance_Resident
  let $taxcode_sort = rtrim($taxcode_sort,' ')
  !---------------------------------------------------------------------
    #ifdef debug_pdf
       show 'updating totals... taxcode_sort ' $taxcode_sort
    #endif
 
  If $MatchFound = 'N'
 
    #ifdef debug_pdf
       show 'updating totals... new'
    #endif
 
     If  #Last_TaxTotal_Cnt >= {TAX_LIMIT}
         Display 'Exceeded Maximum Tax Balances -- Expand Array'
         #ifdef MVS
          Move 5 to #Return-Status
         #end-if
         Stop
     End-if
 
    !-------------------------3/9/06 new sort  -------------------------
    let #s = 1
    while #s <= #LAST_TAXTOTAL_CNT
     get $taxcode_test from TAXTOTAL(#s)    TaxTotal_Taxcode_sort
 
     #ifdef debug_pdf
       show 'updating totals... taxcode_test ' $taxcode_test
     #endif
 
     if $taxcode_SORT < $taxcode_TEST
 
       !shift data forward in array
       let #count = #LAST_TAXTOTAL_CNT
 
       #ifdef debug_pdf
         show 'updating totals... shifting, #count = ' #count
       #endif
 
       while #count >= #s
        get $TBalance_State        -
         $TBalance_Locality        -
         $TBalance_Resident        -
         $TBalance_Tax_Class       -
         $TBalance_ER_Generated    -
         $TBalance_Canada          -
         $TBtaxcode_sort           -
         from TAXTOTAL(#count)       -
             TaxTotal_State          -
             TaxTotal_Locality       -
             TaxTotal_Resident       -
             TaxTotal_Tax_Class      -
             TaxTotal_ER_Generated   -
             TaxTotal_Canada         -
             TaxTotal_Taxcode_sort
 
        let #so = #count + 1
 
        Put $TBalance_State        -
         $TBalance_Locality        -
         $TBalance_Resident        -
         $TBalance_Tax_Class       -
         $TBalance_ER_Generated    -
         $TBalance_Canada          -
         $TBtaxcode_sort           -
         Into TAXTOTAL(#so)          -
             TaxTotal_State          -
             TaxTotal_Locality       -
             TaxTotal_Resident       -
             TaxTotal_Tax_Class      -
             TaxTotal_ER_Generated   -
             TaxTotal_Canada         -
             TaxTotal_Taxcode_sort
 
        !TRANSFER THE BALANCES TOO
        !-------------------------
        let #L2 = 0
        While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
 
         get  #TBalance_Nlgrs_Cur      -
              #TBalance_Txgrs_Cur      -
              #TBalance_Tax_Cur        -
         from TaxTotal(#count)              -
              TaxTotal_Nlgrs_Cur(#L2)    -
              TaxTotal_Txgrs_Cur(#L2)    -
              TaxTotal_Tax_Cur(#L2)
 
         put  #TBalance_Nlgrs_Cur      -
              #TBalance_Txgrs_Cur      -
              #TBalance_Tax_Cur        -
         into TaxTotal(#so)              -
              TaxTotal_Nlgrs_Cur(#L2)    -
              TaxTotal_Txgrs_Cur(#L2)    -
              TaxTotal_Tax_Cur(#L2)
 
         Add 1 to #L2
 
        End-While
 
        let #count = #count - 1
       end-while
       break
      end-if
 
     let #s = #s + 1
 
    end-while
 
    let #L1 = #s
 
    #ifdef debug_pdf
       show 'updating totals... #L1 ' #L1
    #endif
 
    !----------------------------------------------------------
 
    Put $TaxBalance_State           -
         $TaxBalance_Locality        -
         $TaxBalance_Resident        -
         $TaxBalance_Tax_Class       -
         $TaxBalance_ER_Generated    -
         $TaxBalance_Canada          -
         $taxcode_sort               -
         Into TAXTOTAL(#L1)          -
             TaxTotal_State          -
             TaxTotal_Locality       -
             TaxTotal_Resident       -
             TaxTotal_Tax_Class      -
             TaxTotal_ER_Generated   -
             TaxTotal_Canada         -
             TaxTotal_Taxcode_sort
 
        let #L2 = 0
        While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
         put  0      -
              0      -
              0      -
         into TaxTotal(#L1)              -
              TaxTotal_Nlgrs_Cur(#L2)    -
              TaxTotal_Txgrs_Cur(#L2)    -
              TaxTotal_Tax_Cur(#L2)
 
         Add 1 to #L2
        End-While
 
 
     Add 1 to #Last_TaxTotal_Cnt
 
   End-if
 
   #ifdef debug_pdf
       show 'totals added... State ' $TaxBalance_State
       show 'Class ' $TaxBalance_Tax_Class
       show 'tax   ' #TaxBalance_Tax_Cur
       show 'cnt   ' #Last_TaxTotal_Cnt
       show 'L1    ' #L1
       show 'Match ' $MatchFound
  #endif
 
  let #L2 = 0
  While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
 
    Array-Add #TaxBalance_Nlgrs_Cur      -
              #TaxBalance_Txgrs_Cur      -
              #TaxBalance_Tax_Cur        -
           to TaxTotal(#L1)              -
              TaxTotal_Nlgrs_Cur(#L2)    -
              TaxTotal_Txgrs_Cur(#L2)    -
              TaxTotal_Tax_Cur(#L2)
 
    Add 1 to #L2
 
  End-While
 
End-procedure
 

#ifdef INCLUDE_GL_IN_PBZ_HISTORY
begin-procedure Include-GL-in-History  !returns $GL_EXPENSE, $GL_DESCR

 let $GL_EXPENSE = '0'
 let $GL_DESCR   = 'n/a'
 let $found_gl = 'f'
 
 if rtrim($trimmed_state,' ') <> '$U' and rtrim($trimmed_locality,' ') <> '' and $trimmed_tax_class = 'H'
   do LWT-Lookup
 else
   if rtrim($trimmed_state,' ') <> '$U' and rtrim($trimmed_locality,' ') = '' and $trimmed_tax_class = 'H'
     do SWT-Lookup
   else
     do Misc-GL-Lookup
   end-if
 end-if
 
 if $Trimmed_State = '$U' or $Trimmed_State = '$E'  !02B change $EC for EIC too
      let $Juris = 'Federal'
 else
    if rtrim($trimmed_locality,' ') = ''
       let $Juris = $trimmed_state  || ' State'
    else
       let $Juris = $trimmed_state  || ' Local'
    end-if
 end-if
   
 let $FieldName = 'TAX_CLASS'
 let $FieldValue = $trimmed_tax_class
 do Read-Translate-Table
 let $TaxTypeDescr = $XlatShortName
 let $GL_Descr = $Juris || ' ' || $XlatShortName
 
 if rtrim($GL_EXPENSE,' ') = ''
   let $GL_EXPENSE = '0'
 end-if
 
 if rtrim($GL_DESCR,' ') = ''
   let $GL_DESCR   = 'n/a'
 end-if
 
end-PROCEDURE  

begin-procedure SWT-Lookup
 
 
BEGIN-SELECT
HS.EMPLOYER_ID_SWT
 
 let $GL_EXPENSE = rtrim(&HS.EMPLOYER_ID_SWT,' ')
 
 FROM PS_CO_STATETAX_TBL HS
 WHERE HS.COMPANY    = $Payline_Company     AND
       HS.STATE      = $Trimmed_State       AND
       HS.EFF_STATUS = 'A'                  AND
       HS.EFFDT=(SELECT MAX(EFFDT)
            FROM PS_CO_STATETAX_TBL HS1
               WHERE HS.COMPANY = HS1.COMPANY
                 AND HS.STATE   = HS1.STATE)
 
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 

begin-procedure LWT-Lookup
 
 
BEGIN-SELECT
HL.EMPLOYER_ID_LWT
 
 let $GL_EXPENSE = rtrim(&HL.EMPLOYER_ID_LWT,' ')
 
 FROM PS_CO_LOCALTAX_TBL HL
 WHERE HL.COMPANY    = $Payline_Company     AND
       HL.STATE      = $Trimmed_State       AND
       HL.LOCALITY   = $Trimmed_Locality    AND
       HL.EFF_STATUS = 'A'                  AND
       HL.EFFDT=(SELECT MAX(EFFDT)
            FROM PS_CO_LOCALTAX_TBL HL1
               WHERE HL.COMPANY = HL1.COMPANY
                 AND HL.STATE   = HL1.STATE
                 AND HL.LOCALITY = HL1.LOCALITY)
 
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure


begin-procedure Misc-GL-Lookup

 let $GL_retr = 'f'
 if $trimmed_locality = ''
  let $locality_check = ' '
 else
  let $locality_check = $trimmed_locality
 end-if
 
BEGIN-SELECT
MGL.ACCT_CD
 
 let $GL_EXPENSE = rtrim(&MGL.ACCT_CD,' ')
 let $GL_retr = 't'
 
 FROM PS_PAY_NA_TAX_DIST MGL
 WHERE MGL.COMPANY        = $Payline_Company     AND
       MGL.PAYGROUP       = $payline_Paygroup    AND
       MGL.OFF_CYCLE      = $payline_off_cycle   AND
       MGL.PAGE_NUM       = #payline_pagen       AND
       MGL.LINE_NUM       = #payline_linen       AND
       MGL.SEPCHK         = #payline_sepchk      AND
       MGL.STATE          = $Trimmed_State       AND
       MGL.TAX_CLASS      = $Trimmed_tax_class   AND
       MGL.LOCALITY       = $locality_check      AND
       MGL.PAY_END_DT     = $payline_pay_end_dt
       
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
   if $GL_retr <> 't'
      show 'Misc-GL not retrieved for ' $Payline_Company ' ' $payline_Paygroup ' '$payline_off_cycle ' ' #payline_pagen edit 99999 ' ' #payline_linen edit 99999
      show '                          ' #payline_sepchk edit 99999 ' ' $Trimmed_State $Trimmed_tax_class $locality_check ' ' $payline_pay_end_dt
   end-if
 
 
end-procedure

#endif 
 
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Build-Taxcode                                   !
!----------------------------------------------------------------------!
begin-procedure Build-Taxcode
 
  !Inputs: $Trimmed_State, $Trimmed_Tax_Class, $Trimmed_Locality, $Trimmed_Resident
  !output: $Taxcode
 
  let $Taxcode   = ' '
  let $SourceVal = ' '
  let $SourceVal =   $Trimmed_State || $Trimmed_Tax_Class ||  $Trimmed_Locality
 
  if rtrim($Trimmed_Locality,' ') = ''
    Let $SourceVal = rpad($SourceVal,15,' ')
  else
    ! TMG 7/20/04  Force all NYC taxes to be resident, since non-resident (commuter tax) was repealed.
    if $Trimmed_State = 'NY' AND $Trimmed_Locality = 'P0001'
      Let $SourceVal = rpad($SourceVal,14,' ')  || 'Y'
    else
 
      !---------------------------
      !7/14/06 added
      if rtrim($Trimmed_Resident,' ') <> 'Y'
        let $Trimmed_Resident = ' '
      end-if
      !---------------------------
 
      Let $SourceVal = rpad($SourceVal,14,' ')  || rtrim($Trimmed_Resident,' ')
 
    end-if
  end-if
 
 let $Taxcode = $SourceVal
 
 #ifdef OHIO_COURTESY_WITHHOLDING
  if $Trimmed_State = 'OH' and $Trimmed_Tax_Class = 'H' and $Trimmed_Locality <> ''
   show 'build-taxcode complete ' $Trimmed_State $Trimmed_Tax_Class $Trimmed_Locality ' ' $Trimmed_Resident ' results in taxcode --> ' $Taxcode
  end-if
 #endif
 
end-procedure
 
 
 
#ifdef GENERATE_EMPLOYEE_DETAIL
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: get-ssn                                                   !
!----------------------------------------------------------------------!
begin-procedure get-ssn
 
 move ' ' to $ssn
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.29: ' $display_dt
 #endif
 
 
BEGIN-SELECT    !Loops = 1
{SSN_ID}
 
  let $ssn         = rtrim(&{SSN_ID},' ')
 
  #if {PeopleSoft_Version} >= '7.5'
     FROM PS_PERSONAL_DATA A1, PS_PERS_NID H
     WHERE    A1.EMPLID = $Payline_Emplid
        AND   H.EMPLID = $Payline_Emplid
        #ifdef IGNORE_NID_VARS
        AND   H.COUNTRY = 'USA'
        AND   H.NATIONAL_ID_TYPE = 'PR'
        #else
        AND   H.COUNTRY = {NID_COUNTRY}
        AND   H.NATIONAL_ID_TYPE = $PAYROLL_NID_TYPE
        #endif
 
  #endif
 
  #if {PeopleSoft_Version} < '7.5'
     FROM PS_PERSONAL_DATA A1
     WHERE    A1.EMPLID = $Payline_Emplid
  #endif
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 
#endif
 
 
!4/30/03 Peoplesoft 8.8
!-----------------------
 
#if {PeopleSoft_Version} < '8.8'
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Extract-Personal-Data                                          !
! Descr:     Extract the Personal (Employee) data from Personal Data        !
!            table.                                                         !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Extract-Personal-Data
 
  LET $Gender = ' '
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.30: ' $display_dt
 #endif
 
 
BEGIN-SELECT    !Loops = 1
A1.SEX
 
  let $Gender = rtrim(&A1.SEX,' ')
 
  #if {PeopleSoft_Version} >= '7.5'
 
     FROM PS_PERSONAL_DATA A1,
          PS_PERS_NID H
     WHERE    A1.EMPLID = $Payline_Emplid
        AND   H.EMPLID  = $Payline_Emplid
        #ifdef IGNORE_NID_VARS
        AND   H.COUNTRY = 'USA'
        AND   H.NATIONAL_ID_TYPE = 'PR'
        #else
        AND   H.COUNTRY = {NID_COUNTRY}
        AND   H.NATIONAL_ID_TYPE = $PAYROLL_NID_TYPE
        #endif
 
  #endif
 
  #if {PeopleSoft_Version} < '7.5'
 
     FROM PS_PERSONAL_DATA A1
     WHERE    A1.EMPLID = $payline_Emplid
 
  #endif
 
  #ifdef SELECT_WITH_UR
   with ur
  #end-if
end-select
 
end-procedure
 
 
#else      ! *********************** P/S 8.8, major mods ****************
 
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Extract-Personal-Data                                          !
! Descr:     Extract the Personal (Employee) data from Personal Data        !
!            table.                                                         !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Extract-Personal-Data
 
  LET $Gender = ' '
  do get-gender
 
end-procedure
 
begin-procedure Get-Gender
 
  LET $Gender = ' '
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.31: ' $display_dt
 #endif
 
BEGIN-SELECT    !Loops = 1
PERSDT.SEX
 
  let $Gender = rtrim(&PERSDT.SEX,' ')
 
  FROM PS_PERS_DATA_EFFDT PERSDT
    WHERE PERSDT.EMPLID  = $payline_Emplid
      AND PERSDT.EFFDT = (SELECT MAX(EFFDT)
                   FROM PS_PERS_DATA_EFFDT
                   WHERE  EMPLID  = PERSDT.EMPLID
                    AND   EFFDT   <= $PayLine_pay_end_dt)
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-procedure
 
 
 
#endif         !8.8 personal data
 
 
#if {SITE_ID} = 'WFG1'
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: SQL-Error                                                  !
! Descr:     Reports SQL Errors                                        !
!                                                                      !
!               Called by vareous procedures.                          !
!----------------------------------------------------------------------!
 
begin-procedure SQL-Error
 
     evaluate #sql-status
     #ifdef DB2ALL
       when = 6100
       break
     #endif
       when = -9999
        break
       when-other
 
        print 'SQL Error:'   (+1,1)
        print #Sql-Status    (+1,1) edit 9999999
        print $Sql-Error     (0,+2)
        print $Sql-Msg       (0,+2)
 
     end-evaluate
 
end-procedure
#endif
 
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Wrap-Up                                                   !
! Descr:     If errors are found this procedure will Rollback all      !
!            work and the journal table will not be updated. An output !
!            report is generated identfying the file rows containing   !
!            errors along with a total of the transactions read and    !
!            errors found, if any.                                     !
!            Called by Report procedure.                               !
!----------------------------------------------------------------------!
 
begin-procedure Wrap-Up
 
      !show 'Closing periodic extract file  ' $Filename
      !close 1
 
      #ifdef CANADA_TOO
      #if {SITE_ID} <> 'PLP1'
        show 'Closing Canada extract file  '  $Canada_Filename
        DO Close-ADP-Canada
      #endif
      #endif
 
      !Added 2/7/6, see notes
      #ifdef 'SIE1'
        do Commit-Transaction
      #endif
 
      #ifdef KJDA
       #ifdef KJDA_FILENAME
        show 'Closing KJDA extract file  '  $KJDA_Filename
        close 2
       #end-if
      #endif
      
      #ifdef GENERATE_BYPASSED_REPORT
        show 'Closing BYPASSED file  '  $bypassed_Filename
        #if {SITE_ID} = 'KMT1'
         do Format-Number(#kTot_Bypass_Txgrs, $PT_TXGRS_CUR, '999999999999.99')
         do Format-Number(#kTot_Bypass_Nlgrs, $PT_NLGRS_CUR, '999999999999.99')
         do Format-Number(#kTot_Bypass_Tax  , $PT_TAX_CUR, '999999999999.99')
 
         Write 6 FROM 'Grand Total':19
                                ' ':11
                        $PT_TAX_CUR:16
                      $PT_TXGRS_CUR:16
                      $PT_NLGRS_CUR:16
                                ' ':15
        #endif
        #if {SITE_ID} = 'SRC1'
         do Format-Number(#kTot_Bypass_Txgrs, $PT_TXGRS_CUR, '999999999999.99')
         do Format-Number(#kTot_Bypass_Nlgrs, $PT_NLGRS_CUR, '999999999999.99')
         do Format-Number(#kTot_Bypass_Tax  , $PT_TAX_CUR, '999999999999.99')
 
         Write 6 FROM 'Grand Total':19
                                ' ':11
                        $PT_TAX_CUR:16
                      $PT_TXGRS_CUR:16
                      $PT_NLGRS_CUR:16
                                ' ':15
        #endif
        close 6
      #endif
 
      #ifdef PERIODIC_ANNUAL_RECONCILIATION
         do PERIODIC-ANNUAL-RECONCILIATION
         print  'PERIODIC_ANNUAL_RECONCILIATION:  Please review the Annual Recon Data File: ' (+1,10)
         print  $annual_recon_filename     ()
      #endif
      
end-procedure
 
 
 
 
#ifdef STANDARD_FTP
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Create-Standard-ProBiz-FTP-CMD-Text                                !
! Descr:     New procedure, added 05/09/2001.  Creates text file used  !
!            to transfer periodic.dat and txpbzper.lis to the ProBiz   !
!            server.                                                   !
!----------------------------------------------------------------------!
Begin-Procedure Create-Standard-ProBiz-FTP-CMD-Text
   Let $File-Creation-Error = 'N'
 
   let $ftp_command_file = '{FTP_CommandFile}'
 
   ! Open a variable length text file on channel 3.
   Open $ftp_command_file as 3  FOR-WRITING  RECORD=256:VARY  STATUS=#FileStatus
 
   ! Check file status.
   If #FileStatus <> 0
      show ''
      show 'Error opening FTP Command File ' $ftp_command_file
      show 'Can not transfer file to ProBiz server.'
      show ''
 
      Let $File-Creation-Error = 'Y'
 
      Goto Exit-ftp
   End-If
 
   let $FTP_Password = '{FTP_Password}'
 
   #if {SITE_ID} = 'STV1'
     Let $ExclamationPoint = chr(033)
     Let $FTP_Password = $FTP_Password || $ExclamationPoint || 'n'
   #endif
 
   #IfDef UNIX
      Write 3 From '#/bin/ksh'
      Write 3 From 'cd /usr/tmp'
      Write 3 From 'ftp -n {FTP_IP_Address} <<EOF'
      Let $User_And_Password = 'user {FTP_User} ' || $FTP_Password
      Write 3 From $User_And_Password
   #Else
      Write 3 From 'open {FTP_IP_Address}'
      Write 3 From 'user'
      Write 3 From '{FTP_User}'
      Write 3 From $FTP_Password
   #End-If
 
   Show 'FTP_destination_folder: ' '{FTP_destination_folder}'
 
   Write 3 From 'cd {FTP_destination_folder}'
 
   !put the extract file
   !--------------------
   Write 3 From 'ascii'
   Let $PutLine = 'put ' || $Filename || ' {FTP_Test_Prefix}' || $FTP_Extract_Filename
   Write 3 From $PutLine
 
   #ifdef GENERATE_SUBTOTAL_REPORT
     !put the SubTotals file
     !---------------------
     Let $PutLine = 'put ' || $RptFilename || ' {FTP_Test_Prefix}' || 'PRO_' || $FTP_RptFilename
     Write 3 From $PutLine
   #endif
 
   !added 3/24/04
   #ifdef GENERATE_PROBUSINESS_LAYOUT_ALWAYS
     Let $PutLine = 'put ' || $ProFilename || ' {FTP_Test_Prefix}' || $FTP_Extract_Filename
     Write 3 From $PutLine
   #endif
 
   !put the extract report
   !-----------------------
   #ifdef FTP_REPORT
    if rtrim($NewReportExt,' ') = '.pdf'
     Write 3 From 'binary'
    end-if
    Let $PutLine = 'put ' || $NewReportName || ' {FTP_Test_Prefix}' || $FTP_Report_Filename
    Write 3 From $PutLine
   #endif
 
   !get the extract file into '{Fileprefix}pbztmp.dat'
   !---------------------------------------------------
   Let $PutLine = 'get {FTP_Test_Prefix}' || $FTP_Extract_Filename || ' {Fileprefix}pbztmp.dat'
   Write 3 From $PutLine
   Write 3 From 'quit'
 
   #IfDef UNIX
      Write 3 From 'EOF'
   #End-If
 
   Close 3
 
   #IfDef UNIX
      Let $CommandLine = 'chmod 755 ' || $ftp_command_file
      call system using $CommandLine $unix_status
 
      If #unix_status <> 0
         Show 'Can not change mode of FTP Command File ' $ftp_command_file
         Stop
      End-If
   #End-If
 
Exit-ftp:
End-Procedure
 
 
 
begin-procedure verify-ftp-of-extract
 
    !at this point, we've read the extract file that has
    !been written to the ftp server BACK.  Might as well validate it
    !---------------------------------------------------------------
    move '{Fileprefix}pbztmp.dat' to $Verify_Filename
    close 1
 
    do Sum-Periodic-Extract-Data
 
    if #filestat = 0
   
     if round(#Taxes_going_to_ProBusiness,2) <> round(#TOTAL_PBZPER_TAXES,2)
       show 'ERROR: Taxes in Extract      ' #Taxes_going_to_ProBusiness
       show '       Do not match FTP-File ' #TOTAL_PBZPER_TAXES
       let #ftp_error = 1
     else
       show  'FTP Validation OK.  Extract matches FTP-File.'
       let #ftp_error = 0
     end-if
 
   end-if
 
end-procedure
#endif
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Convert-To-Dos
! Descr:     Converts the UNIX file created to a DOS format file       !
!            Called by Report procedure.                               !
!----------------------------------------------------------------------!
 
begin-procedure Convert-To-Dos
 
     let $Run_Command = 'mcvt '|| $Filename
     call system using $Run_Command #status
 
end-procedure
 
#ifdef USE_CHECK_DATE_FROM_PAY_CHECK
 
!************************************************************************
!   begin Get-Check-Date-From-Pay-Check - New procedure added 01.07.2002
!************************************************************************
begin-procedure Get-Check-Date-From-Pay-Check
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.32: ' $display_dt
 #endif
 
 
begin-SELECT DISTINCT
PNU.CHECK_DT
 
    let $payline_check_dt = &PNU.Check_Dt
 
     #if {SITE_ID} = 'SCP1'	 !AS121311 - Added for SCI-SDC Requirement
      if $OnlineChkInd = 'L'
        let $payline_check_dt   = dateadd(&PNU.Check_Dt,'DAY',2)
      end-if
    #endif
    
FROM PS_PAY_CHECK PNU
WHERE PNU.COMPANY    = $Payline_COMPANY
  AND PNU.PAYGROUP   = $Payline_paygroup
  AND PNU.PAY_END_DT = $AsOfDate
  AND PNU.OFF_CYCLE  = $payline_off_cycle
  AND PNU.{pg}       = #payline_pagen
  AND PNU.{ln}       = #payline_linen
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
end-procedure
!************************************************************************
!   end Get-Check-Date-From-Pay-Check - New procedure added 01.07.2002
!************************************************************************
#endif
 
 
!************************************************************************
!   Getting the Balance adjustments.... this will include all balance
!   Adjustments for the quarter that have NOT already been processed.
!   A array will maintain these, and then this array (Bal_Adj) will be
!   dumped out for reconciliation.
!************************************************************************
 
#ifdef GET_BALANCE_ADJUSTMENTS  !added 8/30/04
 
 
begin-procedure insert-into-bal-adj
 
   let #i = 0
   let $found = 'f'
 
 if (#num_Bal_Adj >= {BAL_ADJ_LIMIT})
    show 'ERROR: Insufficient Array space in Bal_Adj array.  Adjust BAL_ADJ_LIMIT.   Stopping program'
    #ifdef MVS
        Move 5 to #Return-Status
    #end-if
    stop
 else
 
   while (#i < #num_Bal_Adj)
 
     get $CompID             -
         $emp                -
         $txcode             -
         $liab               -
     from Bal_Adj(#i)        -
          Company            -
          Emplid             -
          Taxcode            -
          Liab_Date
 
      #ifdef SUBTOTAL_TBAs
       if ($CompID = $ADJ_Company) and ($txcode = $ADJ_Taxcode) and ($liab = $Check_date_real)
         let $found = 't'
         break
       end-if
      #else
       if ($CompID = $ADJ_Company)  and ($emp    = $ADJ_Emplid)  and ($txcode = $ADJ_Taxcode) and ($liab = $Check_date_real)
         let $found = 't'
         break
       end-if
      #endif
      
      add 1 to #i
 
   end-while
 
 
   if $found = 'f'
 
     #ifdef SUBTOTAL_TBAs
      let $epl = ''
     #else
      let $epl = $ADJ_Emplid
     #endif
     
     put   $ADJ_Company              -
           $epl                      -
           $ADJ_taxcode              -
           #ADJ_TAX_ADJ              -
           #ADJ_TXGRS_ADJ            -
           #ADJ_NLGRS_ADJ            -
           $ADJ_DT_ENTERED           -
           $Check_date_real          -
     into Bal_Adj(#num_Bal_Adj)      -
           Company                   -
           Emplid                    -
           Taxcode                   -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           DT_ENTERED                -
           Liab_Date
 
     add 1 to #num_Bal_Adj
 
   else
        Array-Add #ADJ_TAX_ADJ   to Bal_Adj(#i) Taxes
        Array-Add #ADJ_TXGRS_ADJ to Bal_Adj(#i) Txgrs
        Array-Add #ADJ_NLGRS_ADJ to Bal_Adj(#i) Nlgrs
   end-if
 
 end-if
 
 
end-procedure
 
 
begin-procedure Bal-Adj-Sort
 
     do Get-Current-DateTime
     show 'Bal-Adj-Sort: ' $AsOfToday ' ' $AsOfNow ' num_Bal_Adj  = ' #Bal-Adj-Sort
  
     #ifdef MVS
       let $company_zzz = '999'
       let $date_zzz    = '99999999'
       let $taxcode     = '999999999999999'
     #else
       let $company_zzz = 'ZZZ'
       let $date_zzz    = 'ZZZZZZZZ'
       let $taxcode     = 'ZZZZZZZZZZZZZZZ'
     #endif
 
     let #i = 0
     while (#i < #num_Bal_Adj)
 
        let #j = #i
        let $sorttest = $company_zzz || $date_zzz || $taxcode_zzz
        let #nextinx = 0
 
        while (#j < #num_Bal_Adj)
          get $cp from Bal_Adj(#j) Company
          get $dt from Bal_Adj(#j) Liab_Date
          get $tx from Bal_Adj(#j) Taxcode
          let $sortfield = $cp || $dt || $tx        !sort by company, liab_date and taxcode
 
          if ($sortfield < $sorttest)
           let #nextinx = #j
           move $sortfield to $sorttest
          end-if
 
          add 1 to #j
 
        end-while
 
        !save the current i'th entry
        !---------------------------
        get $C          -
            $E          -
            $Taxcd      -
            #Tax        -
            #Txgrs      -
            #Nlgrs      -
            $dt         -
            $liab       -
        from Bal_Adj(#i)  -
           Company   -
           Emplid    -
           Taxcode   -
           Taxes     -
           Txgrs     -
           Nlgrs     -
           DT_Entered -
           Liab_Date
      
         put $C              -
             $E              -
            $Taxcd           -
            #Tax             -
            #Txgrs           -
            #Nlgrs           -
            $dt              -
            $liab            -
         into Bal_Adj(#num_Bal_Adj)  -
             Company   -
             Emplid    -
             Taxcode   -
             Taxes     -
             Txgrs     -
             Nlgrs     -
             DT_Entered -
             Liab_Date
      
        !replace it with the next lowest
        !-------------------------------
 
        get $C          -
            $E          -
            $Taxcd      -
            #Tax        -
            #Txgrs      -
            #Nlgrs      -
            $dt         -
            $liab       -
        from Bal_Adj(#nextinx)  -
           Company   -
           Emplid    -
           Taxcode   -
           Taxes     -
           Txgrs     -
           Nlgrs     -
           DT_Entered -
           Liab_Date
      
         put $C              -
             $E              -
            $Taxcd           -
            #Tax             -
            #Txgrs           -
            #Nlgrs           -
            $dt              -
            $liab            -
         into Bal_Adj(#i)  -
             Company   -
             Emplid    -
             Taxcode   -
             Taxes     -
             Txgrs     -
             Nlgrs     -
             DT_Entered -
             Liab_Date
 
      
        !move the original i'th entry into the array's 'nextinx' location
        !--------------------------------------------------------------------------
        get $C          -
            $E          -
            $Taxcd      -
            #Tax        -
            #Txgrs      -
            #Nlgrs      -
            $dt         -
            $liab       -
        from Bal_Adj(#num_Bal_Adj)  -
           Company   -
           Emplid    -
           Taxcode   -
           Taxes     -
           Txgrs     -
           Nlgrs     -
           DT_Entered -
           Liab_Date
      
         put $C              -
             $E              -
            $Taxcd           -
            #Tax             -
            #Txgrs           -
            #Nlgrs           -
            $dt              -
            $liab            -
         into Bal_Adj(#nextinx)  -
             Company   -
             Emplid    -
             Taxcode   -
             Taxes     -
             Txgrs     -
             Nlgrs     -
             DT_Entered -
             Liab_Date  
             
        add 1 to #i
 
      end-while
 
     do Get-Current-DateTime
     show 'Bal-Adj-Sort Complete: ' $AsOfToday ' ' $AsOfNow 
 
 
end-procedure
 
 
 
begin-procedure Bal-Adj-Breakout
 
 do Bal-Adj-Sort
  
 #ifdef SUBTOTAL_TBAs
    do Bal-Adj-Summary
 #else
 
  let #header_type = 10
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Balance Adjustment Details'
 
  show 'In: Bal-Adj-Breakout, #num_Bal_Adj = ' #num_Bal_Adj
  let #i = 0
  while (#i < #num_Bal_Adj)
   get $C          -
       $E          -
       $Taxcd      -
       #Tax        -
       #Txgrs      -
       #Nlgrs      -
       $dt         -
       $liab       -
   from Bal_Adj(#i)  -
      Company   -
      Emplid    -
      Taxcode   -
      Taxes     -
      Txgrs     -
      Nlgrs     -
      DT_Entered -
      Liab_Date
 
     let $COMPANY = $C
     move $dt to $AsofDate
     do get-company-data
     let #f_FEIN = &CT.FEDERAL_EIN
     if #f_FEIN <> 0
      move #f_FEIN to $f_FEIN 099999999
      move $f_FEIN to $f xx-xxxxxxx
     else
      move ' ' to $f
     end-if
 
 
   print $f                (+1,1)
   print $c                (0,12)
   print $e                (0,21)
   print $Taxcd            (0,40)
   Print #Tax              (0,60) edit  999999999999.99mi
   Print #Txgrs            (0,80) edit  999999999999.99mi
   Print #Nlgrs            (0,100) edit  999999999999.99mi
   Print $dt               (0,120)
   Print $liab             (0,132)
 
   add #Tax   to #Adj_taxes_total
   add #Txgrs to #Adj_txgrs_total
   add #Nlgrs to #Adj_Nlgrs_total
 
   Add 1 to #i
 
  end-while
 
  print 'Total Balance Adjustments --->' (+2,1)
  Print #Adj_taxes_total       (0,60) edit  999999999999.99mi
  Print #Adj_txgrs_total       (0,80) edit  999999999999.99mi
  Print #Adj_nlgrs_total       (0,100) edit  999999999999.99mi
 
  New-Page
 
 #endif
  
 
 
end-procedure
 
 
begin-procedure Bal-Adj-Summary
 
  do Get-Current-DateTime
  show 'Bal-Adj-Summary: ' $AsOfToday ' ' $AsOfNow 
 
 
  let #header_type = 11
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Balance Adjustment Summary'
 
  move 0  to #Adj_taxes_total
  move 0  to #Adj_txgrs_total
  move 0  to #Adj_Nlgrs_total
 
  move 0  to #tba_subTotal_Taxes
  move 0  to #tba_subTotal_Txgrs
  move 0  to #tba_subTotal_Nlgrs
 
  show 'In: Bal-Adj-Summary, #num_Bal_Adj = ' #num_Bal_Adj
  
  let #i = 0
  while (#i < #num_Bal_Adj)
   get $C          -
       $Taxcd      -
       #Tax        -
       #Txgrs      -
       #Nlgrs      -
       $liab       -
   from Bal_Adj(#i)  -
      Company   -
      Taxcode   -
      Taxes     -
      Txgrs     -
      Nlgrs     -
      Liab_Date
 
     let $COMPANY = $C
     move $dt to $AsofDate
     do get-company-data
     let #f_FEIN = &CT.FEDERAL_EIN
     if #f_FEIN <> 0
      move #f_FEIN to $f_FEIN 099999999
      move $f_FEIN to $f xx-xxxxxxx
     else
      move ' ' to $f
     end-if
 
    let $comp_date = $C || ' ' || $liab
    
    if $comp_date <> $prior_comp_date
      if $prior_comp_date <> ''
 
         print 'Liability Date  --> '           (+1,1)
         print $prior_comp_date                 ()
 
         Print #tba_subTotal_Taxes            (0,60) edit  999999999999.99mi
         Print #tba_subTotal_Txgrs            (0,80) edit  999999999999.99mi
         Print #tba_subTotal_Nlgrs           (0,100) edit  999999999999.99mi
         
         Print ' ' (+1,1)
 
         let #tba_subTotal_Taxes = 0
         let #tba_subTotal_Txgrs = 0
         let #tba_subTotal_Nlgrs = 0
 
         let #tba_subTotal_taxcd_Taxes = 0
         let #tba_subTotal_taxcd_Txgrs = 0
         let #tba_subTotal_taxcd_Nlgrs = 0
         let $prior_Taxcd = ''
         
      end-if
      
      let $prior_comp_date = $comp_date
    
    end-if
 
    Add #Tax      to #tba_subTotal_Taxes
    Add #Txgrs    to #tba_subTotal_Txgrs
    Add #Nlgrs    to #tba_subTotal_Nlgrs
 
    if $Taxcd <> $prior_Taxcd
      if $prior_Taxcd <> ''
   
       print $f                                   (+1,1)
       print $c                                   (0,12)
       print $prior_taxcd                         (0,40)
       Print #tba_subTotal_taxcd_Taxes            (0,60)  edit  999999999999.99mi
       Print #tba_subTotal_taxcd_Txgrs            (0,80)  edit  999999999999.99mi
       Print #tba_subTotal_taxcd_Nlgrs            (0,100) edit  999999999999.99mi
       Print $liab                                (0,131)
 
       let #tba_subTotal_taxcd_Taxes = 0
       let #tba_subTotal_taxcd_Txgrs = 0
       let #tba_subTotal_taxcd_Nlgrs = 0
 
      end-if
      
      let $prior_Taxcd = $Taxcd
    
   end-if
 
   add #Tax   to #tba_subTotal_taxcd_Taxes
   add #Txgrs to #tba_subTotal_taxcd_Txgrs
   add #Nlgrs to #tba_subTotal_taxcd_Nlgrs
 
   add #Tax   to #Adj_taxes_total
   add #Txgrs to #Adj_txgrs_total
   add #Nlgrs to #Adj_Nlgrs_total
 
   Add 1 to #i
 
  end-while
 
  !10/4/2010 - we were missing the last row...
  if $prior_Taxcd <> ''
       print $f                                   (+1,1)
       print $c                                   (0,12)
       print $prior_taxcd                         (0,40)
       Print #tba_subTotal_taxcd_Taxes            (0,60)  edit  999999999999.99mi
       Print #tba_subTotal_taxcd_Txgrs            (0,80)  edit  999999999999.99mi
       Print #tba_subTotal_taxcd_Nlgrs            (0,100) edit  999999999999.99mi
       Print $liab                                (0,131)
  end-if
 
  print 'Total Balance Adjustments --->' (+2,1)
  Print #Adj_taxes_total       (0,60)  edit  999999999999.99mi
  Print #Adj_txgrs_total       (0,80)  edit  999999999999.99mi
  Print #Adj_nlgrs_total       (0,100) edit  999999999999.99mi
 
  New-Page
 
 
  do Get-Current-DateTime
  show 'Bal-Adj-Summary Complete: ' $AsOfToday ' ' $AsOfNow 
 
end-procedure
 
 
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Extract-Resident-Code                                     !
! Desc:      This procedure extracts an Employee's Resident code       !
!            I need to check this table out!
!----------------------------------------------------------------------!
begin-procedure Extract-Resident-Code
 
 
  #ifdef show_selects
    display 'Processing PS_LOCAL_TAX_DATA...'
  #endif
 
 let $Resident = ' '
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.33: ' $display_dt
 #endif
 
BEGIN-SELECT         !Loops = 1
LD.RESIDENT
 
  let $Resident = &LD.RESIDENT
 
  FROM PS_LOCAL_TAX_DATA LD
    WHERE LD.EMPLID       = $ADJ_EMPLID
      AND LD.COMPANY      = $Current_Company
      AND LD.STATE        = $Trimmed_State
      AND LD.LOCALITY     = $Trimmed_Locality
      AND LD.EFFDT=(SELECT MAX(EFFDT)
       FROM   PS_LOCAL_TAX_DATA
       WHERE  EMPLID   = LD.EMPLID
         AND  COMPANY  = LD.COMPANY
         AND  STATE    = LD.STATE
         AND  LOCALITY = LD.LOCALITY
         AND  EFFDT   <= $check_date_real)
 
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 
 
begin-procedure Check-if-adj-has-been-processed
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.34: ' $display_dt
 #endif
 
begin-SELECT
TF_ADJ.DT_ENTERED
 
   let $adj-has-been-processed = 't'
 
   #ifdef debug_adj
     show 'Adjustment already processed on ' &TF_ADJ.DT_ENTERED
   #endif
 
 
  FROM {LOG_ADJ_HISTORY_TABLE} TF_ADJ                  !key fields
   WHERE   TF_ADJ.EMPLID       = $ADJ_EMPLID
     AND   TF_ADJ.COMPANY      = $ADJ_COMPANY
     AND   TF_ADJ.BALANCE_ID   = $ADJ_BALANCE_ID
     AND   TF_ADJ.BALANCE_YEAR = #ADJ_BALANCE_YEAR
     AND   TF_ADJ.STATE        = $ADJ_STATE
     AND   TF_ADJ.LOCALITY     = $ADJ_LOCALITY
     AND   TF_ADJ.TAX_CLASS    = $ADJ_TAX_CLASS
     AND   TF_ADJ.BAL_ADJ_SEQ  = #ADJ_BAL_ADJ_SEQ
     AND   TF_ADJ.BALANCE_QTR  = #ADJ_BALANCE_QTR
     AND   TF_ADJ.DT_ENTERED   = $ADJ_DT_ENTERED
     AND   TF_ADJ.TAX_ADJ      = #ADJ_TAX_ADJ
     AND   TF_ADJ.TXGRS_ADJ    = #ADJ_TXGRS_ADJ
     AND   TF_ADJ.NLGRS_ADJ    = #ADJ_NLGRS_ADJ
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
end-procedure
 
 
begin-procedure log-adj
 
   #ifdef LOG_RUNID_INTO_BALANCE_ADJUSTMENTS            !RUN_ID too
     move $Payline_Company to $History_Company
     move $Payline_paygroup to $History_Paygroup
     move $payline_pay_end_dt to $History_pay_end_dt
     do get-Runid-for-history   ! RUNID_For_History
     if isblank($RUNID_For_History)
        move ' ' to $RUNID_For_History
     end-if
   #endif
 
   #ifdef debug_adj
     show 'inserting adjustment into {LOG_ADJ_HISTORY_TABLE}'
     show '             $ADJ_COMPANY       ' $ADJ_COMPANY
     show '             $ADJ_EMPLID        ' $ADJ_EMPLID
     show '             #ADJ_BALANCE_YEAR  ' #ADJ_BALANCE_YEAR
     show '             #ADJ_BALANCE_QTR   ' #ADJ_BALANCE_QTR
     show '             #ADJ_BAL_ADJ_SEQ   ' #ADJ_BAL_ADJ_SEQ
     show '             $ADJ_LOCALITY      ' $ADJ_LOCALITY
     show '             $ADJ_TAX_CLASS     ' $ADJ_TAX_CLASS
     show '             #ADJ_TAX_ADJ       ' #ADJ_TAX_ADJ
     show '             #ADJ_TXGRS_ADJ     ' #ADJ_TXGRS_ADJ
     show '             #ADJ_NLGRS_ADJ     ' #ADJ_NLGRS_ADJ
     show '             $ADJ_DT_ENTERED    ' $ADJ_DT_ENTERED
     show '             $AsofToday         ' $AsofToday
     #ifdef LOG_RUNID_INTO_BALANCE_ADJUSTMENTS
     show '             $RUN_ID            ' $RUNID_For_History
     #endif
     add 1 to #adjustments_inserted
     show '          #adjustments_inserted '  #adjustments_inserted
   #endif
 
begin-sql
 
INSERT INTO {LOG_ADJ_HISTORY_TABLE}   !all key fields except Process_Dt
                (  COMPANY,
                  EMPLID,
                  BALANCE_ID,
                  BALANCE_YEAR,
                  BALANCE_QTR,
                  BAL_ADJ_SEQ,
                  STATE,
                  LOCALITY,
                  TAX_CLASS,
                  TAX_ADJ,
                  TXGRS_ADJ,
                  NLGRS_ADJ,
                  DT_ENTERED,
                  #ifdef LOG_RUNID_INTO_BALANCE_ADJUSTMENTS
                  RUN_ID,
                  #endif
                  PROCESS_DT
                   )
              Values (
                   $ADJ_COMPANY,
                   $ADJ_EMPLID,
                   $ADJ_BALANCE_ID,
                   #ADJ_BALANCE_YEAR,
                   #ADJ_BALANCE_QTR,
                   #ADJ_BAL_ADJ_SEQ,
                   $ADJ_STATE,
                   $ADJ_LOCALITY ,
                   $ADJ_TAX_CLASS,
                   #ADJ_TAX_ADJ,
                   #ADJ_TXGRS_ADJ,
                   #ADJ_NLGRS_ADJ,
                   $ADJ_DT_ENTERED,
                   #ifdef LOG_RUNID_INTO_BALANCE_ADJUSTMENTS  !Cox for now
                   $RUNID_For_History,
                   #endif
! Wells MC09454 - begin
   #if {SITE_ID} = 'WFG1'
                   $Job_Run_date )
   #else
                   $AsofToday )
   #endif
! Wells MC09454 - end
 
end-sql
 
   add 1 to #Tax_baladj_inserts_count
   add #ADJ_TAX_ADJ   to #Tax_baladj_inserts
   add #ADJ_TXGRS_ADJ to #Txgrs_baladj_inserts
 
end-procedure
 
 
!------------------------------------------------------------------------------
 
 
 
#ifdef EMPLID_BALANCE_ADJUSTMENTS
 
!****************************************************************************
! PROCEDURE Get-Current-Adj-Data - Adjustmenst for each employee being paid
!****************************************************************************
begin-PROCEDURE Get-Current-Adj-Data
 
  ! #define debug_adj
 
 
   let $sql-statement =
     'TFBLADJ.SQR, Get-Current-Adj-Data, SELECT, ' ||
     'PS_TAX_BALANCE'
 
      !move $payline_check_dt to $Dt_in
      move $check_date_real to $Dt_in       !changed from above on 7/1 per Tribune
 
      do Get-Quarter
 
  if $trimmed_locality = ''
    move ' ' to $lcl
  else
    move $trimmed_locality to $lcl
  end-if
 
 
 
  #ifdef debug_adj_details
   show 'Get-Current-Adj-Data: Looking for adjustment for emplid ' $Payline_emplid
   show '           COMPANY    ' $Payline_Company
   show '                ID    ' $Calendar_Year_Id
   show '              YEAR    ' #year_out
   show '               QTR    ' #qtr_out
   show '             STATE    ' $trimmed_state
   show '         TAX_CLASS    ' $trimmed_tax_class
   show '          LOCALITY    ' $lcl
   show '              DATE    ' $Check_Date_real
  #endif
 
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.35: ' $display_dt
 #endif
 
begin-SELECT
ADJ.EMPLID
ADJ.COMPANY
ADJ.STATE
ADJ.LOCALITY
ADJ.TAX_CLASS
ADJ.BALANCE_QTR
ADJ.BALANCE_PERIOD
ADJ.NLGRS_ADJ
ADJ.TXGRS_ADJ
ADJ.TAX_ADJ
ADJ.DT_ENTERED
ADJ.BALANCE_ID
ADJ.BALANCE_YEAR
ADJ.BAL_ADJ_SEQ
 
 
  let $ADJ_EMPLID       =  	 rtrim(&ADJ.EMPLID,' ')
  let $ADJ_COMPANY	=	 rtrim(&ADJ.COMPANY,' ')
  let $ADJ_STATE	=	 rtrim(&ADJ.STATE,' ')
  let $ADJ_LOCALITY	=	 &ADJ.LOCALITY
  let $ADJ_TAX_CLASS	=	 rtrim(&ADJ.TAX_CLASS,' ')
  let #ADJ_BALANCE_QTR	=	 &ADJ.BALANCE_QTR
  let #ADJ_BALANCE_PERIOD =      &ADJ.BALANCE_PERIOD
  let #ADJ_NLGRS_ADJ	=	 &ADJ.NLGRS_ADJ
  let #ADJ_TXGRS_ADJ	=	 &ADJ.TXGRS_ADJ
  let #ADJ_TAX_ADJ	=	 &ADJ.TAX_ADJ
  let $ADJ_DT_ENTERED	=	 rtrim(&ADJ.DT_ENTERED,' ')
  let $ADJ_BALANCE_ID	=	 rtrim(&ADJ.BALANCE_ID,' ')
  let #ADJ_BALANCE_YEAR	= 	 &ADJ.BALANCE_YEAR
  let #ADJ_BAL_ADJ_SEQ	=	 &ADJ.BAL_ADJ_SEQ
 
 
 
  #ifdef debug_adj
   show 'Get-Current-Adj-Data: Checking adjustment for emplid ' &ADJ.EMPLID
   show '           COMPANY    ' $ADJ_COMPANY
   show '              YEAR    ' #year_out
   show '               QTR    ' #qtr_out
   show '             STATE    ' $ADJ_STATE
   show '         TAX_CLASS    ' $ADJ_TAX_CLASS
   show '          LOCALITY    ' $ADJ_LOCALITY
   show '           TAX_QTD    ' #ADJ_TAX_ADJ
   show '         TXGRS_QTD    ' #ADJ_TXGRS_ADJ
   show '         NLGRS_QTD    ' #ADJ_NLGRS_ADJ
   show '                DT    ' $ADJ_DT_ENTERED
  #endif
 
   let $adj-has-been-processed = 'f'
   do Check-if-adj-has-been-processed
 
   if rtrim($adj-has-been-processed,' ') = 'f'
 
     add #ADJ_NLGRS_ADJ to #NLGRS_CUR
     add #ADJ_TXGRS_ADJ to #TXGRS_CUR
     add #ADJ_TAX_ADJ   to #TAX_CUR
 
     #ifdef debug_adj
      show 'NEW adjustment for emplid ' $Payline_Emplid
      show '             STATE    ' $ADJ_STATE
      show '         TAX_CLASS    ' $ADJ_TAX_CLASS
      show '          LOCALITY    ' $ADJ_LOCALITY
      show '           TAX_ADJ    ' #ADJ_TAX_ADJ
      show '         TXGRS_ADJ    ' #ADJ_TXGRS_ADJ
      show '         NLGRS_ADJ    ' #ADJ_NLGRS_ADJ
     #endif
 
     move $trimmed_taxcode to $ADJ_Taxcode
 
     do insert-into-bal-adj
     do log-adj
   end-if
 
 
 FROM PS_BAL_ADJ_TAX ADJ
   WHERE   ADJ.EMPLID       = $Payline_Emplid
     AND   ADJ.COMPANY      = $Payline_Company
     AND   ADJ.BALANCE_ID   = $Calendar_Year_Id
     AND   ADJ.BALANCE_YEAR = #year_out
     AND   ADJ.STATE        = $trimmed_state
     AND   ADJ.LOCALITY     = $lcl
     AND   ADJ.TAX_CLASS    = $trimmed_tax_class
     !     AND ADJ.BAL_ADJ_SEQ  <> 0           <--- commented out 10/26/06 per PPL
     AND   ADJ.BALANCE_QTR  = #qtr_out
     AND   ADJ.DT_ENTERED   <= $Check_Date_real
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
 
end-PROCEDURE
 
#endif
 
 
#ifdef COMPANY_BALANCE_ADJUSTMENTS   !Companies JUST in this RUN will be processed
 
!***********************************************************************
! PROCEDURE Get-Current-Adj-Data
!***********************************************************************
begin-PROCEDURE Get-Current-Adj-Company
 
 
   let $sql-statement =
     'TFBLADJ.SQR, Get-Current-Adj-Company, SELECT, ' ||
     'PS_TAX_BALANCE'
 
      move $check_date_real to $Dt_in       !changed from above on 7/1 per Tribune
      do Get-Quarter
 
  if $trimmed_locality = ''
    move ' ' to $lcl
  else
    move $trimmed_locality to $lcl
  end-if
 
 
  #ifdef debug_adj_details
   show 'Get-Current-Adj-Company: Looking for ALL adjustments for company ' $Current_company
   show '                ID    ' $Calendar_Year_Id
   show '              YEAR    ' #year_out
   show '               QTR    ' #qtr_out
   show '              DATE    ' $Check_Date_real
  #endif
 
  let $company_adjustment = 't'
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.36: ' $display_dt
 #endif
 
begin-SELECT
ADJ.EMPLID
ADJ.COMPANY
ADJ.STATE
ADJ.LOCALITY
ADJ.TAX_CLASS
ADJ.BALANCE_QTR
ADJ.BALANCE_PERIOD
ADJ.NLGRS_ADJ
ADJ.TXGRS_ADJ
ADJ.TAX_ADJ
ADJ.DT_ENTERED
ADJ.BALANCE_ID
ADJ.BALANCE_YEAR
ADJ.BAL_ADJ_SEQ
#ifdef PAACT_32_11F_Logic
ADJ.RES_PSD_CD
ADJ.WORK_PSD_CD
#endif
 
  let $ADJ_EMPLID       =  	 rtrim(&ADJ.EMPLID,' ')
  let $ADJ_COMPANY	=	 rtrim(&ADJ.COMPANY,' ')
  let $ADJ_STATE	      =	 rtrim(&ADJ.STATE,' ')
  let $ADJ_LOCALITY	=	 &ADJ.LOCALITY
  let $ADJ_TAX_CLASS	=	 rtrim(&ADJ.TAX_CLASS,' ')
  let #ADJ_BALANCE_QTR	=	 &ADJ.BALANCE_QTR
  let #ADJ_BALANCE_PERIOD =      &ADJ.BALANCE_PERIOD
  let #ADJ_NLGRS_ADJ	=	 &ADJ.NLGRS_ADJ
  let #ADJ_TXGRS_ADJ	=	 &ADJ.TXGRS_ADJ
  let #ADJ_TAX_ADJ	=	 &ADJ.TAX_ADJ
  let $ADJ_DT_ENTERED	=	 rtrim(&ADJ.DT_ENTERED,' ')
  let $ADJ_BALANCE_ID	=	 rtrim(&ADJ.BALANCE_ID,' ')
  let #ADJ_BALANCE_YEAR	= 	 &ADJ.BALANCE_YEAR
  let #ADJ_BAL_ADJ_SEQ	=	 &ADJ.BAL_ADJ_SEQ
 
  #ifdef debug_adj
   show 'Checking adjustment for emplid ' &ADJ.EMPLID
   show '           COMPANY    ' $ADJ_COMPANY
   show '              YEAR    ' #year_out
   show '               QTR    ' #qtr_out
   show '             STATE    ' $ADJ_STATE
   show '         TAX_CLASS    ' $ADJ_TAX_CLASS
   show '          LOCALITY    ' $ADJ_LOCALITY
   show '           TAX_QTD    ' #ADJ_TAX_ADJ
   show '         TXGRS_QTD    ' #ADJ_TXGRS_ADJ
   show '         NLGRS_QTD    ' #ADJ_NLGRS_ADJ
   show '                DT    ' $ADJ_DT_ENTERED
  #endif
 
   let $adj-has-been-processed = 'f'
   do Check-if-adj-has-been-processed
 
   if rtrim($adj-has-been-processed,' ') = 'f'
     let #NLGRS_CUR = #ADJ_NLGRS_ADJ
     let #TXGRS_CUR = #ADJ_TXGRS_ADJ
     let #TAX_CUR   = #ADJ_TAX_ADJ
 
     #ifdef debug_adj
      show 'Get-Current-Adj-Company: NEW adjustment for Emplid ' $Payline_Emplid
      show '             STATE    ' $ADJ_STATE
      show '         TAX_CLASS    ' $ADJ_TAX_CLASS
      show '          LOCALITY    ' $ADJ_LOCALITY
      show '           TAX_ADJ    ' #ADJ_TAX_ADJ
      show '         TXGRS_ADJ    ' #ADJ_TXGRS_ADJ
      show '         NLGRS_ADJ    ' #ADJ_NLGRS_ADJ
     #endif
 
     !setup the Write-to-TaxBalance parameters
     !----------------------------------------------------
     let    $Trimmed_State     = rtrim($ADJ_STATE,' ')
     let    $Trimmed_Locality  = rtrim($ADJ_LOCALITY,' ')
     let    $Trimmed_Tax_Class = rtrim($ADJ_TAX_CLASS,' ')
     let    #NLGRS_CUR         = #ADJ_NLGRS_ADJ
     let    #TXGRS_CUR         = #ADJ_TXGRS_ADJ
     let    #TAX_CUR           = #ADJ_TAX_ADJ
     let    #TOTAL_GROSS       = #ADJ_NLGRS_ADJ
     let    #cnt               = 0
     let    #female_cnt        = 0
     let    #male_cnt          = 0
     let    $Canadian          = 'N'
     let    $ER_Generated      = 'f'
     let    $Trimmed_Resident  = ' '
     let    $Resident  = ' '
 
     if $Trimmed_Locality <> ''
       do Extract-Resident-Code
       let $Trimmed_Resident = rtrim($resident,' ')
       #ifdef debug_adj
          show 'Extract-Resident-Code, Trimmed_Locality  ' $Trimmed_Locality
          show 'Extract-Resident-Code, Resident          ' $Trimmed_Resident
       #endif
     end-if
 
     do Build-Taxcode
     let $Trimmed_TaxCode  = rtrim($Taxcode,' ')
     let $Trimmed_Company  = $Current_Company
 
     move $trimmed_taxcode to $ADJ_Taxcode
 
     #ifdef PA_WORKSITE_EXTRACT
       let $PA_RES_Locality  = ''  
       let $PA_PSD_Locality  = ''  
       let $PA_Work_Locality = ''  
       let $PA_local = $ADJ_LOCALITY
       let $PA_resid = $Trimmed_Resident
   
       if $Trimmed_State = '{PA_STATE}' and $Trimmed_Tax_Class = 'H'
         if $Trimmed_Locality <> ''
           let $ADJUST_ZERO_LOCALS_PA_EIT = 'f'
           let $PA_Taxcode  = $Trimmed_TaxCode
           let $PA_Emplid   = $ADJ_EMPLID
           let $PA_Company  = $Trimmed_Company
           let $PA_State    = $Trimmed_State
           let $PA_Class    = $Trimmed_Tax_Class
           let $PA_end_date = $Check_Date_Real
           let #PA_txgrs    = #Txgrs_Cur
           let #PA_taxes    = #Tax_Cur
           #ifdef PAACT_32_11F_Logic
            let $RES_PSD_CD  = rtrim(&ADJ.RES_PSD_CD,' ')
            let $WORK_PSD_CD = rtrim(&ADJ.WORK_PSD_CD,' ')
           #endif
           let $PA_TBA = 't'
           do determine_pa_worksite !$PA_Emplid, $PA_Company, $PA_State, $PA_end_date  --> $PT_Locality
           let $PA_TBA = 'f'
           #ifdef PA_WORKSITE_AUTO
             if $PA_Work_Locality <> ''
                let $PA_resid = ' '
                let $Trimmed_Resident = ' '   !2/29/2012 added for clearing TBA's resident flag for PA act 32
                let $PT_Locality = $PA_Work_Locality
             end-if
           #else
              let $PT_State = $PA_Worksite_Location_code  !PFZ1
           #endif
           if $ADJUST_ZERO_LOCALS_PA_EIT = 't'  !skip the record if it has only PA EIT wages
             let $Tax_proceed = 'f'
           end-if
         end-if       
       end-if
     #endif
 
     do Check-before-processing-tax
     if $Tax_Proceed = 't'
 
      !to avoid dups in the history table 2/22/06
      !------------------------------------------
      let #payline_pagen = 0
      let #payline_linen = 0
 
       #ifdef debug_adj
          show 'Write-to-taxbalances EE'
       #endif
 
       do Write-to-TaxBalances
 
       !Do we need to generate ER matching tax record too?
       !--------------------------------------------------
       do Check-for-ER-Generated-Tax
       if $Need_to_Generate_ER_Tax = 't'
 
          let $ER_Generated = 't'
          #ifdef debug_adj
             show 'Generated Taxcode (ADJ)         ' $Repeat_Taxcode
          #endif
          #ifdef debug_adj
            show 'Write-to-taxbalances ER'
          #endif
          do Write-to-TaxBalances
 
       end-if  !end-if <-- $Need_to_Generate_ER_Tax = 't'
 
 
       do insert-into-bal-adj
       do log-adj
 
     else
        show 'Bypassed Taxcode (ADJ)         ' $Trimmed_Taxcode
        show '    for Emplid                 ' $ADJ_Emplid
     end-if
 
   end-if
 
 
 FROM PS_BAL_ADJ_TAX ADJ
   WHERE   ADJ.COMPANY      = $Current_company
     AND   ADJ.BALANCE_ID   = $Calendar_Year_Id
     AND   ADJ.BALANCE_YEAR = #year_out
     !     AND   ADJ.BAL_ADJ_SEQ  <> 0           <--- commented out 10/26/06 per PPL
     AND   ADJ.BALANCE_QTR  = #qtr_out
     #if {SITE_ID} = 'WFG1'
      AND   ADJ.DT_ENTERED   <= $Check_Date_real
     #endif
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
  let $company_adjustment = ''
 
 
end-PROCEDURE
 
 
#endif
 
 
#ifdef SWEEP_BALANCE_ADJUSTMENTS   !added 2/20/6 to make for less restrictive inclusion
 
 
!***********************************************************************
! PROCEDURE Sweep-Adjustments
!***********************************************************************
begin-PROCEDURE Sweep-Adjustments
 
   ! #define debug_adj
 
   let $company_adjustment = 't'
 
   move ' '        to $Current_company
   move 0          to #last_TaxBalance_Cnt
   move 0          to #Current_FEIN
   move ' '        to $Current_FEIN
   move ' '        to $Current_ADP_Compid
 
   let $sql-statement = 'TFBLADJ.SQR, Sweep-Adjustments, SELECT, ' || 'PS_BAL_ADJ_TAX'
 
   if $trimmed_locality = ''
    move ' ' to $lcl
   else
    move $trimmed_locality to $lcl
   end-if
 
   move '' to $Current_Company
   let #Last_TaxBalance_Cnt = 0
 
   #ifdef SWEEP_ON_CYCLE_CALENDARS_ONLY
     if $Pay_Off_Cycle_Cal = 'Y' 
       show 'SWEEP_ON_CYCLE_CALENDARS_ONLY, bypassing off-cycle calendar'
       goto done_determining_sweep_quarter
     end-if
   #endif
   
   #ifdef SWEEP_CURRENT_QUARTER
      show 'For TBA Sweep...using current date to determine current quarter, AsofToday = ' $AsofToday
      move $AsofToday to $Dt_in
      do Get-Quarter
      let #sweep_year =  #year_out
      let #sweep_qtr  =  #qtr_out
      goto done_determining_sweep_quarter
   #endif
 
   #ifdef SWEEP_RUNDATE_QUARTER
      show 'For TBA Sweep...using RUN date to determine current quarter, Job_Run_Date = ' $Job_Run_Date
      if $Job_Run_Date <> ''
       move $Job_Run_Date to $Dt_in
      else
       move $AsofToday to $Dt_in
      end-if
      do Get-Quarter
      let #sweep_year =  #year_out
      let #sweep_qtr  =  #qtr_out
      goto done_determining_sweep_quarter
   #endif
 
   #ifdef SWEEP_CHECKDATE_QUARTER
      show 'For TBA Sweep...using check date to determine current quarter, check date = ' $check_date_real
      if rtrim($check_date_real,' ') <> ''
        move $check_date_real to $Dt_in
      else
        move $AsofToday to $Dt_in
      end-if
      do Get-Quarter
      let #sweep_year =  #year_out
      let #sweep_qtr  =  #qtr_out
      goto done_determining_sweep_quarter
   #endif
 
   #ifdef SWEEP_CHECK_DT_FROM_RC_QTR
      show 'For TBA Sweep...using check date from run control page to determine current quarter, check date from RC = ' $Check_Dt_RC
      if rtrim($Check_Dt_RC,' ') <> ''
        move $Check_Dt_RC to $Dt_in
      else
        move $AsofToday to $Dt_in
      end-if
      do Get-Quarter
      let #sweep_year =  #year_out
      let #sweep_qtr  =  #qtr_out
      goto done_determining_sweep_quarter
   #endif
 
   show 'For TBA Sweep...using Tax Reporting Quarter to determine current quarter ' #TX.BALANCE_QTR
   let #sweep_qtr  = #TX.BALANCE_QTR
 
   #ifdef SWEEP_CURRENT_YEAR
     show 'For TBA Sweep...using current date to determine current YEAR, AsofToday = ' $AsofToday
     move $AsofToday to $Dt_in
     do Get-Quarter
     let #sweep_year =  #year_out
   #else
     show 'For TBA Sweep...using Tax Reporting Year to determine current YEAR '  #TX.BALANCE_YEAR
     let #sweep_year = #TX.BALANCE_YEAR
   #endif
 
 
done_determining_sweep_quarter:
 
   move #sweep_year to $Sweep_Year  xxxx
   move #sweep_qtr  to $Sweep_Qtr  x
 
   Evaluate $Sweep_Qtr
         When =  '1'
          let $Sweep_Qtr_Start_DTU   = $Sweep_Year || '-01-01'
          let $Sweep_Qtr_End_DTU     = $Sweep_Year || '-03-31'
          break
         When =  '2'
          let $Sweep_Qtr_Start_DTU   = $Sweep_Year || '-04-01'
          let $Sweep_Qtr_End_DTU     = $Sweep_Year || '-06-30'
          break
         When =  '3'
          let $Sweep_Qtr_Start_DTU   = $Sweep_Year || '-07-01'
          let $Sweep_Qtr_End_DTU     = $Sweep_Year || '-09-30'
          break
         When =  '4'
          let $Sweep_Qtr_Start_DTU   = $Sweep_Year || '-10-01'
          let $Sweep_Qtr_End_DTU     = $Sweep_Year || '-12-31'
          break
         when-other
          break
   end-evaluate
   
   Do Convert-from-DTU-Date($Sweep_Qtr_End_DTU, $Sweep_Qtr_End)
 
   show 'Sweeping for ALL adjustments for: YEAR ' #sweep_year ' Qtr ' #sweep_qtr ' ' $Sweep_Qtr_Start_DTU '..' $Sweep_Qtr_End_DTU
 
   #ifdef USE_DT_ENTERED_FOR_TBAs
     show 'USE_DT_ENTERED_FOR_TBAs enabled'
   #endif
   
   ! Jan 21, 2009     Added logic for TBA's.. to not pull before a specific quarter (TBA_LIVE_YEAR, TBA_LIVE_QTR)
   !----------------------------------------------------------------------------------------------------------------------
   
   #ifdef TBA_LIVE_YEAR
    #ifdef TBA_LIVE_QTR
      
      show ' TBA_LIVE_YEAR  =  {TBA_LIVE_YEAR}'
      show ' TBA_LIVE_QTR   =  {TBA_LIVE_QTR}'
 
      if #sweep_year > {TBA_LIVE_YEAR} or (#sweep_year = {TBA_LIVE_YEAR} and #sweep_qtr >= {TBA_LIVE_QTR})
 
        move {TBA_LIVE_YEAR} to $Live_Year  xxxx
        move {TBA_LIVE_QTR}  to $Live_Qtr   x
 
        Evaluate $Live_Qtr
         When =  '1'
          let $Live_Qtr_Start_DTU   = $Live_Year || '-01-01'
          break
         When =  '2'
          let $Live_Qtr_Start_DTU   = $Live_Year || '-04-01'
          break
         When =  '3'
          let $Live_Qtr_Start_DTU   = $Live_Year || '-07-01'
          break
         When =  '4'
          let $Live_Qtr_Start_DTU   = $Live_Year || '-10-01'
          break
         when-other
          break
        end-evaluate
        Do Convert-from-DTU-Date($Live_Qtr_Start_DTU, $Live_Qtr_Start)
        show 'Allowing TBA sweep, starting : ' $Live_Qtr_Start
      else
       show 'No TBA Sweep for quarter prior to live quarter'
       goto No_Sweep_prior_to_live
      end-if      
    #endif
   #endif
 
 
   #ifdef USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs
        Do Convert-to-DTU-Date($AsofToday, $cur_dt_DTU)
        do dtu-add-days($cur_dt_DTU, {DAYS_INTO_FUTURE}, $Check_Date_Forced_DTU)
        do Convert-From-DTU-Date($Check_Date_Forced_DTU, $USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs_dt)
        show 'For TBA Sweep..USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs, TBA liab dts = ' $USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs_dt
   #endif
   
   
   #if {SITE_ID} = 'WFG1'
     do Select-off-Pay-end-dt               !in sqc wftfctrl
   #endif
! Wells MC08941 - end
 
 #ifdef  debug_sql_stats_oracle
    do Get-Current-Time
    show  ' '
    show  'before SQL PBZPER.37: ' $display_dt
 #endif
 
 let #first_date_generated = 0
 
begin-SELECT
SADJ.EMPLID
SADJ.COMPANY
SADJ.STATE
SADJ.TAX_CLASS
SADJ.LOCALITY
SADJ.BALANCE_QTR
SADJ.BALANCE_PERIOD
SADJ.NLGRS_ADJ
SADJ.TXGRS_ADJ
SADJ.TAX_ADJ
SADJ.DT_ENTERED
SADJ.BALANCE_ID
SADJ.BALANCE_YEAR
SADJ.BAL_ADJ_SEQ
#ifdef SUBTOTAL_FEIN
COADJ.FEDERAL_EIN
#endif
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT
CTADJ.TF_COMPANY
#endif
#ifdef PAACT_32_11F_Logic
SADJ.RES_PSD_CD
SADJ.WORK_PSD_CD
#endif

  show 'TBA for ' &SADJ.COMPANY ' ' &SADJ.EMPLID ' ' &SADJ.STATE &SADJ.TAX_CLASS &SADJ.LOCALITY ', Tax Adjustment = ' &SADJ.TAX_ADJ edit 999,999,999.99

  let $TBA_COMPANY = rtrim(&SADJ.COMPANY,' ')
  let $ok_to_process = 'Y'
 
  !added 11/7/2013 for GNU1's TBA's in Q4, 2013 for AST to NOT be pulled in
  !-------------------------------------------------------------------------
  #ifdef TBA_SWEEP_BYPASS_CRITERIA
      if {TBA_SWEEP_BYPASS_CRITERIA} 
        let $ok_to_process = 'N'
        show 'TBA Bypass, for ' $TBA_Company ' ' &SADJ.EMPLID ' ' &SADJ.STATE &SADJ.TAX_CLASS &SADJ.LOCALITY ', Tax Adjustment skipped = ' &SADJ.TAX_ADJ edit 999,999,999.99
      end-if
  #endif
 
  #ifdef USE_CALENDAR_CHECK_DATE_FOR_TBAs
    #ifdef PROCESS_TBAs_for_COMPANIES_IN_CALENDAR_ONLY
      let $ADJ_COMPANY  =  rtrim(&SADJ.COMPANY,' ')
      do get-calendar-check-date
      if $calendar_company <> 't'
        let $ok_to_process = 'N'
      end-if
    #endif
  #endif
  
  
  !added 11/7/2013 for GNU1's TBA's in Q4, 2013 for AST to NOT be pulled in
  !-------------------------------------------------------------------------
  #if {SITE_ID} = 'GNU1'
      if #sweep_year = 2013 and #sweep_qtr = 4 and rtrim(&SADJ.COMPANY,' ') = 'AST'
        let $ok_to_process = 'N'
        show 'GNU1 skipping TBA for ' &SADJ.EMPLID ' ' &SADJ.STATE &SADJ.TAX_CLASS &SADJ.LOCALITY ', Tax Adjustment skipped = ' &SADJ.TAX_ADJ edit 999,999,999.99
      end-if
  #endif
  
!----------------------------------------------------
!Wells MC08941 - begin
  #if {SITE_ID} = 'WFG1'
     !TLK assume it is on_cycle tran
     let $on_cyc_tran = 'Y'
     if $Month_End = 'N'
       if $Off_Cycle = 'N'
          ! if not month end and an on-cycle run check for pay cal for
          ! company - if pay cal, company is mixed AM company. if no
          ! pay cal, company is pure asset mgmt company.
          ! $ok_to_process is set to 'Y' for mixed, 'N' for pure.
          if rtrim(&SADJ.COMPANY,' ') <> $Current_Company
             let $SADJ_COMPANY = &SADJ.COMPANY
             do Verify-Pay-Calendar-exists   !in wftfctrl sqc
          end-if
          ! if not month end and an on-cycle run if off-cycle
          ! transaction (current or next off-cyc date) sweep only if
          ! non-pure asset mgmt company.
          if $Cur_off_Pay_End_Dt = &SADJ.DT_ENTERED ! an off-cycle transaction
          or $Nxt_off_Pay_End_Dt = &SADJ.DT_ENTERED ! an off-cycle transaction
             let $on_cyc_tran = 'N'
          else
             ! if not month end and an on-cycle run and on-cycle tran
             ! sweep all on-cycle transactions
             let $on_cyc_tran = 'Y'
          end-if
       end-if
     end-if
  #end-if
 
  if $ok_to_process = 'Y'      ! Wells MC08941 - end
 
  if rtrim(&SADJ.COMPANY,' ') <> $Current_Company
   if $Current_Company <> ''
    let $Client_CompID = $Current_Company
    if #Last_TaxBalance_Cnt > 0
     do Process-Tax-Record
     let #Last_TaxBalance_Cnt = 0
    end-if
   end-if
 
   let $Current_Company = rtrim(&SADJ.COMPANY,' ')
 
   let $COMPANY = $Current_Company
   move &SADJ.DT_ENTERED to $AsofDate
   do get-company-data
   let #Current_FEIN = &CT.FEDERAL_EIN
   move #Current_FEIN to $Current_FEIN xx-xxxxxxx
 
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
    let $Current_ADP_Compid = rtrim(&CTADJ.TF_COMPANY,' ')
   #endif
 
  end-if

  let $ADJ_EMPLID   =  rtrim(&SADJ.EMPLID,' ')
  let $ADJ_COMPANY  =  rtrim(&SADJ.COMPANY,' ')
  let $ADJ_STATE    =  rtrim(&SADJ.STATE,' ')
  let $ADJ_LOCALITY =  &SADJ.LOCALITY
  IF rtrim($ADJ_LOCALITY,' ') = ''
    let $ADJ_LOCALITY = ' '
  END-IF
  let $ADJ_TAX_CLASS =  rtrim(&SADJ.TAX_CLASS,' ')
  let #ADJ_BALANCE_QTR =  &SADJ.BALANCE_QTR
  let #ADJ_BALANCE_PERIOD =      &SADJ.BALANCE_PERIOD
  let #ADJ_NLGRS_ADJ =  &SADJ.NLGRS_ADJ
  let #ADJ_TXGRS_ADJ =  &SADJ.TXGRS_ADJ
  let #ADJ_TAX_ADJ =  &SADJ.TAX_ADJ
  let $ADJ_DT_ENTERED =  rtrim(&SADJ.DT_ENTERED,' ')
  let $ADJ_BALANCE_ID =  rtrim(&SADJ.BALANCE_ID,' ')
  let #ADJ_BALANCE_YEAR =   &SADJ.BALANCE_YEAR
  let #ADJ_BAL_ADJ_SEQ =  &SADJ.BAL_ADJ_SEQ
 
  Do Convert-to-DTU-Date($ADJ_DT_ENTERED,$ADJ_DT_ENTERED_DTU)

  #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
      move $Adj_Emplid to $Payline_Emplid
      move $Adj_Company to $Payline_Company
      move $ADJ_DT_ENTERED to $Input_INPUT_PAY_END_DT
      do Get-periodic-Job-Data                          !returns $job_business_unit needs:  $payline_emplid, $payline_company, $Input_INPUT_PAY_END_DT
      let $Current_ADP_Compid = $job_business_unit
  #endif
  
  #ifndef USE_CALENDAR_CHECK_DATE_FOR_TBAs
   if $ADJ_DT_ENTERED_DTU <= $Qtr_End_DTU   !4/10/7 changed from '<'
    let $Check_Date_real = $ADJ_DT_ENTERED
   else
    !added 4/22/06  (if we had an original check date from a pay calendar, use it for the check date, else use Qtr end dt
    !--------------------------------------------------------------------------------------------------------------------
    if rtrim($Current_calendar_check_date,' ') = ''
      let $Check_Date_real = $Qtr_End_Native
    else
      let $Check_Date_real = $Current_calendar_check_date
    end-if
   end-if
  #else
    if rtrim($Current_calendar_check_date,' ') = ''
      let $Check_Date_real = $AsofToday
    else
      let $Check_Date_real = $Current_calendar_check_date
      do get-calendar-check-date
    end-if
  #endif
 
  !no matter what.... set the TBA liabilties to today
  !--------------------------------------------------
  #ifdef TBA_FORCE_CHECK_DATES_TO_TODAY
      move $AsofToday to $Check_Date_Real
  #endif
  
  
  !2/7/7 added for Circuit City
  !----------------------------
  #ifdef SET_CREDIT_DATE_TO_TODAY
    if #ADJ_TAX_ADJ < 0 and $ADJ_TAX_CLASS <> 'C'
      show ''
      show ' Changing TBA CREDIT Liability Date, for emplid: ' $ADJ_EMPLID ' from ' $Check_Date_Real ' to ' $AsofToday
      show '  Company  ' $ADJ_COMPANY
      show '  State    ' $ADJ_STATE
      show '  Taxclass ' $ADJ_TAX_CLASS
      show '  Locality ' $ADJ_LOCALITY 
      show '  Tax_cur  ' #ADJ_TAX_CUR
 
      move $AsofToday to $Check_Date_Real
 
     show ''
    end-if
  #endif



  !added 1/21/09 to make sure no liability date is outside of the range from the first..last day of the quarter we're sweeping
  !-----------------------------------------------------------------------------------------------------------------------------
  #ifdef USE_DT_ENTERED_FOR_TBAs
    move $ADJ_DT_ENTERED to $Check_Date_Real
    show ''
    show ' USE_DT_ENTERED_FOR_TBAs, for emplid: ' $ADJ_EMPLID ', ADJ_DT_ENTERED is the Liability date: ' $Check_Date_Real
  #else
   Do Convert-to-DTU-Date($Check_Date_Real, $TBA_Check_Date_Real_DTU)
   if $TBA_Check_Date_Real_DTU < $Sweep_Qtr_Start_DTU  or  $TBA_Check_Date_Real_DTU > $Sweep_Qtr_End_DTU
        show ''
        show ' Changing TBA CREDIT Liability Date, for emplid: ' $ADJ_EMPLID ' from ' $Check_Date_Real ' to last day of sweep quarter ' $Sweep_Qtr_End
        show '    due to the check date of ' $TBA_Check_Date_Real_DTU  ' being outside the sweep quarter.'
        move $Sweep_Qtr_End to $Check_Date_Real
   end-if
  #endif
  !-----------------------------------------------------------------------------------------------------------------------------

  #ifdef FORCE_TBAS_TO_FUTURE  !Uses: TBAS_INTO_FUTURE
     Do Convert-to-DTU-Date($AsofToday,       $cur_dt_DTU)
     do dtu-add-days($cur_dt_DTU, {TBAS_INTO_FUTURE}, $Check_Date_Forced_DTU)
     do Convert-From-DTU-Date($Check_Date_Forced_DTU, $Check_Date_Real)
     show 'FORCE_TBAS_TO_FUTURE: TBA Liability date set to ' $Check_Date_Real
  #endif

   
  #if {SITE_ID} = 'RDS1'
    let $Payline_off_cycle = 'N'
    do radio-shack-liab-date
  #endif
  
  #ifdef USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs
    let $Check_Date_real = $USE_SYSDATE_PLUS_DAYS_INTO_FUTURE_FOR_TBAs_dt
    show 'TBA Liability date = ' $Check_Date_real ' for emplid: ' $ADJ_EMPLID 
  #endif


  #ifdef debug_adj
   show 'Sweep-Adjustments: Checking adjustment for emplid ' $ADJ_EMPLID
   show '           COMPANY    ' $ADJ_COMPANY
   show '              YEAR    ' #sweep_year
   show '               QTR    ' #sweep_qtr
   show '             STATE    ' $ADJ_STATE
   show '         TAX_CLASS    ' $ADJ_TAX_CLASS
   show '          LOCALITY    ' $ADJ_LOCALITY
   show '           TAX_QTD    ' #ADJ_TAX_ADJ
   show '         TXGRS_QTD    ' #ADJ_TXGRS_ADJ
   show '         NLGRS_QTD    ' #ADJ_NLGRS_ADJ
   show '                DT    ' $ADJ_DT_ENTERED
   #ifdef SUBTOTAL_FEIN
   show '              FEIN    ' &COADJ.FEDERAL_EIN
   #endif
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
   show '              FEIN    ' &CTADJ.TF_COMPANY
   #endif
   #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
   show '        BusinessUnit  ' $job_business_unit
   #endif
  #endif


  let $adj-has-been-processed = 'f'
  do Check-if-adj-has-been-processed
 
  if rtrim($adj-has-been-processed,' ') = 'f'
     let #NLGRS_CUR = #ADJ_NLGRS_ADJ
     let #TXGRS_CUR = #ADJ_TXGRS_ADJ
     let #TAX_CUR   = #ADJ_TAX_ADJ
 
     #ifdef debug_adj
      show 'Sweep-Adjustments: SWEEPING adjustment for Emplid ' $ADJ_Emplid
      show '             STATE    ' $ADJ_STATE
      show '         TAX_CLASS    ' $ADJ_TAX_CLASS
      show '          LOCALITY    ' $ADJ_LOCALITY
      show '           TAX_ADJ    ' #ADJ_TAX_ADJ
      show '         TXGRS_ADJ    ' #ADJ_TXGRS_ADJ
      show '         NLGRS_ADJ    ' #ADJ_NLGRS_ADJ
     #endif
 
     !setup the Write-to-TaxBalance parameters
     !----------------------------------------------------
     let    $Trimmed_State     = rtrim($ADJ_STATE,' ')
     let    $Trimmed_Locality  = rtrim($ADJ_LOCALITY,' ')
     let    $Trimmed_Tax_Class = rtrim($ADJ_TAX_CLASS,' ')
     let    #NLGRS_CUR         = #ADJ_NLGRS_ADJ
     let    #TXGRS_CUR         = #ADJ_TXGRS_ADJ
     let    #TAX_CUR           = #ADJ_TAX_ADJ
     let    #TOTAL_GROSS       = #ADJ_NLGRS_ADJ
     let    #cnt               = 0
     let    #female_cnt        = 0
     let    #male_cnt          = 0
     let    $Canadian          = 'N'
     let    $ER_Generated      = 'f'
     let    $Trimmed_Resident  = ' '
     let    $Resident  = ' '
 
     if $Trimmed_Locality <> ''
       do Extract-Resident-Code
       let $Trimmed_Resident = rtrim($resident,' ')
 
       #ifdef debug_adj
          show 'Extract-Resident-Code, current_company   ' $current_company
          show 'Extract-Resident-Code, check_date_real   ' $check_date_real
          show 'Extract-Resident-Code, Trimmed_Locality  ' $Trimmed_Locality
          show 'Extract-Resident-Code, Resident          ' $Trimmed_Resident
       #endif
     end-if
 
     do Build-Taxcode
     let $Trimmed_TaxCode  = rtrim($Taxcode,' ')
     let $Trimmed_Company  = $Current_Company
     move $trimmed_taxcode to $ADJ_Taxcode
 
     do Check-before-processing-tax
 
     !1/20/2011 added to bypass any future New Hire Act TBA's
     !-------------------------------------------------------
     let $Tax_Proceed_JTC = 't'
     #ifdef BYPASS_NEW_HIRE_TAXCODES  !This gets set automatically in adpq210.sqc if we do not pass New Hire Act data into Periodics
       #if {SITE_ID} <> 'CSX1'
        if  ($Trimmed_State = '$U' or $Trimmed_State = '$E') and 
            ($Trimmed_Tax_Class = '{FICA_EXEMPT_ER_HIRE_ACT_CLASS}' 
          or $Trimmed_Tax_Class = '{FICA_TIPS_EXEMPT_ER_HIRE_ACT_CLASS}')
     
         Add #Tax_Cur to #Ignore_Tax
         Add #Tax_Cur to #Fein_Ignore_Tax
         Add #Tax_Cur to #Hash_Ignore_Tax
         do insert-taxes-into-bypassed-totals  !This creates the ER piece of what we're bypassing
         let $Tax_Proceed_JTC = 'f'
        end-if
       #endif
     #endif
 
     #ifdef PA_WORKSITE_EXTRACT
       let $PA_RES_Locality  = ''  
       let $PA_PSD_Locality  = ''  
       let $PA_Work_Locality = ''  
       let $PA_local = rtrim(&SADJ.LOCALITY,' ')
       let $PA_resid = $Trimmed_Resident
   
       if $Trimmed_State = '{PA_STATE}' and $Trimmed_Tax_Class = 'H'
         if $Trimmed_Locality <> ''
           let $ADJUST_ZERO_LOCALS_PA_EIT = 'f'
           let $PA_Taxcode  = $Trimmed_TaxCode
           let $PA_Emplid   = $ADJ_EMPLID
           let $PA_Company  = $Trimmed_Company
           let $PA_State    = $Trimmed_State
           let $PA_Class    = $Trimmed_Tax_Class
           let $PA_end_date = $Check_Date_Real
           let #PA_txgrs    = #Txgrs_Cur
           let #PA_taxes    = #Tax_Cur
           #ifdef PAACT_32_11F_Logic
            let $RES_PSD_CD  = rtrim(&SADJ.RES_PSD_CD,' ')
            let $WORK_PSD_CD = rtrim(&SADJ.WORK_PSD_CD,' ')
           #endif
           let $PA_TBA = 't'
           do determine_pa_worksite !$PA_Emplid, $PA_Company, $PA_State, $PA_end_date  --> $PT_Locality
           let $PA_TBA = 'f'
           #ifdef PA_WORKSITE_AUTO
             if $PA_Work_Locality <> ''
                let $PA_resid = ' '
                let $Trimmed_Resident = ' '   !2/29/2012 added for clearing TBA's resident flag for PA act 32
                let $PT_Locality = $PA_Work_Locality
             end-if
           #else
              let $PT_State = $PA_Worksite_Location_code  !PFZ1
           #endif
           if $ADJUST_ZERO_LOCALS_PA_EIT = 't'  !skip the record if it has only PA EIT wages
             let $Tax_proceed = 'f'
           end-if
         end-if       
       end-if
     #endif
 
     !added 10/3/01 due to TaxUpdate E's memo taxes added for the territories
     !------------------------------------------------------------------------
     #ifndef PROCESS_TERRITORY_STATE_RECORDS
      if length($Trimmed_State ) <> 2
        add #Tax_Cur to #Tax_Total_bypassed_territory
        let $Tax_proceed = 'f'
        show 'Bypassing TBA for State ' $Trimmed_State  ', class ' $Trimmed_Tax_Class ', Adjustment amount bypassed = ' #Tax_Cur edit 999,999,999.99
      end-if
     #endif
     
     if $Tax_Proceed = 't' and $Tax_Proceed_JTC = 't'
 
      !to avoid dups in the history table 2/22/06
      !------------------------------------------
      let #payline_pagen = 0
      let #payline_linen = 0
 
       #ifdef debug_adj
          show 'Write-to-taxbalances EE'
       #endif
 
       !8/12/08 to get counts into extract
       !-----------------------------------
       let #cnt = 1
       let #Male_cnt = 0
       let #Female_cnt = 0
       let $payline_Emplid = $ADJ_emplid
       do Extract-Personal-Data
       if $Gender = 'M'
         let #Male_cnt = 1
       else
         let #Female_cnt = 1
       end-if
 
       do Write-to-TaxBalances
 
       !Do we need to generate ER matching tax record too?
       !--------------------------------------------------
       do Check-for-ER-Generated-Tax
       if $Need_to_Generate_ER_Tax = 't'
 
          let $ER_Generated = 't'
          #ifdef debug_adj
             show 'Generated Taxcode (ADJ)         ' $Repeat_Taxcode
          #endif
          #ifdef debug_adj
            show 'Write-to-taxbalances ER'
          #endif
          do Write-to-TaxBalances
 
       end-if  !end-if <-- $Need_to_Generate_ER_Tax = 't'
 
       do insert-into-bal-adj
       do log-adj
 
     else
       #ifdef debug_adj
        show 'Bypassed Taxcode (ADJ)         ' $Trimmed_Taxcode
        show '    for Emplid                 ' $ADJ_Emplid
       #endif
     end-if
 
   else
    #ifdef debug_adj
     show 'Already processed (ADJ)'
    #endif
   end-if
 
  end-if       ! $ok_to_process = 'Y'
 
 FROM PS_BAL_ADJ_TAX SADJ
      #ifdef SUBTOTAL_FEIN
       , PS_COMPANY_TBL COADJ
      #endif
 
      #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
       , PS_TF_COMPANY_XREF CTADJ
      #endif
 
   #ifdef MULTIPLE_SITES
      ,{INSTALLATION_TABLE} STFIC
      ,{ALT_SITES_TABLE}    STFAC
   #endif
 
   WHERE   SADJ.BALANCE_ID   = $Calendar_Year_Id
     AND   SADJ.BALANCE_YEAR = #Sweep_year
     AND   SADJ.BALANCE_QTR  = #Sweep_qtr
     !     AND   SADJ.BAL_ADJ_SEQ  <> 0           <--- commented out 10/26/06 per PPL
 
 
     #if {SITE_ID} = 'WFG1'
      #ifdef MVS
        \$Wells_COMPANIES_TO_EXCLUDE_BA\
      #else
        [$Wells_COMPANIES_TO_EXCLUDE_BA]
      #endif
     #endif
 
    #ifdef MULTIPLE_SITES
     AND ((STFIC.{WGPS_SITE_FIELD} = $TFI_Site
         AND SADJ.COMPANY NOT IN (SELECT STFICC.COMPANY FROM {ALT_SITES_CO_TABLE} STFICC))
     OR (STFAC.{WGPS_SITE_FIELD} = $Alt_Site
         AND SADJ.COMPANY IN (SELECT STFACC.COMPANY FROM {ALT_SITES_CO_TABLE} STFACC
                           WHERE STFACC.{WGPS_SITE_FIELD} = $Alt_Site)))
    #endif       
 
 
    #ifdef ADJ_REASON_TBAs_TO_EXCLUDE
       AND SADJ.ADJ_REASON <> '{ADJ_REASON_TBAs_TO_EXCLUDE}'
    #endif
 
    #ifdef COMPANIES_TO_EXCLUDE
       AND NOT SADJ.{COMPANIES_TO_EXCLUDE}
    #endif
 
    #ifdef COMPANY_TO_PROCESS
       AND SADJ.COMPANY = '{COMPANY_TO_PROCESS}'
    #endif
 
    #ifdef COMPANIES_TO_PROCESS
       AND SADJ.COMPANY in {COMPANIES_TO_PROCESS}
    #endif
 
    #ifdef TEST_EMPLID
       AND SADJ.EMPLID = '{TEST_EMPLID}'
    #endif
 
   #ifdef ADP_TAX_PERIODIC_SWEEP_ONE_COMPANY
       AND SADJ.COMPANY = $Company_RC
   #endif
   
   #ifdef SWEEP_BALANCE_ADJUSTMENTS_TAXES_ONLY
       AND SADJ.TAX_ADJ <> 0
    #endif
    
    #ifdef SUBTOTAL_FEIN
     AND COADJ.COMPANY = SADJ.COMPANY
     AND COADJ.EFFDT = (SELECT MAX(EFFDT)
       FROM   PS_COMPANY_TBL COADJ1
       WHERE  COADJ1.COMPANY = COADJ.COMPANY
         AND  COADJ1.EFFDT  <= $AsOfDate)
    #endif
 
    #if {SITE_ID} <> 'CZB1'
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      AND CTADJ.COMPANY = SADJ.COMPANY
      AND CTADJ.EFFDT = (SELECT MAX(CTADJ2.EFFDT)
           FROM PS_TF_COMPANY_XREF CTADJ2
           WHERE CTADJ2.COMPANY = CTADJ.COMPANY
             AND CTADJ2.EFFDT  <= $AsOfDate)
     #endif
    #else
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      AND CTADJ.COMPANY = SADJ.COMPANY
      AND CTADJ.TF_EFFDT = (SELECT MAX(CTADJ2.TF_EFFDT)
           FROM PS_TF_COMPANY_XREF CTADJ2
           WHERE CTADJ2.COMPANY = CTADJ.COMPANY
             AND CTADJ2.TF_EFFDT  <= $AsOfDate)
     #endif
    #endif
    
    #ifdef SUBTOTAL_FEIN
      ORDER BY COADJ.FEDERAL_EIN, SADJ.COMPANY, SADJ.STATE, SADJ.TAX_CLASS, SADJ.LOCALITY
    #else
       #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         ORDER by CTADJ.TF_COMPANY, SADJ.COMPANY, SADJ.STATE, SADJ.TAX_CLASS, SADJ.LOCALITY
       #else
         ORDER by SADJ.COMPANY, SADJ.STATE, SADJ.TAX_CLASS, SADJ.LOCALITY
       #endif
    #endif
 
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
   if #Last_TaxBalance_Cnt > 0
      let $Client_CompID = $Current_Company
      do Process-Tax-Record
   end-if
 
   let $company_adjustment = ''
   show 'Count of TBA Sweep adjustments  = ' #Tax_baladj_inserts_count
 
No_Sweep_prior_to_live:
 
end-PROCEDURE
 
#endif !Sweep balance adjustments

#ifdef USE_CALENDAR_CHECK_DATE_FOR_TBAs 
begin-procedure log-calendar-check-date
 

 let $new_calendar_company = 't'
 let #calinx = 0
 while #calinx < #calendar_check_dates
    get $cmpchk from calendar_check_dates(#calinx) Company 
    if rtrim($cmpchk, ' ') = rtrim($Current_calendar_company, ' ')
     let $new_calendar_company = 'f'
     break
    end-if
    add 1 to #calinx
 end-while
 
 if $new_calendar_company = 't'
  if #calendar_check_dates < {calendar_check_dates_limit}
    put $Current_calendar_company $Current_calendar_check_date into calendar_check_dates(#calendar_check_dates) Company Check_dt
    add 1 to #calendar_check_dates
    show 'log-calendar-check-date: ' #calendar_check_dates edit 999 '. ' $Current_calendar_company ' ' $Current_calendar_check_date
  else
    show 'error: increase size of calendar_check_dates array in pbzper.sqr'
    stop
  end-if
 end-if
 
end-procedure

begin-procedure get-calendar-check-date

 show 'get-calendar-check-date: Init ' $ADJ_COMPANY ' ' $Current_calendar_check_date

 let $calendar_company = 'f'
 let #calinx = 0
 while #calinx < #calendar_check_dates
    get $cmpchk $chkdt from calendar_check_dates(#calinx) Company Check_dt
    if rtrim($cmpchk, ' ') = rtrim($ADJ_COMPANY, ' ')
     let $calendar_company = 't'
     break
    end-if
    add 1 to #calinx
 end-while
 
 if $calendar_company = 't'
    move $chkdt to $Current_calendar_check_date
    show 'get-calendar-check-date: ' $ADJ_COMPANY ' ' $Current_calendar_check_date
 end-if
 
end-procedure

#endif

 
#endif  !get balance adjustments
 
 
#ifdef CUSTOM_RUN_DAILY_BATCH
 
begin-procedure Update-Auto-Error
   show 'Error updating PS_{Client_Table_Prefix}PBZ_PER{Client_Table_Suffix}'
end-procedure
 
!********************************************************
begin-procedure Update-Auto-Run-Control-Record
 
 
begin-sql on-error=Update-Auto-Error
 
 UPDATE PS_{Client_Table_Prefix}PBZ_PER{Client_Table_Suffix}
   SET   PROCESS_FLAG       = 'Y'
   WHERE PROCESS_FLAG       = 'N'                  !Flagged as complete
 
end-SQL
 
end-procedure
 
#endif
 
begin-procedure check-for-void-w2  !from adp303, N/A for periodic
end-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Called SQC Procedures                                                !
!----------------------------------------------------------------------!
 
#ifdef  debug_sql_stats_oracle
 
!***********************************************************************
begin-procedure Get-Current-time
!***********************************************************************
#ifdef ORACLE
 
begin-select
to_char(sysdate,'YYYYMMDD,HH:MI:SS A.M.') &ora_tmp_time
 let $display_dt =  &ora_tmp_time
from dual sysdte
 
end-select
 
#else
  do Get-Current-DateTime
  let $display_dt = $SysDateTime
#endif
 
end-procedure
 
#endif
 
#if {SITE_ID} = 'WHS1'
#include 'wintocom.sqc'
!**********************************************************************
! Name:         WEY-Transmit-File
! Description:  Call the publishing adapter to transmit the file.
! Parameters:   None.
!**********************************************************************
begin-procedure WEY-Transmit-File
 
! commit changes
commit
 
show ' '
show '*****************************************************************'
show 'WHS1 File Publication'
show ' '
show 'File Name: ' $Filename
show ' '
 
! check to see if the file contains any data
open $Filename as 88 for-reading record=250:fixed_nolf status=#wey_filestat
read 88 into $work.record:250
close 88
 
if isblank($work.record)
    show 'File is empty.  File was not published.'
else 
 
    do WINTOCOM-WIA-Publishing-Adapter ($work.wey_filename,
                                        'STD',
                                        $work.return_status)
 
    if $work.return_status = '4'
        show 'The adapter is off.  The file was not published.'
    else
        if $work.return_status <> '0'
            show 'Error:  WIA publishing adapter did not complete normally.  Contact the Integration Services team.'
            show ' '
            show '*****************************************************************'
            stop
        end-if        
    end-if     
end-if  
 
show ' '
show '*****************************************************************'
 
end-procedure WEY-Transmit-File
 
!**********************************************************************
! Name:         WEY-Get-Check-Date
! Description:  Get the check date for off-cycle checks.  Returns the 
!               Friday following the Thursday to Wednesday cycle.  Or 
!               will return the pay calendar check date if the projected
!               date is in a different quarter.
! Parameters:  
!     Input:    $in.pay_calendar_check_dt - Check date from pay calendar
!    Output:    $out.check_dt             - Check Date for off-cycle
!**********************************************************************
begin-procedure WEY-Get-Check-Date ($in.pay_calendar_check_dt,
                                   :$out.check_dt)
 
! get the next Friday date
begin-select
trunc(next_day(sysdate+1, 'FRIDAY')) &check_dt
 
    let $out.check_dt = &check_dt
 
from dual
end-select
 
!  determine the date quarters
begin-select
trunc((to_number(to_char(to_date($out.check_dt),'MM'))-1)/3)+1 &current_qtr
trunc((to_number(to_char(to_date($in.pay_calendar_check_dt),'MM'))-1)/3)+1 &pay_calendar_qtr
 
from dual
end-select
 
! set the date to the pay calendar check date if it is in a different quarter
if &current_qtr <> &pay_calendar_qtr
    !show 'WEY-Get-Check-Date: moving check from ' $out.check_dt ' to ' $in.pay_calendar_check_dt
    let $out.check_dt = $in.pay_calendar_check_dt
end-if
 
end-procedure
#endif  ! WHS1 - WEY END WR0955
 
 
 
 
#ifdef OFF_CYCLE_DETAIL_PRINT
 
begin-procedure populate-off-cycle-detail
 
   if #off_cycle_detail_cnt < {OFF_CYCLE_DETAIL_PRINT_LIMIT}
    put    $payline_company          -
           $payline_paygroup         -
           $payline_pay_end_dt       -
           $A_Check_Dt               -
           $payline_check_dt         -
           $Today_Plus1              -
           $payline_emplid           -
           &PC.PAYCHECK_OPTION       -
     into off_cycle_detail(#off_cycle_detail_cnt)               -
           Company                   -
           Paygroup                  -
           Pay_end_dt                -
           Cal_Check_dt              -
           Issue_dt                  -
           Liab_dt                   -
           Emplid                    -
           Paycheck_option
 
     add 1 to #off_cycle_detail_cnt
     
   else
      show 'Error: increate OFF_CYCLE_DETAIL_PRINT_LIMIT definition in pbzper.sqr'
      stop
   end-if
     
end-procedure
 
begin-procedure off-cycle-detail-breakout
 
 show 'off-cycle-detail-breakout: #off_cycle_detail_cnt = ' #off_cycle_detail_cnt
  
 if #off_cycle_detail_cnt > 0
 
  let #header_type = 18
  let $Company = 'ALL'
  let $ReportTitle  = 'ADP Employment Tax, Periodic Extract. Off-Cycle Details'
 
  let #cinx = 0
  while #cinx < #off_cycle_detail_cnt
    get    $od_company                  -
           $od_paygroup                 -
           $od_pay_end_dt               -
           $od_A_Check_Dt               -
           $od_payline_check_dt         -
           $od_Today_Plus1              -
           $od_payline_emplid           -
           $od_PAYCHECK_OPTION          -
     from off_cycle_detail(#cinx)       -
           Company                   -
           Paygroup                  -
           Pay_end_dt                -
           Cal_Check_dt              -
           Issue_dt                  -
           Liab_dt                   -
           Emplid                    -
           Paycheck_option
 
    !prints
    print $od_company          (+1,1)
    print $od_paygroup         (0,10)
    print $od_pay_end_dt       (0,20)
    print $od_A_Check_Dt       (0,35)
    print $od_payline_check_dt (0,50)
    print $od_Today_Plus1      (0,65)
    print $od_payline_emplid   (0,80)
    print $od_PAYCHECK_OPTION  (0,95)
        
    add 1 to #cinx
  end-while
  
  print 'Note, These entries are for Off-cycle checks where the Issue Date is <= Current Date only.' (+2,1)
  
  New-Page
 end-if
 
end-procedure
 
#endif
 
 
#ifdef ADP_TAX_PERIODIC_CHECK_DATE
 
begin-procedure Get-Report-Parameters-check-date
 
 show ' '
 show 'Get-Report-Parameters-check-date ' $prcs_oprid ' ' $prcs_run_cntl_id ', Table: {CHECK_DATE_RUN_CONTROL_TBL}'
 show '--------------------------------'
 
 let #SlctPageFrom = 1 
 let #SlctPageThru = 99999
 let $First_check_date = 'Y'
 
 move  'A.CHECK_DT in (' to $SlctCalendar     !Build  $SlctCalendar for Where clause
 
begin-SELECT
NRCTL.CHECK_DT
NRCTL.CYCLE_SELECT
 
  if rtrim(&NRCTL.CYCLE_SELECT,' ') = 'O'
       move 'N' to $SlctOffCycleA
       move 'N' to $SlctOffCycleB
       let $CycleInd = 'F'
  end-if   
  
  if rtrim(&NRCTL.CYCLE_SELECT,' ') = 'F'       
        move 'Y' to $SlctOffCycleA
        move 'Y' to $SlctOffCycleB
        let $CycleInd = 'O'
  end-if
  
  if rtrim(&NRCTL.CYCLE_SELECT,' ') = 'B'       
        move 'N' to $SlctOffCycleA
        move 'Y' to $SlctOffCycleB
        let $CycleInd = 'B'
  end-if
 
 if $First_check_date = 'Y'
    let $First_check_date = 'N'
 else  
    concat ','           with $SlctCalendar
 end-if
 
 #ifdef SWEEP_CHECK_DT_FROM_RC_QTR
   move &NRCTL.CHECK_DT to $Check_Dt_RC
 #endif
 
 concat ''''            with $SlctCalendar
 concat &NRCTL.CHECK_DT with $SlctCalendar
 concat ''''            with $SlctCalendar
 
 FROM {CHECK_DATE_RUN_CONTROL_TBL} NRCTL
 WHERE NRCTL.OPRID        = $prcs_oprid
   AND NRCTL.RUN_CNTL_ID  = $prcs_run_cntl_id
 
end-SELECT
 
   if $First_check_date = 'Y'
     show 'No data selected from {CHECK_DATE_RUN_CONTROL_TBL}. Aborting'
     stop
   else
     concat ')'   with $SlctCalendar
   end-if
   
   show '$SlctCalendar         : ' $SlctCalendar    
   show '$SlctOffCycleA        : ' $SlctOffCycleA
   show '$SlctOffCycleB        : ' $SlctOffCycleB
   show '$CycleInd             : ' $CycleInd
   show 'Select-CFG-Params complete via Run control table: {CHECK_DATE_RUN_CONTROL_TBL}'
   show ' '
 
end-procedure
 
#endif
 
 
#if {SITE_ID} = 'PFZ1'
   #include 'getjobin.sqc'  !Get-Job-Info procedure
#endif
 
#ifdef VALIDATE_CHECK_DATE
   #include 'validcdt.sqc'  !Ensure-Valid-Check-dt  (PFE) New 2/24/04
#endif
 
!2/9/99 added for Ogden, pay run dt, check date...
!-------------------------------------------------
#ifdef BY_PAYENDDT
  !Payroll-Report-Init, and Get-Run-Control via PAYENDDT
  !---------------------------------------------------------
  #include 'pbz_pydt.sqc'
#else
 #if {SITE_ID} = 'FTO1'
    #include 'getparm.sqc'
    #include 'cycleprm.sqc'
    #include 'adpfrito.sqc'
 #else
 
 
  #ifdef MULTIPLE_RUNS
    !Payroll-Report-Init, and Get-Run-Control via MULTIPLE RUNS
    !----------------------------------------------------------
    #if {SITE_ID} = 'PMT1'
     #include 'z_pbz_runs.sqc'  !do bypass-tax-check
    #else
     #include 'pbz_runs.sqc'  !do bypass-tax-check
    #endif
 
  #else
    #ifdef CUSTOM_RUN_SELECTION
 
      #ifdef PBZPER_WEEK_PROCESSING
	   #include 'pbz_prun.sqc'    !JCPenney's payroll-report-init...
      #endif
 
      #ifdef CUSTOM_RUN_DAILY_BATCH
        #ifdef SPLIT_RUN_CONTROL_UPDATE
            #include 'pbz001.sqc'        !this is if the auto run control is built in a seperate sqr
        #else
            #if {SITE_ID} = 'PMT1'
              #include 'z_adpauto.sqc'  !do bypass-tax-check
            #else
              #if {SITE_ID} = 'BKR1'
                 #include 'pbz_auto.sqc'
              #else
                 #include 'adpauto.sqc'  !do bypass-tax-check
              #endif
            #endif
        #endif
      #endif
 
    #else
     #if {SITE_ID} = 'GE01'   	!Tracker # 669108
     	  #include 'gepyinit.sqc'       !Tracker # 669108
     #else			        !Tracker # 669108
         #if {SITE_ID} = 'VFS1'
           #include 'payrctl2.sqc'       !Select-Parameters procedure
         #else			  
           #if {SITE_ID} = 'CRB1'
              #include 'tfdinita.sqc'   !Custom Report Initialization and Timing
           #else
       	       #if {SITE_ID} = 'USB1'
                  #Include 'mpayinit.sqc'  ! Get-Run-Control procedure
               #else
                  #ifndef ADP_TAX_PERIODIC_CHECK_DATE
                    #include 'payinit.sqc'        !via standard Payroll-Report-Initialization procedure
                  #endif
      	       #endif !USB1
      	   #endif !CRB1
           #include 'payrnctl.sqc'  !Get-Run-Control procedure
     	 #endif !VFS1
     #endif !GE01
   #endif !CUSTOM_RUN_SELECTION
  #endif !MULTIPLE_RUNS
 #endif !FT01
#endif !BY_PAYENDDT
 
#if {SITE_ID} <> 'SOL1'
  #if {SITE_ID} <> 'WFG1'
    #include 'stdapi.sqc'    !StdAPI-Init procedure
  #endif
#endif
 
 
#include 'reset.sqc'     !Reset printer procedure
#include 'getcodta.sqc'  !get-company-data
#include 'getpgdta.sqc'  !get-paygroup-data
#Include 'getstdta.sqc'  !Get-State-Tax-Data procedure
#Include 'getlcdta.sqc'  !Get-Local-Tax-Data procedure
#Include 'getbalid.sqc'  !Get-Calendar-Year-Id
 
! Freddie Mac Customization for backup and transfer files.....!!!!!
#if {SITE_ID} = 'FHL1'
 #Include 'fmpbbkft.sqc'  !kmr
#endif
 
 
#if {Peoplesoft_Version} >= '8.8'
 #Include 'readxlat.sqc'
 #if {SITE_ID} = 'WFG1'
  #Include 'PRCSLNG.sqc'
 #end-if
#endif
 
 
#ifdef KJDA
  #include 'kjda.sqc'
#endif
 
#if {SITE_ID} = 'AXA1'
#include 'axrunloc.sqc'
#Include 'useprntr.sqc'
#endif
 
#if {SITE_ID} = 'ALB1'
#Include 'axc0011.sqc'   !Get-Run-Location                                 ! Pete - 05/17/00
#endif
 
#if {SITE_ID} = 'DOW1'
 #Include 'setup07.sqc'
#endif
 
#if {SITE_ID} = 'STV1'
 #Include 'stvfilestr.sqc'  !VG - Added by ST.Vincent to Build File String
#endif
 
#if {SITE_ID} = 'WCH1'
  #Include 'fusqrenv.sqc'   !Environment vars
  #include 'fuftp.sqc'      !File Transfer Process
 
#endif
 
#ifdef HOLD_CREDITS
  #if {SITE_ID} = 'PMT1'
    #include 'z_pbz_cred.sqc'  !procedure Init-ADPCompid
  #else
    #include 'adpcred.sqc'  !procedure Init-ADPCompid
  #endif
#endif
 
#if {SITE_ID} = 'MCK1'
  #include 'msetdir.sqc'
#endif
 
#if {SITE_ID} = 'PFG1'
 #include 'usgftp.sqc'    !FTP to NT procedure
#endif
 
 
! GNT set variables for file paths.
#if {SITE_ID} = 'GTI1'
  #Include 'gntfilepath.sqc' !Output Directory path
#endif
 
#if {SITE_ID} = 'SIE1'  !6/6/03
  #include 'adpsieftp.sqc'
  #include 'siemens.sqc'
#endif
 
#if {SITE_ID} = 'SOL1'
     #include 'tranctrl.sqc'  !Transaction Control          !tmschn: added SQC
     #include 'sqlerror.sqc'  !SOL1 SQL Error Routine       !tmschn: added custom SQC
     #include 'stdvar.sqc'    !PeopleSoft Std Var Routine
     #include 'prcslng.sqc'   !Get-PSOptions-Language
#endif
    
!KMT1, get parms sqc
#if {SITE_ID} ='KMT1'
  #Include 'PP05K.sqc' ! Get-KMT1-Parms
#endif
 
#if {SITE_ID} = 'HWL1'
  #Include 'asenv.sqc'                                             !AlliedSignal Environment Values
#endif
 
#if {SITE_ID} = 'PMT1'
   #include 'z_adpbypas.sqc'  !do bypass-tax-check
   #include 'z_common.sqc'    !added 5/14/2007:  to initialize $Output_Path      !PS 89 Upgrade - lsk - Naming Standard Compliance
#else
   #ifndef ADP_BYPASS_TABLE
    #include 'adpbypas.sqc'  !do bypass-tax-check
   #else
    #include 'adpbypst.sqc'  !do bypass-tax-check (Table)
   #endif
#endif
 
 
#if {SITE_ID} = 'AMP1'
  #include 'axfilepaths.sqc'
#endif
 
#if {SITE_ID} = 'KFC_OLD'
  #include 'adp_tax_split.sqc'
#endif
 
!#if {SITE_ID} = 'NAS'
!  #Include 'e1adp.sqc'     !Copy files to history folder
!#endif
 
#if {SITE_ID} = 'WFG1'
  #Include 'wftfctrl.sqc'
  #Include 'stdvar.sqc'
  #Include 'tranctrl.sqc'  !commit-transation
#endif
 
#if {SITE_ID} = 'ELR1'
 #include 'getpath.sqc'
#endif 
 
#if {SITE_ID} = 'ICI11'
  #include 'getprcsd.sqc'
#endif
 
!#if {SITE_ID} = 'SGB1'
!  #Include 'sgdbname.sqc'  !Get File Path
!#endif
 
#if {SITE_ID} = 'JLL1'
 #include 'lpl1.sqc'      !LP custom sqc to get the server outbox folder
#endif
 
#if {SITE_ID} = 'FRB1'							!FRB 02/13/2006
  #include 'ZZU0001.SQC'		     					!FRB 02/13/2006
#endif										!FRB 02/13/2006
 
#if {SITE_ID} = 'LFG1'
  #include 'lxmap001.SQC'		     					
#endif
 
#if {SITE_ID} = 'TFF1'
  #include 'tygetprm.SQC'		     					
  #include 'tysqrpns.SQC'		     					
#endif
 
#if {SITE_ID} = 'ACL1'
  #include 'amc.sqc'
  #include 'amcxlat.sqc'	 !AMC Translate Procedures
#endif
 
#ifdef GL_TAX_CHECK_DATE_BREAKOUT
  #include 'adpgltot.sqc'
#endif
 
#ifdef TAX_CLASS_REPORT
  #include 'adptcrpt.sqc'
#endif
 
#if {Site_ID} = 'ITE1'
   #include 'transmit.sqc'
   #include 'pbzper.sqc'
   #include 'ziadp.sqc'
#endif
 
#include 'adpstdnm.sqc'                     !existing (pre 2/16/09) custom extract naming, and standard naming conventions
#include 'adpcusnm.sqc'                     !new custom extract datafile naming conventions
 
#ifdef PERIODIC_ANNUAL_RECONCILIATION
 #include 'adprecnp.sqc'            !procedure PERIODIC-ANNUAL-RECONCILIATION
#endif
 
#ifdef BYPASS_ZERO_LOCALS_PERIODIC
  #include 'adplocbp.sqc'
#endif
 
#ifdef TF_AUDIT
  #include 'tfaudit.sqc'
#endif
 
#if {SITE_ID} = 'SQP1'
  #include 'hrsecty.sqc'   !Get SQR Security parameters, sets $SecurityClauseWithERN
#endif
 
#if {SITE_ID} = 'USB1'
  #include 'mtrcksqr.sqc'  ! Track SQR run 
  #include 'mtfusbtr.sqc'
#endif
 
#if {SITE_ID} = 'AHM1'
  #include 'z_ftpfil.sqc' !Routine for encryption & FTP transmission
#endif
 
#if {Client_ID} = 'AST1'
  #Include    'amenv.sqc'
  #Include    'asapbz.sqc'  ! Call PGP and File Transfer 
#endif
 
#if {SITE_ID} = 'CRB1'
!************************************************************************
! This procedure will update the multi page showing that the tax        *
! interface has been completed.SITE_ID = 'CRB1'                         *
!************************************************************************
Begin-Procedure Update_Multi_Page
Begin-Sql
Update PS_CRB_PAY_CALC
Set CRB_TAX_RUN       = 'N',
    CRB_TAX_PROCESSED = 'Y'
Where CRB_TAX_RUN = 'Y'
End-Sql
End-Procedure   Update_Multi_Page
#endif

#ifdef OHIO_COURTESY_WITHHOLDING   

begin-procedure Ohio-Courtesy-withholding-Periodic

 if #Ohio-Courtesy-withholding = 0
   show ''
   show 'Ohio-Courtesy-withholding enabled. '
   show ''
   add 1 to #Ohio-Courtesy-withholding
 end-if

   if ($Trimmed_State = 'OH' and $Trimmed_Tax_Class = 'H' and $Trimmed_Locality <> '' and &PT.TAX_CUR <> 0 and &PT.TXGRS_CUR <> 0)
          move $Trimmed_Locality to $save_oh_local
          let #l_oh_local = length($save_oh_local)
          if #l_oh_local > 4       !all 4 char localities in Ohio are S.D. and we don't want to change the S.D. Locals.. they're not related to courtesy logic
              
             do get_tax_distrib_oh
	 											
!Cincinatti  (15000)                                                                                       PeopleSoft 		ADP		EMPLID
! normal        a   Works in Cincy lives somewhere else with two taxcodes        NonResident tax code       OHH15000             0672
!               b   Works and Lives in Cincy one taxcode                         Alternate tax code         OHH150001       Y    3602  
! normal        c   Lives in Cincy works somehwere else with two wage recs       Resident tax code          OHH15000        Y   any alt code

             if rtrim($Trimmed_Locality,' ') = '15000' 
            
!11/3/16
!              if $courtesy = 'f'                                               !b.   a & c are the normal resident/non-resident situations               
               if $courtesy = 'f' and &PT.RESIDENT = 'Y'                        !b.   a & c are the normal resident/non-resident situations               
                 let $Trimmed_Resident = 'Y'
                 let $Alt_Locality = $Trimmed_Locality || '1' 
                 let $Trimmed_Resident = $Alt_Locality
                 show 'OH Courtesy: MUNI_COURTESY_VIA_TAX_DISTRIB, EMPLID ' $Payline_Emplid ', (b) Works and Lives in Cincy one taxcode ' $Alt_Locality ' Resident'
               end-if
               
             else
             
!non-Cincinatti                                                                                           PeopleSoft 	      ADP		EMPLID
! normal       d    Works in Columbus, lives somewhere else with two taxcodes    NonResident tax code     OHH18000           3604      
!              e    Works and Lives in Columbus one taxcode                      NonResident tax code     OHH18000           3604 
! normal       f    Lives in Columbus, works somehwere else with two wage recs   Resident tax code        OHH18000     Y     any alt code

               if $courtesy = 'f'                         !e.   d & f are the normal resident/non-resident situations               
                 let $Trimmed_Resident = 'N'
                 show 'OH Courtesy: MUNI_COURTESY_VIA_TAX_DISTRIB, EMPLID ' $Payline_Emplid ', (e) Works and lives in same locality one taxcode. ' $Trimmed_Locality ' Non-Resident'
               end-if
            
             end-if
              
             
          end-if   !Muni
   end-if      !Ohio withholding with QTD balances

end-procedure

begin-procedure  get_tax_distrib_oh

 let $courtesy = 't'

BEGIN-SELECT
OHTD.LOCALITY

  let $courtesy = 'f'

   FROM PS_TAX_DISTRIB OHTD
     WHERE  OHTD.EMPLID   = $payline_Emplid 
        AND OHTD.STATE    = 'OH' 
        AND OHTD.LOCALITY = $save_oh_local  !if there, they work there, no courtesy
        AND OHTD.EFFDT = (SELECT Max(OHED.EFFDT) 
          FROM   PS_TAX_DISTRIB OHED 
              WHERE  OHTD.EMPLID     = OHED.EMPLID 
                 AND OHTD.EMPL_RCD   = OHED.EMPL_RCD 
                 AND OHED.EFFDT  <= $PayLine_pay_end_dt) 

END-SELECT

  show 'OH Courtesy: MUNI_COURTESY_VIA_TAX_DISTRIB, get_tax_distrib_oh ' $payline_Emplid ' ' $save_oh_local ' ' $Payline_pay_end_dt ' --> ' $courtesy

end-procedure
#endif     

! ----------------- PBZPER.SQR: The End ---------------------!
