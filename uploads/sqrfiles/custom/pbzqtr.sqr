#ifdef COMMENT_COMPILE
!**********************************************************************
! SQR Name:           pbzqtr.sqr
! SQR Descr:          ADP Employment Tax Quarterly/W-2 Filing
! Created by:         drmonroe
! Create date:        03/03/2010
! Last modified by:   drmonroe
! Last modified date: 02/16/2014
!***********************************************************************
! Aug 31, 2016     Yash - OA Customization to include oaprcsdr.sqc
! ----------------------------------------------------------------------------------
!#define ADPTAX_CONFIG   !enable this if the client uses ADPTAX.SQC not PROBIZ.SQC
! ----------------------------------------------------------------------------------
 
!#define MULTI_COMPANY_RC !if this is defined, save as pbzqtrmc.sqr
!#define ADP_TAX_AMEND    !    if this IS defined, save as adpamend.sqr, if not... save as pbzqtr.sqr
                          !----------------------------------------------------------------------------

#endif

#define ADP_TAX_QUARTERLY !tells the probiz.sqc this is a quarterly run
#define PBZQTR_release     20170306 !yyyymmdd
 
!#define ADPTAX_CONFIG
 
#ifdef ADPTAX_CONFIG
 #include 'adptax.sqc'
#else
  #include 'probiz.sqc'
#endif

#ifndef QUARTERLY_REPORT_ID
   #ifdef ADP_TAX_AMEND
     #define QUARTERLY_REPORT_ID ADPAMEND
   #else
     #define QUARTERLY_REPORT_ID PBZQTR
   #endif
#endif

#ifndef REPORT_PREFIX
  #define REPORT_PREFIX
#endif

#define Program_Version    {QUARTERLY_REPORT_ID}.Mar 06, 2017

#ifndef TESTING_EMPLID
  #define TESTING_EMPLID               !single associate testing via probiz.sqc
  !#define TESTING_EMPLID  KU0007       !single associate testing via probiz.sqc
#endif
#if {SITE_ID} <> 'WFG1' !Wells is not using new option
      #define ADPNGTUI    ! if the client has at least a stub of the new adptcfg.sqc file.. enable this, allows probiz.sqc options to be overwritten
#endif
#ifdef ADPNGTUI
  #include 'adptcfg.sqc'
#endif

#define PA_STATE PA
 
#if {SITE_ID} = 'WFG1'
!  #define PROCESS_WF_EMPLOYEE_SPLIT_QUERY
  #define USE_INT_CRITERIA
#endif

#ifndef NM_UI_LOCATION_DFLT
  #define NM_UI_LOCATION_DFLT 00001
#endif
 
#ifndef RIMINI_STREET_TAX_UPDATES
  #ifndef ADP_TAX_DEV
    #define PAACT_32_11F_LOGIC             !Allows the periodic and quarterly to use the new RES_PSD_CD and WORK_PSD_CD fields
    #define PA_ACT_32_SET_X1_FIELD_CODE    !The directs the quarterly extract to populate the Resident PSD code, not the Resident Local taxcode (X2)
  #endif
#endif
 
#if {SITE_ID} = 'BKR1'
 #include 'fpathbi.sqc'
#endif

! OA Customizations - Yash 08/31/2016 - Start
#if {SITE_ID} = 'OGR1'
 #include 'oaprcsdr.sqc'
#endif

#if {SITE_ID} = 'ONA1'
 #include 'oaprcsdr.sqc'
#endif
! OA Customizations - Yash 08/31/2016 - End

#define GENERATE_STATE_FUTA  !11/28/2011 as a standard feature, nees the PS_TF_ADP_ST_FUTA table
#ifdef GENERATE_STATE_FUTA
 #ifndef STATE_FUTA_TAX_CLASS        !Rimini Street clients could set this to 'S' to use the Rimini tax class 'S' values
  #if {PeopleSoft_Version} >= '9.0'
    #define STATE_FUTA_TAX_CLASS 6  !only 9.1 gets the '6' Tax_Class update
  #else
    #define STATE_FUTA_TAX_CLASS 4  !otherwise we need to generate it to virtual class '4'
  #endif
 #endif
#endif
 
 
#ifdef ADP_TAX_AMEND
  #define STRIPPED_PBZQTR_REPORT   !June 2011
  #define INCLUDE_W2C
  #if {SITE_ID} <> 'PWH1'
    #define UPDATE_QTD_WITH_W2C
  #endif
  #if {SITE_ID} = 'CPO1'  !10/7/2013
    #define CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS !this is if clients are ALWAYS going to handle Amendments and W-2Cs via TBA's
  #else
    #define adjust-tax-balances-for-new-state-locals ! (pulls W-2C data for NEW states)
    #define adjust-tax-balances-to-match-ee          ! (matches ER to EE for FICA and MED)
  #endif
#else
    #define CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS !this is if clients are ALWAYS going to handle Amendments and W-2Cs via TBA's
#endif
 
#ifndef CLIENT_ID
 #define CLIENT_ID
#endif
 
#ifndef SITE_ID
 #define SITE_ID
#endif
 
#ifndef NOLOCK_SQL
 #define NOLOCK_SQL
#endif
 
#if {SITE_ID} = 'WFG1'
  #define DECLARE_VARIABLES
#endif
#if {SITE_ID} = 'YRC1'
  #define DECLARE_VARIABLES
#endif

#ifdef DECLARE_VARIABLES
begin-setup
declare-variable
!integer #RptYear
 integer #SelectedMonth
!integer #RptMonth
!integer #RptQtr
 integer #Cit_start_month
 integer #Cit_end_month
 integer #PSPC_PAGE
 integer #PSPC_LINE
 integer #PSPC_SEPCHK
 integer #Current_FEIN
 integer #Period_Count
 integer #PSPC_empl_rcd
end-declare
end-setup
#endif

 
!#define debug_sql_trace_oracle
 
#if {SITE_ID} = 'INT1'
  #include 'ibp_proc.sqc' !KF-fix 4-24-2004 9pm
#endif
 
 #if {SITE_ID} = 'AXA1'
     #Include 'setup32.sqc'  !Landscape, PDF for Axa Financial, setup31 for portrait
 #else
      #if {SITE_ID} = 'PMT1'
        #Include 'setup32.sqc'  !Landscape, PDF for Paramount
      #else
        #if {SITE_ID} = 'SOL1'
          #Include 'setup177.sqc'  !Landscape, FileNet for SOL1
        #else
           #if {SITE_ID} = 'MLN1'
            #ifdef UNIX
             #Include 'mops177.sqc'  !Page-size initialization
            #else
             #Include 'setup02.sqc'  !Printer and page-size initialization
            #endif
           #else
            #if {SITE_ID} = 'PFZ1'
             #Include 'setup02_m1.sqc'  !Printer and page-size initialization
            #else
              #Include 'setup02.sqc'  !Printer and page-size initialization
            #endif
         #endif
        #endif
      #endif
 #endif
 
 #if {SITE_ID} = 'DOW1'
  #include 'setenv.sqc'
  #define DWPAY2
  #define DEFINE_Read-Misc-Employee-Data-1099s
 #endif
 
 #if {SITE_ID} = 'CGI1'
  #define DEFINE_Read-Misc-Employee-Data-1099s
 #endif
 
 #if {SITE_ID} = 'CSA1'
  #define DEFINE_Read-Misc-Employee-Data-1099s
 #endif
 
 #if {SITE_ID} = 'AWP1'
  #define DEFINE_Read-Misc-Employee-Data-1099s
 #endif
 
!allow for a Wyoming Workers comp LOCALITY of something other than WY0001
!------------------------------------------------------------------------
#ifndef WY_WORKERS_COMP_LOCALITY_OVERRIDE
   #define WY_WORKERS_COMP_CD WY0001
#else
   #define WY_WORKERS_COMP_CD {WY_WORKERS_COMP_LOCALITY_OVERRIDE}
#endif
 
#ifndef START_WA_WORKERS_COMP_YYYYQ
  #define START_WA_WORKERS_COMP_YYYYQ  20113  !default to starting the PA Act 32 processing in Q1, 2011
#endif
 
#ifndef WA_STATE   !for testing
  #define WA_STATE WA
#endif
 
#ifdef WORKERS_COMP_ENABLE_TABLE
   #define WORKERS_COMP_ENABLE_TABLE_WY
   #define WORKERS_COMP_ENABLE_TABLE_WA
   #define WA_WORKERS_COMP_ENABLE
   #define WC_RATE_FACTOR 10000
#endif
 
 
#ifdef WA_WORKERS_COMP_ENABLE
 #ifndef WA_WORKERS_COMP_LOCALITY_OVERRIDE
    #define WA_WORKERS_COMP_CD WA0001
 #else
    #define WA_WORKERS_COMP_CD {WA_WORKERS_COMP_LOCALITY_OVERRIDE}
 #endif
 #ifndef WA_WORKERS_COMP_LOCALITY_OVERRIDE_ER
    #define WA_WORKERS_COMP_CD_ER WA0001ER
 #else
    #define WA_WORKERS_COMP_CD_ER {WA_WORKERS_COMP_LOCALITY_OVERRIDE_ER}
 #endif
#endif
!------------------------------------------------------------------------
 
#define ROLLUP_PHILLY_BALANCES
 
#ifdef WORKSITE_REPORTING
  #ifndef LOG_MWR_SETUP_TBL
    #define LOG_MWR_SETUP_TBL  PS_{Client_Table_Prefix}ADP_MWR_TBL{Client_Table_Suffix}
  #endif
#endif
 
 #if {SITE_ID} = 'PMT1'
  #include 'z_proadp.sqc'    !New for ADP migration
 #else
    #ifdef ADPTAX_CONFIG
      #include 'adp303.sqc'    !New for ADP migration
    #else
      #include 'proadp.sqc'    !New for ADP migration
    #endif
 #endif
 
#ifdef PROCESS_1099s
  #define SKIP_EE_DETAILS_PRINT_ADPQ210
  #define SKIP_TAX_AND_WAGE_BREAKDOWN
  #define STRIPPED_PBZQTR_REPORT   !June 2012
  #define SKIP_1099_PRINT   !no room for this part of the adp1099 print / report (out of param issue)
  #define SKIP_FILTER
  #define SKIP_SUI_SUMMARY
#endif
 
#ifdef LOCAL_RECIPROCITY
  #define STRIPPED_PBZQTR_REPORT   !June 2012
#endif
 
#if {SITE_ID} <> 'TCN1'
 #if {SITE_ID} <> 'FHS1'  !08232013 per MP/FHS1
  #ifdef THIRD_PARTY_SICK_DED
    #define STRIPPED_PBZQTR_REPORT   !June 2012
  #endif
 #endif
#endif
 
#if {SITE_ID} = 'WFG1'
 #define DEMAND_TAX_AND_WAGE_BREAKDOWN
#endif
#if {SITE_ID} = 'GHV1'
 #define DEMAND_TAX_AND_WAGE_BREAKDOWN
#endif
 
#ifdef STRIPPED_PBZQTR_REPORT
   #define SKIP_ZERO_LOCALS
   #define SKIP_RESIDENT_AUDIT
   #define SKIP_TAX_AND_WAGE_AUDITS
   #define SKIP_1099_PRINT
   #if {SITE_ID} <> 'GCO1'
     #define SKIP_PA_ASSOCIATE_DETAILS_ON_REPORT
     #define SKIP_PA_WORK_DETAILS_ON_REPORT
   #endif
   
   #ifndef DEMAND_EE_DETAILS_PRINT_ADPQ210
     #define SKIP_EE_DETAILS_PRINT_ADPQ210
   #endif
   
   #ifndef DEMAND_TAX_AND_WAGE_BREAKDOWN
     #define SKIP_TAX_AND_WAGE_BREAKDOWN
   #endif
 
#endif

#define PA_WORKSITE_EXTRACT          !required, V1Q2011
#define PA_WORKSITE_AUTO
#ifdef PA_WORKSITE_AUTO
  #include 'adppaaut.sqc'
#endif
 
#ifndef ADP_TAX_AMEND
 #ifdef Process_1099s
   #if {SITE_ID} = 'PMT1'
      #include 'z_adp1099.sqc'
   #else
      #if {SITE_ID} = 'DCG1'
        #include 'adpd1099.sqc'
      #else
        #include 'adp1099.sqc'
      #endif
   #endif
 #endif
#endif
 
#ifdef GENERAL_SUI_SPLIT_STATE
 #include 'adpuispl.sqc'
 #ifndef GENERAL_SUI_SPLIT_TAX_CLASS
   #define GENERAL_SUI_SPLIT_TAX_CLASS   U
 #endif
#endif
 
 
#ifdef COMMENT_COMPILE
! ADP Employment Tax
! ----------------------------------
!
! Author: Dan Monroe
!
! Version PBZQTR.SQR - February 2011
!
! Purpose: This SQR generates a quarterly tax extract and report which feed into the
!          ADP FACS Transporter in specs 3.0x Format, allowing ADP FACS to
!          handle quarterly reconciliations and filings.  Compatable for Peoplesoft
!          versions from 6 to 8.  This spec includes BOTH quarterly and W-2 data elements.
!
! PROPERTY of ADP FACS, A Division of ADP National Accounts
!
!    Modification History
!    --------------------
!                                                                        !
! To hook in the Process Schedulder:                                     !
! ----------------------------------                                     !
!
!        Current tax classes through 8.8
!        -------------------------------
!                 when = '$U'                  ! Company Totals
!                 when = '$UAS'                ! American Samoa
!                 when = '$UGU'                ! Guam
!                 when = '$UPR'                ! Puerto Rico
!                 when = '$UVI'                ! Virgin Islands
!                 when = 'A'  !Non-resident alien (1042)                                !HP99999
!                 when = 'B'  !ER/EE
!                 when = 'C'  !Earned Income Credit
!                 when = 'D'  !FICA or SDI EE
!                 when = 'E'  !FICA or SDI ER
!                 when = 'F'  !FICA Medicare/EE
!                 when = 'G'  !FICA Tips EE
!                 when = 'H'  !Withholding Employee Income Tax
!                 when = 'I'  !NJ-FLI-EE
!                 when = 'J'  !FICA Tips or SDI ER
!                 when = 'L'  !New Jersey SWAF
!                 when = 'M'  !New Jersey WFDP
!                 when = 'N'  !New Jersey HCSF
!                 when = 'O'  !Vol.NJ-FLI-EE
!                 when = 'P'  !Withholding Employee Occ Priv / LS Tax
!                 when = 'Q'  !FICA Medicare/ER
!                 when = 'R'  !Employer Only Local
!                 when = 'S'  !Unemployment - Special
!                 when = 'T'  !FICA Medicare Tips/EE
!                 when = 'U'  !Unemployment - ER
!                 when = 'V'  !Unemployment - EE
!                 when = 'W'  !VDI EE
!                 when = 'X'  !VDI ER
!                 when = 'Y'  !Vol.NJ-FLI-ER
!                 when = 'Z'  !FICA Medicare Tips/ER
!                 when = '4'  !Virtual State FUTA
!                 when = '6'  !State FUTA (12-E)
!                 when = '7'  !Medicare Surcharge  (12-E, 2013)
!                 when = '8'  !Fica Exempt ER (New Hire act)
!                 when = '9'  !Fica Exempt Tips ER (New Hire act)
!
!6/17/2011 WA L&I  (EE and ER definitions)
!------------------------------------------------------------------------
!standard configuration in probiz.sqc required for this:
!    #define WA_WORKERS_COMP_ENABLE                                    !enables the WA L&I logic starting Q3, 2011
!    #define CALC_WA_LI_HOURS                                          !enables the WA L&I hours calc (QTD Taxes / Rate)
!    #define WC_RATE_FACTOR 10000                                      !multiplier to format the rate
!additional optional configuration in probiz.sqc for this:
!    #define WA_WORKERS_COMP_LOCALITY_OVERRIDE        LI001            !if WA0001 is NOT the EE L&I Locality
!    #define WA_WORKERS_COMP_LOCALITY_OVERRIDE_ER     LI001ER          !if there is a ER L&I Locality add this to specify the Locality
!
!  Sep 21, 2015 #define MAP_OR_TRI_MET_TAXABLE_INTO_SUBJECT   P0746
!  Dec  7, 2015 STANDARD_HOME_INTL_TAX_LOC2_STATE
!  Jan  5, 2016 populate-sui-data updated to use PS_TAX_LOCATION2 if STANDARD_HOME_INTL_TAX_LOC2_STATE
!  May 10, 2016 added CHOOSE_NY_LOCAL_YE_AMOUNTS_ALWAYS (use ye amounts for NYC and Yonkers)
!  Jun  7, 2016 fix to the 'read-misc' routine to include SUBTOTAL_FEIN_EXTRACT logic for AUA1 when only Box 12DD exists with no balances
!  Aug 17, 2016 CUSTOM_EMPLOYMENT_TYPE PEN added (map retirees to PEN) see probiz.sqc
!  Aug 31, 2016 Standardize MULTIPLE_SITES Option with WG
!  Nov 1,  2016 SUBTOTAL_BUSINESS_UNIT_EXTRACT like SRC_BANK
!  Dec 8,  2016 see 12/8/16 sybase syntax error
!               {REPORT_PREFIX} option added
!               fix to Hire Date
!  Dec 12, 2016 EXE1 PER_ORG = 'EMP' only  see 12/12/16
!  Dec 14, 2016 SUBTOTAL_BUSINESS_UNIT_EXTRACT changed to include company in header records on 12/14/16 
!                 if SUBTOTAL_BUSINESS_UNIT_EXTRACT_include_Company is defined (DRMT)
!  Dec 19, 2016 Skip_Processing_Misc_Employees added (ORA-00600 for some clients without this option)
!  Jan 07, 2017 CBU1 - bypass tax class 'A' Federal if there are no YTD amounts, BYPASS_NON_RES_ZERO_YTD
!  Feb 28, 2017 GIE1 - CUSTOM_PA_EIT_GIE1  (bypass $0 tax records for RES 880000)
!  Mar 01, 2017 See $Pension_remap, (don't clear YTD's for void if this flag is set to 't' in probiz.sqc
!----------------------------------------------------------------------------------------------------------------------------------------
#endif

#ifdef WORKSITE_REPORTING
 #ifdef STANDARD_HOME_INTL_LOGIC
  #ifndef MWR_STATE_WIDE_WORKSITE_CRITERIA
    #define MWR_STATE_WIDE_WORKSITE_CRITERIA           upper(rtrim($LocationAbbrv,' ')) = 'HOME BASED'     ! short description
  #endif
  #ifndef MWR_FOREIGN_WORKSITE_CRITERIA
    #define MWR_FOREIGN_WORKSITE_CRITERIA              upper(rtrim($LocationAbbrv,' ')) = 'INTL'           ! short description PA/Pittsbu
  #endif
 #endif
#endif

#define FORCE_FILE_HEADER_AND_TRAILER

#ifdef ADP_TAX_DEV
  #define USE_OREGON_WC_HOURS_and_WEEKS_FOR_SUI  (#RptYear >= 2012)
#endif
 
#ifndef USE_OREGON_WC_HOURS_and_WEEKS_FOR_SUI
  #define USE_OREGON_WC_HOURS_and_WEEKS_FOR_SUI  (#RptYear >= 2015) or (#RptYear = 2014 and #RptQtr >= 4)
#endif
 
#ifdef USE_TEMP_TABLE_FOR_MONTHLY_COUNTS
  #ifndef PBZQTR_TEMP_TABLE
    #define PBZQTR_TEMP_TABLE PS_{Client_Table_Prefix}PBZQTR_TEMP{Client_Table_Suffix}
  #endif
#endif
 
 
#ifndef WAREHOUSE_SUFFIX
  #define WAREHOUSE_SUFFIX
#endif
 
#ifdef MULTIPLE_SITES	             !default multi-site table and field
  #ifndef WGPS_SITE_FIELD
    #define WGPS_SITE_FIELD {Client_Field_Prefix}WGPS_SITE{Client_Field_Suffix}
  #endif
  #ifndef ALT_SITES_CO_TABLE
    #define ALT_SITES_CO_TABLE PS_TF_ALT_SITES_CO{Client_Table_Suffix}
  #endif
  #ifndef ALT_SITES_TABLE
     #define ALT_SITES_TABLE PS_{Client_Table_Prefix}ALT_SITES{Client_Table_Suffix}
  #endif
  #ifndef INSTALLATION_TABLE
    #define INSTALLATION_TABLE  PS_{Client_Table_Prefix}INSTALLATION{Client_Table_Suffix}
  #endif
  #ifndef PBZPER_RC_TABLE
    #define PBZPER_RC_TABLE  PS_{Client_Table_Prefix}PBZPER_RC{Client_Table_Suffix}
  #endif
#endif
 
#ifndef TEST_EMPLID_PHRASE
  #define TEST_EMPLID_PHRASE =
#endif

#if {SITE_ID} = 'DRMT'
 #define SUBTOTAL_BUSINESS_UNIT_EXTRACT_include_Company
#endif

#if {SITE_ID} = 'CBU1'
  #define BYPASS_NON_RES_ZERO_YTD
#endif

#if {SITE_ID} <> 'HWL1'
 #define 08F_PNA_FLI_STATUS   ! comment this out if not up to at least 08F tax-update release
#endif
 
#if {SITE_ID} = 'DOW1'
  #define DWPAY2
#endif
 
#if {SITE_ID} ='WFG1'
 #ifdef ADP_TAX_AMEND
  #define ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST
  #define ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST_START_DT  -02-01   !'2014-02-01'
 #endif
#endif
 
#if {SITE_ID} ='KPG1'
 #ifdef ADP_TAX_AMEND
  #define ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST
 #endif
#endif
 
#if {SITE_ID} ='CEI1'
 #ifdef ADP_TAX_AMEND
  #define ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST
 #endif
#endif
 
#if {SITE_ID} ='CHB1'
  #Include 'fpsetup.sqc'    !For CHUBB - Modified to export the DAT file into UNIX BOX Specified Location
                            !To Set File Path and Get Parameter Value - 24th Jan 2007
  #define tool_name 'ADPQ'
#endif
 
 #if {SITE_ID} = 'STV1'
  #define CUSTOM_RUN_CONTROL_NAME
 #endif
 
 #if {SITE_ID} = 'INT1'
  #define CUSTOM_RUN_CONTROL_NAME
 #endif
 
 #if {SITE_ID} = 'KEY1'
  #define COMMISSION_HOURS_FOR_ALL_STATES
 #endif
 
 #ifndef FORM1042_Taxcode
   #define FORM1042_Taxcode    FORM1042    !1042 FIT Taxcode
 #endif
 
 #ifndef FORM945P_Taxcode
   #define FORM945P_Taxcode    FORM945P    !945P FIT Taxcode
 #endif
 
 #ifndef FORM943_Taxcode
   #define FORM943_Taxcode     FORM943     !943  Taxcode
 #endif
 
 !Standard options
 !-----------------
 
 #define CA_WAGE_PLAN_CD_IN_ALL_CA             !10/31/07
 #define CA_WAGE_PLAN_CD_IN_CAH_CHECK_SUI      !11/02/07
 
#if {SITE_ID} <> 'AXA1'
 #if {SITE_ID} <> 'CZB1'
   #define AUTO_W2_SELECT                           ! Per Nayana on 5/4/06, always select W-2 data if a Q4 run
 #endif
#endif
 
 #define adjust-tax-balances-for-new-state-locals ! (pulls W-2C data for NEW states)
 #define INCLUDE_NEW_FED_W2C_DATA                 ! Per Nayana 8/14/08
 
 !#define ADJUST_ZERO_LOCALS     ! clears wages for zero YTD withholdings on locals
 !#define ADJUST_ZERO_LOCALS_OPT ! clears wages for zero QTD withholdings on locals (only PA-OPT)
                                 ! need ADJUST_ZERO_LOCALS declared too
 #if {SITE_ID} = 'GE01'
   #define SKIP_ZERO_LOCALS
 #endif
 
 #if {SITE_ID} = 'BLK1'
   #define SKIP_ZERO_LOCALS
 #endif
 
 #if {SITE_ID} = 'DOW1'
   #define VOID_W2s_for_EXPATS
 #endif
 
 #ifndef SKIP_ZERO_LOCALS
   #define PRINT_ZERO_LOCALS
 #endif
 
 #ifndef SKIP_RESIDENT_AUDIT
   #define PRINT_RESIDENT_AUDIT
 #endif
 
#if {SITE_ID} = 'FHL1'
  #define DATABASE_NAME_PSDBOWNER_DBNAME
#endif
 
 ! ---------------------------------------------------
 ! Default Client Parameters  (if needed, change them
 !         in your 'SITE_ID' section which follows)
 ! ---------------------------------------------------
 #define PAYGROUP_FIELD              C.PAYGROUP
 
 #ifndef PeopleSoft_Version
   #define PeopleSoft_Version 8.9
 #endif
 
 #ifndef Worksite_Setup_Filename
  #ifdef FILEPREFIX
    #define Worksite_Setup_Filename       {FILEPREFIX}pbzsetup.dat
  #else
    #define Worksite_Setup_Filename       pbzsetup.dat
  #endif
 #endif
 
 #ifndef Quarterly_extract_specs
   #define Quarterly_extract_specs       2.03      !up thru 9/19/98
 #endif
 
 #ifndef Client_Field_Prefix
   #define Client_Field_Prefix
 #endif
 
 #ifndef Client_Field_Suffix
   #define Client_Field_Suffix
 #endif
 
 #ifndef Client_Table_Prefix
   #define Client_Table_Prefix
 #endif
 
 #ifndef Client_Table_Suffix
   #define Client_Table_Suffix
 #endif
 
 #define DUP_B     t
 #define DUP_UF    f
 #define UF_EE_TAXCODE     $UF
 #define UF_ER_TAXCODE     $UQ
 
 #define DUP_UD    f
 #define UD_EE_TAXCODE     $UD
 #define UD_ER_TAXCODE     $UE
 
 #define DUP_PRD    f               !these three defs added 4/3/00
 #define PRD_EE_TAXCODE     PRD
 #define PRD_ER_TAXCODE     PRE
 
#if {SITE_ID} = 'JCP1'
 #define USE_psatax_balance_index
#endif
 
#if {SITE_ID} = 'HWL1'
 #define USE_psatax_balance_index
#endif
 
 ! PeopleSoft Version 7 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} = '7'
   #define POSTAL                 ZIP
   #define SSN_ID                 A1.SSN
 #endif
 
 ! PeopleSoft Version 7.5 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} = '7.5'
 
   #define DUP_UD                 f
   #define DUP_UF                 f
   #define DUP_PRD                f
 
   #define POSTAL                 POSTAL
   #define SSN_ID                 H.NATIONAL_ID
 
   !#define TIPS_ROLLUP
 
   #include 'usarpt.sqc'
 
 #endif
 
 ! PeopleSoft Version 7.51 Definitions
 ! --------------------------------
 #if {PeopleSoft_Version} >= '7.51'
   #define DUP_UD                 f
   #define DUP_UF                 f
   #define DUP_PRD                f
   #define POSTAL                 POSTAL
   #define SSN_ID                 H.NATIONAL_ID
   #define GETLCLDATA_751         !default due to mod to 7.5 "locality_abbr"
   #include 'usarpt.sqc'
 #endif

 #define ln       LINE_NUM
 #define pg       PAGE_NUM
 #define emp_rec  EMPL_RCD
 
 #include 'adphours.sqc'                     !new code specific to hours and weeks worked
 
 #if {SITE_ID} = 'GND1'
   #define AUTO_WORKSITE_FILENAME
 #endif
 
 #if {SITE_ID} = 'LMD1'
   #define PULL_JOB_THROUGH_QE_ONLY
 #endif
 
 #if {SITE_ID} = 'BTS1'
  #define DUP_UF            t
  #define UF_EE_TAXCODE     $UF
  #define UF_ER_TAXCODE     $UQ
  #define DUP_UD            t
  #define UD_EE_TAXCODE     $UD
  #define UD_ER_TAXCODE     $UE
 #endif
 
!#ifdef ADP_COMPID_EXTRACT_STRIPPED_REPORT
 #ifndef SUBTOTAL_COMPANY
  #ifndef SUBTOTAL_FEIN
   #ifndef SUBTOTAL_ADP_COMPID_EXTRACT
    #define SUBTOTAL_COMPANY
   #endif
  #endif
 #endif
!#endif
 
#ifdef UPDATE_QTD_WITH_W2C
  #ifndef UPDATE_QTD_WITH_W2C_NEGATIVE
   #define UPDATE_QTD_WITH_W2C_NEGATIVE    NEGATIVE
  #endif
#endif
 
#ifndef INCLUDE_ON_AND_OFF_CYCLE_FOR_COUNTS
 #ifndef INCLUDE_MATCHING_CHECK_DATES_FOR_COUNTS
   #define INCLUDE_ON_CYCLE_FOR_COUNTS_ONLY
 #endif
#endif
 
#ifdef LOCAL_RECIPROCITY
  #if {SITE_ID} = 'PMT1'
    #include 'z_adprecip.sqc'  !procedure Init-ADPCompid
  #else
    #include 'adprecip.sqc'  !procedure Init-ADPCompid
  #endif
#endif
 
 #ifdef GENERATE_STATE_FUTA
  #include 'adpstfut.sqc'
 #endif
 
#ifndef PRINT_HIGHLIGHT
  #define PRINT_HIGHLIGHT
#endif
 
#ifndef WC_RATE_FACTOR
   #define WC_RATE_FACTOR 1000000     !default multiplier for Wyoming rate (f entered as a RATE not a %
#endif
 
#if {SITE_ID} = 'SRC1'
  #include 'tfqinit2.sqc'
#endif
 
!------------------ End of Definitions ---------------------
!********************************************************************************
Begin-Setup
End-Setup   ! end of setup
 
Begin-Report
 
  do Init-DateTime
  do Define-Standard-Vars      !added 4/13/06
 
 #if {SITE_ID} = 'USB1'
  #debugd show 'Calling MVP-Track-SQR-Start...'
  do MVP-Track-SQR-Start
 #endif
 
  show ''
  show '------------------------>  ADP Employment Tax:    begin-report {QUARTERLY_REPORT_ID}  Site ID = {Site_ID} Program_Version: {Program_Version} Peoplesoft Version: {PeopleSoft_Version} '
  show ''
  let #site_id_len = length('{SITE_ID}')
  if #site_id_len <> 4
     #debugd show ''
     #debugd show ' ********************** Warning: invalid SITE_ID length.  It must be 4 chacters long. (defined in probiz.sqc).'
     #debugd show ''
     stop
  end-if
 
  #if {SITE_ID} = 'PSS1'
    let $Prcs_Process_Instance = 'MVS'
    let $Prcs_OprID            = 'BATCH2'   ! This is the OPRID in your TF_PBZ_QTR
    let $Prcs_Run_Cntl_ID      = 'PBZQTR'    ! This is the RUN_CNTL_ID in your TF_PBZ_QTR
  #endif
 
  #if {SITE_ID} = 'DBS1'
    DO NEW-REPORT-NAME('{QUARTERLY_REPORT_ID}', '', 'I', $ASOFTODAY)
  #endif
 
  do Init-Number
 
  #if {SITE_ID} = 'JCP1'
   #IFDEF PROCESS_SCHEDULER_ENABLED
    do StdAPI-Init
   #ENDIF
   goto done_api
  #endif
 
  #if {SITE_ID} = 'WHS1'
    do WEY-Transmit-File
  #endif
 
  #if {SITE_ID} <> 'SOL1'
    #if {SITE_ID} <> 'WFG1'
     #if {SITE_ID} <> 'VRZ1'
      do StdAPI-Init
     #endif
    #endif
  #endif
 
done_api:
 
  #if {SITE_ID} = 'AXA1'
    do Init_Printer
  #endif
 
  #if {SITE_ID} = 'CMB2'
    if upper($username) = 'PSBATCH'
    or upper($username) = 'PSBATCHEPV'
    
      let $Prcs_OprID            = 'psbatch'
      let $Prcs_Run_Cntl_ID      = 'BATCH_ADP_QTR'
      let $Prcs_Process_Instance = 'CMB2'
      #debugd show 'Process Instance: ' $Prcs_Process_Instance
    end-if
  #endif
  
  show '**** ADP Employment Tax: Quarterly Tax Interface ****'
  show ' '
  show 'Program:  ' $sqr-program
  show 'Database: ' $sqr-database
  show 'Platform: ' $sqr-platform
  show 'Username: ' $username
  show 'Oprid:    ' $Prcs_OprID
  show 'RunCtlID: ' $Prcs_Run_Cntl_ID
 
  do Format-Number(#prcs_process_instance, $PgmProcessInstance, '0999')
  #debugd show 'Instance: ' $PgmProcessInstance
 
  do Get-Current-DateTime
  show 'Current Date      :' $Asoftoday
  show 'Report Started at :' $Asofnow
  show 'System DateTime   :' $SysDateTime
 
  #ifdef JAT_TESTING
    #debugd show 'JAT_TESTING'
  #endif
 
  #ifdef ADPTCFG_DEFINED
    #debugd show 'Next Gen GUI, Configuration Information: {ADPTCFG_DEFINED}'
  #endif
 
  move $AsofNow to $ReportStartTime
 
  #ifdef enable_performance_monitor
 
   #define MAX_timing_debug_entries 1000
   create-array name=debug_entry size={MAX_timing_debug_entries} -
         field=PROC1:char                  -
         field=TABLE1:char                 -
         field=COUNT1:number               -
         field=RUNNING1:number
 
  #endif
 
  do Init-Report
 
  #if {SITE_ID} = 'CSX1'
    #ifdef UNIX
      do Set-Prefix-From-Env
    #endif
  #endif
 
  #if {SITE_ID} = 'XXX'
    #debugd show 'Please set Client ID (on line #9), then re-run.'
    stop
  #endif
 
  #if {PeopleSoft_Version} < '6'
    #debugd show 'Peoplesoft Version {PeopleSoft_Version} not supported.'
    stop
  #endif
 
  #if {PeopleSoft_Version} > '9.9'
    #debugd show 'Peoplesoft Version {PeopleSoft_Version} not supported (yet).'
    #if {SITE_ID} = 'SRC1'
        Move 8 to #Return-Status
    #endif
    #if {SITE_ID} = 'TCN1'
        Move 5 to #Return-Status
    #endif
    stop
  #endif
 
  #ifdef SUBTOTAL_COMPANY
    #debugd show 'SUBTOTAL_COMPANY'
  #endif
  #ifdef MULTIPLE_SITES
    #debugd show 'MULTIPLE_SITES enabled, must have the SITE_ID in the run control'
  #endif
  #ifdef DECOUPLE_HOURS_WEEKS
    #debugd show 'Decoupling hours and weeks'
  #endif
  #ifdef AUTO_W2_SELECT
    #debugd show 'AUTO_W2_SELECT enabled (Q4 will always pull W-2 data)'
  #else
    #debugd show 'AUTO_W2_SELECT disabled (Q4 will not auto-pull W-2 data)'
  #endif
  #ifdef ADP_TAX_AMEND
     #ifdef Process_1099s
        #debugd show 'Warning: ADP_TAX_AMEND Run.. W-2C processing will not include 1099 data'
     #endif
  #endif
  #ifndef ADP_TAX_AMEND
    #ifdef Process_1099s_only
     #debugd show 'Processing 1099s only (CO1.TAX_REPORT_TYPE = R)'
     #define JOIN_COMPANY_TBL
    #endif
  #endif
  #ifdef Process_w2s_only
    #debugd show 'Processing W-2s only  (CO1.TAX_REPORT_TYPE <> R)'
    #define JOIN_COMPANY_TBL
  #endif
  let $Program_Version      = '{Program_Version}'
  let $Release_Version      = '{PBZQTR_release}'
  let $PeopleSoft_Version   = '{PeopleSoft_Version}'
  let $Client_Setup_Version = '{Client_Setup_Version}'
  show 'Client ID           = {CLIENT_ID}                           Note: Configuration Date/Client_Setup_Version: ' $Client_Setup_Version
  show 'Program Version     = ' $Program_Version
  show 'PeopleSoft Version  = ' $PeopleSoft_Version
 
  #ifdef SUBTOTAL_FEIN
    show 'SUBTOTAL_FEIN enabled'
  #else
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
     show 'SUBTOTAL_ADP_COMPID_EXTRACT enabled'
   #else
      show 'Normal Rollup (no FEIN or COMPID).'
   #endif
  #endif
 
  #ifdef ADP_TAX_AMEND
    show 'ADP_TAX_AMEND (W-2C run), ADPAMEND.SQR'
  #endif
 
  #ifdef WAREHOUSE_YEAR
    #debugd show 'WAREHOUSE_YEAR      = {WAREHOUSE_YEAR}'
  #endif
  #ifdef WAREHOUSE_SUFFIX
    #debugd show 'WAREHOUSE_SUFFIX    = {WAREHOUSE_SUFFIX}'
  #endif
 
  #if {SITE_ID} = 'BKR1'
    #define USE_UI_RPT_CD_LOCATION_LOOKUP
  #endif
 
  #ifdef TIPS_ROLLUP
    #debugd show 'Tips Rollup enabled.'
  #endif
 
  #ifdef USE_psatax_balance_index
    #debugd show 'USE_psatax_balance_index enabled.'
  #endif
 
  #ifdef USE_parallel_tax_balance_access
    #debugd show 'USE_parallel_tax_balance_access enabled (8 parallel processes).'
  #endif
 
  #ifdef CALC_OREGON_HOURS
    #debugd show 'CALC_OREGON_HOURS enabled.'
  #endif
 
  #ifdef ADJUST_ZERO_LOCALS                     ! clears wages for zero YTD withholdings on ALL locals
    #debugd show 'ADJUST_ZERO_LOCALS enabled.'
    #ifdef ADJUST_ZERO_LOCALS_OPT               ! clears wages for zero YTD PA-OPT withholdings
      #debugd show 'ADJUST_ZERO_LOCALS_OPT enabled (only OPT records with zero QTD taxes will be cleared).'
    #endif
  #endif
 
  #ifdef ZERO_WAGES_for_ZERO_RATE_LOCALS
    #debugd show 'ZERO_WAGES_for_ZERO_RATE_LOCALS enabled'
  #endif
 
  #ifdef PRINT_ZERO_LOCALS
    #debugd show 'PRINT_ZERO_LOCALS enabled.'
  #endif
 
  #ifdef BYPASS_QUARTERLY_TAXES
    #debugd show 'BYPASS_QUARTERLY_TAXES enabled.'
    #ifdef BYPASS_ZERO_LOCALS_QUARTERLY
     #debugd show 'BYPASS_ZERO_LOCALS_QUARTERLY enabled'
    #endif
  #endif
  do Init-taxes-bypassed
 
  #ifdef debug_kjda
    #debugd show 'Debugging KJDA enabled.'
  #endif
 
  #ifdef INCLUDE_ON_CYCLE_FOR_COUNTS_ONLY
    #debugd show 'INCLUDE_ON_CYCLE_FOR_COUNTS_ONLY enabled'
  #endif
 
  #ifdef INCLUDE_ON_AND_OFF_CYCLE_FOR_COUNTS
    #debugd show 'INCLUDE_ON_AND_OFF_CYCLE_FOR_COUNTS enabled'
  #endif
 
  #ifdef INCLUDE_MATCHING_CHECK_DATES_FOR_COUNTS
    #debugd show 'INCLUDE_MATCHING_CHECK_DATES_FOR_COUNTS enabled'
  #endif
 
  #ifdef VT_HEALTH_INSURANCE_INDICATOR
    #debugd show 'VT_HEALTH_INSURANCE_INDICATOR enabled'
  #endif
 
  #ifdef VT_HEALTH_DEDUCTION_BAL_CRITERIA
    #debugd show 'VT_HEALTH_DEDUCTION_BAL_CRITERIA: {VT_HEALTH_DEDUCTION_BAL_CRITERIA}'
  #endif
 
  #ifdef WORKERS_COMP_ENABLE_TABLE
   #debugd show 'WORKERS_COMP_ENABLE_TABLE enabled'
   #ifdef WORKERS_COMP_ENABLE_TABLE_WA
    #debugd show 'WORKERS_COMP_ENABLE_TABLE_WA enabled'
   #endif
   #ifdef WORKERS_COMP_ENABLE_TABLE_WY
    #debugd show 'WORKERS_COMP_ENABLE_TABLE_WY enabled'
   #endif
  #endif
 
  #ifdef US_SOC_CD_for_RATE
   #debugd show 'US_SOC_CD_for_RATE enabled'
  #endif
  #ifdef WC_RATE_FACTOR
   #debugd show 'WC_RATE_FACTOR = {WC_RATE_FACTOR}'
  #endif
  #ifdef SELECT_WITH_UR
    #debugd show 'SELECT_WITH_UR enabled'
  #endif
  #ifdef USE_EMPLOYER_ID_EXT_FOR_MN_MI
    #debugd show 'USE_EMPLOYER_ID_EXT_FOR_MN_MI'
  #endif
  #ifndef ADP_TAX_AMEND
    #ifdef CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS
      #debugd show 'CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS...'
    #endif
  #endif
  #ifdef PRIMARY_JOBS_ONLY
    #debugd show 'PRIMARY_JOBS_ONLY...'
  #endif
  #ifdef INITIAL_Q3_FUSION_QUARTERLY_RUN
    #debugd show 'INITIAL_Q3_FUSION_QUARTERLY_RUN'
  #endif
  #if {SITE_ID} = 'PFZ1'
    #if {USE_GBL_TAX_BAL} = 'Y'
      #debugd show 'Pulling Tax Balances for Company GBL (200 WL-FOR) from Table: PS_Z_GBL_TAX_BAL'
    #else
      #debugd show 'Pulling Tax Balances for Company GBL (200 WL-FOR) from Table: PS_TAX_BALANCE'
    #endif
  #endif
  
  #ifdef debug_sql_trace_oracle
    do set-trace
  #endif
 
  #if {SITE_ID} = 'CHS1'
     do init-CT-location-CHS1 !probiz.sqc
  #endif
 
 #ifdef GENERAL_SUI_SPLIT_STATE
      do init-sui-split-location   !adpuispl.sqc
 #endif
 
  do Get-Calendar-Year-Id
  do Get-Current-DateTime
  do Report
  do Get-Current-DateTime
 
  show ' '
  show 'Report Started: ' $ReportStartTime
  show 'Report Ended:   ' $AsOfNow
  show 'Employee Count  ' #employee_total edit 999,999 ', Total Tax Qtd = ' #Hash_Total_Tax_Qtd edit 999,999,999,999.99 ', Year ' $RptYear ', Qtr ' $RptQtr
  show 'Total Tax Qtd   ' #Hash_Total_Tax_Qtd
  show 'Total Tax Ytd   ' #Hash_Total_Tax_Ytd
  show 'Write W-2 recs  ' $adp_w2_records
  show 'Program Version {Program_Version}'
  show 'Extract   -->   ' $Filename
 
  print 'Report Started: ' (+2,1)
  print $ReportStartTime   ()
  print 'Report Ended:   ' (+1,1)
  print $AsOfNow           ()
  print 'Employee Count  ' (+1,1)
  print #employee_total    () edit 9,999,999
  print '   (Count of associates with Tax Balance records)'     ()
 
!**************************Freddie Mac Customizationa !kmr*********************
! Freddie Mac Customization for backup and transfer files..Manohar.k..10/04/2007.!!!!
     #if {SITE_ID} = 'FHL1'
         let $quarterly_sqrprogram= 'Y'
         if $TTS_Naming = 'PROD'
                  let $adpfileprefix =  'p.fhl1.tax.'
         else
                  let $adpfileprefix =  'c.fhl1.tax.test.'
         end-if
       do Create-Backup  !kmr
       do Invoke-GCS-FileTransfer  !kmr
     #endif
 
Exit-Report:
 
   #ifdef ADPCUSNM_QUARTERLY_CLOSE
      do custom-quarterly-close  !in adpcusnm.sqc
   #endif
 
     #if {SITE_ID} = 'NXT1'
       #debugd show 'Cleanup-report: NXT1 output_directory = ' $output_directory ', filename_only = ' $filename_only ', folder = ' $folder
       do Send-Output-File ($FileName_only)
       let $new_filename = 'pbzqtr.dat'
       let $copy_command = 'cp ' || $folder || $filename_only || ' ' || $output_directory || $new_filename
       #debugd show 'Cleanup-report: NXT1: cleaning up report, command = ' $copy_command
       call system using $copy_command #status
     #endif
 
   #if {SITE_ID} = 'ACL1'
 
       let $ftp_filename = $Filename_prefix || $filename_extension
       let $arch_folder = $folder || 'Archive\'
       let $arch_folder_file = $folder || 'Archive\' || $ftp_filename
       #debugd show ' '
       #debugd show 'ACL1: Archival and FTP:             Full Extract filename  : ' $Filename
       #debugd show '                                          Filename_prefix  : ' $Filename_prefix
       #debugd show '                                       filename_extension  : ' $filename_extension
       #debugd show '                                          Original Folder  : ' $Folder
       #debugd show '                                          Archival Folder  : ' $arch_Folder
       #debugd show '                                             FTP_Filename  : ' $ftp_filename
 
       do archive-file($filename, $arch_folder_file, $archive_success)
       if $archive_success = 'Y'
         do FTP-file($prcs_dbname, 'PBZQTR', $arch_Folder, $ftp_filename)
         #debugd show 'ACL1: Archive Success: File FTPd. Check for file ' $filename
         #debugd show '$arch_Folder = ' $arch_Folder
       else
         #debugd show 'ACL1: Archive Failure: File Not FTPd. Check for file ' $filename
         STOP
       end-if
 
     #endif
 
 #if {SITE_ID} = 'BLB1'
  !********************************************
  !** V000**  BLB1 Customization
  !           Unix chmod for file permissions
  !********************************************
  #debugd show '$Filename is  =' $Filename
  let $chmod1 = 'chmod 777 ' ||  $Filename
  !*** execute Unix commands and ! showstatus
 
  call system using $chmod1 #unix_status
  #debug #debugd show 'Change Security Status =' #unix_status
  if #unix_status != 0
     #debugd show '  **** WARNING FILE ERROR **** File Permissions NOT Changed for $chmod1...program STOPPED'
  ELSE
     #debugd show '     Success Changing File Permissions (chmod1)  '
  end-if
  !********************************************
  !** V000**  BLB1 customization
  !*********************************************
 #endif
 
! CGI1 Specific FTP Code
! James Fornshell, 07/05/2006
 
  #if {SITE_ID} = 'CGI1'
 
     Let $Dest_Unix=$Dest_Fol || $CGFilename
     Let $Source_Unix=$Folder || $CGFilename
 
     LET $Unix_CD = 'mv ' || $Source_Unix || ' ' || $Dest_Unix
 
     CALL SYSTEM USING $Unix_CD #status
 
     #debugd show 'Destination Path '  $Dest_Unix
     #debugd show 'Source Path '  $Source_Unix
 
     if #status = 0
       #debugd show 'File Move to Out Folder- Unix Command Sucess'
     else
       #debugd show 'File Move to Out Folder - Unix Command Fail'
     end-if
 
  #endif
 
! End CGI1 Customization
 
 #if {SITE_ID} = 'ICI'
      do get_ici_prcs_directory     !getprcsd.sqc
 
      let $CP_SHELL = 'cp ' ||  $filename  ||' '|| $ici_prcs_directory
      let #CP_UNIX_STATUS = 0
      #debugd show 'Unix script executing: ' $CP_SHELL
      CALL SYSTEM USING $CP_SHELL #CP_UNIX_STATUS
 
      if #CP_UNIX_STATUS <> 0
       let $Error_Message = 'Error copy file to report repository, UNIX SHELL STATUS: '|| rtrim(ltrim(edit(#CP_UNIX_STATUS,'9999999.999999'),' '),'.000000')
       ! show$Error_Message
      end-if
 #endif
 
    #if {SITE_ID} <> 'SOL1'
      #if {SITE_ID} <> 'VRZ1'
       #if {SITE_ID} <> 'WFG1'
         #debugd show 'Calling stdapi-term'
         do Stdapi-Term
       #endif
      #endif
    #endif
 
 #if {SITE_ID} = 'USB1'
    #debugd show 'Calling MVP-Track-SQR-End...'
    do MVP-Track-SQR-End
 #endif
 
end-report
 
begin-procedure set-trace
 
#ifdef ORACLE
begin-sql
    alter session set sql_trace = true
end-sql
  #debugd show 'alter session set sql_trace = true command executed under Oracle.'
#else
  #debugd show 'alter session set sql_trace = true command only valid under Oracle.  ORACLE definition not defined in setenv.sqc'
#endif
 
end-procedure
 
begin-heading 8
 
  #if {SITE_ID} = 'WFG1'
    #include 'stdh01nw.sqc'      ! Wells MC06462
  #endif
 
  #ifdef SUBTOTAL_FEIN
    #ifndef SUBTOTAL_COMPANY
      #if {SITE_ID} = 'PFZ1'
       #Include 'stdhdg01_m.sqc'
      #else
       #if {SITE_ID} = 'KEN1'
         #Include 'cvstdhdg01.sqc'! 9/6/10-COVIDIEN CHANGE RELATED TO INCOMPATIBLE/CUSTOMIZED STDHDG01.SQC
       #else
         #Include 'stdhdg01.sqc'
       #endif
      #endif
      print 'FEDERAL ID: '      (3,1)
      print $Current_FEIN       (0,+1)
      goto end_header_label
    #endif
  #endif
 
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
    #ifndef SUBTOTAL_COMPANY
      #if {SITE_ID} = 'PFZ1'
       #Include 'stdhdg01_m.sqc'
      #else
       #if {SITE_ID} = 'KEN1'
         #Include 'cvstdhdg01.sqc'! 9/6/10-COVIDIEN CHANGE RELATED TO INCOMPATIBLE/CUSTOMIZED STDHDG01.SQC
       #else
         #Include 'stdhdg01.sqc'
       #endif
      #endif
 
      #if {SITE_ID} = 'CZB1'
        print 'Rollup Company: '  (3,1)
      #else
        print 'ADP CompID: '      (3,1)
      #endif
 
      print $Current_ADP_Compid (0,+1)
      goto end_header_label
    #endif
  #endif
 
  #if {SITE_ID} = 'PFZ1'
   #Include 'stdhdg02_m1.sqc'
  #else
   #if {SITE_ID} = 'KEN1'
     #Include 'cvstdhdg02.sqc'! 9/6/10-COVIDIEN CHANGE RELATED TO INCOMPATIBLE/CUSTOMIZED STDHDG01.SQC
   #else
     #Include 'stdhdg02.sqc'
   #endif
  #endif
 
end_header_label:
 
  evaluate #header_type
  when = 0
    print '<----------- Quarter-To-Date ------------>'   (+2,87)          ! changed 12/13/00
    print '<-------------- Year-To-Date -------------->' (0,130)
    print ' State          SWT/EIN   TAX_BAL.Locality'   (+1,1)
    print 'Taxcode              Tax Class'               (0,47)
    print 'Taxable         Gross         Taxes'          (0,92)
    print 'Taxable          Gross          Taxes'        (0,136)
 
  when = 1  !Worksite reporting
      print 'Company        Worksite       UI RptCode     Found        Employee Count' (+2,1)
      print '-------        ------         ----------     -----        --------------' (+1,1)
 
  when = 2
       print 'Summary...' (+2,1)
 
  when = 3   !Missing Personal Data
      print 'Company        Emplid              Message' (+2,1)
      print '-------        ------              -------' (+1,1)
 
  when = 4   !SUI Totals
      print '*** Note, Negative Wage amounts are NOT included in the totals below' (+2,1)
      print 'Company  State     Worksite    Rate                 Gross-Wages      Taxable-Wages      Taxes-Withheld   ' (+2,1)
      print 'Month1   Month2   Month3       Qtd-Hours    Weeks  In-Qtr  Description' ()
      print '-------  -----     --------    ----                 -----------      -------------      --------------   ' (+1,1)
      print '------   ------   ------       ---------    -----  ------  -----------' ()
 
  when = 5   !Local Totals
      print '*** Note, PA OPT taxes have no wages associated with the taxes...    ' (+2,1)
      print 'State     Locality  Res                    Gross-Wages      Taxable-Wages      Taxes-Withheld           Rate      Description' (+2,1)
      print '-----     --------  ---                    -----------      -------------      --------------           ----      -----------' (+1,1)
 
  when = 6   !Zero locals
      print 'Company        Emplid              State     Locality  Res               QTD-Taxable        QTD-Withheld     YTD-Taxable        YTD-Withheld     ' (+2,1)
      print '-------        ------              -------   --------  ---               -----------        ------------     -----------        ------------     ' (+1,1)
 
  when = 7   !Taxes Bypassed
       print 'Fed-Ein        Company             QTD-Withheld       QTD-Taxable      QTD-Subject      YTD-Withheld       YTD-Taxable      YTD-Subject      Taxcode'  (+2,1)
       print '-------        -------             ------------       -----------      -----------      ------------       -----------      -----------      -------'  (+1,1)
 
  when = 8   !Audit Resident changes
      print 'Company        Emplid              State     Locality  ResStatus' (+2,1)
      print '-------        ------              -------   --------  ---------' (+1,1)
!      print 'Company        Emplid              State     Locality  Res    Effective-Date' (+2,1)
!      print '-------        ------              -------   --------  ---    -----------   ' (+1,1)
 
  when = 9   !lLocal reciprocity
 
       !Oct 11, 2007 changed (see adprecip.sqc)
       !---------------------------------------
 
       print 'Company Emplid       State Locality     TAX_BALANCE           PAY_TAX_(RES)   PAY_TAX_(NonRES)     Delta         ' (+2,1)
       print '------- ------       ----- --------     -----------------     -------------   ----------------     --------------' (+1,1)
 
  when = 13   !additional audits
      print 'Company Emplid           Message                       Taxcode             QTD-Withheld       QTD-Taxable             YTD-Withheld       YTD-Taxable' (+2,1)
      print '------- ------           -------                       -------             ------------       -----------             ------------       -----------' (+1,1)
 
  when = 14   !W-2 Voids
      print 'Company Emplid           Message                       Taxcode             QTD-Withheld       QTD-Taxable             YTD-Withheld       YTD-Taxable' (+2,1)
      print '------- ------           -------                       -------             ------------       -----------             ------------       -----------' (+1,1)
 
  when = 15   !multistate audits
      print 'Company Emplid           Taxcode         Worksite        QTD-Withheld        QTD-Taxable         YTD-Withheld        YTD-Taxable   Message' (+2,1)
      print '------- ------           -------         --------        ------------        -----------         ------------        -----------   --------------------------------------------' (+1,1)
 
  when = 16   !MWR audits
      print 'Company     Emplid        Worksite                  State    UI_Location    Address                   City                    Descr                     Warning' (+2,1)
      print '-------     ------        --------                  -----    -----------    -------                   ----                    -----                     -------' (+1,1)
 
  when = 20   !debugging for performance monitor
      print 'Procedure                                         Table                         Count     Running-Time (secs)' (+2,1)
      print '---------                                         -----                         -----     -------------------' (+1,1)
 
  when = 25   !Tax recap - CHS1
      print '               Company        TaxLocation                Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
      print '               -------        -----------                -----         -------------        -----------'  (+1,1)
 
#ifdef GENERAL_SUI_SPLIT_STATE
    when = 26   !Tax recap -
       print '               Company        Location                   Taxes         Taxable-Wages        Gross-Wages'  (+2,1)
       print '               -------        --------                   -----         -------------        -----------'  (+1,1)
#endif
 
  when = 52   !New Hire act
       print 'Company  Emplid            New Hire Associate Name                 Exempt_Taxable_QTD  Exempt_Taxable_YTD  HireEffdt      HireType       (Derived-Bal QTD)     (Derived-Bal YTD)' (+2,1)
  when = 53   !Nevada
       print 'Company  Emplid            Nevada Associate Name                   Taxable_Wages_QTD   ER_HealthContrib_QTD   Taxable_Wages_YTD   ER_HealthContrib_YTD' (+2,1)
  when = 54   !New Mexico
       print 'Company  Emplid            New Mexico Associate Name                            W/C Flag' (+2,1)
  when = 60   !PA Locals, heading to include PSD codes, 5/23/2011
      print 'Company  Emplid      ResSt ResCounty     Class ResLocal   ResPSD    Res  ResRt    NonResRt TaxesWithheld       TaxableWages   WorkLoc    WorkPSD   WorkSt WorkCounty    WorkDescr' (+2,1)
  when = 70   !state futa
      print 'COMPANY   STATE                           FUTA_QTD_TAXABLE    FUTA_YTD_TAXABLE      (State Futa Breakdown) Class: ' (+2,1)
      print $STATE_FUTA_TAX_CLASS ()
  #ifdef BOX_01_03_05_SUMMARY
   when = 75   !Box 01/03/05 warnings
       print 'Company  Emplid            Box   Description' (+2,1)
  #endif
 
#ifdef PA_PULL_PO_BOX_ADDRESSES
  when = 80  !PA_PULL_PO_BOX_ADDRESSES
      print 'COUNT     EMPLID          W-2-PULL  ORIG-ADDR1                     NEW-ADDR1 ({PA_PULL_PO_BOX_ADDRESSES})' (+2,1)
      print 'NAME' (,99)
#endif
 
  when-other
      break
  end-evaluate
 
end-heading

begin-procedure Input-Prompts
 
 let $CompanySelection = 'AND C.COMPANY > '' '''  !added this for a default here 20141208

 IF $PRCS_PROCESS_INSTANCE = ''
 
  #if {SITE_ID} ='FTO1'
     do Open-Parm-File
     do Read-Next-Parm
     !populate:  $RptYear, $RptQtr, $RptDetail, $AllCompanies, $SelectCompany,
 
     let $RptQTR        = substr($Parm_record,1,1)  !
     let $RptYear       = substr($Parm_record,3,4)
     let $RptDetail     = substr($Parm_record,8,1)
     let $AllCompanies  = substr($Parm_record,10,1)
     let $SelectCompany = substr($Parm_record,12,3)
     let $Operator_selected_W2s = substr($Parm_record,16,1)  !Y/N added 1/30/04 for ADP
     do Close-Parm-File
     #debugd show 'Frito Lay parms: '   $RptQTR ', ' $RptYear ', ' $RptDetail ', '$AllCompanies ', ' $SelectCompany ', ' $Operator_selected_W2s
     move $RptYear to #RptYear
     move $RptQtr to #RptQtr
     goto done_inputs
 #endif
 
  input $RptYear maxlen=4      'Enter Year  (2007,2008,2009...) '
  move $RptYear to #RptYear
 
  input $RptQtr maxlen=1       'Enter Quarter (1,2,3 or 4) '
  move $RptQtr to #RptQtr
 
  #ifdef MONTHLY_BALANCING_ENABLED
    input $RptPeriod maxlen=2       'Enter Month (1..12) '
    move $RptPeriod to #RptPeriod
 
    if #RptPeriod <> 0
 
     evaluate $RptQtr
     when = '1'
       let #validm1 = 1
       let #validm3 = 3
       break
     when = '2'
       let #validm1 = 4
       let #validm3 = 6
       break
     when = '3'
       let #validm1 = 7
       let #validm3 = 9
       break
     when = '4'
       let #validm1 = 10
       let #validm3 = 12
       break
     when-other
       break
     end-evaluate
 
     if #RptPeriod < #validm1 or #RptPeriod > #validm3
       #debugd show 'ERROR: Invalid Month (' $RptPeriod ') Aborting Program.'
       #ifdef MVS
        Move 5 to #Return-Status
       #endif
       stop
     end-if
 
     #debugd show '$RptPeriod = ' $RptPeriod
 
    end-if
 
  #endif
 
  input $RptDetail maxlen=1    'Print Employee Details?  (Y/N) '
  uppercase $RptDetail
 
  input $AllCompanies maxlen=1 'Select ALL Companies? (Y/N) '
  uppercase $AllCompanies
 
  input $Operator_selected_W2s maxlen=1 'Select W-2 records?   (Y/N) '
  uppercase $Operator_selected_W2s
 
  if $AllCompanies = 'N'
 
     #if {SITE_ID} = 'SRC1'
        do Prompt-Parameters
        do Prompt-Pattern
        #ifdef AUTO_W2_SELECT
          if $RptQtr = '4'
             let $Operator_selected_W2s = 'Y'
          end-if
        #endif
     #else
        input $SelectCompany maxlen=4 'Company '
        uppercase $SelectCompany
     #endif
 
!     #if {SITE_ID} = 'JCP1'
!       if rtrim($SelectCompany,' ') = ''
!          input $ExcludeCompany maxlen=4 'Company '
!          uppercase $ExcludeCompany
!       end-if
!     #endif
 
  end-if
 
   let $SelectEmplidSelection_MC  = 'AND PSPC1.EMPLID <> '' '''
   let $SelectEmplidSelection_3P  = 'AND BB1.EMPLID <> '' '''
   let $SelectEmplidSelection     = 'AND C.EMPLID <> '' '''
   let $SelectEmplidSelection_YE  = 'AND YE_DATA.EMPLID <> '' '''
   let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID <> '' '''
   let $SelectEmplidSelection_WF  = 'AND WF.EMPLID <> '' '''
 
   #ifdef MULTIPLE_SITES
     input $Site_ID_RC maxlen=4 'Enter SITE_ID (4 char) for Quarterly Extraction (eg. SSS1) '
   #endif
 
   #ifdef TEST_EMPLID_IN_RUN_CONTROL
    input $SelectEmplid  maxlen=15 'Test Emplid '
    if $SelectEmplid <> ''
       let $SelectEmplidSelection     = 'AND C.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_YE  = 'AND YE_DATA.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_MC  = 'AND PSPC1.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_3P  = 'AND BB1.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_WF  = 'AND WF.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
    else
       let $SelectEmplidSelection     = 'AND C.EMPLID <> '' '''
       let $SelectEmplidSelection_YE  = 'AND YE_DATA.EMPLID <> '' '''
       let $SelectEmplidSelection_MC  = 'AND PSPC1.EMPLID <> '' '''
       let $SelectEmplidSelection_3P  = 'AND BB1.EMPLID <> '' '''
       let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID <> '' '''
       let $SelectEmplidSelection_WF  = 'AND WF.EMPLID <> '' '''
    end-if
    #debugd show ' TEST Emplid from Run control string = ' $SelectEmplidSelection
   #endif
 
   #ifdef Q3_2010_RUN_CONTROL
    input $Report_only_flag maxlen=1 'Report Only? '
    input $ADP_QTR_MODE  maxlen=1 'Normal(N), Amend(A)? '
   #endif
 
  else
 
    let $CompanySelection = 'AND C.COMPANY > '' '''  !added this for a default here 20141208
    ! Use the run control table to get the parameters
    ! -----------------------------------------------
    DO Select-Parameters-For-Scheduler
    move $RptYear to #RptYear
    move $RptQtr  to #RptQtr
 
  end-if
 
  let $RptYear2 = substr($RptYear,3,2)

done_inputs:

 
 #ifdef MULTIPLE_SITES
  let $Site_ID = $Site_ID_RC
  do Get-Installation
 #endif
 
 #ifndef MULTI_COMPANY_RC
 
   if $AllCompanies = 'Y'
     let $CompanySelection = 'AND C.COMPANY > '' '''
   else
 
     if ($SelectCompany = 'ALL') or ($SelectCompany = '')
       let $CompanySelection = 'AND C.COMPANY > '' '''
     else
         #if {SITE_ID} = 'SRC1'
             let $CompanySelection = $TF_Company
         #else
           #ifdef SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY
             let $CompanySelection = 'AND CT.TF_COMPANY = ''' || $SelectCompany || ''''
             show 'SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY: SelectCompany ' $SelectCompany ', CompanySelection ' $CompanySelection
           #else
             let $CompanySelection = 'AND C.COMPANY = ''' || $SelectCompany || ''''
             let $CompanySelection_WF = 'AND WF.COMPANY = ''' || $SelectCompany || ''''
           #endif
         #endif
     end-if
   end-if
 #endif
 
DONE_SELECTIONS:
 
#if {SITE_ID} = 'HEP1'
  if #prcs_process_instance = 0
 
begin-SELECT
TAXRPT.BALANCE_YEAR
TAXRPT.BALANCE_QTR
 
    let #RptYear = &TAXRPT.BALANCE_YEAR
    let #RptQtr  = &TAXRPT.BALANCE_QTR
    move #RptYear to $RptYear xxxx
    move #RptQtr  to $RptQtr  x
 
  FROM PS_TAXRPT_RUNCTL TAXRPT
end-SELECT
   #debugd show 'HEP1 Batch, RptYear = ' $RptYear
   #debugd show 'HEP1 Batch, RptQtr  = ' $RptQtr
  end-if
#endif
 
  show 'Company selection  = ' $CompanySelection
  show 'RptYear = ' $RptYear
  Let $Year_Start_Date_dtu = $RptYear || '-01-01'   !yyyymmdd
 
  let $Calc_Exempt = 'N'
 
  Evaluate $RptQtr
    When = '1'
        let $Qtr_Start_DTU = $RptYear || '-01-01'
        let $Qtr_End_DTU   = $RptYear || '-03-31'
 
        let $12th_Of_1st_Month_DTU  = $RptYear || '-01-12'
        let $12th_Of_2nd_Month_DTU  = $RptYear || '-02-12'
        let $12th_Of_3rd_Month_DTU  = $RptYear || '-03-12'
 
        let $Last_of_1st_Month_DTU  = $RptYear || '-01-31'
        if ((#RptYear % 4) <> 0) and ((#RptYear % 100) <> 0)
         let $Last_Of_2nd_Month_DTU  = $RptYear || '-02-28'
        else
         let $Last_Of_2nd_Month_DTU  = $RptYear || '-02-29'
        end-if
 
        let $Last_Of_3rd_Month_DTU  = $RptYear || '-03-31'
 
        let $Month1             = '01'
        let $Month2             = '02'
        let $Month3             = '03'
        let #Month1             = 1
        let #Month2             = 2
        let #Month3             = 3
 
        let #RptMonth = 3
        let $RptMonth = '03'
 
    When = '2'
       let $Qtr_Start_DTU = $RptYear || '-04-01'
       let $Qtr_End_DTU   = $RptYear || '-06-30'
       let $12th_Of_1st_Month_DTU  = $RptYear || '-04-12'
       let $12th_Of_2nd_Month_DTU  = $RptYear || '-05-12'
       let $12th_Of_3rd_Month_DTU  = $RptYear || '-06-12'
 
        let $Last_of_1st_Month_DTU  = $RptYear || '-04-30'
        let $Last_Of_2nd_Month_DTU  = $RptYear || '-05-31'
        let $Last_Of_3rd_Month_DTU  = $RptYear || '-06-30'
 
        let $Month1             = '04'
        let $Month2             = '05'
        let $Month3             = '06'
        let #Month1             = 4
        let #Month2             = 5
        let #Month3             = 6
        let #RptMonth = 6
        let $RptMonth = '06'
 
    When = '3'
       let $Qtr_Start_DTU = $RptYear || '-07-01'
       let $Qtr_End_DTU   = $RptYear || '-09-30'
       let $12th_Of_1st_Month_DTU  = $RptYear || '-07-12'
       let $12th_Of_2nd_Month_DTU  = $RptYear || '-08-12'
       let $12th_Of_3rd_Month_DTU  = $RptYear || '-09-12'
 
        let $Last_of_1st_Month_DTU  = $RptYear || '-07-31'
        let $Last_Of_2nd_Month_DTU  = $RptYear || '-08-31'
        let $Last_Of_3rd_Month_DTU  = $RptYear || '-09-30'
 
        let $Month1             = '07'
        let $Month2             = '08'
        let $Month3             = '09'
        let #Month1             = 7
        let #Month2             = 8
        let #Month3             = 9
        let #RptMonth = 9
        let $RptMonth = '09'
 
    When = '4'
        let $Qtr_Start_DTU = $RptYear || '-10-01'
        let $Qtr_End_DTU   = $RptYear || '-12-31'
        let $12th_Of_1st_Month_DTU  = $RptYear || '-10-12'
        let $12th_Of_2nd_Month_DTU  = $RptYear || '-11-12'
        let $12th_Of_3rd_Month_DTU  = $RptYear || '-12-12'
 
        let $Last_of_1st_Month_DTU  = $RptYear || '-10-31'
        let $Last_Of_2nd_Month_DTU  = $RptYear || '-11-30'
        let $Last_Of_3rd_Month_DTU  = $RptYear || '-12-31'
 
        let $Month1             = '10'
        let $Month2             = '11'
        let $Month3             = '12'
        let #Month1             = 10
        let #Month2             = 11
        let #Month3             = 12
        let #RptMonth = 12
        let $RptMonth = '12'
 
   when-other
      break
  end-evaluate
 
  Do Convert-From-DTU-Date($Qtr_End_DTU,$AsOfDate)
 
  Do Convert-From-DTU-Date($Qtr_Start_DTU,$Qtr_Start_Native)
  Do Convert-From-DTU-Date($Qtr_End_DTU,$Qtr_End_Native)
  Do Convert-From-DTU-Date($12th_Of_1st_Month_DTU,$12th_Of_1st_Month_Native)
  Do Convert-From-DTU-Date($12th_Of_2nd_Month_DTU,$12th_Of_2nd_Month_Native)
  Do Convert-From-DTU-Date($12th_Of_3rd_Month_DTU,$12th_Of_3rd_Month_Native)
  Do Convert-From-DTU-Date($Last_Of_1st_Month_DTU,$Last_Of_1st_Month_Native)
  Do Convert-From-DTU-Date($Last_Of_2nd_Month_DTU,$Last_Of_2nd_Month_Native)
  Do Convert-From-DTU-Date($Last_Of_3rd_Month_DTU,$Last_Of_3rd_Month_Native)
  Do Convert-From-DTU-Date($Year_Start_Date_DTU,$Year_Start_Date_Native)
 
  #debugd show 'AsOfDate ' $AsOfDate
  #debugd show ' '
 
  #ifdef MULTIPLE_SITES
    show 'Site ID from Run control table: ' $Site_ID_RC
  #endif
 
 
end-procedure
 
#ifdef MULTIPLE_SITES
!***********************************************************************
! PROCEDURE Get-Installation
!***********************************************************************
begin-PROCEDURE Get-Installation
 
begin-SELECT
TFI.{WGPS_SITE_FIELD}
 
#ifdef debugs
  #debugd show 'TFI.{WGPS_SITE_FIELD} = ' &TFI.{WGPS_SITE_FIELD}
#endif
 
FROM  {INSTALLATION_TABLE} TFI
end-SELECT
 
  let $TFI_Site = &TFI.{WGPS_SITE_FIELD}
  if rtrim($Site_ID,' ') = ''          !Process Primary Site by Default if no Alt Site is entered on run control page
     let $Site_ID  = $TFI_Site
  end-if
 
  let $Alt_SITE_Selected = 'N'
  move ' '       to $Alt_Site
  If $TFI_Site <> $Site_ID
    do Get-Alt-Site-ID
  end-if
 
end-PROCEDURE  !Get-Installation
 
!***********************************************************************
! PROCEDURE Get-Alt-Site-ID
!***********************************************************************
begin-PROCEDURE Get-Alt-Site-ID
 
begin-SELECT on-error=SQL-Error
TFAI.{WGPS_SITE_FIELD}
 
   let $Alt_SITE_Selected             = 'Y'
 
   move &TFAI.{WGPS_SITE_FIELD}       to $TFI_Site
   move &TFAI.{WGPS_SITE_FIELD}       to $Alt_Site
 
   #debugd show ' '
   #debugd show 'Running With Alternate Site ID: ' $TFI_Site
   #debugd show ' '
 
FROM  {ALT_SITES_TABLE} TFAI
WHERE TFAI.{WGPS_SITE_FIELD} = $Site_ID
end-SELECT
 
  let $TFI_Site = &TFAI.{WGPS_SITE_FIELD}
 
 if rtrim($TFI_Site, ' ') <> $Site_ID
   #debugd show 'ERROR: Installation Site ID does not match Site ID in run control, aborting'
   #debugd show 'ERROR: Installation Site ID =' $TFI_Site ' Run control Site ID =' $Site_ID
   stop
 end-if
 
end-PROCEDURE  !Get-Alt-Site-ID

#endif   !end MULTIPLE_SITES logic

!----------------------------------------
Begin-Procedure Select-Parameters-For-Scheduler
 
#ifdef Process_Scheduler_enabled
 #ifdef MULTIPLE_SITES
   move 'PS_{Client_Table_Prefix}PBZ_QTR_MS{Client_Table_Suffix}' to $ps_run_control
 #else
   move 'PS_{Client_Table_Prefix}PBZ_QTR{Client_Table_Suffix}' to $ps_run_control
 #endif
  
#if {SITE_ID} = 'STV1'
 move 'PS_STV_RUNTXPBZQTR' to $ps_run_control
#endif
 
#if {SITE_ID} = 'INT1'
 move 'PS_IN_RC_PBZQTR' to $ps_run_control
#endif
 

 show 'Getting Parameters via Run Control Table'
 show 'Operator id: ' $PRCS_OPRID
 show 'Run Cntl id: ' $PRCS_RUN_CNTL_ID
 show 'Client ID:     {SITE_ID}'
 show 'RC Table:    ' $ps_run_control
 
 #ifdef TEST_EMPLID_IN_RUN_CONTROL
    show 'TEST_EMPLID from run control is enabled.'
 #endif
 #ifdef TEST_FLAG_IN_RUN_CONTROL
   #debugd show 'TEST_FLAG from run control is enabled.'
 #endif
 
 #ifdef Q3_2010_RUN_CONTROL
  #debugd show 'Q3_2010_RUN_CONTROL enabled.'
 #endif
 
#ifdef MULTI_COMPANY_RC
  show 'MULTI_COMPANY_RC'
  do Select-Multi-Company-Params
#else
 

  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY
    show 'SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY enabled, getting selected company from TF_COMPANY'
  #endif
 
  #ifndef CUSTOM_RUN_CONTROL_NAME
    show 'default run control, for client: {SITE_ID} ' $ps_run_control
  #else
    show 'custom run control, for client: {SITE_ID} ' $ps_run_control
  #endif
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
Begin-Select
STD_SP.OPRID
STD_SP.RUN_CNTL_ID
STD_SP.{Client_Field_Prefix}CALENDAR_QTR{Client_Field_Suffix}
STD_SP.CALENDAR_YEAR
STD_SP.{Client_Field_Prefix}DETAIL_CHOICE{Client_Field_Suffix}
STD_SP.{Client_Field_Prefix}ALL_COMPANIES{Client_Field_Suffix}
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY
STD_SP.TF_COMPANY
#else
STD_SP.{Client_Field_Prefix}SELECT_COMPANY{Client_Field_Suffix}
#endif
STD_SP.{Client_Field_Prefix}W2_SELECT{Client_Field_Suffix}
#if {SITE_ID} = 'TMW1'
STD_SP.{Client_Field_Prefix}AUDIT_FED{Client_Field_Suffix}
#endif
#ifdef TEST_EMPLID_IN_RUN_CONTROL
STD_SP.EMPLID
#endif
#ifdef TEST_FLAG_IN_RUN_CONTROL
STD_SP.TEST_FLAG
#endif
#ifdef MONTHLY_BALANCING_ENABLED
STD_SP.MONTHCD
#endif
#ifdef MULTIPLE_SITES
STD_SP.{Client_Field_Prefix}WGPS_SITE{Client_Field_Suffix}
#endif
#ifdef Q3_2010_RUN_CONTROL
STD_SP.REPORT_ONLY_FLAG
STD_SP.{Client_Field_Prefix}ADP_QTR_MODE{Client_Field_Suffix}
#endif
#ifdef QUARTERLY_HISTORY_UPDATE_FIELD
STD_SP.UPDATE_FIELD
#endif
 
  let $SelectEmplidSelection    = 'AND C.EMPLID <> '' '''
  let $SelectEmplidSelection_YE = 'AND YE_DATA.EMPLID <> '' '''
  let $SelectEmplidSelection_MC = 'AND PSPC1.EMPLID <> '' '''
  let $SelectEmplidSelection_3P = 'AND BB1.EMPLID <> '' '''
  let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID <> '' '''
  let $SelectEmplidSelection_WF  = 'AND WF.EMPLID <> '' '''
 
  #ifdef TEST_EMPLID_IN_RUN_CONTROL
    Let $SelectEmplid  = rtrim(&STD_SP.EMPLID,' ')
    if $SelectEmplid <> ''
       let $SelectEmplidSelection    = 'AND C.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_YE = 'AND YE_DATA.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_MC = 'AND PSPC1.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_3P = 'AND BB1.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_WF = 'AND WF.EMPLID {TEST_EMPLID_PHRASE} ''' || $SelectEmplid || ''''
    else
       let $SelectEmplidSelection    = 'AND C.EMPLID <> '' '''
       let $SelectEmplidSelection_YE = 'AND YE_DATA.EMPLID <> '' '''
       let $SelectEmplidSelection_MC = 'AND PSPC1.EMPLID <> '' '''
       let $SelectEmplidSelection_3P = 'AND BB1.EMPLID <> '' '''
       let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID <> '' '''
       let $SelectEmplidSelection_WF = 'AND WF.EMPLID <> '' '''
    end-if
    show ' TEST Emplid from Run control string = ' $SelectEmplidSelection
  #endif
 
  #ifdef QUARTERLY_HISTORY_UPDATE_FIELD
    let $update_quarterly_history = &STD_SP.UPDATE_FIELD
    #debugd show 'update_quarterly_history = ' $update_quarterly_history
  #else
    let $update_quarterly_history = 'Y'
  #endif
 
 
  Let $RptQTR         = &STD_SP.{Client_Field_Prefix}CALENDAR_QTR{Client_Field_Suffix}
  Let $RptYear        = to_char(&STD_SP.CALENDAR_YEAR)
  Let $RptDetail      = &STD_SP.{Client_Field_Prefix}DETAIL_CHOICE{Client_Field_Suffix}
  Let $AllCompanies   = &STD_SP.{Client_Field_Prefix}ALL_COMPANIES{Client_Field_Suffix}
 
  #ifdef MULTIPLE_SITES
   let $Site_ID_RC = &STD_SP.{Client_Field_Prefix}WGPS_SITE{Client_Field_Suffix}
  #endif
 
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY
    show 'SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY: TF_COMPANY ' &STD_SP.TF_COMPANY
    Let $SelectCompany  = &STD_SP.TF_COMPANY
  #else
    Let $SelectCompany  = &STD_SP.{Client_Field_Prefix}SELECT_COMPANY{Client_Field_Suffix}
  #endif
 
  !8/9/06 fix.. was only reporting W-2 data for Q4
  !-----------------------------------------------
  let $Operator_selected_W2s = &STD_SP.{Client_Field_Prefix}W2_SELECT{Client_Field_Suffix}
  #ifdef AUTO_W2_SELECT
    if $RptQtr = '4'
      let $Operator_selected_W2s = 'Y'
    end-if
  #endif
 
  show 'Report year   ' $RptYear
  show 'Report Qtr    ' $RptQTR
  show 'W-2s Selected ' $Operator_selected_W2s
  show 'Detail Select ' $RptDetail
  #ifdef MULTIPLE_SITES
    show 'Site_ID_RC    ' $Site_ID_RC
  #endif
 
  #ifdef Q3_2010_RUN_CONTROL
   Let $REPORT_ONLY_FLAG    = &STD_SP.REPORT_ONLY_FLAG
   Let $ADP_QTR_MODE        = &STD_SP.{Client_Field_Prefix}ADP_QTR_MODE{Client_Field_Suffix}
   #debugd show 'REPORT_ONLY_FLAG  ' $REPORT_ONLY_FLAG
   #debugd show 'ADP_QTR_MODE      ' $ADP_QTR_MODE
  #endif
 
 
  #ifdef MONTHLY_BALANCING_ENABLED
 
   let $RptPeriod = &STD_SP.MONTHCD
   move $RptPeriod to #RptPeriod
 
   if #RptPeriod <> 0
 
    evaluate $RptQtr
     when = '1'
       let #validm1 = 1
       let #validm3 = 3
       break
     when = '2'
       let #validm1 = 4
       let #validm3 = 6
       break
     when = '3'
       let #validm1 = 7
       let #validm3 = 9
       break
     when = '4'
       let #validm1 = 10
       let #validm3 = 12
       break
     when-other
       break
    end-evaluate
 
    if #RptPeriod < #validm1 or #RptPeriod > #validm3
     show 'ERROR: Invalid Month (' $RptPeriod ') Aborting Program.'
     stop
    end-if
 
     show '$RptPeriod = ' $RptPeriod
 
   end-if
  #endif
 
 !Client unique run control table names...
 !-----------------------------------------
 #ifndef CUSTOM_RUN_CONTROL_NAME
   from PS_{Client_Table_Prefix}PBZ_QTR{Client_Table_Suffix} STD_SP

   #if {SITE_ID} = 'WFG1'
     where STD_SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
   #else
     Where STD_SP.OPRID = $PRCS_OPRID
       and STD_SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
   #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #else
 
  #if {SITE_ID} = 'GTI1'
   from PS_GNTPY069_RUNCTL STD_SP
   Where STD_SP.OPRID = $PRCS_OPRID
     and STD_SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
  #endif
 
  #if {SITE_ID} = 'STV1'      !Venu Tirumala - Logic is added to select from ST.Vincent Run Control Table
   from PS_STV_RUNTXPBZQTR STD_SP
   Where STD_SP.OPRID = $PRCS_OPRID
     and STD_SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
  #endif
 
  #if {SITE_ID} = 'INT1'
   from PS_IN_RC_PBZQTR STD_SP
   Where STD_SP.OPRID = $PRCS_OPRID
     and STD_SP.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
  #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
#endif  !CUSTOM_RUN_CONTROL_NAME
#endif  !Multi rc
 
 if (rtrim($RptYear,' ') = '') OR (rtrim($RptQtr,' ') = '')
    show 'Error: Not retrieving CALENDAR_YEAR, or CALENDAR_QTR from Run Control Table: ' $ps_run_control
    #if {SITE_ID} = 'SRC1'
        Move 8 to #Return-Status
    #endif
    #if {SITE_ID} = 'TCN1'
        Move 5 to #Return-Status
    #endif
    stop
 end-if
 
#endif  !process scheduler enabled
 
End-Procedure
 
#ifdef MULTI_COMPANY_RC
 
begin-procedure Select-Multi-Company-Params
 
  show 'PROCEDURE Select-Multi-Company-Params'
 
  let $SelectCompany     = ''
 
 
Begin-Select
STD_MRC.OPRID
STD_MRC.RUN_CNTL_ID
STD_MRC.{Client_Field_Prefix}CALENDAR_QTR{Client_Field_Suffix}
STD_MRC.CALENDAR_YEAR
STD_MRC.{Client_Field_Prefix}DETAIL_CHOICE{Client_Field_Suffix}
STD_MRC.{Client_Field_Prefix}ALL_COMPANIES{Client_Field_Suffix}
STD_MRC.{Client_Field_Prefix}SELECT_COMPANY{Client_Field_Suffix}
STD_MRC.{Client_Field_Prefix}W2_SELECT{Client_Field_Suffix}
STD_MRC.EMPLID
#ifdef Q3_2010_RUN_CONTROL
STD_MRC.REPORT_ONLY_FLAG
STD_MRC.{Client_Field_Prefix}ADP_QTR_MODE{Client_Field_Suffix}
#endif
#ifdef MONTHLY_BALANCING_ENABLED
STD_MRC.MONTHCD
#endif
#ifdef QUARTERLY_HISTORY_UPDATE_FIELD
STD_MRC.UPDATE_FIELD
#endif
 
  let $SelectEmplidSelection    = 'AND C.EMPLID <> '' '''
  let $SelectEmplidSelection_YE = 'AND YE_DATA.EMPLID <> '' '''
  let $SelectEmplidSelection_MC = 'AND PSPC1.EMPLID <> '' '''
  let $SelectEmplidSelection_3P = 'AND BB1.EMPLID <> '' '''
  let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID <> '' '''
  let $SelectEmplidSelection_WF  = 'AND WF.EMPLID <> '' '''
 
  Let $SelectEmplid  = rtrim(&STD_MRC.EMPLID,' ')
  if $SelectEmplid <> ''
       let $SelectEmplidSelection    = 'AND C.EMPLID = ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_YE = 'AND YE_DATA.EMPLID = ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_MC = 'AND PSPC1.EMPLID = ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_3P = 'AND BB1.EMPLID = ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID = ''' || $SelectEmplid || ''''
       let $SelectEmplidSelection_WF  = 'AND WF.EMPLID = ''' || $SelectEmplid || ''''
  else
       let $SelectEmplidSelection    = 'AND C.EMPLID <> '' '''
       let $SelectEmplidSelection_YE = 'AND YE_DATA.EMPLID <> '' '''
       let $SelectEmplidSelection_MC = 'AND PSPC1.EMPLID <> '' '''
       let $SelectEmplidSelection_3P = 'AND BB1.EMPLID <> '' '''
       let $SelectEmplidSelection_W2c = 'AND W2CD.W2C_ADD_EMPLID <> '' '''
       let $SelectEmplidSelection_WF  = 'AND WF.EMPLID <> '' '''
  end-if
  show ' TEST Emplid from Run control string = ' $SelectEmplidSelection
 
  #ifdef QUARTERLY_HISTORY_UPDATE_FIELD
    let $update_quarterly_history = &STD_MRC.UPDATE_FIELD
    #debugd show 'update_quarterly_history = ' $update_quarterly_history
  #else
    let $update_quarterly_history = 'Y'
  #endif
 
  Let $RptQTR         = &STD_MRC.{Client_Field_Prefix}CALENDAR_QTR{Client_Field_Suffix}
  Let $RptYear        = to_char(&STD_MRC.CALENDAR_YEAR)
  Let $RptDetail      = &STD_MRC.{Client_Field_Prefix}DETAIL_CHOICE{Client_Field_Suffix}
  Let $AllCompanies   = &STD_MRC.{Client_Field_Prefix}ALL_COMPANIES{Client_Field_Suffix}
 
  !8/9/06 fix.. was only reporting W-2 data for Q4
  !-----------------------------------------------
  let $Operator_selected_W2s = &STD_MRC.{Client_Field_Prefix}W2_SELECT{Client_Field_Suffix}
  #ifdef AUTO_W2_SELECT
    if $RptQtr = '4'
      let $Operator_selected_W2s = 'Y'
    end-if
  #endif
 
  #ifdef MONTHLY_BALANCING_ENABLED
 
   let $RptPeriod = &STD_MRC.MONTHCD
   move $RptPeriod to #RptPeriod
 
   if #RptPeriod <> 0
 
    evaluate $RptQtr
     when = '1'
       let #validm1 = 1
       let #validm3 = 3
       break
     when = '2'
       let #validm1 = 4
       let #validm3 = 6
       break
     when = '3'
       let #validm1 = 7
       let #validm3 = 9
       break
     when = '4'
       let #validm1 = 10
       let #validm3 = 12
       break
     when-other
       break
    end-evaluate
 
    if #RptPeriod < #validm1 or #RptPeriod > #validm3
     show 'ERROR: Invalid Month (' $RptPeriod ') Aborting Program.'
     stop
    end-if
 
    #debugd show '$RptPeriod = ' $RptPeriod
 
   end-if
  #endif
 
  #ifdef Q3_2010_RUN_CONTROL
   Let $REPORT_ONLY_FLAG    = &STD_MRC.REPORT_ONLY_FLAG
   Let $ADP_QTR_MODE        = &STD_MRC.{Client_Field_Prefix}ADP_QTR_MODE{Client_Field_Suffix}
   #debugd show 'REPORT_ONLY_FLAG  ' $REPORT_ONLY_FLAG
   #debugd show 'ADP_QTR_MODE      ' $ADP_QTR_MODE
  #endif
 
   FROM PS_{Client_Table_Prefix}PBZ_QTR{Client_Table_Suffix} STD_MRC
     WHERE STD_MRC.OPRID       = $PRCS_OPRID
       AND STD_MRC.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 
!---------- now get the list of companies if the 'all companies' has not been selected
 
  if rtrim($AllCompanies,' ') <> 'Y'
 
    Let $First_company     = 'Y'
    #ifdef MULTI_COMPANY_RC_EXCLUDE
      move 'AND NOT C.COMPANY in (' to $CompanySelection
    #else
      move 'AND C.COMPANY in (' to $CompanySelection
    #endif
    
begin-select
STD_COM.COMPANY
 
   If rtrim(&STD_COM.COMPANY,' ') <> ''
 
    if $First_company = 'Y'
       let $First_company = 'N'
    else
        let $CompanySelection = $CompanySelection || ','
    end-if
 
    concat ''''             with $CompanySelection
    concat &STD_COM.COMPANY with $CompanySelection
    concat ''''             with $CompanySelection
 
   End-If
 
  #if {SITE_ID} = 'ANC1'
    FROM PS_{Client_Table_Prefix}PBZ_QTR_COM{Client_Table_Suffix} STD_COM    !too many chars in table name
  #else
   #if {SITE_ID} = 'PPL1'
    FROM PS_{Client_Table_Prefix}PBZ_QTR_COM{Client_Table_Suffix} STD_COM    !too many chars in table name
   #else
     FROM PS_{Client_Table_Prefix}PBZ_QTR_COMP{Client_Table_Suffix} STD_COM
   #endif
  #endif
 
  WHERE STD_COM.OPRID       = $PRCS_OPRID
       AND STD_COM.RUN_CNTL_ID = $PRCS_RUN_CNTL_ID
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  end-if
 
  if rtrim($AllCompanies,' ') = 'Y'
     let $CompanySelection = 'AND C.COMPANY > '' '''
  else
      if $First_company = 'N'
        concat ')'   with $CompanySelection
      else
        let $SelectCompany = &STD_MRC.{Client_Field_Prefix}SELECT_COMPANY{Client_Field_Suffix}
      end-if
  end-if
 
  ! ------------------------------------------
 
  show ' '
  show 'MULTI-COMPANY Run control'
  show ' Report year ' $RptYear ', Report Qtr ' $RptQTR ', W-2s Selected ' $Operator_selected_W2s ', Detail ' $RptDetail ', AllCompanies ' $AllCompanies
  show ' SelectCompany    ' $SelectCompany
  show ' CompanySelection ' $CompanySelection
  show ' '
 
end-PROCEDURE  !Select-CFG-Params
 
#endif
 
#ifdef USE_TEMP_TABLE_FOR_MONTHLY_COUNTS         !the table create MUST be in Begin-setup
 
begin-procedure init-temp-table
 
  do Get-Current-DateTime
  #debugd show ' '
  #debugd show 'init-temp-table: USE_TEMP_TABLE_FOR_MONTHLY_COUNTS: Tablename: {PBZQTR_TEMP_TABLE} ' $AllCompanies ', ' $SelectCompany ' --> ' $AsOfNow
 
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT
     show 'init-temp-table {PBZQTR_TEMP_TABLE}: SUBTOTAL_ADP_COMPID_EXTRACT: Clearing table for all companies'
 
begin-sql
DELETE FROM {PBZQTR_TEMP_TABLE}
end-sql
 
#else
  if ($AllCompanies = 'Y') or ($SelectCompany = '') !07/23/01
    show 'init-temp-table {PBZQTR_TEMP_TABLE}: Clearing table for all companies'
 
begin-sql
DELETE FROM {PBZQTR_TEMP_TABLE}
end-sql
 
  else
    show 'Clearing table: {PBZQTR_TEMP_TABLE} for company = ' $SELECTCOMPANY
 
   #if {SITE_ID} = 'SRC1'
       begin-sql
       DELETE FROM {PBZQTR_TEMP_TABLE}
       WHERE COMPANY IN (SELECT B.COMPANY FROM PS_TF_COMPANY_XREF B
                           WHERE B.TF_COMPANY = $SelectCompany
                             AND B.EFFDT = (SELECT MAX(B1.EFFDT) FROM PS_TF_COMPANY_XREF B1
                                              WHERE B1.COMPANY = B.COMPANY
					        AND B1.EFFDT <= CURRENT DATE))
       end-sql
   #else
 
begin-sql
DELETE FROM {PBZQTR_TEMP_TABLE}
WHERE COMPANY = $SELECTCOMPANY
end-sql
 
   #endif
 
 end-if
 
#endif
 
#ifdef ANALYZE_PBZQTR_TEMP
 #ifdef ORACLE
 #debugd show 'init-temp-table: USE_TEMP_TABLE_FOR_MONTHLY_COUNTS: Table analyze...'
 Begin-sql
    analyze table {PBZQTR_TEMP_TABLE} estimate statistics	!Added KH 2/23
 end-sql
 #endif
#endif
 
!#ifdef BIG_CLIENT
 #ifdef MVS
     #debugd show 'commit #0'       ! mc06862 - wells
     do Commit-Transaction  ! mc06862 - wells
 #endif
 #ifdef UNIX
     #debugd show 'commit #0'       ! mc06862 - wells
     do Commit-Transaction  ! mc06862 - wells
 #endif
!#endif
 
 do Get-Current-DateTime
 show 'init-temp-table: USE_TEMP_TABLE_FOR_MONTHLY_COUNTS: init-temp-table complete. ' $AsOfNow
 show ' '
 
end-procedure
 
#endif  !Endif (USE_TEMP_TABLE_FOR_MONTHLY_COUNTS)
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Init-Report                                                !
! Descr:     Report initialization procedure.  Prompt for filename.     !
!--------------------------------------------------------------------   !
begin-procedure Init-Report
 
  let $ReportID     = '{QUARTERLY_REPORT_ID}'
  let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly Extract'
 
  #if {SITE_ID} = 'PFZ1'
    do Get-Job-Info
  #endif
 
  #if {SITE_ID} = 'BKR1'
    let $VARIABLE = 'ADP_TAX_QRTRLY_RPT_PREFIX'
   #debugd show 'Going to get path name from sqr'   !030509jlg
    do get-path-name
  #endif
 
  #if {SITE_ID} = 'WFG1'
  ! Wells MC06462 - Begin - Added for the report
     move '003'                    to $Version
     move 'NOB'                    to $Job_Schedule_ID
     do Format-DateTime($AsOfToday, $Date_Out, {DEFCMP}, '', '')
     move $Date_Out        to $RunDate    mm/dd/yyyy
     let #commit_cnt = 0
  ! Wells MC06462 - End
 
   let $Prcs_Process_Instance = 'MVS'     ! Wells MC06462
   let $Prcs_OprID            = 'PAYROLL' ! Wells MC06462
   let $Prcs_Run_Cntl_ID      = 'QTR_END' ! Wells MC06462
  #endif
 
 
end-procedure
 
begin-procedure open-quarterly-extract-file
 
  show 'Full Extract File Path = ' $Filename
 
  !----------------------------------------------------------------------
  let $Add_Cr = 'f'    !for some Unix systems, transferring to
                       !Novell doesn't work unless the extract explicitly
                       !contains a CR at the end of each line. (Coke,PJ)
 
  !----------------------------------------------------------------------
  #if {SITE_ID} = 'TDB2'
    let $filename = 'DD:OUTFILE1'
    #debugd show 'TDB2: open-quarterly-extract-file: Quarterly Extract Filename: ' $FileName ', prcs_process_instance = ' $prcs_process_instance
    If $prcs_process_instance = '0'
      open $Filename as 1 for-writing record=700:fixed_nolf status=#filestat
    Else
      open $Filename as 1 for-writing record=2500:vary status=#filestat
    End-If
    goto extract_file_open_complete
  #endif
 
  #if {SITE_ID} = 'WFG1'
     open $Filename as 1 for-writing record=700:fixed_nolf status=#filestat
     goto extract_file_open_complete
  #endif
 
  #if {SITE_ID} = 'YRC1'
     open $Filename as 1 for-writing record=700:fixed_nolf status=#filestat
     goto extract_file_open_complete
  #endif
 
  #if {SITE_ID} = 'FHS1'
    let $filename = 'DD:OUTFILE1'
    #debugd show 'FHS1: open-quarterly-extract-file: Quarterly Extract Filename: ' $FileName ', prcs_process_instance = ' $prcs_process_instance
    If $prcs_process_instance = '0'
      open $Filename as 1 for-writing record=700:fixed_nolf status=#filestat
    Else
      open $Filename as 1 for-writing record=2500:vary status=#filestat
    End-If
    goto extract_file_open_complete
  #endif
 
  open $Filename as 1 for-writing record=700:vary status=#filestat
 
!  #ifdef CREATE_TRIGGER_FILE
!   let $Trigger_Filename = $Filename || '.trigger'
!   #debugd show 'CREATE_TRIGGER_FILE, creating ' $Trigger_Filename
!   open $Trigger_Filename as 11 for-writing record=700:vary status=#filestat
!   close 11
!  #endif
 
extract_file_open_complete:
 
 if #filestat <> 0
    show '*** Error on Output File: Open $Filename as 1 for-writing record=700:vary status=#filestat *** ' $Filename ', #filestat ' #filestat edit 999999999
    #if {SITE_ID} = 'SRC1'
       Move 8 to #Return-Status
    #endif
    #if {SITE_ID} = 'TCN1'
        Move 5 to #Return-Status
    #endif
    stop
  else
    show 'Quarterly Extract File Created. ' $Filename
    let #open1 = -1
  end-if
 
end-procedure
 
 
begin-procedure report
 
     do input-prompts
 
     #ifdef PA_WORKSITE_EXTRACT
      #debugd show 'PA_WORKSITE_EXTRACT enabled. for {PA_STATE}'
      do init-PA-worksites
     #endif
 
     #if {SITE_ID} = 'WFG1'
      #debugd show 'in report ' $RptYear
      move $RptYear to #RptYear
      move $RptQtr  to #RptQtr
      move 'N' to $RptDetail
     #endif
 
     #ifdef USE_INT_CRITERIA
        let $RptMonthZ =  #RptMonth
        let $RptQtrZ   =  #RptQtr
        let $RptYearZ  =  #RptYear
        show 'USE_INT_CRITERIA enabled Month: ' $RptMonthZ ' Qtr: ' $RptQtrZ ' Year: ' $RptYearZ
     #endif
  
 
     #ifdef WA_WORKERS_COMP_ENABLE                                !Allow the L&I to start Q3, 2011 (or any quarter)
       let $start_YYYYQ = rtrim('{START_WA_WORKERS_COMP_YYYYQ}',' ')
       if $start_YYYYQ <> ''                                      !YYYYQ must be the format.... process STARTING on this quarter
          let #start_Q    = substr($start_YYYYQ,5,1)
          let #start_YYYY = substr($start_YYYYQ,1,4)
          if #RptYear > #start_YYYY or (#RptYear = #start_YYYY and #RptQtr >= #start_Q)
            let $WA_WORKERS_COMP_ENABLE = 't'
            show 'WA_WORKERS_COMP_ENABLED. (WA L&I activated).  Activation in Q' #start_q edit 9 ', ' #start_yyyy edit 9999
          else
            show 'WA_WORKERS_COMP_ENABLED, but not allowed until Q' #start_q edit 9 ', ' #start_yyyy edit 9999 '.   Currently running for ' $RptYear ' Q' $RptQtr
          end-if
       else
         show 'START_WA_WORKERS_COMP_YYYYQ definition is invalid {START_WA_WORKERS_COMP_YYYYQ}.  It should be in the form of YYYYQ. Example: 20113'
       end-if
     #endif
 
     #ifdef USE_TEMP_TABLE_FOR_MONTHLY_COUNTS         !the table create MUST be in Begin-setup
        do init-temp-table
     #endif
 
     let $adp_format = 't'
     let $adp_w2_records = 'f'
 
     if $RptQtr = '4' OR $Operator_selected_W2s = 'Y'  ! June 18, 2012 - Auto selection of W-2 data re-enabled
        let $adp_w2_records = 't'
     end-if

     show 'W-2 Logic enabled ($adp_w2_records) = ' $adp_w2_records
 
     #ifdef MERGE_FILENAME
       do  open_MERGE_FILENAME  !this needs to be called at the beginning of the code to see if the merge file exists
     #endif
 
     !20121120
     #ifdef GENERATE_STATE_FUTA
        show 'STATE_FUTA_TAX_CLASS definition in pbzqtr.sqr: {STATE_FUTA_TAX_CLASS}'
        if #RptYear >= 2011
          let $STATE_FUTA_TAX_CLASS = '{STATE_FUTA_TAX_CLASS}'
          if (#RptYear = 2011 and $STATE_FUTA_TAX_CLASS = '6')
            let $STATE_FUTA_TAX_CLASS = '4'         !'6' started in Q4, 2012 for 9.1 clients or greater
          end-if
          if #RptYear = 2012 and $STATE_FUTA_TAX_CLASS = '6' and $Tax_Update <> '2012-F'
            let $STATE_FUTA_TAX_CLASS = '4'         !'6' started in Q4, 2012, 2012-F for 9.1 clients or greater
          end-if
        else
          let $STATE_FUTA_TAX_CLASS = ' '
        end-if
        show 'GENERATE_STATE_FUTA, class = ' $STATE_FUTA_TAX_CLASS ' for year = ' $RptYear ' and Tax update = ' $Tax_Update
        do Init-State-Futa
     #endif
 
     do Create-Interface-File
     do Create-Custom-Interface-File
     #If {Client_ID} = 'TFF1'
       date-time () mmddyy &Create_Dt
       move &Create_Dt   to $Create_Dt
       let $FileMMSS = substr($FileTime,3,4)
       let $Filename = $Cert_Prod|| 'tff1' || $Create_Dt || $FileMMSS || '.qtrly'
       let $Filename = $folder || $Filename
     #endif
 
     do open-quarterly-extract-file
     do init-adp303-procedure
 
     #ifdef LOCAL_RECIPROCITY
       show 'LOCAL_RECIPROCITY enabled.'
       do init-LOCAL_RECIPROCITY
 
       #ifdef LOCAL_RECIPROCITY_SPECIAL_REPORT
        show 'LOCAL_RECIPROCITY_SPECIAL_REPORT enabled. (see adpohrec.sqc)'
        do Init-LOCAL_RECIPROCITY_SPECIAL_REPORT
       #endif
 
     #endif
 
     if $adp_format = 't'
       #ifndef ADP_TAX_AMEND
          #ifdef Process_1099s
            do Init-1099s
          #endif
       #endif
       let $extract_mode = 'Q'      !Quarterly
       do Write-File-Header-Rec
     end-if
 
     #ifdef REDIRECT_REPORT_NAME
       #debugd show 'Quarterly Extract Report: Redircted to ' $NewReportName
     #else
       #debugd show 'Standard Report Name ' $sqr-report
     #endif
 
     #if {SITE_ID} = 'SCR1'
         do get_database_name-scr1
         #debugd show 'Database: ' $database
     #endif
 
     do PeopleSoft-Defaults
     do ProBusiness-Defaults
     do Create-TaxBalance-Array
     do Create-StateTax-Array
     do Create-SUI-Array
     do Create-State-Array

 
    do Get-Current-DateTime
    show ''
    show '---------------------------------------------------------------------------------------------------------------------------------'
    show 'Report: {QUARTERLY_REPORT_ID}: ' $AsOfNow ', Year: ' $RptYear ', Qtr: ' $RptQtr ', All Companies: ' $AllCompanies ', Select Company: ' $SelectCompany ', Emplid: ' $SelectEmplid ', W-2 data: ' $Operator_selected_W2s
 
    !Hours worked
    !------------
    do init-hours-calc
 
    #ifdef USE_TEMP_TABLE_FOR_MONTHLY_COUNTS
        do Get-Current-DateTime
        show 'Populating Temp Monthly count table ' $AsOfNow
        do Populate-Worked-In-Months-Flags
        do Get-Current-DateTime
        show 'Monthly count table {PBZQTR_TEMP_TABLE} initialized. ' $AsOfNow ', count = ' #temp_records
    #endif
 
 #ifdef UPDATE_STATISTICS
 #ifdef ANALYZE_TEMP_TABLES
   Begin-sql
    ANALYZE table {PBZQTR_TEMP_TABLE} compute statistics;	
   End-sql
 #else
   Begin-sql
    COMMIT
   end-sql
   Begin-sql
    UPDATE STATISTICS {PBZQTR_TEMP_TABLE}
   end-sql
 #endif
 #endif
 
 #ifdef DB2ALL
     #debugd show 'commit #1'       ! mc06862 - wells
     do Commit-Transaction  ! mc06862 - wells
 #endif
 #ifdef UNIX
     #debugd show 'commit #1'       ! mc06862 - wells
     do Commit-Transaction  ! mc06862 - wells
 #endif
 
     #ifdef INCLUDE_W2C
       #ifdef ADP_TAX_AMEND
         #debugd show 'W-2C processing enabled.  Calling Init-W2C...'
         #ifdef Q3_2010_RUN_CONTROL
           #debugd show 'Q3_2010_RUN_CONTROL automatically sets the $ADP_QTR_Mode to A (Amend)'
           let $ADP_QTR_Mode = 'A'
         #endif
 
         do Init-W2C
 
         #ifdef adjust-tax-balances-to-match-ee
          if $RptQtr = '4' and $adp_w2_records = 't'
            if $process_W2C_data = 't'
               show 'adjust-tax-balances-to-match-ee          --> Q4 W-2C inclusion Enabled.'
            end-if
          end-if
        #endif
 
        #ifdef INCLUDE_NEW_FED_W2C_DATA
           show 'INCLUDE_NEW_FED_W2C_DATA enabled'
        #endif
 
       #else
         #debugd show 'ERROR:  ADPAMEND.SQR now supports the W-2C functionality.'
         #debugd show '        Contact ADP CIS PeopleSoft support team to acquire adpamend.sqr'
         #debugd show '        Clone the PBZQTR SQR Report process definition, and name it ADPAMEND'
         #debugd show '        And, then run the ADPAMEND process to pick up prior year W-2C data'
         #debugd show 'Stop'
         stop
       #endif
 
     #endif
 
     #ifdef adjust-tax-balances-for-new-state-locals
 
          if $RptQtr = '4' and $adp_w2_records = 't'
            if $process_W2C_data = 't'
               #debugd show 'adjust-tax-balances-for-new-state-locals --> Q4 W-2C inclusion Enabled.'
            end-if
          end-if
 
          #define MAX_new_state_locals 50   !5/4/05
          create-array name=New_State_W2Cs size={MAX_new_state_locals} -
           field=state:char            -
           field=tax_class:char        -
           field=locality:char         -
           field=WORK_PSD_CD:char      -
           field=RES_PSD_CD:char       -
           field=YTD_tax:number        -
           field=YTD_txgrs:number      -
           field=RESIDENT:char
 
     #endif
 
     show 'sqr-report   :   ' $sqr-report
     show 'NewReportName:   ' $NewReportName
     show 'FileName     :   ' $Filename
 
  
     do Init-Process-Employees
     #ifdef PROCESS_WF_EMPLOYEE_SPLIT_QUERY
       do Get-Employee-Split
     #else
       do Process-Employees
     #endif
     do Post-Tax-Balance-Processing

     #if {Quarterly_extract_specs} >= '3.00'  !ADP
      if $adp_format = 't'
       if rtrim($Header_rec_compid,' ') <> ''
         do Write-Company-Trailer-Rec
       end-if
       do Write-File-Trailer-Rec
      end-if
     #endif
 
     #ifdef FORCE_FILE_HEADER_AND_TRAILER
        do Write-File-Trailer-Rec
     #endif
 
     do Wrap-Up
     do Reset
 
 if $REPORT_ONLY_FLAG = 'Y'
   do Delete-Extract-File
 else
 
   #if {SITE_ID} = 'WUV1'
        !Wesleyan Mod 03/31/2009  - Do the File manipulation and FTP to get to ADP.
 
      do Get-DB-Instance
 
      do WES_PRCSAPI_SET_PATH_NAMES
 
     if instr(upper($atabase_name) ,'PROD',1) > 1
       let $ftp_filename              = 'pwesleyan.wuv1.tax.payroll.' || edit(datenow(), 'YYYYMMDDHH24MISS')  || '.qtrly'
     else
       let $ftp_filename              = 'cwesleyan.wuv1.tax.payroll.' || edit(datenow(), 'YYYYMMDDHH24MISS')  || '.qtrly'
     end-if
 
     let $gpg_file_path               = $folder || $ftp_filename || '.gpg'
     let $pgp_file_path               = $folder || $ftp_filename || '.pgp'
     let $ftp_file_path               = $Folder || $ftp_filename
     let $pgp_file                    = $ftp_filename || '.pgp'
 
     let $cur_file_location           = $PS_DEPT_DIR || 'Payroll/tax/'
     let $cur_file                    = $cur_file_location || 'quarter'||$rptqtr||$rptyear||'.dat'
     let $del_cur_files               = $cur_file_location || '*.*'
     let $key_name                    = 'Tax Service'
 
     #debugd show 'FTP Filename is    : ' $ftp_file_path
     #debugd show 'Current Filename is: ' $cur_file
 
     do wes_unix_command_copy($Filename,$ftp_file_path,#ftp_copy_status)
     do wes_unix_command_del($del_cur_files, #delete_old_status)
     do wes_unix_command_copy($Filename,$cur_file, #create_current_status)
 
     do Wes-Gpg-Encrypt($ftp_file_path,$key_name,#GPG_status)
 
     if #gpg_status <> 0
       #debugd show 'GPG Encryption Failed!'
     end-if
     let #gpg_file_exists             = exists($gpg_file_path)
     if #gpg_file_exists              = 0
       let #pgp_rename                = rename($gpg_file_path, $pgp_file_path)
       if #pgp_rename                 = 0
         #debugd show 'File ready for FTP'
       else
         #debugd show 'File not renamed for FTP'
       end-if
     else
      #debugd show 'Encrypt status: ' #GPG_status
      #debugd show 'File not encrypted'
      stop
     end-if
 
    if #pgp_file_exists              = 0
      let $ftp_log                   = $file_location || 'scp.log'
 
      let $scp_cmd = '/usr/bin/scp '|| $pgp_file_path  || ' adp@admintran.wesleyan.edu:/usr/transfer/adp/outbound/'||$pgp_file
      #debugd show 'SCP Command: ' $scp_cmd
      CALL SYSTEM USING $scp_cmd #scp_status WAIT
      #debugd show 'SCP Status:  ' #scp_status
    if #scp_status                 = 0
      #debugd show 'SCP Sucessful'
    else
      evaluate #scp_status
        when = 1
          #debugd show 'Could not connect to remote host.'
          break
        when = 2
          #debugd show 'Could not connect to remote host - timed out.'
          break
        when = 3
          #debugd show 'Transfer failed.'
          break
        when = 4
          #debugd show 'Transfer failed - timed out.'
          break
        when = 5
          #debugd show 'Directory change failed.'
          break
        when = 6
          #debugd show 'Directory change failed - timed out.'
          break
        when = 7
          #debugd show 'Malformed URL.'
          break
        when = 8
          #debugd show 'Usage error.  '
          break
        when = 9
          #debugd show 'Error in login configuration file.'
          break
        when = 10
          #debugd show 'Library initialization failed.'
          break
        when = 11
          #debugd show 'Session initialization failed.'
          break
        when-other
          #debugd show 'Unknown Error with FTP.'
      end-evaluate
      #debugd show 'SCP File Transfer Unsuccessful, program aborted'
      do Get-Current-DateTime
      #debugd show ''
      ! show$ProgramID ' - ' $ProgramTitle
      #debugd show 'Aborted at ' $AsOfToday ' ' $AsOfNow
      stop
    end-if
  else
    #debugd show 'PGP File Rename Unsuccessful, program aborted'
    do Get-Current-DateTime
 
    #debugd show ''
    ! show$ProgramID ' - ' $ProgramTitle
    #debugd show 'Aborted at ' $AsOfToday ' ' $AsOfNow
    stop
  end-if
  #endif
 
     #if {SITE_ID} = 'RCC1'
        #ifdef UNIX
         do Convert-Files-RCC1
        #endif
     #endif
 
    #if {Client_ID} = 'AHM1'
        !input parms for encryption & FTP procedure
        let $ReportID       = 'PBZQTR'
        let $Directory      = $Folder    !file path
        !$FileName                       !file name & path
        let #SleepPeriod    = 2          !minutes
        do Put-File-on-FTP-Site
    #endif
 
     ! Generice shell script to executed upon termination
     !----------------------------------------------------
     #ifdef SHELL_CMD_FOR_QUARTERLY_UPON_EXIT   !Option added 8/13 for generic script...
       #ifdef UNIX
         #debugd show 'Calling, UNIX Shell Script...'
         #if {SITE_ID} = 'SWF1'
           let $command_line = '{SHELL_CMD_FOR_QUARTERLY_UPON_EXIT}' || ' ' || $Filename || '.zip' || ' ' || $Filename    !bcb01  zip with new naming convention
         #else
           let $command_line = '{SHELL_CMD_FOR_QUARTERLY_UPON_EXIT}' || ' ' || $Filename
         #endif
         let $display_message = 'UNIX Shell command-line is ' || $command_line
         display $display_message
         call system using $command_line #UNIX_status WAIT
         let $UNIX_status = #UNIX_status
         let $display_message = 'UNIX return code is ' || $UNIX_status
         display $display_message
       #else
         #debugd show 'No Shell Script Executed. This job was not run in the UNIX environment'
         let #Unix_status = 0
       #endif
 
       if #Unix_status > 0
          #debugd show 'ERROR - Invalid Return Code from UNIX script'
       end-if
     #endif
 
     #if {SITE_ID} = 'PLP1'
          ! Do FTP-Files-PH    !not for testing
     #endif
 
     #if {SITE_ID} = 'INT1'
     #ifdef AUTO_QUARTERLY_FTP
        do Get-local-Settings
        let $system_id       = 'PBZI'
        let $interface_id    = 'PBZQR'
        let $in_parm         = 'move1'
        let $in_filename  = $Filename
        string &G1.LOCAL_FILE_DIR 'IPAYI45.quarter.dat' by '' into $out_filename1
        do Move-File ($in_parm, $in_filename, $out_filename1)
        let $in_filename = $sqr-report
        string &G1.LOCAL_FILE_DIR 'IPAYI45.quarter.lis' by '' into $out_filename1
        do Move-File ($in_parm, $in_filename, $out_filename1)
      #endif
     #endif
 
    if #ErrorCount = 0
        #debugd show 'committing'
        do Commit-Transaction
    end-if
 
    #if {SITE_ID} = 'WHS1'
        do WEY-Transmit-File
    #endif
 
	#If {SITE_ID} = 'ITE1'
    #debugd show 'ITE1: custom filehandling in pbzqtr.sqr started.'
    do Create-Ftp-Filenames
    do Create-Ftp-Batch-File
		do Get-Transmit-Check-Box
		do Setup-FTP
		do Copy-File
	  #debugd show 'ITE1: custom filehandling in pbzqtr.sqr complete.'
  #endif
	
 end-if
 
 if #ErrorCount = 0 and $ADP_QTR_MODE = 'N' and $Report_Only_Flag <> 'Y'  !no errors, normal mode and not report only...
        #debugd show 'commit-Transaction call'
        do Commit-Transaction
 end-if
 
end-procedure
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: PeopleSoft-Defaults                                        !
! Descr:     Load PeopleSoft Default Values.                            !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure PeopleSoft-Defaults
 
  let $Default_COMPANY_Name = 'Com'
 
end-procedure
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: ProBusiness-Defaults                                       !
! Descr:     Load ProBusiness Default Values.                           !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure ProBusiness-Defaults
 
     let $Current_Company = 'Com'
     let $Current_Paygroup    = 'Pay'
     let $New_Hire = ' '
     let $space9 = '         '
     let $space1 = ' '
     let $Space5 = '     '
     let $Space15 = '               '
     let $Space7 = '       '
     let $space9 = '         '
     let $space10 = '          '
     let $space30 = '                              '
     let $space3 = '   '
     let $filler = '    '
     let $term_char = 'Z'
     do Format-Number(0,$zero16,  '999999999999999mi')
     do Format-Number(0,$zero2,   '99')
     let $No = 'N'
     let $Yes = 'Y'
     do Format-Number(0,$wc_rate,  '9999999999')
     let $wc_code = '    '
 
end-procedure
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Create-TaxBalance_Array                                    !
! Descr:     Create the array to hold Employee's Tax Balances from      !
!            the Tax-Balance table.                                     !
!---------------------------------------------------------------------- !
begin-procedure Create-TaxBalance-Array
 
#ifndef STRIPPED_PBZQTR_REPORT
    #define MISSING_QTR_DATA_LIMIT      1000
    #define LOCAL_LOCATIONS_LIMIT       5000
    create-array name=Missing_Qtr_Data size={MISSING_QTR_DATA_LIMIT}     -
           field=Company:char          -
           field=Emplid:char           -
           field=Message:char
 
    create-array name=Local_Locations size={LOCAL_LOCATIONS_LIMIT}     -
           field=State:char            -
           field=Locality:char         -
           field=Resident:char         -
           field=Gross:number          -
           field=Taxable:number        -
           field=Taxes:number
 
#endif
 
#ifndef SKIP_SUI_SUMMARY
    #ifndef SUI_LOCATIONS_LIMIT
      #define SUI_LOCATIONS_LIMIT         10000  !changed from 5000, 3/24/04
    #endif
    #debugd show 'SUI_LOCATIONS_LIMIT = {SUI_LOCATIONS_LIMIT}'
    create-array name=SUI_Locations size={SUI_LOCATIONS_LIMIT}     -
           field=Company:char          -
           field=State:char            -
           field=Worksite:char         -
           field=Rate:number           -
           field=Gross:number          -
           field=Taxable:number        -
           field=Taxes:number          -
           field=Month1:number         -
           field=Month2:number         -
           field=Month3:number         -
           field=QTD_Hours:number      -
           field=Weeks:number          -
           field=Worked_in_Qtr:number
#endif
 
    #ifdef Process_1099s
       #debugd show 'Process_1099s enabled'
    #endif
 
    #ifdef STRIPPED_PBZQTR_REPORT
       #debugd show 'STRIPPED_PBZQTR_REPORT enabled'
    #endif
 
    #ifndef SKIP_TAX_AND_WAGE_AUDITS
      #debugd show 'SKIP_TAX_AND_WAGE_AUDITS disabled, calling init-audits'
      do init-audits
    #else
       #debugd show 'SKIP_TAX_AND_WAGE_AUDITS enabled, no init-audits required'
    #endif
 
!COMMON DEFINITIONS
 
    #define MAX_TAX_CLASSES              100
    #ifndef TAX_LIMIT
      #define TAX_LIMIT                   7000
    #endif
    #debugd show 'TAX_LIMIT           = {TAX_LIMIT}'
 
    #ifndef MAX_YE_BAL_ADJ
      #define MAX_YE_BAL_ADJ 3000   !5/4/05
    #endif
    #debugd show 'MAX_YE_BAL_ADJ      = {MAX_YE_BAL_ADJ}'
    create-array name=YE_BalAdj size={MAX_YE_BAL_ADJ}
      field=Company:char
      field=Emplid:char
      field=Taxcode:char
      field=Type:char
      field=TaxBal:number
      field=YE_Amount:number
 
  create-array name=TaxBalance size={TAX_LIMIT} -
    field=TaxBalance_State:char          -
    field=TaxBalance_Locality:char       -
    field=TaxBalance_Tax_Class:char      -
    field=TaxBalance_Nlgrs_Qtd:number    -
    field=TaxBalance_Txgrs_Qtd:number    -
    field=TaxBalance_Tax_Qtd:number      -
    field=TaxBalance_Nlgrs_Ytd:number    -
    field=TaxBalance_Txgrs_Ytd:number    -
    field=TaxBalance_Tax_Ytd:number      -
    field=TaxBalance_Tip_Wages_Qtd:number -
    field=TaxBalance_Tip_Wages_Ytd:number -
    field=TaxBalance_Tip_Tax_Qtd:number -
    field=TaxBalance_Tip_Tax_Ytd:number -
    field=TaxBalance_Resident:char      -
    field=TaxBalance_Res_PSD_CD:char    -
    field=TaxBalance_Work_PSD_CD:char
 
 
  create-array name=TaxTotal size={TAX_LIMIT} -
    field=TaxTotal_State:char                -
    field=TaxTotal_Locality:char             -
    #ifdef LOCAL_RECIPROCITY
    field=TaxTotal_RESIDENT:char             -
    #endif
    field=TaxTotal_Tax_Class:char            -
    field=TaxTotal_Nlgrs_Qtd:number:4        -
    field=TaxTotal_Txgrs_Qtd:number:4        -
    field=TaxTotal_Excess_Qtd:number:4       -
    field=TaxTotal_Tax_Qtd:number:4          -
    field=TaxTotal_Nlgrs_Ytd:number:4        -
    field=TaxTotal_Txgrs_Ytd:number:4        -
    field=TaxTotal_Excess_Ytd:number:4       -
    field=TaxTotal_Tax_Ytd:number:4          -
    field=TaxTotal_Taxcode_sort:char
 
    create-array name=TaxClasses size={MAX_TAX_CLASSES} -
          field=Tax_Class_Lookup:char                   -
          field=Tax_Class_Descr:char
 
    #define MAX_MONTHLY_CHECKS 50
    create-array name=monthly_checks size={MAX_MONTHLY_CHECKS} -  !added 8/1/6 for speed (no temp table required)
  	   field=PC_PAY_BEGIN_DT:char   -
  	   field=PC_PAY_END_DT:char     -
  	   field=COMPANY:char           -
  	   field=PAYGROUP:char          -
  	   field=PAY_END_DT:char        -
  	   field=PAGE:number            -
  	   field=LINE:number            -
  	   field=OFF_CYCLE:char         -
  	   field=SEPCHK:number
 
    #define MAX_SUI_IN_QUARTER 50
    create-array name=sui_job size={MAX_SUI_IN_QUARTER} -  !added 1/28/8 sui date / SUI jurisdiction
  	   field=JOBCODE:char                   -
  	   field=LOCATION:char                  -
  	   field=TAX_LOCATION_CD:char           -
  	   field=ESTABID:char                   -
  	   field=STATE:char                     -
  	   field=WORKSITE:char                             !this is all data that could change from sui to sui...
 
 
 
#ifdef PRINT_ZERO_LOCALS
  #define MAX_zero_locals 6000
    create-array name=Zero_locals size={MAX_zero_locals} -
        field=Company:char            -
        field=emplid:char             -
        field=state:char              -
        field=locality:char           -
        field=resident:char           -
        field=QTD_txgrs:number        -
        field=QTD_taxes:number        -
        field=YTD_txgrs:number        -
        field=YTD_taxes:number
 #endif
 
#ifndef SKIP_RESIDENT_AUDIT
!2/28/7 added
 #ifndef MAX_resident_change
   #define MAX_resident_change 6000
 #endif
 create-array name=resident_change size={MAX_resident_change} -
        field=Company:char            -
        field=emplid:char             -
        field=state:char              -
        field=locality:char           -
        field=resident:char           -
        field=Effdt:char
#endif
 
end-procedure
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Create-State-Array                                         !
! Descr:     Create the array to hold ordered list of states for output !
!            50 States + Washington DC                                  !
!---------------------------------------------------------------------- !
begin-procedure Create-State-Array
 
  create-array name=States size=52 field=State:char
  put 'AL' into States(0) State
  put 'AK' into States(1) State
  put 'AR' into States(2) State
  put 'AZ' into States(3) State
  put 'CA' into States(4) State
  put 'CO' into States(5) State
  put 'CT' into States(6) State
  put 'DC' into States(7) State
  put 'DE' into States(8) State
  put 'FL' into States(9) State
  put 'GA' into States(10) State
  put 'HI' into States(11) State
  put 'IA' into States(12) State
  put 'ID' into States(13) State
  put 'IL' into States(14) State
  put 'IN' into States(15) State
  put 'KY' into States(16) State
  put 'KS' into States(17) State
  put 'LA' into States(18) State
  put 'MA' into States(19) State
  put 'MD' into States(20) State
  put 'ME' into States(21) State
  put 'MI' into States(22) State
  put 'MN' into States(23) State
  put 'MO' into States(24) State
  put 'MS' into States(25) State
  put 'MT' into States(26) State
  put 'NC' into States(27) State
  put 'ND' into States(28) State
  put 'NE' into States(29) State
  put 'NH' into States(30) State
  put 'NJ' into States(31) State
  put 'NM' into States(32) State
  put 'NV' into States(33) State
  put 'NY' into States(34) State
  put 'OH' into States(35) State
  put 'OK' into States(36) State
  put 'OR' into States(37) State
  put 'PA' into States(38) State
  put 'RI' into States(39) State
  put 'SC' into States(40) State
  put 'SD' into States(41) State
  put 'TN' into States(42) State
  put 'TX' into States(43) State
  put 'UT' into States(44) State
  put 'VA' into States(45) State
  put 'VT' into States(46) State
  put 'WA' into States(47) State
  put 'WI' into States(48) State
  put 'WV' into States(49) State
  put 'WY' into States(50) State
  put 'PR' into States(51) State
 
 end-procedure
 
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Create-StateTax_Array                                      !
! Descr:     Create the array to hold Employee's State Tax data from    !
!            the State-Tax-Data table.                                  !
!---------------------------------------------------------------------- !
begin-procedure Create-StateTax-Array
 
 #define HOURS_WORKED_PAY_TYPE
 #define HOURS_WORKED_PAY_SELECTION
  create-array name=StateTax size=100 -
    field=StateTax_EmplId:char          -
    field=StateTax_COMPANY:char         -
    field=StateTax_State:char           -
    field=Statetax_Wage_Plan_CD:char
 
 end-procedure
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Create-SUI-Array                                               !
! Descr:     Create the array to hold SUI rates from the                     !
!            CO-StateTax-Tbl table.                                       !
!---------------------------------------------------------------------- !
begin-procedure Create-SUI-Array
 
  create-array name=SUI size=100       -
    field=SUI_State:char               -
    field=SUI_Experience_Rt:number     -
    field=SUI_Employer_ID_SWT:char
 
 end-procedure
 
#if {SITE_ID} = 'HWL1'   ! 'ALLSIG'
 
begin-procedure Honeywell-exclude
 
    let $HON_COMPANIES_TO_EXCLUDE = ''
 
begin-select
CCHK.COMPANY
 
   let $HON_COMPANIES_TO_EXCLUDE_PRINT = $HON_COMPANIES_TO_EXCLUDE_PRINT ||' '|| &CCHK.COMPANY
   if $HON_COMPANIES_TO_EXCLUDE = ''
       let $HON_COMPANIES_TO_EXCLUDE = ' and c.COMPANY not in ('''|| &CCHK.COMPANY ||''''
   else
       let $HON_COMPANIES_TO_EXCLUDE = $HON_COMPANIES_TO_EXCLUDE ||','''|| &CCHK.COMPANY||''''
   end-if
 
   FROM {HONEYWELL_EXCLUDE_TBL} CCHK
   WHERE CCHK.EFF_STATUS = 'A'
     AND CCHK.EFFDT      = (SELECT MAX(EFFDT)
                            FROM {HONEYWELL_EXCLUDE_TBL}
                              WHERE COMPANY     = CCHK.COMPANY
                                AND EFF_STATUS  = CCHK.EFF_STATUS
                                AND EFFDT      <= sysdate)
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
    if $HON_COMPANIES_TO_EXCLUDE <> ''
        let $HON_COMPANIES_TO_EXCLUDE = $HON_COMPANIES_TO_EXCLUDE || ')'
    end-if
 
    show 'Honeywell exclude string : ' $HON_COMPANIES_TO_EXCLUDE
 
end-procedure
 
#endif
 
#if {SITE_ID} = 'ECR1'
 
!***********************************************************************   !
!----------------------------------------------------------------------    !
! Procedure: Check-EMC-Record                                              !
! Desc:      This procedure determines whether or not to handle the        !
!            company / emplid for this record:$Check_Company,$Check_Emplid !
!----------------------------------------------------------------------    !
begin-procedure Check-EMC-Record
 
   let $Process_Tax_Record = 't'
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
begin-select
CCHK.TAX_REPORT_TYPE
 
   let $Process_Tax_Record = 'f'
 
   FROM PS_COMPANY_TBL CCHK
   WHERE CCHK.COMPANY    = $Check_Company
     AND CCHK.EFF_STATUS = 'A'  !Exclude
     AND CCHK.TAX_REPORT_TYPE <> '2'   !W-2s only
     AND CCHK.EFFDT      = (SELECT MAX(EFFDT)
       FROM PS_COMPANY_TBL
         WHERE COMPANY     = CCHK.COMPANY
           AND EFF_STATUS  = CCHK.EFF_STATUS
           AND EFFDT       <= $Qtr_End_Native)
 
 #ifdef SELECT_WITH_UR
  {SELECT_WITH_UR} with ur
 #endif
end-select
 
end-procedure
 
#endif
 
#ifdef USE_EFF_STATUS_TF_COMPANY_TBL
 
begin-procedure check-tf-company-tbl
 
    let $TF_COMPANY_TBL_INCLUDE = ''
 
begin-select
CTE.COMPANY
 
   let $TF_COMPANY_TBL_INCLUDE_PRINT = $TF_COMPANY_TBL_INCLUDE_PRINT ||' '|| &CTE.COMPANY
   if $TF_COMPANY_TBL_INCLUDE = ''
       let $TF_COMPANY_TBL_INCLUDE = ' AND C.COMPANY in ('''|| &CTE.COMPANY ||''''
   else
       let $TF_COMPANY_TBL_INCLUDE = $TF_COMPANY_TBL_INCLUDE ||','''|| &CTE.COMPANY||''''
   end-if
 
   FROM PS_{Client_Table_Prefix}COMPANY_TBL{Client_Table_Suffix} CTE
   WHERE CTE.EFF_STATUS = 'A'
     AND CTE.EFFDT      = (SELECT MAX(EFFDT)
                            FROM PS_TF_COMPANY_TBL
                              WHERE COMPANY     = CTE.COMPANY
                                AND EFF_STATUS  = CTE.EFF_STATUS
                                AND EFFDT      <= sysdate)
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
    if $TF_COMPANY_TBL_INCLUDE <> ''
        let $TF_COMPANY_TBL_INCLUDE = $TF_COMPANY_TBL_INCLUDE || ')'
    end-if
 
    #debugd show 'USE_EFF_STATUS_TF_COMPANY_TBL include string : ' $TF_COMPANY_TBL_INCLUDE
 
end-procedure
#endif
 
begin-procedure Init-Process-Employees
 
#if {SITE_ID} = 'HEP1'
begin-sql            !JAMES 10/30/2010
    ALTER SESSION SET "_UNNEST_SUBQUERY"=TRUE;
end-sql
#endif
 
  Let #Last_TaxBalance_Cnt = 0
  Let #Last_TaxTotal_Cnt   = 0
  Let $Current_Company       = ' '
  Let $C_Company             = ' '
  Let #Current_Fein          = 0
  Let $Current_Fein          = ' '
  let $Current_ADP_Compid    = ' '
  Let $Current_Emplid        = ' '
  Let $Input_Locality      = ' '
  Let $Input_State         = ' '
  let #new_ss = -1
  let #new_med = -1
 
 
  move $Qtr_End_Native to $Personal_AsOfDate    !Normally, we get the Job, Name, Address through the last day of the quarter
  #debugd show 'Personal_AsOfDate = ' $Personal_AsOfDate
 
 
  #ifdef USE_EFF_STATUS_TF_COMPANY_TBL
    do check-tf-company-tbl
  #endif
 
  #if {SITE_ID} = 'HWL1'
    do Honeywell-exclude
  #endif
 
  #if {SITE_ID} = 'WFG1'
    do Wells-Fargo-exclude
  #endif
 
  #ifdef show_selects
     #debugd show 'Processing PS_TAX_BALANCE{WAREHOUSE_SUFFIX}...'
  #endif
 
  #ifdef MULTIPLE_SITES
    #debugd show 'Init-Process-employees, MULTIPLE_SITES: $Alt_Site = ' $Alt_Site ', $TFI_Site = ' $TFI_Site
  #endif
 
  if $SelectEmplid <> ''
     #debugd show '----------->Testing Data for emplid : ' $SelectEmplid
  end-if
 
 !--------------------------------------------------------------------
 !4/5/01 for speed, so we don't look at company if all companies have
 !       been chosen
 !--------------------------------------------------------------------
 if $AllCompanies = 'Y'
   move ' ' to $CompanySelection
   #debugd show 'Init-Process-Employees: Clearing CompanySelection, as all companies have been selected'
 else
   #debugd show 'Init-Process-Employees: CompanySelection : ' $CompanySelection
 end-if
 
#ifdef INCLUDE_W2C
 #if {SITE_ID} = 'GE01'              !in adpgew2c.sqc - only pull in companies with W-2C data (Taxform_id = 'X' for GE01)
    do determine-if-w2c-run-GE01
    if $w2c_data_found = 't'
       move $CompanySelection_GE01_W2C to $CompanySelection
    end-if
    #debugd show 'GE01: Init-Process-Employees: CompanySelection : ' $CompanySelection ', w2c_data_found = ' $w2c_data_found
 #endif
#endif
 
 #ifdef TEST_EMPLID_IN_RUN_CONTROL
  if $SelectEmplid = ''                                               !this logic added for speed on 2/6/9
   move ' ' to $SelectEmplidSelection
   #debugd show 'Process-Employees: Clearing SelectEmplidSelection, as all EMPLIDs have been selected'
  end-if
 #else
  if $SelectEmplidSelection = 'AND C.EMPLID <> '' '''                 !this logic added for speed on 2/6/9
   move ' ' to $SelectEmplidSelection
   #debugd show 'Init-Process-Employees: Clearing SelectEmplidSelection, as all EMPLIDs have been selected'
  end-if
 #endif
 #debugd show 'Init-Process-Employees: SelectEmplidSelection : ' $SelectEmplidSelection
 
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 #ifdef MONTHLY_BALANCING_ENABLED
  let #SelectedMonth = #RptMonth
  if #RptPeriod <> 0
    let #SelectedMonth = #RptPeriod
 
    evaluate #RptPeriod
     when = 1
      let $Qtr_End_DTU   = $RptYear || '-01-31'
      break
     when = 2
      if mod(#RptYear,4) = 0
       let $Qtr_End_DTU   = $RptYear || '-02-29'
      else
       let $Qtr_End_DTU   = $RptYear || '-02-28'
      end-if
      break
     when = 3
      let $Qtr_End_DTU   = $RptYear || '-03-31'
      break
     when = 4
      let $Qtr_End_DTU   = $RptYear || '-04-30'
      break
     when = 5
      let $Qtr_End_DTU   = $RptYear || '-05-31'
      break
     when = 6
      let $Qtr_End_DTU   = $RptYear || '-06-30'
      break
     when = 7
      let $Qtr_End_DTU   = $RptYear || '-07-31'
      break
     when = 8
      let $Qtr_End_DTU   = $RptYear || '-08-31'
      break
     when = 9
      let $Qtr_End_DTU   = $RptYear || '-09-30'
      break
     when = 10
      let $Qtr_End_DTU   = $RptYear || '-10-30'
      break
     when = 11
      let $Qtr_End_DTU   = $RptYear || '-11-31'
      break
     when = 12
      let $Qtr_End_DTU   = $RptYear || '-12-31'
      break
     when-other
      #debugd show 'Invalid Month, Aborting.'
      stop
    end-evaluate
 
    Do Convert-From-DTU-Date($Qtr_End_DTU,$AsOfDate)
    #debugd show 'MONTHLY_BALANCING_ENABLED, Adjusted AsOfDate = ' $AsOfDate
  end-if
 
 #endif
 
 #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
  do Init-ADPCompid                     !in adpcompid.sqc
 #endif
 
 #if {SITE_ID} = 'SQP1'
     let $_TableAlias = 'C'  ! (PS_TAX_BALANCE)
     do Security-Param
     #debugd show ' '
     #debugd show 'SQP1: init-Process-Employees PS_TAX_BALANCE: SecurityClauseWithoutERN = ' $SecurityClauseWithoutERN
     !Let $SecurityClauseWithoutERN  = ' AND EXISTS (SELECT ' || '''X''' || ' FROM PS_FAST_SQR_SEC_VW SCRTY
     !    WHERE SCRTY.EMPLID = ' || $_TableAlias || '.EMPLID
     !                    AND SCRTY.OPRID = ''' || $prcs_oprid  || ''')'
     #debugd show ' '
 #endif
 
 do Get-Current-DateTime
 show 'init-Process-Employees Complete.  Starting main TAX_BALANCE query ' $AsofNow
 
 
end-procedure
 
 
#ifdef PROCESS_WF_EMPLOYEE_SPLIT_QUERY
begin-procedure Get-Employee-Split

    show 'Get-Employee-Split: Emplid from Run control string  = ' $SelectEmplidSelection_WF
    show 'Get-Employee-Split: Company from Run control string = ' $CompanySelection_WF

begin-select distinct
WF.COMPANY
WF.EMPLID
 
     let $get-company = &WF.COMPANY
     let $get-emplid = &WF.EMPLID
     do Process-Employees
 
FROM  PS_TAX_BALANCE WF
 WHERE WF.BALANCE_ID      = $Calendar_Year_Id

     #ifdef USE_INT_CRITERIA
       AND WF.BALANCE_YEAR    = int(\$RptYearZ\)
     #else
       AND WF.BALANCE_YEAR    = #RptYear
     #endif
     
     #ifdef TEST_EMPLID_IN_RUN_CONTROL
       #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
         \$SelectEmplidSelection_WF\
       #else
         [$SelectEmplidSelection_WF]
       #endif
     #endif
     #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
       \$CompanySelection_WF\
     #else
       [$CompanySelection_WF]
     #endif
       ORDER BY WF.COMPANY, WF.EMPLID
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
#endif
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: Process-Employees                                         !
! Desc:      This procedure cycles through all employees records       !
!            which display taxes for this quarter                         !
!----------------------------------------------------------------------!
begin-procedure Process-Employees
 
   if #ProcessEmployeescnt = 0
     show 'Process-Employees: CompanySelection = ' $CompanySelection ', Time --> '  $AsOfNow
     add 1 to #ProcessEmployeescnt
   end-if

BEGIN-SELECT
#ifdef ORACLE              !GE01 - 10/25/2011 50% speedup for them
/*+ leading(C) */
#endif
#if {SITE_ID} = 'HEP1'
/*+ NO_PARALLEL C) */ !HP Customization - Change parallel hint to no_parallel Sept 29 2010
#else
#ifdef USE_parallel_tax_balance_access
/*+ PARALLEL (C, 8) */
#endif
#ifdef USE_psatax_balance_index
/*+ index (c psatax_balance) */
#endif
#endif
#ifdef SUBTOTAL_FEIN
CO.FEDERAL_EIN
#endif
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT
CT.TF_COMPANY
#endif
C.COMPANY
C.EMPLID
C.STATE
C.TAX_CLASS
C.LOCALITY
C.NLGRS_QTD
C.NLGRS_YTD
C.TXGRS_QTD
C.TXGRS_YTD
C.TAX_QTD
C.TAX_YTD
C.BALANCE_YEAR
C.BALANCE_QTR
C.BALANCE_PERIOD
#ifdef MONTHLY_BALANCING_ENABLED
C.NLGRS_MTD
C.TXGRS_MTD
C.TAX_MTD
#endif
#ifdef PAACT_32_11F_Logic
C.RES_PSD_CD
C.WORK_PSD_CD
#endif
 

 !#define COMPANIES_TO_EXCLUDE_PRE_2011    COMPANY IN ('269','249','243','154','099','156')
 #if {SITE_ID} = 'MAC1'
   #ifdef COMPANIES_TO_EXCLUDE_PRE_2011
    if #RptYear < 2011
     if instr('{COMPANIES_TO_EXCLUDE_PRE_2011}', &C.COMPANY, 1) > 0
      if $SelectEmplid <> ''
        #debugd show 'Bypassing data for company ' &C.COMPANY ' due to COMPANIES_TO_EXCLUDE_PRE_2011 logic in ' $RptYear
      end-if
      goto bypass_tax_balance
     end-if
    end-if
   #endif
 #endif
 
 
  let $TB_State    = rtrim(&C.STATE,' ')
  let $TB_Locality = rtrim(&C.LOCALITY,' ')
 
  if #ps_tax_balance_count = 0
      do Get-Current-DateTime
      show '*** First Tax Balance retrieved. Time --> '  $AsOfNow
  end-if
 
  let $C.Company = rtrim(&C.COMPANY,' ')
  let $C.Emplid  = rtrim(&C.EMPLID,' ')
 
  if $C.Company = ''
    #if {SITE_ID} = 'SRC1'
      let #return-status = 8
    #endif
    #if {SITE_ID} = 'TCN1'
        Move 5 to #Return-Status
    #endif
    stop
  end-if

  if $SelectEmplid <> '' or $C.Emplid = '{TESTING_EMPLID}'
      show ' '
      show 'New Tax_Balance: ' $C.COMPANY ' ' &C.EMPLID ', Q' &C.BALANCE_QTR ', P' &C.BALANCE_PERIOD ', Taxcode:' $TB_State &C.TAX_CLASS $TB_Locality
      if &C.BALANCE_QTR = #RptQtr
        show ' --> QTD Tax = ' &C.TAX_QTD ' --> QTD Txgrs = ' &C.TXGRS_QTD ' --> QTD Nlgrs = ' &C.NLGRS_QTD
      end-if
      show ' --> YTD Tax = ' &C.TAX_YTD ' --> YTD Txgrs = ' &C.TXGRS_YTD ' --> YTD Nlgrs = ' &C.NLGRS_YTD
      #ifdef SUBTOTAL_FEIN
      show ' --> FEIN:     ' &CO.FEDERAL_EIN
      #endif
  end-if
 
   let $RES_PSD_CD1  = ''
   let $WORK_PSD_CD1 = ''
   #ifdef PAACT_32_11F_Logic
       if $TB_State = '{PA_STATE}' and $TB_Locality <> '' and &C.TAX_CLASS = 'H'
         let $RES_PSD_CD1  = rtrim(&C.RES_PSD_CD,' ')
         let $WORK_PSD_CD1 = rtrim(&C.WORK_PSD_CD,' ')
       end-if
   #endif
 
 
   if $SelectEmplid <> '' or $C.Emplid = '{TESTING_EMPLID}'
     show ' --> Res PSD = ' $RES_PSD_CD1 ' --> Work PSD  = ' $WORK_PSD_CD1
   end-if
 
 !added 10/5/01 due to TaxUpdate E's memo taxes added for the territories
 !------------------------------------------------------------------------
 #ifndef PROCESS_TERRITORY_STATE_RECORDS
  let $State_check = rtrim($TB_State,' ')
  if length($State_check) <> 2
     add &C.TAX_QTD to #Tax_Total_bypassed_territory_QTD
     goto bypass_tax_balance
  end-if
 #endif
 
 
 #ifdef ADP_TAX_AMEND !20140320 added
      if &C.BALANCE_QTR <> #RptQtr and (&C.TAX_YTD  = 0 and &C.TXGRS_YTD = 0 and &C.NLGRS_YTD = 0)
         show ' ADP_TAX_AMEND: Bypass balances for prior quarter with ZERO YTDs. Emplid ' &C.EMPLID
         goto bypass_tax_balance
      end-if
 #endif

 #ifdef BYPASS_NON_RES_ZERO_YTD  !1/6/17 / CBU1
   if $TB_State = '$U' and &C.TAX_CLASS = 'A' and &C.NLGRS_YTD <= 0 and &C.TXGRS_YTD <= 0 and &C.TAX_YTD <= 0 
     show ' Bypass (BYPASS_NON_RES_ZERO_YTD)  Bypassing Non-Resident Alien Balance record, Emplid: ' &C.EMPLID ', Company ' &C.COMPANY
     goto bypass_tax_balance
  end-if
 #endif

 
 !20130108 bypass PA-SIT with NLGRS_YTD <> 0 conversion error
 #if {SITE_ID} = 'ARP1'
   if $TB_State = '{PA_STATE}' and $TB_Locality = '' and &C.TAX_CLASS = 'H' and &C.NLGRS_YTD <> 0 and #RptYear = 2012
     #debugd show ' Bypass PA-SIT with NLGRS_YTD <> 0, Emplid ' &C.EMPLID ', Bypassing Balance record with NLGRS_YTD of ' &C.NLGRS_YTD edit 999,999,999.99
     goto bypass_tax_balance
  end-if
 #endif
 
 !20170228 bypass PA-Locals with $0 in YTD Taxes and $RES_PSD_CD = 880000
 #ifdef CUSTOM_PA_EIT_GIE1
   if $TB_State = '{PA_STATE}' and $TB_Locality <> '' and &C.TAX_CLASS = 'H' and &C.TAX_YTD <= 0 and (rtrim($RES_PSD_CD1,' ') = '880000' or rtrim($WORK_PSD_CD1,' ') = '880000')
     show ' Bypass PA-EIT with RES_PSD_CD 880000 and TAX_YTD = 0, Emplid ' &C.EMPLID ', Bypassing Balance record with TXGRS_YTD of ' &C.TXGRS_YTD edit 999,999,999.99
     goto bypass_tax_balance
  end-if
 #endif
 
 #ifdef JAT_TESTING
   let $JAT_Emplid = $C.Emplid
   do custom-emplid-selection  !in probiz.sqc
   if $process_test_emplid = 't'
     #ifdef debug_JAT_TESTING
      #debugd show 'Processing JAT test emplid: ' $JAT_Emplid
     #endif
   else
     goto bypass_tax_balance
   end-if
 #endif

 #ifdef CUSTOM_EMPLID_SKIP
    do custom-emplid-skip
    if $Process_Tax_Record <> 't'     !7/3/02 fix
      goto bypass_tax_balance
    end-if
 #endif
 
 let $Process_Tax_Record = 't'
 
 let $Cur_Tax_Class = rtrim(&C.TAX_CLASS,' ')
 let $Cur_State = rtrim($TB_State,' ')
 let $Cur_Locality = rtrim($TB_Locality,' ')
 
 !11/1/6 option
 !-------------
 #ifdef BYPASS_QUARTERLY_TAXES
   let $Trimmed_State     = rtrim($TB_State,' ')
   let $Trimmed_Tax_Class = rtrim(&C.TAX_CLASS,' ')
   let $Trimmed_Locality  = rtrim($TB_Locality,' ')
   let $Trimmed_Taxcode   = $Trimmed_State || $Trimmed_Tax_Class || $Trimmed_Locality
   do bypass-tax-check-quarterly  !in adpbypas.sqc
   if $Tax_Proceed = 'f'
     if &C.BALANCE_QTR = #RptQtr
       Add &C.TAX_QTD to #Hash_Ignore_Tax_QTD
     end-if
     Add &C.TAX_YTD to #Hash_Ignore_Tax_YTD
 
     let #CT.FEDERAL_EIN = &CT.FEDERAL_EIN
     let $C.Company_bypass    = &C.COMPANY
     let $C.Trimmed_State     = $Trimmed_State
     let $C.Trimmed_Tax_Class = $Trimmed_Tax_Class
     let $C.Trimmed_Locality  = $Trimmed_Locality
     let $C.Trimmed_Taxcode   = $Trimmed_Taxcode
     let #C.TAX_QTD   = &C.TAX_QTD
     let #C.TXGRS_QTD = &C.TXGRS_QTD
     let #C.NLGRS_QTD = &C.NLGRS_QTD
     let #C.TAX_YTD   = &C.TAX_YTD
     let #C.TXGRS_YTD = &C.TXGRS_YTD
     let #C.NLGRS_YTD = &C.NLGRS_YTD
     do insert-taxes-into-bypassed-totals
 
     let $Process_Tax_Record = 'f'
     goto bypass_tax_balance
   end-if
 
   #ifdef BYPASS_ZERO_LOCALS_QUARTERLY
    do bypass-zero-locals-quarterly  !in adplocbp.sqc
    if $Tax_Proceed = 'f'
     if &C.BALANCE_QTR = #RptQtr
       Add &C.TAX_QTD to #Hash_Ignore_Tax_QTD
     end-if
     Add &C.TAX_YTD to #Hash_Ignore_Tax_YTD
 
     let #CT.FEDERAL_EIN = &CT.FEDERAL_EIN
     let $C.Company_bypass    = &C.COMPANY
     let $C.Trimmed_State     = $Trimmed_State
     let $C.Trimmed_Tax_Class = $Trimmed_Tax_Class
     let $C.Trimmed_Locality  = $Trimmed_Locality
     let $C.Trimmed_Taxcode   = $Trimmed_Taxcode
     let #C.TAX_QTD   = &C.TAX_QTD
     let #C.TXGRS_QTD = &C.TXGRS_QTD
     let #C.NLGRS_QTD = &C.NLGRS_QTD
     let #C.TAX_QTD   = &C.TAX_YTD
     let #C.TXGRS_QTD = &C.TXGRS_YTD
     let #C.NLGRS_QTD = &C.NLGRS_YTD
     do insert-taxes-into-bypassed-totals
     let $Process_Tax_Record = 'f'
     goto bypass_tax_balance
    end-if
   #endif
 
 #endif
 
 #ifdef BYPASS_WA_NON_WITHHOLDING
    if  ( $Cur_State = 'WA' )  AND ( $Cur_Tax_Class <> 'H' OR $Cur_Locality <> '' )
      goto bypass_tax_balance
    end-if
  #endif
 
  !Puerto Rico exception for SOL1  ($UPR DOES get into the file for them)
  !-------------------------------------------------------------------------
  #if {SITE_ID} = 'SOL1'
     if  (($C.COMPANY = '504')       AND
	    (($Cur_State = '$U')     AND
            (($Cur_Tax_Class= 'D')    OR
             ($Cur_Tax_Class = 'E')   OR
             ($Cur_Tax_Class = 'F')   OR
             ($Cur_Tax_Class = 'Q'))  OR
            (($Cur_State = 'PR')     AND
	      ($Cur_Tax_Class = 'E')) OR
	    (($Cur_State = '$UPR')   AND
	      ($Cur_Tax_Class = 'U'))))
      #debugd show 'bypassing 504 $U record, tax_class = ' $Cur_tax_class
      goto bypass_tax_balance
    end-if
    if  ($Cur_State = 'NY')          AND
	($Cur_Tax_Class = 'D')
      #debugd show 'bypassing ' $Cur_State ', tax_class = ' $Cur_Tax_Class
      goto bypass_tax_balance
    end-if
  #endif
 
  #if {SITE_ID} = 'FRB1'
   if $C.COMPANY = '10J' AND
     ( ($Cur_Locality = '20000') AND ($Cur_State = 'CO') AND ($Cur_Tax_Class = 'R') )
     goto bypass_tax_balance
   end-if
  #endif
 
  #if {SITE_ID} = 'PFZ1'
    move $C.COMPANY to $PFE_Company
    move $Qtr_End_Native to $PFE_sysdate
    do Check-Company-Catagory
    if $PFE_Catagory <> 'A'
     goto bypass_tax_balance
    end-if
  #endif
 
 #if {SITE_ID} = 'ECR1'
   move $C.COMPANY to $Check_Company
   do Check-EMC-Record
   if $Process_Tax_Record <> 't'     !7/3/02 fix
     goto bypass_tax_balance
   end-if
 #endif
 
 ! -------------- 4/3/00 no memo PA OPTs --------------------------------------
 #if {Peoplesoft_Version} >= '7.51'
   if ($Cur_Tax_Class = 'P') AND ($Cur_State = 'PA') AND ($Cur_Locality = '')
    let $Process_Tax_Record = 'f'
   end-if
 #endif
 
  if $SelectEmplid <> '' or $C.Emplid = '{TESTING_EMPLID}'
    show 'Process_Tax_Record = ' $Process_Tax_Record ' for ' &C.EMPLID ' in ' $C.COMPANY ' $Current_Company = ' $Current_Company ' $Current_Emplid = ' $Current_Emplid
  end-if 

 if $Process_Tax_Record = 't'
  Add 1 to #ps_tax_balance_count
 
  #ifdef SUBTOTAL_FEIN_EXTRACT
    if (rtrim(&C.EMPLID,' ') <> $Current_Emplid) or (&CO.FEDERAL_EIN <> #Current_FEIN)
  #else
   #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      if (rtrim(&C.EMPLID,' ') <> $Current_Emplid) or (&CT.TF_COMPANY <> $Current_ADP_Compid)
   #else
    if (rtrim(&C.EMPLID,' ') <> $Current_Emplid) or (rtrim($C.COMPANY,' ') <> $Current_Company)
   #endif
  #endif
 
  #ifdef SUBTOTAL_FEIN_EXTRACT
    if (rtrim($Current_Emplid,' ') <> '') and (#Current_FEIN <> 0)
  #else
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
       if (rtrim($Current_Emplid,' ') <> '') and (rtrim($Current_ADP_Compid,' ') <> '')
     #else
       if (rtrim($Current_Emplid,' ') <> '') and (rtrim($Current_Company,' ') <> '')
     #endif
  #endif
 
      if (rtrim($Personal_emplid,' ') <> '')
        #ifdef KJDA              !KJDA for Custom KJDA Clients: Papajohns  5/31/05, Yum
          do Include-KJDA
        #endif
        if $Current_Emplid = '{TESTING_EMPLID}'
          show 'calling Process-Quarterly-Record for ' $Current_Emplid
        end-if
        do Process-Quarterly-Record
      else
       #debugd show 'Personal emplid is blank for ' $Current_Emplid
      end-if
 
      let #Last_TaxBalance_Cnt= 0
      clear-array name=TaxBalance
 
      !on EMPLID break, we may also have a COMPANY or TF_COMPANY break, to invoke the Process-Misc-Employees
      !-----------------------------------------------------------------------------------------------------
 
      #ifdef SUBTOTAL_ADP_COMPID_EXTRACT  !this section added 12/15/07
        if (rtrim(&CT.TF_COMPANY,' ') <> $Current_ADP_Compid) AND (rtrim($Current_ADP_Compid,' ') <> '')
          if $adp_w2_records = 't'
           let $misc_box_only = 'n'  !resets the flag before next company
           do Process-Misc-Employees !get ee's that are NOT in tax balances
           let $misc_box_only = 'n'  !resets the flag before next company
          end-if
        end-if
 
      #else
 
         if rtrim($C.COMPANY,' ') <> $Current_Company and rtrim($Current_Company,' ') <> ''
          if $adp_w2_records = 't'
           let $misc_box_only = 'n'  !resets the flag before next company
           do Process-Misc-Employees !get ee's that are NOT in tax balances
           let $misc_box_only = 'n'  !resets the flag before next company
          end-if
         end-if
 
      #endif
    end-if
 
    let $Current_Emplid =  rtrim(&C.EMPLID,' ')
    let $Input_State  =  rtrim($TB_State,' ')
    let $C_Company = rtrim($C.COMPANY,' ')
 
       do Init-Job-Data            !MOVED HERE ON 6/12/02
       do get-job-data
       do Extract-Personal-Data
       do Process-Employee-Record
 
       add 1 to #employee_total
 
       #ifdef BIG_CLIENT
         if mod(#employee_total,5000) = 0
       #else
         if mod(#employee_total,100) = 0
       #endif 
       do Get-Current-DateTime
       show '----> Status: Employee Count... ' #employee_total '  --> ' $AsOfNow
 
  end-if
 
  end-if

  if rtrim($C.COMPANY,' ') <> rtrim($Current_Company,' ')
       if rtrim($Current_Company,' ') <> ''
 
          #ifdef SUBTOTAL_COMPANY
           let $ReportID     = '{QUARTERLY_REPORT_ID}'
           let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly Extract, Ending ' || $Qtr_End_Native
           Let #Tot = 1
           Let $State = ' '
           Let $Locality = ' '
           show '  Print-TaxBalance-Recap,  $Current_Company ' $Current_Company ' $C.COMPANY = ' $C.COMPANY
           Do Print-TaxBalance-Recap
           New-Page
           #ifdef KJDA
             do Summarize-KJDA-Company
           #endif
 
           #if {Quarterly_extract_specs} >= '3.01'
                 if $adp_w2_records = 't'
                     let #Tot = #DomesticInx  !Domestic Company Totals
                     do Print-Company-Recap
                     do Init-Company-totals
                     do Init-Company-totals-PR
                     #ifndef SKIP_1099_PRINT
                       #ifdef Process_1099s
                         let #Tot = #DomesticInx
                         do Print-Company-Recap-1099s
                       #endif
                     #endif
                 end-if
           #endif
 
          #endif
 
          let #Company_Total_Tax_Qtd_Not_Generated = 0
          let #Company_Total_Tax_Ytd_Not_Generated = 0
          let #Company_Total_Tax_Qtd = 0
          let #Company_Total_Tax_Ytd = 0
 
          let #Unknown_Tax_Qtd = 0
          let #Unknown_Tax_Ytd = 0
 
          let #Company_Total_Tip_Wages_Qtd = 0
          let #Company_Total_Tip_Wages_Ytd = 0
          let #Company_Total_Tip_Tax_Qtd = 0
          let #Company_Total_Tip_Tax_Ytd = 0
 
          let #Company_Total_Txgrs_Qtd  = 0
          let #Company_Total_Nlgrs_Qtd  = 0
          let #Company_Total_Txgrs_Ytd  = 0
          let #Company_Total_Nlgrs_Ytd  = 0
 
          let #Company_Total_Tax_Federal_Qtd   = 0
          let #Company_Total_Tax_SIT_Qtd       = 0
          let #Company_Total_Tax_SUI_Qtd       = 0
          let #Company_Total_Tax_SPCL_SUI_Qtd  = 0
          let #Company_Total_Tax_SUI_EE_Qtd    = 0
          let #Company_Total_Tax_SDI_EE_Qtd    = 0
          let #Company_Total_Nlgrs_SUI_Qtd     = 0
          let #Company_Total_Nlgrs_SPCL_SUI_Qtd = 0
          let #Company_Total_Nlgrs_SUI_EE_Qtd  = 0
          let #Company_Total_Nlgrs_SDI_ER_Qtd  = 0
          let #Company_Total_Nlgrs_SDI_EE_Qtd  = 0
          let #Company_Total_Tax_SDI_ER_Qtd    = 0
          let #Company_Total_Tax_Misc_Qtd      = 0
          let #Company_Total_Tax_Local_Qtd     = 0
 
          let #Company_Total_Tax_FLI_EE_Qtd    = 0
          let #Company_Total_Nlgrs_FLI_EE_Qtd  = 0
          let #Company_Total_Tax_VFLI_EE_Qtd   = 0
          let #Company_Total_Nlgrs_VFLI_EE_Qtd = 0
          let #Company_Total_Tax_VFLI_ER_Qtd   = 0
          let #Company_Total_Nlgrs_VFLI_ER_Qtd = 0
          let #Company_Total_Tax_NJSWAF_Qtd    = 0
          let #Company_Total_Nlgrs_NJSWAF_Qtd  = 0
          let #Company_Total_Tax_NJWDPF_Qtd    = 0
          let #Company_Total_Nlgrs_NJWDPF_Qtd  = 0
          let #Company_Total_Tax_NJHCSF_Qtd    = 0
          let #Company_Total_Nlgrs_NJHCSF_Qtd  = 0
          let #Company_Total_Tax_State_FUTA_Qtd = 0
 
          let #Company_Generated_Taxes_Qtd     = 0
          let #Company_Generated_Taxes_Ytd     = 0
 
          let #Company_Total_Tax_Qtd_PRE_Generated = 0
          let #Company_Total_Tax_Ytd_PRE_Generated = 0
 
          let #Ignore_Tax_Qtd = 0
          let #Ignore_Tax_Ytd = 0
 
          let $MOH_YTD_extracted = 'f'
 
       End-if
 
       #ifdef SUBTOTAL_FEIN
 
        if &CO.FEDERAL_EIN <> #Current_FEIN
         if #Current_FEIN <> 0
          let $ReportID     = '{QUARTERLY_REPORT_ID}'
          let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. FEIN ' || $Current_FEIN
          let $Company = ' '
          let $CompanyName = ' '
          Let #Tot = 2
          Let $State = ' '
          Let $Locality = ' '
          Do Print-TaxBalance-Recap
          New-Page
 
          #if {Quarterly_extract_specs} >= '3.01'
           if $adp_w2_records = 't'
             show 'Printing W-2 data for FEIN ' $Current_FEIN
             let #Tot = #FEINInx
             do Print-Company-Recap
             do Init-FEIN-totals
           end-if
          #endif
 
          #ifndef SKIP_1099_PRINT
            #ifdef Process_1099s
              let #Tot = #FEINInx
              do Print-Company-Recap-1099s
            #endif
          #endif
         End-if
 
         let #Current_FEIN = &CO.FEDERAL_EIN              !3/28/01 changes
         move #Current_FEIN to $FedEIN 099999999
         move $FedEIN to $Current_FEIN xx-xxxxxxx
 
         show 'Processing Next FEIN --> ' $Current_Fein
 
         Let #Last_TaxBalance_Cnt = 0        ! count of tax bins for an employee
         clear-array name=TaxBalance
 
         Do Init-Report
        End-if  !new fein
 
      #endif
 
       #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
 
        if rtrim(&CT.TF_COMPANY,' ') <> $Current_ADP_Compid
         if rtrim($Current_ADP_Compid,' ') <> ''
          let $ReportID     = '{QUARTERLY_REPORT_ID}'
          #if {SITE_ID} = 'CZB1'
            let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Rollup Company ' || $Current_ADP_Compid
          #else
            let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. ADP Compid ' || $Current_ADP_Compid
          #endif
          let $Company = ' '
          let $CompanyName = ' '
          Let #Tot = 2
          Let $State = ' '
          Let $Locality = ' '
          show 'Print-TaxBalance-Recap for company ' $Current_ADP_Compid
          Do Print-TaxBalance-Recap
          New-Page
 
          #if {Quarterly_extract_specs} >= '3.01'
           if $adp_w2_records = 't'
             let #Tot = #FEINInx
             do Print-Company-Recap
             do Init-FEIN-totals
           end-if
          #endif
 
          #ifndef SKIP_1099_PRINT
            #ifdef Process_1099s
              let #Tot = #FEINInx
              do Print-Company-Recap-1099s
            #endif
          #endif
         End-if
 
         let $Current_ADP_Compid = rtrim(&CT.TF_COMPANY,' ')
         show 'Processing Next ADP Compid --> ' $Current_ADP_Compid
 
         Let #Last_TaxBalance_Cnt = 0        ! count of tax bins for an employee
         clear-array name=TaxBalance
 
         Do Init-Report
        End-if  !new fein
 
      #endif
 
      let $Current_Company = rtrim($C.COMPANY,' ')
      let $Company = rtrim($C.COMPANY,' ')
      do get-company-data
 
      #ifndef SUBTOTAL_FEIN
       #ifndef SUBTOTAL_ADP_COMPID_EXTRACT
        let #Current_FEIN = &CT.FEDERAL_EIN
        move #Current_FEIN to $FedEIN 099999999
        move $FedEIN to $Current_FEIN xx-xxxxxxx
 
        Let #Last_TaxBalance_Cnt = 0        ! count of tax bins for an employee
        clear-array name=TaxBalance
        show 'Processing Next Company --> '$Current_Company ',  FEIN: ' $Current_FEIN ', Total Associate Count = ' #employee_total
       #endif
      #endif
 
      if rtrim($adp_w2_records,' ') = 't'
        do Get-W2_REPORTING_CO
      end-if
 
      #ifndef SKIP_SUI_SUMMARY
          Do Load-SUI-Array
      #endif
      Do Init-Report
      Let #ErrorCnt = 0
 
  End-if  !new company
 
  if (rtrim($Personal_emplid,' ') = '')
       add &C.TAX_QTD   to #Missing_TAX_QTD
       add &C.TAX_YTD   to #Missing_TAX_YTD
       show 'Due to Missing Qtr-End Data, QTD Taxes Bypassed = ' &C.TAX_QTD ', Taxcode ' $TB_State &C.TAX_CLASS $TB_Locality
  end-if
 
!#ifndef STRIPPED_PBZQTR_REPORT
  if $RptDetail = 'Y'
     Do Print-TaxBalance-Detail
  end-if
!#endif
 
  !10/14/05 for imih / SOURCE_INTER
  #ifdef PAYGROUP_TO_EXCLUDE  !Excludes a single paygroup across all companies
   if rtrim($Job_Paygroup,' ') = '{PAYGROUP_TO_EXCLUDE}'
    goto  bypass_tax_balance
   end-if
  #endif
 
  #ifdef PAYGROUP_TO_PROCESS !Handles a Single paygroup to process across all companies
    if rtrim($Job_Paygroup,' ') <> '{PAYGROUP_TO_PROCESS}'
     goto  bypass_tax_balance
    end-if
  #endif
 
  let #NLGRS_QTD_T   = 0
  let #TXGRS_QTD_T   = 0
  let #TAX_QTD_T     = 0
  let #Tip_Wages_QTD = 0
  let #Tip_Tax_QTD   = 0
  let #NLGRS_YTD_T   = 0
  let #TXGRS_YTD_T   = 0
  let #TAX_YTD_T     = 0
  let #Tip_Wages_YTD = 0
  let #Tip_Tax_YTD   = 0
 
  !6/25/7 added
  !------------
  #ifdef MONTHLY_BALANCING_ENABLED
   if #RptPeriod <> 0
     if &C.BALANCE_PERIOD = #RptPeriod
      let #NLGRS_QTD_T = &C.NLGRS_MTD
      let #TXGRS_QTD_T = &C.TXGRS_MTD
      let #TAX_QTD_T   = &C.TAX_MTD
     end-if
     let #NLGRS_YTD_T = &C.NLGRS_YTD
     let #TXGRS_YTD_T = &C.TXGRS_YTD
     let #TAX_YTD_T   = &C.TAX_YTD
   else
     if &C.BALANCE_QTR = #RptQtr
      let #NLGRS_QTD_T = &C.NLGRS_QTD
      let #TXGRS_QTD_T = &C.TXGRS_QTD
      let #TAX_QTD_T   = &C.TAX_QTD
     end-if
     let #NLGRS_YTD_T = &C.NLGRS_YTD
     let #TXGRS_YTD_T = &C.TXGRS_YTD
     let #TAX_YTD_T   = &C.TAX_YTD
   end-if
  #else
   if &C.BALANCE_QTR = #RptQtr
    let #NLGRS_QTD_T = &C.NLGRS_QTD
    let #TXGRS_QTD_T = &C.TXGRS_QTD
    let #TAX_QTD_T   = &C.TAX_QTD
   end-if
   let #NLGRS_YTD_T = &C.NLGRS_YTD
   let #TXGRS_YTD_T = &C.TXGRS_YTD
   let #TAX_YTD_T   = &C.TAX_YTD
  #endif
 
  #ifdef MAP_OR_TRI_MET_TAXABLE_INTO_SUBJECT
    if $TB_State = 'OR' and $TB_Locality = rtrim('{MAP_OR_TRI_MET_TAXABLE_INTO_SUBJECT}',' ')
      if $SelectEmplid <> '' or $C.Emplid = '{TESTING_EMPLID}'
        show 'Process_Tax_Record remapping Subject from Taxable for OR, Locality: {MAP_OR_TRI_MET_TAXABLE_INTO_SUBJECT}'
      end-if 
      let #NLGRS_QTD_T = #TXGRS_QTD_T
      let #NLGRS_YTD_T = #TXGRS_YTD_T
    end-if
  #endif
   
  #if {Client_ID} = 'OSM1'
   if $TB_State = 'CA' and &C.TAX_CLASS = 'D'        !calculate CAD taxes, not in PeopleSoft for OSM1
    do Get-CA-SDI-Rate  !in OSM1 probiz.sqc file
    let #Tax_QTD_T = #TXGRS_QTD_T * #CA_SDI_Rate
    let #Tax_YTD_T = #TXGRS_YTD_T * #CA_SDI_Rate
   end-if
 #endif
 
   if ($Cur_State = '$U') AND
     ( ($Cur_Tax_Class = 'G') OR ($Cur_Tax_Class = 'J') OR ($Cur_Tax_Class = 'T') OR ($Cur_Tax_Class = 'Z') )
 
       #ifdef IGNORE_TIPS_TAX_CLASSES
         goto bypass_tax_balance_tips_logic
       #endif
 
          let #Tip_Wages_YTD = #TXGRS_YTD_T
          let #Tip_Tax_YTD   = #TAX_YTD_T
 
          if &C.BALANCE_QTR = #RptQtr
            let #Tip_Wages_Qtd = #TXGRS_Qtd_T
            let #Tip_Tax_Qtd   = #TAX_Qtd_T
          end-if
 
bypass_tax_balance_tips_logic:
   end-if
 
  #ifdef TIPS_ROLLUP
    if (($Cur_Tax_Class = 'G') AND ($Cur_State = '$U'))
         !OASDI TIPS EE goes into FICA OASDI BIN $UG --> $UD Bin
         !---------------------------------------------------
         move 'D' to $Cur_Tax_Class
    end-if
 
    if (($Cur_Tax_Class = 'J') AND ($Cur_State = '$U'))
         !OASDI TIPS ER goes into FICA OASDI BIN $UJ --> $UE Bin
         !---------------------------------------------------
         move 'E' to $Cur_Tax_Class
    end-if
 
    if (($Cur_Tax_Class = 'T') AND ($Cur_State = '$U'))
         !MEDIC TIPS EE goes into FICA MEDIC BIN $UT --> $UF Bin
         !---------------------------------------------------
         move 'F' to $Cur_Tax_Class
    end-if
 
    if (($Cur_Tax_Class = 'Z') AND ($Cur_State = '$U'))
         !MEDIC TIPS ER goes into FICA MEDIC BIN $UQ --> $UE Bin
         !---------------------------------------------------
         move 'Q' to $Cur_Tax_Class
    end-if
 #endif
 
 #if {SITE_ID} = 'ELI1'
     if $Current_Company = 'LYR' AND $DeptId = '1001042'
         let $Cur_State     = substr('{FORM1042_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM1042_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM1042_Taxcode}',4,9)
     end-if
  #endif
 
  #if {SITE_ID} = 'FRB1'               ! 8/21/06
    if ($Current_Company = '10J')
      if ($Cur_Locality = '20000') AND ($Cur_State = 'CO') AND ($Cur_Tax_Class = 'H')
        move '20000-E' to $Cur_Locality        ! Exempt locality code
      end-if
    end-if
  #endif
 
  #if {SITE_ID} = 'ALB1'                         ! 11/1/00 945P logic for Albemarle
   if $Cur_State = '$U' AND $Cur_Tax_Class = 'H'
     if $Current_Company = 'APT'
         let $Cur_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM945P_Taxcode}',4,9)
     end-if
   end-if
  #endif
 
  #if {SITE_ID} = 'FTO1'
   if $Cur_State = '$U' AND $Cur_Tax_Class <> 'U' AND $Job_Paygroup = '193'  !Farmers
         let $Cur_Locality  = '{FORM943_Taxcode}'
   end-if
  #endif
 
  #if {SITE_ID} = 'ELI1'                         !4/10/01 945P logic for Lilly
   if $Cur_State = '$U' AND $Cur_Tax_Class = 'H'
     if $Current_Company = 'LYR'
         let $Cur_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM945P_Taxcode}',4,9)
     end-if
   end-if
  #endif
 
  #if {SITE_ID} = 'IDP1'                         ! 3/19/01 945 logic for IBC
   if $Cur_State = '$U' AND $Cur_Tax_Class = 'H'
     if $Current_Company = 'RET'
         let $Cur_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM945P_Taxcode}',4,9)
     end-if
   end-if
  #endif
 
  #if {SITE_ID} = 'DOW1'
   if $Cur_State = '$U' AND $Cur_Tax_Class = 'H'
     if $Current_Company = 'C04'
         let $Cur_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM945P_Taxcode}',4,9)
     end-if
   end-if
  #endif
 
  #if {SITE_ID} = 'FDC1'          !4/12/01 logic for First Data for 945P ee's
   #ifdef REMAP_WUP_NVP_TO_945P
    if rtrim($Current_Company,' ') =  '$UH'
     if $Current_Company = 'NVP'  OR $Current_Company = 'WUP'
         let $Cur_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM945P_Taxcode}',4,9)
     end-if
    end-if
   #endif
  #endif
 
  #ifdef TAX_UPDATE_OVERRIDE
    let $Tax_Update = '{TAX_UPDATE_OVERRIDE}'
    if $SelectEmplid <> ''
      show 'TAX_UPDATE_OVERRIDE: ' $Tax_Update
    end-if
  #endif
 
  #ifndef Skip_Rimini_Medicare_Surcharge
     #ifdef FORCE_MEDICARE_SURCHARGE_CALC
       if #RptYear = {FORCE_MEDICARE_SURCHARGE_CALC} and ($Cur_State = '$U' AND $Cur_Tax_Class = 'F')
         do Rimini_Medicare_Surcharge
       end-if
     #else
       if (substr($Tax_Update,1,1) = 'R' or substr($Tax_Update,1,1) = 'C' or substr($Tax_Update,1,6) = '103144' or substr($Tax_Update,1,6) = '103800' or
         substr($Tax_Update,1,6) = '2012-A' or substr($Tax_Update,1,6) = '2012-B' or substr($Tax_Update,1,6) = '2012-C' or substr($Tax_Update,1,6) = '2012-D' or
         substr($Tax_Update,1,6) = '2012-E')  ! calculate the $U7 amounts if client still running older 2012 tax udpates (2012-F was the first update with '7')
         and ($Cur_State = '$U' AND $Cur_Tax_Class = 'F')
         do Rimini_Medicare_Surcharge
       end-if
     #endif
     
  #endif
 
 
  #ifdef LOCAL_RECIPROCITY
    if rtrim($Cur_Locality,' ') <> '' and rtrim($RES_PSD_CD1,' ') = '' and rtrim($WORK_PSD_CD1,' ') = ''  !PSD code logic added: 08292013, updated to use rtrim 20130320
      do Split-locality-totals
      if $log_type = 'error'       !no split was possible due to out of balances
        move '' to $Cur_Resident
        do update-tax-balances
      end-if
    else
     move '' to $Cur_Resident
     do update-tax-balances
    end-if
  #else
    move '' to $Cur_Resident
    do update-tax-balances
    #if {SITE_ID} = 'SOL1'
     if #RptYear = 2009 and #RptQtr = 3 and ($Current_Company = '501' or $Current_Company = '507')
       do Sol1-reduce-by-transfer-checks     !in adpsol1.sqc
     end-if
    #endif
  #endif
 
  !20121118 reworked
  #ifdef GENERATE_STATE_FUTA
     evaluate $STATE_FUTA_TAX_CLASS  ! 4 means 'generate it',  6 or S mean it's in the balances
      when = 'S'  !Rimini
        if ($Cur_State <> '$U' AND $Cur_Tax_Class = 'S')
          do report-state-futa  !adpstfut.sqc
        end-if
        break
      when = '6'  !PeopleSoft 9.1 or greater
        if ($Cur_State <> '$U' AND $Cur_Tax_Class = '6')
          do report-state-futa  !adpstfut.sqc
          let $report_state_futa_Tax_Class_6 = 't'
        end-if
        break
      when = '4'  !PeopleSoft  < 9.1
        if $Cur_State = '$U' AND $Cur_Tax_Class = 'U'
 
          #ifndef STATE_FUTA_SKIP_GENERATION_CODE
           do Generate-State-Futa  !adpstfut.sqc
          #endif
 
        end-if
        break
      when-other
        break
      end-evaluate
   #endif
 
 end-if
 
bypass_tax_balance:
 
 #ifdef SUBTOTAL_FEIN
  FROM PS_TAX_BALANCE{WAREHOUSE_SUFFIX} C {NOLOCK_SQL}, PS_COMPANY_TBL CO {NOLOCK_SQL}
 #else
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
    FROM PS_TAX_BALANCE{WAREHOUSE_SUFFIX} C {NOLOCK_SQL}, PS_TF_COMPANY_XREF CT {NOLOCK_SQL}
  #else
    #if {SITE_ID} = 'PFZ1'
      #if {USE_GBL_TAX_BAL} = 'Y'
        FROM (SELECT *
                FROM PS_TAX_BALANCE{WAREHOUSE_SUFFIX} {NOLOCK_SQL}
               WHERE NOT (
                             company = '200'
                         AND state = '$U'
                         AND locality = ' '
                         AND tax_class IN ('D', 'E', 'F', 'Q')
                         )
              UNION
              SELECT *
                FROM ps_z_gbl_tax_bal) C
      #else
        FROM PS_TAX_BALANCE{WAREHOUSE_SUFFIX} C {NOLOCK_SQL}
      #endif
    #else
      FROM PS_TAX_BALANCE{WAREHOUSE_SUFFIX} C {NOLOCK_SQL}
    #endif
  #endif
 #endif
 
 #ifdef JOIN_COMPANY_TBL
       , PS_COMPANY_TBL CO {NOLOCK_SQL}
 #endif
 
  #ifdef MULTIPLE_SITES
    ,{INSTALLATION_TABLE} TFIC {NOLOCK_SQL}
  #endif
 
   #ifdef USE_INT_CRITERIA
     WHERE C.BALANCE_YEAR    = int(\$RptYearZ\)
   #else
     WHERE C.BALANCE_YEAR    = #RptYear
   #endif

      AND C.BALANCE_ID      = $Calendar_Year_Id
 
     #if {SITE_ID} = 'SRC1'
        [$SelectEmplid_Where]
     #endif
 
     #ifdef TEST_EMPLID_IN_RUN_CONTROL
       #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
         \$SelectEmplidSelection\
       #else
         [$SelectEmplidSelection]
       #endif
     #endif
 
     #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
       \$CompanySelection\
     #else
       [$CompanySelection]
     #endif
 
     #ifdef COMPANY_TO_PROCESS
      AND C.COMPANY = '{COMPANY_TO_PROCESS}'
     #endif
 
     #if {SITE_ID} = 'HWL1'
       [$HON_COMPANIES_TO_EXCLUDE]
     #endif
 
     #ifdef MULTIPLE_SITES !7/2/10 reworked due to dupliate rows being pulled
       AND ((TFIC.{WGPS_SITE_FIELD} = $TFI_Site
          AND C.COMPANY NOT IN (SELECT TFICC.COMPANY FROM {ALT_SITES_CO_TABLE} TFICC))
        OR (TFIC.{WGPS_SITE_FIELD} <> $TFI_Site
          AND C.COMPANY IN (SELECT TFACC.COMPANY FROM {ALT_SITES_CO_TABLE} TFACC
                           WHERE TFACC.{WGPS_SITE_FIELD} = $Alt_Site)))
     #endif
 
 
     #ifdef USE_EFF_STATUS_TF_COMPANY_TBL
      #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
        \$TF_COMPANY_TBL_INCLUDE\
      #else
        [$TF_COMPANY_TBL_INCLUDE]
      #endif
     #endif
 
 
     #ifdef PROCESS_WF_EMPLOYEE_SPLIT_QUERY
       AND C.COMPANY = $get-company
       AND C.EMPLID  = $get-emplid
     #endif
 
 
     #ifdef COMPANIES_TO_EXCLUDE
      AND NOT C.{COMPANIES_TO_EXCLUDE}
     #endif
 
     #if {SITE_ID} = 'WFG1'
      ! wells custom - mc06862
         #ifdef STATE_TAX_CLASS_TO_EXCLUDE_1
          AND NOT {STATE_TAX_CLASS_TO_EXCLUDE_1}
                  {STATE_TAX_CLASS_TO_EXCLUDE_2}
         #endif
     ! wells custom - mc06862 - end
     #endif
 
     #if {SITE_ID} = 'WFG1'
         #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
           \$WFG1_COMPANIES_TO_EXCLUDE\
         #else
           [$WFG1_COMPANIES_TO_EXCLUDE]
         #endif
     #endif
     #ifdef EMPLIDS_TO_INCLUDE              !eg. in adpclien.sqc: #define EMPLIDS_TO_INCLUDE  EMPLID IN ('XXXX','YYYY','ZZZZ')
      AND C.{EMPLIDS_TO_INCLUDE}
     #endif
 
     #ifdef SUBTOTAL_FEIN
      #ifdef TEST_FEIN
       AND CO.FEDERAL_EIN = {TEST_FEIN}
      #endif
     #endif
 
     #ifdef COMPANIES_TO_PROCESS
      AND C.COMPANY in {COMPANIES_TO_PROCESS}
     #endif
 
     #if {SITE_ID} = 'MTBI'             !TJL - Exclude Puerto Rico 20121220
       AND (C.COMPANY < '300')          !TJL
     #endif                             !TJL
 
     !Sri, 1/11/05...Please include companies BETWEEN (650 - 699)
     !-------------------------------------------------------------------------
     #if {SITE_ID} = 'GEC1'
       AND ( (C.COMPANY BETWEEN '650'AND '699') or (C.COMPANY = '630') )
     #endif
 
     #if {SITE_ID} = 'CBL1'
      AND C.COMPANY <> '701'
      AND C.COMPANY <> '703'
      AND C.COMPANY <> '888'
      AND C.COMPANY <> '999'
     #endif
 
     #if {SITE_ID} = 'PPL1'
      AND C.COMPANY <> 'RES'
     #endif
 
     #ifdef TEST_EMPLID
       AND C.EMPLID = '{TEST_EMPLID}'
     #endif
 
     #if {SITE_ID} = 'SQP1'
       [$SecurityClauseWithoutERN]       !select just the rows allowed.
     #endif
 
     AND C.BALANCE_PERIOD  = (SELECT
 
     #ifdef USE_psatax_balance_index
      /*+ index (PS_TAX_BALANCE{WAREHOUSE_SUFFIX} psatax_balance) */
     #endif
 
     MAX(BALANCE_PERIOD)
 
 #if {SITE_ID} = 'PFZ1'
   #if {USE_GBL_TAX_BAL} = 'Y'
     FROM (SELECT *
             FROM PS_TAX_BALANCE{WAREHOUSE_SUFFIX} {NOLOCK_SQL}
            WHERE NOT (
                          company = '200'
                      AND state = '$U'
                      AND locality = ' '
                      AND tax_class IN ('D', 'E', 'F', 'Q')
                      )
           UNION
           SELECT *
             FROM ps_z_gbl_tax_bal)
   #else
     FROM  PS_TAX_BALANCE{WAREHOUSE_SUFFIX} {NOLOCK_SQL}
   #endif
 #else
     FROM  PS_TAX_BALANCE{WAREHOUSE_SUFFIX} {NOLOCK_SQL}
 #endif
 
       WHERE  COMPANY       = C.COMPANY
         AND  EMPLID        = C.EMPLID
         AND  STATE         = C.STATE
         AND  LOCALITY      = C.LOCALITY
         #ifdef PAACT_32_11F_Logic                 !3/12/2012 added
         AND  WORK_PSD_CD   = C.WORK_PSD_CD
         AND  RES_PSD_CD    = C.RES_PSD_CD
         #endif
         AND  TAX_CLASS     = C.TAX_CLASS
         AND  BALANCE_ID    = C.BALANCE_ID
         AND  BALANCE_YEAR  = C.BALANCE_YEAR
 
       #ifdef MONTHLY_BALANCING_ENABLED
         AND  BALANCE_PERIOD  <= #SelectedMonth)
       #else
         #ifdef USE_INT_CRITERIA
            AND  BALANCE_PERIOD  <= int(\$RptMonthZ\))
         #else
            AND  BALANCE_PERIOD  <= #RptMonth)
         #endif
       #endif
 
         #ifdef SUBTOTAL_FEIN
          AND C.COMPANY = CO.COMPANY
          AND CO.EFFDT = (SELECT MAX(EFFDT)
           FROM   PS_COMPANY_TBL CO1 {NOLOCK_SQL}
           WHERE  CO1.COMPANY = CO.COMPANY
             AND  CO1.EFFDT  <= $AsOfDate)
         #endif
 
         #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
           AND CT.COMPANY = C.COMPANY
           AND CT.EFFDT = (SELECT MAX(CT2.EFFDT)
                FROM PS_TF_COMPANY_XREF CT2 {NOLOCK_SQL}
                WHERE CT2.COMPANY = CT.COMPANY
                  AND CT2.EFFDT  <= $AsOfDate)
         #endif
 
    #if {SITE_ID} = 'GE01'
     AND {GE_DEPT_TYPE_LIST}
     AND CO.COMPANY = C.COMPANY
     AND CO.EFFDT =
      (SELECT MAX(EFFDT)
       FROM   PS_COMPANY_TBL CO1 {NOLOCK_SQL}
       WHERE  CO1.COMPANY = CO.COMPANY
         AND  CO1.EFFDT  <= $AsOfDate)
 
      #ifndef ADP_TAX_AMEND
          #ifdef Process_1099s_only
            AND CO.TAX_REPORT_TYPE = 'R'
          #endif
      #endif
      #ifdef Process_w2s_only
        AND CO.TAX_REPORT_TYPE <> 'R'
      #endif
 
    #endif
 
    !added 9/19/06 to eliminate selects if all QTD and YTD taxes and wages are zero
    !---------------------------------------------------------------------------------------------------------------------
    #ifndef ALLOW_ALL_ZERO_QTD_and_YTDs
     #ifdef MONTHLY_BALANCING_ENABLED
      AND (C.NLGRS_QTD <> 0 OR C.TXGRS_QTD <> 0 OR C.TAX_QTD <> 0 OR        !8/20/07
           C.NLGRS_YTD <> 0 OR C.TXGRS_YTD <> 0 OR C.TAX_YTD <> 0 OR
           C.NLGRS_MTD <> 0 OR C.TXGRS_MTD <> 0 OR C.TAX_MTD <> 0)
     #else
      AND (C.NLGRS_QTD <> 0 OR C.TXGRS_QTD <> 0 OR C.TAX_QTD <> 0 OR
           C.NLGRS_YTD <> 0 OR C.TXGRS_YTD <> 0 OR C.TAX_YTD <> 0)
     #endif
    #endif
 
  !6/19/06... not working for JUST SUBTOTAL_FEIN, modified to below
  !-----------------------------------------------------------------
  #ifdef SUBTOTAL_FEIN
      #ifdef SUBTOTAL_FEIN_EXTRACT
        ORDER BY CO.FEDERAL_EIN, C.EMPLID, C.COMPANY, C.STATE, C.TAX_CLASS    !
      #else
        ORDER BY CO.FEDERAL_EIN, C.COMPANY, C.EMPLID, C.STATE, C.TAX_CLASS   ! < 1/13/06
      #endif
  #else
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
       ORDER BY CT.TF_COMPANY, C.EMPLID, C.COMPANY, C.STATE, C.TAX_CLASS    !
     #else
       ORDER BY C.COMPANY, C.EMPLID, C.STATE, C.TAX_CLASS                    !
     #endif
  #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure

begin-procedure Post-Tax-Balance-Processing
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Post-Tax-Balance-Processing' to $debug-proc1
     move 'PS_TAX_BALANCE'    to $debug-table1
     do log-delta-time
  #endif
 
  show 'Count of Tax_Balance Records read = ' #ps_tax_balance_count
 
  !12/26/7 added this section for single emplid testing
  !-------------------------------------------------------
  if rtrim($C.Company,' ') = '' and $SelectEmplid <> ''
      if $adp_w2_records = 't'
        let $misc_box_only = 'n'  !resets the flag before next company
        let $Misc_C_Company = ''
        do Process-Misc-Employees
        let $misc_box_only = 'n'  !resets the flag before next company
      end-if
  end-if
  !--------------------------------
 
  if rtrim($C.Company,' ') <> '' OR rtrim($Misc_C_Company,' ') <> ''
 
    if rtrim($C.Company,' ') = ''
      goto continue_totals
    end-if
 
    if rtrim($Current_Company,' ') = ''             !added 6/19/06
      let $Current_Company = rtrim($C.COMPANY,' ')
      let $Company = rtrim($C.COMPANY,' ')
      do get-company-data
    end-if
 
    if rtrim($Current.Emplid,' ') = ''                   !added 6/19/06
      let $Current_Emplid = rtrim($C.Emplid,' ')
    end-if
 
    !we need to ouput a Final quarterly record first!
    !-----------------------------------------------
    if rtrim($Current_Emplid,' ') <> ''
 
       if #Last_TaxBalance_Cnt > 0
 
        #ifdef KJDA              !KJDA for Custom KJDA Clients: Papajohns  5/31/05, Yum
          do Include-KJDA
        #endif
 
        do Process-Quarterly-Record
        let #Last_TaxBalance_Cnt= 0
        clear-array name=TaxBalance
        if $adp_w2_records = 't'
          let $misc_box_only = 'n'  !resets the flag before next company
          do Process-Misc-Employees
          let $misc_box_only = 'n'  !resets the flag before next company
        end-if
 
      end-if
 
    else  !Get misc W-2 records for test emplid even if no tax balances
      if $SelectEmplid <> ''
        if $adp_w2_records = 't'
          let $misc_box_only = 'n'  !resets the flag before next company
          do Process-Misc-Employees
          let $misc_box_only = 'n'  !resets the flag before next company
        end-if
      end-if
    end-if
 
continue_totals:
 
    #ifdef SUBTOTAL_COMPANY
     let $State = ' '
     let $Locality = ' '
     let $ReportID     = '{QUARTERLY_REPORT_ID}'
     let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly Extract, Ending ' || $Qtr_End_Native
     Let #Tot = 1
     Do Print-TaxBalance-Recap
     New-Page
     #ifdef KJDA
       do Summarize-KJDA-Company
     #endif
     #if {Quarterly_extract_specs} >= '3.01'
           let #Tot = #DomesticInx  !Domestic W-2 Company Totals
           do Print-Company-Recap
           do Init-Company-totals
           do Init-Company-totals-PR
 
           #ifndef SKIP_1099_PRINT
             #ifdef Process_1099s
               let #Tot = 0
               do Print-Company-Recap-1099s
             #endif
           #endif
     #endif
    #endif
 
    #ifdef SUBTOTAL_FEIN
      Let $State = ' '
      Let $Locality = ' '
      let $ReportID     = '{QUARTERLY_REPORT_ID}'
      let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. FEIN ' || $Current_FEIN
      let $Company = 'ALL'
      let $CompanyName = ' '
      Let #Tot = 2
      Do Print-TaxBalance-Recap
      New-Page
 
      #if {Quarterly_extract_specs} >= '3.01'
         if $adp_w2_records = 't'
           #debugd show 'Printing W-2 data for FEIN ' $Current_FEIN
           let #Tot = #FEINInx
           do Print-Company-Recap
 
           #ifndef SKIP_1099_PRINT
              #ifdef Process_1099s
                let #Tot = #FEINInx
                do Print-Company-Recap-1099s
              #endif
           #endif
         end-if
      #endif
    #endif
 
    #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
      Let $State = ' '
      Let $Locality = ' '
      let $ReportID     = '{QUARTERLY_REPORT_ID}'
      #if {SITE_ID} = 'CZB1'
        let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Rollup Company ' || $Current_ADP_Compid
      #else
        let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. ADP Compid ' || $Current_ADP_Compid
      #endif
 
      let $Company = 'ALL'
      let $CompanyName = ' '
      Let #Tot = #FEINInx
      Do Print-TaxBalance-Recap
      New-Page
 
      #if {Quarterly_extract_specs} >= '3.01'
         if $adp_w2_records = 't'
           let #Tot = #FEINInx
           #debugd show 'Printing W-2 data for ADP Compid ' $Current_ADP_Compid ', tot = ' #Tot
           do Print-Company-Recap
 
           #ifndef SKIP_1099_PRINT
              #ifdef Process_1099s
                let #Tot = #FEINInx
                do Print-Company-Recap-1099s
              #endif
           #endif
         end-if
      #endif
 
 
    #endif
 
    #if {Quarterly_extract_specs} >= '3.01'
         if $adp_w2_records = 't'
           let #Tot = #GrandInx     !Grand W-2 Totalss
           #debugd show 'Printing W-2 data for Grand Totals, #GrandInx ' #GrandInx
           do Print-Company-Recap
 
           #ifndef SKIP_1099_PRINT
             #ifdef Process_1099s
               let #Tot = #GrandInx
               do Print-Company-Recap-1099s
             #endif
           #endif
 
           do Print-TaxBalance-Adjustments
         end-if
    #endif
 
    #debugd show 'Process-Employees: TOTAL Miscellaneous (year-end with no balances) ' #tot_misc_empls ' associates extracted.'
    #debugd show ' '
 
    !Full Hash Totals / All Companies
    !--------------------------------
 
    let $Company = 'ALL'
    let $CompanyName = ' '
    let $Current_FEIN = 'ALL'
    let $Current_ADP_Compid = 'ALL'
 
#ifndef STRIPPED_PBZQTR_REPORT
    do print-missing-personal
    do Print-SSN-Errors           !10/27/08 moved from above.. to enable it always
#endif
 
#ifndef SKIP_TAX_AND_WAGE_AUDITS
     do print-audits
     do print-multistate
     do print-voids
#endif
 
   #ifdef WORKSITE_REPORTING
    #ifdef LOG_MWR_SETUP_TBL
     do print-MWR-Audit
    #endif
   #endif
 
   #ifdef INCLUDE_W2C
     if $process_W2C_data = 't'
      do print-w2c-rejects
     end-if
   #endif
 
#ifndef SKIP_FILTER
 
     if #filtered_count > 0
      show 'Printing Hash Totals: calling print-filter-Warnings'
      do print-filter-Warnings        !enabled this for the next major release .. for ALL quarters
     end-if
 
#endif
 
#ifndef SKIP_SUI_SUMMARY
    do print-sui-totals
#endif
  #ifdef GENERATE_STATE_FUTA
      do Summarize-State-Futa
  #endif
#ifndef STRIPPED_PBZQTR_REPORT
    do print-local-totals   !added 4/18/02
#endif
#ifdef PRINT_ZERO_LOCALS
     do print-zero-locals
#endif
#ifdef PRINT_RESIDENT_AUDIT
     do print-resident-audit
#endif
 
#ifndef STRIPPED_PBZQTR_REPORT
    #ifdef LOCAL_RECIPROCITY
      do print-reciprocity
     #ifdef LOCAL_RECIPROCITY_SPECIAL_REPORT
       do Write-special-reciprocity
     #endif
    #endif
#endif
 
    #ifdef PA_PULL_PO_BOX_ADDRESSES
      do PRINT-PA-PULL-PO-BOX-ADDRESSES
    #endif
 
    #ifdef PA_WORKSITE_EXTRACT
      do print-PA-Locality-Summary  !in adppaloc.sqc
    #endif
 
    do Hash-Taxes-Bypassed-Breakout
 
    #ifdef COBRA
      do print-cobra-hash
    #endif
 
    do Print-Hire-Associates  !in adpq210.sqc
 
    #ifdef enable_performance_monitor
      do print-debug-entries
    #endif
 
    let #header_type = 2
    let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly Extract, Ending ' || $Qtr_End_Native
 
    print 'Quarterly Extract Totals for All Companies (GRAND TOTALS)' (+2,1)  {PRINT_HIGHLIGHT}
    print ',  Year : '     ()               {PRINT_HIGHLIGHT}
    print #RptYear         ()   edit 9999   {PRINT_HIGHLIGHT}
    print ',  Quarter : '  ()               {PRINT_HIGHLIGHT}
    print #RptQtr          ()   edit 9      {PRINT_HIGHLIGHT}
 
    #ifdef MULTIPLE_SITES
    print ',  Site_ID : '  ()               {PRINT_HIGHLIGHT}
    print $Site_ID_RC      ()               {PRINT_HIGHLIGHT}
    print ',  Alt_SITE: '  ()               {PRINT_HIGHLIGHT}
    print $Alt_Site        ()               {PRINT_HIGHLIGHT}
    print ',  TFI_SITE: '  ()               {PRINT_HIGHLIGHT}
    print $TFI_Site        ()               {PRINT_HIGHLIGHT}
    #endif
 
    #ifdef MONTHLY_BALANCING_ENABLED
     if #RptPeriod <> 0
      print 'Note: QTD totals on report are actually MTD values for Month: ' (+2,1)  {PRINT_HIGHLIGHT}
      print #RptPeriod         ()   edit 99  {PRINT_HIGHLIGHT}
     end-if
    #endif
 
    if rtrim($SelectEmplid,' ') <> ''
          print ',  For Emplid : ' ()  {PRINT_HIGHLIGHT}
          print $SelectEmplid      ()  {PRINT_HIGHLIGHT}
    end-if
 
    print '*** Use the following Grand Totals to Balance      *** ' (+2,1)
    #if {SITE_ID} = 'JCP1'
      print '    Back to the Grand Totals in the PYP145R.LIS Report.    ' (+1,1)
      move 'PYP145R' to $Balancing_Report
    #else
      print '    Back to the Grand Totals in the TAX010FD, TAX010ST and TAX010PA Reports.' (+1,1)
      move 'TAX010FD, TAX010ST, TAX010PA' to $Balancing_Report
    #endif
 
    #if {Peoplesoft_Version} >= '7.51'
     if round(#PA_OPT_HASH_TOTAL,2) <> 0
      print 'Note, you will need to run the PA OPT Report (TAX010PA)'               (+2,1)
      print 'and add the total PA OPT taxes from that report to the TAX010FD and TAX010ST.' (+1,1)
      print 'The extract has computed the total PA OPT Taxes to be = '              (+1,1)
      print #PA_OPT_HASH_TOTAL   () edit $$$,$$$,$$$,$$9.99mi
      print 'The PA Opt Taxes have been included in this extract report.'           (+1,1)
     end-if
    #endif
 
    print 'On Report(s): ' (+2,1)
    print $Balancing_Report       ()
    print  ', Add the QTD and YTD taxes to balance to the following tax totals.' ()
 
    if round(#Hash_Total_Tax_Qtd_PRE_Generated,2) <> 0
 
      print '  Total Qtd Taxes             = ' (+1,10)
      print #Hash_Total_Tax_Qtd_Not_Generated  ()       edit $$$,$$$,$$$,$$9.99mi
      print '  Total Qtd PR-SDI-ER Taxes   = ' (+1,10)
      print #Hash_Total_Tax_Qtd_PRE_Generated  ()       edit $$$,$$$,$$$,$$9.99mi
 
      let #with_pre_total = #Hash_Total_Tax_Qtd_Not_Generated + #Hash_Total_Tax_Qtd_PRE_Generated
 
      print '  Total Qtd Taxes + Total Qtd PR-SDI-ER Taxes (Balance this to Tax010xx reports) = ' (+1,10)
      print #with_pre_total () edit $$$,$$$,$$$,$$9.99mi
      print '  ** Note, This does NOT include any extract generated taxes, EXCEPT PR-SDI-ER' ()
 
    else
 
      print '  Total Qtd Taxes      = ' (+1,10)
      print #Hash_Total_Tax_Qtd_Not_Generated       ()   edit $$$,$$$,$$$,$$9.99mi
      print '  ** Note, This does NOT include any extract generated taxes' ()
 
    end-if
 
    #if {SITE_ID} = 'CBL1'
       print '* CBL1 ---->  Note, Company 701,703,888 and 999 are NOT included in extract.' (+2,1)
    #endif
 
    #if {SITE_ID} = 'PFZ1'
       print 'Balancing for Pfizer'                                           (+2,1) {PRINT_HIGHLIGHT}
       print 'Company 200, Paygroups 21L,31L,FSL,PHL,A6S,A7S are the International employees.' (+1,1)
       print 'Total International Fica Taxes (Compid 200 WL-FOR, OASDI-EE, MED-EE) = ' (+1,1)
       print #Hash_Total_Tax_WL_FicaEE_Intl                                   () edit $$$,$$$,$$$,$$9.99mi
   #endif
 
   #if {SITE_ID} = 'KFC_OLD'
      print '* KFC1 Professional Services Breakout'  (+2,1)
      print '---------------------------------------'  (+1,1)
 
      print '  Total QTD Flex Taxes (F)    = ' (+1,10)
      print #Hash_Total_Tax_KFC1_F           () edit $$$,$$$,$$$,$$9.99mi
 
      print '  Total QTD Core Taxes (C)    = ' (+1,10)
      print #Hash_Total_Tax_KFC1_C           () edit $$$,$$$,$$$,$$9.99mi
 
      print '  Total QTD Main Taxes (M)    = ' (+1,10)
      print #Hash_Total_Tax_KFC1_M           () edit $$$,$$$,$$$,$$9.99mi
 
      print '  Total QTD Staf Taxes (S)    = ' (+1,10)
      print #Hash_Total_Tax_KFC1_S           () edit $$$,$$$,$$$,$$9.99mi
 
      let #Hash_Total_Tax_KFC1 = #Hash_Total_Tax_KFC1_F + #Hash_Total_Tax_KFC1_C +
                                   #Hash_Total_Tax_KFC1_M + #Hash_Total_Tax_KFC1_S
 
      print '  Total QTD (Core + Flex + Main + Staffing/CA = ' (+1,10)
      print #Hash_Total_Tax_KFC1             () edit $$$,$$$,$$$,$$9.99mi
 
    #endif
 
    #if {SITE_ID} = 'TLL1'
     #ifdef TOLL_FAIRLESS_HILLS_COMPID
       print 'TLL1: Total QTD {TOLL_FAIRLESS_HILLS_COMPID} Taxes = ' (+2,1)
       print #Hash_Total_Tax_NGR2  () edit $$$,$$$,$$$,$$9.99mi
       #debugd show 'TLL1: Total QTD {TOLL_FAIRLESS_HILLS_COMPID} Taxes = ' #Hash_Total_Tax_NGR2
     #endif
    #endif
    
    #ifdef CUSTOM_EMPLOYMENT_TYPE
       print 'CUSTOM_EMPLOYMENT_TYPE QTD Taxes remapped to PEN . = ' (+2,1)
       print #Hash_Total_Tax_CUSTOM_EMPLOYMENT_TYPE  () edit $$$,$$$,$$$,$$9.99mi
       show 'CUSTOM_EMPLOYMENT_TYPE  QTD Taxes remapped to PEN   = ' #Hash_Total_Tax_CUSTOM_EMPLOYMENT_TYPE
    #endif
    
 
    #if {SITE_ID} = 'CHS1'
      do print-CT-location-CHS1 !probiz.sqc
    #endif
    #ifdef GENERAL_SUI_SPLIT_STATE
      do print-sui-split-location !adpuispl.sqc
    #endif
 
    #if {SITE_ID} = 'AFS1'
      print '* Alliant Food Service, Illinois SUI Breakout for Company AFS *'         (+2,1) {PRINT_HIGHLIGHT}
 
      print '  Total QTD IL SUI in LLC     = ' (+1,10)
      print #Hash_Total_Tax_ILU_LLC            () edit $$$,$$$,$$$,$$9.99mi
      print ' (employee count = '              ()
      print #Hash_Count_ILU_LLC                () edit 99999
      print ')'                                ()
 
      print '  Total QTD IL SUI in AFS     = ' (+1,10)
      print #Hash_Total_Tax_ILU_AFS            () edit $$$,$$$,$$$,$$9.99mi
      print ' (employee count = '              ()
      print #Hash_Count_ILU_AFS                () edit 99999
      print ')'                                ()
    #endif
 
    if round(#Hash_Total_Tax_Ytd_PRE_Generated,2) <> 0 ! added 12/13/00
 
      print '  Total Ytd Taxes             = ' (+2,10)
      print #Hash_Total_Tax_Ytd_Not_Generated  ()       edit $$$,$$$,$$$,$$9.99mi
      print '  Total Ytd PR-SDI-ER Taxes   = ' (+1,10)
      print #Hash_Total_Tax_Ytd_PRE_Generated  ()       edit $$$,$$$,$$$,$$9.99mi
 
      let #with_pre_total = #Hash_Total_Tax_Ytd_Not_Generated + #Hash_Total_Tax_Ytd_PRE_Generated
 
      print '  Total Ytd Taxes + Total Ytd PR-SDI-ER Taxes (Balance this to Tax010xx) = ' (+1,10)
      print #with_pre_total () edit $$$,$$$,$$$,$$9.99mi
      print '  ** Note, This does NOT include any extract generated taxes, EXCEPT PR-SDI-ER' ()
 
    else
 
      print '  Total Ytd Taxes      = ' (+2,10)
      print #Hash_Total_Tax_Ytd_Not_Generated       ()     edit $$$,$$$,$$$,$$9.99mi
      print '  ** Note, This does NOT include any extract generated taxes' ()
 
    end-if
 
 
    if round(#TaxBalance_Tax_Ytd_adjusted_hash,2)   <> 0   or
       round(#TaxBalance_Txgrs_Ytd_adjusted_hash,2) <> 0   or
       round(#TaxBalance_Nlgrs_Ytd_adjusted_hash,2) <> 0
     print 'YTD taxes and wages removed due to W-2 voids.' (+2,1)  {PRINT_HIGHLIGHT}
    end-if
 
  if round(#TaxBalance_Tax_Ytd_adjusted_hash,2) <> 0
     print '  Total Ytd Tax removed due to void YTD data   = ' (+1,10)
     print #TaxBalance_Tax_Ytd_adjusted_hash                   ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
    if round(#TaxBalance_Txgrs_Ytd_adjusted_hash,2) <> 0
     print '  Total Ytd Txgrs removed due to void YTD data = ' (+1,10)
     print #TaxBalance_Txgrs_Ytd_adjusted_hash                 ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
    if round(#TaxBalance_Nlgrs_Ytd_adjusted_hash,2) <> 0
     print '  Total Ytd Nlgrs removed due to void YTD data = ' (+1,10)
     print #TaxBalance_Nlgrs_Ytd_adjusted_hash                 ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Total_Unknown_Tax_Qtd,2) <> 0
     print '  Total Qtd Unknown Tax= ' (+2,10)
     print #Total_Unknown_Tax_Qtd      ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Total_Unknown_Tax_Ytd,2) <> 0
      print '  Total Ytd Unknown Tax= ' (+1,10)
      print #Total_Unknown_Tax_Ytd      ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Ignore_Tax_Qtd,2) <> 0
      print '  Total Qtd not reported Tax= ' (+2,10)
      print #Hash_Ignore_Tax_Qtd      ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Ignore_Tax_Ytd,2) <> 0
      print '  Total Ytd not reported Tax= ' (+1,10)
      print #Hash_Ignore_Tax_Ytd      ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Total_Excise_Qtd,2) <> 0
      print '  Note, Excise taxes are included in the extract totals.' (+2,10)
      print '        These taxes are not included in the TAX010xx totals.' (+1,10)
      print '  Total Qtd Fed Excise Tax  = ' (+1,10)
      print #Hash_Total_Excise_Qtd   ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Total_Excise_Ytd,2) <> 0
      print '  Total Ytd Fed Excise Tax  = ' (+1,10)
      print #Hash_Total_Excise_Ytd    ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Total_Tax_Non_941,2) <> 0
     print '   (Note, Non-941 Taxes and Wages are mapped as: {FORM1042_Taxcode} and ' (+2,10)
     print '{FORM945P_Taxcode} in the extract)'  ()
     print 'Total Non-941 Taxes Withheld (FIT)  = '  (+1,20)
     print #Hash_Total_Tax_Non_941                   ()  edit $$$,$$$,$$$,$$9.99mi
     print 'Total Non-941 Taxable Wages  (FIT)  = '  (+1,20)
     print #Hash_Total_Taxable_Wages_Non_941         ()  edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Generated_Taxes_Qtd,2) <> 0
     print '*** Use the following Grand Totals to Balance      *** ' (+2,1)
     print '    ahead with the Transporters Hash Totals.   '        (+1,1)
     print '    These Totals may be larger than Tax010xx Totals    ' (+1,1)
     print '    because of the Employer OASDI and Medicare taxes   ' (+1,1)
     print '    which can generated by this extract.  Any other    ' (+1,1)
     print '    EE taxes with TaxClass = B are also generated by   ' (+1,1)
     print '    the extract process.                               ' (+1,1)
 
     print '  Total Extract Generated (ER) Qtd Taxes = ' (+2,10)
     print #Generated_Taxes_Qtd       () edit $$$,$$$,$$$,$$9.99mi
     print '  Total Extract Generated (ER) Ytd Taxes = ' (+1,10)
     print #Generated_Taxes_Ytd       () edit $$$,$$$,$$$,$$9.99mi
 
    end-if
 
    print 'Quarterly Extract Totals for ADP Employment Tax, Quarterly Run: ' (+2,1) {PRINT_HIGHLIGHT}
    print '  Client ID :            ' (+1,10)
    print '{SITE_ID}'               ()
    print '  Company Selection  :   ' (+1,10)
 
    if $AllCompanies <> 'Y'
      print $CompanySelection         ()
    else
      print 'ALL'                     ()
    end-if
 
    print '  Qtd Total Taxes        = '(+2,10)
    print #Hash_Total_Tax_Qtd          () edit $$$,$$$,$$$,$$9.99mi
    print '  Qtd Taxable Wages      = '(+1,10)
    print #Hash_Total_Txgrs_Qtd        () edit $$$,$$$,$$$,$$9.99mi
    print '  Qtd Gross Wages        = '(+1,10)
    print #Hash_Total_Nlgrs_Qtd        () edit $$$,$$$,$$$,$$9.99mi
 
    print '  Ytd Total Taxes        = '(+1,10)
    print #Hash_Total_Tax_Ytd          () edit $$$,$$$,$$$,$$9.99mi
    print '  Ytd Taxable Wages      = '(+1,10)
    print #Hash_Total_Txgrs_Ytd        () edit $$$,$$$,$$$,$$9.99mi
    print '  Ytd Gross Wages        = '(+1,10)
    print #Hash_Total_Nlgrs_Ytd        () edit $$$,$$$,$$$,$$9.99mi
 
    print '  Count of Jurisdictions = '(+2,10)
    print #Last_TaxTotal_Cnt           ()   edit 99999
 
    new-page
 
    print 'Extract Configuration' (+2,1) {PRINT_HIGHLIGHT}
 
    print  'W-2 Selection (Y/N)    : ' (+1,10)
    print  $Operator_selected_W2s      ()
 
    if $adp_w2_records = 't'
      print  'W-2 Records included in extract'     (+1,10)
      print  'Summary Mode:            '           (+1,10)
      print  '{DEDUCTS_AND_EARNINGS_MODE}'         ()
    else
      print  'W-2 Records not included in extract' (+1,10)
    end-if
 
    #ifndef ADP_TAX_AMEND
       #ifdef CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS
        print  'CHOOSE TAX BALANCES OVER YE AMOUNTS.' (+1,10)
       #else
         print  'ADPAMEND, Uses year-end data.' (+1,10)
       #endif
    #endif
 
    #ifdef USE_TEMP_TABLE_FOR_OUTPUT
      print  'Temp Tables (PS_{Client_Table_Prefix}PBZQOUT_x{Client_Table_Suffix}) used to pre-sort output.'     (+2,10)
    #endif
 
    #ifdef USE_TEMP_TABLE_FOR_MONTHLY_COUNTS
      print 'Temp Table used for monthly counts (Tablename: {PBZQTR_TEMP_TABLE}).' (+2,10)
      print 'Verify that {PBZQTR_TEMP_TABLE} has the following fields only, and that they are ALL KEY fields' (+1,10)
      print '  COMPANY, EMPLID, STATE, TAX_CLASS, LOCALITY, PERIOD_COUNT' (+1,10)
    #endif
 
    print  'Extract Specifications : ' (+1,10)
    print  '{Quarterly_extract_specs}'           ()
 
    #ifdef Process_1099s
        print '1099 Section.                                                     ' (+2,1) {PRINT_HIGHLIGHT}
        print ' 1099 Total employee count                                      = ' (+2,10)
        print #emp_count_hash_1099                                                 () edit 999999
        print ' 1099 Total Distributions                                       = ' (+1,10)
        print #Current_Distribution_hash_1099                                      () edit $$$,$$$,$$$,$$9.99mi
        print ' 1099 Total Taxable Wages                                       = ' (+1,10)
        print #Current_Taxable_hash_1099                                           () edit $$$,$$$,$$$,$$9.99mi
    #endif
 
    print 'NJ-FLI Subject to Taxes ' (+2,1) {PRINT_HIGHLIGHT}
    print ' New Jersey associates subject to Family Leave State plan       = ' (+2,10)
    print #FLI_STATUS_Y  () edit 999999
    print ' New Jersey associates not subject to Family Leave State plan   = ' (+1,10)
    print #FLI_STATUS_N  () edit 999999
 
    #ifdef INCLUDE_LCL_ADJ
         print 'Local Adjustment logic enabled.  SUMMARY Totals'      (+2,1)  {PRINT_HIGHLIGHT}
         print '  QTD Taxes included from Adjustments (Adj)       = ' (+1,10)
         print #ADJ.TAX_QTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  QTD Wages included from Adjustments (Adj)       = ' (+1,10)
         print #ADJ.TXGRS_QTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  YTD Taxes included from Adjustments (Adj)       = ' (+1,10)
         print #ADJ.TAX_YTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  YTD Wages included from Adjustments (Adj)       = ' (+1,10)
         print #ADJ.TXGRS_YTD  () edit $$$,$$$,$$$,$$9.99mi
 
         print '  QTD Taxes skipped from Tax Balances (Orig)      = ' (+2,10)
         print #ADC.TAX_QTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  QTD Wages skipped from Tax Balances (Orig)      = ' (+1,10)
         print #ADC.TXGRS_QTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  YTD Taxes skipped from Tax Balances (Orig)      = ' (+1,10)
         print #ADC.TAX_YTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  YTD Wages skipped from Tax Balances (Orig)      = ' (+1,10)
         print #ADC.TXGRS_YTD  () edit $$$,$$$,$$$,$$9.99mi
 
         let #ADN.TAX_QTD   = #ADJ.TAX_QTD   - #ADC.TAX_QTD
         let #ADN.TXGRS_QTD = #ADJ.TXGRS_QTD - #ADC.TXGRS_QTD
         let #ADN.TAX_YTD   = #ADJ.TAX_YTD   - #ADC.TAX_YTD
         let #ADN.TXGRS_YTD = #ADJ.TXGRS_YTD - #ADC.TXGRS_YTD
         print '  QTD Taxes Net Adjustments    (Adj - Orig)       = ' (+2,10)
         print #ADN.TAX_QTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  QTD Wages Net Adjustments    (Adj - Orig)       = ' (+1,10)
         print #ADN.TXGRS_QTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  YTD Taxes Net Adjustments    (Adj - Orig)       = ' (+1,10)
         print #ADN.TAX_YTD  () edit $$$,$$$,$$$,$$9.99mi
         print '  YTD Wages Net Adjustments    (Adj - Orig)       = ' (+1,10)
         print #ADN.TXGRS_YTD  () edit $$$,$$$,$$$,$$9.99mi
 
         print 'Count of records read from Adjustment table: {ADP_LCL_ADJ_TBL}  = ' (+2,10)  {PRINT_HIGHLIGHT}
         print #Local_Adj_count () edit 99999  {PRINT_HIGHLIGHT}
    #endif
 
    #ifdef VT_HEALTH_INSURANCE_INDICATOR
 
     print 'VERMONT Health Insurance' (+2,1) {PRINT_HIGHLIGHT}
 
     #ifdef VT_HEALTH_INSURANCE_07C
       print 'VT Health Insurance indicator determined via PS_STATE_TAX_DATA.HLTH_COV_IND values.' (+1,10)
       if rtrim($VT_Erncds,' ') = 'f'
          print 'Warning, No Earnings codes setup in RC_TAX810VT Table.  Using standard hours worked calculation' (+1,10)
       else
          print 'Earnings codes for QTD Hours determined from RC_TAX810VT Table' (+1,10)
       end-if
     #else
 
       #ifdef VT_HEALTH_DEDUCTION_BAL_CRITERIA
          print 'VT Health Insurance indicator determined via VT_HEALTH_DEDUCTION_BAL_CRITERIA definition in configuration file.' (+1,10)
       #else
          print 'VT Health Insurance indicator determined via PS_HEALTH_BENEFIT.COVERAGE_ELECT values.' (+2,10)
       #endif
 
     #endif
 
     print ' Vermont associates covered under health insurance benefits     = ' (+2,10)
     print #Health_insurance_indicator_covered_hash                             () edit 999999
     print ', QTD Hours = '                                                     ()
     print #Health_insurance_indicator_covered_hash_qtd_hours                   () edit 9999999
     print ' Vermont associates NOT covered under health insurance benefits = ' (+1,10)
     print #Health_insurance_indicator_not_covered_hash                         () edit 999999
     print ', QTD Hours = '                                                     ()
     print #Health_insurance_indicator_not_covered_hash_qtd_hours               () edit 9999999
 
    #endif
 
    if round(#Health_care_contrib_YTD_Hash,2) <> 0
      print '  NV Healthcare ER contrib QTD '  (+2,10)
      print #Health_care_contrib_QTD_Hash      () edit $$$,$$$,$$$,$$9.99mi
      print '  NV Healthcare ER contrib YTD '  (+1,10)
      print #Health_care_contrib_YTD_Hash      () edit $$$,$$$,$$$,$$9.99mi
      print ' (employee count = '              ()
      print #Health_care_contrib_count_hash    () edit 99999
      print ')'                                ()
    end-if
 
 
   #ifdef SSDP_BENEFITS
       print 'NEW YORK SSDP Benefits' (+2,1) {PRINT_HIGHLIGHT}
       do Format-Number(#SSDP_Benefits_pay_QTD_hash, $SSDP_Benefits_pay_QTD_hash, $Fmt)
       do Format-Number(#SSDP_Benefits_pay_YTD_hash, $SSDP_Benefits_pay_YTD_hash, $Fmt)
       #debugd show 'SSDP_Benefits_pay_QTD = ' $SSDP_Benefits_pay_QTD_hash
       #debugd show 'SSDP_Benefits_pay_YTD = ' $SSDP_Benefits_pay_YTD_hash
       print 'SSDP QTD Benefits (NY Work + Retire)        = '  (+2,10)
       print $SSDP_Benefits_pay_QTD_hash                       ()
       print 'SSDP YTD Benefits (NY Box 14A + NY Box 14B) = '  (+1,10)
       print $SSDP_Benefits_pay_YTD_hash                       ()
   #endif
 
    !4/21/08 added this section for sanity check of year-end data
    !------------------------------------------------------------
    if $adp_w2_records = 't'
 
          print 'Year-End / W-2 Record Counts and Audit'                      (+2,1) {PRINT_HIGHLIGHT}
          print 'U.S. Associate Count. Associates with PS_YE_DATA Loaded = '  (+2,10)
          print #tot_emp_count                                                () edit 999,999
          print 'Pension Plan associate count     (Box 13 = Y)           = '  (+1,10)
          print #PensionPlanFlag_Y                                            () edit 999,999
          print 'Non-Pension Plan associate count (Box 13 = N)           = '  (+1,10)
          print #PensionPlanFlag_N                                            () edit 999,999
          print 'Box (B) Misc. Record count. All BOX (B) record count    = '  (+1,10)
          print #B_REC_Total_Count                                            () edit 9,999,999
 
          if #PensionPlanFlag_Y = 0 and #PensionPlanFlag_N > 0
            print 'Warning: ALL Pension Plan (Box 13) Boxes are set to N, verify running TAX504 then re-run TAX910LD' (+1,10) bold
          end-if
 
          if #tot_emp_count = 0
            print 'ERROR: No Year-End Data has been extracted from PS_YE_DATA. Verify W-2 setup then re-run TAX910LD' (+1,10) bold
            print '       After running Tax910LD, verify federal Box totals via W-3 Transmittal (TAX915).'            (+1,10) bold
          end-if
 
          if #B_REC_Total_Count = 0
            print 'Warning: No BOX records have been extracted from PS_YE_AMOUNTS. Verify W-2 setup then re-run TAX910LD' (+1,10) bold
            print '         After running Tax910LD, verify federal Box totals via W-3 Transmittal (TAX915).'            (+1,10) bold
          end-if
 
 
    end-if
    !------------------------------------------------------------
 
    New-Page
 
    !format includes NLGRS, TXGRS and TAXES both QTD and YTD as of 5/23/06
    !-----------------------------------------------------------------------
#ifndef SKIP_TAX_AND_WAGE_BREAKDOWN
    print 'Tax & Wage Breakdown (Federal, State, Local, Misc...)' (+2,1) {PRINT_HIGHLIGHT}
 
    print 'Jurisdiction            QTD Taxes              QTD Taxable              QTD Subject                YTD Taxes              YTD Taxable              YTD Subject'  (+1,1)
    print '------------            ---------              -----------              -----------                ---------              -----------              -----------'  (+1,1)
 
    print ' FIT'                            (+1,1)
    print #Hash_Total_Tax_FIT_Qtd           (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_FIT_Qtd         (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_FIT_Qtd         (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_FIT_Ytd           (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_FIT_Ytd         (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_FIT_Ytd         (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    #ifdef excise_deduction
      print #excise_deduction_hash_qtd           (,12) edit $$,$$$,$$$,$$$,$$9.99mi
      print #excise_deduction_hash_ytd           (,87) edit $$,$$$,$$$,$$$,$$9.99mi
      print ' (<-- FIT totals include these Excise taxes for Dedcd: {excise_deduction})' ()
    #endif
 
 
    print ' EIC'                            (+1,1)
    print #Hash_Total_Tax_EIC_Qtd           (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_EIC_Qtd         (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_EIC_Qtd         (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_EIC_Ytd           (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_EIC_Ytd         (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_EIC_Ytd         (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' OASDI-EE'                       (+1,1)
    print #Hash_Total_Tax_OASDIEE_Qtd       (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_OASDIEE_Qtd     (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_OASDIEE_Qtd     (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_OASDIEE_Ytd       (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_OASDIEE_Ytd     (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_OASDIEE_Ytd     (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' OASDI-ER'                       (+1,1)
    print #Hash_Total_Tax_OASDIER_Qtd       (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_OASDIER_Qtd     (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_OASDIER_Qtd     (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_OASDIER_Ytd       (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_OASDIER_Ytd     (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_OASDIER_Ytd     (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' MED-EE'                         (+1,1)
    print #Hash_Total_Tax_MEDEE_Qtd         (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_MEDEE_Qtd       (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_MEDEE_Qtd       (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_MEDEE_Ytd         (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_MEDEE_Ytd       (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_MEDEE_Ytd       (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' MEDEE-SUR'                      (+1,1)
    print #Hash_Total_Tax_MEDEE_SUR_Qtd     (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_MEDEE_SUR_Qtd   (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_MEDEE_SUR_Qtd   (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_MEDEE_SUR_Ytd     (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_MEDEE_SUR_Ytd   (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_MEDEE_SUR_Ytd   (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' MED-ER'                         (+1,1)
    print #Hash_Total_Tax_MEDER_Qtd         (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_MEDER_Qtd       (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_MEDER_Qtd       (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_MEDER_Ytd         (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_MEDER_Ytd       (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_MEDER_Ytd       (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' FUTA'                          (+1,1)
    print #Hash_Total_Tax_FUTA_Qtd         (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_FUTA_Qtd       (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_FUTA_Qtd       (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_FUTA_Ytd         (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_FUTA_Ytd       (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_FUTA_Ytd       (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' FED TOTAL'                      (+1,1)
    print #Hash_Total_Tax_Federal_Qtd       (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_Federal_Qtd     (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_Federal_Qtd     (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_Federal_Ytd       (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_Federal_Ytd     (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_Federal_Ytd     (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    !----------------------------------------------
 
    print ' SIT'                       (+2,1)
    print #Hash_Total_Tax_SIT_Qtd      (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SIT_Qtd    (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SIT_Qtd    (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_SIT_Ytd      (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SIT_Ytd    (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SIT_Ytd    (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' SUI-ER'                    (+1,1)
    print #Hash_Total_Tax_SUI_Qtd      (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SUI_Qtd    (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SUI_Qtd    (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_SUI_Ytd      (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SUI_Ytd    (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SUI_Ytd    (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' SUI-SPCL-ER'                    (+1,1)
    print #Hash_Total_Tax_SPCL_SUI_Qtd      (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SPCL_SUI_Qtd    (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SPCL_SUI_Qtd    (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_SPCL_SUI_Ytd      (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SPCL_SUI_Ytd    (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SPCL_SUI_Ytd    (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' SUI-EE'                    (+1,1)
    print #Hash_Total_Tax_SUI_EE_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SUI_EE_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SUI_EE_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_SUI_EE_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SUI_EE_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SUI_EE_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' SDI-ER'                    (+1,1)
    print #Hash_Total_Tax_SDI_ER_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SDI_ER_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SDI_ER_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_SDI_ER_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SDI_ER_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SDI_ER_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' SDI-EE'                    (+1,1)
    print #Hash_Total_Tax_SDI_EE_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SDI_EE_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SDI_EE_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_SDI_EE_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_SDI_EE_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_SDI_EE_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' FLI-EE'                    (+1,1)
    print #Hash_Total_Tax_FLI_EE_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_FLI_EE_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_FLI_EE_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_FLI_EE_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_FLI_EE_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_FLI_EE_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' VFLI-EE'                    (+1,1)
    print #Hash_Total_Tax_VFLI_EE_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_VFLI_EE_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_VFLI_EE_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_VFLI_EE_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_VFLI_EE_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_VFLI_EE_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' VFLI-ER'                    (+1,1)
    print #Hash_Total_Tax_VFLI_ER_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_VFLI_ER_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_VFLI_ER_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_VFLI_ER_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_VFLI_ER_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_VFLI_ER_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' NJ-SWAF'                    (+1,1)
    print #Hash_Total_Tax_NJSWAF_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_NJSWAF_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_NJSWAF_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_NJSWAF_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_NJSWAF_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_NJSWAF_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' NJ-WDPF'                    (+1,1)
    print #Hash_Total_Tax_NJWDPF_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_NJWDPF_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_NJWDPF_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_NJWDPF_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_NJWDPF_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_NJWDPF_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' NJ-HCSF'                    (+1,1)
    print #Hash_Total_Tax_NJHCSF_Qtd   (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_NJHCSF_Qtd (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_NJHCSF_Qtd (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_NJHCSF_Ytd   (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_NJHCSF_Ytd (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_NJHCSF_Ytd (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    print ' Locals'                    (+1,1)
    print #Hash_Total_Tax_Local_Qtd    (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_Local_Qtd  (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_Local_Qtd  (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_Local_Ytd    (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_Local_Ytd  (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_Local_Ytd  (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    if rtrim($STATE_FUTA_TAX_CLASS,' ') <> ''
     print ' State Futa '               (+1,1)
     print #Hash_Total_Tax_State_FUTA_Qtd      (,12) edit $$,$$$,$$$,$$$,$$9.99mi
     print #State_futa_QTD_Hash                (,37) edit $$,$$$,$$$,$$$,$$9.99mi
     print #Hash_Total_Tax_State_FUTA_Ytd      (,87) edit $$,$$$,$$$,$$$,$$9.99mi
     print #State_futa_YTD_Hash               (,112) edit $$,$$$,$$$,$$$,$$9.99mi
     print ' , Tax_Class = '             ()
     print $STATE_FUTA_TAX_CLASS         ()
    end-if
 
    print ' Misc. '                     (+1,1)
    print #Hash_Total_Tax_Misc_Qtd      (,12) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_Misc_Qtd    (,37) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_Misc_Qtd    (,62) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Tax_Misc_Ytd      (,87) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Txgrs_Misc_Ytd    (,112) edit $$,$$$,$$$,$$$,$$9.99mi
    print #Hash_Total_Nlgrs_Misc_Ytd    (,137) edit $$,$$$,$$$,$$$,$$9.99mi
 
    !----------------------------------------------------------------------------
 
    if round(#Hash_Total_Tip_Wages_Qtd,2) <> 0
      print '  Qtd Tip Wages          = '(+2,10)
      print #Hash_Total_Tip_Wages_Qtd () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Total_Tip_Tax_Qtd,2) <> 0
      print '  Qtd Tip Taxes          = '(+1,10)
      print #Hash_Total_Tip_Tax_Qtd () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Unknown_Tax_Qtd,2) <> 0
      print '  Qtd Unknown Taxes      = '(+1,10)
      print #Unknown_Tax_Qtd () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Ignore_Tax_Qtd,2) <> 0
      print '  Qtd not reported Tax   = ' (+2,10)
      print #Ignore_Tax_Qtd  () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Total_Tip_Wages_Ytd,2) <> 0
      print '  Ytd Tip Wages          = '(+2,10)
      print #Hash_Total_Tip_Wages_Ytd () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Hash_Total_Tip_Tax_Ytd,2) <> 0
      print '  Ytd Tip Taxes          = '(+1,10)
      print #Hash_Total_Tip_Tax_Ytd () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Unknown_Tax_Ytd,2) <> 0
      print '  Ytd Unknown Taxes      = '(+1,10)
      print #Unknown_Tax_Ytd () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    if round(#Ignore_Tax_Ytd,2) <> 0
      print '  Ytd not reported Tax   = ' (+1,10)
      print #Ignore_Tax_Ytd  () edit $$,$$$,$$$,$$$,$$9.99mi
    end-if
 
    #ifndef PROCESS_TERRITORY_STATE_RECORDS
     if round(#Tax_Total_bypassed_territory_QTD,2) <> 0
      print '  Qtd Taxes Skipped From Territory Memo Pay_Tax records   = '  (+1,10)
      print #Tax_Total_bypassed_territory_QTD  () edit $$,$$$,$$$,$$$,$$9.99mi
     end-if
    #endif
 
    !added 3/27/06
    !----------------
    #ifdef THIRD_PARTY_SICK_EMPLOYER
      print '  QTD Employer Paid 3PSP (reported for NU-SUI)             = '  (+1,10)
      print #Sick_Pay_amt_er_Qtd_Company  () edit $$,$$$,$$$,$$$,$$9.99mi
    #endif
 
    #ifdef THIRD_PARTY_NON_TAXABLE
      print '  YTD Employer Non-Taxable Federal 3PSP                    = '  (+1,10)
      print #Sick_Pay_amt_er_Ytd_Company  () edit $$,$$$,$$$,$$$,$$9.99mi
    #endif
 
    #if {SITE_ID} = 'ARK1'
      print '  Qtd ER Paid Taxes = ' (+2,10)
      print #Hash_CoPaid_QTD  () edit $$,$$$,$$$,$$$,$$9.99mi
      print '  Ytd ER Paid Taxes = ' (+1,10)
      print #Hash_CoPaid_YTD  () edit $$,$$$,$$$,$$$,$$9.99mi
    #endif
 
    #ifdef REMAP_OH_SUI_FOR_BRINKER
      if round(#Hash_Total_Tax_OHU_Remapped_Qtd,2) <> 0
         print '  Qtd OHU remapped from Company BI to BOH Taxes   = ' (+2,10)
         print #Hash_Total_Tax_OHU_Remapped_Qtd  () edit $$$,$$$,$$$,$$9.99mi
         print '  Qtd OHU remapped from Company BI to BOH Taxable = ' (+2,10)
         print #Hash_Total_Txgrs_OHU_Remapped_Qtd  () edit $$$,$$$,$$$,$$9.99mi
         print '  Qtd OHU remapped from Company BI to BOH Gross   = ' (+2,10)
         print #Hash_Total_Nlgrs_OHU_Remapped_Qtd  () edit $$$,$$$,$$$,$$9.99mi
      end-if
    #endif
 
    if round(#CALC-MOH-EMPLOYER-CREDIT_Hash,2) <> 0
     print 'Total Missouri SIT QTD Employer Credit           = ' (+2,10)
     print #CALC-MOH-EMPLOYER-CREDIT_Hash () edit 999,999,999.99mi
    end-if
 
    if #Hash_PR_Taxable_YTD_Adjusted <> 0
         print '  YTD Taxable Commisions reducing PR State (PRH)  = ' (+2,10)
         print #Hash_PR_Taxable_YTD_Adjusted  () edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if #Hash_Voided_taxable_for_expats <> 0
         print '  YTD Taxable Wages Voided for Expats             = ' (+2,10)
         print #Hash_Voided_taxable_for_expats  () edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if #TaxBalance_Txgrs_Qtd_locals_cleared <> 0
         print '  QTD Taxable cleared due to zero local withheld  = ' (+2,10)
         print #TaxBalance_Txgrs_Qtd_locals_cleared  () edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    if #TaxBalance_Txgrs_Ytd_locals_cleared <> 0
         print '  YTD Taxable cleared due to zero local withheld  = ' (+2,10)
         print #TaxBalance_Txgrs_Ytd_locals_cleared  () edit $$$,$$$,$$$,$$9.99mi
    end-if
 
 
    #ifdef KJDA
      do Summarize-KJDA-Hash
    #endif
 
    #if {SITE_ID} = 'HWL1'
      if  $HON_COMPANIES_TO_EXCLUDE <> ''
        print '* Companies excluded from quarterly run: ' (+2,10)
        print $HON_COMPANIES_TO_EXCLUDE_PRINT ()
      end-if
    #endif
 
    #if {SITE_ID} = 'WFG1'
      if  $WFG1_COMPANIES_TO_EXCLUDE <> ''
        print '* Companies excluded from quarterly run: ' (+2,10)
        print $WFG1_COMPANIES_TO_EXCLUDE_PRINT ()
      end-if
    #endif
 
    #ifdef COMPANIES_TO_EXCLUDE_PRINT
     print '* Companies excluded from quarterly run: ' (+2,10)
     print '{COMPANIES_TO_EXCLUDE_PRINT}' ()
    #endif
 
    if $process_W2C_data = 't'
 
     print 'W-2C Section. Total count of associates having W-2C data  = ' (+2,1)         {PRINT_HIGHLIGHT}
     print #W2C_Amounts_loaded_count                                      () edit 99999  {PRINT_HIGHLIGHT}
 
     if #W2C_Amounts_loaded_count > 0
 
      print 'W-2C Grand Totals                            Previous             Corrected          Increase/decrease' (+2,1) bold
      print '                               --->' (+1,1)
      do Format-Number(#W2C_Prv_Hash_TOT, $out, '$$$,$$$,$$$,$$9.99mi')
      print $out       (,37)
      do Format-Number(#W2C_Cur_Hash_TOT, $out, '$$$,$$$,$$$,$$9.99mi')
      print $out       (,59)
      do Format-Number(#W2C_Dif_Hash_TOT, $out, '$$$,$$$,$$$,$$9.99mi')
      print $out       (,86)
 
      print 'W-2C Switches' (+2,1) {PRINT_HIGHLIGHT}
 
      #ifdef EDIT_QTD_NEGATIVE
        print 'EDIT_QTD_NEGATIVE enabled.' (+1,10)
      #else
        print 'EDIT_QTD_NEGATIVE NOT enabled.' (+1,10)
      #endif
 
      #ifdef UPDATE_QTD_WITH_W2C_NEGATIVE
        print 'UPDATE_QTD_WITH_W2C_NEGATIVE = {UPDATE_QTD_WITH_W2C_NEGATIVE}' (+1,10)
      #else
        print 'UPDATE_QTD_WITH_W2C_NEGATIVE not defined.' (+1,10)
      #endif
 
      #ifdef UPDATE_QTD_WITH_W2C
        print 'UPDATE_QTD_WITH_W2C enabled.' (+1,10)
      #else
        print 'UPDATE_QTD_WITH_W2C NOT enabled.' (+1,10)
      #endif
 
      #ifdef W2C_REJECT_TABLE_ENABLED
        print 'W2C_REJECT_TABLE_ENABLED enabled.' (+1,10)
      #else
        print 'W2C_REJECT_TABLE_ENABLED NOT enabled.' (+1,10)
      #endif
 
      #ifdef W2C_REJECT_TABLE_AUTO_INSERT
        print 'W2C_REJECT_TABLE_AUTO_INSERT enabled.' (+1,10)
      #else
        print 'W2C_REJECT_TABLE_AUTO_INSERT NOT enabled.' (+1,10)
      #endif
 
      #ifdef adjust-tax-balances-for-new-state-locals
         print 'adjust-tax-balances-for-new-state-locals enabled.'   (+1,10)
      #endif
 
      #ifdef adjust-tax-balances-to-match-ee
         print 'adjust-tax-balances-to-match-ee enabled.'   (+1,10)
      #endif
 
      #ifndef ADP_TAX_AMEND
        #ifdef CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS
          print 'Tax Balances over YE Amounts'          (+1,10)
        #endif
      #endif
     end-if
    end-if
 
    New-Page
#endif
 
    print 'Program Versions, Releases, and Output Files.' (+2,1) {PRINT_HIGHLIGHT}
    print  'Extract Release Version: ' (+1,10)
    print  $Release_Version            ()
    print  'SQR Program Version:     ' (+1,10)
    print  $Program_Version            ()
 
    print  'adp303.sqc Version:      ' (+1,10)
    print  '{adp303_version}         ' ()
    print  'adp303q.sqc Version:     ' (+1,10)
    print  '{adp303q_version}        ' ()
    print  'adp303b.sqc Version:     ' (+1,10)
    print  '{adp303b_version}        ' ()
    print  'adpq210.sqc Version:     ' (+1,10)
    print  '{adpq210_version}        ' ()
    print  '    (Review Trace file for additional SQC versions)' ()
    print  ' ' (+1,1)
 
    #ifdef ADP_TAX_AMEND
     #ifdef Process_1099s
      print 'Warning: ADP_TAX_AMEND Run.. W-2C processing will not include 1099 data' (+1,10)
     #endif
    #endif
 
 
   #ifdef LOCAL_RECIPROCITY
      print 'Locality Reciprocity Enabled (splitting RES and Non-RES Tax and Wage values).' (+1,10)
   #endif
 
    !#ifdef WORKSITE_REPORTING
    ! do write-worksite-setup-records
    ! print 'Worksite Setup File to send to ADP Employment Tax:  ' (+1,10)
    ! print $Worksite_Setup_Filename ()
    ! print 'Count of MWR setup records = ' (+1,10)
    ! print #worksite_count                 () edit 999999
    !#endif
 
    #ifdef EXCEL_FIXED_QUARTERLY_FILENAME
    print  'Excel Data File:         ' (+1,10)
    print  $Excel_Filename             ()
    #endif
 
    #ifdef W2C_OUTPUT_FILE
       do Close-W2C    !call to adpw2c.sqc to close supplemental W-2C file
       print  'Include adpw2c.sqc Vers: ' (+1,10)
       print  '{Program_Version_adpw2c}'  ()
       print 'Supplemental file for AT10 W-2C handling has been created.  File: ' (+1,10)
       print $W2c_filename ()
    #endif
 
    #ifdef LOCAL_RECIPROCITY
     #ifdef LOCAL_RECIPROCITY_SPECIAL_REPORT
       print 'Listing of Special localities detailed in file: ' (+1,10)
       print $SPECIAL_rec_filename ()
     #endif
    #endif
 
    print  'Extract Report:          ' (+1,10)
    #if {SITE_ID} = 'SRC1'
       print $NewReportName            ()
    #else
       #ifdef REDIRECT_REPORT_NAME
          print $NewReportName            ()
       #else
          print $sqr-report               ()
       #endif
    #endif
 
    if $ADP_Qtr_Mode = 'N'
      print 'ADP_Qtr_Mode (Normal) data written into PS_{Client_Table_Prefix}ADP_QTR_LOG{Client_Table_Suffix}'  (+2,10)
      print '  Inserts                      =  '  (+1,10)
      print #insert_quarterly_logging_count       () edit 9999999
      print '  Updates                      =  '  (+1,10)
      print #update_quarterly_logging_count       () edit 9999999
      print '  Totals (Inserts+Updates)     =  '  (+1,10)
      print #Store_quarterly_logging_count        () edit 9999999
    end-if
    if $ADP_Qtr_Mode = 'A'
      print 'ADP_Qtr_Mode (Amend) '            (+2,10)
      print #retrieve_quarterly_logging_count  () edit 9999999
    end-if
 
 
    if $Report_Only_Flag = 'Y'
     print  'Extract Data File:       '             (+2,10) {PRINT_HIGHLIGHT}
     print  $Filename                               ()      {PRINT_HIGHLIGHT}
     print '    <------ REMOVED (Report only mode)' ()      {PRINT_HIGHLIGHT}
    else
     print  'Extract Data File:       '             (+2,10) {PRINT_HIGHLIGHT}
     print  $Filename                               ()      {PRINT_HIGHLIGHT}
     print '    <------ send this file to ADP'      ()      {PRINT_HIGHLIGHT}
    end-if
 
    print 'ADP Employment Tax, Quarter/W-2/1099 Extract Complete. '   (+2,1)  {PRINT_HIGHLIGHT}
 
 End-if
 
end-procedure  !Post-Tax-Balance-Processing

 
#ifndef Skip_Rimini_Medicare_Surcharge
begin-procedure Rimini_Medicare_Surcharge
 
 !----------------------------------------------------------------------------------------------------------------------------------------
 !20130213 - split $UF to $UF and $U7 for Medicare surcharge for Rimini $Tax_Update like 'RS%'
 !           the Balances for EE Medicare in PS_TAX_BALANCE include the full Taxable wages,
 !           and the taxes withheld amount to be equal to 1.45% of the first $200,000 + 2.35% of the overage (Taxable wages - $200,000).
 !           the $U7 amount will be just the difference above the limit and .9% of the difference
 !----------------------------------------------------------------------------------------------------------------------------------------
 if #RptYear >= 2013
 
  let #NLGRS_QTD_T_save   = #NLGRS_QTD_T
  let #TXGRS_QTD_T_save   = #TXGRS_QTD_T
  let #TAX_QTD_T_save     = #TAX_QTD_T
  let #NLGRS_YTD_T_save   = #NLGRS_YTD_T
  let #TXGRS_YTD_T_save   = #TXGRS_YTD_T
  let #TAX_YTD_T_save     = #TAX_YTD_T
  let $Cur_Tax_Class_save = $Cur_Tax_Class
 
  if #Rimini_Medicare_Surcharge < 1
     if #RptYear >= 2013
       let #Medicare_Surcharge_wage_limit = 200000.00
       let #Medicare_Surcharge_tax_rate   = 0.009
       let #Medicare_Standard_tax_rate    = 0.0145
     end-if
     show 'Rimini_Medicare_Surcharge: Limit ' #Medicare_Surcharge_wage_limit edit 999,999.99
     show '         Medicare Standard  Rate ' #Medicare_Standard_tax_rate    edit 9.9999
     show '         Medicare Surcharge Rate ' #Medicare_Surcharge_tax_rate   edit 9.9999
     add 1 to #Rimini_Medicare_Surcharge
  end-if
 
  if #TXGRS_YTD_T > #Medicare_Surcharge_wage_limit
       move ''                   to $Cur_Resident
       move '$U'                 to $Cur_State
       move '7'                  to $Cur_Tax_Class
 
       let #TAX_QTD_A = #TXGRS_QTD_T * #Medicare_Standard_tax_rate  !adjusted Tax amounts on the $UF record to include just the 1.45 %
       let #TAX_YTD_A = #TXGRS_YTD_T * #Medicare_Standard_tax_rate
       let #TAX_QTD_A = round(#TAX_QTD_A,2)
       let #TAX_YTD_A = round(#TAX_YTD_A,2)
 
       !calculate the new surcharge wage and tax amounts
       let  #NLGRS_YTD_T         = #NLGRS_YTD_T - #Medicare_Surcharge_wage_limit
       let  #TXGRS_YTD_T         = #TXGRS_YTD_T - #Medicare_Surcharge_wage_limit
       let  #TAX_YTD_T           = #TXGRS_YTD_T * #Medicare_Surcharge_tax_rate  !generate surcharge Tax amount of .9%
       let  #TAX_YTD_T           = round(#TAX_YTD_T,2)
 
       if #RptQtr = 1
         let  #NLGRS_QTD_T         = #NLGRS_YTD_T
         let  #TXGRS_QTD_T         = #TXGRS_YTD_T
         let  #TAX_QTD_T           = #TAX_YTD_T
       else
         if #TXGRS_QTD_T > #TXGRS_YTD_T
            let  #TXGRS_QTD_T  = #TXGRS_YTD_T
            let  #NLGRS_QTD_T  = #NLGRS_YTD_T
         end-if
         let  #TAX_QTD_T           = #TXGRS_QTD_T   * #Medicare_Surcharge_tax_rate  !generate surcharge Tax amount of .9%
         let  #TAX_QTD_T           = round(#TAX_QTD_T,2)
       end-if
       !--------------------------------------------------
       if $SelectEmplid <> ''
         show 'Rimini_Medicare_Surch $UF: Original QTD Wages ' #TXGRS_QTD_T_save edit 999,999,999.99 ', QTD Taxes ' #TAX_QTD_T_save edit 999,999,999.99
         show '                      $UF: Original YTD Wages ' #TXGRS_YTD_T_save edit 999,999,999.99 ', YTD Taxes ' #TAX_YTD_T_save edit 999,999,999.99
         show '                      $UF: Adjusted QTD Taxes ' #TAX_QTD_A        edit 999,999,999.99 ', YTD Taxes ' #TAX_YTD_A      edit 999,999,999.99
         show '                      $U7: SurTax   QTD Wages ' #TXGRS_QTD_T      edit 999,999,999.99 ', QTD Taxes ' #TAX_QTD_T      edit 999,999,999.99
         show '                      $U7: SurTax   YTD Wages ' #TXGRS_YTD_T      edit 999,999,999.99 ', YTD Taxes ' #TAX_YTD_T      edit 999,999,999.99
       end-if
 
       do update-tax-balances
 
       let #TAX_QTD_T_save = #TAX_QTD_A
       let #TAX_YTD_T_save = #TAX_YTD_A
 
  end-if
 
  let #NLGRS_QTD_T = #NLGRS_QTD_T_save
  let #TXGRS_QTD_T = #TXGRS_QTD_T_save
  let #TAX_QTD_T   = #TAX_QTD_T_save
  let #NLGRS_YTD_T = #NLGRS_YTD_T_save
  let #TXGRS_YTD_T = #TXGRS_YTD_T_save
  let #TAX_YTD_T   = #TAX_YTD_T_save
  let $Cur_Tax_Class = $Cur_Tax_Class_save
 
 end-if
 
end-procedure
#endif
 
begin-procedure update-tax-balances
 
    #ifdef excise_deduction
     if rtrim($Cur_State,' ') = '$U' and rtrim($Cur_Tax_Class,' ') = 'H'
      do Get_excise_deduction !NXT1 - probiz.sqc, sums #excise_deduction_hash, returns #excise_deduction_qtd, #excise_deduction_ytd
      add #excise_deduction_ytd to #TAX_YTD_T
      add #excise_deduction_qtd to #TAX_QTD_T
     end-if
    #endif
 
    if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
         show 'update-tax-balances: Entering Philly rollup check.  Cur_Resident ' $Cur_Resident ' Res PSD code ' $RES_PSD_CD1 ' Cur_Locality ' $Cur_Locality
    end-if
    #ifdef ROLLUP_PHILLY_BALANCES
       !04122013 Philly rollup for RSI
       !------------------------------
       if rtrim($RES_PSD_CD1,' ') = '' and $Cur_State = 'PA' and ($Cur_Locality = '510101' or $Cur_Locality = 'I510012M')
         let $Resident = ' '
         let $TaxBalance_State = $Cur_State
         let $TaxBalance_Locality = $Cur_Locality
         do Extract-Resident-Code
         if $Resident = 'Y'
           let $RES_PSD_CD1 = $Cur_Locality
         end-if
         if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
            show 'update-tax-balances: rollup Philly Bal, blank RES_PSD_CD logic.   Cur_Resident ' $Cur_Resident ' Resident ' $Resident ' Res PSD code ' $RES_PSD_CD1
         end-if
       end-if
       !------------------------------
       if $Cur_State = 'PA' and ($Cur_Locality = '510101' or $Cur_Locality = 'I510012M')
        if rtrim($Cur_Resident,' ') = ''  !DON'T reset the resident flag for local reciprocity clients, these clients would have the cur_resident var set to Y/N by now
          if ($RES_PSD_CD1 = '510101' or $RES_PSD_CD1 = 'I510012M')
           let $Cur_Resident = 'Y'
          else
           let $Cur_Resident = 'N'
          end-if
        end-if
 
        let $RES_PSD_CD1 = ''
        let $WORK_PSD_CD1 = $Cur_Locality    !20130509 added
        if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
            show 'update-tax-balances: rollup Philly Balance, Resident ' $Cur_Resident ' ' $WORK_PSD_CD1 '/' $RES_PSD_CD1 ', ' $Current_Company ', ' $Current_Emplid
        end-if
      end-if
    #endif
 
    !20130517, 20140724 added 880000
    #ifndef CUSTOM_PA_EIT_GIE1
     if (rtrim($WORK_PSD_CD1,' ') = '990000' or rtrim($WORK_PSD_CD1,' ') = '880000') and $Cur_State = 'PA'
      show 'update-tax-balances: resetting PA Work PSD code from: ' $WORK_PSD_CD1 ' to Locality: ' $Cur_Locality ' for Emplid ' $Current_Emplid
      let $WORK_PSD_CD1 = $Cur_Locality
     end-if
    #endif
    
 
    let #L1 = 0
    let $found = 'f'
    while #L1 < #LAST_TAXBALANCE_CNT
    Add 1 to #L1
    get $TEST_ST                    -
        $TEST_LOCALITY              -
        $TEST_TAX_CLASS             -
        $TEST_Resident              -
        $TEST_Res_PSD               -
       from TAXBALANCE(#L1)         -
             TaxBalance_State       -
             TaxBalance_Locality    -
             TaxBalance_Tax_Class   -
             TaxBalance_Resident    -
             TaxBalance_Res_PSD_CD
 
 
    if     rtrim($Cur_State,' ') = rtrim($TEST_ST,' ')
       AND rtrim($Cur_Locality,' ') = rtrim($TEST_LOCALITY,' ')
       AND rtrim($Cur_Tax_Class,' ') = rtrim($TEST_TAX_CLASS,' ')
       AND rtrim($Cur_Resident,' ') = rtrim($TEST_Resident,' ')
       AND rtrim($RES_PSD_CD1,' ') = rtrim($TEST_Res_PSD,' ')
 
      Array-Add #NLGRS_QTD_T         -
                #TXGRS_QTD_T         -
                #TAX_QTD_T           -
                #NLGRS_YTD_T         -
                #TXGRS_YTD_T         -
                #TAX_YTD_T           -
                #Tip_Wages_QTD       -
                #Tip_Wages_YTD       -
                #Tip_Tax_QTD         -
                #Tip_Tax_YTD         -
                TO TAXBALANCE(#L1) -
                        TaxBalance_Nlgrs_Qtd  -
                        TaxBalance_Txgrs_Qtd  -
                        TaxBalance_Tax_Qtd    -
                        TaxBalance_Nlgrs_Ytd  -
                        TaxBalance_Txgrs_Ytd  -
                        TaxBalance_Tax_Ytd    -
                        TaxBalance_Tip_Wages_Qtd -
                        TaxBalance_Tip_Wages_Ytd -
                        TaxBalance_Tip_Tax_Qtd   -
                        TaxBalance_Tip_Tax_Ytd
 
         let $found = 't'
 
         break
 
     end-if
 
  end-while
 
  if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
    show 'update-tax-balances: emplid ' $Current_Emplid ' ' $Cur_State $Cur_Tax_Class $Cur_Locality ' Res: ' $Cur_Resident ' ' $WORK_PSD_CD1 '/' $RES_PSD_CD1 ' found: ' $found
  end-if
 
  if $found = 'f'
    Add 1 to #Last_TaxBalance_Cnt
 
    put $Cur_State           -
        $Cur_Locality        -
        $Cur_Tax_Class       -
        #NLGRS_QTD_T         -
        #TXGRS_QTD_T         -
        #TAX_QTD_T           -
        #NLGRS_YTD_T         -
        #TXGRS_YTD_T         -
        #TAX_YTD_T           -
        #Tip_Wages_QTD       -
        #Tip_Wages_YTD       -
        #Tip_Tax_QTD         -
        #Tip_Tax_YTD         -
        $Cur_Resident        -
        $RES_PSD_CD1          -
        $WORK_PSD_CD1         -
        INTO TAXBALANCE(#LAST_TAXBALANCE_CNT) -
            TaxBalance_State      -
            TaxBalance_Locality   -
            TaxBalance_Tax_Class  -
            TaxBalance_Nlgrs_Qtd  -
            TaxBalance_Txgrs_Qtd  -
            TaxBalance_Tax_Qtd    -
            TaxBalance_Nlgrs_Ytd  -
            TaxBalance_Txgrs_Ytd  -
            TaxBalance_Tax_Ytd -
            TaxBalance_Tip_Wages_Qtd -
            TaxBalance_Tip_Wages_Ytd -
            TaxBalance_Tip_Tax_Qtd   -
            TaxBalance_Tip_Tax_Ytd -
            TaxBalance_Resident -
            TaxBalance_Res_PSD_CD -
            TaxBalance_Work_PSD_CD
 
   end-if
 
end-procedure
 
#ifndef SKIP_SUI_SUMMARY
begin-procedure print-sui-totals
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
    #debugd show 'print-sui-totals, #sui_count = ' #sui_count
 
    move   0 to #g_t
    move   0 to #t_t
    move   0 to #w_t
    move   0 to #m1_t
    move   0 to #m2_t
    move   0 to #m3_t
    move   0 to #q_t
    move   0 to #weeks_t
    move   0 to #worked_t
 
    if #sui_count > 0
 
     let #header_type = 4
     let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. SUI Summary (Employer)'
 
     let #i = 0
     let $company_zzz = 'ZZZ'
     let $worksite_zz = 'ZZZZZ'
     let $state_zz    = 'ZZ'
     while (#i < #sui_count)
 
        let #j = 0
        let $sorttest = $company_zzz || $state_zz || $worksite_zz
        let #nextinx = 0
 
        while (#j < #sui_count)
          get $c -
              $s -
              $w -
          from SUI_Locations(#j) -
              Company -
              State -
              Worksite
 
          let $sortfield = $c || $s || $w
 
          #ifdef debug_worksites
            #debugd show 'print-sui-totals: retrieving worksite info = ' #j ':' $sortfield
          #endif
 
          if ($sortfield < $sorttest)
           let #nextinx = #j
           move $sortfield to $sorttest
          end-if
 
          add 1 to #j
 
        end-while
 
        if #current-line > 56
          New-Page
        end-if
 
        get $c -
         $s -
         $w -
         #rt -
         #g  -
         #t  -
         #w  -
         #m1 -
         #m2 -
         #m3 -
         #q  -
         #wks -
         #worked -
        from SUI_Locations(#nextinx)  -
	  Company -
	  State -
	  Worksite -
	  Rate -
	  Gross -
	  Taxable -
	  Taxes -
	  Month1 -
	  Month2 -
	  Month3 -
	  QTD_Hours -
          Weeks     -
	  Worked_in_Qtr
 
        put $company_zzz -
            $state_zz -
            $worksite_zz -
         into SUI_Locations(#nextinx) -
            Company -
            State -
            Worksite
 
        print $c       (+1,1)
        print $s       (0,10)
        print $w       (0,20)
        print #rt      (0,32)  edit 99.999
        print #g       (0,46)  edit $$$,$$$,$$$,$$9.99mi
        print #t       (0,65)  edit $$$,$$$,$$$,$$9.99mi
        print #w       (0,85)  edit $$$,$$$,$$$,$$9.99mi
        print #m1      (0,105) edit 99999
        print #m2      (0,114) edit 99999
        print #m3      (0,123) edit 99999
        print #q       (0,130) edit 9,999,999,999.99
        print #wks     (0,148) edit 99999
        print #worked  (0,155) edit 99999
 
        !--------------- 4/18/02 ----------------
        move ' ' to $LocationName
 
        #ifdef USE_ESTABID
         do Get-Estabid-Name
        #else
         #ifdef USE_LOCATION_CD
          let $Location = $w
          let $Setid = $Setid_loc
          do Get-Location-Name
         #else
          #ifndef USE_DEPTID_FOR_WORKSITE
            let $TaxLocationCd = $w
            do Get-Tax-Location-Name
          #else
            let $DeptidCd = $w
            #if {SITE_ID} <> 'WFG1'
              do Get-Deptid-Name
            #endif
          #endif
         #endif
        #endif
 
        print $LocationName (0,164,12)
        !----------------------------------------
 
        add #g to #g_t
        add #t to #t_t
        add #w to #w_t
        add #m1 to #m1_t
        add #m2 to #m2_t
        add #m3 to #m3_t
        add #q to #q_t
        add #wks    to #weeks_t
        add #worked to #worked_t
 
        add 1 to #i
 
      end-while
 
      print 'Employer SUI TOTALS --> ' (+2,1)
      print #g_t       (0,46)  edit $$$,$$$,$$$,$$9.99mi
      print #t_t       (0,65)  edit $$$,$$$,$$$,$$9.99mi
      print #w_t       (0,85)  edit $$$,$$$,$$$,$$9.99mi
      print #m1_t      (0,105) edit 99999
      print #m2_t      (0,114) edit 99999
      print #m3_t      (0,123) edit 99999
      print #q_t       (0,130) edit 9,999,999,999.99
      print #weeks_t   (0,148) edit 99999
      print #worked_t  (0,155) edit 99999
 
      print 'QTD Total Negative SUI Gross Wages in Extract, but NOT in totals above = ' (+2,1)
      print #Hash_Total_Neg_Nlgrs_SUI_Qtd () edit $$$,$$$,$$$,$$9.99mi
      print 'QTD Total SUI Gross Wages in Extract                                   = ' (+1,1)
      print #Hash_Total_Nlgrs_SUI_Qtd     () edit $$$,$$$,$$$,$$9.99mi
 
      print 'NOTE:  Please perform a sanity check of the Month1..Month3 TOTAL Counts prior to sending a final live file.' (+2,1)
 
      New-Page
 
    end-if
 
      #ifdef  enable_performance_monitor
         do Get-Current-Time
         move 'Print-SUI-Totals' to $debug-proc1
         move ' '    to $debug-table1
         do log-delta-time
      #endif
 
end-procedure
#endif
 
#ifndef STRIPPED_PBZQTR_REPORT
begin-procedure print-local-totals
 
    !added 1/8/04
    !------------
    move 0 to #g_t
    move 0 to #t_t
    move 0 to #w_t
 
    if #local_count > 0
 
     let #header_type = 5
     let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Local Summary (All Companies)'
 
     let #ii = 0
     let $state_zz    = 'ZZ'
     let $res_zz      = 'Z'
     let $local_zz    = 'ZZZZZZZZZZ'
 
     while (#ii < #local_count)
 
        let #jj = 0
        let $sorttest =  $state_zz || $local_zz || $res_zz
 
        let #nextinx = 0
        while (#jj < #local_count)
         get $s -
             $l -
             $r -
         from local_Locations(#jj) -
             State		   -
             Locality		   -
             Resident
 
         let $sortfield = $s || $l || $r
 
         if ($sortfield < $sorttest)
           let #nextinx = #jj
           move $sortfield to $sorttest
         end-if
         add 1 to #jj
        end-while
 
        if #current-line > 56
          New-Page
        end-if
 
        get $s -
            $l -
            $r -
            #gw -
            #tw	-
            #wh	-
        from local_Locations(#nextinx) -
            State -
            Locality -
	    Resident -
	    Gross    -
	    Taxable  -
	    Taxes
 
        put $state_zz -
            $Local_zz -
            $res_zz   -
        into local_Locations(#nextinx) -
           State	    -
           Locality	    -
           Resident
 
 
        !added 4/30/08
        !--------------
        let $get_local_rate = rtrim($l,' ')
        let $state_trimmed  = rtrim($s,' ')
 
        do get-local-rate
        if rtrim($r,' ') = 'Y'
         let #rt = #wc_rate
        else
         let #rt = #nonres_wc_rate
        end-if
 
        print $s       (+1,1)
        print $l       (0,11)
        print $r       (0,21)
        print #gw      (0,37)  edit $$$,$$$,$$$,$$9.99mi
        print #tw      (0,56)  edit $$$,$$$,$$$,$$9.99mi
        print #wh      (0,76)  edit $$$,$$$,$$$,$$9.99mi
        print #rt      (0,105) edit 99.9999
 
        move $s to $State
        let $Locality = substr($l,1,14)
        let $Locality = rtrim($Locality,' ')
 
        do get-local-tax-data
        Print $Localname              (0,115)
 
        add #gw to #gw_t
        add #tw to #tw_t
        add #wh to #wh_t
 
        add 1 to #ii
 
      end-while
 
      print 'Local TOTALS --> ' (+2,1)
      print #gw_t       (0,37)  edit $$$,$$$,$$$,$$9.99mi
      print #tw_t       (0,56)  edit $$$,$$$,$$$,$$9.99mi
      print #wh_t       (0,76)  edit $$$,$$$,$$$,$$9.99mi
 
      New-Page
 
    end-if
 
end-procedure
 
begin-procedure print-missing-personal
 
    if #Missing_Qtr_Data_count > 0
 
      let #header_type = 3
      let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Missing Quarter-End Data'
 
      let #i = 0
      while (#i < #Missing_Qtr_Data_count)
 
        if #current-line > 56
          New-Page
        end-if
 
        Get $C -
            $E -
            $M -
            from Missing_Qtr_Data(#i) -
               Company  -
               Emplid   -
               Message
 
           print $C       (+1,1)
           print $E       (0,16)
           print $M       (0,35)
 
        add 1 to #i
 
      end-while
 
      print 'Total Qtd Taxes Associated with Missing Qtr-End Data = '  (+2,10)
      print #Missing_Tax_QTD                                           ()  edit $$$,$$$,$$$,$$9.99mi
      print '  Note, missing personal data records are an ERROR,'      (+1,10)
      print '  while the missing job data records are a WARNING only.' (+1,10)
      print 'Missing Qtr-End Data Records                         = '  (+2,10)
      print #Missing_Qtr_Data_count                                    () edit 99999
      print '    (See sqr.log for details)'                            ()
 
      New-Page
 
   end-if
 
end-procedure
#endif
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Print-TaxBalance-Recap                                         !
! Descr:     Prints a Recap of  Tax Balances                                !
!            If #Tot = 0, then we are recapping the PAYGROUP data           !
!            If #Tot = 1, we are recapping COMPANY Totals                   !
!            If #Tot = 2, we are recapping FEIN Totals                      !                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Print-TaxBalance-Recap
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  let #L1    = 0
  let #next_state_inx = 0
  let $Processed_Feds = 'f'  !we need to process the federal taxes first
  let $State:2 = '  '
  let #CoPaid_Qtd = 0
  let #CoPaid_Ytd = 0
 
!#ifndef STRIPPED_PBZQTR_REPORT
  if $RptDetail = 'Y'
    New-Page
  end-if
!#endif
 
  do Sort-TaxBalance-Recap
 
  while #L1 < #Last_TaxTotal_Cnt
 
   if $Processed_Feds = 't'
     do Get-Next-State
     Add 1 to #next_state_inx
   end-if
 
   let #i = 0
 
   while #i < #Last_TaxTotal_Cnt
 
    Add 1 to #i
    get $Test_State from TaxTotal(#i) TaxTotal_State
 
    if ($Processed_Feds = 'f')
      let $First_Char_St = substr($Test_State,1,1)
    end-if
 
    if (($Processed_Feds = 't') AND ($Test_State = $Next_State)) OR
       (($Processed_Feds = 't') AND ($Next_State = '**')) OR
       (($Processed_Feds = 'f') AND ($First_Char_St = '$'))
 
     Add 1 to #L1
     get $TaxTotal_State       -
      $TaxTotal_Locality       -
      #ifdef LOCAL_RECIPROCITY
      $TaxTotal_Resident       -
      #endif
      $TaxTotal_Tax_Class      -
      #TaxTotal_Nlgrs_Qtd      -
      #TaxTotal_Txgrs_Qtd      -
      #TaxTotal_Tax_Qtd        -
      #TaxTotal_Excess_Qtd     -
      #TaxTotal_Nlgrs_Ytd      -
      #TaxTotal_Txgrs_Ytd      -
      #TaxTotal_Tax_Ytd        -
      #TaxTotal_Excess_Ytd     -
      $TaxTotal_Taxcode_sort   -
      from TaxTotal(#i)        -
           TaxTotal_State      -
           TaxTotal_Locality   -
           #ifdef LOCAL_RECIPROCITY
           TaxTotal_Resident    -
           #endif
           TaxTotal_Tax_Class  -
           TaxTotal_Nlgrs_Qtd (#Tot) -
           TaxTotal_Txgrs_Qtd (#Tot) -
           TaxTotal_Tax_Qtd   (#Tot) -
           TaxTotal_Excess_Qtd(#Tot) -
           TaxTotal_Nlgrs_Ytd (#Tot) -
           TaxTotal_Txgrs_Ytd (#Tot) -
           TaxTotal_Tax_Ytd   (#Tot) -
           TaxTotal_Excess_Ytd(#Tot) -
           TaxTotal_Taxcode_sort
 
      if ( (round(#TaxTotal_Nlgrs_Qtd,2) <> 0) OR
           (round(#TaxTotal_Txgrs_Qtd,2) <> 0) OR
           (round(#TaxTotal_Tax_Qtd,2) <> 0)   OR
           (round(#TaxTotal_Nlgrs_Ytd,2) <> 0) OR
           (round(#TaxTotal_Txgrs_Ytd,2) <> 0) OR
           (round(#TaxTotal_Tax_Ytd,2) <> 0) )
 
       if #current-line > 56
          New-Page
       end-if
 
       do Build-TaxTotal-Taxcode
 
       if rtrim($TaxTotal_Taxcode,' ') = '{FORM945P_Taxcode}' OR
          rtrim($TaxTotal_Taxcode,' ') = '{FORM1042_Taxcode}' OR
          substr($TaxTotal_Taxcode,4,7) = '{FORM943_Taxcode}'
        Print 'U.S.Fed Non-941 '            (+1,1)
       else
 
        let $State = substr($TaxTotal_State,1,2)
        do get-state-tax-data
 
        if ($State <> $Prior_State)
 
         If $State = '$U' OR $State = '$E'
           Print 'U.S. Federal '            (+1, 1)
           Print $Current_Fein              (0,17,10)
         Else
           Print $StateName                 (+1, 1, 15)
           Print &EMPLOYER_ID_SWT           (0,17,11)   !10/1/04 changed from 10 chars long to 11
         end-if
 
         move $State to $Prior_State
 
        else
         Print ' '                            (+1,1)
        end-if
       end-if
 
       move $TaxTotal_Locality to $Locality
 
       if rtrim($TaxTotal_Taxcode,' ') <> '{FORM945P_Taxcode}' AND
          rtrim($TaxTotal_Taxcode,' ') <> '{FORM1042_Taxcode}' AND
          substr($TaxTotal_Taxcode,4,7) <> '{FORM943_Taxcode}'
 
        If Rtrim($Locality,' ') <> ''
 
         do get-local-tax-data
         Print $Locality               (0, 27, 7)
 
         #ifdef GETLCLDATA_751                     !7.51  (LocalAbbr changed names)
           Print $Localabbr              (0,37,9)
         #else
           Print &LOCALITY_ABBRV         (0,37,9)
         #endif
 
        End-if
       end-if
 
       If Rtrim($Locality,' ') <> ''
         let $TaxTotal_Resident = substr($TaxTotal_Taxcode_sort,15,1)
         Print $TaxTotal_Taxcode               (0,47,14)
         Print $TaxTotal_Resident              (0,61,1)
       else
         Print $TaxTotal_Taxcode                (0,47,15)
       end-if
 
       move ' ' to $TaxClass_Descr
       if rtrim($TaxTotal_Taxcode,' ') = '{FORM945P_Taxcode}'
         move '945P-FIT' to $TaxClass_Descr
       else
         if rtrim($TaxTotal_Taxcode,' ') = '{FORM1042_Taxcode}'
           move '1042-FIT' to $TaxClass_Descr
         else
 
          if substr($TaxTotal_Taxcode,4,7) = '{FORM943_Taxcode}'
           move '943-FED' to $TaxClass_Descr
          else
 
           let $Tax_Class_Parm = substr($TaxTotal_Tax_Class,1,1)
           do Get-XlatTable-Descr
 
           !added 8/13/98
           if rtrim($TaxClass_Descr,' ') = ''
             Let $TaxClass_Descr = 'Class ' || $TaxTotal_Tax_Class
             Add #TaxTotal_Tax_Qtd to #Unknown_Tax_QTD
             Add #TaxTotal_Tax_Ytd to #Unknown_Tax_YTD
             Add #TaxTotal_Tax_Qtd to #Total_Unknown_Tax_QTD
             Add #TaxTotal_Tax_Ytd to #Total_Unknown_Tax_YTD
           end-if
         end-if
        end-if
       end-if
       Print $TaxClass_Descr                  (0,67,10)
       Print #TaxTotal_Txgrs_Qtd              (0,87)  edit 9999999999.99    ! changed 12/13/00
       Print #TaxTotal_Nlgrs_Qtd              (0,101) edit 9999999999.99
       Print #TaxTotal_Tax_Qtd                (0,115) edit 9999999999.99
       Print #TaxTotal_Txgrs_Ytd              (0,130) edit 99999999999.99
       Print #TaxTotal_Nlgrs_Ytd              (0,145) edit 99999999999.99
       Print #TaxTotal_Tax_Ytd                (0,160) edit 99999999999.99
 
       #if {SITE_ID} = 'ARK1'
         !I - California Company Pd CASDI, J - New Jersey Company Paid NJSDI, which
         !are not know to Tax001, so this is for reconciliation
         !--------------------------------------------------------------------------
         if (($TaxTotal_Tax_Class = 'I') OR ($TaxTotal_Tax_Class = 'J'))
           Add #TaxTotal_Tax_Qtd to #CoPaid_QTD
           Add #TaxTotal_Tax_Ytd to #CoPaid_YTD
           Add #TaxTotal_Tax_Qtd to #Hash_CoPaid_QTD
           Add #TaxTotal_Tax_Ytd to #Hash_CoPaid_YTD
         end-if
 
       #endif
 
       end-if
 
       Put 0          -
           0          -
           0          -
           0          -
           0          -
           0          -
           0          -
           0          -
           Into TaxTotal(#i)       -
                TaxTotal_Nlgrs_Qtd (#Tot) -
                TaxTotal_Txgrs_Qtd (#Tot) -
                TaxTotal_Tax_Qtd   (#Tot) -
                TaxTotal_Excess_Qtd(#Tot) -
                TaxTotal_Nlgrs_Ytd (#Tot) -
                TaxTotal_Txgrs_Ytd (#Tot) -
                TaxTotal_Tax_Ytd   (#Tot) -
                TaxTotal_Excess_Ytd(#Tot)
 
    End-if
 
   end-while
   let $Processed_Feds = 't'
 
 end-while
 
 !Company Totals
 !--------------
 if #Tot = 1
 
  New-Page
 
  #if {SITE_ID} = 'JCP1'
    print '** Use the following Company Totals to Balance to PYP145R *** ' (+2,1)
  #else
    print '** Use the following Company Totals to Balance to TAX010FD    ' (+2,1)
    print '   TAX010ST and TAX010PA Totals (Federal, State, and PA-OPT)  ' (+1,1)
  #endif
 
  print 'Quarterly Extract Totals for Company: ' (+2,10)
  print $Current_Company              ()
  print '  Year   :                 ' (+1,10)
  print #RptYear                    () edit 9999
  print '  Quarter:                 ' (+1,10)
  print #RptQtr                     () edit 9
 
  print '  Qtd Taxes              = '(+1,10)
  print #Company_Total_Tax_Qtd_Not_Generated                  () edit $$$,$$$,$$$,$$9.99mi
  print '  ** - does NOT include generated taxes by extract ' ()
  print '  Qtd Total Taxes        = '(+1,10)
  print #Company_Total_Tax_Qtd          () edit $$$,$$$,$$$,$$9.99mi
  print '  ** - DOES include generated taxes by extract' ()
 
  if round(#Company_Total_Tax_Qtd_PRE_Generated,2) <> 0
    print ', which include PR-SDI-ER Qtd Taxes = ' ()     !5/16/00
    print #Company_Total_Tax_Qtd_PRE_Generated     () edit $$$,$$$,$$$,$$9.99mi      !5/16/00
  end-if
 
  print '  Qtd Taxable Wages      = '(+1,10)
  print #Company_Total_Txgrs_Qtd     () edit $$$,$$$,$$$,$$9.99mi
  print '  Qtd Gross Wages        = '(+1,10)
  print #Company_Total_Nlgrs_Qtd     () edit $$$,$$$,$$$,$$9.99mi
 
  print '  Ytd Taxes              = '(+2,10)
  print #Company_Total_Tax_Ytd_Not_Generated       () edit $$$,$$$,$$$,$$9.99mi
  print '  ** - does NOT include generated taxes by extract ' ()
  print '  Ytd Total Taxes        = '(+1,10)
  print #Company_Total_Tax_Ytd          () edit $$$,$$$,$$$,$$9.99mi
  print '  ** - DOES include generated taxes by extract ' ()
 
  if round(#Company_Total_Tax_Ytd_PRE_Generated,2) <> 0     ! added 12/13/00
    print 'Additionaly, PR-SDI-ER Ytd Taxes = ' ()
    print #Company_Total_Tax_Ytd_PRE_Generated     () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  print '  Ytd Taxable Wages      = '(+1,10)
  print #Company_Total_Txgrs_Ytd     () edit $$$,$$$,$$$,$$9.99mi
  print '  Ytd Gross Wages        = '(+1,10)
  print #Company_Total_Nlgrs_Ytd     () edit $$$,$$$,$$$,$$9.99mi
 
  if round(#TaxBalance_Tax_QTD_Remapped_to_RR,2) <> 0
    print '  Taxes Remapped to Railroad companies  = ' (+2,10)
    print #TaxBalance_Tax_QTD_Remapped_to_RR  () edit $$$,$$$,$$$,$$9.99mi
  end-if
  LET #TaxBalance_Tax_QTD_Remapped_to_RR = 0
 
  if round(#TaxBalance_Tax_QTD_Remapped_to_FRM,2) <> 0
    print '  Taxes Remapped to 001FRM Farm company = ' (+2,10)
    print #TaxBalance_Tax_QTD_Remapped_to_FRM  () edit $$$,$$$,$$$,$$9.99mi
  end-if
  LET #TaxBalance_Tax_QTD_Remapped_to_FRM = 0
 
  if round(#TaxBalance_Tax_QTD_Remapped_to_PEN,2) <> 0
    print '  Taxes Remapped to 001PEN Pens company = ' (+2,10)
    print #TaxBalance_Tax_QTD_Remapped_to_PEN () edit $$$,$$$,$$$,$$9.99mi
  end-if
  LET #TaxBalance_Tax_QTD_Remapped_to_PEN= 0
 
  if round(#TaxBalance_Tax_QTD_Remapped_to_PEN_AIR1,2) <> 0
    print '  Taxes Remapped to 1099 company = ' (+2,10)
    print #TaxBalance_Tax_QTD_Remapped_to_PEN_AIR1 () edit $$$,$$$,$$$,$$9.99mi
  end-if
  LET #TaxBalance_Tax_QTD_Remapped_to_PEN_AIR1 = 0
 
  if round(#TaxBalance_Tax_QTD_Remapped_to_200,2) <> 0
    print '  Taxes Remapped to 200  = ' (+2,10)
    print #TaxBalance_Tax_QTD_Remapped_to_200  () edit $$$,$$$,$$$,$$9.99mi
  end-if
  LET #TaxBalance_Tax_QTD_Remapped_to_200 = 0
 
  #if {SITE_ID} = 'AXA1'
   if round(#TaxBalance_Tax_QTD_Remapped_to_ADPPRB,2) <> 0
    print '  Taxes Remapped to ADPPRB  = ' (+2,10)
    print #TaxBalance_Tax_QTD_Remapped_to_ADPPRB  () edit $$$,$$$,$$$,$$9.99mi
   end-if
   LET #TaxBalance_Tax_QTD_Remapped_to_ADPPRB = 0
   if round(#TaxBalance_Tax_QTD_Remapped_to_PRPPRB,2) <> 0
    print '  Taxes Remapped to PRPPRB  = ' (+1,10)
    print #TaxBalance_Tax_QTD_Remapped_to_PRPPRB  () edit $$$,$$$,$$$,$$9.99mi
   end-if
   LET #TaxBalance_Tax_QTD_Remapped_to_PRPPRB = 0
  #endif
 
  print '  QTD TAX BREAKDOWN (Fed, State, Locals...)' (+2,10)
  print '  -----------------------------------------' (+1,10)
  print '  Qtd Federal Taxes      = '(+1,10)
  print #Company_Total_Tax_Federal_Qtd   () edit $$$,$$$,$$$,$$9.99mi
  print '  Qtd State Income Taxes = '(+1,10)
  print #Company_Total_Tax_SIT_Qtd     () edit $$$,$$$,$$$,$$9.99mi
 
  print '  Qtd SUI (ER)     Taxes = '(+1,10)
  print #Company_Total_Tax_SUI_Qtd     () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd SUI (ER)     Gross = ' ()
  print #Company_Total_Nlgrs_SUI_Qtd   () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''U'')' ()
 
  print '  Qtd SPCL SUI(ER) Taxes = '(+1,10)
  print #Company_Total_Tax_SPCL_SUI_Qtd     () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd SPCL SUI(ER) Gross = ' ()
  print #Company_Total_Nlgrs_SPCL_SUI_Qtd   () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''S'')' ()
 
  print '  Qtd SUI (EE)     Taxes = '(+1,10)
  print #Company_Total_Tax_SUI_EE_Qtd  () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd SUI (EE)     Gross = ' ()
  print #Company_Total_Nlgrs_SUI_EE_Qtd () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''V'')' ()
 
  print '  Qtd SDI (ER)     Taxes = '(+1,10)
  print #Company_Total_Tax_SDI_ER_Qtd  () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd SDI (ER)     Gross = ' ()
  print #Company_Total_Nlgrs_SDI_ER_Qtd () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''E'')' ()
 
  print '  Qtd SDI (EE)     Taxes = '(+1,10)
  print #Company_Total_Tax_SDI_EE_Qtd  () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd SDI (EE)     Gross = ' ()
  print #Company_Total_Nlgrs_SDI_EE_Qtd () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''D'')' ()
 
  !new section 8/20/09
  !--------------------
  print '  Qtd FLI EE             = '(+1,10)
  print #Company_Total_Tax_FLI_EE_Qtd      () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd FLI EE       Gross = '     ()
  print #Company_Total_Nlgrs_FLI_EE_Qtd    () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''I'')'               ()
 
  print '  Qtd VFLI EE            = '(+1,10)
  print #Company_Total_Tax_VFLI_EE_Qtd      () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd VFLI EE      Gross = '     ()
  print #Company_Total_Nlgrs_VFLI_EE_Qtd    () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''O'')'               ()
 
  print '  Qtd VFLI ER            = '(+1,10)
  print #Company_Total_Tax_VFLI_ER_Qtd      () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd VFLI ER      Gross = '     ()
  print #Company_Total_Nlgrs_VFLI_ER_Qtd    () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''Y'')'               ()
 
  print '  Qtd NJSWAF             = '(+1,10)
  print #Company_Total_Tax_NJSWAF_Qtd      () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd NJSWAF       Gross = '     ()
  print #Company_Total_Nlgrs_NJSWAF_Qtd    () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''L'')'               ()
 
  print '  Qtd NJWDPF             = '(+1,10)
  print #Company_Total_Tax_NJWDPF_Qtd      () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd NJWDPF       Gross = '     ()
  print #Company_Total_Nlgrs_NJWDPF_Qtd    () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''M'')'               ()
 
  print '  Qtd NJHCSF             = '(+1,10)
  print #Company_Total_Tax_NJHCSF_Qtd      () edit $$$,$$$,$$$,$$9.99mi
  print ',  Qtd NJHCSF       Gross = '     ()
  print #Company_Total_Nlgrs_NJHCSF_Qtd    () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class ''N'')'               ()
 
  print '  Qtd State FUTA Addl    = '(+1,10)
  print #Company_Total_Tax_State_FUTA_Qtd  () edit $$$,$$$,$$$,$$9.99mi
  print ' (Tax Class '                     ()
  print $State_FUTA_Tax_Class              ()
  print ')'                                ()
 
  !end of new section 8/20/09
  !------------------------------
 
  print '  Qtd Local Taxes        = '(+1,10)
  print #Company_Total_Tax_Local_Qtd     () edit $$$,$$$,$$$,$$9.99mi
  print '  Qtd Misc. Taxes        = '(+1,10)
  print #Company_Total_Tax_Misc_Qtd     () edit $$$,$$$,$$$,$$9.99mi
 
  print '  Miscellaneous Company extract totals.....' (+2,10)
  print '  -----------------------------------------' (+1,10)
 
  #ifdef VT_HEALTH_INSURANCE_INDICATOR
   print 'Vermont associates covered under health insurance benefits     = ' (+2,20)
   print #Health_insurance_indicator_covered_company                         () edit 999999
   print ', QTD Hours = '                                                    ()
   print #Health_insurance_indicator_covered_company_qtd_hours               () edit 9999999
   print 'Vermont associates NOT covered under health insurance benefits = ' (+1,20)
   print #Health_insurance_indicator_not_covered_company                     () edit 999999
   print ', QTD Hours = '                                                    ()
   print #Health_insurance_indicator_not_covered_company_qtd_hours           () edit 9999999
 
   let #Health_insurance_indicator_covered_company = 0
   let #Health_insurance_indicator_not_covered_company = 0
   let #Health_insurance_indicator_covered_company_qtd_hours = 0
   let #Health_insurance_indicator_not_covered_company_qtd_hours = 0
 
  #endif
 
  if round(#CALC-MOH-EMPLOYER-CREDIT_C,2) <> 0
   print 'Total Missouri SIT QTD Employer Credit = '  (+2,20)
   print  #CALC-MOH-EMPLOYER-CREDIT_C   () edit 999,999,999.99mi
   move 0 to #CALC-MOH-EMPLOYER-CREDIT_C
  end-if
 
  !added 2/4/04
  !----------------------------------
  if round(#12M_QTD_Company,2) <> 0
    print '(Box 12M) Uncol SS / RRTA tax GTL  = ' (+2,20)
    print #12M_QTD_Company                        () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#12N_QTD_Company,2) <> 0
    print '(Box 12N) Uncol Med / RRTA tax GTL = ' (+2,20)
    print #12N_QTD_Company                        () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  let #12M_QTD_Company = 0
  let #12N_QTD_Company = 0
 
   print 'Misc 3.03 Earnings QTD & YTD         ' (+2,20)
   print '----------------------------         ' (+1,20)
 
   #ifdef STOCK_OPTION_SELECTION
    print 'Stock Option QTD Earnings          = ' (+1,20)
    print #Stock_Options_QTD_Company              () edit $$$,$$$,$$$,$$9.99mi
    print 'Stock Option YTD Earnings          = ' (+1,20)
    print #Stock_Options_YTD_Company              () edit $$$,$$$,$$$,$$9.99mi
    let #Stock_Options_QTD_Company = 0
    let #Stock_Options_YTD_Company = 0
   #endif
 
   #ifdef Meals_employer_conv_selection
    print 'Employer Meals QTD Earnings        = ' (+1,20)
    print #Meals_employer_conv_QTD_Company        () edit $$$,$$$,$$$,$$9.99mi
    print 'Employer Meals YTD Earnings        = ' (+1,20)
    print #Meals_employer_conv_YTD_Company        () edit $$$,$$$,$$$,$$9.99mi
    let #Meals_employer_conv_QTD_Company = 0
    let #Meals_employer_conv_YTD_Company = 0
   #endif
 
   #ifdef Qual_transportation_selection
    print 'Qualified Transportation QTD       = ' (+1,20)
    print #Qual_transportation_QTD_Company        () edit $$$,$$$,$$$,$$9.99mi
    print 'Qualified Transportation YTD       = ' (+1,20)
    print #Qual_transportation_YTD_Company      () edit $$$,$$$,$$$,$$9.99mi
    let #Qual_transportation_QTD_Company = 0
    let #Qual_transportation_YTD_Company = 0
   #endif
 
   #ifdef Severence_pay_selection
    print 'Severance Pay QTD                  = ' (+1,20)
    print #Severence_pay_QTD_Company      () edit $$$,$$$,$$$,$$9.99mi
    print 'Severance Pay YTD                  = ' (+1,20)
    print #Severence_pay_YTD_Company      () edit $$$,$$$,$$$,$$9.99mi
 
    print 'Severance Pay QTD Michigan         = ' (+1,20)
    print #Severence_pay_QTD_Company_MI           () edit $$$,$$$,$$$,$$9.99mi
    print 'Severance Pay YTD Michigan         = ' (+1,20)
    print #Severence_pay_YTD_Company_MI           () edit $$$,$$$,$$$,$$9.99mi
 
    print 'Severance Pay QTD New York         = ' (+1,20)
    print #Severence_pay_QTD_Company_NY           () edit $$$,$$$,$$$,$$9.99mi
    print 'Severance Pay YTD New York         = ' (+1,20)
    print #Severence_pay_YTD_Company_NY           () edit $$$,$$$,$$$,$$9.99mi
 
    let #Severence_pay_QTD_Company    = 0
    let #Severence_pay_YTD_Company    = 0
    let #Severence_pay_QTD_Company_MI = 0
    let #Severence_pay_YTD_Company_MI = 0
    let #Severence_pay_QTD_Company_NY = 0
    let #Severence_pay_YTD_Company_NY = 0
   #endif
 
   #ifdef Moving_exp_3rdParty_selection
    print 'Moving Expense 3rd Party QTD       = ' (+1,20)
    print #Moving_exp_3rdParty_QTD_Company      () edit $$$,$$$,$$$,$$9.99mi
    print 'Moving Expense 3rd Party YTD       = ' (+1,20)
    print #Moving_exp_3rdParty_YTD_Company      () edit $$$,$$$,$$$,$$9.99mi
    let #Moving_exp_3rdParty_QTD_Company = 0
    let #Moving_exp_3rdParty_YTD_Company = 0
   #endif
 
   #ifdef Meal_Allowances_selection
    print 'Meal Allowances QTD                = ' (+1,20)
    print #Meal_Allowances_QTD_Company      () edit $$$,$$$,$$$,$$9.99mi
    print 'Meal Allowances YTD                = ' (+1,20)
    print #Meal_Allowances_YTD_Company      () edit $$$,$$$,$$$,$$9.99mi
    let #Meal_Allowances_QTD_Company = 0
    let #Meal_Allowances_YTD_Company = 0
   #endif
 
  if round(#Company_Total_Tax_Non_941,2) <> 0
    print 'Non-941 Taxes Withheld (FIT)       = ' (+2,20)
    print #Company_Total_Tax_Non_941              () edit $$$,$$$,$$$,$$9.99mi
    print 'Non-941 Taxable Wages  (FIT)       = ' (+1,20)
    print #Company_Total_Taxable_Wages_Non_941    () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Company_Generated_Taxes_Qtd,2) <> 0
    print 'Employer Generated QTD Taxes       = ' (+2,20)
    print #Company_Generated_Taxes_Qtd              () edit $$$,$$$,$$$,$$9.99mi
    print '  (Tax Class ''B'' EE/ER Taxes' ()
  end-if
 
  if round(#Company_Generated_Taxes_Ytd,2) <> 0
    print 'Employer Generated YTD Taxes       = ' (+2,20)
    print #Company_Generated_Taxes_Ytd              () edit $$$,$$$,$$$,$$9.99mi
    print '  (Tax Class ''B'' EE/ER Taxes' ()
  end-if
 
  let #Company_Total_Tax_Non_941 = 0
  let #Company_Total_Taxable_Wages_Non_941 = 0
 
  if round(#Company_Total_Tip_Wages_Qtd,2) <> 0
    print '  Qtd Tip Wages          = '(+1,10)
    print #Company_Total_Tip_Wages_Qtd () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Company_Total_Tip_Tax_Qtd,2) <> 0
    print '  Qtd Tip Taxes          = '(+1,10)
    print #Company_Total_Tip_Tax_Qtd () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Unknown_Tax_Qtd,2) <> 0
    print '  Qtd Unknown Taxes      = '(+1,10)
    print #Unknown_Tax_Qtd () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Ignore_Tax_Qtd,2) <> 0
    print '  Qtd not reported Tax   = ' (+2,10)
    print #Ignore_Tax_Qtd  () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Company_Total_Tip_Wages_Ytd,2) <> 0
    print '  Ytd Tip Wages          = '(+2,10)
    print #Company_Total_Tip_Wages_Ytd () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Company_Total_Tip_Tax_Ytd,2) <> 0
    print '  Ytd Tip Taxes          = '(+1,10)
    print #Company_Total_Tip_Tax_Ytd () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Unknown_Tax_Ytd,2) <> 0
    print '  Ytd Unknown Taxes      = '(+1,10)
    print #Unknown_Tax_Ytd () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  if round(#Ignore_Tax_Ytd,2) <> 0
    print '  Ytd not reported Tax   = ' (+1,10)
    print #Ignore_Tax_Ytd  () edit $$$,$$$,$$$,$$9.99mi
  end-if
 
  #if {SITE_ID} = 'ARK1'
   print '*** The following Company Paid taxes refer to the California' (+2,1)
   print '    and New Jersey (Tax Classes I, and J) Company paid SDI taxes.' (+1,1)
   print '  ER Paid Qtd Taxes = '(+2,10)
   print #CoPaid_Qtd                  () edit $$$,$$$,$$$,$$9.99mi
   print '  ER Paid Ytd Taxes = '(+1,10)
   print #CoPaid_Ytd                  () edit $$$,$$$,$$$,$$9.99mi
   let #Tax010_Qtd = #Company_Total_Tax_Qtd_Not_Generated - #CoPaid_Qtd
   let #Tax010_Ytd = #Company_Total_Tax_Ytd_Not_Generated - #CoPaid_Ytd
   print '  TAX010 QTD Taxes (less ER Paid Taxes)      = '(+1,10)
   print #Tax010_Qtd                  () edit $$$,$$$,$$$,$$9.99mi
   print '  TAX010 YTD Taxes (less ER Paid Taxes)      = '(+1,10)
   print #Tax010_Ytd                  () edit $$$,$$$,$$$,$$9.99mi
  #endif
 
  print '  Miscellaneous Company extract totals completed.' (+2,10)
 end-if
 
 !11/16/06 updated
 !-----------------
 #ifdef THIRD_PARTY_SICK_DED
   do third-party-sick-quarterly-report
 #endif
 
 !Fein Totals
 !-----------
 #ifdef SUBTOTAL_FEIN
  if #Tot = 2
   print 'Quarterly Extract Totals for FEIN: ' (+2,10)
   print $Current_Fein                         ()
 
   print '  Qtd Taxes              = '(+1,10)
   print #Fein_Total_Tax_Qtd_Not_Generated                     () edit $$$,$$$,$$$,$$9.99mi
   print '  ** - does NOT include generated taxes by extract ' ()
   print '  Qtd Total Taxes        = '(+1,10)
   print #Fein_Total_Tax_Qtd          () edit $$$,$$$,$$$,$$9.99mi
   print '  ** - DOES include generated taxes by extract' ()
 
   if round(#Fein_Total_Tax_Qtd_PRE_Generated,2) <> 0
     print ', which include PR-SDI-ER Qtd Taxes = ' ()     !5/16/00
     print #Fein_Total_Tax_Qtd_PRE_Generated        () edit $$$,$$$,$$$,$$9.99mi      !5/16/00
   end-if
 
   print '  Qtd Taxable Wages      = '(+1,10)
   print #Fein_Total_Txgrs_Qtd        () edit $$$,$$$,$$$,$$9.99mi
   print '  Qtd Gross Wages        = '(+1,10)
   print #Fein_Total_Nlgrs_Qtd        () edit $$$,$$$,$$$,$$9.99mi
 
   print '  Ytd Taxes              = '(+2,10)
   print #Fein_Total_Tax_Ytd_Not_Generated       () edit $$$,$$$,$$$,$$9.99mi
   print '  ** - does NOT include generated taxes by extract ' ()
   print '  Ytd Total Taxes        = '(+1,10)
   print #Fein_Total_Tax_Ytd          () edit $$$,$$$,$$$,$$9.99mi
   print '  ** - DOES include generated taxes by extract ' ()
   print '  Ytd Taxable Wages      = '(+1,10)
   print #Fein_Total_Txgrs_Ytd        () edit $$$,$$$,$$$,$$9.99mi
   print '  Ytd Gross Wages        = '(+1,10)
   print #Fein_Total_Nlgrs_Ytd        () edit $$$,$$$,$$$,$$9.99mi
 
   print '  Miscellaneous FEIN extract totals' (+2,10)
   print '  ---------------------------------' (+1,10)
 
   if round(#Fein_Total_Tax_Non_941,2) <> 0
     print 'Non-941 Taxes Withheld (FIT)       = ' (+2,20)
     print #Fein_Total_Tax_Non_941                 () edit $$$,$$$,$$$,$$9.99mi
     print 'Non-941 Taxable Wages  (FIT)       = ' (+1,20)
     print #Fein_Total_Taxable_Wages_Non_941       () edit $$$,$$$,$$$,$$9.99mi
   end-if
 
   let #Fein_Total_Tax_Qtd_Not_Generated = 0
   let #Fein_Total_Tax_Qtd = 0
   let #Fein_Total_Txgrs_Qtd = 0
   let #Fein_Total_Nlgrs_Qtd = 0
 
   let #Fein_Total_Tax_Ytd_Not_Generated = 0
   let #Fein_Total_Tax_Ytd = 0
   let #Fein_Total_Txgrs_Ytd = 0
   let #Fein_Total_Nlgrs_Ytd = 0
 
   let #Fein_Total_Tax_Qtd_PRE_Generated = 0
   let #Fein_Total_Tax_Non_941 = 0
   let #Fein_Total_Taxable_Wages_Non_941 = 0
 
  end-if
 #endif
 
  !ADP Compid totals
  !-----------------
  #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
   if #Tot = 2
 
    #if {SITE_ID} = 'CZB1'
      print 'Quarterly Extract Totals for Rollup Company: ' (+2,10)
    #else
      print 'Quarterly Extract Totals for ADP Compid: ' (+2,10)
    #endif
 
    print $Current_ADP_Compid                   ()
 
    print '  Qtd Taxes              = '(+1,10)
    print #ADP_Compid_Total_Tax_Qtd_Not_Generated               () edit $$$,$$$,$$$,$$9.99mi
    print '  ** - does NOT include generated taxes by extract ' ()
    print '  Qtd Total Taxes        = '(+1,10)
    print #ADP_Compid_Total_Tax_Qtd    () edit $$$,$$$,$$$,$$9.99mi
    print '  ** - DOES include generated taxes by extract' ()
 
    if round(#ADP_Compid_Total_Tax_Qtd_PRE_Generated,2) <> 0
      print ', which include PR-SDI-ER Qtd Taxes = ' ()     !5/16/00
      print #ADP_Compid_Total_Tax_Qtd_PRE_Generated  () edit $$$,$$$,$$$,$$9.99mi      !5/16/00
    end-if
 
    print '  Qtd Taxable Wages      = '(+1,10)
    print #ADP_Compid_Total_Txgrs_Qtd  () edit $$$,$$$,$$$,$$9.99mi
    print '  Qtd Gross Wages        = '(+1,10)
    print #ADP_Compid_Total_Nlgrs_Qtd  () edit $$$,$$$,$$$,$$9.99mi
 
    print '  Ytd Taxes              = '                 (+2,10)
    print #ADP_Compid_Total_Tax_Ytd_Not_Generated       () edit $$$,$$$,$$$,$$9.99mi
    print '  ** - does NOT include generated taxes by extract ' ()
    print '  Ytd Total Taxes        = '      (+1,10)
    print #ADP_Compid_Total_Tax_Ytd          () edit $$$,$$$,$$$,$$9.99mi
    print '  ** - DOES include generated taxes by extract ' ()
    print '  Ytd Taxable Wages      = '      (+1,10)
    print #ADP_Compid_Total_Txgrs_Ytd        () edit $$$,$$$,$$$,$$9.99mi
    print '  Ytd Gross Wages        = '      (+1,10)
    print #ADP_Compid_Total_Nlgrs_Ytd        () edit $$$,$$$,$$$,$$9.99mi
 
    if round(#ADP_Compid_Total_Tax_Non_941,2) <> 0
      print '  Miscellaneous ADP Compid extract totals' (+2,10)
      print '  ---------------------------------------' (+1,10)
      print 'Non-941 Taxes Withheld (FIT)       = '     (+2,20)
      print #ADP_Compid_Total_Tax_Non_941               ()        edit $$$,$$$,$$$,$$9.99mi
      print 'Non-941 Taxable Wages  (FIT)       = '     (+1,20)
      print #ADP_Compid_Total_Taxable_Wages_Non_941     ()        edit $$$,$$$,$$$,$$9.99mi
    end-if
 
    let #ADP_Compid_Total_Tax_Qtd_Not_Generated = 0
    let #ADP_Compid_Total_Tax_Qtd   = 0
    let #ADP_Compid_Total_Txgrs_Qtd = 0
    let #ADP_Compid_Total_Nlgrs_Qtd = 0
 
    let #ADP_Compid_Total_Tax_Ytd_Not_Generated = 0
    let #ADP_Compid_Total_Tax_Ytd   = 0
    let #ADP_Compid_Total_Txgrs_Ytd = 0
    let #ADP_Compid_Total_Nlgrs_Ytd = 0
 
    let #ADP_Compid_Total_Tax_Qtd_PRE_Generated = 0
    let #ADP_Compid_Total_Tax_Non_941           = 0
    let #ADP_Compid_Total_Taxable_Wages_Non_941 = 0
 
   end-if
  #endif
 
      #ifdef  enable_performance_monitor
         do Get-Current-Time
         move 'Print-TaxBalance-Recap' to $debug-proc1
         move ' '    to $debug-table1
         do log-delta-time
      #endif
 
End-procedure
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-Next-State                                             !
! Descr:     Get The Next state to printout                             !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure Get-Next-State
 
  if #next_state_inx > 51
    let $Next_State = '**'
  else
    get $Next_State from States(#next_state_inx) State
  end-if
 
end-procedure
 
!#ifndef STRIPPED_PBZQTR_REPORT
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Print-TaxBalance-Detail                                        !
! Descr:     Prints Details of Tax Balances                                 !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Print-TaxBalance-Detail
 
   if $SelectEmplid <> ''
     #debugd show 'Print-TaxBalance-Detail: ' $TB_State ' ' &C.TAX_CLASS ' ' $TB_Locality ' Res PSD: ' $RES_PSD_CD1
   end-if
 
       if #current-line > 56
          New-Page
       end-if
 
       let $State = rtrim($TB_State,' ')
       let $Locality = rtrim($TB_Locality,' ')
       do get-state-tax-data
 
       if rtrim($Locality,' ') = ''
         do get-local-tax-data
       end-if
 
       if rtrim(&C.EMPLID,' ')  <> rtrim($Empl ,' ')
         Print &C.EMPLID                  (+2,50)
         Print &A1.NAME                   (,+2)
         let $Empl = rtrim(&C.EMPLID,' ')
       end-if
 
       If $State = '$U' OR $State = '$E'
             Print 'U.S. Federal '            (+1, 1)
       Else
         Print $StateName                 (+1, 1)
         If Rtrim($Locality,' ') <> ''
            Print $Locality               (0, 20, 7)
            if rtrim($RES_PSD_CD1,' ') <> ''
             print '/'                     ()
             print $RES_PSD_CD1        (0,0,6)
            else
             print '       '               (0,0,7)
            end-if
         #ifdef GETLCLDATA_751                    !7.51  (LocalAbbr changed names)
           Print $Localabbr              ()
         #else
           Print &LOCALITY_ABBRV         ()
         #endif
 
         End-if
       End-if
 
       let $Tax_Class_Parm = substr(&C.TAX_CLASS,1,1)
       do Get-XlatTable-Descr
 
       Print $TaxClass_Descr           (0,37,10)
 
       if $Tax_Class_Parm = 'H'                         !prior to 7/7/09, this was: &C.NLGRS_YTD = 0 or &C.NLGRS_QTD = 0
 
          #ifdef NLGRS_FROM_CHECK_YTD_AMOUNT
           do calc-gross99
           let #Grs_Ytd = #Total_Gross_ytd
           let #Grs_Qtd = #Total_Gross_qtd
          #else
           Let #Grs_Ytd = &C.TXGRS_YTD
           Let #Grs_Qtd = &C.TXGRS_QTD
          #endif
 
       else
           Let #Grs_Qtd = &C.NLGRS_QTD
           Let #Grs_Ytd = &C.NLGRS_YTD
       end-if
 
       if &C.BALANCE_QTR = #RptQtr
         Print &C.TXGRS_QTD              (0,90)  edit 9999999999.99
         Print #Grs_Qtd                  (0,104) edit 9999999999.99
         Print &C.TAX_QTD                (0,118) edit 9999999999.99
       end-if
 
       Print &C.TXGRS_YTD              (0,133) edit 99999999999.99
       Print #Grs_Ytd                  (0,148) edit 99999999999.99
       Print &C.TAX_YTD                (0,163) edit 99999999999.99
 
End-procedure
!#endif
 
#if {Peoplesoft_Version} >= '8.8'
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-XlatTable-Descr                                        !
! Descr:     Get The Tax Class Description.                             !
!                                                                       !
!---------------------------------------------------------------------- !
begin-procedure Get-XlatTable-Descr
 
  let #t_inx = 0
  while (#t_inx < #Tax_Class_Lookup_Count)
    get $t from TaxClasses(#t_inx) Tax_Class_Lookup
    let $t_trimmed = rtrim($t,' ')
    if $t_trimmed = $Tax_Class_Parm
      get $TaxClass_Descr from TaxClasses(#t_inx) Tax_Class_Descr
      goto Done_Xlat
    end-if
    add 1 to #t_inx
  end-while
 
   move 'TAX_CLASS'          to $FieldName
   move  $Tax_Class_Parm     to $FieldValue
   do Read-Translate-Table
   move $XlatShortName to $TaxClass_Descr
 
   if #Tax_Class_Lookup_Count < {MAX_TAX_CLASSES}
      put $Tax_Class_Parm into TaxClasses(#Tax_Class_Lookup_Count) Tax_Class_Lookup
      put $TaxClass_Descr into TaxClasses(#Tax_Class_Lookup_Count) Tax_Class_Descr
      add 1 to #Tax_Class_Lookup_Count
   else
      #debugd show 'Warning: TaxClasses Array is too small'
   end-if
 
Done_xlat:
 
end-procedure
 
#else
 
!********************************************************************** !
!---------------------------------------------------------------------- !
! Procedure: Get-XlatTable-Descr                                        !
! Descr:     Get The Tax Class Description.                             !
!                                                                       !
!-----------------------------------------------------------------------!
 
begin-procedure Get-XlatTable-Descr
 
  let #t_inx = 0
  while (#t_inx < #Tax_Class_Lookup_Count)
    get $t from TaxClasses(#t_inx) Tax_Class_Lookup
    let $t_trimmed = rtrim($t,' ')
    if $t_trimmed = $Tax_Class_Parm
      get $TaxClass_Descr from TaxClasses(#t_inx) Tax_Class_Descr
      goto Done_Xlat
    end-if
    add 1 to #t_inx
  end-while
 
  #ifdef show_selects
     #debugd show 'Processing XLATTABLE...'
  #endif
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
Begin-Select
XLATSHORTNAME
XLATLONGNAME
 
  let $TaxClass_Descr = rtrim(&XLATSHORTNAME,' ')
 
 #if {SITE_ID} = 'TBN1'
  From PSXLATITEM
  where FIELDNAME  = 'TAX_CLASS' And
       FIELDVALUE = $Tax_Class_Parm
 #else
  From XLATTABLE
  where FIELDNAME  = 'TAX_CLASS' And
       LANGUAGE_CD = 'ENG' And
       FIELDVALUE = $Tax_Class_Parm
 #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-XlatTable-Descr' to $debug-proc1
     move 'XLATTABLE'    to $debug-table1
     do log-delta-time
  #endif
 
  if #Tax_Class_Lookup_Count < {MAX_TAX_CLASSES}
      put $Tax_Class_Parm into TaxClasses(#Tax_Class_Lookup_Count) Tax_Class_Lookup
      put $TaxClass_Descr into TaxClasses(#Tax_Class_Lookup_Count) Tax_Class_Descr
      add 1 to #Tax_Class_Lookup_Count
  else
      #debugd show 'Warning: TaxClasses Array is too small'
  end-if
 
Done_xlat:
 
end-procedure
 
#endif
 
#ifndef SKIP_SUI_SUMMARY
!----------------------------------------------------------------------     !
! Procedure: Load-SUI-Array                                                 !
! Descr:     Load the SUI rates into the SUI array.                         !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Load-SUI-Array
 
  let #Last_SUI_Cnt     = 0
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT
H.STATE
H.SUT_EXPERIENCE_RT
H.EMPLOYER_ID_SWT
 
  let $h = rtrim(&H.STATE,' ')
  
  if length($h) = 2
    let #SuiExperienceRt = &H.SUT_EXPERIENCE_RT
    let $EmployerIdSWT = rtrim(&H.EMPLOYER_ID_SWT,' ')
    PUT  $h                  -
         #SuiExperienceRt    -
         $EmployerIdSWT      -
    INTO SUI(#LAST_SUI_CNT)  -
         SUI_State           -
         SUI_Experience_Rt   -
         SUI_Employer_ID_SWT
 
    add 1 to #LAST_SUI_CNT
   end-if
   
FROM PS_CO_STATETAX_TBL H {NOLOCK_SQL}
WHERE H.COMPANY = $Current_Company AND
      H.STATE <> ' ' AND
      H.EFF_STATUS = 'A' AND
      H.EFFDT=
            (SELECT MAX(EFFDT)
            FROM PS_CO_STATETAX_TBL {NOLOCK_SQL}
               Where COMPANY    = H.COMPANY
                 AND STATE      = H.STATE
                 AND EFF_STATUS = H.EFF_STATUS
                 AND EFFDT <= $Qtr_End_Native)
   ORDER BY H.STATE
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Load-SUI-Array' to $debug-proc1
    move 'PS_CO_STATETAX_TBL'    to $debug-table1
    do log-delta-time
 #endif
 
end-procedure
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: SUI-Rate-Lookup                                           !
! Desc:      This procedure does a lookup for the SUI rate applicable  !
!            to an employee.                                           !
!----------------------------------------------------------------------!
begin-procedure SUI-Rate-Lookup
 
    let #Mid                    = 0
    let #Output_SUI_Rate        = 0
    let $Output_Employer_ID_SWT = ' '
 
    while #Mid < #Last_SUI_Cnt
      get $SUI_State           -
          #SUI_Experience_Rt   -
          $SUI_Employer_ID_SWT -
      from SUI(#Mid)           -
           SUI_State           -
           SUI_Experience_Rt   -
           SUI_Employer_ID_SWT
 
      if $SUI_State = $State_trimmed
         let #Output_SUI_Rate  = #SUI_Experience_Rt
         let $Output_Employer_ID_SWT = rtrim($SUI_Employer_ID_SWT,' ')
         break
      end-if
 
      add 1 to #Mid
 
    end-while
 
end-procedure
#endif
 
 
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT
!----------------------------------------------------------------------!
begin-procedure Process-Misc-Employees
 
 #ifdef SUBTOTAL_ADP_COMPID_EXTRACT_MISC_EMPLOYEES
 
    let $imputed_income_already_added = ''
    let #Last_TaxBalance_Cnt= 0
    let $C_Company = $Current_Company
    let #Misc_empls = 0
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move $display_dt to $display_dt0
  #endif
 
BEGIN-SELECT
TBX.COMPANY
TBX.EMPLID
 
  if $SelectEmplid <> ''
   if $SelectEmplid <> rtrim(&TBX.EMPLID,' ')
     #debugd show 'Process-misc-employees, SUBTOTAL_ADP_COMPID_EXTRACT_MISC_EMPLOYEES, bypassing ' &TBX.EMPLID
     goto skip_misc
   end-if
  end-if
 
  add 1 to #employee_total
  add 1 to #Misc_empls
 
  show 'Process-Misc-Employees: EXISTING YE Data and NO Tax Balances. ADP Compid ' $Current_ADP_Compid ', Emplid ' &TBX.EMPLID
  move &TBX.COMPANY to $Current_Company
  let $C_Company = $Current_Company
  let $Misc_C_Company = $C_Company
 
  let $Current_Emplid = &TBX.EMPLID
 
  do get-w2-amounts
 
  #ifndef ADP_TAX_AMEND
    #ifdef Process_1099s
       do Read-Employee-Data-1099s                             !in adpgepen.sqc
    #endif
  #endif
 
  let $skip_report_detail = 't'   !this eliminates the emcare issue (no tb ee, with detail on)
 
  do Init-Job-Data
  do get-job-data
 
  !added 12/27/07
  !----------------------------------------------------------------
  move $Current_Company to $Company_in_extract
  #ifdef PAYGROUP_ROLLUP
    move $Company_in_extract to $Extract_Compid
  #else
    let $Extract_Compid = $Company_in_extract || ' ' || upper($Job_Paygroup)
 
    #ifdef SITE_ID
     #if {SITE_ID} = 'TUH1'   ! !TUH-TW1&TB1 remapping 3/20/8
      if rtrim($Extract_Compid,' ') = 'TUH TW1' or rtrim($Extract_Compid,' ') = 'TUH TB1'
        let $Extract_Compid = 'TUH TW1&TB1'
      end-if
     #endif
    #endif
 
  #endif
 
  do Extract-Personal-Data
  if rtrim($Personal_Emplid,' ') = ''
    move &TBX.EMPLID to $Emp_Emplid  !this handles missing personal data for these folks
  else
    do Process-Employee-Record
  end-if
 
  do Process-Quarterly-Record
  let #Last_TaxBalance_Cnt= 0
  clear-array name=TaxBalance
 
skip_misc:
 
 from (select YE_EE.COMPANY, YE_EE.EMPLID from PS_YE_EE YE_EE
    
    #ifdef USE_INT_CRITERIA
     where YE_EE.CALENDAR_YEAR    = int(\$RptYearZ\)
    #else
     where YE_EE.CALENDAR_YEAR    = #RptYear
    #endif
 
      and   YE_EE.PROCESS_FLAG     <> 'V'
 
      #if {SITE_ID} = 'GE01'
       #ifdef Process_w2s_only
        and  YE_EE.TAXFORM_ID = 'W'
       #endif
       #ifndef ADP_TAX_AMEND
          #ifdef Process_1099s_only
            and  YE_EE.TAXFORM_ID <> 'W'
          #endif
       #endif
      #endif
 
       minus
       select TAX_BAL.COMPANY, TAX_BAL.EMPLID from PS_TAX_BALANCE{WAREHOUSE_SUFFIX} TAX_BAL

    #ifdef USE_INT_CRITERIA
      where TAX_BAL.BALANCE_YEAR  = int(\$RptYearZ\)
    #else
       where TAX_BAL.BALANCE_YEAR = #RptYear
    #endif

       and   TAX_BAL.BALANCE_ID   = $Calendar_Year_Id ) TBX,
       PS_YE_EE YE_EEE,
       PS_TF_COMPANY_XREF CT2
 
 #ifdef USE_INT_CRITERIA
  where YE_EEE.CALENDAR_YEAR  = int(\$RptYearZ\)
 #else
  where YE_EEE.CALENDAR_YEAR  = #RptYear
 #endif
 and   YE_EEE.PROCESS_FLAG  <> 'V'
 and   YE_EEE.COMPANY        = TBX.COMPANY
 and   YE_EEE.EMPLID         = TBX.EMPLID
 
 and CT2.TF_COMPANY        = $Current_ADP_Compid
 
 and   CT2.COMPANY  = TBX.COMPANY
 and   CT2.EFFDT    = (select max(EFFDT) from PS_TF_COMPANY_XREF
                       where COMPANY = CT2.COMPANY
                       and   EFFDT  <= $AsOfDate)
 
!---------------------------------------------------------------------------------------
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
#endif
 
  if #misc_empls > 0
   #debugd show 'Process-Misc-Employees: Current_ADP_Compid ' $Current_ADP_Compid ' has ' #misc_empls ' associates extracted.'
   let #tot_misc_empls = #tot_misc_empls + #misc_empls
  end-if
 end-procedure
 
#else  !Normal.. sorted by COMPANY
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: Process-Misc-Employees                                    !
! Desc:      This procedure identifies employees that have W-2 box     !
!            amounts and NO tax balances for imputed wage purposes     !
!----------------------------------------------------------------------!
begin-procedure Process-Misc-Employees
 
#ifndef Skip_Processing_Misc_Employees
 
  !3/11/08 save prior taxcode info
  let $Save_Cur_State      = $Cur_State
  let $Save_Cur_Tax_Class  = $Cur_Tax_Class
  let $Save_Cur_Locality   = $Cur_Locality
  let $Save_Cur_Resident   = $Cur_Resident
  let $Save_Current_Emplid = $Current_Emplid
 
  let $imputed_income_already_added = ''
  let #Last_TaxBalance_Cnt= 0
  let $C_Company = $Current_Company
  let #Misc_empls = 0
 
  #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
  #endif
 
  #if {SITE_ID} = 'SQP1'
     let $_TableAlias = 'YE_DATA'  ! (PS_YE_DATA)
     do Security-Param
     #debugd show ' '
     #debugd show 'SQP1: Process-Misc-Employees PS_YE_DATA: SecurityClauseWithoutERN = ' $SecurityClauseWithoutERN
     !Let $SecurityClauseWithoutERN  = ' AND EXISTS (SELECT ' || '''X''' || ' FROM PS_FAST_SQR_SEC_VW SCRTY
     !    WHERE SCRTY.EMPLID = ' || $_TableAlias || '.EMPLID
     !                    AND SCRTY.OPRID = ''' || $prcs_oprid  || ''')'
     #debugd show ' '
  #endif
 
BEGIN-SELECT
YE_DATA.EMPLID
YE_DATA.COMPANY
YE_DATA.TAXFORM_ID
#ifdef SUBTOTAL_FEIN_EXTRACT1
COMISC.FEDERAL_EIN         
#endif

  #ifdef JAT_TESTING
     let $JAT_Emplid = &YE_DATA.EMPLID
     do custom-emplid-selection  !in probiz.sqc
     if $process_test_emplid = 't'
      #ifdef debug_JAT_TESTING
       #debugd show 'Process-Misc-Employees: Processing JAT test emplid: ' $JAT_Emplid
      #endif
     else
       goto bypass_Misc_Employees
     end-if
  #endif
 
  add 1 to #employee_total
  add 1 to #Misc_empls
 
  let $Current_Company = rtrim(&YE_DATA.COMPANY,' ')
  show 'Process-Misc-Employees: EXISTING YE Data and NO Tax Balances. Company: ' $Current_Company ', Emplid: ' &YE_DATA.EMPLID
 
  let $C_Company = $Current_Company
  let $Misc_C_Company = $C_Company
 
  let $Current_TAXFORM_ID = rtrim(&YE_DATA.TAXFORM_ID,' ')
  let $Current_Emplid = &YE_DATA.EMPLID
  do get-w2-amounts
 
  let $skip_report_detail = 't'   !this eliminates the emcare issue (no tb ee, with detail on)
 
  do Init-Job-Data
  do get-job-data
 
  !added 12/27/07
  !----------------------------------------------------------------
  move $Current_Company to $Company_in_extract
  #ifdef PAYGROUP_ROLLUP
    move $Company_in_extract to $Extract_Compid
  #else
    #ifdef SUBTOTAL_FEIN_EXTRACT1
      let $Company_in_extract = $Extract_Compid
    #else
      let $Extract_Compid = $Company_in_extract || ' ' || upper($Job_Paygroup)
      #if {SITE_ID} = 'TUH1'   ! !TUH-TW1&TB1 remapping 3/20/8
        if rtrim($Extract_Compid,' ') = 'TUH TW1' or rtrim($Extract_Compid,' ') = 'TUH TB1'
          let $Extract_Compid = 'TUH TW1&TB1'
        end-if
      #endif
    #endif
  #endif
 
  !12/19/2011 added for SCM1
  !------------------------------
  #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
    let $Company = $Current_Company
    do get-paygroup-data-SCM1
    let $Extract_compid = $SCM1_Compid
  #endif

  #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
      let $Company = $Current_Company
      #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT_include_Company
        let $Extract_compid = $Current_Company || '_' || $Job_Business_Unit  !change on 12/14/16 to include Company in header
      #else
        let $Extract_compid = $Job_Business_Unit
      #endif
  #endif
  
  #ifdef SUBTOTAL_FEIN_EXTRACT1
    let $Company = $Current_Company
    let #Current_FEIN = &COMISC.FEDERAL_EIN              !3/28/01 changes
    move #Current_FEIN to $FedEIN 099999999
    move $FedEIN to $Extract_Compid
  #endif
 
  show 'Process-Misc-Employees: Extract_Compid: ' $Extract_Compid ' for Current_Company ' $Current_Company ' emplid ' &YE_DATA.EMPLID ' BusUnit ' $Job_Business_Unit
  !----------------------------------------------------------------
  do Extract-Personal-Data
 
  if rtrim($Personal_Emplid,' ') = ''
    move &YE_DATA.EMPLID to $Emp_Emplid  !this handles missing personal data for these folks
  else
    do Process-Employee-Record
  end-if
 
  do Process-Quarterly-Record
  let #Last_TaxBalance_Cnt= 0
  clear-array name=TaxBalance
 
bypass_Misc_Employees:
 
 !see who's in YE_DATA (not voided) and NOT in Tax Balances
 !---------------------------------------------------------
 FROM PS_YE_DATA YE_DATA, PS_YE_EE YE_EE
 #ifdef SUBTOTAL_FEIN_EXTRACT1
  , PS_COMPANY_TBL COMISC
 #endif
 
 #ifdef USE_INT_CRITERIA
  WHERE YE_DATA.CALENDAR_YEAR = int(\$RptYearZ\)
 #else
  WHERE YE_DATA.CALENDAR_YEAR = #RptYear
 #endif

 
  AND ( YE_DATA.COMPANY = $Current_Company OR YE_DATA.EMPLID = $SelectEmplid )            ! <-- this could be SLOW!!
 
  AND YE_DATA.COMPANY           = YE_EE.COMPANY      ! 11/11/05 added to avoid dups
  AND YE_DATA.EMPLID            = YE_EE.EMPLID
  AND YE_DATA.CALENDAR_YEAR     = YE_EE.CALENDAR_YEAR
  AND YE_DATA.TAXFORM_ID        = YE_EE.TAXFORM_ID
  AND YE_EE.PROCESS_FLAG   <> 'V'
 
  AND NOT EXISTS (select 'x' from PS_TAX_BALANCE{WAREHOUSE_SUFFIX} TAX_BAL
   WHERE TAX_BAL.BALANCE_YEAR    = YE_DATA.CALENDAR_YEAR
     AND TAX_BAL.BALANCE_ID      = $Calendar_Year_Id
     AND TAX_BAL.COMPANY         = YE_DATA.COMPANY
     AND TAX_BAL.TXGRS_YTD <> 0  !12/8/16 changed from '0'
     AND TAX_BAL.EMPLID          = YE_DATA.EMPLID)
 
     #ifdef TEST_EMPLID
       AND YE_DATA.EMPLID = '{TEST_EMPLID}'
     #endif
 
     #if {SITE_ID} = 'SQP1'
       [$SecurityClauseWithoutERN]       !select just the rows allowed.
     #endif
 
     #ifdef TEST_EMPLID_IN_RUN_CONTROL
       #ifdef MVS                   !OS400 - /.../, NT - [...], MVS - \...\
         \$SelectEmplidSelection_YE\
       #else
         [$SelectEmplidSelection_YE]
       #endif
     #endif

     #ifdef SUBTOTAL_FEIN_EXTRACT1
          AND YE_DATA.COMPANY = COMISC.COMPANY
          AND COMISC.EFFDT = (SELECT MAX(EFFDT)
           FROM   PS_COMPANY_TBL COMISC1 {NOLOCK_SQL}
           WHERE  COMISC1.COMPANY = COMISC.COMPANY
             AND  COMISC1.EFFDT  <= $AsOfDate)
    #endif

    #ifdef SUBTOTAL_FEIN_EXTRACT1
        ORDER BY COMISC.FEDERAL_EIN
    #else
        ORDER BY YE_DATA.COMPANY
    #endif

 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Process-Misc-Employees' to $debug-proc1
     move 'PS_YE_DATA'    to $debug-table1
     do log-delta-time
  #endif
  
 #if {SITE_ID} = 'DOW1'    !only for companies C04 D27 D40
  if $adp_w2_records = 't'
   if $current_company = 'C04' or
      $Current_Company = 'D27' or
      $Current_Company = 'G84'
      #ifndef ADP_TAX_AMEND
       #ifdef Process_1099s
        show 'Calling Read-Misc-Employee-Data-1099s DOW1, for company ' $Current_Company
        do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
       #endif
      #endif
   end-if
  end-if
 
 #endif

 #if {SITE_ID} = 'AWP1'     
  if $adp_w2_records = 't'
      #ifndef ADP_TAX_AMEND
        #ifdef Process_1099s
         show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
        #endif
      #endif
  end-if
 #endif
 
 #if {SITE_ID} = 'DTC1'    !only for companies C04 D27 D40
  if $adp_w2_records = 't'
      #ifndef ADP_TAX_AMEND
        #ifdef Process_1099s
         show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
        #endif
      #endif
  end-if
 #endif
 
 #if {SITE_ID} = 'CSA1'    !only for companies C04 D27 D40
  if $adp_w2_records = 't'
      #ifndef ADP_TAX_AMEND
        #ifdef Process_1099s
         #debugd show ' '
         #debugd show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
        #endif
      #endif
  end-if
 #endif
 
 #if {SITE_ID} = 'IRC1'
  if $adp_w2_records = 't'
      #ifndef ADP_TAX_AMEND
        #ifdef Process_1099s
         #ifdef DEFINE_Read-Misc-Employee-Data-1099s
          #debugd show ' '
          if rtrim($Current_Company,' ') = ''
           let $Current_Company = $SelectCompany
          end-if
          #debugd show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
          do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
         #endif
        #endif
      #endif
  end-if
 #endif
 
  #if {SITE_ID} = 'CGI1'
   #ifndef ADP_TAX_AMEND
    #ifdef Process_1099s
     #ifdef DEFINE_Read-Misc-Employee-Data-1099s
      if $adp_w2_records = 't'
       let $1099_Company = 'f'
       do check-1099-company
       if rtrim($1099_Company,' ') <> 'f'
         #debugd show ' '
         #debugd show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
       end-if
      end-if
     #endif
    #endif
   #endif
  #endif
 
  #if {SITE_ID} = 'GCO1'
   #ifndef ADP_TAX_AMEND
    #ifdef Process_1099s
     #ifdef DEFINE_Read-Misc-Employee-Data-1099s
      if $adp_w2_records = 't'
         show ' '
         show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
      end-if
     #endif
    #endif
   #endif
  #endif

  #if {SITE_ID} = 'CEI1'
   #ifndef ADP_TAX_AMEND
    #ifdef Process_1099s
     #ifdef DEFINE_Read-Misc-Employee-Data-1099s
      if $adp_w2_records = 't'
         show ' '
         show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
      end-if
     #endif
    #endif
   #endif
  #endif

  #ifdef ADP_TAX_QA
   #ifndef ADP_TAX_AMEND
    #ifdef Process_1099s
     #ifdef DEFINE_Read-Misc-Employee-Data-1099s
      if $adp_w2_records = 't'
         show ' '
         show 'Calling Read-Misc-Employee-Data-1099s for company ' $Current_Company
         do Read-Misc-Employee-Data-1099s  !earnings balances but no YE_Data and no Tax_Balances...see adp1099.sqc
      end-if
     #endif
    #endif
   #endif
  #endif

  if #misc_empls > 0
   show 'Process-Misc-Employees: Current_Company ' $Current_Company ' has ' #misc_empls ' associates extracted.'
   let #tot_misc_empls = #tot_misc_empls + #misc_empls
  end-if
 
  let $Cur_State      = $Save_Cur_State
  let $Cur_Tax_Class  = $Save_Cur_Tax_Class
  let $Cur_Locality   = $Save_Cur_Locality
  let $Cur_Resident   = $Save_Cur_Resident
  let $Current_Emplid = $Save_Current_Emplid
 
  #if {SITE_ID} = 'SQP1'
     let $_TableAlias = 'C'  ! (PS_TAX_BALANCE)
     do Security-Param
     #debugd show ' '
     #debugd show 'SQP1: PS_TAX_BALANCE: SecurityClauseWithoutERN = ' $SecurityClauseWithoutERN
     !Let $SecurityClauseWithoutERN  = ' AND EXISTS (SELECT ' || '''X''' || ' FROM PS_FAST_SQR_SEC_VW SCRTY
     !    WHERE SCRTY.EMPLID = ' || $_TableAlias || '.EMPLID
     !                    AND SCRTY.OPRID = ''' || $prcs_oprid  || ''')'
     #debugd show ' '
  #endif
 
 #endif
 
end-procedure
 
#endif ! 12/2/2011
 
begin-procedure get-w2-amounts  !gets imputed income for ee's with NO tax balances
 
!The solution I came up with is to create a new variable, $misc_box_only.  I
!initialize $misc_box_only to 'y' at the start of the get-w2-amounts
!procedure.  Inside that procedure's select statement, I set $misc_box_only
!to 'n',
 
  let $misc_box_only = 'y'
 
begin-SELECT
YE_AMT.BOX
YE_AMT.W2_AMOUNT
YE_AMT.STATE
YE_AMT.LOCALITY
YE_AMT.TAXFORM_ID
 
  let #YE_AMT.W2_AMOUNT = &YE_AMT.W2_AMOUNT
 
!#ifndef STRIPPED_PBZQTR_REPORT
  if $RptDetail = 'Y'
     Do Print-w2-amounts-Detail
  end-if
!#endif
 
 let $misc_box_only = 'n'
 
 let $Cur_Tax_Class = ''
 let $Box = rtrim(&YE_AMT.BOX,' ')
 evaluate $Box
     when = '03'
        let $Cur_Tax_Class = 'D'
        break
     when = '05'
        let $Cur_Tax_Class = 'F'
        break
     when = '07'
        let $Cur_Tax_Class = 'G'  !added 9/27/06
        break
     when-other
        let $Cur_Tax_Class = 'H'
        break
 end-evaluate
 
 if rtrim($Cur_Tax_Class,' ') <> ''
 
   let $Cur_State    = rtrim(&YE_AMT.STATE,' ')
   let $Cur_Locality = rtrim(&YE_AMT.LOCALITY,' ')
   let #TXGRS_YTD_T  = #YE_AMT.W2_AMOUNT
 
   #if {SITE_ID} = 'DOW1'
     if $Cur_State = '$U' AND $Cur_Tax_Class = 'H'
       if $Current_Company = 'C04'
         let $Cur_State     = substr('{FORM945P_Taxcode}',1,2)
         let $Cur_Tax_Class = substr('{FORM945P_Taxcode}',3,1)
         let $Cur_Locality  = substr('{FORM945P_Taxcode}',4,9)
       end-if
     end-if
    #endif
 
    do insert-w2-amount-into-taxbalances
 
  end-if

 
 FROM  PS_YE_AMOUNTS YE_AMT
 WHERE YE_AMT.COMPANY         = $Current_Company
   
   #ifdef USE_INT_CRITERIA
    AND YE_AMT.CALENDAR_YEAR   = int(\$RptYearZ\)
   #else
    AND YE_AMT.CALENDAR_YEAR   = #RptYear
   #endif
   AND YE_AMT.EMPLID          = $Current_Emplid
   AND YE_AMT.TAXFORM_ID      = $Current_TAXFORM_ID
   AND YE_AMT.BOX in ('01','03','05','07','16','18')
 ORDER By YE_AMT.BOX
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'get-w2-amounts (pbzqtr)' to $debug-proc1
     move 'PS_YE_AMOUNTS'    to $debug-table1
     do log-delta-time
  #endif
 
end-procedure
 
begin-procedure Print-w2-amounts-Detail
 
       if #current-line > 56
          New-Page
       end-if
 
       let $State = rtrim(&YE_AMT.STATE,' ')
       let $Locality = rtrim(&YE_AMT.LOCALITY,' ')
       do get-state-tax-data
 
       if rtrim($Locality,' ') = ''
         do get-local-tax-data
       end-if
 
       if rtrim($Current_EMPLID,' ')  <> rtrim($Empl ,' ')
         Print $Current_EMPLID             (+2,50)
         let $Empl = rtrim($Current_EMPLID,' ')
       end-if
 
       If $State = '$U' OR $State = '$E'
             Print 'U.S. Federal '        (+1, 1)
       Else
         Print $StateName                 (+1, 1)
         If Rtrim($Locality,' ') <> ''
            Print $Locality               (0, 20, 7)
 
         #ifdef GETLCLDATA_751                    !7.51  (LocalAbbr changed names)
           Print $Localabbr              ()
         #else
           Print &LOCALITY_ABBRV         ()
         #endif
 
         End-if
       End-if
 
       print ', Box = '                  ()
       print &YE_AMT.BOX                 ()
       print ', TaxForm ID = '           ()
       print &YE_AMT.TAXFORM_ID          ()
       print ', W-2 Amount = '           ()
       print &YE_AMT.W2_AMOUNT           () edit 99999999999.99
 
end-procedure
 
begin-procedure insert-w2-amount-into-taxbalances
  let #L1 = 0
  let $found = 'f'
  while #L1 < #LAST_TAXBALANCE_CNT
    Add 1 to #L1
    get $TEST_ST                    -
        $TEST_LOCALITY              -
        $TEST_TAX_CLASS             -
       from TAXBALANCE(#L1)         -
             TaxBalance_State       -
             TaxBalance_Locality    -
             TaxBalance_Tax_Class
 
    if     $Cur_State = $TEST_ST
       AND $Cur_Locality = $TEST_LOCALITY
       AND $Cur_Tax_Class = $TEST_TAX_CLASS
 
      Array-Add 0                    -
                0                    -
                0                    -
                0                    -
                #TXGRS_YTD_T         -
                0                    -
                0                    -
                0                    -
                0                    -
                0                    -
                TO TAXBALANCE(#L1) -
                        TaxBalance_Nlgrs_Qtd  -
                        TaxBalance_Txgrs_Qtd  -
                        TaxBalance_Tax_Qtd    -
                        TaxBalance_Nlgrs_Ytd  -
                        TaxBalance_Txgrs_Ytd  -
                        TaxBalance_Tax_Ytd    -
                        TaxBalance_Tip_Wages_Qtd -
                        TaxBalance_Tip_Wages_Ytd -
                        TaxBalance_Tip_Tax_Qtd   -
                        TaxBalance_Tip_Tax_Ytd
 
         let $found = 't'
         break
     end-if
 
  end-while
 
  if $found = 'f'
    Add 1 to #Last_TaxBalance_Cnt
 
    put $Cur_State             -
        $Cur_Locality          -
        $Cur_Tax_Class         -
          0                    -
          0                    -
          0                    -
          0                    -
          #TXGRS_YTD_T         -
          0                    -
          0                    -
          0                    -
          0                    -
          0                    -
        INTO TAXBALANCE(#LAST_TAXBALANCE_CNT) -
            TaxBalance_State      -
            TaxBalance_Locality   -
            TaxBalance_Tax_Class  -
            TaxBalance_Nlgrs_Qtd  -
            TaxBalance_Txgrs_Qtd  -
            TaxBalance_Tax_Qtd    -
            TaxBalance_Nlgrs_Ytd  -
            TaxBalance_Txgrs_Ytd  -
            TaxBalance_Tax_Ytd -
            TaxBalance_Tip_Wages_Qtd -
            TaxBalance_Tip_Wages_Ytd -
            TaxBalance_Tip_Tax_Qtd   -
            TaxBalance_Tip_Tax_Ytd
 
  end-if
 
end-procedure
 
!4/30/03 Peoplesoft 8.8
!-----------------------
 
#if {PeopleSoft_Version} < '8.8'
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Extract-Personal-Data                                          !
! Descr:     Extract the Personal (Employee) data from Personal Data        !
!            table.                                                         !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Extract-Personal-Data
 
  LET $Personal_EMPLID       = ' '
  LET $Personal_NAME         = ' '
  LET $Personal_ADDRESS1     = ' '
  LET $Personal_ADDRESS2     = ' '  !2/2/4
  LET $Personal_SSN          = ' '
  LET $Personal_CITY         = ' '
  LET $Personal_STATE        = ' '
  LET $Personal_ZIP          = ' '
  LET $Personal_SEX          = ' '
  LET $Personal_Orig_Hire_DTU = ' '
 
  !7/10/7 added
  !------------
  let $FirstName            = ' '
  let $LastName             = ' '
 
  #ifdef show_selects
     #debugd show 'Processing PS_PERSONAL_DATA...'
  #endif
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
BEGIN-SELECT    !Loops = 1
A1.EMPLID
#if {SITE_ID} = 'PFZ1'
CHAR_PKG.MAKE_IT_ASCII(A1.NAME)         &A1.NAME
CHAR_PKG.MAKE_IT_ASCII(A1.ADDRESS1)     &A1.ADDRESS1
CHAR_PKG.MAKE_IT_ASCII(A1.ADDRESS2)     &A1.ADDRESS2
#else
A1.NAME
A1.ADDRESS1
A1.ADDRESS2
#endif
{SSN_ID}
#if {SITE_ID} = 'PFZ1'
CHAR_PKG.MAKE_IT_ASCII(A1.CITY)         &A1.CITY
CHAR_PKG.MAKE_IT_ASCII(A1.STATE)        &A1.STATE
#else
A1.CITY
A1.STATE
#endif
A1.{POSTAL}
A1.SEX
#if {SITE_ID} = 'TBN1'
A2.ORIG_HIRE_DT
#else
A1.ORIG_HIRE_DT
#endif
#if {PeopleSoft_Version} >= '7.5'
A1.COUNTRY
#endif
#if {PeopleSoft_Version} >= '8'
#if {SITE_ID} = 'PFZ1'
CHAR_PKG.MAKE_IT_ASCII(A1.LAST_NAME)   &A1.LAST_NAME
CHAR_PKG.MAKE_IT_ASCII(A1.FIRST_NAME)  &A1.FIRST_NAME
CHAR_PKG.MAKE_IT_ASCII(A1.MIDDLE_NAME) &A1.MIDDLE_NAME
#else
A1.LAST_NAME
A1.FIRST_NAME
A1.MIDDLE_NAME
#endif
#endif
 
  LET $Personal_NAME        = rtrim(&A1.NAME,' ')
 
  #if {PeopleSoft_Version} >= '8'
   let $FirstName            = rtrim(&A1.FIRST_NAME,' ')
   let $LastName             = rtrim(&A1.LAST_NAME,' ')
   let $MiddleName           = rtrim(&A1.MIDDLE_NAME,' ')
  #endif
 
  LET $Personal_EMPLID      = rtrim(&A1.EMPLID,' ')
  LET $Personal_NAME        = rtrim(&A1.NAME,' ')
  LET $Personal_ADDRESS1    = rtrim(&A1.ADDRESS1,' ')
  LET $Personal_ADDRESS2    = rtrim(&A1.ADDRESS2,' ')
  LET $Personal_SSN         = rtrim(&{SSN_ID},' ')
 
  !8/26/03 if blank address1, but NOT blank address2..... use address2
  !-------------------------------------------------------------------
  if rtrim($Personal_ADDRESS1,' ') = ''
    if rtrim($Personal_ADDRESS2,' ') <> ''
       move $Personal_ADDRESS2 to $Personal_ADDRESS1
       move ' ' to $Personal_ADDRESS2
    end-if
  end-if
 
  IF $Personal_SSN = ''
    LET $Personal_SSN          = '999999999'
    #debugd show 'Warning: Blank SSN for Emplid: ' $Personal_EMPLID ' --> Setting SSN to 999999999'
  END-IF
 
  IF LENGTH($Personal_SSN) <> 9
    #debugd show 'Warning: Invalid SSN for Emplid ' $Personal_EMPLID ', SSN: ' $Personal_SSN
  END-IF
 
  !7/5/05
  if substr(&A1.COUNTRY,1,2) = 'US'
    move &A1.CITY     to $Personal_CITY
    move &A1.STATE    to $Personal_STATE
    move &A1.{POSTAL} to $Personal_ZIP
  else
    let $Personal_City = rtrim(&A1.CITY,' ') || ' ' || rtrim(&A1.{POSTAL},' ') || ' ' || rtrim(&A1.COUNTRY,' ')
  end-if
 
  move &A1.SEX      to $Personal_SEX
 
  move '' to $Personal_Orig_Hire_DTU
 
  #if {SITE_ID} = 'TBN1'
   if rtrim(&A2.ORIG_HIRE_DT,' ') <> ''
      Do Convert-to-DTU-Date(&A2.ORIG_HIRE_DT, $Personal_Orig_Hire_DTU)
   end-if
  #else
   if rtrim(&A1.ORIG_HIRE_DT,' ') <> ''
      Do Convert-to-DTU-Date(&A1.ORIG_HIRE_DT, $Personal_Orig_Hire_DTU)
   end-if
  #endif
 
  #if {PeopleSoft_Version} >= '7.5'
 
     FROM PS_PERSONAL_DATA A1 {NOLOCK_SQL},
          PS_PERS_NID H {NOLOCK_SQL}
       #if {SITE_ID} = 'TBN1'
        , PS_PER_ORG_INST A2 {NOLOCK_SQL}
       #endif
 
 
     WHERE    A1.EMPLID = $Current_Emplid
        AND   H.EMPLID  = $Current_Emplid
        #if {SITE_ID} = 'TBN1'
        AND   A1.EMPLID  = A2.EMPLID
        #endif
        #if {SITE_ID} = 'MLN1'
            AND   H.NATIONAL_ID_TYPE = 'PR'
        #else
            #ifdef IGNORE_NID_VARS
            AND   H.COUNTRY = 'USA'
            AND   H.NATIONAL_ID_TYPE = 'PR'
            #else
            AND   H.COUNTRY = {NID_COUNTRY}
            AND   H.NATIONAL_ID_TYPE = $PAYROLL_NID_TYPE
            #endif
        #endif
 
  #endif
 
  #if {PeopleSoft_Version} < '7.5'
 
     FROM PS_PERSONAL_DATA A1
     WHERE    A1.EMPLID = $Current_Emplid
 
  #endif
 
  #ifdef SELECT_WITH_UR
   {SELECT_WITH_UR} with ur
  #endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Extract-Personal-Data' to $debug-proc1
     move 'PS_PERSONAL_DATA < 8.8'    to $debug-table1
     do log-delta-time
  #endif
 
#ifndef STRIPPED_PBZQTR_REPORT
    if (rtrim($Personal_emplid,' ') = '')
       if (#Missing_Qtr_Data_count < {MISSING_QTR_DATA_LIMIT})
          Put $Current_Company                              -
              $Current_Emplid                               -
              'Missing Personal Data'                       -
           Into Missing_Qtr_Data(#Missing_Qtr_Data_count) -
              Company                                     -
              Emplid
              Message
          add 1 to #Missing_Qtr_Data_count
        end-if
    end-if
#endif
   move $Personal_EMPLID to $Previous_EMPLID
 
end-procedure
 
#else      ! *********************** P/S 8.8, major mods ****************
 
!**********************************************************************     !
!----------------------------------------------------------------------     !
! Procedure: Extract-Personal-Data                                          !
! Descr:     Extract the Personal (Employee) data from Personal Data        !
!            table.                                                         !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Extract-Personal-Data
 
  LET $Personal_NAME         = ' '
  LET $Personal_ADDRESS1     = ' '
  LET $Personal_ADDRESS2     = ' '
  LET $Personal_SSN          = ' '
  LET $Personal_CITY         = ' '
  LET $Personal_STATE        = ' '
  LET $Personal_ZIP          = ' '
  LET $Personal_SEX          = ' '
 
  !7/10/7 added
  !------------
  let $FirstName            = ' '
  let $LastName             = ' '
  let $MiddleName           = ' '
  let $NameSuffix           = ' '
 
  LET $Personal_EMPLID      = $Current_Emplid
 
  #if {PeopleSoft_Version} <= '8.8'
   LET $Personal_Orig_Hire_DTU = ' '  !so we don't clear the hire date retrieved from JOB for 8.9+
  #endif
 
  move $Personal_AsOfDate to $Save_Personal_AsOfDate
  do get-name
  do check-name
  move $Save_Personal_AsOfDate to $Personal_AsOfDate
  do get-ssn
  #if {PeopleSoft_Version} = '8.8'
    do get-Hire-Date
  #endif
  do get-gender
 
  move $Personal_AsOfDate to $Save_Personal_AsOfDate
  Do Get-Empl-Address-PBZ
  do check-address
  move $Save_Personal_AsOfDate to $Personal_AsOfDate
 
end-procedure
 
begin-procedure get-name
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT    !Loops = 1
#if {SITE_ID} = 'PFZ1'    !PANNES01 - BEGIN - 15Apr2009
A1.NAME_SUFFIX
CHAR_PKG.MAKE_IT_ASCII(A1.NAME)  &A1.NAME
CHAR_PKG.MAKE_IT_ASCII(A1.LAST_NAME) &A1.LAST_NAME
CHAR_PKG.MAKE_IT_ASCII(A1.FIRST_NAME) &A1.FIRST_NAME
CHAR_PKG.MAKE_IT_ASCII(A1.MIDDLE_NAME) &A1.MIDDLE_NAME
#else
#ifdef cast_ps_names
cast(A1.NAME_SUFFIX as char (15)) &A1.NAME_SUFFIX
cast(A1.NAME as char (50)) &A1.NAME
cast(A1.LAST_NAME as char (30)) &A1.LAST_NAME
cast(A1.FIRST_NAME as char (30)) &A1.FIRST_NAME
cast(A1.MIDDLE_NAME as char (30)) &A1.MIDDLE_NAME
#else
A1.NAME_SUFFIX
A1.NAME
A1.LAST_NAME
A1.FIRST_NAME
A1.MIDDLE_NAME
#endif   !cast_ps_names
#endif   !PANNES01 - END - 15Apr2009
 
   LET $Personal_NAME        = rtrim(&A1.NAME,' ')
 
#ifdef STRIP_PERIODS_FROM_NAME
   let $FirstName = rtrim(translate(&A1.FIRST_NAME,'.',' '),' ')
   let $LastName = rtrim(translate(&A1.LAST_NAME,'.',' '),' ')
   let $MiddleName = rtrim(translate(&A1.MIDDLE_NAME,'.',' '),' ')
   let $NameSuffix = rtrim(translate(&A1.NAME_SUFFIX,'.',' '),' ')
#else
  let $FirstName            = rtrim(&A1.FIRST_NAME,' ')
  let $LastName             = rtrim(&A1.LAST_NAME,' ')
  let $MiddleName           = rtrim(&A1.MIDDLE_NAME,' ')
  let $NameSuffix           = rtrim(&A1.NAME_SUFFIX,' ')
#endif
 
  if $SelectEmplid <> ''
    show 'get-name: associate NAME retrieved: '  $Personal_NAME
  end-if
 
  FROM PS_NAMES A1 {NOLOCK_SQL}
     WHERE    A1.EMPLID = $Current_Emplid
        AND   A1.NAME_TYPE = 'PRI'
        AND   A1.EFFDT = (SELECT MAX(EFFDT)
           FROM PS_NAMES {NOLOCK_SQL}
             WHERE EMPLID    = A1.EMPLID
              AND  NAME_TYPE = A1.NAME_TYPE
              AND  EFFDT <= $Personal_AsOfDate)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'get-name' to $debug-proc1
     move 'PS_NAMES'    to $debug-table1
     do log-delta-time
  #endif
 
end-procedure
 
begin-procedure check-name
 
  if rtrim($Personal_NAME,' ') = ''
    #debugd show 'Warning: in check-name routine: Blank NAME for Emplid: ' $Current_Emplid
    #ifdef GET_MOST_RECENT_PERSONAL_DATA
      move $AsOfToday to $Personal_AsOfDate
      do get-name
    #endif
  end-if
 
end-procedure
 
begin-procedure check-address
 
  if rtrim($Personal_ADDRESS1,' ') = ''
    if $SelectEmplid <> ' '
      #debugd show 'Warning: Missing Personal Address Data for Emplid ' $Current_Emplid  ', Company ' $Current_Company
    end-if
    #ifdef GET_MOST_RECENT_PERSONAL_DATA
      move $AsOfToday to $Personal_AsOfDate
      do Get-Empl-Address-PBZ
    #endif
  end-if
 
end-procedure
 
begin-procedure get-ssn
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT    !Loops = 1
{SSN_ID}
 
  LET $Personal_SSN = rtrim(&{SSN_ID},' ')
 
  if $SelectEmplid <> ''
    let $partial_ssn = 'xxxxx' || substr($Personal_SSN,6,4)
    #debugd show 'get-ssn: retrieved: '  $partial_ssn ' (first 5 chars of ssn have been masked for privacy)'
  end-if
 
  FROM PS_PERS_NID H {NOLOCK_SQL}
     WHERE    H.EMPLID  = $Current_Emplid
        #ifdef IGNORE_NID_VARS
        AND   H.COUNTRY = 'USA'
        AND   H.NATIONAL_ID_TYPE = 'PR'
        #else
        AND   H.COUNTRY = {NID_COUNTRY}
        AND   H.NATIONAL_ID_TYPE = $PAYROLL_NID_TYPE
        #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  IF LENGTH($Personal_SSN) <> 9
 
    #if {SITE_ID} <> 'YRC1'
      if $SelectEmplid <> ''
       #debugd show 'Warning: Invalid SSN for Emplid ' $Current_EMPLID ', Invalid SSN: ' $Personal_SSN ', setting SSN to 999999999'
      end-if
      let $Personal_SSN = '999999999'
    #else
      let $Personal_SSN = substr($Personal_SSN,1,9)  !4/2/09
    #endif
 
  END-IF
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'get-ssn' to $debug-proc1
    move 'PS_PERS_NID'    to $debug-table1
    do log-delta-time
 #endif
 
end-procedure
 
#if {PeopleSoft_Version} = '8.8'
 
begin-procedure Get-Hire-Date
 
  LET $Personal_Orig_Hire_DTU = ' '
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT    !Loops = 1
HIREDT.ORIG_HIRE_DT
HIREDT.BIRTHDATE
 
  if rtrim(&HIREDT.ORIG_HIRE_DT,' ') <> ''
      Do Convert-to-DTU-Date(&HIREDT.ORIG_HIRE_DT, $Personal_Orig_Hire_DTU)
  end-if
 
  let $Birthdate = &HIREDT.BIRTHDATE
 
  FROM PS_PERSON HIREDT {NOLOCK_SQL}
  WHERE HIREDT.EMPLID  = $Current_Emplid
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Get-Hire-Date' to $debug-proc1
    move 'PS_PERSON'    to $debug-table1
    do log-delta-time
 #endif
 
end-procedure
 
#endif
 
begin-procedure Get-Gender
 
  LET $Personal_Sex = ' '
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT    !Loops = 1
PERSDT.SEX
 
  let $Personal_Sex = &PERSDT.SEX
 
  FROM PS_PERS_DATA_EFFDT PERSDT {NOLOCK_SQL}
    WHERE PERSDT.EMPLID  = $Current_Emplid
      AND PERSDT.EFFDT = (SELECT MAX(EFFDT)
                   FROM PS_PERS_DATA_EFFDT {NOLOCK_SQL}
                   WHERE  EMPLID  = PERSDT.EMPLID
                     AND  EFFDT <= $Personal_AsOfDate)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Get-Gender' to $debug-proc1
    move 'PS_PERS_DATA_EFFDT'    to $debug-table1
    do log-delta-time
 #endif
 
end-procedure
 
!-----------------------------------------------------------------------
! Section: Get-Empl-Address-pbz
! Descr:   Retrieves the Employee's Current Address
!-----------------------------------------------------------------------
Begin-Procedure Get-Empl-Address-Pbz
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
Begin-Select
#ifdef cast_ps_addresses
cast(PERSON_ADDRESS.ADDRESS1 as char(55)) &PERSON_ADDRESS.ADDRESS1
cast(PERSON_ADDRESS.ADDRESS2 as char(55)) &PERSON_ADDRESS.ADDRESS2
cast(PERSON_ADDRESS.CITY as char(30)) &PERSON_ADDRESS.CITY
cast(PERSON_ADDRESS.STATE as char(6)) &PERSON_ADDRESS.STATE
cast(PERSON_ADDRESS.POSTAL as char(12)) &PERSON_ADDRESS.POSTAL
cast(PERSON_ADDRESS.ADDRESS_TYPE as char(4)) &PERSON_ADDRESS.ADDRESS_TYPE
#else
PERSON_ADDRESS.ADDRESS1
PERSON_ADDRESS.ADDRESS2
PERSON_ADDRESS.CITY
PERSON_ADDRESS.STATE
PERSON_ADDRESS.POSTAL
PERSON_ADDRESS.ADDRESS_TYPE
#endif !cast_ps_addresses
  LET $Personal_ADDRESS1    =  &PERSON_ADDRESS.ADDRESS1
  LET $Personal_ADDRESS2    =  &PERSON_ADDRESS.ADDRESS2
  LET $Personal_CITY        =  &PERSON_ADDRESS.CITY
  LET $Personal_STATE       =  &PERSON_ADDRESS.STATE
  LET $Personal_ZIP         =  &PERSON_ADDRESS.POSTAL
  LET $ADDRESS_TYPE         =  &PERSON_ADDRESS.ADDRESS_TYPE
 
  !8/26/03 if blank address1, but NOT blank address2..... use address2
  !-------------------------------------------------------------------
  #ifndef SWITCH_ADDRESS_LINES_HR
   if rtrim($Personal_ADDRESS1,' ') = ''
    if rtrim($Personal_ADDRESS2,' ') <> ''
       move $Personal_ADDRESS2 to $Personal_ADDRESS1
       move ' ' to $Personal_ADDRESS2
    end-if
   end-if
  #endif
  
  if $SelectEmplid <> ''
    show 'PS_ADDRESSES: ' $ADDRESS_TYPE ' --> ' $Personal_ADDRESS1 '/' $Personal_ADDRESS2 ' '  $Personal_CITY ' ' $Personal_STATE ' ' $Personal_ZIP
  end-if
 
  from PS_ADDRESSES PERSON_ADDRESS {NOLOCK_SQL}
   where PERSON_ADDRESS.EMPLID      = $Current_Emplid
 
    #ifdef USE_MAIL_ADDRESS
      AND ( PERSON_ADDRESS.ADDRESS_TYPE = 'MAIL' OR PERSON_ADDRESS.ADDRESS_TYPE = 'HOME')
    #else
      #if {SITE_ID} = 'WUV1'
        AND (PERSON_ADDRESS.ADDRESS_TYPE = 'WESS'
        OR NOT EXISTS (SELECT 'x' FROM effvw.PS_ADDRESSES addr_type
                    WHERE person_address.emplid = addr_type.emplid
                    AND addr_type.eff_status = 'A'
                    AND addr_type.address_type = 'WESS')
                    AND PERSON_ADDRESS.ADDRESS_TYPE = 'HOME')
 
      #else
         #ifdef USE_HOME_ADDRESS
            AND ( PERSON_ADDRESS.ADDRESS_TYPE = 'MAIL' OR PERSON_ADDRESS.ADDRESS_TYPE = 'HOME' )
         #else
            AND PERSON_ADDRESS.ADDRESS_TYPE = 'HOME'
         #endif
      #endif
    #endif
    AND PERSON_ADDRESS.EFF_STATUS   = 'A'                !11/15/07 added
    AND PERSON_ADDRESS.EFFDT = (SELECT MAX(EFFDT)
    FROM PS_ADDRESSES {NOLOCK_SQL}
    WHERE  EMPLID       = PERSON_ADDRESS.EMPLID
      AND  ADDRESS_TYPE = PERSON_ADDRESS.ADDRESS_TYPE
      AND  EFFDT <= $Personal_AsOfDate)
 
    #ifdef USE_MAIL_ADDRESS
      ORDER by PERSON_ADDRESS.ADDRESS_TYPE
    #else
      ORDER by PERSON_ADDRESS.ADDRESS_TYPE DESC
    #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Get-Empl-Address-Pbz' to $debug-proc1
    move 'PS_ADDRESSES'    to $debug-table1
    do log-delta-time
 #endif
 
 
end-procedure
 
#endif         !8.8 personal data
 
!***********************************************************************
!----------------------------------------------------------------------!
! Procedure: Process-Employee-Record                                   !
! Desc:      This procedure creates/writes the ProBusiness E1 record.  !
!                                                                      !
!----------------------------------------------------------------------!
begin-procedure Process-Employee-Record
 
 !#define debug_new_hire
 
 let $Emp_Hire_Mo  = ' '
 let $Emp_Hire_Day = ' '
 let $Emp_Hire_Yr  = ' '
 let $Trm_Hire_Mo  = ' '
 let $Trm_Hire_Day = ' '
 let $Trm_Hire_Yr  = ' '
 let $Name         = ' '
 
 let $Emp_Personal_Address1 = ' '
 let $Emp_Personal_Address2 = ' '  !added 2/2/4
 let $Emp_EmplId       = ' '
 let $Emp_SSN          = ' '
 let $Emp_City         = ' '
 let $Emp_State        = ' '
 let $Private_SDI      = ' '
 let $Emp_Sex          = ' '
 let $Emp_Seasonal_Emp = ' '
 
 if rtrim($Personal_Emplid,' ') <> ''
  let $Emp_Personal_Address1 = $Personal_Address1
  let $Emp_Personal_Address2 = $Personal_Address2
  let $Emp_EmplId      = $Personal_EmplId
  let $Emp_SSN         = substr($Personal_SSN,1,3) ||
                         substr($Personal_SSN,4,2) ||
                         substr($Personal_SSN,6,4)
  let $Emp_City        = $Personal_City
  let $Emp_State       = $Personal_State
 
  !--------------------------------------------!
  ! Process the Zip Code - Omit the '-' within !
  ! the PeopleSoft Zip Code field (if any)     !
  !--------------------------------------------!
  !11/23/98 old way - no 0's at end if blank
  !-----------------------------------------
  if substr($Personal_Zip,6,1) = '-' or
    substr($Personal_Zip,6,1) = ' '
    let $Emp_Zip     = substr($Personal_Zip,1,5) ||
                       substr($Personal_Zip,7,4)
  else
     let $Emp_Zip     = substr($Personal_Zip,1,9)
  end-if
 
  if $adp_format = 't'
    let $Emp_Hire_Mo           = substr($Personal_Orig_Hire_DTU,6,2)
    let $Emp_Hire_Day          = substr($Personal_Orig_Hire_DTU,9,2)
    let $Emp_Hire_Yr           = substr($Personal_Orig_Hire_DTU,1,4)
  else
   if ($Personal_Orig_Hire_DTU >= $Qtr_Start_DTU) AND ($Personal_Orig_Hire_DTU <= $Qtr_End_DTU)
    let $Emp_Hire_Mo           = substr($Personal_Orig_Hire_DTU,6,2)
    let $Emp_Hire_Day          = substr($Personal_Orig_Hire_DTU,9,2)
    let $Emp_Hire_Yr           = substr($Personal_Orig_Hire_DTU,1,4)
   else
    let $Emp_Hire_Mo           = '  '
    let $Emp_Hire_Day          = '  '
    let $Emp_Hire_Yr           = '    '
   end-if
  end-if
 
  if $SelectEmplid <> ''
   show 'Process-Employee-Record adp_format ' $adp_format ', Personal_Orig_Hire_DTU ' $Personal_Orig_Hire_DTU ', hire YYYYMMDD ' $Emp_Hire_Yr $Emp_Hire_Mo $Emp_Hire_Day
  end-if
 
  let $Emp_Sex               = $Personal_Sex
  let $Emp_Seasonal_Emp      = 'N'
 
 end-if
 
end-procedure
 
#ifdef CA_WAGE_PLAN_CD_IN_CAH_CHECK_SUI
begin-procedure Find-Wage-Plan-Cd-Check
 
 !leave it alone if SUI data exists... otherwise set it to P, withholding only
 !----------------------------------------------------------------------------
 let $found_sui = 'f'
 let $found_sdi = 'f'
 
  let #ca_cnt = 0
 
  while #ca_cnt < #Last_TaxBalance_Cnt
 
    Add 1 to #ca_cnt
 
    get   $TBalance_State_chk      -
          $TBalance_Tax_Class_chk  -
          #TBalance_Nlgrs_Qtd_chk  -
          #TBalance_Txgrs_Qtd_chk  -
          #TBalance_Tax_Qtd_chk    -
      from TaxBalance(#Ca_Cnt)   -
           TaxBalance_State      -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd
 
     !if positive SUI taxes or wages... leave the wage plan along.. otherwise set it to 'exempt from SUI'
     !----------------------------------------------------------------------------------------------------
     if ( rtrim($TBalance_State_chk,' ') = 'CA' AND rtrim($TBalance_Tax_Class_chk,' ') = 'U' ) AND
      ( #TBalance_Nlgrs_Qtd_chk > 0 OR #TBalance_Txgrs_Qtd_chk > 0 OR #TBalance_Tax_Qtd_chk > 0 )
          let $found_sui = 't'
     end-if
 
     if ( rtrim($TBalance_State_chk,' ') = 'CA' AND rtrim($TBalance_Tax_Class_chk,' ') = 'D' ) AND
      ( #TBalance_Nlgrs_Qtd_chk > 0 OR #TBalance_Txgrs_Qtd_chk > 0 OR #TBalance_Tax_Qtd_chk > 0 )
          let $found_sdi = 't'
     end-if
 
 
 end-while
 
 !we have both SUI and SDI indicators here letting us know whether there is CA SUI and/or SDI in the quarter
 !-----------------------------------------------------------------------------------------------------------
 if rtrim($Statetax_Wage_Plan_CD,' ') = ''   !default to 'S' if blank...
   let $Statetax_Wage_Plan_CD     = 'S'
 end-if
 
 if rtrim($found_sui,' ') = 'f' AND rtrim($found_sdi,' ') = 'f'
   let $Statetax_Wage_Plan_CD     = 'P'         !   P= Exempt from SDI and SUI,
 end-if
end-procedure
 
#endif
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Find-Wage-Plan-Cd                                         !
! Desc:      This procedure extracts an employee's record from the     !
!            State-Tax-Data table                                      !
!----------------------------------------------------------------------!
begin-procedure Find-Wage-Plan-Cd
 
#if {SITE_ID} = 'AGN1'
    do Find-Wage-Plan-Cd-AGN1 !probiz.sqc
#else
 
  let $Statetax_Wage_Plan_CD     = ' '
 
  #ifdef show_selects
     #debugd show 'Processing PS_STATE_TAX_DATA...'
  #endif
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT
CC.WAGE_PLAN_CD
 
  !from Peoplesoft: (same as output, no mods required)
  ! S=State Plan for both SUI and SDI,
  ! U=Voluntary Plan for Disability and State plan for SUI,
  ! J=State plan for SDI and exempt from SUI,
  ! L=Voluntary plan for SDI and exempt from SUI,
  ! R=State plan for SUI and Religious Exemption from SDI,
  ! P= Exempt from SDI and SUI,
  ! A=Covered under State SUI plan
  ! default=S
 
  let $Statetax_Wage_Plan_CD = rtrim(&CC.WAGE_PLAN_CD,' ')
 
FROM PS_STATE_TAX_DATA CC {NOLOCK_SQL}
  WHERE     CC.EMPLID  = $Current_Emplid  AND
            CC.COMPANY = $Current_Company AND
            CC.STATE   = $State_trimmed AND
            CC.EFFDT=(SELECT MAX(CC1.EFFDT)
                   FROM PS_STATE_TAX_DATA CC1 {NOLOCK_SQL}
                   WHERE  CC.EMPLID      = CC1.EMPLID AND
                          CC.COMPANY     = CC1.COMPANY AND
                          CC.STATE       = CC1.STATE AND
                          CC1.EFFDT       <= $Qtr_End_Native)  !9/13/07 fix
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Find-Wage-Plan-Cd' to $debug-proc1
    move 'PS_STATE_TAX_DATA'    to $debug-table1
    do log-delta-time
 #endif
 
#endif
 
end-procedure
 
#ifdef KJDA  !This is for the custom KJDA clients (PJ's and Yum) who do NOT
             !track Credits in the TAX_BALANCE Table directly
 
Begin-Procedure Include-KJDA
 
  !11/28/05 to fix the FICA fields getting wiped out...
  !-------------------------------------------------
  let $Save_Cur_State      = $Cur_State
  let $Save_Cur_Tax_Class  = $Cur_Tax_Class
  let $Save_Cur_Locality   = $Cur_Locality
  let $Save_Cur_Resident   = $Cur_Resident
 
  let #TaxBalance_Txgrs_Qtd   = 0
  let #TaxBalance_Nlgrs_Qtd   = 0
  let #TaxBalance_Tax_Qtd     = 0
  let #TaxBalance_Txgrs_Ytd   = 0
  let #TaxBalance_Nlgrs_Ytd   = 0
  let #TaxBalance_Tax_Ytd     = 0
 
  move ' ' to $KJDA_Output_TaxCode
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  #ifdef debug_kjda-details
   #debugd show 'Begin Include-KJDA procedure...'
  #endif
 
BEGIN-SELECT
KJDA.BALANCE_QTR
KJDA.{Client_Field_Prefix}TAXCODE
KJDA.TAX_CUR
KJDA.TXGRS_CUR
 
    Let $Current_KJDA_TaxCode = substr(&KJDA.{Client_Field_Prefix}TAXCODE,1,15)
 
    if $Current_KJDA_TaxCode <> $KJDA_Output_TaxCode
      if rtrim($KJDA_Output_TaxCode,' ') <> ''
        do Output-KJDA
      end-if
 
      let #TaxBalance_Txgrs_Qtd   = 0
      let #TaxBalance_Nlgrs_Qtd   = 0
      let #TaxBalance_Tax_Qtd     = 0
      let #TaxBalance_Txgrs_Ytd   = 0
      let #TaxBalance_Nlgrs_Ytd   = 0
      let #TaxBalance_Tax_Ytd     = 0
 
      move $Current_KJDA_TaxCode to $KJDA_Output_TaxCode
 
    end-if
 
    !YTD's
    !-----
    add  &KJDA.TXGRS_CUR to #KJDA_Txgrs_Ytd
    add  &KJDA.TAX_CUR   to #KJDA_Tax_Ytd
    add  &KJDA.TXGRS_CUR to #TaxBalance_Nlgrs_Ytd
    add  &KJDA.TXGRS_CUR to #TaxBalance_Txgrs_Ytd
    add  &KJDA.TAX_CUR   to #TaxBalance_Tax_Ytd
 
    let #len = length(rtrim('{KJDA_KY}',' '))
    if substr($Current_KJDA_TaxCode,4,#len) = '{KJDA_KY}'
      add  &KJDA.TXGRS_CUR to #KJDA_KY_Txgrs_Ytd
      add  &KJDA.TAX_CUR   to #KJDA_KY_Tax_Ytd
    end-if
 
    let #len = length(rtrim('{KJDA_JC}',' '))
    if substr($Current_KJDA_TaxCode,4,#len) = '{KJDA_JC}'
      add  &KJDA.TXGRS_CUR to #KJDA_JC_Txgrs_Ytd
      add  &KJDA.TAX_CUR   to #KJDA_JC_Tax_Ytd
    end-if
 
    let #len = length(rtrim('{KJDA_KY}',' '))
    if substr($Current_KJDA_TaxCode,4,#len) = '{KJDA_KY}'
      add  &KJDA.TXGRS_CUR to #KJDA_JT_Txgrs_Ytd
      add  &KJDA.TAX_CUR   to #KJDA_JT_Tax_Ytd
    end-if
 
    !QTD's
    !-----
    if &KJDA.BALANCE_QTR  = #RptQtr
 
      add  &KJDA.TXGRS_CUR to #KJDA_Txgrs_Qtd
      add  &KJDA.TAX_CUR   to #KJDA_Tax_Qtd
      add  &KJDA.TXGRS_CUR to #TaxBalance_Nlgrs_Qtd
      add  &KJDA.TXGRS_CUR to #TaxBalance_Txgrs_Qtd
      add  &KJDA.TAX_CUR   to #TaxBalance_Tax_Qtd
 
      let #len = length(rtrim('{KJDA_KY}',' '))
      if substr($Current_KJDA_TaxCode,4,#len) = '{KJDA_KY}'
        add  &KJDA.TXGRS_CUR to #KJDA_KY_Txgrs_Qtd
        add  &KJDA.TAX_CUR   to #KJDA_KY_Tax_Qtd
      end-if
 
      let #len = length(rtrim('{KJDA_JC}',' '))
      if substr($Current_KJDA_TaxCode,4,#len) = '{KJDA_JC}'
        add  &KJDA.TXGRS_CUR to #KJDA_JC_Txgrs_Qtd
        add  &KJDA.TAX_CUR   to #KJDA_JC_Tax_Qtd
      end-if
 
      let #len = length(rtrim('{KJDA_JT}',' '))
      if substr($Current_KJDA_TaxCode,4,#len) = '{KJDA_JT}'
        add  &KJDA.TXGRS_CUR to #KJDA_JT_Txgrs_Qtd
        add  &KJDA.TAX_CUR   to #KJDA_JT_Tax_Qtd
      end-if
 
   end-if
 
   FROM PS_{Client_Table_Prefix}KJDA_BALS KJDA
   WHERE  KJDA.EMPLID       = $Current_Emplid
      AND KJDA.COMPANY      = $Current_Company

      #ifdef USE_INT_CRITERIA
        AND KJDA.BALANCE_YEAR  = int(\$RptYearZ\) 
        AND KJDA.BALANCE_QTR   <= int(\$RptQtrZ\) 
      #else
        AND KJDA.BALANCE_YEAR = #RptYear
        AND KJDA.BALANCE_QTR  <= #RptQtr
      #endif
 
   ORDER BY KJDA.{Client_Field_Prefix}TAXCODE
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 if rtrim($KJDA_Output_TaxCode,' ') <> ''
   do Output-KJDA
 end-if
 
    !11/28/05 to fix the FICA fields getting wiped out...
    !-------------------------------------------------
    let $Cur_State      = $Save_Cur_State
    let $Cur_Tax_Class  = $Save_Cur_Tax_Class
    let $Cur_Locality   = $Save_Cur_Locality
    let $Cur_Resident   = $Save_Cur_Resident
 
  let #TaxBalance_Txgrs_Qtd   = 0
  let #TaxBalance_Nlgrs_Qtd   = 0
  let #TaxBalance_Tax_Qtd     = 0
  let #TaxBalance_Txgrs_Ytd   = 0
  let #TaxBalance_Nlgrs_Ytd   = 0
  let #TaxBalance_Tax_Ytd     = 0
 
  #ifdef debug_kjda_details
       let $restored_taxcode = $Cur_State || $Cur_Tax_Class || $Cur_Locality || $Cur_Resident
       #debugd show 'Include-KJDA complete. Restored taxcode ' $restored_taxcode
  #endif
 
End-procedure
 
begin-procedure Output-KJDA
 
    let #TAX_QTD_T   = #TaxBalance_Tax_Qtd
    let #TXGRS_QTD_T = #TaxBalance_Txgrs_Qtd
    let #NLGRS_QTD_T = #TaxBalance_Nlgrs_Qtd
    let #TAX_YTD_T   = #TaxBalance_Tax_Ytd
    let #TXGRS_YTD_T = #TaxBalance_Txgrs_Ytd
    let #NLGRS_YTD_T = #TaxBalance_Nlgrs_Ytd
 
    let #Tip_Wages_QTD = 0
    let #Tip_Tax_QTD   = 0
    let #Tip_Wages_YTD = 0
    let #Tip_Tax_YTD   = 0
 
    let $Cur_State     = substr($KJDA_Output_TaxCode,1,2)
    let $Cur_Tax_Class = substr($KJDA_Output_TaxCode,3,1)
 
    let $Cur_Locality = substr($KJDA_Output_TaxCode,4,10)
    let $Cur_Locality = rtrim($Cur_Locality,' ')
    let $Cur_Resident = substr($KJDA_Output_TaxCode,15,1)
 
    !---------------------------------------------------------------
    !default to using the old EXCESS Calc (fast), for Q4, use the
    !query to get the exempt wage totals  --  6/28/01
    !---------------------------------------------------------------
 
    if ( (round(#TaxBalance_Nlgrs_Qtd,2) <> 0) OR
         (round(#TaxBalance_Txgrs_Qtd,2) <> 0) OR
         (round(#TaxBalance_Tax_Qtd,2)   <> 0) OR
         (round(#TaxBalance_Nlgrs_Ytd,2) <> 0) OR
         (round(#TaxBalance_Txgrs_Ytd,2) <> 0) OR
         (round(#TaxBalance_Tax_Ytd,2)   <> 0) )
     do update-tax-balances
 
   end-if
 
end-procedure
 
Begin-Procedure Summarize-KJDA-Hash
 
  print 'KJDA Grand Total Credit Summary'  (+2,10)
  print '-------------------------------'  (+1,10)
 
  print '  KY QTD Credit    '  (+2,10)
  print #KJDA_KY_Tax_Qtd_Hash       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_KY_Txgrs_Qtd_Hash     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  print '  JC QTD Credit    '  (+1,10)
  print #KJDA_JC_Tax_Qtd_Hash       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JC_Txgrs_Qtd_Hash     (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  #if {SITE_ID} = 'PJN1'
  print '  JT QTD Credit    '  (+1,10)
  print #KJDA_JT_Tax_Qtd_Hash       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JT_Txgrs_Qtd_Hash     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  #endif
 
  print '  KJDA QTD Credits '  (+1,10)
  print #KJDA_Tax_Qtd_Hash          ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_Txgrs_Qtd_Hash        (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  print '  KY YTD Credit    '  (+2,10)
  print #KJDA_KY_Tax_Ytd_Hash       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_KY_Txgrs_Ytd_Hash     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  print '  JC YTD Credit    '  (+1,10)
  print #KJDA_JC_Tax_Ytd_Hash       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JC_Txgrs_Ytd_Hash     (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  #if {SITE_ID} = 'PJN1'
  print '  JT YTD Credit    '  (+1,10)
  print #KJDA_JT_Tax_Ytd_Hash       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JT_Txgrs_Ytd_Hash     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  #endif
 
  print '  KJDA YTD Credits '  (+1,10)
  print #KJDA_Tax_Ytd_Hash          ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_Txgrs_Ytd_Hash        (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  let #net = #Hash_Total_Tax_Qtd + #KJDA_Tax_Qtd_Hash
  print '  Net Qtd Taxes    '  (+2,10)
  print #net                   () edit $$$,$$$,$$$,$$9.99mi
  print '(Net is the Total QTD Taxes less the KJDA Credits)'  (0,50)
 
  New-Page
 
End-procedure
 
Begin-Procedure Summarize-KJDA-Company
 
  print 'KJDA Company Credit Summary'  (+2,10)
  print '---------------------------'  (+1,10)
 
  print '  KY QTD Credit    '  (+2,10)
  print #KJDA_KY_Tax_Qtd       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_KY_Txgrs_Qtd     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  print '  JC QTD Credit    '  (+1,10)
  print #KJDA_JC_Tax_Qtd       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JC_Txgrs_Qtd     (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  #if {SITE_ID} = 'PJN1'
  print '  JT QTD Credit    '  (+1,10)
  print #KJDA_JT_Tax_Qtd       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JT_Txgrs_Qtd     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  #endif
 
  print '  KJDA QTD Credits '  (+1,10)
  print #KJDA_Tax_Qtd          ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_Txgrs_Qtd        (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  print '  KY YTD Credit    '  (+2,10)
  print #KJDA_KY_Tax_Ytd       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_KY_Txgrs_Ytd     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  print '  JC YTD Credit    '  (+1,10)
  print #KJDA_JC_Tax_Ytd       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JC_Txgrs_Ytd     (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  #if {SITE_ID} = 'PJN1'
  print '  JT YTD Credit    '  (+1,10)
  print #KJDA_JT_Tax_Ytd       ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_JT_Txgrs_Ytd     (0,60)      edit $$$,$$$,$$$,$$9.99mi
  #endif
 
  print '  KJDA YTD Credits '  (+1,10)
  print #KJDA_Tax_Ytd          ()          edit $$$,$$$,$$$,$$9.99mi
  print 'Wages '               (0,50)
  print #KJDA_Txgrs_Ytd        (0,60)      edit $$$,$$$,$$$,$$9.99mi
 
  let #net = #Company_Total_Tax_Qtd + #KJDA_Tax_Qtd
  print '  Net Qtd Taxes    '  (+2,10)
  print #net                   () edit $$$,$$$,$$$,$$9.99mi
  print '(Net is the Total QTD Taxes less the KJDA Credits)'  (0,50)
 
  add #KJDA_KY_Tax_Qtd to #KJDA_KY_Tax_Qtd_Hash
  move 0 to #KJDA_KY_Tax_Qtd
  add #KJDA_KY_Txgrs_Qtd to #KJDA_KY_Txgrs_Qtd_Hash
  move 0 to #KJDA_KY_Txgrs_Qtd
  add #KJDA_JC_Tax_Qtd to #KJDA_JC_Tax_Qtd_Hash
  move 0 to #KJDA_JC_Tax_Qtd
  add #KJDA_JC_Txgrs_Qtd to #KJDA_JC_Txgrs_Qtd_Hash
  move 0 to #KJDA_JC_Txgrs_Qtd
  add #KJDA_JT_Tax_Qtd to #KJDA_JT_Tax_Qtd_Hash
  move 0 to #KJDA_JT_Tax_Qtd
  add #KJDA_JT_Txgrs_Qtd to #KJDA_JT_Txgrs_Qtd_Hash
  move 0 to #KJDA_JT_Txgrs_Qtd
  add #KJDA_Tax_Qtd to #KJDA_Tax_Qtd_Hash
  move 0 to #KJDA_Tax_Qtd
  add #KJDA_Txgrs_Qtd to #KJDA_Txgrs_Qtd_Hash
  move 0 to #KJDA_Txgrs_Qtd
 
  add #KJDA_KY_Tax_YTD to #KJDA_KY_Tax_YTD_Hash
  move 0 to #KJDA_KY_Tax_YTD
  add #KJDA_KY_Txgrs_YTD to #KJDA_KY_Txgrs_YTD_Hash
  move 0 to #KJDA_KY_Txgrs_YTD
  add #KJDA_JC_Tax_YTD to #KJDA_JC_Tax_YTD_Hash
  move 0 to #KJDA_JC_Tax_YTD
  add #KJDA_JC_Txgrs_YTD to #KJDA_JC_Txgrs_YTD_Hash
  move 0 to #KJDA_JC_Txgrs_YTD
  add #KJDA_JT_Tax_YTD to #KJDA_JT_Tax_YTD_Hash
  move 0 to #KJDA_JT_Tax_YTD
  add #KJDA_JT_Txgrs_YTD to #KJDA_JT_Txgrs_YTD_Hash
  move 0 to #KJDA_JT_Txgrs_YTD
  add #KJDA_Tax_YTD to #KJDA_Tax_YTD_Hash
  move 0 to #KJDA_Tax_YTD
  add #KJDA_Txgrs_YTD to #KJDA_Txgrs_YTD_Hash
  move 0 to #KJDA_Txgrs_YTD
 
  New-Page
 
End-procedure
 
#endif
 
!sort to get the FIT taxes LAST ALWAYS to help in RR processing..
!-----------------------------------------------------------------
begin-procedure sort-tax-balances
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  do clear-sui-data
 
  let #cur_cnt = 0
  let #sav_cnt = 0
 
  let #new_cnt = #Last_TaxBalance_Cnt
 
  while #cur_cnt < #Last_TaxBalance_Cnt
 
    Add 1 to #cur_cnt
 
    get $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          #TaxBalance_Tip_Wages_Qtd  -
          #TaxBalance_Tip_Wages_Ytd  -
          #TaxBalance_Tip_Tax_Qtd    -
          #TaxBalance_Tip_Tax_Ytd    -
      from TaxBalance(#Cur_Cnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Tip_Wages_Qtd  -
           TaxBalance_Tip_Wages_Ytd  -
           TaxBalance_Tip_Tax_Qtd    -
           TaxBalance_Tip_Tax_Ytd
 
      if $TaxBalance_State <> '$U' and $TaxBalance_Tax_Class = 'U'
         put $TaxBalance_State into sui_job(#sui_jurisdictions) STATE
         add 1 to #sui_jurisdictions
      end-if
 
      !shift from 1 thru Last_TaxBalance_Cnt .... to ..... 2 thru Last_TaxBalance_Cnt + 1
      !------------------------------------------------------------------------------------
      if $TaxBalance_State = '$U' and $TaxBalance_Tax_Class = 'H'  ! (always last)
       let #new_cnt = #Last_TaxBalance_Cnt + 1
       put $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          #TaxBalance_Tip_Wages_Qtd  -
          #TaxBalance_Tip_Wages_Ytd  -
          #TaxBalance_Tip_Tax_Qtd    -
          #TaxBalance_Tip_Tax_Ytd    -
       into TaxBalance(#new_Cnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Tip_Wages_Qtd  -
           TaxBalance_Tip_Wages_Ytd  -
           TaxBalance_Tip_Tax_Qtd    -
           TaxBalance_Tip_Tax_Ytd
 
           put '--' into TaxBalance(#cur_Cnt) TaxBalance_State
 
     end-if
 
  end-while
 
  do populate-sui-data
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'sort-tax-balances' to $debug-proc1
     move ' '    to $debug-table1
     do log-delta-time
 #endif
 
end-procedure
 
#ifdef USE_STATE_IN_WORKSITE_JOB_QUERY_ALWAYS
begin-procedure populate-sui-data
 
    let #s = 0
    while #s < #sui_jurisdictions
        get $st from sui_job(#s) STATE
        if $SelectEmplid <> ''
          show 'populate-sui-data sui_jurisdictions (USE_STATE_IN_WORKSITE_JOB_QUERY_ALWAYS) SUI jurisdictions = ' #s edit 99 ', state = ' $st
        end-if
        do populate-multi-sui
        add 1 to #s
    end-while
 
end-procedure
#else
begin-procedure populate-sui-data
 
  if #sui_jurisdictions = 1
 
    put $Location           -
        $Tax_Location_cd    -
        $input_jobcode      -
        $estabid            -
        $worksite_cd        -
      into sui_job(0)       -
  	   LOCATION         -
  	   TAX_LOCATION_CD  -
       	   JOBCODE          -
       	   ESTABID          -
           WORKSITE
 
   else
      ! this is where we need to go through the 'sui_job' array of states.. populating the other fields in this array
      ! -------------------------------------------------------------------------------------------------------------
      let #s = 0
      while #s < #sui_jurisdictions
        get $st from sui_job(#s) STATE
        do populate-multi-sui
        add 1 to #s
      end-while
 
   end-if
 
end-procedure
#endif
 
begin-procedure populate-multi-sui
 
   !default to current if there is no matching location in the state
    if $SelectEmplid <> ''
      show 'populate-multi-sui: st ' $st ', Emplid ' $Current_Emplid ', Company ' $C_Company
    end-if
 
   !4/10/09 added
   !-------------
   #ifdef USE_LOCATION_CD
      move $location to $wrksite
   #else
     #ifdef USE_ESTABID
        move $Estabid to $wrksite
     #else
        move $Tax_Location_cd to $wrksite
     #endif
   #endif
 
   !-------
 
   put $LOCATION                  -
       $Tax_Location_cd           -
       $Input_JOBCODE             -
       $Estabid                   -
       $wrksite                   -
      into sui_job(#s)            -
  	 LOCATION                 -
  	 TAX_LOCATION_CD          -
         JOBCODE                  -
         ESTABID                  -
         WORKSITE
 
 
begin-select loops=1
JB9.TAX_LOCATION_CD
JB9.LOCATION
JB9.JOBCODE
JB9.EFFDT
JB9.ESTABID
JB9.EFFSEQ
 
   !4/10/09 added
   !-------------
   #ifdef USE_LOCATION_CD
      move &JB9.LOCATION to $wrksite
   #else
     #ifdef USE_ESTABID
       move &JB9.ESTABID to $wrksite
     #else
      move &JB9.TAX_LOCATION_CD to $wrksite
     #endif
   #endif
   !-------
 
    if $SelectEmplid <> ''
      show 'populate-multi-sui:  LOC ' &JB9.LOCATION ' TAX_LOC_CD ' &JB9.TAX_LOCATION_CD ' JOBCODE ' &JB9.JOBCODE ' ESTABID ' &JB9.ESTABID ' worksite --> '   $wrksite ' ' &JB9.EFFDT ' ' &JB9.EFFSEQ edit 99
    end-if
 
    put &JB9.LOCATION               -
        &JB9.TAX_LOCATION_CD        -
        &JB9.JOBCODE                -
        &JB9.ESTABID                -
        $wrksite                    -     !4/10/9 changed this from &JB9.TAX_LOCATION_CD
      into sui_job(#s)              -
  	 LOCATION                   -
  	 TAX_LOCATION_CD            -
         JOBCODE                    -
         ESTABID                    -
         WORKSITE
 
   #ifdef USE_LOCATION_CD
    FROM PS_JOB JB9 {NOLOCK_SQL}, PS_LOCATION_TBL LCHK9 {NOLOCK_SQL}
   #else
    #ifdef USE_ESTABID
      FROM PS_JOB JB9 {NOLOCK_SQL}, PS_ESTAB_TBL LCHK9 {NOLOCK_SQL}
     #else
       #ifdef STANDARD_HOME_INTL_TAX_LOC2_STATE
         FROM PS_JOB JB9 {NOLOCK_SQL}, PS_TAX_LOCATION2 LCHK9 {NOLOCK_SQL}
       #else
         FROM PS_JOB JB9 {NOLOCK_SQL}, PS_TAX_LOCATION1 LCHK9 {NOLOCK_SQL}
       #endif
     #endif
   #endif
   
    Where JB9.EMPLID     = $Current_Emplid
 
    #if {SITE_ID} <> 'AXA1'
     #if {SITE_ID} <> 'HWL1'   ! 'ALLSIG'
      #if {SITE_ID} <> 'LAN1'
       AND JB9.COMPANY  = $C_Company
      #endif
     #endif
    #endif
 
   #if {SITE_ID} = 'AXA1'
     AND JB9.COMPANY || '' = $C_Company
   #endif
 
   #if {SITE_ID} = 'LAN1'
     AND JB9.COMPANY||NULL  = $C_Company
     AND JB9.{emp_rec} = 0
   #endif
 
  #ifdef PULL_JOB_THROUGH_QE_ONLY
    AND JB9.EFFDT = (SELECT MAX(JB91.EFFDT)
        FROM   PS_JOB JB91 {NOLOCK_SQL}
   	    WHERE JB91.EMPLID    = JB9.EMPLID
   	      AND JB91.COMPANY   = JB9.COMPANY
   	      AND JB91.EFFDT    <= $Qtr_End_Native)
    	      AND JB9.EFFSEQ =  (SELECT MAX(JB92.EFFSEQ)
   	FROM  PS_JOB JB92 {NOLOCK_SQL}
   	    WHERE JB92.EMPLID    = JB9.EMPLID
   	      AND JB92.COMPANY   = JB9.COMPANY
   	      AND JB92.EFFDT     = JB9.EFFDT)
   #endif
 
   #ifdef USE_LOCATION_CD
    AND JB9.LOCATION = LCHK9.LOCATION
   #else
     #ifdef USE_ESTABID
       AND JB9.ESTABID = LCHK9.ESTABID
     #else
      AND JB9.TAX_LOCATION_CD = LCHK9.TAX_LOCATION_CD
     #endif
   #endif
 
   AND LCHK9.STATE         = $st
 
   ORDER By JB9.EFFDT DESC, JB9.EFFSEQ DESC
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
begin-procedure clear-sui-data
 
  clear-array name=sui_job
  let #sui_jurisdictions = 0
 
end-procedure
 
begin-procedure retrieve-sui-data
 
 
   let #s = 0
   while #s < #sui_jurisdictions
    get $state_chk           -
        $Location_chk        -
        $Tax_Location_cd_chk -
        $input_jobcode_chk   -
        $input_estabid       -
        $worksite_cd_chk     -
      from sui_job(#s)       -
           STATE             -
  	   LOCATION          -
  	   TAX_LOCATION_CD   -
     	   JOBCODE           -
           ESTABID           -
           WORKSITE
 
     if $state_chk = $State_trimmed
       move $Location_chk        to $Location
       move $Tax_Location_cd_chk to $Tax_Location_cd
       move $Location_chk        to $Location
       move $Input_estabid       to $Estabid
       move $worksite_cd_chk     to $worksite_cd
       move $input_jobcode_chk   to $input_jobcode  !added 12/30/2010
       break
     end-if
 
     add 1 to #s
   end-while
 
 
 end-procedure
 
!------------------------------------------------------------------------------------------
!2/5/05 - Adjust tax balances YTD Taxable, Taxes by applying W-2 and W-2C data to original
!         called before first Wage record is written
!------------------------------------------------------------------------------------------
begin-procedure adjust-tax-balances   !hook from pbzqtr, for W-2 time, to adjust tax balances
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 if $SelectEmplid <> ''
   show ''
   show 'In Adjust-tax-balance'
 end-if
 
 !8/13/07 added, to clear out all tax balances for voided W-2
 !-----------------------------------------------------------
 
 let #cur_cnt = 0
 
  while #cur_cnt < #Last_TaxBalance_Cnt
 
    Add 1 to #cur_cnt
 
    get $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          #TaxBalance_Tip_Wages_Qtd  -
          #TaxBalance_Tip_Wages_Ytd  -
          #TaxBalance_Tip_Tax_Qtd    -
          #TaxBalance_Tip_Tax_Ytd    -
          $TaxBalance_WORK_PSD_CD    -
          $TaxBalance_RES_PSD_CD    -
          $TaxBalance_Resident      -
      from TaxBalance(#Cur_Cnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Tip_Wages_Qtd  -
           TaxBalance_Tip_Wages_Ytd  -
           TaxBalance_Tip_Tax_Qtd    -
           TaxBalance_Tip_Tax_Ytd    -
           TaxBalance_WORK_PSD_CD    -
           TaxBalance_RES_PSD_CD     -
           TaxBalance_Resident
 
     let $state_trimmed	 = rtrim($TaxBalance_State,' ')
     let $Local_trimmed  = rtrim($TaxBalance_Locality,' ')
     let $class_trimmed	 = rtrim($TaxBalance_Tax_Class,' ')
     let $WPC_trimmed	 = rtrim($TaxBalance_WORK_PSD_CD,' ')
     let $RPC_trimmed	 = rtrim($TaxBalance_RES_PSD_CD,' ')
 
     if $check-for-void-w2 = 't'

       #ifdef CUSTOM_EMPLOYMENT_TYPE
          do Get-Custom-Employment-set-pension-flag   !this could set the $pension_remap so we don't clear out the YTDs
       #endif
   
       if $pension_remap <> 't'

           let $message = 'Orig YTD Balances'
           let $output_taxcode = $state_trimmed || $class_trimmed || $Local_trimmed
 
           #ifndef SKIP_TAX_AND_WAGE_AUDITS
            do log-void
           #endif
 
           !and zero out the YTD totals
           !---------------------------
           add #TaxBalance_Tax_Ytd   to #TaxBalance_Tax_Ytd_adjusted_hash
           add #TaxBalance_Txgrs_Ytd to #TaxBalance_Txgrs_Ytd_adjusted_hash
           add #TaxBalance_Nlgrs_Ytd to #TaxBalance_Nlgrs_Ytd_adjusted_hash
 
           put 0   into TaxBalance(#cur_cnt) TaxBalance_Tax_Ytd
           put 0   into TaxBalance(#cur_cnt) TaxBalance_Txgrs_Ytd
           put 0   into TaxBalance(#cur_cnt) TaxBalance_Nlgrs_Ytd
 
           let #TaxBalance_Tax_Ytd   = 0
           let #TaxBalance_Txgrs_Ytd = 0
           let #TaxBalance_Nlgrs_Ytd = 0
           let $message = 'New YTD Balances'
 
           #ifndef SKIP_TAX_AND_WAGE_AUDITS
            do log-void
           #endif
 
        end-if
 
     else
 
      if $SelectEmplid <> ''
        show 'In Adjust-tax-balance, TaxBalance: ' $state_trimmed $class_trimmed $Local_trimmed ' ' $TaxBalance_Resident ' ' $WPC_trimmed '/' $RPC_trimmed
        show '        YTD txgrs = '  #TaxBalance_Txgrs_Ytd edit 999,999,999.99 ', YTD tax = '  #TaxBalance_Tax_Ytd edit 999,999,999.99
      end-if
 
 ! ----------------------------------------------------------------------------------------------
 !From tax910ld, valid tax classes : ('H','D','E','F','G','J','Q','T','Z','C','K','V','L','M','N','W')
 !-----------------------------------------------------------------------------------------------------
      evaluate $state_trimmed
       when = '$U'
       when = '$E'
         let $TaxBal_ID  = 'W'
         evaluate $class_trimmed
           when = 'H'
              let $TaxBal_Box = '01'
              let $TaxBal_typ = 'TXGRS'
              do New-Use-Box-Data
              let $TaxBal_Box = '02'
              let $TaxBal_typ = 'TAX'
              do New-Use-Box-Data
           ! ----------------------------------------------------------------------
           !12/1/5 Fica & Med amounts are NOT loaded via YE_Amounts, but are loaded
           !       via the W-2C amounts.  So at year end we'll get these amounts always
           !       via the Tax balances, but during the year we'll pull W-2C data if
           !       it exists
           ! ----------------------------------------------------------------------
            when = 'D'
              let $TaxBal_Box = '03'
              let $TaxBal_typ = 'TXGRS'
              do New-Use-Box-Data
              let $TaxBal_Box = '04'
              let $TaxBal_typ = 'TAX'
              do New-Use-Box-Data
            when = 'F'
              let $TaxBal_Box = '05'
              let $TaxBal_typ = 'TXGRS'
              do New-Use-Box-Data
              let $TaxBal_Box = '06'
              let $TaxBal_typ = 'TAX'
              do New-Use-Box-Data
            when = 'G'
              let $TaxBal_Box = '07'
              let $TaxBal_typ = 'TXGRS'
              do New-Use-Box-Data
            when = 'C'
              let $TaxBal_Box = '09'
              let $TaxBal_typ = 'TAX'
              do New-Use-Box-Data
            when-other
            break
         end-evaluate
         break
 
       when-other   !State, locals...
 
 !     #ifndef LOCAL_RECIPROCITY
           if $Local_trimmed <> '' and ($class_trimmed = 'H' or $class_trimmed = 'P')  !P added 4/23/08
              let $TaxBal_Box = '18'
              let $TaxBal_typ = 'TXGRS'
              do New-Use-Box-Data
              let $TaxBal_Box = '19'
              let $TaxBal_typ = 'TAX'
              do New-Use-Box-Data
              break
           end-if
 !     #endif
 
       !SIT and PRH
       if $Local_trimmed = '' and $class_trimmed = 'H'
              if $State_Trimmed = 'PR'
                let $TaxBal_ID  = 'P'
                let $TaxBal_Box = '08'     !Commissions is 8, wages is 7
                let $TaxBal_typ = 'TXGRS'
                do New-Use-Box-Data
                let $TaxBal_Box = '14'     !Coda is 14, taxes are 13  (these should be 7 and 13, not 8 and 14)
                let $TaxBal_typ = 'TAX'
              else
                let $TaxBal_ID  = 'W'
                let $TaxBal_Box = '16'
                let $TaxBal_typ = 'TXGRS'
                do New-Use-Box-Data
                let $TaxBal_Box = '17'
                let $TaxBal_typ = 'TAX'
                do New-Use-Box-Data
              end-if
              break
          end-if
 
          let $state_class = $state_trimmed || $class_trimmed
          let $state_class = rtrim($state_class,' ')
          do get-box-from-taxcode
          if $TaxBal_Box <> ''
               let $TaxBal_typ = 'TAX'
               evaluate $state_class
                !SUI box 14 mappings
                when = 'AKV'
                !when = 'NJL'
                !when = 'NJM'
                !when = 'NJN'
                !when = 'NJV'
                when = 'PAV'
                  do New-Use-Box-Data
                  break
 
                !SDI box 14 mappings
                when = 'CAD'
                when = 'NJD'
                when = 'NJW'
                when = 'RID'
                when = 'PRD'
                when = '$UPRD'
                  do New-Use-Box-Data
                  break
 
              when-other
                  break
 
              end-evaluate
          end-if
 
    end-evaluate
  end-if
 
 end-while
 
 !we could check here....  (no other source would need to change) for two issues (WellsFargo, and Tribune issues) 4/24/06
 !-----------------------------------------------------------------------------------------------------------------------
 !  1. See if there were Box records for State 16,17, and Local 18,19 that were NOT referenced in TaxBalances
 !     ADDING new Tax balance records for these.. this would be for the case where no tax balances were in
 !     an emplid's data but a W-2C was added for an entirely new state (the new state data is not being picked up)
 !     We'd need to 'flag' the 'used' Box_w2 16-19 box values as having already been processed, and if other 16-19
 !     boxes were 'unused'... these would result in new tax balance entries being added to tax balance array
 
 #ifdef adjust-tax-balances-for-new-state-locals
  if $RptQtr = '4' and $adp_w2_records = 't'
     if $process_W2C_data = 't'
        do adjust-tax-balances-for-new-state-locals
     end-if
  end-if
 #endif
 
 !  2. adjust FICA ER and MED ER to match FICA EE and MED EE.. to automatically sync up the YTD's to match the W-2C
 !     data entered for FICA EE and MED EE, does not address SUI or FUTA
 
 #ifdef adjust-tax-balances-to-match-ee
   if $RptQtr = '4' and $adp_w2_records = 't'
     if $process_W2C_data = 't'
       do adjust-tax-balances-to-match-ee          !coded up on 4/24/06 and ready to test
     end-if
   end-if
 #endif
 
 !-----------------------------------------------------------------------------------------------------------------------
 
  !added 6/14/06
  #ifdef PR_REDUCE_WAGES_BY_COMMISSION
     if $RptQtr = '4' and $adp_w2_records = 't'
        do adjust-tax-balances-for-PR-Commissions
     end-if
  #endif
 
  !#ifdef ADJUST_ZERO_LOCALS  !12/8/6, this should be called for all quarters
  !  do adjust-zero-locals
  !#endif
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'adjust-tax-balances' to $debug-proc1
    move ' '    to $debug-table1
    do log-delta-time
 #endif
 
 
end-procedure
 
#ifdef ADJUST_ZERO_LOCALS
begin-procedure adjust-zero-locals
 
  let #cur_cnt = 0
  while #cur_cnt < #Last_TaxBalance_Cnt
 
    Add 1 to #cur_cnt
 
    get   $TaxBalance_State          -
          $TaxBalance_Tax_Class      -
          $TaxBalance_Locality       -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
      from TaxBalance(#Cur_Cnt)  -
           TaxBalance_State      -
           TaxBalance_Tax_Class  -
           TaxBalance_Locality   -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd
 
           let $state_trimmed	 = rtrim($TaxBalance_State,' ')
           let $Local_trimmed    = rtrim($TaxBalance_Locality,' ')
           let $class_trimmed	 = rtrim($TaxBalance_Tax_Class,' ')
           let $res_trimmed	 = rtrim($TaxBalance_resident,' ')
 
       #ifdef ZERO_WAGES_for_ZERO_RATE_LOCALS
           if $Local_trimmed <> '' and (#TaxBalance_Tax_Ytd <= 0)
            do get-local-rate
            if #wc_rate <= 0 and #nonres_wc_rate <= 0
              add #TaxBalance_Txgrs_Qtd to #TaxBalance_Txgrs_Qtd_locals_cleared
              add #TaxBalance_Txgrs_Ytd to #TaxBalance_Txgrs_Ytd_locals_cleared
              do clear-local-wages
              #ifdef ZERO_WAGES_for_ZERO_RATE_LOCALS_debug
                #debugd show 'ZERO_WAGES_for_ZERO_RATE_LOCALS: ' $Current_Emplid ' ' $state_trimmed $class_trimmed $local_trimmed
              #endif
            end-if
           end-if
       #else
         #ifndef ADJUST_ZERO_LOCALS_OPT
 
!Clear all locals w/zero YTD Withheld
!------------------------------------
           if $Local_trimmed <> '' and (#TaxBalance_Tax_Ytd <= 0)
            add #TaxBalance_Txgrs_Qtd to #TaxBalance_Txgrs_Qtd_locals_cleared
            add #TaxBalance_Txgrs_Ytd to #TaxBalance_Txgrs_Ytd_locals_cleared
            do clear-local-wages
           end-if
 
         #else
 
!Clear all PA-OPT locals w/zero QTD withheld and YTD withheld
!-------------------------------------------------------------
 
           if $state_trimmed = 'PA' and $class_trimmed = 'P' and $Local_trimmed <> '' and
              (#TaxBalance_Tax_Qtd <= 0 and #TaxBalance_Tax_Ytd <= 0)
 
              add #TaxBalance_Txgrs_Qtd to #TaxBalance_Txgrs_Qtd_locals_cleared
              add #TaxBalance_Txgrs_Ytd to #TaxBalance_Txgrs_Ytd_locals_cleared
              do clear-local-wages
 
           end-if
         #endif
       #endif
    end-while
 
end-procedure
 
begin-procedure clear-local-wages
 
        put 0   into TaxBalance(#cur_cnt) TaxBalance_Nlgrs_Qtd
        put 0   into TaxBalance(#cur_cnt) TaxBalance_Txgrs_Qtd
        put 0   into TaxBalance(#cur_cnt) TaxBalance_Nlgrs_Ytd
        put 0   into TaxBalance(#cur_cnt) TaxBalance_Txgrs_Ytd
        put 0   into TaxBalance(#cur_cnt) TaxBalance_Tax_Qtd
        put 0   into TaxBalance(#cur_cnt) TaxBalance_Tax_Ytd
 
end-procedure
 
#endif
 
#ifdef PR_REDUCE_WAGES_BY_COMMISSION
begin-procedure adjust-tax-balances-for-PR-Commissions
 
  let #i = 0
  let $adjusted_pr = 'f'
  while (#i < #box_w2_count) and rtrim($adjusted_pr,' ') = 'f'
 
     Get #Amount                   -
         $box                      -
         $tax_id                   -
         From Box_W2(#i)           -
             AMOUNT                -
             BOX                   -
             TAXFORM_ID
 
     if rtrim($tax_id,' ') = 'P' and #amount <> 0 and rtrim($box,' ') = $YE_Commissions
 
      let #cur_cnt = 0
      while #cur_cnt < #Last_TaxBalance_Cnt
 
       Add 1 to #cur_cnt
 
       get $TaxBalance_State         -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
       from TaxBalance(#Cur_Cnt)     -
           TaxBalance_State          -
           TaxBalance_Locality       -
           TaxBalance_Tax_Class      -
           TaxBalance_Nlgrs_Ytd      -
           TaxBalance_Txgrs_Ytd
 
        let $state_trimmed	 = rtrim($TaxBalance_State,' ')
        let $class_trimmed	 = rtrim($TaxBalance_Tax_Class,' ')
        let $local_trimmed	 = rtrim($TaxBalance_Locality,' ')
 
        if $state_trimmed = 'PR' and $class_trimmed = 'H' and $local_trimmed = ''
          let #PRH_TaxBalance_Nlgrs_Ytd     = #TaxBalance_Nlgrs_Ytd - #Amount
          let #PRH_TaxBalance_Txgrs_Ytd     = #TaxBalance_Txgrs_Ytd - #Amount
          put #PRH_TaxBalance_Nlgrs_Ytd into TaxBalance(#Cur_Cnt) TaxBalance_Nlgrs_Ytd
          put #PRH_TaxBalance_Txgrs_Ytd into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Ytd
 
          add #amount to #Hash_PR_Taxable_YTD_Adjusted
          let $adjusted_pr = 't'
          break
        end-if
      end-while
 
   end-if
   add 1 to #i
 
  end-while
end-procedure
#endif
 
#ifdef adjust-tax-balances-for-new-state-locals
begin-procedure adjust-tax-balances-for-new-state-locals
 
  let #New_State_W2Cs = 0
  clear-array name=New_State_W2Cs
 
  let #i = 0
  while (#i < #box_w2_count)
 
     Get #Amount                   -
         $box                      -
         $tax_id                   -
         $St                       -
         $Lc                       -
         $WPC                      -
         $RPC                      -
         $R
         $ld_type                  -
         From Box_W2(#i)           -
             AMOUNT                -
             BOX                   -
             TAXFORM_ID            -
             STATE                 -
             LOCALITY              -
             WORK_PSD_CD           -
             RES_PSD_CD            -
             RESIDENT              -
             LOAD_AMT_TYPE
 
   if $SelectEmplid <> ''
     show 'adjust-tax-balances-for-new-state-locals, Box_W2: ' #i edit 999 ' ' $box ' ' $st ' ' $lc ' ' $Ld_type ' ' #Amount edit 999,999.99 ' ' $WPC '/' $RPC ', Res ' $R ', ld_type ' $ld_type
   end-if
 
   if rtrim($tax_id,' ') = 'W'
 
    !see if there are 'unused State or locals.. so we can create a taxbalance for them
    !----------------------------------------------------------------------------------------------------------
     #ifdef INCLUDE_NEW_FED_W2C_DATA   !get federal new W-2C's too.. check this out w/Dow then make generic?
      if  (     rtrim($box,' ') = '01' or rtrim($box,' ') = '02' or rtrim($box,' ') = '03'
            or  rtrim($box,' ') = '04' or rtrim($box,' ') = '05' or rtrim($box,' ') = '06'
            or  rtrim($box,' ') = '16' or rtrim($box,' ') = '17' or rtrim($box,' ') = '18'
            or  rtrim($box,' ') = '19')  and rtrim($ld_type,' ') <> 'X'
 
        evaluate $box
         when = '01'
         when = '02'
          let $tc = 'H'
          break
         when = '03'
         when = '04'
          let $tc = 'D'
          break
         when = '05'
         when = '06'
          let $tc = 'F'
          break
         when-other
          let $tc = 'H'
          break
         end-evaluate
 
 
     #else
        if ( rtrim($box,' ') = '16' or rtrim($box,' ') = '17' or rtrim($box,' ') = '18' or rtrim($box,' ') = '19' ) and (rtrim($ld_type,' ') <> 'X')
            let $tc = 'H'
     #endif
 
        put ' ' into Box_W2(#i) LOAD_AMT_TYPE
        do save_new_state_w2C
 
        !this will duplicate the EE creating ER FICA and ER MED....9/30/8
        !----------------------------------------------------------------
        #ifdef adjust-tax-balances-to-match-ee
 
         let $dup_er = 'f'
 
!        if #RptYear < 2011 and #RptYear > 2012  !20130129: Tax holiday
          if $Box = '03' or $Box = '04'
           let $tc = 'E'
           let $dup_er = 't'
          end-if
          if $Box = '05' or $Box = '06'
           let $tc = 'Q'
           let $dup_er = 't'
          end-if
 
          if $dup_er = 't'
           do save_new_state_w2C
          end-if
!        end-if                                  !20130129: Tax holiday
        #endif
        !----------------------------------------------------------------
     end-if
   end-if
   add 1 to #i
  end-while
 
  !08292013 - see if $UD and/or $UF exists with no $UE and/or no $UQ...
  #ifdef CHECK_FOR_FED_ER_FICA_MED
      do check-for-ER-Fica-Med
  #endif
  do output_new_State_w2C_to_TaxBalances
 
end-procedure
 
#ifdef CHECK_FOR_FED_ER_FICA_MED
begin-procedure check-for-ER-Fica-Med   !08292013 - see if $UD and/or $UF exists with no $UE and/or no $UQ...
 
  let $Fica_EE = ''
  let $Fica_ER = ''
  let $Med_EE  = ''
  let $Med_ER  = ''
  let #cc = 0
  while #cc < #Last_TaxBalance_Cnt
    Add 1 to #cc
    get $st $tc #YTD_Tax #YTD_Taxable from TaxBalance(#cc) TaxBalance_State TaxBalance_Tax_Class  TaxBalance_Tax_Ytd TaxBalance_Txgrs_Ytd
    if rtrim($st,' ') = '$U' and rtrim($tc,' ') = 'D'
      let #UD_TaxBalance_Txgrs_Ytd = #YTD_Taxable
      let #UD_TaxBalance_Tax_Ytd   = #YTD_Tax
      let $Fica_EE = 't'
    end-if
    if rtrim($st,' ') = '$U' and rtrim($tc,' ') = 'E'
      let $Fica_ER  = 't'
    end-if
    if rtrim($st,' ') = '$U' and rtrim($tc,' ') = 'F'
      let #UF_TaxBalance_Txgrs_Ytd = #YTD_Taxable
      let #UF_TaxBalance_Tax_Ytd   = #YTD_Tax
      let $Med_EE = 't'
    end-if
    if rtrim($st,' ') = '$U' and rtrim($tc,' ') = 'Q'
      let $Med_ER  = 't'
    end-if
  end-while
 
  let $lc = ''
  let $WPC = ''
  let $RPC = ''
  let $R = ''
 
  if $Fica_ER = '' and $Fica_EE = 't'
   let $st = '$U'
   let $tc = 'E'
   let $box = '03'
   let #amount = #UD_TaxBalance_Txgrs_Ytd
   do save_new_state_w2C
   let $box = '04'
   let #amount = #UD_TaxBalance_Tax_Ytd
   do save_new_state_w2C
  end-if
 
  if $Med_ER = '' and $Med_EE = 't'
   let $st = '$U'
   let $tc = 'Q'
   let $box = '05'
   let #amount = #UF_TaxBalance_Txgrs_Ytd
   do save_new_state_w2C
   let $box = '06'
   let #amount = #UF_TaxBalance_Tax_Ytd
   do save_new_state_w2C
  end-if
 
  if $SelectEmplid <> ''
    show 'check-for-ER-Fica-Med: Fica EE/ER, Med EE/ER: ' $Fica_EE '/' $Fica_ER ', ' $Med_EE '/' $Med_ER
  end-if
 
end-procedure
#endif
 
 
begin-procedure save_new_state_w2C
 
    let #j = 0
    let $found = 'f'
    while #j < #New_State_W2Cs
     Get $S                       -
         $T                       -
         $L                       -
         $WPCt                    -
         $RPCt                    -
         $L                       -
         $Rt                      -
         From New_State_W2Cs(#j)  -
             STATE                -
             TAX_CLASS            -
             LOCALITY             -
             WORK_PSD_CD          -
             RES_PSD_CD           -
             LOCALITY             -
             RESIDENT
 
       if     rtrim($s,' ') = rtrim($st,' ') AND rtrim($t,' ') = rtrim($tc,' ') AND rtrim($l,' ') = rtrim($lc,' ')
          AND rtrim($WPCt,' ') = rtrim($WPC,' ') AND rtrim($RPCt,' ') = rtrim($RPC,' ') AND rtrim($Rt,' ') = rtrim($R,' ')
          let $found = 't'
          break
       end-if
 
       add 1 to #j
 
    end-while
 
    if $SelectEmplid <> ''
       show 'save_new_state_w2C: '  $s ' ' $t ' ' $l ' ' $WPC '/' $RPC ' ' $R ' found --> ' $found
    end-if
 
    if rtrim($found,' ') = 't'
 
      if rtrim($box,' ') = '16' or rtrim($box,' ') = '18'                 !WAGE buckets
       #ifdef INCLUDE_NEW_FED_W2C_DATA
        or rtrim($box,' ') = '01' or rtrim($box,' ') = '03' or rtrim($box,' ') = '05'
       #endif
       put #amount into New_State_W2Cs(#j) YTD_txgrs
      end-if
 
 
      let #Tamount = #amount
      if rtrim($box,' ') = '17' or rtrim($box,' ') = '19'                 !TAX buckets
       #ifdef INCLUDE_NEW_FED_W2C_DATA
        or rtrim($box,' ') = '02' or rtrim($box,' ') = '04' or rtrim($box,' ') = '06'
 
        if rtrim($box,' ') = '04' and (#RptYear = 2011 or #RptYear = 2012) and $tc = 'E' !20130129: Tax holiday
           let #Tamount = (#amount / 0.042) * 0.062                                      !20130129: Calculate the ER FICA amount (6.2%), not equal the EE FICA Amount (4.2%)
        end-if
 
       #endif
 
       put #Tamount into New_State_W2Cs(#j) YTD_tax
      end-if
 
    else
      put $st $tc $lc $WPC $RPC $R into New_State_W2Cs(#New_State_W2Cs) state tax_class locality WORK_PSD_CD RES_PSD_CD RESIDENT
 
      if rtrim($box,' ') = '16' or rtrim($box,' ') = '18'
       #ifdef INCLUDE_NEW_FED_W2C_DATA
        or rtrim($box,' ') = '01' or rtrim($box,' ') = '03' or rtrim($box,' ') = '05'
       #endif
       put #amount into New_State_W2Cs(#New_State_W2Cs) YTD_txgrs
      end-if
 
 
      let #Tamount = #amount
      if rtrim($box,' ') = '17' or rtrim($box,' ') = '19'
       #ifdef INCLUDE_NEW_FED_W2C_DATA
        or rtrim($box,' ') = '02' or rtrim($box,' ') = '04' or rtrim($box,' ') = '06'
 
        if rtrim($box,' ') = '04' and (#RptYear = 2011 or #RptYear = 2012) and $tc = 'E' !20130129: Tax holiday
           let #Tamount = (#amount / 0.042) * 0.062                                      !20130129: Calculate the ER FICA amount (6.2%), not equal the EE FICA Amount (4.2%)
        end-if
 
       #endif
 
       put #Tamount into New_State_W2Cs(#New_State_W2Cs) YTD_tax
 
      end-if
 
      add 1 to #New_State_W2Cs
 
    end-if
end-procedure
 
begin-procedure output_new_State_w2C_to_TaxBalances
 
    let #j = 0
    while #j < #New_State_W2Cs
     Get $S                       -
         $T                       -
         $L                       -
         $R                       -
         $WPC                     -
         $RPC                     -
         #YTD_txgrs               -
         #YTD_tax                 -
         From New_State_W2Cs(#j)  -
             STATE                -
             TAX_CLASS            -
             LOCALITY             -
             RESIDENT             -
             WORK_PSD_CD          -
             RES_PSD_CD           -
             YTD_txgrs            -
             YTD_tax
 
        if $SelectEmplid <> ''
          show 'output_new_State_w2C_to_TaxBalances: New_State_W2Cs ' #j edit 999 '. ' $S $T $L ' ' $R ' , Txgrs = ' #YTD_txgrs edit 999,999.99 ', Tax = ' #YTD_tax edit 999,999.99
        end-if
 
        add 1 to #Last_TaxBalance_Cnt
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Nlgrs_Qtd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Txgrs_Qtd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tax_Qtd
 
        if $process_W2C_data = 't'
         #ifdef UPDATE_QTD_WITH_W2C
           if #RptQtr = 4
            put #YTD_txgrs  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Txgrs_Qtd
            put #YTD_tax    into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tax_Qtd
           end-if
         #endif
        end-if
 
        put $s  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_State
        put $t  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tax_Class  !8/17/08 changed: put 'H' into ...
        put $l  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Locality
        put $r  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Resident
 
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tip_Wages_Qtd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tip_Tax_Qtd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Nlgrs_Ytd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tip_Wages_Ytd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tip_Tax_Ytd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Txgrs_Ytd
        put 0   into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tax_Ytd
        put #YTD_txgrs  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Txgrs_Ytd
        put #YTD_tax    into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_Tax_Ytd
 
        put $WPC  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_WORK_PSD_CD
        put $RPC  into TaxBalance(#Last_TaxBalance_Cnt) TaxBalance_RES_PSD_CD
 
       add 1 to #j
   end-while
 
end-procedure
 
#endif
 
!------------------------------------------------------------
 
#ifdef adjust-tax-balances-to-match-ee
 
begin-procedure adjust-tax-balances-to-match-ee
 
  let #cur_cnt = 0
 
  let #UD_TaxBalance_Nlgrs_Qtd     = 0
  let #UD_TaxBalance_Txgrs_Qtd     = 0
  let #UD_TaxBalance_Tax_Qtd       = 0
  let #UD_TaxBalance_Tip_Wages_Qtd = 0
  let #UD_TaxBalance_Tip_Tax_Qtd   = 0
  let #UD_TaxBalance_Nlgrs_Ytd     = 0
  let #UD_TaxBalance_Txgrs_Ytd     = 0
  let #UD_TaxBalance_Tax_Ytd       = 0
  let #UD_TaxBalance_Tip_Wages_Ytd = 0
  let #UD_TaxBalance_Tip_Tax_Ytd   = 0
 
  let #UF_TaxBalance_Nlgrs_Qtd     = 0
  let #UF_TaxBalance_Txgrs_Qtd     = 0
  let #UF_TaxBalance_Tax_Qtd       = 0
  let #UF_TaxBalance_Tip_Wages_Qtd = 0
  let #UF_TaxBalance_Tip_Tax_Qtd   = 0
  let #UF_TaxBalance_Nlgrs_Ytd     = 0
  let #UF_TaxBalance_Txgrs_Ytd     = 0
  let #UF_TaxBalance_Tax_Ytd       = 0
  let #UF_TaxBalance_Tip_Wages_Ytd = 0
  let #UF_TaxBalance_Tip_Tax_Ytd   = 0
 
 
  let #U7_TaxBalance_Tax_Qtd       = 0
  let #U7_TaxBalance_Tax_Ytd       = 0
 
 
  while #cur_cnt < #Last_TaxBalance_Cnt
 
    Add 1 to #cur_cnt
 
    get $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          #TaxBalance_Tip_Wages_Qtd  -
          #TaxBalance_Tip_Wages_Ytd  -
          #TaxBalance_Tip_Tax_Qtd    -
          #TaxBalance_Tip_Tax_Ytd    -
      from TaxBalance(#Cur_Cnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Tip_Wages_Qtd  -
           TaxBalance_Tip_Wages_Ytd  -
           TaxBalance_Tip_Tax_Qtd    -
           TaxBalance_Tip_Tax_Ytd
 
           let $state_trimmed	 = rtrim($TaxBalance_State,' ')
           let $class_trimmed	 = rtrim($TaxBalance_Tax_Class,' ')
 
     if $SelectEmplid <> ''
        show 'adjust-tax-balances-to-match-ee ' #cur_cnt edit 999 '. ' $state_trimmed ' ' $class_trimmed ' ' #TaxBalance_Tax_Qtd edit 999,999.99 ' ' #TaxBalance_Tax_Ytd edit 999,999.99
     end-if
 
     if $state_trimmed = '$U' and $class_trimmed = 'D'
        let #UD_TaxBalance_Nlgrs_Qtd     = #TaxBalance_Nlgrs_Qtd
        let #UD_TaxBalance_Txgrs_Qtd     = #TaxBalance_Txgrs_Qtd
        let #UD_TaxBalance_Tax_Qtd       = #TaxBalance_Tax_Qtd
        let #UD_TaxBalance_Tip_Wages_Qtd = #TaxBalance_Tip_Wages_Qtd
        let #UD_TaxBalance_Tip_Tax_Qtd   = #TaxBalance_Tip_Tax_Qtd
        let #UD_TaxBalance_Nlgrs_Ytd     = #TaxBalance_Nlgrs_Ytd
        let #UD_TaxBalance_Txgrs_Ytd     = #TaxBalance_Txgrs_Ytd
        let #UD_TaxBalance_Tax_Ytd       = #TaxBalance_Tax_Ytd
        let #UD_TaxBalance_Tip_Wages_Ytd = #TaxBalance_Tip_Wages_Ytd
        let #UD_TaxBalance_Tip_Tax_Ytd   = #TaxBalance_Tip_Tax_Ytd
     end-if
    if $state_trimmed = '$U' and $class_trimmed = 'E'
	
	 let #UE_TaxBalance_Nlgrs_Qtd     = #UD_TaxBalance_Nlgrs_Qtd
         let #UE_TaxBalance_Txgrs_Qtd     = #UD_TaxBalance_Txgrs_Qtd
         let #UE_TaxBalance_Tax_Qtd       = #TaxBalance_Tax_Qtd
         let #UE_TaxBalance_Tip_Wages_Qtd = #TaxBalance_Tip_Wages_Qtd
         let #UE_TaxBalance_Tip_Tax_Qtd   = #TaxBalance_Tip_Tax_Qtd
         let #UE_TaxBalance_Nlgrs_Ytd     = #UD_TaxBalance_Nlgrs_Ytd
         let #UE_TaxBalance_Txgrs_Ytd     = #UD_TaxBalance_Txgrs_Ytd
         let #UE_TaxBalance_Tax_Ytd       = #TaxBalance_Tax_Ytd
         let #UE_TaxBalance_Tip_Wages_Ytd = #TaxBalance_Tip_Wages_Ytd
         let #UE_TaxBalance_Tip_Tax_Ytd   = #TaxBalance_Tip_Tax_Ytd
 
     end-if
     if $state_trimmed = '$U' and $class_trimmed = 'F'
        let #UF_TaxBalance_Nlgrs_Qtd     = #TaxBalance_Nlgrs_Qtd
        let #UF_TaxBalance_Txgrs_Qtd     = #TaxBalance_Txgrs_Qtd
        let #UF_TaxBalance_Tax_Qtd       = #TaxBalance_Tax_Qtd
        let #UF_TaxBalance_Tip_Wages_Qtd = #TaxBalance_Tip_Wages_Qtd
        let #UF_TaxBalance_Tip_Tax_Qtd   = #TaxBalance_Tip_Tax_Qtd
        let #UF_TaxBalance_Nlgrs_Ytd     = #TaxBalance_Nlgrs_Ytd
        let #UF_TaxBalance_Txgrs_Ytd     = #TaxBalance_Txgrs_Ytd
        let #UF_TaxBalance_Tax_Ytd       = #TaxBalance_Tax_Ytd
        let #UF_TaxBalance_Tip_Wages_Ytd = #TaxBalance_Tip_Wages_Ytd
        let #UF_TaxBalance_Tip_Tax_Ytd   = #TaxBalance_Tip_Tax_Ytd
     end-if
     if $state_trimmed = '$U' and $class_trimmed = '7'
        let #U7_TaxBalance_Tax_Qtd       = #TaxBalance_Tax_Qtd
        let #U7_TaxBalance_Tax_Ytd       = #TaxBalance_Tax_Ytd
     end-if
 
  end-while
 
  let #UD_Delta_TaxBalance = 0
  let #UF_Delta_TaxBalance = 0
  let #iw2 = 0
  while (#iw2 < #box_w2_count)
      Get $box $ld_type #W2C_ADJ_AMOUNT  From Box_W2(#iw2) BOX LOAD_AMT_TYPE  W2C_ADJ_AMOUNT
 
      if $SelectEmplid <> ''
         show 'adjust-tax-balances-to-match-ee: Box_W2 ' #iw2 edit 999 '. $box: ' $box ', $ld_type ' $ld_type ', #W2C_ADJ_AMOUNT ' #W2C_ADJ_AMOUNT edit 99,999,999.99
      end-if
 
      if rtrim($box,' ') = '04'
         let #UD_Delta_TaxBalance = #W2C_ADJ_AMOUNT
         if $SelectEmplid <> ''
           show 'adjust-tax-balances-to-match FicaER: $Current_Emplid : ' $Current_Emplid ', $box: ' $box ', #W2C_ADJ_AMOUNT: ' #W2C_ADJ_AMOUNT edit 99,999,999.99
         end-if
      end-if
      if rtrim($box,' ') = '06'
         let #UF_Delta_TaxBalance = #W2C_ADJ_AMOUNT
         if $SelectEmplid <> ''
           show 'adjust-tax-balances-to-match MEDEE: $Current_Emplid : ' $Current_Emplid ', $box: ' $box ', #W2C_ADJ_AMOUNT: ' #W2C_ADJ_AMOUNT edit 99,999,999.99
         end-if
      end-if
      add 1 to #iw2
  end-while
 
  let #cur_cnt = 0
  while #cur_cnt < #Last_TaxBalance_Cnt
 
    Add 1 to #cur_cnt
 
    get $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          #TaxBalance_Tip_Wages_Qtd  -
          #TaxBalance_Tip_Wages_Ytd  -
          #TaxBalance_Tip_Tax_Qtd    -
          #TaxBalance_Tip_Tax_Ytd    -
      from TaxBalance(#Cur_Cnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Tip_Wages_Qtd  -
           TaxBalance_Tip_Wages_Ytd  -
           TaxBalance_Tip_Tax_Qtd    -
           TaxBalance_Tip_Tax_Ytd
 
           let $state_trimmed	 = rtrim($TaxBalance_State,' ')
           let $class_trimmed	 = rtrim($TaxBalance_Tax_Class,' ')
 
     if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
         show 'adjust-tax-balances-to-match(1) ' #cur_cnt edit 999 '. ' $state_trimmed ' ' $class_trimmed ' ' #TaxBalance_Tax_Qtd edit 99,999,999.99 ' ' #TaxBalance_Tax_Ytd edit 99,999,999.99
     end-if
 
     if $state_trimmed = '$U' and $class_trimmed = 'E'
 
        put #UD_TaxBalance_Nlgrs_Qtd     into TaxBalance(#Cur_Cnt) TaxBalance_Nlgrs_Qtd
        put #UD_TaxBalance_Txgrs_Qtd     into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Qtd
	put #UD_TaxBalance_Tip_Wages_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Wages_Qtd
	put #UD_TaxBalance_Tip_Tax_Qtd   into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Tax_Qtd
	put #UD_TaxBalance_Nlgrs_Ytd     into TaxBalance(#Cur_Cnt) TaxBalance_Nlgrs_Ytd
	put #UD_TaxBalance_Txgrs_Ytd     into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Ytd
	put #UD_TaxBalance_Tip_Wages_Ytd into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Wages_Ytd
        put #UD_TaxBalance_Tip_Tax_Ytd   into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Tax_Ytd
 
        if (#RptYear < 2011 or #RptYear > 2012)
          put #UD_TaxBalance_Tax_Qtd  into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Qtd               !for non holiday years always set ER FICA to the EE FICA
          put #UD_TaxBalance_Tax_Ytd  into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Ytd
          if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show 'adjust-tax-balances-to-match-ee, (2) ER ($UE) QTD Taxes = ' #UD_TaxBalance_Tax_Qtd   edit 99,999,999.99 ', YTD Taxes = ' #UD_TaxBalance_Tax_Ytd  edit 99,999,999.99
          end-if
        end-if
 
        if (#RptYear = 2011 or #RptYear = 2012)
         if (#UD_Delta_TaxBalance <> 0)  !adjust the ER only if the FICA ER needs to be adjusted
 
!          let #TamountQ  = #UD_TaxBalance_Tax_Qtd / 0.042 * 0.062
           let #TamountQ  = #UD_TaxBalance_Txgrs_Qtd * 0.062
           let #TamountQt = trunc(#TamountQ,2)
           let #TamountQr = round(#TamountQ,2)
           put #TamountQr into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Qtd                     	
 
!          let #TamountY  = #UD_TaxBalance_Tax_Ytd / 0.042 * 0.062
           let #TamountY  = #UD_TaxBalance_Txgrs_Ytd * 0.062
           let #TamountYt = trunc(#TamountY,2)
           let #TamountYr = round(#TamountY,2)
           put #TamountYr into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Ytd                     	
 
           if (#TamountQt <> #TamountQr) or (#TamountYt <> #TamountYr) or $SelectEmplid <> ''
             show $Current_Emplid '. round <> trunc  TamountQt = ' #TamountQt edit 999,999.99 ' roundQ = ' #TamountQr edit 999,999.99 ' trunc TamountY = ' #TamountYt edit 999,999.99 ' roundY = ' #TamountYr edit 999,999.99
           end-if
 
           if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show 'adjust-tax-balances-to-match-ee, Holiday ER ($UE) QTD Taxes = ' #TamountQr               edit 99,999,999.99 ', YTD Taxes = ' #TamountYr               edit 99,999,999.99
              show '                                            ($UD) QTD Taxes = ' #UD_TaxBalance_Tax_Qtd   edit 99,999,999.99 ', YTD Taxes = ' #UD_TaxBalance_Tax_Ytd   edit 99,999,999.99
              show '                                basis  (3)  ($UD) QTD Wages = ' #UD_TaxBalance_Txgrs_Qtd edit 99,999,999.99 ', YTD Wages = ' #UD_TaxBalance_Txgrs_Ytd edit 99,999,999.99
              show '                                because of  (Box 04) Delta  = ' #UD_Delta_TaxBalance edit 99,999,999.99
           end-if
         end-if
        end-if
     end-if
 
     if $state_trimmed = '$U' and $class_trimmed = 'F'  !20140701 added to keep Addl Med EE from doubling
        if (#RptYear >= 2013) and (#UF_Delta_TaxBalance <> 0)
          let #UF_ADJ_YTD = #UF_TaxBalance_Tax_Ytd - #U7_TaxBalance_Tax_Ytd
          put #UF_ADJ_YTD  into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Ytd
          move #UF_ADJ_YTD to #UF_TaxBalance_Tax_Ytd  !added 20140807
 
          if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show 'adjust-tax-balances-to-match-ee, (2Y) Adjusting MEDEE YTD by addl MED EE. Adjusted $UF YTD Taxes = ' #UF_ADJ_YTD  edit 99,999,999.99
              show '                                                             UF_TaxBalance_Tax_Ytd                 ' #UF_TaxBalance_Tax_Ytd edit 99,999,999.99
              show '                                                           - U7_TaxBalance_Tax_Ytd                 ' #U7_TaxBalance_Tax_Ytd edit 99,999,999.99
          end-if
          !----------
        end-if
     end-if
 
 
     if $state_trimmed = '$U' and $class_trimmed = 'Q'
 
        put #UF_TaxBalance_Nlgrs_Qtd     into TaxBalance(#Cur_Cnt) TaxBalance_Nlgrs_Qtd
        put #UF_TaxBalance_Txgrs_Qtd     into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Qtd
        put #UF_TaxBalance_Tax_Qtd       into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Qtd
        put #UF_TaxBalance_Tip_Wages_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Wages_Qtd
        put #UF_TaxBalance_Tip_Tax_Qtd   into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Tax_Qtd
        put #UF_TaxBalance_Nlgrs_Ytd     into TaxBalance(#Cur_Cnt) TaxBalance_Nlgrs_Ytd
        put #UF_TaxBalance_Txgrs_Ytd     into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Ytd
        put #UF_TaxBalance_Tax_Ytd       into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Ytd
        put #UF_TaxBalance_Tip_Wages_Ytd into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Wages_Ytd
        put #UF_TaxBalance_Tip_Tax_Ytd   into TaxBalance(#Cur_Cnt) TaxBalance_Tip_Tax_Ytd
     end-if
  end-while
 
end-procedure
 
#endif
 
begin-procedure get-box-from-taxcode
 
  if $local_trimmed = ''
    let $local_trimmed_w_space = ' '
  else
    let $local_trimmed_w_space = $local_trimmed
  end-if
 
  let $TaxBal_Box = ''
 
begin-select
TBOX.BOX
 
 let $TaxBal_Box = rtrim(&TBOX.BOX,' ')
 
 FROM  PS_TAXFORM_TAX TBOX {NOLOCK_SQL}
 
 WHERE TBOX.TAXFORM_ID = $TaxBal_ID
   AND TBOX.EFFDT      = $Max_Effdt
   AND TBOX.STATE      = $state_trimmed
   AND TBOX.TAX_CLASS  = $class_trimmed
   AND TBOX.LOCALITY   = $local_trimmed_w_space
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
begin-procedure New-Use-Box-Data
 
  if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
    show ''
    show 'New-Use-Box-Data: Box   ' $TaxBal_Box ' ' $state_Trimmed $local_trimmed ' ' $WPC_trimmed '/' $RPC_trimmed ' ' $TaxBalance_Resident ', Amt = ' #Amount edit 999,999.99
  end-if
 
  let #i = 0
  while (#i < #box_w2_count)
 
     Get #Amount                   -
         $box                      -
         $tax_id                   -
         $St                       -
         $Lc                       -
         $R
         $WPC                      -
         $RPC                      -
         $ld_type                  -
         #W2C_ADJ_AMOUNT           -
         From Box_W2(#i)           -
             AMOUNT                -
             BOX                   -
             TAXFORM_ID            -
             STATE                 -
             LOCALITY              -
             RESIDENT
             WORK_PSD_CD           -
             RES_PSD_CD            -
             LOAD_AMT_TYPE         -
             W2C_ADJ_AMOUNT
 
    if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
       show '  New-Use-Box-Data: Check ' #i edit 999 ', Box ' $Box ' ' $st $lc ' ' $WPC '/' $RPC ' ' $R ', Amount = ' #Amount edit 999,999.99
    end-if
 
    if     rtrim($box,' ')          = $TaxBal_Box
      and rtrim($tax_id,' ')       = $TaxBal_ID
      and rtrim($St,' ')           = $state_trimmed
      and rtrim($Lc,' ')           = $Local_trimmed
      and rtrim($WPC,' ')          = $WPC_trimmed
      and rtrim($RPC,' ')          = $RPC_trimmed
      !and rtrim($R,' ')            = rtrim($TaxBalance_Resident,' ')                                     !04232013
      and ((rtrim($R,' ') = rtrim($TaxBalance_Resident,' ')) or (rtrim($TaxBalance_Resident,' ') = ''))   !05022013
 
       if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
         show '  New-Use-Box-Data: Match, calling use-updated-year-end-data'
       end-if
       do use-updated-year-end-data
       break
   end-if
 
   !August 22, 2013 added Philly logic - match regardless of RSD code for Philly  08222013
   !----------------------------------------------------------------------------------------
    if     rtrim($box,' ')          = $TaxBal_Box
      and rtrim($tax_id,' ')       = $TaxBal_ID
      and rtrim($St,' ')           = $state_trimmed
      and rtrim($Lc,' ')           = $Local_trimmed
      and rtrim($WPC,' ')          = $WPC_trimmed
      and $st = 'PA'  and ($lc = '510101' or $lc = 'I510012M')
 
       let $ResMatch = 'N'
       if rtrim($R,' ') = ''
        let $R = 'N'
       end-if
       if rtrim($TaxBalance_Resident,' ') = ''
         let $TaxBalance_Resident = 'N'
       end-if
       if  (rtrim($R,' ') = rtrim($TaxBalance_Resident,' '))
         let $ResMatch = 'Y'
       end-if
       if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
         show '  New-Use-Box-Data: Philly W-2 Resident ($R) = ' $R ', $TaxBalance_Resident = ' $TaxBalance_Resident ' W-2 RPC = ' $RPC ' Balances RPC = ' $RPC_trimmed ', ResMatch -->' $ResMatch
       end-if
 
       if $ResMatch = 'Y'
        if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
          show '  New-Use-Box-Data: Philly Match, calling use-updated-year-end-data ' $lc
        end-if
        do use-updated-year-end-data
        break
       end-if
    end-if
 
   add 1 to #i
  end-while
end-procedure
 
begin-procedure use-updated-year-end-data
 
   if  (     rtrim($box,' ') = '01' or rtrim($box,' ') = '02' or rtrim($box,' ') = '03'
         or  rtrim($box,' ') = '04' or rtrim($box,' ') = '05' or rtrim($box,' ') = '06'
         or  rtrim($box,' ') = '16' or rtrim($box,' ') = '17' or rtrim($box,' ') = '18'
         or  rtrim($box,' ') = '19' ) and (rtrim($tax_id,' ') = 'W' or rtrim($tax_id,' ') = 'C')
 
         put 'X' into Box_W2(#i) LOAD_AMT_TYPE   !X indicates we've already used this updated value
 
    end-if
 
    #ifndef ADP_TAX_AMEND
      let $use_ye = 'f'
      #ifndef CHOOSE_TAX_BALANCES_OVER_YE_AMOUNTS
        let $use_ye = 't'
      #else
        #ifdef CHOOSE_NY_YE_AMOUNTS_ALWAYS
          if (rtrim($box,' ') = '16' or rtrim($box,' ') = '17') and rtrim($tax_id,' ') = 'W' and rtrim($St,' ') = 'NY'
           let $use_ye = 't'
          end-if
        #endif
        #ifdef CHOOSE_NY_LOCAL_YE_AMOUNTS_ALWAYS
          if (rtrim($box,' ') = '18' or rtrim($box,' ') = '19') and rtrim($tax_id,' ') = 'W' and rtrim($St,' ') = 'NY' and (rtrim($lc,' ') = 'P0001' or rtrim($lc,' ') = '84000')
           let $use_ye = 't'
          end-if
        #endif
      #endif
    #else
       !  let $use_ye = 't' !20121026 removed - look at the adpamend.sqr logic and NOT report the year-end amounts, only reporting changes that come directly from the W-2C tables.
       if rtrim($ld_type,' ') = 'C' or rtrim($ld_type,' ') = 'WC' !20121026 added
         let $use_ye = 't'                                        !20121026 added
       else                                                       !20121026 added
         let $use_ye = 'f'                                        !20121026 added
       end-if                                                     !20121026 added
    #endif
 
    let $Output_Taxcode = $state_trimmed || $class_trimmed || $local_trimmed
    if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
      show 'use-updated-year-end-data. Output_Taxcode ' $Output_Taxcode
    end-if
 
    if rtrim($TaxBal_typ,' ') = 'TXGRS'
     if rtrim($ld_type,' ') = 'C' or rtrim($ld_type,' ') = 'WC'
      let #TaxBalance_Txgrs_Orig  = #Amount - #W2C_ADJ_AMOUNT
      let #TaxBalance_Txgrs_Ytd   = #Amount
      let #TaxBalance_Txgrs_Delta = #W2C_ADJ_AMOUNT
     else
      let #TaxBalance_Txgrs_Orig  = #TaxBalance_Txgrs_Ytd
      #ifdef CUSTOM_NY_WAGES_YEAR_END
       if (rtrim($box,' ') = '16' and rtrim($tax_id,' ') = 'W' and rtrim($St,' ') = 'NY')
         do custom-set-ny-wages   ! probiz.sqc: set #TaxBalance_Txgrs_Ytd to either #amount (from W-2 table) or leave it alone (from tax balance table)
       else
        let #TaxBalance_Txgrs_Ytd   = #Amount
       end-if
      #else
       let #TaxBalance_Txgrs_Ytd   = #Amount
      #endif
      let #TaxBalance_Txgrs_Delta = #TaxBalance_Txgrs_Ytd - #TaxBalance_Txgrs_Orig
     end-if
 
      if $use_ye = 't' and round(#TaxBalance_Txgrs_Delta,2) = 0
         if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
          show 'use-updated-year-end-data.  Year-end MATCHES Txgrs-Balances'
         end-if
      end-if
 
      if $use_ye = 't' and round(#TaxBalance_Txgrs_Delta,2) <> 0
 
            put #TaxBalance_Txgrs_Ytd into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Ytd
 
            if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show '    Using Year-End TXGRS Amounts...emplid ' $Current_Emplid ' Adjustment = ' #TaxBalance_Txgrs_Delta edit 999,999,999.99
            end-if
 
            if rtrim($ld_type,' ') = 'W'  !4/8/9, don't call this if its a W-2C
             do Log-TaxBalance-Adjustments
            end-if
 
            if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show ' Wage Adjust:   taxcode          ' $state_trimmed ' ' $class_trimmed ' ' $local_trimmed ' ' $WPC_trimmed '/' $RPC_trimmed
              show '     TaxBalance_Txgrs_Ytd        ' #TaxBalance_Txgrs_Ytd
              show '     TaxBalance_Txgrs_Orig       ' #TaxBalance_Txgrs_Orig
              show '     W2C_ADJ_AMOUNT              ' #W2C_ADJ_AMOUNT
              show '     TaxBalance_Txgrs_Delta      ' #TaxBalance_Txgrs_Delta
              show '         process_W2C_data        ' $process_W2C_data
              show '              tax_id             ' $tax_id
              show '             ld_type             ' $ld_type ', W=W-2, C=W-2C, WC=W-2 & W-2C'
            end-if
 
    if $process_W2C_data = 't' and (rtrim($ld_type,' ') = 'C' or rtrim($ld_type,' ') = 'WC')
 
         #ifdef UPDATE_QTD_WITH_W2C
          if #RptQtr = 4
 
            if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show '     Adjusted QTD Taxable: =  ' #TaxBalance_Txgrs_Qtd ' + ' #TaxBalance_Txgrs_Delta
            end-if
 
            let #TaxBalance_Txgrs_Qtd = #TaxBalance_Txgrs_Qtd + #TaxBalance_Txgrs_Delta
            if #TaxBalance_Txgrs_Qtd >= 0
              put #TaxBalance_Txgrs_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Qtd
              add #TaxBalance_Txgrs_Delta to #TaxBalance_Txgrs_Delta_Company
            else
 
             #ifdef UPDATE_QTD_WITH_W2C_NEGATIVE
 
                #if {UPDATE_QTD_WITH_W2C_NEGATIVE} = 'CLEAR'
 
                  #ifndef SKIP_TAX_AND_WAGE_AUDITS
                   let $message  = 'Q4 WageAdj < 0, set to 0'
                   do log-audit
                  #endif
 
                  add #TaxBalance_Txgrs_Qtd to #TaxBalance_Txgrs_Delta_Company  ! we can only adjust it
                  let #TaxBalance_Txgrs_Qtd = 0
                  put #TaxBalance_Txgrs_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Qtd
 
                #else
                     #if {UPDATE_QTD_WITH_W2C_NEGATIVE} = 'NEGATIVE'
 
                        #ifndef SKIP_TAX_AND_WAGE_AUDITS
                         let $message  = 'Q4 WageAdj < 0'
                         do log-audit
                        #endif
 
                        put #TaxBalance_Txgrs_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Txgrs_Qtd
                        add #TaxBalance_Txgrs_Delta to #TaxBalance_Txgrs_Delta_Company
 
                     #else
                        #ifndef SKIP_TAX_AND_WAGE_AUDITS
                         let $message  = 'Q4 WageAdj < 0, No Adj'
   	                 do log-audit
   	                #endif
                     #endif
		 #endif
             #else
                  #ifndef SKIP_TAX_AND_WAGE_AUDITS
                   let $message  = 'Q4 WageAdj < 0, No Adj'
 		   do log-audit
 		  #endif
             #endif
            end-if
          end-if
         #endif
        end-if
      end-if
    else  !taxes
 
      !5/16/05
      if $state_trimmed = '$U' and $class_trimmed = 'C'  !EIC - YE Amounts are NOT negative
         let #amount = 0 - #amount
      end-if
 
      !4/8/9 reworked ... W-2C section to use as a delta the W-2C adjustment amount, not the difference between the W-2c new amount and the tax bal amt
      if rtrim($ld_type,' ') = 'C' or rtrim($ld_type,' ') = 'WC'
       let #TaxBalance_Tax_Orig  = #Amount - #W2C_ADJ_AMOUNT
       let #TaxBalance_Tax_Ytd   = #Amount
       let #TaxBalance_Tax_Delta = #W2C_ADJ_AMOUNT
      else
       let #TaxBalance_Tax_Orig  = #TaxBalance_Tax_Ytd
       let #TaxBalance_Tax_Ytd   = #Amount
       let #TaxBalance_Tax_Delta = #TaxBalance_Tax_Ytd - #TaxBalance_Tax_Orig
      end-if
 
      if $use_ye = 't' and round(#TaxBalance_Tax_Delta,2) = 0
         if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
          show 'use-updated-year-end-data.  Year-end MATCHES Tax-Balances'
         end-if
      end-if
 
      if $use_ye = 't' and round(#TaxBalance_Tax_Delta,2) <> 0
 
            put #TaxBalance_Tax_Ytd into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Ytd
 
            if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
               show '    Using Year-End TAX Amounts...emplid ' $Current_Emplid ' Adjustment = ' #TaxBalance_Tax_Delta edit 999,999,999.99
            end-if
 
            if rtrim($ld_type,' ') = 'W'   !4/8/9, don't call this if its a W-2C
              do Log-TaxBalance-Adjustments
            end-if
 
            if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show ' Tax Adjust.    taxcode          ' $state_trimmed ' ' $class_trimmed ' ' $local_trimmed ' ' $WPC_trimmed '/' $RPC_trimmed
              show '     TaxBalance_Tax_Ytd          ' #TaxBalance_Tax_Ytd
              show '     TaxBalance_Tax_Orig         ' #TaxBalance_Tax_Orig
              show '     W2C_ADJ_AMOUNT              ' #W2C_ADJ_AMOUNT
              show '     TaxBalance_Tax_Delta        ' #TaxBalance_Tax_Delta
              show '    process_W2C_data             ' $process_W2C_data
              show '              tax_id             ' $tax_id
              show '             ld_type             ' $ld_type ', W=W-2, C=W-2C, WC=W-2 & W-2C'
            end-if
 
  if $process_W2C_data = 't' and (rtrim($ld_type,' ') = 'C' or rtrim($ld_type,' ') = 'WC')
 
          #ifdef UPDATE_QTD_WITH_W2C
           if #RptQtr = 4
 
            if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
              show '     Adjusted QTD Taxes: =  ' #TaxBalance_Tax_Qtd ' + ' #TaxBalance_Tax_Delta
            end-if
 
            !20140728
            !----------
            if rtrim($box,' ') = '06' and #RptYear >= 2013
              #ifdef ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST
               do get-tba-medee-surcharge
               let #TaxBalance_Tax_Delta =  #TaxBalance_Tax_Delta - (#UF_Surcharge_Adj)   !UF_Surcharge_Adj from Tax Balance Adjustments
               if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
                 show 'Tax Adjust, (2Q) Adjusting delta QTD Box 06 by #UF_Surcharge_Adj ' #UF_Surcharge_Adj edit 99,999,999.99 ', New Q4 TaxBalance_Tax_Delta = ' #TaxBalance_Tax_Delta edit 99,999,999.99
               end-if
              #endif
            end-if
            !----------
            let #TaxBalance_Tax_Qtd = #TaxBalance_Tax_Qtd + #TaxBalance_Tax_Delta
            if #TaxBalance_Tax_Qtd >= 0
              put #TaxBalance_Tax_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Qtd
              add #TaxBalance_Tax_Delta to #TaxBalance_Tax_Delta_Company
            else
 
              #ifdef UPDATE_QTD_WITH_W2C_NEGATIVE
 
                #if {UPDATE_QTD_WITH_W2C_NEGATIVE} = 'CLEAR'
 
                  #ifndef SKIP_TAX_AND_WAGE_AUDITS
                   let $message  = 'Q4 TaxAdj < 0, set to 0'
                   do log-audit
                  #endif
                  add #TaxBalance_Tax_Qtd to #TaxBalance_Tax_Delta_Company  ! we can only adjust it
                  let #TaxBalance_Tax_Qtd = 0
                  put #TaxBalance_Tax_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Qtd
 
                #else
                     #if {UPDATE_QTD_WITH_W2C_NEGATIVE} = 'NEGATIVE'
                        #ifndef SKIP_TAX_AND_WAGE_AUDITS
                         let $message  = 'Q4 TaxAdj < 0'
                         do log-audit
                        #endif
                        put #TaxBalance_Tax_Qtd into TaxBalance(#Cur_Cnt) TaxBalance_Tax_Qtd
                        add #TaxBalance_Tax_Delta to #TaxBalance_Tax_Delta_Company
 
                     #else
                        #ifndef SKIP_TAX_AND_WAGE_AUDITS
                         let $message  = 'Q4 TaxAdj < 0, No Adj'
                         do log-audit
                        #endif
                     #endif
		  		
		 #endif
	
              #else
                  #ifndef SKIP_TAX_AND_WAGE_AUDITS
                   let $message  = 'Q4 TaxAdj < 0, No Adj'
		   do log-audit
	          #endif
	      #endif
            end-if
           end-if
         #endif
       end-if
      end-if
    end-if
end-procedure
 
#ifdef ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST
begin-procedure get-tba-medee-surcharge
 
  let #UF_Surcharge_Adj = 0
 
  let $Surcharge_TBA_DT = $Qtr_End_Native
  #ifdef ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST_START_DT
    let #RptYearPlusOne = #RptYear + 1
    move #RptYearPlusOne to $RptYearPlusOne xxxx
    let $Surcharge_TBA_DT = $RptYearPlusOne || rtrim('{ADPAMEND_TBA_MEDEE_SURCHARGE_ADJUST_START_DT}',' ')
  #endif
 
  if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
     show 'get-tba-medee-surcharge, Box ' $Box ', Extracting TBAs for Tax Class 7 with Dates entered >= ' $Surcharge_TBA_DT
  end-if
 
begin-SELECT
MADJ.TAX_ADJ
 
 let #UF_Surcharge_Adj = &MADJ.TAX_ADJ
 if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'
     show 'get-tba-medee-surcharge, Adjustment for MEDEE Surcharge $U7 = ' #UF_Surcharge_Adj edit 999,999,999.99
 end-if
 
 FROM PS_BAL_ADJ_TAX MADJ
   WHERE   MADJ.EMPLID       = $Current_Emplid
     AND   MADJ.COMPANY      = $Current_Company
     AND   MADJ.BALANCE_ID   = $Calendar_Year_Id
     AND   MADJ.BALANCE_YEAR = #RptYear
     AND   MADJ.STATE        = '$U'
     AND   MADJ.TAX_CLASS    = '7'
     AND   MADJ.DT_ENTERED   >= $Surcharge_TBA_DT
     AND MADJ.BALANCE_PERIOD  = (SELECT MAX(BALANCE_PERIOD)
       FROM  PS_BAL_ADJ_TAX
        WHERE  COMPANY       = MADJ.COMPANY
         AND  EMPLID        = MADJ.EMPLID
         AND  STATE         = MADJ.STATE
         AND  LOCALITY      = MADJ.LOCALITY
         #ifdef PAACT_32_11F_Logic                 !3/12/2012 added
         AND  WORK_PSD_CD   = MADJ.WORK_PSD_CD
         AND  RES_PSD_CD    = MADJ.RES_PSD_CD
         #endif
         AND  TAX_CLASS     = MADJ.TAX_CLASS
         AND  BALANCE_ID    = MADJ.BALANCE_ID
         AND  BALANCE_YEAR  = MADJ.BALANCE_YEAR
         #ifdef USE_INT_CRITERIA
            AND  BALANCE_PERIOD  <= int(\$RptMonthZ\))
         #else
            AND  BALANCE_PERIOD  <= #RptMonth)
         #endif
 
 #ifdef SELECT_WITH_UR
  {SELECT_WITH_UR} with ur
 #endif
 end-select
 
end-procedure
#endif
 
 
!--------------- beginning of Audit Resident Changes --------------------------
 
#ifndef SKIP_RESIDENT_AUDIT
 
begin-procedure check-resident-change
 
  let $Resident_at_start_of_Qtr = ''
 
BEGIN-SELECT
LD0.EMPLID
LD0.STATE
LD0.RESIDENT
LD0.LOCALITY
LD0.COMPANY
LD0.EFFDT
 
  let $Resident_at_start_of_Qtr = rtrim(&LD0.RESIDENT,' ')
 
  FROM PS_LOCAL_TAX_DATA LD0 {NOLOCK_SQL}
     WHERE LD0.EMPLID       = $Current_Emplid
       AND LD0.COMPANY      = $Current_Company
       AND LD0.STATE        = $TaxBalance_State
       AND LD0.LOCALITY     = $TaxBalance_Locality
       AND LD0.EFFDT=(SELECT MAX(EFFDT)
        FROM   PS_LOCAL_TAX_DATA {NOLOCK_SQL}
        WHERE  EMPLID   = $Current_Emplid
          AND  COMPANY  = $Current_Company
          AND  STATE    = $TaxBalance_State
          AND  LOCALITY = $TaxBalance_Locality
          AND  EFFDT    < $Qtr_Start_Native)
 
 
 #ifdef SELECT_WITH_UR
  {SELECT_WITH_UR} with ur
 #endif
 end-select
 
  if $Resident_at_start_of_Qtr = ''
   let $Resident_at_start_of_Qtr = $Resident   !if no prior qtr residency.. set to current $resident status
  else
   if $Resident_at_start_of_Qtr <> rtrim(&LD.RESIDENT,' ')
    let $New_Resident_Status = $Resident
    let $New_Resident_Effdt  = &LD0.EFFDT
    do log-resident-changes
    goto done_resident_change
   end-if
  end-if
 
BEGIN-SELECT
LDN.EMPLID
LDN.STATE
LDN.RESIDENT
LDN.LOCALITY
LDN.COMPANY
LDN.EFFDT
 
  if $Resident_at_start_of_Qtr <> &LDN.RESIDENT
    let $New_Resident_Status = rtrim(&LDN.RESIDENT,' ')
    let $New_Resident_Effdt  = &LDN.EFFDT
    do log-resident-changes
  end-if
 
  FROM PS_LOCAL_TAX_DATA LDN {NOLOCK_SQL}
     WHERE LDN.EMPLID       = $Current_Emplid
       AND LDN.COMPANY      = $Current_Company
       AND LDN.STATE        = $TaxBalance_State
       AND LDN.LOCALITY     = $TaxBalance_Locality
       AND LDN.EFFDT       >= $Qtr_Start_Native
       AND LDN.EFFDT       <= $Qtr_End_Native
 
   ORDER by LDN.EFFDT
 
 #ifdef SELECT_WITH_UR
  {SELECT_WITH_UR} with ur
 #endif
 end-select
 
done_resident_change:
 
end-procedure
 
begin-procedure log-resident-changes
 
   if #resident_changes < {MAX_resident_change}
    put  $Current_company         -
         $Current_Emplid          -
         $TaxBalance_State        -
         $TaxBalance_Locality     -
         $New_Resident_Status     -
         $New_Resident_Effdt      -
           into Resident_Change(#Resident_Changes) -
             company       -
             emplid        -
             state         -
             locality      -
             resident      -
             Effdt
 
    add 1 to #resident_changes
 
   else
 
     if #MAX_resident_change_warnings < 1
      #debugd show 'Warning: Maximum number of Resident_changes logged, increase array, Resident_Change ( {MAX_resident_change} ) '
      add 1 to #MAX_resident_change_warnings
     end-if
 
   end-if
 
end-procedure
 
begin-procedure print-resident-audit
 
    #debugd show 'print-resident-audit: resident_changes = ' #resident_changes
 
    if #resident_changes > 0
 
      let #header_type = 8
      let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Audit Resident Changes.'
 
      let #i = 0
      while (#i < #resident_changes)
 
        if #current-line > 56
          New-Page
        end-if
 
        Get $C -
            $E -
            $S -
            $L -
            $R -
            $effdt_res -
            from Resident_Change(#i) -
             Company       -
             Emplid        -
             state         -
             locality      -
             resident      -
             effdt
 
           print $C           (+1,1)
           print $E           (0,16)
           print $S           (0,36)
           print $L           (0,46)
           print $R           (0,56)
        !   print $effdt_res   (0,63)
 
        add 1 to #i
 
      end-while
 
      print 'Total Count of Local Resident Status changes = ' (+2,1)
      print #resident_changes  () edit 99999
      print '  (NOTE, these are listed in the report only as an informative audit)'  (+2,1)
      New-Page
 
   end-if
 
end-procedure
#endif
!--------------- end of Audit Resident Changes --------------------------
 
#ifdef PRINT_ZERO_LOCALS
begin-procedure log-zero-locals
 
  let #zCnt          = 0
  while #zCnt < #new_cnt
 
    Add 1 to #zCnt
    get $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          $TaxBalance_Resident       -
      from TaxBalance(#zCnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Resident
 
  let $Class_trimmed = rtrim($TaxBalance_Tax_Class,' ')
  let $Local_trimmed = rtrim($TaxBalance_Locality,' ')
  let $State_trimmed = rtrim($TaxBalance_State,' ')
 
  if $state_trimmed <> 'FO' AND   !11/12/07, FORM945P causing local audits
     $Local_trimmed <> '' AND (#TaxBalance_Txgrs_Ytd > 0 AND #TaxBalance_Tax_Ytd = 0)
 
   if #Zero_locals < {MAX_zero_locals}
    put  $Current_company         -
         $Current_Emplid          -
         $State_Trimmed           -
         $Local_Trimmed           -
         $TaxBalance_Resident     -
         #TaxBalance_Txgrs_Qtd    -
         #TaxBalance_Tax_Qtd      -
         #TaxBalance_Txgrs_Ytd    -
         #TaxBalance_Tax_Ytd      -
           into Zero_locals(#Zero_locals) -
             company       -
             emplid        -
             state         -
             locality      -
             resident      -
             QTD_txgrs     -
             QTD_taxes     -
             YTD_txgrs     -
             YTD_taxes
 
    add 1 to #Zero_locals
 
   else
 
     if #zero_local_Warning < 1
      #debugd show 'Warning: Maximum number of Zero_Locals logged, increase array, Zero_Locals ( {MAX_zero_locals} ) '
      add 1 to #zero_local_Warning
     end-if
 
   end-if
 
  end-if
 
  ! add 1 to #zCnt  !commented out 6/6/7 per Renee @CinBell
 
 end-while
 
end-procedure
 
begin-procedure print-zero-locals
 
    if #Zero_locals > 0
 
      let #header_type = 6
      let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. (YTD Withheld=0 AND YTD Taxable>0) Zero Local Audit'
 
      let #i = 0
      while (#i < #Zero_locals)
 
        if #current-line > 56
          New-Page
        end-if
 
        Get $C -
            $E -
            $S -
            $L -
            $R -
            #Q_Taxable -
            #Q_WH -
            #Y_Taxable -
            #Y_WH -
            from Zero_locals(#i) -
             Company       -
             Emplid        -
             state         -
             locality      -
             resident      -
             QTD_txgrs     -
             QTD_taxes     -
             YTD_txgrs     -
             YTD_taxes
 
           print $C       (+1,1)
           print $E       (0,16)
           print $S       (0,36)
           print $L       (0,46)
           print $R       (0,56)
           print #Q_Taxable (0,65)    edit $$$,$$$,$$$,$$9.99mi
           print #Q_WH      (0,84)    edit $$$,$$$,$$$,$$9.99mi
           print #Y_Taxable (0,101)   edit $$$,$$$,$$$,$$9.99mi
           print #Y_WH      (0,120)   edit $$$,$$$,$$$,$$9.99mi
 
        add 1 to #i
 
      end-while
 
      print 'Total Count of Zero Locals (Taxable wages with zero Taxes withheld) = ' (+2,1)
      print #Zero_locals  () edit 99999
      print '  (NOTE, these are listed in the report only as an informative audit)'  (+2,1)
      New-Page
 
   end-if
 
end-procedure
 
#endif
 
#ifdef VT_HEALTH_INSURANCE_INDICATOR
 
#ifdef VT_HEALTH_INSURANCE_07C  !June 14, 2007 added
 
! example from probiz.sqc
!    #define VT_HEALTH_INSURANCE_INDICATOR
!    #define VT_HEALTH_INSURANCE_07C
! -----------------------------------------
 
begin-procedure Get-Associate-Enroll
 
 let $Health_insurance_indicator = '1' !Waived is deemed uncovered... set flag to '1'
 
 ! PS_STATE_TAX_DATA.HLTH_COV_IND A,B,C,D,N,S (Covered codes will be A,B and S (see doc section related to 07C)
 
BEGIN-SELECT
SH.HLTH_COV_IND
 
#ifdef HLTH_COV_IND_CUSTOM
   if {HLTH_COV_IND_CUSTOM}         !eg. #define HLTH_COV_IND_CUSTOM     &SH.HLTH_COV_IND = 'A' OR &SH.HLTH_COV_IND = 'B' OR &SH.HLTH_COV_IND = 'C'
     let $Health_insurance_indicator = '3'
   end-if
#else
  #ifdef HLTH_COV_IND_DEFAULT_COVERED
     if &SH.HLTH_COV_IND = 'A' OR &SH.HLTH_COV_IND = 'B' OR &SH.HLTH_COV_IND = 'S' OR &SH.HLTH_COV_IND = 'N'  !'N' added 1/21/09
  #else
     if &SH.HLTH_COV_IND = 'A' OR &SH.HLTH_COV_IND = 'B' OR &SH.HLTH_COV_IND = 'S'
  #endif
     let $Health_insurance_indicator = '3'
   end-if
#endif
 
  FROM PS_STATE_TAX_DATA SH {NOLOCK_SQL}
  WHERE     SH.EMPLID  = $Current_Emplid  AND
            SH.COMPANY = $Current_Company AND
            SH.STATE   = $State_trimmed AND
            SH.EFFDT=(SELECT MAX(SH1.EFFDT)
                   FROM PS_STATE_TAX_DATA SH1 {NOLOCK_SQL}
                   WHERE  SH1.EMPLID      = SH.EMPLID  AND
                          SH1.COMPANY     = SH.COMPANY AND
                          SH1.STATE       = SH.STATE   AND
                          SH1.EFFDT       <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Associate-Enroll' to $debug-proc1
     move 'PS_STATE_TAX_DATA'    to $debug-table1
     do log-delta-time
  #endif
 
end-procedure
 
#else
 
#ifdef VT_HEALTH_DEDUCTION_BAL_CRITERIA
                                 !if this is not defined, we'll read the PS_HEALTH_BENEFITS coverage
                                 !if it IS defined, we'll flag 'covered' for anyone with the specified criteria
 
! -----------------------------------------------------------------------------------------
! example from probiz.sqc
!    #define VT_HEALTH_INSURANCE_INDICATOR
!    #define VT_HEALTH_DEDUCTION_BAL_CRITERIA          HDED.DEDCD in (''MED'',''PPO'')
! -----------------------------------------------------------------------------------------
 
begin-procedure Get-Associate-Enroll
 
     let $Health_insurance_indicator = '1' !Waived is deemed uncovered... set flag to '1'
     let $dedcd_vt = '{VT_HEALTH_DEDUCTION_BAL_CRITERIA}'
 
begin-SELECT
HDED.COMPANY
HDED.EMPLID
HDED.DED_YTD
HDED.DEDCD
HDED.DED_CLASS
HDED.PLAN_TYPE
HDED.BENEFIT_PLAN
HDED.BALANCE_PERIOD
 
  let $Health_insurance_indicator = '3' !Elect coverage, covered under a plan... set it to a '3'
 
FROM  PS_DEDUCTION_BAL{WAREHOUSE_SUFFIX} HDED
  WHERE HDED.EMPLID            = $Current_Emplid
    AND HDED.COMPANY           = $Current_COMPANY
    AND HDED.BALANCE_ID        = $Calendar_Year_Id
 
     #ifdef MVS
       AND \$dedcd_vt\
     #else
       AND [$dedcd_vt]
     #endif

   #ifdef USE_INT_CRITERIA
    AND HDED.BALANCE_YEAR      = int(\$RptYearZ\)
   #else
    AND HDED.BALANCE_YEAR      = #RptYear
   #endif
 
    AND HDED.BALANCE_PERIOD    = (SELECT MAX(BALANCE_PERIOD)
       FROM   PS_DEDUCTION_BAL{WAREHOUSE_SUFFIX}
       WHERE  EMPLID            = HDED.EMPLID
         AND  BALANCE_ID        = HDED.BALANCE_ID
         AND  BALANCE_YEAR      = HDED.BALANCE_YEAR
         #if {Peoplesoft_Version} >= '8'                 !12/3/04
         AND  BENEFIT_RCD_NBR   = HDED.BENEFIT_RCD_NBR
         #endif
         AND  PLAN_TYPE         = HDED.PLAN_TYPE
         AND  BENEFIT_PLAN      = HDED.BENEFIT_PLAN
         AND  DED_CLASS         = HDED.DED_CLASS
         AND  COMPANY           = HDED.COMPANY
         AND  DEDCD             = HDED.DEDCD
         #ifdef USE_INT_CRITERIA
            AND  BALANCE_PERIOD  <= int(\$RptMonthZ\))
         #else
            AND  BALANCE_PERIOD  <= #RptMonth)
         #endif
 
    AND HDED.DED_YTD <> 0
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
#else
 
begin-procedure Get-Associate-Enroll

#ifdef USE_INT_CRITERIA
     Let $empl_rcd = &JB.{emp_rec}
#endif
 
begin-select distinct
 
HB.PLAN_TYPE
HB.BENEFIT_PLAN
HB.COVERAGE_ELECT
HB.COVRG_CD
HB.EFFDT
 
   !COVRG_CD, Description
   !----------------------
   ! 1  Employee Only			  (PS_COVRG_CD_TBL)
   ! 2  Employee + 1			
   ! 3  Employee + Children		
   ! 4  Family				
   ! 3  Employee + Child		
   ! 5  Employee + 1 Young Adult	
   ! 6  Employee + 1 + 1 Young Adult	
   ! 7  Employee + 1 + 2 Young Adults	
   ! 8  Family + 1 Young Adult		
   ! 9  Family + 2 Young Adult		
   ! A  Employee +1+3YA			
   ! B  Employee Only-APG 		
   ! C  Employee Only APG 		
   ! D  Dependent Only			
   ! E  2 Dependents Only		
   ! 3  Employee + Child		
 
   if &HB.COVERAGE_ELECT = 'E' or &HB.COVERAGE_ELECT = 'W'
     let $Health_insurance_indicator = '3' !Elect or Waive coverage, covered under a plan... set it to a '3'
   else
     let $Health_insurance_indicator = '1' !otherwise set flag to '1' (uncovered)
   end-if

 from PS_HEALTH_BENEFIT HB
 
   where HB.EMPLID         = $Current_Emplid

     #ifdef USE_INT_CRITERIA
      and HB.{emp_rec}      = int(\$empl_rcd\)
     #else
      and HB.{emp_rec}      = &JB.{emp_rec}
     #endif

      and HB.PLAN_TYPE       =  '10'            ! '10' - Health Benefit, '11' - Dental, '14' - vision
      and HB.COVERAGE_ELECT  in ('E','W')       ! Elected or Waived = covered, not terminated
      and HB.EFFDT           = (select max(HB1.EFFDT)
                              from PS_HEALTH_BENEFIT HB1
                               where HB1.EMPLID            = HB.EMPLID
                                 and HB1.{emp_rec}         = HB.{emp_rec}
                                 and HB1.COBRA_EVENT_ID    = HB.COBRA_EVENT_ID
                                 and HB1.PLAN_TYPE         = HB.PLAN_TYPE
                                 and HB1.EFFDT            <= $Qtr_End_Native)
 
end-select
 
end-procedure  !Get-Associate-Enroll
 
#endif
#endif
#endif
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Process-Quarterly-Record                                  !
! Desc:      This procedure creates/writes the ProBusiness Q1 record.  !
!                                                                      !
!----------------------------------------------------------------------!
begin-procedure Process-Quarterly-Record
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  let #Last_Q1_Cnt          = 0
  let $first_tax_for_emplid = 't'
  let $first_state_tax_for_emplid = 't'
  let $sui_for_emplid = 'f'
 
   !2/4/4 added
   #if {Quarterly_extract_specs} >= '3.00'
    if $adp_format = 't' and $adp_w2_records = 't'
 
      if $SelectEmplid <> ''
        #debugd show 'Calling : Read-W-2-Employee-Boxes'
      end-if
 
      do Read-W-2-Employee-Boxes  !reades W-2 and W-2C boxes (potentially)
      do check-for-void-w2                            !8/13/07 moved to here
      if $check-for-void-w2 = 't'
       add 1 to #void-w2-hash_count
      end-if
 
      !W-2C optional inclusion
      !---------------------------------------------------------------
       #ifdef INCLUDE_W2C
 
        if $SelectEmplid <> ''
         #debugd show '$adp_w2_records ' $adp_w2_records ', $process_W2C_data ' $process_W2C_data ', $reject_w2c ' $reject_w2c
        end-if
 
        if $RptQtr = '4' and $adp_w2_records = 't'and  $process_W2C_data = 't' and $reject_w2c <> 't'
          if $SelectEmplid <> ''
           #debugd show 'Calling SaveBalances prior to W-2C extract'
          end-if
          do SaveBalances     !in adpw2c.sqc - Save original tax balances in case we need to revert to them due to reject
        end-if
 
        if $YEE.PROCESS_FLAG = 'V'
          #debugd show 'Note: Read-Employee-Data-W2C will NOT be invoked due to the W-2 being VOIDED'
        else
           if $SelectEmplid <> ''
             #debugd show 'Calling Read-Employee-Data-W2C..'
           end-if
           let $W2C_Data_Included = ''
           do Read-Employee-Data-W2C                  !in adpw2c.sqc
        end-if
       #endif
       !---------------------------------------------------------------
 
       do adjust-tax-balances                          !adjustments (including voids) handled here
 
    end-if
   #endif
 
   #ifdef INCLUDE_W2C
 
    if $W2C_Data_Included = 't'    ! changed on 5/23/08 to use W2C_Data_Included, not W2C_included
     if $RptQtr = '4' and $adp_w2_records = 't'and  $process_W2C_data = 't' and $reject_w2c <> 't'
      do create-w2c-audit !in adpw2c - this will audit the TaxBalances, and if we determine a reject... will revert back
      if $w2c_abend <> ''
        do RestoreBalances
      end-if
     end-if
    end-if
   #endif
 
   #ifdef INCLUDE_LCL_ADJ
     do Include-LCL-ADJ  !in adppaaut.sqc to adjust locals in PA
   #endif
 
   do sort-tax-balances  !added 12/9/4
 
   #ifdef PRINT_ZERO_LOCALS
    do log-zero-locals
   #endif
 
   #ifdef ADJUST_ZERO_LOCALS  !12/8/6, this should be called for all quarters
     do adjust-zero-locals
   #endif
 
 
   #ifdef LOCAL_RECIPROCITY
    #ifdef LOCAL_RECIPROCITY_SPECIAL_REPORT
     do Update-Special-locality-totals
    #endif
   #endif
 
   let $Statetax_Wage_Plan_CD_set = ''
   let #Save_QTD_Hours_Worked = 0
   let #Save_QTD_Weeks_Worked = 0
 
! ----------------------------------------------------------------------------------------
  let #Last_Q1_Cnt = 0
  while #Last_Q1_Cnt < #new_cnt
 
    Add 1 to #Last_Q1_Cnt
    get $TaxBalance_State        -
          $TaxBalance_Locality       -
          $TaxBalance_Tax_Class      -
          #TaxBalance_Nlgrs_Qtd      -
          #TaxBalance_Txgrs_Qtd      -
          #TaxBalance_Tax_Qtd        -
          #TaxBalance_Nlgrs_Ytd      -
          #TaxBalance_Txgrs_Ytd      -
          #TaxBalance_Tax_Ytd        -
          #TaxBalance_Tip_Wages_Qtd  -
          #TaxBalance_Tip_Wages_Ytd  -
          #TaxBalance_Tip_Tax_Qtd    -
          #TaxBalance_Tip_Tax_Ytd    -
          $TaxBalance_Resident       -
          $TaxBalance_RES_PSD_CD     -
          $TaxBalance_WORK_PSD_CD      -
      from TaxBalance(#Last_Q1_Cnt)    -
           TaxBalance_State      -
           TaxBalance_Locality   -
           TaxBalance_Tax_Class  -
           TaxBalance_Nlgrs_Qtd  -
           TaxBalance_Txgrs_Qtd  -
           TaxBalance_Tax_Qtd    -
           TaxBalance_Nlgrs_Ytd  -
           TaxBalance_Txgrs_Ytd  -
           TaxBalance_Tax_Ytd    -
           TaxBalance_Tip_Wages_Qtd  -
           TaxBalance_Tip_Wages_Ytd  -
           TaxBalance_Tip_Tax_Qtd    -
           TaxBalance_Tip_Tax_Ytd    -
           TaxBalance_Resident       -
           TaxBalance_Res_PSD_CD     -
           TaxBalance_Work_PSD_CD
 
 let $Class_trimmed = rtrim($TaxBalance_Tax_Class,' ')
 let $Local_trimmed = rtrim($TaxBalance_Locality,' ')
 let $State_trimmed = rtrim($TaxBalance_State,' ')
 let $WC_Locality = ''
 if $SelectEmplid <> '' or $Current_Emplid = '{TESTING_EMPLID}'   !04232013
    show ' '
    show 'Processing TaxBalance, cnt = ' #Last_Q1_Cnt edit 999 ' for Taxcode: ---------------------------------------------->  ' $TaxBalance_State  $TaxBalance_Tax_Class $TaxBalance_Locality $TaxBalance_Resident
    show ' QTD Subject = ' #TaxBalance_Nlgrs_Qtd edit 999,999,999.99mi ', QTD Taxable = ' #TaxBalance_Txgrs_Qtd edit 999,999,999.99mi ', QTD Taxes = ' #TaxBalance_Tax_Qtd edit 999,999,999.99mi
    show ' YTD Subject = ' #TaxBalance_Nlgrs_YTD edit 999,999,999.99mi ', YTD Taxable = ' #TaxBalance_Txgrs_YTD edit 999,999,999.99mi ', YTD Taxes = ' #TaxBalance_Tax_YTD edit 999,999,999.99mi
 end-if
 
 if $Local_trimmed <> '' AND
    #TaxBalance_Nlgrs_Qtd = 0 and #TaxBalance_Txgrs_Qtd = 0 and #TaxBalance_Tax_Qtd = 0 and
    #TaxBalance_Nlgrs_Ytd = 0 and #TaxBalance_Txgrs_Ytd = 0 and #TaxBalance_Tax_Ytd = 0
   goto zero_wage_tax
 end-if
 
 if $State_trimmed <> '--'
 
     !7/6/09 reworked - QTD's were getting set to zero for ytd's of zero too
     !----------------------------------------------------------------------
     if $Class_Trimmed = 'H'         !prior to 7/7/09 this was: if #TaxBalance_Nlgrs_Ytd = 0 or #TaxBalance_Nlgrs_Qtd = 0
 
       #ifdef NLGRS_FROM_CHECK_YTD_AMOUNT
         do calc-gross99
         let #TaxBalance_Nlgrs_Ytd = #Total_Gross_ytd
         let #TaxBalance_Nlgrs_Qtd = #Total_Gross_qtd
       #else
         Let #TaxBalance_Nlgrs_Ytd = #TaxBalance_Txgrs_Ytd
         Let #TaxBalance_Nlgrs_Qtd = #TaxBalance_Txgrs_Qtd
       #endif
 
     end-if
 
     let #wc_rate = 0  !10/13/05 added
     do Format-Number(#wc_rate,$wc_rate,  '9999999999')
 
     !6/21/01 moved this code from get-job-data to here
     !-------------------------------------------------
     move ' ' to $Occup_Title
     move ' ' to $Occup_Code
     move ' ' to $wc_code
 
     let #QTD_Hours_worked = 0
     let #EarningsBal_Hrs_Ytd = 0
     let #QTD_Hours_Worked = 0
     let #QTD_Weeks_Worked = 0
     let #YTD_Weeks_Worked = 0
     let #WeeksWorked      = 0
     move ' 0'      to $Qtd_weeks_worked
     move ' 0'      to $Ytd_weeks_worked
     move '   0'   to $Qtd_Hours_Worked
 
     #ifdef DETERMINE_MONTHLY_COUNTS_BASED_ON_TAX_BALANCES
       let $Month1_Worked = 'N'
       let $Month2_Worked = 'N'
       let $Month3_Worked = 'N'
       if ($State_trimmed <> '$U' AND ($Class_trimmed = 'U' OR $Class_trimmed = 'S')) OR ($State_trimmed = '$U' AND $Class_trimmed = 'H') or ($Local_trimmed <> '')
        do Get-Worked-In-Months-Flags-Based-on-Balances
       end-if
     #else
       #if {SITE_ID} = 'JCP1'
          if $Current_Company = 'RET'
            do Get-Worked-In-Months-Flags-JCP-Ret-Company
          else
            do Get-Worked-In-Months-Flags  !For SUI Worksite counts, and worksite reporting (optional)
          end-if
        #else
            do Get-Worked-In-Months-Flags
        #endif
     #endif
 
     ! --------------------------------------------------------------------------------------------------
     ! The SUI Agencies that require 'QTD Weeks worked' data are:
     !   Arkansas Delaware Indiana Louisiana Massachusetts Mississipi Missouri New Hampshire New Jersey
     !   Ohio Oklahoma Oregon Penn Tennessee Wyoming
     ! The states that require 'QTD Hours worked' are:
     !   Minnesota Oregon Tennessee Mississippi Indiana Oklahoma Missouri Washington Wyoming
     ! So, the states that need 'weeks' and were not getting it for Q1 & Q2, 2000 are:
     !   Arkansas Delaware Louisiana Massachusetts New Hampshire  New Jersey Ohio Pennsylvania
     !---------------------------------------------------------------------------------------------------
 
     #ifdef USE_STATE_IN_WORKSITE_JOB_QUERY_ALWAYS
       if $State_trimmed <> '$U' AND ($Class_trimmed = 'U' OR $Class_trimmed = 'S')
        do retrieve-sui-data
       end-if
     #else
      if #sui_jurisdictions > 1
       if $State_trimmed <> '$U' AND ($Class_trimmed = 'U' OR $Class_trimmed = 'S')
        do retrieve-sui-data
       end-if
      end-if
     #endif
 
     if ($State_trimmed = 'AK')
       do Get-Area-Code
     end-if
 
     if ($State_trimmed = 'WY' OR $State_trimmed = 'AK' ) and (rtrim($occup_code,' ') = '')
       do get-occupational-data
     end-if
 
     #ifdef WA_WORKERS_COMP_ENABLE
      if ($State_trimmed = '{WA_STATE}') and (rtrim($occup_code,' ') = '') and ($WA_WORKERS_COMP_ENABLE = 't')
        do get-occupational-data
      end-if
     #endif
 
     do Wyoming-rate-data
 
     #ifdef WA_WORKERS_COMP_ENABLE
      if $WA_WORKERS_COMP_ENABLE = 't' and ($State_trimmed = '{WA_STATE}') and ($Local_Trimmed <> '')
       do Washington-rate-data
      end-if
     #endif
 
     if ($Local_trimmed <> '') OR          !added ALL locals on 10/12/04 just to be sure..
        ( ($State_trimmed <> '$U')  AND
          ( ($Class_trimmed = 'U') OR ($Class_trimmed = 'B') OR ($Class_trimmed = 'S') ) )
 
       do calc-hours-weeks-paid
 
       !20140929 Use Oregon W/C Hours for Oregon SUI
       !--------------------------------------------
       #ifdef USE_OREGON_WC_HOURS_and_WEEKS_FOR_SUI
        if {USE_OREGON_WC_HOURS_and_WEEKS_FOR_SUI}
         if ($Local_trimmed = 'OR0001') AND ($State_trimmed = 'OR')  AND ($Class_trimmed = 'B')
           let #Save_QTD_Hours_Worked =  #QTD_Hours_worked
           let #Save_QTD_Weeks_Worked =  #QTD_Weeks_Worked
 
         else
          if ($Local_trimmed = '') AND ($State_trimmed = 'OR')  AND $Class_trimmed = 'U' AND (#Save_QTD_Weeks_Worked > 0 and #Save_QTD_Weeks_Worked > 0)
           if $SelectEmplid <> ''
             show 'USE_OREGON_WC_HOURS_and_WEEKS_FOR_SUI. ' $Current_Emplid ' Using ' #Save_QTD_Hours_Worked edit 9999 ' for SUI hours, not ' #QTD_Hours_worked edit 9999
             show '                                       ' $Current_Emplid ' Using ' #Save_QTD_Weeks_Worked edit 9999 ' for SUI weeks, not ' #QTD_Weeks_Worked edit 9999
           end-if
           let #QTD_Hours_worked = #Save_QTD_Hours_Worked
           let #Save_QTD_Hours_Worked = 0
           do Format-Number(#QTD_Hours_worked, $Qtd_Hours_Worked,   '9999')
 
           let #QTD_Weeks_Worked = #Save_QTD_Weeks_Worked
           let #Save_QTD_Weeks_Worked = 0
           do Format-Number(#QTD_Weeks_Worked,$Qtd_weeks_worked,   '99')
 
          end-if
         end-if
        end-if
       #endif
       !--------------------------------------------
 
     end-if
 
     #ifdef USE_UI_RPT_CD_FOR_MN_MI_LOCATION  !moved from job query 8/21/07 for speed
       if ($State_trimmed = 'MN') OR ($State_trimmed = 'MI') OR
          ($State_trimmed = 'MA') OR ($State_trimmed = 'IA') OR ($State_trimmed = 'NM')
         do Get-Rpt-Unit-Number
       end-if
     #endif
 
     #if {SITE_ID} = 'MCK1'
       if ($State_trimmed = 'MI') or ($State_trimmed = 'MN') or
          ($State_trimmed = 'MA') or ($State_trimmed = 'IA')
         let $UiRptCode5  = '00000'
       end-if
       if ($State_trimmed = 'NM')
         let $UiRptCode5  = '{NM_UI_LOCATION_DFLT}'
       end-if
     #endif
 
     #if {SITE_ID} = 'SCR1'            !added 8/21/07
       if ($State_trimmed = 'MN') OR ($State_trimmed = 'MI') or
          ($State_trimmed = 'MA') or ($State_trimmed = 'IA') OR ($State_trimmed = 'NM')
         do get-SCR1-MN-MI-location
       end-if
     #endif
 
    #if {SITE_ID} = 'VZN1'
     if ($State_trimmed = 'WY')
       if ($Current_Company = '151')
         let #wc_rate =  0.0107                 !1.07% = This will get multiplied by 1000000 and become 0000010700 in the data file
         let #t = #wc_rate * {WC_RATE_FACTOR}
         do Format-Number(#t,$wc_rate,  '9999999999')
       end-if
 
       !If company 001 for VZN1, always set the code to '517911', and rate to 0.77
 
       if ($Current_Company = '001')
         let #wc_rate =  0.0127                 !0.77% = This will get multiplied by 1000000 and become 0000007700 in the data file, 7/11/2012 change from .77 to 1.27%
         let #t = #wc_rate * {WC_RATE_FACTOR}
         do Format-Number(#t,$wc_rate,  '9999999999')
       end-if
     end-if
    #endif
 
    #if {SITE_ID} = 'IRC1'          !10/9/09
     if ($State_trimmed = 'WY')
       if rtrim($Input_Jobcode,' ') = 'S020' or rtrim($Input_Jobcode,' ') = 'S022'
         let #wc_rate =  0.0405                 !4.05% = This will get multiplied by 1000000 and become 0000040500 in the data file
         let #t = #wc_rate * {WC_RATE_FACTOR}
         do Format-Number(#t,$wc_rate,  '9999999999')
       end-if
 
       if rtrim($Input_Jobcode,' ') = 'S067'
         let #wc_rate =  0.0558                 !5.58% = This will get multiplied by 1000000 and become 0000055800 in the data file
         let #t = #wc_rate * {WC_RATE_FACTOR}
         do Format-Number(#t,$wc_rate,  '9999999999')
       end-if
     end-if
    #endif
 
    #if {SITE_ID} = 'WFG1'
 
     if ($State_trimmed = 'WY')
 
      let $wc_code = ''
      let #wc_rate = 0
 
begin-SELECT on-error = SQL-Error
E.TF_WRKRS_COMP_CD,
E.RESIDENT_TAX_RT
 
     let $wc_code = substr(&E.TF_WRKRS_COMP_CD,1,6)
     let #wc_rate = &E.RESIDENT_TAX_RT
 
      FROM PS_TF_COMPANY_XREF D,
           PS_TF_COMPANY_TBL E
      WHERE D.COMPANY = $COMPANY
        AND E.TF_COMPANY = D.TF_COMPANY
        AND D.EFF_STATUS = 'A'
        AND D.EFFDT = (SELECT MAX(D1.EFFDT)
             FROM PS_TF_COMPANY_XREF D1
              WHERE D1.COMPANY  = D.COMPANY
                AND D1.EFFDT <= $Qtr_End_Native)
                AND E.EFF_STATUS = 'A'
                AND E.EFFDT = (SELECT MAX(E1.EFFDT)
                  FROM PS_TF_COMPANY_TBL E1
                    WHERE E1.TF_COMPANY  = E.TF_COMPANY
                      AND E1.EFFDT <= $Qtr_End_Native)
 
      #ifdef SELECT_WITH_UR
       {SELECT_WITH_UR} with ur
      #endif
 
end-select
 
    end-if
 
    let #t = #wc_rate * {WC_RATE_FACTOR}  !1/8/8  tied to RESIDENT_TAX_RT of PS_TF_COMPANY_TBL
    do Format-Number(#t,$wc_rate,  '9999999999')
 
#endif
! ---------------------------------------------------------------------
 
#if {SITE_ID} = 'JLL1'  !added 6/4/7
 
  if ($State_trimmed = 'WY')
 
      let $wc_code = ''
      let #wc_rate = 0
 
 
begin-SELECT
JLA.WORKERS_COMP_CD
JLA.LP_WORK_COMP_RT
 
     let $wc_code = substr(&JLA.WORKERS_COMP_CD,1,6)
     let #wc_rate = &JLA.LP_WORK_COMP_RT
 
  FROM PS_LP_WORKCOMP_TBL JLA
    WHERE JLA.STATE = 'WY'
     AND JLA.EFFDT = (SELECT MAX(A_ED.EFFDT)
       FROM PS_LP_WORKCOMP_TBL A_ED
         WHERE JLA.STATE = A_ED.STATE)
 
      #ifdef SELECT_WITH_UR
       {SELECT_WITH_UR} with ur
      #endif
end-select
 
    let #t = #wc_rate * {WC_RATE_FACTOR}  !11/3/05 eg. .017 should be reported as '000017000', .0046 as '0000004600'
    do Format-Number(#t,$wc_rate,  '9999999999')
 
  end-if
 
#endif
 
    !3/31/09 override RATE and/or COMP code for Wyoming
    !---------------------------------------------------
    #ifdef WY_WORKERS_COMP_RATE_OVERRIDE
     if ($State_trimmed = 'WY') and (($Local_Trimmed = 'WY0001') or ($class_trimmed = 'U'))
      let #wc_rate = {WY_WORKERS_COMP_RATE_OVERRIDE} !entered as .46% -->0000004600
     else
      let #wc_rate = 0
     end-if
     let #t = #wc_rate * {WC_RATE_FACTOR}
     do Format-Number(#t,$wc_rate,  '9999999999')
    #endif
 
    #ifdef WY_WORKERS_COMP_CODE_OVERRIDE
     if ($State_trimmed = 'WY') and (($Local_Trimmed = 'WY0001') or ($class_trimmed = 'U'))
      let $wc_code = '{WY_WORKERS_COMP_CODE_OVERRIDE}'
     else
      let $wc_code = ''
     end-if
    #endif
 
   !3/31/09 override RATE and/or COMP code for Washington L&I
   !---------------------------------------------------------
   #ifdef WA_WORKERS_COMP_ENABLE
    if $WA_WORKERS_COMP_ENABLE = 't'
 
     #ifdef WA_WORKERS_COMP_RATE_OVERRIDE
      if ($State_trimmed = '{WA_STATE}') and (($Local_Trimmed = 'WA0001') or ($class_trimmed = 'U'))
       let #wc_rate = {WA_WORKERS_COMP_RATE_OVERRIDE}
      else
       let #wc_rate = 0
      end-if
      let #t = #wc_rate * {WC_RATE_FACTOR}
      do Format-Number(#t,$wc_rate,  '9999999999')
     #endif
 
     #ifdef WA_WORKERS_COMP_CODE_OVERRIDE
      if ($State_trimmed = '{WA_STATE}') and (($Local_Trimmed = 'WA0001') or ($class_trimmed = 'U'))
       let $wc_code = '{WA_WORKERS_COMP_CODE_OVERRIDE}'
      else
       let $wc_code = ''
      end-if
     #endif
 
     #ifdef WA_WORKERS_COMP_RATE_OVERRIDE_ER
      if ($State_trimmed = '{WA_STATE}') and (($Local_Trimmed = 'WA0001ER') or ($class_trimmed = 'U'))
       let #wc_rate = {WA_WORKERS_COMP_RATE_OVERRIDE_ER}
      else
       let #wc_rate = 0
      end-if
      let #t = #wc_rate * 10000
      do Format-Number(#t,$wc_rate,  '9999999999')
     #endif
 
     #ifdef WA_WORKERS_COMP_CODE_OVERRIDE_ER
      if ($State_trimmed = '{WA_STATE}') and (($Local_Trimmed = 'WA0001ER') or ($class_trimmed = 'U'))
       let $wc_code = '{WA_WORKERS_COMP_CODE_OVERRIDE_ER}'
      else
       let $wc_code = ''
      end-if
     #endif
 
    end-if
 #endif
 
     #ifdef WORKERS_COMP_ENABLE_TABLE_WY
      #ifdef WORKERS_COMP_ENABLE_TABLE
       if ($State_trimmed = 'WY') and (($Local_Trimmed <> '') or ($class_trimmed = 'U'))
        do Retrieve-Workers-Comp-Data  !see if this is W/Comp data from our custom table... to pull in the code, and rate
       end-if
      #endif
     #endif
 
     ! ---------------------------------------------------------------------
     !Oregon.... workers comp rate
     if ($State_trimmed = 'OR') and ($Local_Trimmed = 'OR0001')
         let $get_local_rate = $Local_Trimmed
        do get-local-rate
     end-if
 
 
     !SUI Rate if necessary (all SUI's)
     !---------------------------------
#ifndef SKIP_SUI_SUMMARY
     let #Output_SUI_Rate = 0
     if ($State_trimmed <> '$U') and ( $Class_trimmed = 'U' or $Class_Trimmed = 'S' )
       let $sui_for_emplid = 't'
       do SUI-Rate-Lookup
     end-if
     let #t =  #Output_SUI_Rate * 10000000
     do Format-Number (#t,$Output_SUI_Rate,'999999999')
#endif
 
     let $Resident = ' '
     do ProBusiness-TaxCode-Lookup
 
     if rtrim($Output_Taxcode,' ') <> '{FORM945P_Taxcode}' AND
       rtrim($Output_Taxcode,' ') <> '{FORM1042_Taxcode}'
 
     if $Local_trimmed <> ''
 
      if rtrim($TaxBalance_WORK_PSD_CD,' ') <> '' and rtrim($TaxBalance_RES_PSD_CD,' ') <> ''
         let $PSD_CODES_BAL = 't'
      else
         let $PSD_CODES_BAL = ''
      end-if
 
      !1/13/04 - always set resident to "Y" if taxes for NYC have been withheld
      !-------------------------------------------------------------------------
      if rtrim($TaxBalance_Resident,' ') <> ''
         let $Resident = rtrim($TaxBalance_Resident,' ')
      else
       if $State_trimmed = 'NY' AND $Local_trimmed = 'P0001'    ! 7/26/04 AND #TaxBalance_Tax_Qtd > 0
         let $Resident = 'Y'
       else
         let $Resident = ' '
         if $PSD_CODES_BAL <> 't'
           do Extract-Resident-Code  !Prior to 1/13/04
           if $Resident = 'N'        !Prior to 1/13/04
             let $Resident = ' '     !Prior to 1/13/04
           end-if                    !Prior to 1/13/04
         end-if
       end-if
      end-if
      !-------------------------------------------------------------------------
 
      !Rebuild the output taxcode if necessary (stick $Resident in place 15)
      !---------------------------------------------------------------------
      if $Resident = 'N'
        let $Resident = ' '
      end-if
 
      if $Resident <> ' '
        Let $Output_Taxcode = substr($Output_Taxcode,1,14)  || $Resident
      end-if
    end-if
   end-if
 
   let $PA_PSD_Locality  = ''
   let $PA_RES_Locality  = ''
   let $PA_Work_Locality = ''  !this will have the Work locality
   let $RES_PSD_CD  = ''
   let $WORK_PSD_CD = ''
 
  #ifdef PA_WORKSITE_EXTRACT
 
       #ifdef INCLUDE_LCL_ADJ
        if $Include-LCL-ADJ-PA = 't' and $state_trimmed = '{PA_STATE}' and $Local_trimmed <> '' and $class_trimmed = 'H'         !THESE ARE THE ADJUSTMENT BALANCES
          let $PA_PSD_Locality = '      '
          let $PA_RES_Locality = '               '
          #ifdef PAACT_32_11F_Logic
           let $PA_PSD_Locality = rtrim($TaxBalance_RES_PSD_CD,' ')  !six chars into 503-508
          #else
           let $PA_RES_Locality = rtrim($TaxBalance_RES_PSD_CD,' ')  !fourteen chars into 514-528
          #endif
          goto skip_PA_WORKSITE_EXTRACT_logic_PA
        end-if
       #endif
 
       put $Resident into TaxBalance(#Last_Q1_Cnt) TaxBalance_Resident  !so the determine_pa_worksite has the resident status
 
       if $state_trimmed = '{PA_STATE}' and $Local_trimmed <> '' and $class_trimmed = 'H'
           let $ADJUST_ZERO_LOCALS_PA_EIT = 'f'
           let $PA_Taxcode  = $Output_Taxcode
           let $PA_resid    = $Resident
           let $PA_Emplid   = $Current_Emplid
           let $PA_Company  = $Current_Company
           let $PA_State    = $state_trimmed
           let $PA_Class    = $class_trimmed
           let $PA_Local    = $local_trimmed
           let $PA_end_date = $Qtr_End_Native
           let #PA_txgrs    = #TaxBalance_Txgrs_Qtd
           let #PA_taxes    = #TaxBalance_Tax_Qtd
 
           #ifdef PAACT_32_11F_Logic
               let $RES_PSD_CD  = rtrim($TaxBalance_RES_PSD_CD,' ')
               let $WORK_PSD_CD = rtrim($TaxBalance_WORK_PSD_CD,' ')
           #endif
 
           do determine_pa_worksite !$PA_Emplid, $PA_Company, $PA_State, $PA_end_date  --> $PA_Work_Locality
 
           #ifdef ROLLUP_PHILLY_BALANCES  !Resident status is determined during the initial processing of the balance, preserve it.
             if substr($Output_Taxcode,1,9) = 'PAH510101' or substr($Output_Taxcode,1,11) = 'PAHI510012M'
                Let $Output_Taxcode = substr($Output_Taxcode,1,14)  || $PA_resid
             end-if
           #endif
 
 
           if $ADJUST_ZERO_LOCALS_PA_EIT = 't' !11/1/11 - added to handle zero'ing out $0.00 tax records and not reporting them into the extract
             goto zero_wage_tax
           end-if
 
           #ifndef PA_WORKSITE_AUTO
             let $TB_State = $PA_Worksite_Location_code
             let $Cur_State = rtrim($TB_State,' ')
           #endif
      end-if
 
skip_PA_WORKSITE_EXTRACT_logic_PA:
   #endif
 
   !This logic added 9/17/99 DMonroe
   !--------------------------------
   let $Private_SDI = 'N'
   if ($State_Trimmed <> 'CA')
      let $Statetax_Wage_Plan_CD = ' '
   end-if
 
   if ($State_trimmed = 'NJ') AND ($Class_trimmed = 'U')
      do Find-Wage-Plan-Cd
      if ($State_trimmed = 'NJ') and (($Statetax_Wage_Plan_CD = 'P') OR ($Statetax_Wage_Plan_CD = 'R'))
        let $Private_SDI = 'Y'
      end-if
   end-if
 
   #ifdef CA_WAGE_PLAN_CD_IN_ALL_CA
 
     if ($State_Trimmed = 'CA')
      if rtrim($Statetax_Wage_Plan_CD_set,' ') = ''
        do Find-Wage-Plan-Cd
        #ifdef CA_WAGE_PLAN_CD_IN_CAH_CHECK_SUI
          do Find-Wage-Plan-Cd-Check
        #endif
        let $Statetax_Wage_Plan_CD_set = $Statetax_Wage_Plan_CD
      else
        let $Statetax_Wage_Plan_CD = $Statetax_Wage_Plan_CD_set                     ! Wage Plan code fix....  1/9/2012
      end-if
     end-if
 
   #else
 
    #ifdef CA_WAGE_PLAN_CD_IN_CAH
     if ($State_Trimmed = 'CA')  AND ($Class_trimmed = 'H')
      do Find-Wage-Plan-Cd
      #ifdef CA_WAGE_PLAN_CD_IN_CAH_CHECK_SUI
        do Find-Wage-Plan-Cd-Check
      #endif
     end-if
    #else
     if ($State_Trimmed = 'CA') AND ($Class_trimmed = 'U')
      do Find-Wage-Plan-Cd
     end-if
    #endif
 
   #endif
 
 
 
    #ifdef VT_HEALTH_INSURANCE_INDICATOR   !This logic added 5/16/07 DMonroe
 
      let $Health_insurance_indicator = ' '  !Clear for non VTU's
 
      if ($State_trimmed = 'VT') AND ($Class_trimmed = 'U')
        let $Health_insurance_indicator = '1'  !default no coverage
 
        #ifdef ALL_VT_HEALTH_COVERED             !TMG added 12/20/2010
          let $Health_insurance_indicator = '3'  !flag all VT employees as covered or eligible
        #else
          let $Health_insurance_indicator = '1'  !default no coverage
          do Get-Associate-Enroll
        #endif
 
        if #TaxBalance_Nlgrs_Qtd <> 0 or #TaxBalance_Txgrs_Qtd <> 0 or #TaxBalance_Tax_Qtd <> 0  !10/7/2011 to not report counts/totals if QTD activity is nil
         if $Health_insurance_indicator <> '1'
          add 1 to #Health_insurance_indicator_covered_company
          add 1 to #Health_insurance_indicator_covered_hash
          add #QTD_Hours_worked to #Health_insurance_indicator_covered_company_qtd_hours
          add #QTD_Hours_worked to #Health_insurance_indicator_covered_hash_qtd_hours
         else
          add 1 to #Health_insurance_indicator_not_covered_company
          add 1 to #Health_insurance_indicator_not_covered_hash
          add #QTD_Hours_worked to #Health_insurance_indicator_not_covered_company_qtd_hours
          add #QTD_Hours_worked to #Health_insurance_indicator_not_covered_hash_qtd_hours
         end-if
        end-if
      end-if
      !-----------------------------------------------------------------------------------------------
    #endif
 
 
    #ifdef BYPASS_PA_LOCALS
     if $State_Trimmed = 'PA' AND $Local_Trimmed <> ''
      let $proceed = 'f'
     end-if
    #endif
 
    let $proceed = 't'
#ifndef SKIP_SUI_SUMMARY
    ! -------------------------------------------------------------
    ! for Gillette, ignore the State Withholding taxes if a 'G' code
    ! is in the Co_State_Tax_Table:Employer_id_swt field
    ! -------------------------------------------------------------
    #ifdef IGNORE_G_CODES
      do SUI-Rate-Lookup
      if ($State_trimmed <> '$U') and  ($Class_trimmed = 'H') and ($Output_Employer_ID_SWT = '"G"')
       let $proceed = 'f'
      end-if
    #endif
#endif
 
    !Exempt Wage calc
    !----------------
    let #Excess_Qtd = 0 !#TaxBalance_Nlgrs_Qtd - #TaxBalance_Txgrs_Qtd
    let #Excess_Ytd = 0 !#TaxBalance_Nlgrs_Ytd - #TaxBalance_Txgrs_Ytd
    if $Calc_Exempt = 'Y'
      if $State_Trimmed = '$U' AND $Class_Trimmed = 'U'              !FUTA
 
         let #Excess_Qtd = #Exempt_QTD_Futa_Earnings + #Exempt_QTD_Futa_Deds
         let #Excess_Ytd = #Exempt_YTD_Futa_Earnings + #Exempt_YTD_Futa_Deds
 
         !FUTA Totals for balancing...
         !-----------------------------
         Add #Excess_Ytd to #Exempt_YTD_Futa_Hash
      end-if
    end-if
 
    do Update-Taxbalance-Recap
 
    let #t = #TaxBalance_Nlgrs_Qtd * 100
    do Format-Number(#t,$TaxBalance_Nlgrs_Qtd, '999999999999999mi')
 
    let #t = #TaxBalance_Txgrs_Qtd * 100
    do Format-Number(#t,$TaxBalance_Txgrs_Qtd, '999999999999999mi')
 
    let #t = #TaxBalance_Tax_Qtd  * 100
    do Format-Number(#t,$TaxBalance_Tax_Qtd,   '999999999999999mi')
 
    let #t = #TaxBalance_Nlgrs_Ytd * 100
    do Format-Number(#t,$TaxBalance_Nlgrs_Ytd, '999999999999999mi')
 
    let #t = #TaxBalance_Txgrs_Ytd * 100
    do Format-Number(#t,$TaxBalance_Txgrs_Ytd, '999999999999999mi')
 
    let #t = #TaxBalance_Tax_Ytd * 100
    do Format-Number(#t,$TaxBalance_Tax_Ytd,   '999999999999999mi')
 
    let #t = #TaxBalance_Tip_Wages_Qtd * 100
    do Format-Number(#t,$TaxBalance_Tip_Wages_Qtd, '999999999999999mi')
 
    let #t = #TaxBalance_Tip_Wages_Ytd * 100
    do Format-Number(#t,$TaxBalance_Tip_Wages_Ytd, '999999999999999mi')
 
    let #t = #TaxBalance_Tip_Tax_Qtd * 100
    do Format-Number(#t,$TaxBalance_Tip_Tax_Qtd, '999999999999999mi')
 
    let #t = #TaxBalance_Tip_Tax_Ytd * 100
    do Format-Number(#t,$TaxBalance_Tip_Tax_Ytd, '999999999999999mi')
 
    let #t = #Excess_Qtd * 100
    do Format-Number(#t,$Excess_Qtd,   '999999999999999mi')
 
    let #t = #Excess_Ytd * 100
    do Format-Number(#t,$Excess_Ytd,   '999999999999999mi')
 
    #ifndef ALLOW_ALL_ZERO_QTD_and_YTDs
     if ( (#TaxBalance_Nlgrs_Qtd = 0) AND
         (#TaxBalance_Txgrs_Qtd = 0) AND
         (#TaxBalance_Tax_Qtd   = 0) AND
         (#TaxBalance_Nlgrs_Ytd = 0) AND
         (#TaxBalance_Txgrs_Ytd = 0) AND
         (#TaxBalance_Tax_Ytd   = 0) )
 
       let $proceed = 'f'
     end-if
    #endif
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Process-Quarterly-Recird(1)' to $debug-proc1
     move ' '    to $debug-table1
     do log-delta-time
 #endif
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move $display_dt to $display_dt0
 #endif
 
 
  if $proceed = 't'
 
   let $repeat_tax = 'f'
   do Write-Quarterly-Record
 
   !we sum these here (not in the Write-Quarterly-Record routine
   !to balance to tax010, which does not include the employer
   !duplications of FICA and tax class B taxes in its totals
   !-------------------------------------------------------------
   Add #TaxBalance_Tax_Qtd to #Company_Total_Tax_Qtd_Not_Generated
   Add #TaxBalance_Tax_Ytd to #Company_Total_Tax_Ytd_Not_Generated
   Add #TaxBalance_Tax_Qtd to #Fein_Total_Tax_Qtd_Not_Generated
   Add #TaxBalance_Tax_Ytd to #Fein_Total_Tax_Ytd_Not_Generated
   Add #TaxBalance_Tax_Ytd to #ADP_Compid_Total_Tax_Ytd_Not_Generated
   Add #TaxBalance_Tax_Qtd to #ADP_Compid_Total_Tax_Qtd_Not_Generated
   Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_Qtd_Not_Generated   !added 9/27/06
   Add #TaxBalance_Tax_Ytd to #Hash_Total_Tax_Ytd_Not_Generated
 
   #ifdef debug_pbz
     #debugd show 'WRITING, #TaxBalance_Tip_Tax_Qtd = ' #TaxBalance_Tip_Tax_Qtd
   #endif
 
   ! ----------------------------------------------------------------------------
   ! Following is added to create records for employer contributions.
   ! remove comments if needed (if client has not elected within Peoplesoft to
   ! keep track seperately of employer contribs for SS)
   ! ----------------------------------------------------------------------------
 
    !Medicare   ($UF)
    !--------
    #if {DUP_UF} = 't'
     if rtrim($Output_TaxCode,' ') = '{UF_EE_TAXCODE}'
        Let $Output_TaxCode  = rpad('{UF_ER_TAXCODE}',15,' ')
        do Repeat-Quarterly-Record
      end-if
    #endif
 
    !Social Security  ($UD)
    !----------------
    #if {DUP_UD} = 't'
     if rtrim($Output_TaxCode,' ') = '{UD_EE_TAXCODE}'
        Let $Output_TaxCode  = rpad('{UD_ER_TAXCODE}',15,' ')
        do Repeat-Quarterly-Record
     end-if
    #endif
 
    !PR SDI (PRD) - this section added 4/3/00
    !----------------------------------------
    #if {DUP_PRD} = 't'
     if rtrim($Output_TaxCode,' ') = '{PRD_EE_TAXCODE}'
        Let $Output_TaxCode  = rpad('{PRD_ER_TAXCODE}',15,' ')
        do Repeat-Quarterly-Record
 
        Add #TaxBalance_Tax_Qtd to #Company_Total_Tax_Qtd_PRE_Generated  !5/16/00
        Add #TaxBalance_Tax_Qtd to #Fein_Total_Tax_Qtd_PRE_Generated     !5/16/00
        Add #TaxBalance_Tax_Qtd to #ADP_Compid_Total_Tax_Qtd_PRE_Generated     !5/16/00
        Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_Qtd_PRE_Generated     !5/16/00
 
        Add #TaxBalance_Tax_Ytd to #Company_Total_Tax_Ytd_PRE_Generated  ! added 12/13/00
        Add #TaxBalance_Tax_Ytd to #Fein_Total_Tax_Ytd_PRE_Generated     !5/16/00
        Add #TaxBalance_Tax_Ytd to #ADP_Compid_Total_Tax_Ytd_PRE_Generated     !5/16/00
        Add #TaxBalance_Tax_Ytd to #Hash_Total_Tax_Ytd_PRE_Generated     ! added 12/13/00
 
     end-if
    #endif
 
    !Tax_Class 'B'  (Both EE and ER)
    !-------------------------------
     #if {DUP_B} = 't'
     if (rtrim($TaxBalance_Tax_Class,' ') = 'B')
 
       let $RTaxCode = rtrim(substr($Output_TaxCode,1,12),' ')        !8/13/98
       let $OTaxCode = $RTaxCode || 'ER'
       Let $Output_TaxCode  = rpad($OTaxCode,14,' ') || $Resident     !8/13/98
 
       #ifdef WORKERS_COMP_ENABLE_TABLE
         #ifdef WA_WORKERS_COMP_ENABLE  !20121107
          let $local_Trimmed = $local_Trimmed || 'ER'
          do Retrieve-Workers-Comp-Data  !see if this is W/Comp data from our custom table... to pull in the code, and rate
        #endif
       #endif
 
       do Repeat-Quarterly-Record
 
     end-if
 
    #endif
 
   ! CSX specific Tier #2 railroad taxes
   ! -----------------------------------
   #if {SITE_ID} = 'CSX1'
    let #CSX_Tier2_conversion = {CSX_Tier2_conversion_const}
    #if {DUP_Tier2_RR} = 't'
      #if {Peoplesoft_Version} >= '7.5'
       if $Output_TaxCode       = '$UI            '!Employee Tier #2 retirement pension
      #else
       if $Output_TaxCode       = '$UX            '
      #endif
 
      Let $Output_TaxCode  = 'TIER2C         '  !generate the employer
      let #TaxBalance_Nlgrs_Qtd = #TaxBalance_Nlgrs_Qtd * #CSX_Tier2_conversion
      let #TaxBalance_Txgrs_Qtd = #TaxBalance_Txgrs_Qtd * #CSX_Tier2_conversion
      let #TaxBalance_Tax_Qtd   = #TaxBalance_Tax_Qtd   * #CSX_Tier2_conversion
      let #TaxBalance_Nlgrs_Ytd = #TaxBalance_Nlgrs_Ytd * #CSX_Tier2_conversion
      let #TaxBalance_Txgrs_Ytd = #TaxBalance_Txgrs_Ytd * #CSX_Tier2_conversion
      let #TaxBalance_Tax_Ytd   = #TaxBalance_Tax_Ytd   * #CSX_Tier2_conversion
      let #TaxBalance_Nlgrs_Cur = #TaxBalance_Nlgrs_Cur * #CSX_Tier2_conversion
      let #Excess_Qtd = 0  !#Excess_Qtd * #CSX_Tier2_conversion    7/27/01 set excess to 0
      let #Excess_Ytd = 0  !#Excess_Ytd * #CSX_Tier2_conversion    7/27/01 set excess to 0
 
      let #t =  #TaxBalance_Nlgrs_Qtd * 100
      do Format-Number(#t,$TaxBalance_Nlgrs_Qtd, '999999999999999mi')
 
      let #t =  #TaxBalance_Txgrs_Qtd * 100
      do Format-Number(#t,$TaxBalance_Txgrs_Qtd, '999999999999999mi')
 
      let #t =  #TaxBalance_Tax_Qtd * 100
      do Format-Number(#t,$TaxBalance_Tax_Qtd,   '999999999999999mi')
 
      let #t = #TaxBalance_Nlgrs_Ytd * 100
      do Format-Number(#t,$TaxBalance_Nlgrs_Ytd, '999999999999999mi')
 
      let #t =  #TaxBalance_Txgrs_Ytd * 100
      do Format-Number(#t,$TaxBalance_Txgrs_Ytd, '999999999999999mi')
 
      let #t =  #TaxBalance_Tax_Ytd * 100
      do Format-Number(#t,$TaxBalance_Tax_Ytd,   '999999999999999mi')
 
      let #t =  #Excess_Qtd * 100
      do Format-Number(#t,$Excess_Qtd,   '999999999999999mi')
 
      let #t =  #Excess_Ytd * 100
      do Format-Number(#t,$Excess_Ytd,   '999999999999999mi')
 
      do Repeat-Quarterly-Record
 
    end-if
   #endif
 
   #if {DUP_Tier1_Med} = 't'
    if rtrim($Output_TaxCode,' ') = '{EE_Tier1_MED}'       !Employee Tier #1 medicare
      Let $Output_TaxCode  = 'TIER1MEDC      '             !generate the employer contrib here
      do Repeat-Quarterly-Record
    end-if
   #endif
 
   #if {DUP_Tier1_SS} = 't'
    if rtrim($Output_TaxCode,' ') = '{EE_Tier1_SS}'       !Employee Tier #1 soc sec.
     if #RptYear = 2011 or #RptYear = 2012  !Payroll Tax holiday
        let #TaxBalance_Tax_Qtd   = #TaxBalance_Txgrs_Qtd   *  0.062   !for 2010 EE is 4.2%, ER is 6.2%
        let #TaxBalance_Tax_Ytd   = #TaxBalance_Txgr_Ytd    *  0.062
        let #t =  #TaxBalance_Tax_Qtd * 100
        do Format-Number(#t,$TaxBalance_Tax_Qtd,   '999999999999999mi')
        let #t =  #TaxBalance_Tax_Ytd * 100
        do Format-Number(#t,$TaxBalance_Tax_Ytd,   '999999999999999mi')
     end-if
     Let $Output_TaxCode  = 'TIER1SDIC      '           !generate the employer contrib here
     do Repeat-Quarterly-Record
    end-if
   #endif
  #endif       ! CSX (Railroad specific tax codes)
 
   else
    let #Ignore_Tax_Qtd = #Ignore_Tax_Qtd + #TaxBalance_Tax_Qtd
    let #Ignore_Tax_Ytd = #Ignore_Tax_Ytd + #TaxBalance_Tax_Ytd
    let #Hash_Ignore_Tax_Qtd = #Hash_Ignore_Tax_Qtd + #TaxBalance_Tax_Qtd
    let #Hash_Ignore_Tax_Ytd = #Hash_Ignore_Tax_Ytd + #TaxBalance_Tax_Ytd
 
   end-if
 
  end-if  !state = '--'
 
zero_wage_tax:
 
 
 
end-while
 
 !Write all W-2 Box Records for Q4
 !----------------------------------
 #if {Quarterly_extract_specs} >= '3.00'
  if $adp_format = 't' and $adp_w2_records = 't'
   if $misc_box_only = 'y'                       !S.Edwards 08/06/2004
      if $first_tax_for_emplid = 't'
        do write-employee-rec
        let $first_tax_for_emplid = 'f'
      end-if
   end-if
 
   if rtrim($check-for-void-w2,' ') <> 't'
 
     do write-misc-box-records
     #ifndef ADP_TAX_AMEND
       #ifdef Process_1099s
         do Read-Employee-Data-1099s
       #endif
     #endif
   end-if
 
  end-if
 #endif
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Process-Quarterly-Record(2)' to $debug-proc1
    move ' '    to $debug-table1
    do log-delta-time
 #endif
 
end-procedure
 
begin-procedure Wyoming-rate-data
     #ifdef US_SOC_CD_for_RATE
        if ($State_trimmed = 'WY') and ($Local_Trimmed <> '') and ($class_trimmed = 'R')
         let $get_local_rate = $Local_Trimmed
         do get-local-rate
         let $wc_code = substr($Local_trimmed,5,6)  !this is unique for GE now ccccllllll is the local code
        end-if                                         !and it is made up of 'compid' || 'SOCcd'
     #else
        if ($State_trimmed = 'WY') and ($Local_Trimmed = '{WY_WORKERS_COMP_CD}')
         let $get_local_rate = $Local_Trimmed
         do get-local-rate
        end-if
     #endif
end-procedure
 
#ifdef WA_WORKERS_COMP_ENABLE
begin-procedure Washington-rate-data
 
      #ifdef WORKERS_COMP_ENABLE_TABLE_WA  !added 10/6/2011 to overwrite the $wc_code from our TF_ADP_WC_TBL if required - WA only for now
        #ifdef WORKERS_COMP_ENABLE_TABLE
         do Retrieve-Workers-Comp-Data  !see if this is W/Comp data from our custom table... to pull in the code, and rate
        #endif
      #else
        if ($State_trimmed = '{WA_STATE}') and ($Local_Trimmed = '{WA_WORKERS_COMP_CD}' or $Local_Trimmed = '{WA_WORKERS_COMP_CD_ER}')
         let $get_local_rate = $Local_Trimmed
         do get-local-rate
        end-if
      #endif
 
end-procedure
#endif
 
#ifdef WORKERS_COMP_ENABLE_TABLE
begin-procedure Retrieve-Workers-Comp-Data   !for WA now... could be used for generic Workers comp needs to retrieve the W/C code.  The rate still comes from local tax table
                                             !if the code is blank, we'll use the default $wc_code, so this would suffice as a placeholder to tell us this is a WA W/C code
 
  if $SelectEmplid <> ''
     show 'Retrieve-Workers-Comp-Data: looking for W/C data in: ' $Current_Company ' ' $State_trimmed $Class_Trimmed $Local_trimmed ' thru ' $Qtr_End_Native ' default code ' $wc_code
  end-if
 
  #ifdef WORKERS_COMP_TABLE_VIA_US_SOC_CD
   let $wc_code_perc = $wc_code || '%'
   if $SelectEmplid <> ''
     show 'Retrieve-Workers-Comp-Data: WORKERS_COMP_TABLE_VIA_US_SOC_CD: pulling in W/C code values like ' $wc_code_perc
   end-if
  #endif
 
    let $wc_code_table = ''
    let #wc_rate_table = 0
    let $wc_rate_table = ''
 
begin-select
WKCMP.US_SOC_CD
WKCMP.EFFDT
WKCMP.LOCALITY
WKCMP.RESIDENT_TAX_RT
 
  if $SelectEmplid <> ''
      show 'Retrieve-Workers-Comp-Data: W/C data found.   &WKCMP.US_SOC_CD = ' &WKCMP.US_SOC_CD ', Locality = ' &WKCMP.LOCALITY ' on ' &WKCMP.EFFDT ' rt ' &WKCMP.RESIDENT_TAX_RT
  end-if
 
  let $WC_Locality = $Local_Trimmed
 
  #ifndef WORKERS_COMP_TABLE_VIA_US_SOC_CD
   if rtrim(&WKCMP.US_SOC_CD,' ') <> ''
    let $wc_code = rtrim(&WKCMP.US_SOC_CD,' ')
    if $SelectEmplid <> ''
        show 'Retrieve-Workers-Comp-Data: Code and Rate from Table: ' &WKCMP.US_SOC_CD ' ' &WKCMP.RESIDENT_TAX_RT
    end-if
   end-if
  #endif
 
  if rtrim(&WKCMP.US_SOC_CD,' ') <> ''
    let $wc_code = rtrim(&WKCMP.US_SOC_CD,' ')
    if $SelectEmplid <> ''
        show 'Retrieve-Workers-Comp-Data: W/C CODE = ' $wc_code
    end-if
  end-if
 
  if &WKCMP.RESIDENT_TAX_RT = 0
    let $get_local_rate = $Local_Trimmed
    do get-local-rate
  else
     let #wc_rate = &WKCMP.RESIDENT_TAX_RT
     let #t = #wc_rate * {WC_RATE_FACTOR}                !eg. .017 should be reported as '000017000', .0046 as '0000004600'
     do Format-Number(#t,$wc_rate,  '9999999999')
  end-if
  if $SelectEmplid <> ''
      show 'Retrieve-Workers-Comp-Data: W/C RATE = ' $wc_rate
  end-if
 
  let $replaced = replace($wc_code, '-','')
  let $wc_code  = replace($replaced, '.00','')
 
  let $wc_code_table = $wc_code
  let #wc_rate_table = #wc_rate
  let $wc_rate_table = $wc_rate
 
  if $SelectEmplid <> ''
      show 'Retrieve-Workers-Comp-Data: Corrected W/C CODE ($wc_code_table) = ' $wc_code_table ', rate ($wc_rate_table) = ' $wc_rate_table
  end-if
 
  from PS_{Client_Table_Prefix}ADP_WC_TBL{Client_Table_Suffix} WKCMP
    WHERE WKCMP.COMPANY   = $Current_Company
     AND  WKCMP.STATE     = $State_Trimmed
     AND  WKCMP.TAX_CLASS = $Class_Trimmed
 
     #ifdef WORKERS_COMP_TABLE_VIA_US_SOC_CD
     AND  WKCMP.LOCALITY  like $wc_code_perc
     #else
     AND  WKCMP.LOCALITY  = $Local_Trimmed
     #endif
 
     AND  WKCMP.EFFDT = (SELECT MAX(EFFDT)
       FROM   PS_{Client_Table_Prefix}ADP_WC_TBL{Client_Table_Suffix} WKCMP1
       WHERE  WKCMP1.STATE     = WKCMP.STATE
         AND  WKCMP1.TAX_CLASS = WKCMP.TAX_CLASS
         AND  WKCMP1.LOCALITY  = WKCMP.LOCALITY
         AND  WKCMP1.COMPANY   = WKCMP.COMPANY
         AND  WKCMP1.EFFDT    <= $Qtr_End_Native)
 
     AND  WKCMP.EFF_STATUS = 'A'
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  if substr($wc_code_table,3,1) = '-'
    let $wc_code_table  = substr($wc_code_table,1,2) || substr($wc_code_table,4,4)  !skip the '-'
  else
    let $wc_code_table  = $wc_code
  end-if
  let $wc_code_table  = lpad($wc_code_table,6,'0')
 
  if $SelectEmplid <> ''
      show 'Retrieve-Workers-Comp-Data Complete: Code ($wc_code_table) = ' $wc_code_table ', rate ($wc_rate_table) = ' $wc_rate_table
  end-if
 
 
end-procedure
#endif
 
!************************************************************************
 
!----------------------------------------------------------------------!
! Procedure: Repeat-Quarterly-Record                                   !
! Desc:      This repeats the quarterly records out to 'quarter.dat'   !
!            (needed with certain tax codes which are kept track of    !
!             internally within Peoplesoft as employee contrib only    !
!                                                                      !
!----------------------------------------------------------------------!
begin-procedure Repeat-Quarterly-Record
 
    Add #TaxBalance_Tax_Qtd to #Generated_Taxes_Qtd
    Add #TaxBalance_Tax_Qtd to #Company_Generated_Taxes_Qtd
    Add #TaxBalance_Tax_Ytd to #Generated_Taxes_Ytd
    Add #TaxBalance_Tax_Ytd to #Company_Generated_Taxes_Ytd
    let $repeat_tax = 't'
    do Write-Quarterly-Record
 
end-procedure
 
#ifdef WORKSITE_REPORTING
#ifdef STANDARD_HOME_INTL_LOGIC
begin-procedure get-worksite-abbrv  !set $LocationAbbrv
 
        move ' ' to $LocationAbbrv
        move ' ' to $LocationState
        move ' ' to $LocationCountry
 
        #ifdef USE_ESTABID
         do Get-Estabid-Name
        #else
         #ifdef USE_LOCATION_CD
          let $Location = $worksite_cd
          let $Setid = $Setid_loc
          do Get-Location-Name
         #else
          #ifndef USE_DEPTID_FOR_WORKSITE
            let $TaxLocationCd = $worksite_cd
            do Get-Tax-Location-Name
          #else
            let $DeptidCd = $worksite_cd
            #if {SITE_ID} <> 'WFG1'
              do Get-Deptid-Name
            #endif
          #endif
         #endif
        #endif
 
        #ifdef STANDARD_HOME_INTL_TAX_LOC2_STATE
          do Get-Tax-Location2-state
        #endif
        
        let $state_MWR = rtrim($LocationState,' ')
        let $Country   = rtrim($LocationCountry,' ')
 
        if $SelectEmplid <> ''
         show 'get-worksite-abbrv: ' $LocationAbbrv ' for worksite ' $worksite_cd ' state ' $LocationState ' country ' $Country
        end-if
 
end-procedure

#ifdef STANDARD_HOME_INTL_TAX_LOC2_STATE
begin-procedure Get-Tax-Location2-state

begin-SELECT
ZZ2.STATE

   let $LocationState      = rtrim(&ZZ2.STATE, ' ')

   FROM  PS_TAX_LOCATION2  ZZ2
    WHERE ZZ2.TAX_LOCATION_CD    = $worksite_cd
    
end-SELECT

        if $SelectEmplid <> ''
          show 'Get-Tax-Location2-state: for worksite ' $worksite_cd ' state ' $LocationState 
        end-if

end-procedure
#endif
#endif
#endif
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Write-Quarterly-Record                                    !
! Desc:      This procedure writes the  quarterly record               !
!                                                                      !
!----------------------------------------------------------------------!
 
begin-procedure Write-Quarterly-Record
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
   let $Proceed_with_output = 'T'
 
   if ($RptQtr = '4')
     let $W2 = 'Y'
   else
     let $W2 = 'N'
   end-if
 
   if ( (#TaxBalance_Txgrs_Qtd > 0) OR (#TaxBalance_Nlgrs_Qtd > 0) OR (#TaxBalance_Tax_Qtd > 0) OR
        ($Month1_Worked = 'Y') OR ($Month2_Worked = 'Y') OR ($Month3_Worked = 'Y') )
     let $Worked_in_Qtr = 'Y'
   else
     let $Worked_in_Qtr = 'N'
   end-if
 
   Let $Current_Paygroup = rpad($Current_Paygroup,10,' ')
 
   uppercase $Current_Company
 
   #ifndef PAYGROUP_ROLLUP
     uppercase $Current_Paygroup
   #else
     move $space10 to $Current_Paygroup
   #endif
 
   move ' ' to $worksite_into_extract
   if ($State_trimmed <> '$U') and ($Class_trimmed = 'U')
    let $STANDARD_HOME_INTL_LOGIC = 'f'
    #ifdef WORKSITE_REPORTING
      #ifdef STANDARD_HOME_INTL_LOGIC
       if $state_trimmed <> 'IA' and $state_trimmed <> 'MA' and $state_trimmed <> 'MI' and $state_trimmed <> 'MN' and $state_trimmed <> 'NM' and $state_trimmed <> 'AK'
        do get-worksite-abbrv
        move $worksite_cd to $w_orig
        if {MWR_STATE_WIDE_WORKSITE_CRITERIA}
         let $Company = $Current_Company
         let $state = $State_Trimmed
         do get-state-tax-data
         let $worksite_cd = $State_trimmed || '-' || 'HOME'
         let $STANDARD_HOME_INTL_LOGIC = 't'
        else
         if {MWR_FOREIGN_WORKSITE_CRITERIA}
          let $Company = $Current_Company
          let $state = $State_Trimmed
          do get-state-tax-data
          let $worksite_cd = $State_trimmed || '-' || 'INTL'
          let $STANDARD_HOME_INTL_LOGIC = 't'
         end-if
        end-if
 
        if $SelectEmplid <> ''
         show 'STANDARD_HOME_INTL_LOGIC? ' $STANDARD_HOME_INTL_LOGIC ' ' $State_trimmed $Class_trimmed ', ShortDesc: ' $LocationAbbrv ' original worksite ' $w_orig ' new worksite ' $worksite_cd
        end-if
       end-if
      #endif
      move $worksite_cd to $worksite_into_extract
    #endif
   end-if
 
#ifndef SKIP_SUI_SUMMARY
   !Handle SUI totaling, and Worksite processing
   !--------------------------------------------
   move ' ' to $UiRptCode_into_extract
 
   if ($State_trimmed <> '$U') and ($Class_trimmed = 'U')
    if rtrim($worksite_cd,' ') = ''
      #ifndef SKIP_TAX_AND_WAGE_AUDITS
       let $message = 'Blank Worksite'
       do log-audit
      #endif
    end-if
 
    if (#TaxBalance_Nlgrs_Qtd > 0)   OR                           !This is in question, we may only
       (#TaxBalance_Tax_Qtd   > 0)   OR                           !want to write to the SUI Summary if Gross > 0
       (#TaxBalance_Txgrs_Qtd > 0)                                !????????????????????????????????????????????????
 
     !SUI Totals by worksite
     !----------------------
     move $worksite_cd to $worksite_into_extract
 
     let $worksite_into_extract_trimmed = rtrim($worksite_into_extract,' ')
 
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
       let $Current_ADP_CompID_trimmed = rtrim($Current_ADP_CompID,' ')
     #else
       let $Current_Company_trimmed    = rtrim($Current_Company,' ')
     #endif
 
      if $Month1_Worked = 'Y'
        let #Mth1 = 1
      else
        let #Mth1 = 0
      end-if
      if $Month2_Worked = 'Y'
        let #Mth2 = 1
      else
        let #Mth2 = 0
      end-if
      if $Month3_Worked = 'Y'
        let #Mth3 = 1
      else
        let #Mth3 = 0
      end-if
      if $Worked_in_Qtr = 'Y'
        let #Work = 1
      else
        let #Work = 0
      end-if
 
 
     let #inx = #sui_count - 1   !changed this loop on 2/22/10 to speed it up.. going backwards through the array makes more sense.
     let #loc_exists = 0
 
     while (#inx >= 0)
        get $c -
            $s -
            $w -
            from SUI_Locations(#inx) -
            Company -
            State   -
            Worksite
 
        #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
         if ($c = $Current_ADP_CompID_trimmed)  AND ($s = $State_trimmed) AND ($w = $worksite_into_extract_trimmed)
        #else
         if ($c = $Current_Company_trimmed)  AND ($s = $State_trimmed) AND ($w = $worksite_into_extract_trimmed)
        #endif
 
        let #loc_exists = 1
        let #inx_exists = #inx
        break
       end-if
 
       let #inx = #inx - 1
     end-while
 
     if #loc_exists = 1
 
      array-add #TaxBalance_Nlgrs_Qtd -
      		#TaxBalance_Txgrs_Qtd -
      		#TaxBalance_Tax_Qtd   -
      		#QTD_Hours_worked     -
      		#Mth1 -
      		#Mth2 -
      		#Mth3 -
                #QTD_Weeks_Worked -
                #Work -
         to  SUI_Locations(#inx_exists) -
                Gross    -
                Taxable  -
                Taxes    -
                QTD_Hours -
                Month1    -
                Month2    -
                Month3    -
                Weeks     -
                Worked_in_Qtr
 
     end-if
 
     if (#loc_exists = 0)
      if (#sui_count < {SUI_LOCATIONS_LIMIT})
 
         #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
           put $Current_ADP_CompID_trimmed      into SUI_Locations(#sui_count) Company
         #else
           put $Current_Company_trimmed         into SUI_Locations(#sui_count) Company
         #endif
 
         put $State_trimmed -
             $worksite_into_extract_trimmed -
             #Output_SUI_Rate -
             into SUI_Locations(#sui_count) -
                State -
                Worksite -
                Rate
 
         array-add #TaxBalance_Nlgrs_Qtd -
      		#TaxBalance_Txgrs_Qtd -
      		#TaxBalance_Tax_Qtd   -
      		#QTD_Hours_worked     -
      		#Mth1 -
      		#Mth2 -
      		#Mth3 -
      		#QTD_Weeks_Worked -
      		#Work -
         to  SUI_Locations(#sui_count) -
                Gross    -
                Taxable  -
                Taxes    -
                QTD_Hours -
                Month1    -
                Month2    -
                Month3    -
                Weeks     -
                Worked_in_Qtr
 
 
         add 1 to #sui_count
      else
        #debugd show 'ERROR: SUI_LOCATIONS_LIMIT needs to be increased from {SUI_LOCATIONS_LIMIT}.  Stopping'
        stop
      end-if
 
     end-if
 
    else
      add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Neg_Nlgrs_SUI_Qtd
    end-if      !  if #TaxBalance_Nlgrs_Qtd > 0
   end-if      !  if SUI
#endif
 
 
   !keep track of total federal excise taxes, as tax010 does not
   !------------------------------------------------------------
   if $State_trimmed = '$U' and $Class_trimmed = 'K'          ! Federal Excise
      Add #TaxBalance_Tax_Qtd to #Hash_Total_Excise_Qtd
      Add #TaxBalance_Tax_Ytd to #Hash_Total_Excise_Ytd
   end-if
 
   !4/29/99 Added for Albemarle to remap APT --> ALB
   !------------------------------------------------
   move $Current_Company to $Output_Company
   #if {SITE_ID} = 'ALB1'
       if rtrim($Current_Company,' ') = 'APT'
         move 'ALB1' to $Output_Company
       end-if
   #endif
 
   !don't pass PA-OPT for QTD=0 if prior to 2006 (this is for prior year amendments).. code added 7/23/08
   !-----------------------------------------------------------------------------------------------------
   #ifdef BYPASS_ZERO_OPT_PRIOR_TO_2006
    if #RptYear < 2006
     if ($Class_Trimmed = 'P') AND ($State_trimmed = 'PA') AND ($Local_trimmed <> '') AND (#TaxBalance_Tax_Qtd = 0)
      let $Proceed_with_output = 'F'
     end-if
    end-if
   #endif
   !-----------------------------------------------------------------------------------------------------
 
  #ifdef show_selects
   #debugd show 'Write-Quarterly-Record...$Proceed_with_output ' $Proceed_with_output
  #endif
 
   if $Proceed_with_output = 'T'
 
    !Local Totals
    !-------------
#ifndef STRIPPED_PBZQTR_REPORT
    if ($State_trimmed <> '$U') and ($State_trimmed <> 'FO') and ($Local_trimmed <> '')
 
     if (#TaxBalance_Nlgrs_Qtd <> 0)   OR
        (#TaxBalance_Tax_Qtd   <> 0)   OR
        (#TaxBalance_Txgrs_Qtd <> 0)   OR ($adp_w2_records = 't') !   changed 2/3/04 from ($RptQtr = '4')
 
     let #inx = 0
     let #loc_exists = 0
     while (#inx < #local_count)
 
        get $s -
            $l -
            $r -
        from local_Locations(#inx) -
            State    -
            Locality -
            Resident
 
        if ($s = $State_trimmed) AND ($l = $Local_trimmed)  AND ($r = $resident)
           let #loc_exists = 1
           break
        end-if
        add 1 to #inx
     end-while
 
     array-add #TaxBalance_Nlgrs_Qtd -
               #TaxBalance_Txgrs_Qtd -
               #TaxBalance_Tax_Qtd   -
       to  local_Locations(#inx)     -
               Gross -
               Taxable -
               Taxes
 
     if (#loc_exists = 0) and (#local_count < {LOCAL_LOCATIONS_LIMIT})
         put $State_trimmed           into local_Locations(#local_count) State
         put $Local_trimmed           into local_Locations(#local_count) Locality
         put $resident                into local_Locations(#local_count) Resident
         add 1 to #local_count
     end-if
 
    end-if      !  if #TaxBalance_Nlgrs_Qtd > 0
   end-if      !  if Local
#endif
 
   Add #TaxBalance_Tip_Tax_Qtd   to #Hash_Total_Tip_Tax_Qtd                           ! tips
   Add #TaxBalance_Tip_Tax_Qtd   to #Company_Total_Tip_Tax_Qtd
   Add #TaxBalance_Tip_Tax_Ytd   to #Hash_Total_Tip_Tax_Ytd
   Add #TaxBalance_Tip_Tax_Ytd   to #Company_Total_Tip_Tax_Ytd
 
   Add #TaxBalance_Tax_Qtd       to #Company_Total_Tax_Qtd
   Add #TaxBalance_Tax_Qtd       to #Fein_Total_Tax_Qtd
   Add #TaxBalance_Tax_Qtd       to #ADP_Compid_Total_Tax_Qtd
   Add #TaxBalance_Tax_Qtd       to #Hash_Total_Tax_Qtd
   Add #TaxBalance_Tax_Ytd       to #Company_Total_Tax_Ytd
   Add #TaxBalance_Tax_Ytd       to #Fein_Total_Tax_Ytd
   Add #TaxBalance_Tax_Ytd       to #ADP_Compid_Total_Tax_Ytd
   Add #TaxBalance_Tax_Ytd       to #Hash_Total_Tax_Ytd
 
   !added 8/9/07
   !------------
   Add #TaxBalance_Txgrs_Qtd       to #ADP_Compid_Total_Txgrs_Qtd
   Add #TaxBalance_Nlgrs_Qtd       to #ADP_Compid_Total_Nlgrs_Qtd
   Add #TaxBalance_Txgrs_Ytd       to #ADP_Compid_Total_Txgrs_Ytd
   Add #TaxBalance_Nlgrs_Ytd       to #ADP_Compid_Total_Nlgrs_Ytd
 
   let $classified = 'f'
 
   !Federal totals -------------------
 
   !added 9/27/06 to clasify FED Forms 945, 943, and 1042 as FEDERAL not LOCAL
   !--------------------------------------------------------------------------
   if (rtrim($Output_TaxCode,' ') = '{FORM945P_Taxcode}') OR
      (rtrim($Output_TaxCode,' ') = '{FORM1042_Taxcode}') OR
      (rtrim($Output_TaxCode,' ') = '{FORM943_Taxcode}')
 
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_FIT_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_FIT_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_FIT_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_FIT_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_FIT_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_FIT_Ytd
     let $classified = 't'
     goto done_classifactions
   end-if
 
   if $State_trimmed = '$U'                                                           ! Fed
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_Federal_Qtd
 
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_Federal_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_Federal_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_Federal_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_Federal_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_Federal_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_Federal_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = 'H' and $Local_trimmed = ''         ! FIT
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_FIT_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_FIT_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_FIT_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_FIT_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_FIT_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_FIT_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = 'C' and $Local_trimmed = ''         ! EIC
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_EIC_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_EIC_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_EIC_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_EIC_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_EIC_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_EIC_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = 'D' and $Local_trimmed = ''         ! OASDI-EE
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_OASDIEE_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_OASDIEE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_OASDIEE_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_OASDIEE_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_OASDIEE_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_OASDIEE_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = 'E' and $Local_trimmed = ''         ! OASDI-ER
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_OASDIER_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_OASDIER_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_OASDIER_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_OASDIER_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_OASDIER_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_OASDIER_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = 'F' and $Local_trimmed = ''         ! MED-EE
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_MEDEE_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_MEDEE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_MEDEE_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_MEDEE_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_MEDEE_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_MEDEE_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = '7' and $Local_trimmed = ''         ! MEDEE-SUR
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_MEDEE_SUR_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_MEDEE_SUR_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_MEDEE_SUR_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_MEDEE_SUR_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_MEDEE_SUR_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_MEDEE_SUR_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' and $Class_trimmed = 'Q' and $Local_trimmed = ''         ! MED-ER
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_MEDER_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_MEDER_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_MEDER_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_MEDER_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_MEDER_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_MEDER_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed = '$U' AND $Class_trimmed = 'U' and $Local_trimmed = ''         ! FUTA
 
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_FUTA_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_FUTA_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_FUTA_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_FUTA_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_FUTA_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_FUTA_Ytd
 
     Add #TaxBalance_Txgrs_YTD to #Hash_Total_Txgrs_Futa  !for calcing FUTA exempt...
     Add #TaxBalance_Nlgrs_YTD to #Hash_Total_Nlgrs_Futa
     let $classified = 't'
   end-if
 
   !-----------------------------
 
   if $State_trimmed <> '$U' and $Class_trimmed = 'H' and $Local_trimmed = ''         ! SIT
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_SIT_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_SIT_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_SIT_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_SIT_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_SIT_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_SIT_Ytd
 
     Add #TaxBalance_Tax_Qtd to #Company_Total_Tax_SIT_Qtd
     Add #TaxBalance_Tax_Ytd to #Company_Total_Tax_SIT_Ytd
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' and $Class_trimmed = 'U'       ! SUI
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_SUI_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_SUI_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_SUI_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_SUI_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_SUI_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_SUI_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_SUI_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_SUI_Qtd
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' and $Class_trimmed = 'S'       ! SUI-Spcl
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_SPCL_SUI_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_SPCL_SUI_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_SPCL_SUI_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_SPCL_SUI_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_SPCL_SUI_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_SPCL_SUI_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_SPCL_SUI_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_SPCL_SUI_Qtd
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' and $Class_trimmed = 'V'                                 ! SUI-EE
     Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_SUI_EE_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_SUI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_SUI_EE_Qtd
     Add #TaxBalance_Tax_Ytd to #Hash_Total_Tax_SUI_EE_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_SUI_EE_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_SUI_EE_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_SUI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_SUI_EE_Qtd
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' AND $Class_trimmed = 'D'                                  ! SDI-EE
     Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_SDI_EE_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_SDI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_SDI_EE_Qtd
     Add #TaxBalance_Tax_Ytd to #Hash_Total_Tax_SDI_EE_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_SDI_EE_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_SDI_EE_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_SDI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_SDI_EE_Qtd
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' AND $Class_trimmed = 'E'                                  ! SDI-ER
     Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_SDI_ER_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_SDI_ER_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_SDI_ER_Qtd
     Add #TaxBalance_Tax_Ytd to #Hash_Total_Tax_SDI_ER_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_SDI_ER_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_SDI_ER_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_SDI_ER_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_SDI_ER_Qtd
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' and  $Local_trimmed <> ''                                 ! Local
     Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_Local_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_Local_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_Local_Qtd
     Add #TaxBalance_Tax_Ytd to #Hash_Total_Tax_Local_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_Local_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_Local_Ytd
     Add #TaxBalance_Tax_Qtd to #Company_Total_Tax_Local_Qtd
     let $classified = 't'
   end-if
 
   !12/11/08 - FLI-EE (tax class I) and VFLI-EE (tax class O), Vol FLI/ER (tax class Y)
   if $State_trimmed = 'NJ' AND $Class_trimmed = 'I'                                  ! FLI-EE
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_FLI_EE_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_FLI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_FLI_EE_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_FLI_EE_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_FLI_EE_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_FLI_EE_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_FLI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_FLI_EE_Qtd
 
     let $classified = 't'
   end-if
   if $State_trimmed = 'NJ' AND $Class_trimmed = 'O'                                  ! VFLI-EE
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_VFLI_EE_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_VFLI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_VFLI_EE_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_VFLI_EE_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_VFLI_EE_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_VFLI_EE_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_VFLI_EE_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_VFLI_EE_Qtd
 
     let $classified = 't'
   end-if
   if $State_trimmed = 'NJ' AND $Class_trimmed = 'Y'                                  ! VFLI-ER
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_VFLI_ER_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_VFLI_ER_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_VFLI_ER_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_VFLI_ER_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_VFLI_ER_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_VFLI_ER_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_VFLI_ER_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_VFLI_ER_Qtd
 
     let $classified = 't'
   end-if
 
   if $State_trimmed = 'NJ' AND $Class_trimmed = 'L'                                  ! NJ-SWAF
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_NJSWAF_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_NJSWAF_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_NJSWAF_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_NJSWAF_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_NJSWAF_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_NJSWAF_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_NJSWAF_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_NJSWAF_Qtd
 
     let $classified = 't'
   end-if
 
   if $State_trimmed = 'NJ' AND $Class_trimmed = 'M'                                  ! NJ-WDPF
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_NJWDPF_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_NJWDPF_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_NJWDPF_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_NJWDPF_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_NJWDPF_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_NJWDPF_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_NJWDPF_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_NJWDPF_Qtd
 
     let $classified = 't'
   end-if
 
   if $State_trimmed = 'NJ' AND $Class_trimmed = 'N'                                  ! NJ-HCSF
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_NJHCSF_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_NJHCSF_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_NJHCSF_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_NJHCSF_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_NJHCSF_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_NJHCSF_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_NJHCSF_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_NJHCSF_Qtd
 
     let $classified = 't'
   end-if
 
   if $State_trimmed <> '$U' and $Class_trimmed = $STATE_FUTA_TAX_CLASS                        ! State Futa, totals tracked in adpstfut.sqc
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_State_FUTA_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_State_FUTA_Ytd
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_State_FUTA_Qtd
     let $classified = 't'
   end-if
 
done_classifactions:
 
   if $classified = 'f'
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_Misc_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_Misc_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_Misc_Qtd
     Add #TaxBalance_Tax_Ytd   to #Hash_Total_Tax_Misc_Ytd
     Add #TaxBalance_Txgrs_Ytd to #Hash_Total_Txgrs_Misc_Ytd
     Add #TaxBalance_Nlgrs_Ytd to #Hash_Total_Nlgrs_Misc_Ytd
 
     Add #TaxBalance_Tax_Qtd   to #Company_Total_Tax_Misc_Qtd
   end-if
 
   if $repeat_tax = 'f'                                                               ! wages
    add #TaxBalance_Txgrs_Qtd to #Company_Total_Txgrs_Qtd
    add #TaxBalance_Nlgrs_Qtd to #Company_Total_Nlgrs_Qtd
    add #TaxBalance_Txgrs_Qtd to #Fein_Total_Txgrs_Qtd
    add #TaxBalance_Nlgrs_Qtd to #Fein_Total_Nlgrs_Qtd
    add #TaxBalance_Txgrs_Qtd to #ADP_CompidTotal_Txgrs_Qtd
    add #TaxBalance_Nlgrs_Qtd to #ADP_CompidTotal_Nlgrs_Qtd
 
    add #TaxBalance_Txgrs_YTD to #Company_Total_Txgrs_YTD
    add #TaxBalance_Nlgrs_YTD to #Company_Total_Nlgrs_YTD
    add #TaxBalance_Txgrs_YTD to #Fein_Total_Txgrs_YTD
    add #TaxBalance_Nlgrs_YTD to #Fein_Total_Nlgrs_YTD
    add #TaxBalance_Txgrs_YTD to #ADP_CompidTotal_Txgrs_YTD
    add #TaxBalance_Nlgrs_YTD to #ADP_CompidTotal_Nlgrs_YTD
 
    Add #TaxBalance_Tip_Wages_Qtd to #Company_Total_Tip_Wages_Qtd
    Add #TaxBalance_Tip_Wages_Ytd to #Company_Total_Tip_Wages_Ytd
   end-if
 
write_rec:
 
 if rtrim($Output_TaxCode,' ') = '{FORM1042_Taxcode}' OR
    rtrim($Output_TaxCode,' ') = '{FORM945P_Taxcode}'
   Add #TaxBalance_Tax_Cur   to #Hash_Total_Tax_Non_941
   Add #TaxBalance_Txgrs_Cur to #Hash_Total_Taxable_Wages_Non_941
   Add #TaxBalance_Tax_Cur   to #Company_Total_Tax_Non_941
   Add #TaxBalance_Txgrs_Cur to #Company_Total_Taxable_Wages_Non_941
   Add #TaxBalance_Tax_Cur   to #Fein_Total_Tax_Non_941
   Add #TaxBalance_Txgrs_Cur to #Fein_Total_Taxable_Wages_Non_941
   Add #TaxBalance_Tax_Cur   to #ADP_CompidTotal_Tax_Non_941
   Add #TaxBalance_Txgrs_Cur to #ADP_CompidTotal_Taxable_Wages_Non_941
 end-if
 
 move $Current_Company to $Company_in_extract
 
 !remap OHU taxes to 'fake' compid 'BOH' for BI ee's in company BI
 !----------------------------------------------------------------
 #ifdef REMAP_OH_SUI_FOR_BRINKER
   if $Current_Company = 'BI' and $State_trimmed = 'OH' and $Class_trimmed = 'U'
     move 'BOH' to $Company_in_extract
     Add #TaxBalance_Tax_Qtd   to #Hash_Total_Tax_OHU_Remapped_Qtd
     Add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_OHU_Remapped_Qtd
     Add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_OHU_Remapped_Qtd
   end-if
 #endif
 
 !9/5/01 added for Albemarle
 !--------------------------
 #ifdef REMAP_APT
  if $Current_Company = 'APT'
    move 'ALB1' to $Company_in_extract
  end-if
 #endif
 
 !Report Iowa Unemployment (IAU) under separate companies instead of using Aon Service Corp. (AON).
 ! This feature requires the re-sorting via USE_TEMP_TABLE_FOR_OUTPUT definition in probiz.sqc
 #if {SITE_ID} = 'AON1'
    if rtrim($Output_TaxCode,' ') = 'IAU' and
       ($Company_in_extract = 'AON' or $Company_in_extract = 'PRC')
       let $first_tax_for_emplid = 't'
       let $Job_Business_Unit    = rtrim($Job_Business_Unit,' ')
       let $Company_in_extract   = substr($Job_Business_Unit,1,3)
    end-if
 #endif
 
 !/***** AON_CUSTOM end   - AEM  268952  10/12/2009 *****/
 
 !added 5/29/01
 !-------------
 if ($Month3_Worked = 'Y') AND ($Emp_Sex = 'F')
   move 'F' to $Emp_Sex_M3
 else
   move ' ' to $Emp_Sex_M3
 end-if
 
 if rtrim($Company_in_extract,' ') = ''
   show 'Blank Compid for Employee ' $Emp_Emplid
 end-if
 
  !---------------------------------------------------------------------------
  ! 4/13/04 - 945 & 1042 & 943 split too, appending 945 or 1042 onto the company codes
  ! ADP can only handle one 'class' / company (941, 945, 1042, RR,...)
  !---------------------------------------------------------------------------
  #ifndef NO_943_945_1042_COMPID_REMAP   !added 12/16/04 for Dow
   let $TestNon941_Append = ''
   if (rtrim($Output_TaxCode,' ') = '{FORM945P_Taxcode}')
    let $TestNon941_Append = '945'
   else
    if (rtrim($Output_TaxCode,' ') = '{FORM1042_Taxcode}')
     let $TestNon941_Append = '1042'
    else
      if (rtrim($Output_TaxCode,' ') = '{FORM943_Taxcode}')
       let $TestNon941_Append = '943'
      end-if
    end-if
   end-if
 
   if rtrim($TestNon941_Append,' ') <> ''
     Let $Extract_compid = $Company_in_extract || $TestNon941_Append || ' ' || $Current_Paygroup
     #debugd show 'Form 945/1042/943 Remapping to company: ' $Extract_compid
     goto done_reestablish_compid
   end-if
  #endif
 
    #if {SITE_ID} = 'PRD1'
      let $Save_Company_in_extract = $Company_in_extract
      let $Save_current_company = $current_company
      if rtrim($Job_Employment_type,' ') = 'A'
        let $Company_in_extract = $Company_in_extract || ' AG'
      end-if
 
      if rtrim($Current_Emplid,' ') = '000101'
        #debugd show '000101  Job_Employment_type ' $Job_Employment_type
        #debugd show '        Company_in_extract  ' $Company_in_extract
      end-if
 
    #endif
 
!   -----------------------------------------------------------------------------------------
!   Mar 15, 2007  TLL1
!      TOLL_FAIRLESS_HILLS_LOCATION    PA0000061   --> TOLL_FAIRLESS_HILLS_COMPID      NGR2
!   -----------------------------------------------------------------------------------------
    #if {SITE_ID} = 'TLL1'
     #ifdef TOLL_FAIRLESS_HILLS_LOCATION
      let $Save_Company_in_extract = $Company_in_extract
      let $Save_current_company = $current_company
      if rtrim($Location,' ') = rtrim('{TOLL_FAIRLESS_HILLS_LOCATION}',' ')
        let $Company_in_extract = $Company_in_extract || ' {TOLL_FAIRLESS_HILLS_COMPID}'
        Add #TaxBalance_Tax_QTD   to #Hash_Total_Tax_NGR2
      end-if
     #endif
    #endif
 
    #if {SITE_ID} = 'CHS1'
     if $State_trimmed = 'CT' and $class_trimmed = 'U'        !Special logic in probiz.sqc for CT
        let $CHS1_COMPANY   = $Company_in_extract
        let $CHS1_EMPLID    = $Current_Emplid
        let #CHS1_Tax       = #TaxBalance_Tax_QTD
        let #CHS1_Txgrs     = #TaxBalance_Txgrs_QTD
        let #CHS1_Nlgrs     = #TaxBalance_Nlgrs_QTD
        let $CHS1_Tax_Location_cd = $Tax_Location_cd
        do log-CT-location-CHS1
        let $Company_in_extract = $Company_in_extract || ' ' || $CHS1_Tax_Location_cd
     end-if
    #endif
 
    #ifdef GENERAL_SUI_SPLIT_STATE
     let $Save_Company_in_extract = $Company_in_extract
     let $Paygroup_LLC_Field = ''
 
     if #GENERAL_SUI_SPLIT_STATE < 10
       show 'GENERAL_SUI_SPLIT_STATE: for {GENERAL_SUI_SPLIT_STATE}{GENERAL_SUI_SPLIT_TAX_CLASS} ' $State_trimmed ' ' $class_trimmed ' ' $Current_Emplid ' ' $Company_in_extract ' ' $Job_Paygroup ' ' $AsofDate ' ' #Job_empl_rcd
       add 1 to #GENERAL_SUI_SPLIT_STATE
     end-if
 
  if ('{GENERAL_SUI_SPLIT_STATE}'     = '*' or $State_trimmed = rtrim('{GENERAL_SUI_SPLIT_STATE}',' ')) and 
     ('{GENERAL_SUI_SPLIT_TAX_CLASS}' = '*' or $Class_trimmed = rtrim('{GENERAL_SUI_SPLIT_TAX_CLASS}',' '))
        show 'GENERAL_SUI_SPLIT_STATE: Splitting: ' $State_trimmed ' ' $class_trimmed ' ' $Current_Emplid ' ' $Company_in_extract ' ' $Job_Paygroup ' ' $AsofDate ' ' #Job_empl_rcd
        let $Gen_SUI_Split_COMPANY   = $Company_in_extract
        let $Gen_SUI_Split_PAYGROUP  = $Job_Paygroup
        let $Gen_SUI_Split_EMPLID    = $Current_Emplid
        let $Gen_SUI_Split_EFFDT     = $AsofDate
        let #Gen_SUI_Split_empl_rcd  = #Job_empl_rcd
        let #Gen_SUI_Split_Tax       = #TaxBalance_Tax_QTD
        let #Gen_SUI_Split_Txgrs     = #TaxBalance_Txgrs_QTD
        let #Gen_SUI_Split_Nlgrs     = #TaxBalance_Nlgrs_QTD
        do get-SUI-Split-Location          !sets $Paygroup_LLC_Field
        let $Company_in_extract = $Company_in_extract || ' ' || $Paygroup_LLC_Field
     end-if
    #endif
 
    !7/28/05
    #if {SITE_ID} = 'KCT1'
       move $Company_in_extract to $Save_Company_in_extract
       if rtrim($Job_FICA_Status_KMT1,' ') = 'M' and  rtrim($adp_w2_records,' ') = 't'
         move 'MEDEE' to $Company_in_extract
       end-if
    #endif
 
     #if {SITE_ID} = 'TUH1'   ! !TUH-TW1&TB1 remapping 3/20/8
     if rtrim($Company_in_extract,' ') = 'TUH'
        if (rtrim($Job_Paygroup,' ') = 'TW1') or (rtrim($Job_Paygroup,' ') = 'TB1')
          let $Current_Paygroup = 'TW1&TB1'
        end-if
     end-if
     #endif
 
    !Pfizer's logic, set paygroup to WL-FOR, if company 200, Paygroup 21L & 31L, Fica EE tax...
    !----------------------------------------------------------------------------------------
    #if {SITE_ID} = 'PFZ1'
      #if {USE_GBL_TAX_BAL} = 'Y'
         if rtrim($Company_in_extract,' ') = 'GBL'
           if $State_trimmed = '$U' AND  ( ($Class_trimmed = 'D') OR ($Class_trimmed = 'F')
                                     OR    ($Class_trimmed = 'E') OR ($Class_trimmed = 'Q') )
             let $Company_in_extract = '200'
             let $Current_Paygroup = 'WL-FOR'
             Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_WL_FicaEE_Intl
           end-if
         end-if
      #else
         if #RptQtr = 4
           if rtrim($Company_in_extract,' ') = 'GBL'
             if $State_trimmed = '$U' AND  ( ($Class_trimmed = 'D') OR ($Class_trimmed = 'F')
                                       OR    ($Class_trimmed = 'E') OR ($Class_trimmed = 'Q') )
               let $Company_in_extract = '200'
               let $Current_Paygroup = 'WL-FOR'
               Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_WL_FicaEE_Intl
             end-if
           end-if
         else
           if rtrim($Company_in_extract,' ') = 'GBL'
             if $State_trimmed = '$U' AND  ( ($Class_trimmed = 'D') OR ($Class_trimmed = 'F')
                                       OR    ($Class_trimmed = 'E') OR ($Class_trimmed = 'Q') )
               let $Company_in_extract = '200'
               let $Current_Paygroup = 'WL-FOR'
               Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_WL_FicaEE_Intl
             end-if
           else
             if rtrim($Company_in_extract,' ') = '200'
             if rtrim($Company_in_extract,' ') = '200'
               if ((rtrim($Job_Paygroup,' ') = '31L')
               or (rtrim($Job_Paygroup,' ') = '21L')
               or (rtrim($Job_Paygroup,' ') = 'FSL')
               or (rtrim($Job_Paygroup,' ') = 'PHL')
               or (rtrim($Job_Paygroup,' ') = 'A6S')
               or (rtrim($Job_Paygroup,' ') = 'A7S'))
                 if $State_trimmed = '$U' AND  ( ($Class_trimmed = 'D') OR ($Class_trimmed = 'F')
                                           OR    ($Class_trimmed = 'E') OR ($Class_trimmed = 'Q') )
                   let $Company_in_extract = '200'
                   let $Current_Paygroup = 'WL-FOR'
                   Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_WL_FicaEE_Intl
                 end-if
               end-if
             end-if
           end-if
         end-if
      #endif
    #endif
 
    #if {SITE_ID} = 'KFC_OLD'
      let $KFC1_Tax_Class = $class_trimmed
      let $KFC1_State     = $state_trimmed
      let $year = $rptyear
      let #year = #rptyear
      move $current_emplid to $KFC1_emplid
      do Handle-KFC1-Split                  !in adp_tax_split.sqc, returns $KFC1_Group: M-Main, S-CA/Staffing, F-Flex, C-Core
      move $KFC1_Group to $KFC1_Split_Type
      evaluate $KFC1_Group
      when = 'F'
         Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_KFC1_F
         break
      when = 'C'
         Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_KFC1_C
         break
      when = 'M'
         Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_KFC1_M
         break
      when = 'S'
         Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_KFC1_S
         break
      when-other
         break
      end-evaluate
      let $Company_in_extract = rtrim($Company_in_extract,' ') || ' ' || rtrim($KFC1_Split_Type,' ')
    #endif
 
    !3/28/02 for Alliant Food Service ILU breakout
    !---------------------------------------------
    #if {SITE_ID} = 'AFS1'
     if ( (rtrim($Company_in_extract,' ') = 'AFS') AND  !3/28/02 logic fine tuned to look for ILU, AFS
          (rtrim($Output_TaxCode,' ')     = 'ILU') )
 
      let $Current_Paygroup = ' '
      do Determine-AFS-ILU-Breakout  !sets the $Current_Paygroup to LLC if this is an 'LLC' Employee
      if rtrim($Current_Paygroup,' ') = 'LLC'
         Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_ILU_LLC
         Add 1 to #Hash_Count_ILU_LLC
      else
         Add #TaxBalance_Tax_Qtd to #Hash_Total_Tax_ILU_AFS
         Add 1 to #Hash_Count_ILU_AFS
      end-if
     end-if
    #endif
 
    !3/8/02 Hash totals (moved from above)
    !---------------------------------------------------
    add #TaxBalance_Txgrs_Qtd to #Hash_Total_Txgrs_Qtd
    add #TaxBalance_Nlgrs_Qtd to #Hash_Total_Nlgrs_Qtd
    add #TaxBalance_Txgrs_YTD to #Hash_Total_Txgrs_YTD
    add #TaxBalance_Nlgrs_YTD to #Hash_Total_Nlgrs_YTD
    Add #TaxBalance_Tip_Wages_Qtd to #Hash_Total_Tip_Wages_Qtd
    Add #TaxBalance_Tip_Wages_Ytd to #Hash_Total_Tip_Wages_Ytd
 
    !4/13/04 for Frito Lay Pension and Farmers
    !-----------------------------------------
    #if {SITE_ID} = 'FTO1'
     move $Company_in_extract to $Save_Company_in_extract
 
     if rtrim($Company_in_extract,' ') = '001' AND rtrim($Job_Paygroup,' ') = '193'
             let $Company_in_extract = $Company_in_extract || 'FRM'
             #debugd show 'Frito Farmers remapping for employee: ' $Emp_Emplid ' moved to company: ' $Company_in_extract
             add #TaxBalance_Tax_QTD to #TaxBalance_Tax_QTD_Remapped_to_FRM
 
     end-if
     if rtrim($Company_in_extract,' ') = '001' AND rtrim($Job_Paygroup,' ') = 'NOM'
             let $Company_in_extract = $Company_in_extract || 'PEN'
             #debugd show 'Frito Pension remapping for employee: ' $Emp_Emplid ' moved to company: ' $Company_in_extract
             add #TaxBalance_Tax_QTD to #TaxBalance_Tax_QTD_Remapped_to_PEN
     end-if
    #endif
 
    #if {SITE_ID} = 'AIR1'                    ! Company : ALC (AIR1 USA LLC)  Earning Codes: SRP & DIR
      if rtrim($Company_in_extract,' ') = 'ALC'        ! or rtrim($Company_in_extract,' ') = 'AAL'
       do check-for-945-ee
       if rtrim($945_flag,' ') <> ''
         let $Company_in_extract = $Company_in_extract || $945_flag
         #debugd show 'AIR1 Pension remapping for employee: ' $Emp_Emplid ' moved to company: ' $Company_in_extract
         add #TaxBalance_Tax_QTD to #TaxBalance_Tax_QTD_Remapped_to_PEN_AIR1
       end-if
      end-if
    #endif
 
    #if {SITE_ID} = 'BLB1'  !5/26/05 - $UHMP instead of $UH for company 309, Saipan
        if rtrim($Company_in_extract,' ') = '309'
         if rtrim($Output_TaxCode,' ') = '$UH'
          Let $Output_TaxCode  = '$UHMP          '
         end-if
      end-if
    #endif
 
 !*********** Railroad company logic 4/12/04 ************************
 
    #if {SITE_ID} = 'ALC1'                     !Railroad companies for Alcoa
 
      move $Company_in_extract to $Save_Company_in_extract
      let $Current_Paygroup_alcoa = ''
 
      !1/31/05 added
      !--------------
      if ( (rtrim($Company_in_extract,' ') = '010') AND
           (substr($deptid,1,3)            = '059') AND
          ((rtrim($Output_TaxCode,' ') = 'PAU') or (rtrim($Output_TaxCode,' ') = 'PAV')) )
         let $Current_Paygroup_alcoa = 'LLC'
      end-if
      move  $Company_in_extract to $ALCOA_Compid
    #endif
 
      #if {SITE_ID} = 'TBN1'
        let $Trib_Compid = $company_in_extract
        move $Company_in_extract to $Save_Company_in_extract
 
        #ifndef TRIB_PRE_NEWSDAY_SALE
          if rtrim($Company_in_extract,' ') = '660' or
             rtrim($Company_in_extract,' ') = '661' or
             rtrim($Company_in_extract,' ') = '662' or
             rtrim($Company_in_extract,' ') = '663' or
             rtrim($Company_in_extract,' ') = '664' or
             rtrim($Company_in_extract,' ') = '658' or
             rtrim($Company_in_extract,' ') = '659' or
             rtrim($Company_in_extract,' ') = '669'
 
             let $Trib_Compid = $company_in_extract || 'P'
           end-if
        #endif
      #endif
 
 
      #if {SITE_ID} = 'BCD1'
 
         move $Company_in_extract to $Save_Company_in_extract
         move  $company_in_extract to $Boise_Compid
 
         if rtrim($company_in_extract,' ') = 'MRR' OR rtrim($company_in_extract,' ') = 'BRR'
 
           !MN B TIER1    Tier I Employee Tax
           !MN B TIER1ER  Tier I Employer Tax
           !MN B TIERA    Tier I Medicare Emloyee Tax
           !MN B TIERAER  Tier I Medicare Employer Tax
           !MN H TIER2    Tier II Employee Tax
           !MN R TIERR    Tier II Employer Tax
           !MN R RUIA     RUIA Employer Tax
 
           if  substr($Output_Taxcode,1,7) = 'MNBTIER'  OR substr($Output_Taxcode,1,7) = 'MNHTIER'
            OR substr($Output_Taxcode,1,7) = 'MNRRUIA'  OR substr($Output_Taxcode,1,7) = 'MNRTIER'
 
            let $Boise_Compid = $company_in_extract || 'RR'
            add #TaxBalance_Tax_QTD to #TaxBalance_Tax_QTD_Remapped_to_RR
            #debugd show 'Boise remapping.    Emplid ' $Current_Emplid ' to ' $Boise_Compid ' for taxcode ' $Output_Taxcode
           else
            #debugd show 'Boise no-remapping. Emplid ' $Current_Emplid '    ' $Boise_Compid ' for taxcode ' $Output_Taxcode
           end-if
         end-if
 
       #endif
 
       !4/1/04 remap RR taxcodes to COMPANY || RR
       !-----------------------------------------
       #if {SITE_ID} = 'CSX1'
 
           move $Company_in_extract to $Save_Company_in_extract
           move  $company_in_extract to $CSX_Compid
 
           !11/26/2013 -Move existing RRTA Tax Classes to other assigned, but unused Tax Classes.
              !6 RRTA Tier I	        ->	G OASDI/EE - Tips
              !7 RRTA Tier II	        ->	T FICA Med Hospital Ins/EE - Tips
              !8 RRTA Tier II Employer	->	J OASDI/ER - Tips
              !9 RRTA Medicare	        ->	Z FICA Med Hospital Ins/ER - Tips
		 	 	
              !Move previously re-assigned Tax Classes back to their original assignments
              !0 FICA Add. FUTA Tax Expenses	->	6 FICA Add. FUTA Tax Expenses
              !1 FICA Medicare High Earners	->	7 FICA Medicare High Earners
              !2 FICA ER Exempt       	        ->	8 FICA ER Exempt
              !3 FICA ER Tips Exempt	        ->	9 FICA ER Tips Exempt
 
              ! #define EE_Tier1_MED       $UG
              ! #define EE_Tier1_SS        $UZ
              ! #define EE_Tier1_MED_ADDL  $UK
 
!05312013, $U8 removed on 11/26/2013
 
           if rtrim($Output_Taxcode,' ') = '{EE_Tier1_MED}'   OR
              rtrim($Output_Taxcode,' ') = '{EE_Tier1_SS}'    OR
              rtrim($Output_Taxcode,' ') = '$UT'       OR
              rtrim($Output_Taxcode,' ') = '$UJ'       OR
              rtrim($Output_Taxcode,' ') = 'TIER1MEDC' OR
              rtrim($Output_Taxcode,' ') = 'TIER1SDIC' OR
              rtrim($Output_Taxcode,' ') = '{EE_Tier1_MED_ADDL}'
!--------------
 
             let $CSX_Compid = $company_in_extract || 'RR'
             show 'CSX RR Remapping to company: ' $CSX_Compid ', taxcode: ' $Output_Taxcode ', emplid: ' $Current_Emplid
             add #TaxBalance_Tax_QTD to #TaxBalance_Tax_QTD_Remapped_to_RR
           end-if
 
       #endif
 
  #if {SITE_ID} = 'ALC1'
        Let $Extract_compid = $ALCOA_CompID || $space1 || $Current_Paygroup_alcoa
        goto done_reestablish_compid
  #endif
  #if {SITE_ID} = 'BCD1'
        #ifdef PAYGROUP_ROLLUP
          Let $Extract_compid = $BOISE_CompID
        #else
          Let $Extract_compid = $BOISE_CompID || $space1 || $Current_Paygroup
        #endif
        goto done_reestablish_compid
  #endif
  #if {SITE_ID} = 'CSX1'
        #ifdef PAYGROUP_ROLLUP
          Let $Extract_compid = $CSX_CompID
        #else
          Let $Extract_compid = $CSX_CompID || $space1 || $Current_Paygroup
        #endif
 
        goto done_reestablish_compid
  #endif
 
  #if {SITE_ID} = 'TBN1'
     let $Extract_compid = $Trib_Compid
     goto done_reestablish_compid
  #endif
 
  #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
    move $Company_in_extract to $Save_Company_in_extract
    do get-paygroup-data-SCM1
    let $Extract_compid = $SCM1_Compid
    goto done_reestablish_compid
  #endif
 
   #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
      #ifdef DEBUG_SUBTOTAL_BUSINESS_UNIT_EXTRACT
        show '  ****  establishing SUBTOTAL_BUSINESS_UNIT_EXTRACT, company = ' $company ' current_company = ' $current_company ' busunit = ' $Job_Business_Unit ' ' $Current_Emplid
      #endif
      let $Company = $Current_Company
      #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT_include_Company
        let $Extract_compid = $Current_Company || '_' || $Job_Business_Unit   !12/14/16
      #else
        let $Extract_compid = $Job_Business_Unit
      #endif
      goto done_reestablish_compid
  #endif
  
  #ifdef CUSTOM_EMPLOYMENT_TYPE
    move $Company_in_extract to $Save_Company_in_extract
    let $Extract_compid = $Company_in_extract
    move $Extract_compid to $Save_Extract_compid
    do Get-Custom-Employment_type                               !modified Extract_compid if necessary, see probiz.sqc
    if $Extract_compid <> $Save_Extract_compid
      Add #TaxBalance_Tax_QTD   to #Hash_Total_Tax_CUSTOM_EMPLOYMENT_TYPE
    end-if
    goto done_reestablish_compid
  #endif
  
  !********************* End of Railroad logic ***************************
 
    let $Extract_compid = $Company_in_extract || $space1 || $Current_Paygroup
 
    #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
        Let $Extract_compid = $Current_ADP_CompID
    #endif
 
done_reestablish_compid:
 
  ! SCR1
  ! ---------
  #ifdef ENABLE_SCR1_REMAPPING
 
    !------------------------------------------------------------------------------------------------------------------------
    !6/25/09
      !We do not want any changes to the EOC file as there are no issues.  This means not changes to any 'E' databases.
      !The change we would like you to make is in the header, and if it starts with an H, start off the header with W0.
      !All databases do start with E or H. The Es are fine so we only need to have the modification to the program for the Hs.
      !From Probiz.sqc:
      !  #define ENABLE_SCR1_REMAPPING
      !  #define EAST_PREFIX                  E0
      !  #define WEST_PREFIX                  W0
      !  #define EAST_PROD_DB                 EHRPROD
      !  #define WEST_PROD_DB                 HRPROD
 
    !7/07/09
      !Jose and I did review the email from 6/25 and we understand the E Databases currently have the H0
      !and we do not want to change this to E0.  We only want the H databases to have W0 which HRPPROD does,
      !but not HRTAX which is our test DB.  Therefore, whenever we send a test file we must modify the header.
      !All other databases currently work properly (HRPROD = W0, EHRPROD = E0 and EHRTAX = E0.  Please let Jose
      !and I know if you would like to have a call on this.
    !------------------------------------------------------------------------------------------------------------------------
 
      let $SCR1_Compid = $Extract_compid
      if    rtrim($Extract_compid,' ') <> '44'   !Renaissance Center Management
        AND rtrim($Extract_compid,' ') <> '49'   !SCG
        AND rtrim($Extract_compid,' ') <> '51'   !Pinkerton Govt. Services
        AND rtrim($Extract_compid,' ') <> '50'   !Paragon
         if rtrim($database,' ') <> 'HRTAX'
          if substr($database,1,1) = 'H'
            let $SCR1_Compid = '{WEST_PREFIX}' || $Extract_compid
          end-if
         end-if
      end-if
 
      Let $Extract_compid = $SCR1_Compid
 
  #endif
 
  !write header record for every new compid in the extract
  !-------------------------------------------------------
  if (rtrim($Header_rec_compid,' ') <> rtrim($Extract_compid,' '))
 
        if rtrim($Header_rec_compid,' ') <> ''      !write preceding trailer if not first set of data
 
          #ifdef SKIP_COMPANY_HEADER
             if rtrim($Extract_compid,' ') <> rtrim('{SKIP_COMPANY_HEADER}',' ')
               show 'Writing Trailer for company ' $Header_rec_compid
               do Write-Company-Trailer-Rec
             end-if
          #else
             show 'Writing Trailer for company ' $Header_rec_compid
             do Write-Company-Trailer-Rec
          #endif
 
        end-if
 
        #ifdef SKIP_COMPANY_HEADER
           if rtrim($Extract_compid,' ') <> rtrim('{SKIP_COMPANY_HEADER}',' ')
             show 'Writing Header for company ' $Extract_compid
             do Write-Company-Header-Rec
             move $Extract_compid to $Header_rec_compid
           end-if
        #else
           show 'Writing Header for company ' $Extract_compid
           do Write-Company-Header-Rec
           move $Extract_compid to $Header_rec_compid
        #endif
 
    end-if
 
    #ifndef SKIP_TAX_AND_WAGE_AUDITS
        do create-audit
    #endif
 
    if $first_tax_for_emplid = 't'
      do write-employee-rec
    end-if
 
    !6/9/9 - log worksite data
    !#ifdef WORKSITE_REPORTING
    !  if ($State_trimmed <> '$U') and ($Class_trimmed = 'U')
    !     do log-worksite-setup-records
    !  end-if
    !#endif
 
    do Write-Wage-rec
    let $first_tax_for_emplid = 'f'
 
    !Reestablish the original comany code for those clients that need remapping
    !--------------------------------------------------------------------------
 
    #if {SITE_ID} = 'AXA1'
      move $Save_Company_in_extract to $Company_in_extract
    #endif
    #if {SITE_ID} = 'FTO1'
      move $Save_Company_in_extract to $Company_in_extract
    #endif
    #if {SITE_ID} = 'ALC1'                     !Railroad companies for Alcoa
      move $Save_Company_in_extract to $Company_in_extract
      if rtrim($Save_Current_Paygroup,' ') <> ''
         let $Current_Paygroup = $Save_Current_Paygroup
      end-if
    #endif
    #if {SITE_ID} = 'TBN1'
         move $Save_Company_in_extract to $Company_in_extract
    #endif
    #if {SITE_ID} = 'BCD1'
      move $Save_Company_in_extract to $Company_in_extract
    #endif
    #if {SITE_ID} = 'CSX1'
      move $Save_Company_in_extract to $Company_in_extract
    #endif
    #if {SITE_ID} = 'PRD1'
      move $Save_Company_in_extract to $Company_in_extract
      move $Save_current_company to $current_company
    #endif
    #if {SITE_ID} = 'KCT1'
         move $Save_Company_in_extract to $Company_in_extract
    #endif
    #ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
      move $Save_Company_in_extract to $Company_in_extract
    #endif
    #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
       move $Save_Company_in_extract to $Company_in_extract
    #endif
    
    #if {SITE_ID} = 'TLL1'
     #ifdef TOLL_FAIRLESS_HILLS_LOCATION
      move $Save_Company_in_extract to $Company_in_extract
      move $Save_current_company to $current_company
     #endif
    #endif
 
    #if {SITE_ID} = 'CHS1'
      move $Save_Company_in_extract to $Company_in_extract
    #endif
    #ifdef GENERAL_SUI_SPLIT_STATE
      move $Save_Company_in_extract to $Company_in_extract
    #endif
 
    #ifdef CUSTOM_EMPLOYMENT_TYPE
      move $Save_Company_in_extract to $Company_in_extract
    #endif
 
 
    !--------------------------------------------------------------------------
 
 end-if
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move 'Write-Quarterly-Record' to $debug-proc1
    move ' '    to $debug-table1
    do log-delta-time
 #endif
 
end-procedure
 
#ifdef SUBTOTAL_SRC_BANK_ID_EXTRACT
begin-procedure get-paygroup-data-SCM1
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  let $SCM1_Compid = ''
 
begin-select
PAYTBL.SRC_BANK_ID
 
  let $SCM1_Compid = $Company_in_extract || '_' || &PAYTBL.SRC_BANK_ID !updated 3/24/09 to pull in the company too
 
  FROM PS_PAYGROUP_TBL PAYTBL
    Where PAYTBL.COMPANY  = $Company_in_extract
        AND PAYTBL.PAYGROUP = $Job_PAYGROUP
        AND PAYTBL.EFFDT = (SELECT MAX(PAYTBL2.EFFDT)
             FROM PS_PAYGROUP_TBL PAYTBL2
             WHERE PAYTBL2.COMPANY = PAYTBL.COMPANY
              AND  PAYTBL2.PAYGROUP = PAYTBL.PAYGROUP
              AND  PAYTBL2.EFFDT  <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  if length($SCM1_Compid) < 5
    #debugd show 'get-paygroup-data-SCM1: Error: invalid SRC_BANK_ID. Aborting program ' $Current_Emplid ' ' $Company_in_extract ' ' $Job_Paygroup ' = ' $SCM1_Compid
    stop
  end-if
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'get-paygroup-data-SCM1' to $debug-proc1
     move 'PS_PAYGROUP_TBL'    to $debug-table1
     do log-delta-time
  #endif
 
 
end-procedure
#endif
 
begin-procedure check-for-void-w2  !added 5/24/06
 
  let $check-for-void-w2 = 't'
  #ifdef VOID_W2s_for_EXPATS  !if one tax balance.. AND it is Box 11x or 12x, we want to void it.
 
    !if #box_w2_count = 1                       !remove this 20121217
    ! Get #Amount from Box_W2(0) AMOUNT
    ! Get $Box    from Box_W2(0) BOX
    !
    ! if rtrim($Box,' ') = '01'
    !    add #Amount to #Hash_Voided_taxable_for_expats
    !    #debugd show 'Expat logic: void #1 ' $Current_Emplid ' Box: ' $Box ' Amount: ' #Amount edit 999,999,999.99 ' count ' #box_w2_count edit 999
    !    goto void_w2
    ! end-if
    !end-if
 
    !if single Box 01 OR a single Box 01 and a Box 12x... Void it   !remove 20121218
    !------------------------------------------------------------
    !Get #Amount from Box_W2(0) AMOUNT
    !Get $Box    from Box_W2(0) BOX
    !
    !if rtrim($Box,' ') = '01' and #box_w2_count = 2
    !    Get $Box from Box_W2(1) BOX  ! Box 01 only ... OR.... Box 01 and any Box 12 next... should be voided
    !    if substr($Box,1,2) = '12'
    !       add #Amount    to #Hash_Voided_taxable_for_expats
    !       #debugd show 'Expat logic: void #2 ' $Current_Emplid ' Box: ' $Box ' Amount: ' #Amount edit 999,999,999.99 ' count ' #box_w2_count edit 999
    !       goto void_w2
    !    end-if
    !end-if
 
     !12/07/2012 - if single Box 12x .. Void it
     !------------------------------------------------------------
      Get #Amount from Box_W2(0) AMOUNT
      Get $Box    from Box_W2(0) BOX
      if (substr($Box,1,2) = '12' or substr($Box,1,2) = '11') and #box_w2_count = 1
        add #Amount    to #Hash_Voided_taxable_for_expats
        show 'Expat logic: void #3 ' $Current_Emplid ' Box: ' $Box ' Amount: ' #Amount edit 999,999,999.99 ' count ' #box_w2_count edit 999
        goto void_w2
      end-if
 
 #endif
 
 !12/6/6 added -------------------------
 if $YEE.PROCESS_FLAG = 'V'
   show 'Expat logic: void #4 ' $Current_Emplid ' W-2 Voided, PROCESS_FLAG = V'
   goto void_w2
 end-if
 !--------------------------------------
 
  let #cur_cnt = 0
  while #cur_cnt < #Last_TaxBalance_Cnt
 
      Add 1 to #cur_cnt
 
      get   #vTaxBalance_Nlgrs_Ytd      -
            #vTaxBalance_Txgrs_Ytd      -
            #vTaxBalance_Tax_Ytd        -
            #vTaxBalance_Tip_Wages_Ytd  -
            #vTaxBalance_Tip_Tax_Ytd    -
        from TaxBalance(#Cur_Cnt)      -
             TaxBalance_Nlgrs_Ytd      -
             TaxBalance_Txgrs_Ytd      -
             TaxBalance_Tax_Ytd        -
             TaxBalance_Tip_Wages_Ytd  -
             TaxBalance_Tip_Tax_Ytd
 
      if    #vTaxBalance_Nlgrs_Ytd     <> 0
        or  #vTaxBalance_Txgrs_Ytd     <> 0
        or  #vTaxBalance_Tax_Ytd       <> 0
        or  #vTaxBalance_Tip_Wages_Ytd <> 0
        or  #vTaxBalance_Tip_Tax_Ytd   <> 0
 
       let $check-for-void-w2 = 'f'                         
       goto void_w2
 
      end-if
 
   end-while
 
 
  let #cur_cnt = 0
  while (#cur_cnt < #box_w2_count)
 
     Get #Amount From Box_W2(#cur_cnt) AMOUNT
     if #Amount <> 0
        let $check-for-void-w2 = 'f'
        goto void_w2
     end-if
     add 1 to #cur_cnt
 
  end-while
 
  show 'Expat logic: void #5 ' $Current_Emplid
 
void_w2:
 
end-procedure
 
#if {SITE_ID} = 'AIR1'
 
begin-procedure check-for-945-ee
 
  let $945_flag = ''
 
begin-select
EB99.ERNCD
 
 let $945_flag = 'R'
 
 FROM PS_EARNINGS_BAL{WAREHOUSE_SUFFIX} EB99
 WHERE EB99.EMPLID            = $Current_Emplid
   AND EB99.COMPANY           = $Current_COMPANY
   #ifdef USE_INT_CRITERIA
    AND EB99.BALANCE_YEAR      = int(\$RptYearZ\)
   #else
    AND EB99.BALANCE_YEAR      = #RptYear
   #endif
   AND EB99.BALANCE_ID        = $Calendar_Year_Id
   AND EB99.GRS_YTD           <> 0                       !1/12/02 was > 0
   ! AND EB99.ERNCD in ('M60', '99M', '99R')
   AND EB99.ERNCD in ('DIR', 'SRP')
   AND EB99.BALANCE_PERIOD           =
      (SELECT MAX(BALANCE_PERIOD)
       FROM   PS_EARNINGS_BAL{WAREHOUSE_SUFFIX}
       WHERE  EMPLID            = EB99.EMPLID
         AND  COMPANY           = EB99.COMPANY
         AND  BALANCE_YEAR      = EB99.BALANCE_YEAR
         AND  BALANCE_ID        = EB99.BALANCE_ID
         AND  {emp_rec}         = EB99.{emp_rec}         ! 1/7/05
         AND  SPCL_BALANCE      = EB99.SPCL_BALANCE
         AND  ERNCD             = EB99.ERNCD)
! ORDER BY EB99.EMPLID, EB99.ERNCD
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
#endif
 
#if {SITE_ID} = 'AFS1'
 
begin-procedure Determine-AFS-ILU-Breakout  !sets the $Current_Paygroup to LLC if this is an 'LLC' Employee
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT
AFS.COMPANY
AFS.EMPLID
 
 let $Current_Paygroup = 'LLC'
 
 FROM PS_{Client_Table_Prefix}AF_AFSLLC{Client_Table_Suffix} AFS
 
 WHERE AFS.COMPANY         = '{AFS_LLC_COMPANY_CODE}'
   AND AFS.EMPLID          = $Current_Emplid
   AND AFS.EFFDT           =
     (SELECT MAX(EFFDT)
        FROM PS_{Client_Table_Prefix}AF_AFSLLC{Client_Table_Suffix}
       WHERE COMPANY    = AFS.COMPANY
         AND EMPLID     = AFS.EMPLID
         AND EFFDT     <= $AsOfDate )
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
#endif
 
#ifdef USE_HIRE_DATE_FOR_MONTHLY_COUNTS
 
begin-procedure Get-Termination-Date-for-counts
 
 move '' to $Personal_Orig_Trm_DTU
 
begin-select
QEE.TERMINATION_DT
 
  if rtrim(&QEE.TERMINATION_DT,' ') <> ''
    Do Convert-to-DTU-Date(&QEE.TERMINATION_DT, $Personal_Orig_Trm_DTU)
  end-if
 
  FROM PS_EMPLOYMENT QEE {NOLOCK_SQL}
    WHERE EMPLID = $Current_emplid
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
#endif
 
#ifndef USE_TEMP_TABLE_FOR_MONTHLY_COUNTS   !this is the < 2/5/02 STANDARD way, no temp table
 
!3/30/6 -----------------------------------------------------------------------------------------------------
 
begin-procedure check-for-state-local
 
 !We may only need this logic for SUI and Locals, 10/24/2011 added logic to include counts for FIT
 !---------------------------------------------------------------------------------------------------
 if ($state_trimmed <> '$U' and ($class_trimmed = 'U' or $Class_trimmed = 'S')) or ($state_trimmed = '$U' and $class_trimmed = 'H')
 
 let #monthly_checks_inx = 0
 while #monthly_checks_inx < #monthly_checks
 
  get	 $PC_PAY_BEGIN_DT
         $PC_PAY_END_DT
         $PSPC.COMPANY
  	 $PSPC.PAYGROUP
  	 $PSPC.PAY_END_DT
  	 #PSPC_PAGE
  	 #PSPC_LINE
  	 $PSPC.OFF_CYCLE
  	 #PSPC_SEPCHK
  	 from monthly_checks(#monthly_checks_inx)
  	   PC_PAY_BEGIN_DT
  	   PC_PAY_END_DT
  	   COMPANY
  	   PAYGROUP
  	   PAY_END_DT
  	   PAGE
  	   LINE
  	   OFF_CYCLE
  	   SEPCHK
 
   let $eec_match = 'f'
 
begin-select
EEC_PT.STATE
EEC_PT.LOCALITY
EEC_PT.TAX_CLASS
 
 if $local_trimmed = ''
   let $eec_match = 't'
 else
   if rtrim(&EEC_PT.LOCALITY,' ')  = $local_trimmed
     let $eec_match = 't'
   end-if
 end-if
 
 FROM PS_PAY_TAX{WAREHOUSE_SUFFIX} EEC_PT {NOLOCK_SQL}
 
 WHERE EEC_PT.COMPANY    = $PSPC.COMPANY
   AND EEC_PT.PAYGROUP   = $PSPC.PAYGROUP
   AND EEC_PT.PAY_END_DT = $PSPC.PAY_END_DT
   AND EEC_PT.OFF_CYCLE  = $PSPC.OFF_CYCLE
   AND EEC_PT.{pg}       = #PSPC_PAGE
   AND EEC_PT.{ln}       = #PSPC_LINE
   #if {PeopleSoft_Version} >= '8'      !10/12/07   use sepchk
    AND EEC_PT.SEPCHK     = #PSPC_SEPCHK
   #endif
 
   AND EEC_PT.STATE       = $state_trimmed
   AND EEC_PT.TAX_CLASS   = $class_trimmed
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  if rtrim($eec_match,' ') = 't'
 
    !added 2/2/99...
    !----------------
    Do Convert-to-DTU-Date($PC_PAY_BEGIN_DT, $EarnsBegin_DTU)
    Do Convert-to-DTU-Date($PC_PAY_END_DT, $EarnsEnd_DTU)
    !--------------------------
 
     if  ( ($12th_of_1st_Month_DTU >= $EarnsBegin_DTU) and ($12th_of_1st_Month_DTU <= $EarnsEnd_DTU) )
      let $Month1_Worked = 'Y'
     end-if
 
     if  ( ($12th_of_2nd_Month_DTU >= $EarnsBegin_DTU) and ($12th_of_2nd_Month_DTU <= $EarnsEnd_DTU) )
      let $Month2_Worked = 'Y'
     end-if
 
     if  ( ($12th_of_3rd_Month_DTU >= $EarnsBegin_DTU) and ($12th_of_3rd_Month_DTU <= $EarnsEnd_DTU) )
      let $Month3_Worked = 'Y'
     end-if
 
     !-----------------------------------------------------------------------------
     !note, this logic will NOT pull data for someone unless they have a job record
     !effective dated less than or equal to the check date we're accessing
     !-----------------------------------------------------------------------------
  end-if
 
  add 1 to #monthly_checks_inx
 end-while
 
 !We may only need this logic for SUI
 !-----------------------------------
 end-if
 
end-procedure
 
!------------------------------------------------------------------------
 
!********************************************************************* !
!----------------------------------------------------------------------!
! Procedure: Get-Worked-In-Months-Flags                                !
!----------------------------------------------------------------------!
begin-procedure Get-Worked-In-Months-Flags
 
 #ifdef USE_HIRE_DATE_FOR_MONTHLY_COUNTS
 
  if #Last_Q1_Cnt = 1
 
    let $Month1_Worked = 'N'
    let $Month2_Worked = 'N'
    let $Month3_Worked = 'N'
 
    do Get-Termination-Date-for-counts
 
    if (rtrim($Personal_Orig_Trm_DTU,' ') = '')
      if $Personal_Orig_Hire_DTU <= $12th_of_1st_Month_DTU
        let $Month1_Worked = 'Y'
      end-if
      if $Personal_Orig_Hire_DTU <= $12th_of_2nd_Month_DTU
        let $Month2_Worked = 'Y'
      end-if
      if $Personal_Orig_Hire_DTU <= $12th_of_3rd_Month_DTU
        let $Month3_Worked = 'Y'
      end-if
    else
      if $Personal_Orig_Hire_DTU <= $12th_of_1st_Month_DTU  AND ($Personal_Orig_Trm_DTU >= $12th_of_1st_Month_DTU)
        let $Month1_Worked = 'Y'
      end-if
      if $Personal_Orig_Hire_DTU <= $12th_of_2nd_Month_DTU  AND ($Personal_Orig_Trm_DTU >= $12th_of_2nd_Month_DTU)
        let $Month2_Worked = 'Y'
      end-if
      if $Personal_Orig_Hire_DTU <= $12th_of_3rd_Month_DTU  AND ($Personal_Orig_Trm_DTU >= $12th_of_3rd_Month_DTU)
        let $Month3_Worked = 'Y'
      end-if
    end-if
  end-if
 
  if $SelectEmplid <> ''
    show 'Get-Worked-In-Months-Flags: USE_HIRE_DATE_FOR_MONTHLY_COUNTS: Hire..Term: ' $Personal_Orig_Hire_DTU '...' $Personal_Orig_Trm_DTU ' --> ' $Month1_Worked $Month2_Worked $Month3_Worked
  end-if
 
#else
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 let $Month1_Worked = 'N'
 let $Month2_Worked = 'N'
 let $Month3_Worked = 'N'
 
 if #Last_Q1_Cnt > 1 !added 7/31/06, as this only needs to get called for each employee once.
    do check-for-state-local !local and state match required now...
 else
 
  clear-array name=monthly_checks
  let #monthly_checks = 0
 
begin-SELECT
#if {SITE_ID} = 'AAP1'
/*+ leading (paycal2 pspc) no_expand   use_nl(paycal2 pspc) */
#endif
PAYCAL2.PAY_BEGIN_DT
PAYCAL2.PAY_END_DT
PSPC.COMPANY
PSPC.PAYGROUP
PSPC.PAY_END_DT
PSPC.{pg}
PSPC.{ln}
PSPC.OFF_CYCLE
PSPC.SEPCHK
PSPC.CHECK_DT
 
  put	 &PAYCAL2.PAY_BEGIN_DT
         &PAYCAL2.PAY_END_DT
         &PSPC.COMPANY
  	 &PSPC.PAYGROUP
  	 &PSPC.PAY_END_DT
  	 &PSPC.{pg}
  	 &PSPC.{ln}
  	 &PSPC.OFF_CYCLE
  	 &PSPC.SEPCHK
  	 into monthly_checks(#monthly_checks)
  	   PC_PAY_BEGIN_DT
  	   PC_PAY_END_DT
  	   COMPANY
  	   PAYGROUP
  	   PAY_END_DT
  	   PAGE
  	   LINE
  	   OFF_CYCLE
  	   SEPCHK
 
    add 1 to #monthly_checks
 
    if #monthly_checks >= {MAX_MONTHLY_CHECKS}
      #debugd show 'Error: Monthly_counts array is too small, {MAX_MONTHLY_CHECKS}, emplid ' $Current_emplid
      stop
    end-if
 
  FROM  PS_PAY_CHECK{WAREHOUSE_SUFFIX} PSPC {NOLOCK_SQL}, PS_PAY_CALENDAR{WAREHOUSE_SUFFIX} PAYCAL2 {NOLOCK_SQL}
 
     WHERE    PSPC.COMPANY       = PAYCAL2.COMPANY
       AND    PSPC.PAYGROUP      = PAYCAL2.PAYGROUP
       AND    PSPC.PAY_END_DT    = PAYCAL2.PAY_END_DT
       AND   ( ($12th_Of_1st_Month_Native BETWEEN PAYCAL2.PAY_BEGIN_DT
                                              AND PAYCAL2.PAY_END_DT)
          OR   ($12th_Of_2nd_Month_Native BETWEEN PAYCAL2.PAY_BEGIN_DT
                                              AND PAYCAL2.PAY_END_DT)
          OR   ($12th_of_3rd_month_Native BETWEEN PAYCAL2.PAY_BEGIN_DT
                                              AND PAYCAL2.PAY_END_DT) )
       AND PSPC.COMPANY    = $Current_Company
       AND PSPC.EMPLID     = $Current_Emplid
 
       #ifdef INCLUDE_ON_AND_OFF_CYCLE_FOR_COUNTS
        AND PSPC.OFF_CYCLE  <> ' '
       #endif
 
       #ifdef INCLUDE_ON_CYCLE_FOR_COUNTS_ONLY         !default
         AND PSPC.OFF_CYCLE <> 'Y'
       #endif
 
       #ifdef INCLUDE_MATCHING_CHECK_DATES_FOR_COUNTS  !JCP Test
         AND ( PSPC.CHECK_DT = PAYCAL2.CHECK_DT )
       #endif
 
       AND PSPC.PAYCHECK_STATUS = 'F'
       AND PSPC.PAYCHECK_OPTION <> 'R'
 
     #if {SITE_ID} = 'SRC1'
       AND PAYCAL2.PAY_OFF_CYCLE_CAL = 'N'
       AND PSPC.TOTAL_GROSS > 0
     #endif
 
#ifdef SELECT_WITH_UR
   {SELECT_WITH_UR} with ur
#endif
end-select
 
  do check-for-state-local !local and state match required now...
 
 end-if
 
#endif
 
 
end-procedure
 
#else
 
!3/30/6 -----------------------------------------------------------------------------------------------------
 
begin-procedure init-for-state-local
 
begin-select
EEC_PT.STATE
EEC_PT.LOCALITY
EEC_PT.TAX_CLASS
EEC_PT.TAX_CUR
 
  if $SelectEmplid <> ''
    show 'init-for-state-local ' &EEC_PT.STATE ' ' &EEC_PT.TAX_CLASS ' ' &EEC_PT.LOCALITY
  end-if
 
  let $Tax_State     = rtrim(&EEC_PT.STATE,' ')
  let $Tax_Locality  = rtrim(&EEC_PT.LOCALITY,' ')
  let $Tax_Tax_Class = rtrim(&EEC_PT.TAX_CLASS,' ')
 
  do ins-temp
 
 FROM PS_PAY_TAX{WAREHOUSE_SUFFIX} EEC_PT {NOLOCK_SQL}
 
 WHERE EEC_PT.COMPANY    = $PSPC.COMPANY
   AND EEC_PT.PAYGROUP   = $PSPC.PAYGROUP
   AND EEC_PT.PAY_END_DT = $PSPC.PAY_END_DT
   AND EEC_PT.OFF_CYCLE  = $PSPC.OFF_CYCLE
   AND EEC_PT.{pg}       = #PSPC_PAGE
   AND EEC_PT.{ln}       = #PSPC_LINE
   #if {PeopleSoft_Version} >= '8'      !10/12/07   use sepchk
    AND EEC_PT.SEPCHK     = #PSPC_SEPCHK
   #endif
   AND ( (EEC_PT.STATE <> '$U' AND (EEC_PT.TAX_CLASS = 'U' or EEC_PT.TAX_CLASS = 'S' )) OR
         (EEC_PT.STATE = '$U' AND EEC_PT.TAX_CLASS = 'H') )                                !10/24/2011 added for FIT (MasterTax)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
 
!------------------------------------------------------------------------
 
!********************************************************************* !
!----------------------------------------------------------------------!
! Procedure: Populate-Worked-In-Months-Flags                           !
!----------------------------------------------------------------------!
begin-procedure Populate-Worked-In-Months-Flags
 
  #ifndef SUBTOTAL_ADP_COMPID_EXTRACT_SELECT_BY_TF_COMPANY
 
  if $AllCompanies = 'Y'
      let $TempCompanySelection = 'PAYCAL22.COMPANY > '' '''
  else
     if rtrim($SelectCompany,' ') <> ''
       #if {SITE_ID} = 'SRC1'
           if $Include = 'I'
              let $TempCompanySelection = 'PAYCAL22.COMPANY IN ' || $PS_Company_list
           else
              let $TempCompanySelection = 'PAYCAL22.COMPANY NOT IN ' || $PS_Company_list
           end-if
       #else
           let $TempCompanySelection = 'PAYCAL22.COMPANY = ''' || $SelectCompany || ''''
       #endif
     else
       if rtrim($ExcludeCompany,' ') <> ''
        let $TempCompanySelection = 'PAYCAL22.COMPANY <> ''' || $ExcludeCompany || ''''
       else
!        #debugd show 'Invalid Temp Company Selection'
!        stop
         let $TempCompanySelection = 'PAYCAL22.COMPANY > '' '''
       end-if
     end-if
  end-if
 
  #else
      let $TempCompanySelection = 'PAYCAL22.COMPANY > '' '''
  #endif
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
begin-SELECT
PAYCAL22.PAY_BEGIN_DT
PAYCAL22.PAY_END_DT
PSPC1.COMPANY
PSPC1.PAYGROUP
PSPC1.PAY_END_DT
PSPC1.{pg}
PSPC1.{ln}
PSPC1.OFF_CYCLE
PSPC1.SEPCHK
PSPC1.EMPLID
PSPC1.CHECK_DT
 
 #ifdef JAT_TESTING
   let $JAT_Emplid = &PSPC1.EMPLID
   do custom-emplid-selection  !in probiz.sqc
   if $process_test_emplid = 't'
     #ifdef debug_JAT_TESTING
      #debugd show 'Populate-Worked-In-Months-Flags: Processing JAT test emplid: ' $JAT_Emplid
     #endif
   else
     goto bypass_worked_flags
   end-if
 #endif
 
  move &PSPC1.COMPANY     to $PSPC.COMPANY
  move &PSPC1.PAYGROUP    to $PSPC.PAYGROUP
  move &PSPC1.PAY_END_DT  to $PSPC.PAY_END_DT
  move &PSPC1.{pg}        to #PSPC_PAGE
  move &PSPC1.{ln}        to #PSPC_LINE
  move &PSPC1.OFF_CYCLE   to $PSPC.OFF_CYCLE
  move &PSPC1.SEPCHK      to #PSPC_SEPCHK
  move &PSPC1.EMPLID      to $PSPC.EMPLID
  move &PSPC1.CHECK_DT    to $PSPC.CHECK_DT
 
  if $SelectEmplid <> ''
     if rtrim($PSPC.EMPLID,' ') = $SelectEmplid
       show 'New pay check, for initing monthly counts ' $PSPC.COMPANY ' ' $PSPC.PAYGROUP ' ' $PSPC.PAY_END_DT
     end-if
  end-if
 
     Do Convert-to-DTU-Date(&PAYCAL22.PAY_BEGIN_DT, $EarnsBegin_DTU)
     Do Convert-to-DTU-Date(&PAYCAL22.PAY_END_DT, $EarnsEnd_DTU)
 
     !--------------------------
     let #Period_Count = 0
     if  ( ($12th_of_1st_Month_DTU >= $EarnsBegin_DTU) and
           ($12th_of_1st_Month_DTU <= $EarnsEnd_DTU) )
      let #Period_Count = 1
     end-if
 
     if  ( ($12th_of_2nd_Month_DTU >= $EarnsBegin_DTU) and
           ($12th_of_2nd_Month_DTU <= $EarnsEnd_DTU) )
      let #Period_Count = 2
     end-if
 
     if  ( ($12th_of_3rd_Month_DTU >= $EarnsBegin_DTU) and
           ($12th_of_3rd_Month_DTU <= $EarnsEnd_DTU) )
      let #Period_Count = 3
     end-if
 
     do init-for-state-local !local and state match required now...
 
bypass_worked_flags:
 
  FROM  PS_PAY_CHECK{WAREHOUSE_SUFFIX} PSPC1 {NOLOCK_SQL}, PS_PAY_CALENDAR{WAREHOUSE_SUFFIX} PAYCAL22 {NOLOCK_SQL},
        PS_PAY_CAL_BAL_ID{WAREHOUSE_SUFFIX} BAL1 {NOLOCK_SQL}
 
     WHERE
              #ifdef MVS
                \$TempCompanySelection\
              #else
                [$TempCompanySelection]
              #endif
 
              AND PAYCAL22.COMPANY     = BAL1.COMPANY
              AND PAYCAL22.PAYGROUP    = BAL1.PAYGROUP
              AND PAYCAL22.PAY_END_DT  = BAL1.PAY_END_DT
              AND BAL1.BALANCE_ID = $Calendar_Year_Id

!20150819 - this eliminates the BETWEEN which is slow
!---------------------------------------------------------------------------------------------------------- 

              AND ( (PAYCAL22.PAY_BEGIN_DT     <= $12th_Of_1st_Month_Native AND PAYCAL22.PAY_END_DT >= $12th_Of_1st_Month_Native)
                  OR   (PAYCAL22.PAY_BEGIN_DT  <= $12th_Of_2nd_Month_Native AND PAYCAL22.PAY_END_DT >= $12th_Of_2nd_Month_Native)
                  OR   (PAYCAL22.PAY_BEGIN_DT  <= $12th_of_3rd_month_Native AND PAYCAL22.PAY_END_DT >= $12th_of_3rd_month_Native) )

!             AND ( ($12th_Of_1st_Month_Native BETWEEN PAYCAL22.PAY_BEGIN_DT
!                                            AND PAYCAL22.PAY_END_DT)
!                OR   ($12th_Of_2nd_Month_Native BETWEEN PAYCAL22.PAY_BEGIN_DT
!                                            AND PAYCAL22.PAY_END_DT)
!                OR   ($12th_of_3rd_month_Native BETWEEN PAYCAL22.PAY_BEGIN_DT
!                                            AND PAYCAL22.PAY_END_DT) )
!---------------------------------------------------------------------------------------------------------- 
              AND PSPC1.COMPANY       = PAYCAL22.COMPANY
              AND PSPC1.PAYGROUP      = PAYCAL22.PAYGROUP
              AND PSPC1.PAY_END_DT    = PAYCAL22.PAY_END_DT
 
 
              #ifdef INCLUDE_ON_AND_OFF_CYCLE_FOR_COUNTS
              AND PSPC1.OFF_CYCLE  <> ' '
              #endif
 
              #ifdef INCLUDE_ON_CYCLE_FOR_COUNTS_ONLY         !default
              AND PSPC1.OFF_CYCLE <> 'Y'
              #endif
 
              #ifdef INCLUDE_MATCHING_CHECK_DATES_FOR_COUNTS  !JCP Test
              AND  ( PSPC1.CHECK_DT = PAYCAL22.CHECK_DT )
              #endif
 
              AND PSPC1.PAYCHECK_STATUS = 'F'
              AND PSPC1.PAYCHECK_OPTION <> 'R'
 
          #if {SITE_ID} = 'SRC1'
              AND PAYCAL22.PAY_OFF_CYCLE_CAL = 'N'
              AND PSPC1.TOTAL_GROSS > 0
              [$PSPC1.EMPLID]                        !%%2%%
          #endif
 
          #ifdef TEST_EMPLID
              AND PSPC1.EMPLID = '{TEST_EMPLID}'
          #endif
 
         #ifdef EMPLIDS_TO_INCLUDE
           AND PSPC1.{EMPLIDS_TO_INCLUDE}
         #endif
 
         #ifdef TEST_EMPLID_IN_RUN_CONTROL
              #ifdef MVS
                \$SelectEmplidSelection_MC\
              #else
                [$SelectEmplidSelection_MC]
              #endif
          #endif
 
!       ORDER BY PSPC1.COMPANY, PSPC1.EMPLID, PSPC1.PAY_END_DT
 
  #ifdef SELECT_WITH_UR
   {SELECT_WITH_UR} with ur
  #endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Populate-Worked-In-Months-Flags' to $debug-proc1
     move 'PS_PAY_CHECK'    to $debug-table1
     do log-delta-time
  #endif
 
  if $Prior_PC_Emplid <> ''
     do Ins-Temp
  end-if
 
end-procedure
 
begin-procedure Ins-Temp
 
  if rtrim($Tax_Locality,' ') = ''
     move '-' to $Tax_Locality
  end-if
 
 begin-sql on-error=temp-ins-error
 
  INSERT INTO {PBZQTR_TEMP_TABLE}
          (COMPANY,            !key
           EMPLID,             !key
           STATE,              !key
           TAX_CLASS,          !key
           LOCALITY,           !key
           PERIOD_COUNT )      !key
 
       VALUES ($PSPC.Company,
               $PSPC.Emplid,
               $Tax_State,
               $Tax_Tax_Class,
               $Tax_Locality,
               #Period_Count)
 
end-sql
 
      add 1 to #temp_records
 
      if mod(#temp_records,5000) = 0
         do Get-Current-DateTime
         #debugd show '----> Init Status: {PBZQTR_TEMP_TABLE} Record Count... ' #temp_records '  --> ' $AsOfNow
      end-if
 
end-procedure
 
begin-procedure temp-ins-error
 
   if #temp_records = 0
       #debugd show 'Temp Insert Error.  Check Table structure: {PBZQTR_TEMP_TABLE}'
       stop
   end-if
 
end-procedure
 
!********************************************************************* !
!----------------------------------------------------------------------!
! Procedure: Get-Worked-In-Months-Flags                                !
!----------------------------------------------------------------------!
begin-procedure Get-Worked-In-Months-Flags
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 
  let $Month1_Worked = 'N'
  let $Month2_Worked = 'N'
  let $Month3_Worked = 'N'
 
 if   ($state_trimmed <> '$U' and ($class_trimmed = 'U' or $Class_trimmed = 'S'))
   or ($state_trimmed = '$U' and $class_trimmed = 'H')  !10/24/2011 added for MasterTax for FIT
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
begin-SELECT
TEMP1.LOCALITY
TEMP1.PERIOD_COUNT
 
     if rtrim(&TEMP1.LOCALITY,' ') = '-'  !need to account for some non null char in this key field
       move '' to $Temp1.locality
     else
       move &TEMP1.LOCALITY to $Temp1.locality
     end-if
 
     if rtrim($Temp1.locality,' ') = $local_trimmed
 
 
      if &TEMP1.PERIOD_COUNT = 1
        let $Month1_Worked = 'Y'
      end-if
      if &TEMP1.PERIOD_COUNT = 2
        let $Month2_Worked = 'Y'
      end-if
      if &TEMP1.PERIOD_COUNT = 3
        let $Month3_Worked = 'Y'
      end-if
 
     end-if
 
   #ifdef SUBTOTAL_FEIN_EXTRACT
     FROM  {PBZQTR_TEMP_TABLE} TEMP1 {NOLOCK_SQL}, PS_COMPANY_TBL CO4 {NOLOCK_SQL}
     WHERE    TEMP1.COMPANY    = CO4.COMPANY
          AND TEMP1.EMPLID     = $Current_Emplid
          AND TEMP1.STATE      = $state_trimmed
          AND TEMP1.TAX_CLASS  = $class_trimmed
          AND CO4.FEDERAL_EIN  = #Current_FEIN
          AND CO4.EFFDT = (SELECT MAX(EFFDT)
            FROM   PS_COMPANY_TBL {NOLOCK_SQL}
            WHERE  COMPANY = CO4.COMPANY
              AND  EFFDT  <= $AsOfDate)
 
   #else  !added 04/14/2011
     #ifdef SUBTOTAL_ADP_COMPID_EXTRACT
     FROM  {PBZQTR_TEMP_TABLE} TEMP1 {NOLOCK_SQL}, PS_TF_COMPANY_XREF CO4 {NOLOCK_SQL}
     WHERE    TEMP1.COMPANY    = CO4.COMPANY
          AND TEMP1.EMPLID     = $Current_Emplid
          AND TEMP1.STATE      = $state_trimmed
          AND TEMP1.TAX_CLASS  = $class_trimmed
          AND CO4.TF_COMPANY   = $Current_ADP_Compid
          AND CO4.EFFDT = (SELECT MAX(EFFDT)
            FROM   PS_TF_COMPANY_XREF {NOLOCK_SQL}
            WHERE  COMPANY = CO4.COMPANY
              AND  EFFDT  <= $AsOfDate)
     #else
       FROM  {PBZQTR_TEMP_TABLE} TEMP1 {NOLOCK_SQL}
       WHERE     TEMP1.COMPANY    = $Current_Company
             AND TEMP1.EMPLID     = $Current_Emplid
             AND TEMP1.STATE      = $state_trimmed
             AND TEMP1.TAX_CLASS  = $class_trimmed
     #endif
   #endif
 
  #ifdef SELECT_WITH_UR
   {SELECT_WITH_UR} with ur
  #endif
end-select
 
   if $SelectEmplid <> ''
      show '  get-worked-in-months-flags M1,M2,M3 =' $Month1_Worked $Month2_Worked $Month3_Worked ' for ' $State_trimmed $class_trimmed
   end-if
 
 end-if
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Worked-In-Months-Flags' to $debug-proc1
     move 'PBZQTR_TEMP'    to $debug-table1
     do log-delta-time
 #endif
 
 
end-procedure
 
#endif  !using temp table
 
#ifdef DETERMINE_MONTHLY_COUNTS_BASED_ON_TAX_BALANCES
begin-procedure Get-Worked-In-Months-Flags-Based-on-Balances
 
BEGIN-SELECT
CNTB.BALANCE_PERIOD
CNTB.NLGRS_QTD
CNTB.TXGRS_QTD
 
     if $SelectEmplid <> ''
      show 'Get-Worked-In-Months-Flags-Based-on-Balances: ' $State_Trimmed $Class_Trimmed ', Period: ' &CNTB.BALANCE_PERIOD ', NLGRS = ' &CNTB.NLGRS_QTD edit 999,999,999.99 ', TXGRS = ' &CNTB.TXGRS_QTD edit 999,999,999.99
     end-if
 
     let #CNTB_Wages = &CNTB.NLGRS_QTD
     if $Class_Trimmed = 'H'
       let #CNTB_Wages = &CNTB.TXGRS_QTD
     end-if
 
     if &CNTB.BALANCE_PERIOD = #Month1 and #CNTB_Wages > 0
       let $Month1_Worked = 'Y'
     end-if
     if &CNTB.BALANCE_PERIOD = #Month2 and #CNTB_Wages > 0
       let $Month2_Worked = 'Y'
     end-if
     if &CNTB.BALANCE_PERIOD = #Month3 and #CNTB_Wages > 0
       let $Month3_Worked = 'Y'
     end-if
 
     FROM  PS_TAX_BALANCE CNTB
       WHERE  CNTB.EMPLID        = $Current_Emplid
         AND  CNTB.COMPANY       = $Current_Company
         AND  CNTB.STATE         = $State_Trimmed
         AND  CNTB.TAX_CLASS     = $Class_Trimmed
         AND  CNTB.BALANCE_ID    = $Calendar_Year_Id
         #ifdef USE_INT_CRITERIA
          AND CNTB.BALANCE_YEAR  = int(\$RptYearZ\) 
          AND CNTB.BALANCE_QTR   = int(\$RptQtrZ\) 
         #else
          AND CNTB.BALANCE_YEAR = #RptYear
          AND CNTB.BALANCE_QTR  = #RptQtr
         #endif
  
#ifdef SELECT_WITH_UR
 with ur
#end-if
end-select
 
     if $SelectEmplid <> ''
      show 'Get-Worked-In-Months-Flags-Based-on-Balances: complete --> ' $Month1_Worked $Month2_Worked $Month3_Worked
     end-if
 
end-procedure
#endif
 
#if {SITE_ID} = 'JCP1'
 
!********************************************************************* !
!----------------------------------------------------------------------!
! Procedure: Get-Worked-In-Months-Flags-JCP-Ret-Company                !
!            ******************************************                !
! For RET Company of JCP's, who only get earnings at month end...      !
!----------------------------------------------------------------------!
begin-procedure Get-Worked-In-Months-Flags-JCP-Ret-Company
 
  #ifdef show_selects
    #debugd show 'Processing JCP, RET PS_PAY_EARNINGS...'
  #endif
 
  let $Month1_Worked = 'N'
  let $Month2_Worked = 'N'
  let $Month3_Worked = 'N'
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
begin-SELECT
E3.EARNS_BEGIN_DT
E3.EARNS_END_DT
E3.PAY_END_DT
T3.STATE
T3.PAYGROUP
 
     Do Convert-to-DTU-Date(&E3.EARNS_END_DT, $EarnsEnd_DTU)
 
     if  ( ($EarnsEnd_DTU >= $12th_of_1st_Month_DTU) and
           ($EarnsEnd_DTU <= $Last_of_1st_Month_DTU) )
      let $Month1_Worked = 'Y'
 
     end-if
 
     if  ( ($EarnsEnd_DTU >= $12th_of_2nd_Month_DTU) and
           ($EarnsEnd_DTU <= $Last_of_2nd_Month_DTU) )
      let $Month2_Worked = 'Y'
     end-if
 
     if  ( ($EarnsEnd_DTU >= $12th_of_3rd_Month_DTU) and
           ($EarnsEnd_DTU <= $Last_of_3rd_Month_DTU) )
      let $Month3_Worked = 'Y'
 
     end-if
 
     !-----------------------------------------------------------------------------
     !note, this logic will NOT pull data for someone unless they have a job record
     !effective dated less than or equal to the check date we're accessing
     !-----------------------------------------------------------------------------
 
     FROM    PS_PAY_EARNINGS{WAREHOUSE_SUFFIX}     E3,
             PS_PAY_TAX{WAREHOUSE_SUFFIX}          T3                      !added 5/18/00
 
   WHERE   E3.COMPANY          = $Current_Company
     AND   E3.EMPLID           = $Current_Emplid
     AND   E3.PAY_LINE_STATUS  IN ('C','F')        !may want to change: IN ('C','F') ---> = 'F'
 
     AND   ( ((E3.EARNS_END_DT >= $12th_Of_1st_Month_Native) AND
              (E3.EARNS_END_DT <= $Last_of_1st_Month_Native))
        OR   ((E3.EARNS_END_DT >= $12th_Of_2nd_Month_Native) AND
              (E3.EARNS_END_DT <= $Last_of_2nd_Month_Native))
        OR   ((E3.EARNS_END_DT >= $12th_Of_3rd_Month_Native) AND
              (E3.EARNS_END_DT <= $Last_of_3rd_Month_Native)) )
 
          AND     T3.COMPANY          = E3.COMPANY      !added 5/18/00, to only pull in
          AND     T3.PAYGROUP         = E3.PAYGROUP     !worksite counts for SUI
          AND     T3.PAY_END_DT       = E3.PAY_END_DT
          AND     T3.OFF_CYCLE        = E3.OFF_CYCLE
          AND     T3.{pg}             = E3.{pg}
          AND     T3.{ln}             = E3.{ln}
          AND     T3.SEPCHK           = E3.SEPCHK
          AND     T3.STATE            = $State_Trimmed
          AND     T3.LOCALITY         = ' '
          AND     T3.TAX_CLASS        = 'U'
 
  #ifdef SELECT_WITH_UR
   {SELECT_WITH_UR} with ur
  #endif
end-select
 
!#ifndef STRIPPED_PBZQTR_REPORT
  if $RptDetail = 'Y'
   if $skip_report_detail <> 't'
     print 'Worked in Months Flags for EMPLID '  (+1,1)
     print  $Current_Emplid                      ()
     print ': (Month1 Month2 Month3) '           ()
     print $Month1_Worked                        ()
     print $Month2_Worked                        ()
     print $Month3_Worked                        ()
   else
    let $skip_report_detail = 'f'
   end-if
  end-if
!#endif
 
end-procedure
 
#endif  !JCP
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Extract-Resident-Code                                     !
! Desc:      This procedure extracts an Employee's Resident code       !
!            I need to check this table out!
!----------------------------------------------------------------------!
begin-procedure Extract-Resident-Code
 
  #ifdef show_selects
    #debugd show 'Processing PS_LOCAL_TAX_DATA...'
  #endif
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT         !Loops = 1
LD.EMPLID
LD.STATE
LD.RESIDENT
LD.LOCALITY
LD.COMPANY
 
   if $SelectEmplid <> ''
      #debugd show 'Extract-Resident-Code: for '  $TaxBalance_State ' ' $TaxBalance_Locality ' --> ' &LD.RESIDENT
   end-if
   let $Resident = &LD.RESIDENT
 
  #if {SITE_ID} = 'ALC1'
    if ($TaxBalance_State = 'KY') AND (rtrim($TaxBalance_Locality,' ') = '48000A')
       let $Resident = ' '
       if rtrim($tax_location_cd,' ') = 'KYLSV001'    !anyone in this tax location cd is a RESIDENT
         let $Resident = 'Y'
       end-if
    end-if
  #endif
 
  !--------------------------------------------------------------------------------
  !JCP: add a new section to the report
  !emplid, name, locality, resident status as of last day of quarter
  !of people who had resident status change during the year
  !--------------------------------------------------------------------------------
 
  FROM PS_LOCAL_TAX_DATA LD {NOLOCK_SQL}
    WHERE LD.EMPLID       = $Current_Emplid
      AND LD.COMPANY      = $Current_Company
      AND LD.STATE        = $TaxBalance_State
      AND LD.LOCALITY     = $TaxBalance_Locality
      AND LD.EFFDT=(SELECT MAX(EFFDT)
       FROM   PS_LOCAL_TAX_DATA {NOLOCK_SQL}
       WHERE  EMPLID   = $Current_Emplid
         AND  COMPANY  = $Current_Company
         AND  STATE    = $TaxBalance_State
         AND  LOCALITY = $TaxBalance_Locality
         AND  EFFDT   <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
   #ifndef SKIP_RESIDENT_AUDIT
     do check-resident-change  !new 2/28/7
   #endif
 
end-procedure
 
!----------------------------------------------------------------------!
! Procedure: Init-job-data                                             !
! Desc:      This procedure inits the job-data                         !
!----------------------------------------------------------------------!
begin-procedure Init-Job-Data
 
 move 'N' to $Corp_Officer
 move 'N' to $Seasonal_Worker
 move ' ' to $Worksite_cd
 move ' ' to $Input_Jobcode
 move ' ' to $Occup_Title
 move ' ' to $Occup_Code
 move ' ' to $wc_code
 move ' ' to $Current_Paygroup
 move ' ' to $WrkComp_Code
 move ' ' to $Location
 move ' ' to $Tax_Location_cd
 move ' ' to $Paygroup_LLC_Field
 move ' ' to $Empl_status
 move ' ' to $Job_record_retrieved
 move ' ' to $Job_paygroup
 move ' ' TO $Area_Code_AK
 move ' ' to $Setid_loc
 move ' ' to $DeptID
 move ' ' to $JOB_Deptid 
 move ' ' to $Job_Employment_type
 move ' ' to $Job_Acct_Cd
 move ' ' to $JOB_SETID
 move 0   to #Job_empl_rcd
 move ' ' to $hourly_rt
 move ' ' to $JOB_UNION_CD
 move ' ' to $EstabID
 move ' ' to $Job_FICA_Status
 move ' ' to $SAL_ADMIN_PLAN
 move ' ' to $full_part_time
 move ''  to $job_business_unit
 
 let $IA_Current_Paygroup = ' '
 
 #if {SITE_ID} = 'HWL1'
  move ' ' to $h_location
 #endif
 move ' ' to $Officer_Cd
 
 #if {PeopleSoft_Version} >= '8.9'
  move ' ' to $Personal_Orig_Hire_DTU
  move ' ' to $Personal_Orig_Trm_DTU
 #endif
 
 let #Std_Hours = 40
 let #Comprate = 0
 
end-procedure
 
!----------------------------------------------------------------------!
! Procedure: Get-job-data                                              !
! Desc:      This procedure gets the job-data at the end of the qtr    !
!            last worked in this quarter                               !
!----------------------------------------------------------------------!
begin-procedure Get-Job-Data
 
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
BEGIN-SELECT
JB.OFFICER_CD   !if = C,D,O then a corporate big wig
JB.EMPL_CLASS   !if G then a temp/seasonal employee
JB.JOBCODE      !6 chars (lookup into JOBCODE_TBL for Job DESCR)
JB.PAYGROUP
JB.COMPANY
JB.BUSINESS_UNIT
JB.STD_HOURS
JB.STD_HRS_FREQUENCY
JB.COMPRATE
JB.EMPL_STATUS
JB.TAX_LOCATION_CD
JB.LOCATION
JB.EMPL_TYPE
JB.HOURLY_RT
JB.EFFDT
JB.EFFSEQ
JB.{emp_rec}
JB.DEPTID
JB.SETID_JOBCODE
JB.ESTABID
JB.SAL_ADMIN_PLAN
JB.FULL_PART_TIME
#if {SITE_ID} = 'MAC1'
JB.UNION_CD
#endif
JB.FICA_STATUS_EE
#if {SITE_ID} = 'PRD1'
JB.ACCT_CD
JB.Employment_type
#endif
#if {SITE_ID} = 'PFZ1'
JB.REG_TEMP
#endif
#if {Peoplesoft_Version} >= '8'
JB.SETID_LOCATION
#endif
#if {PeopleSoft_Version} >= '8.9'
JB.HIRE_DT
JB.TERMINATION_DT
#endif
#if {SITE_ID} = 'HWL1'
#if {PeopleSoft_Version} = '8'
JB.{Client_Field_Prefix}SITE_LOC_ID{Client_Field_Suffix}
  let $h_location = &JB.{Client_Field_Prefix}SITE_LOC_ID{Client_Field_Suffix}
#else
  let $h_location = &JB.LOCATION
#endif
#endif
 
   move 'T' to $Job_record_retrieved
 
  #if {PeopleSoft_Version} >= '8.9'
    if rtrim(&JB.HIRE_DT,' ') <> ''
     Do Convert-to-DTU-Date(&JB.HIRE_DT, $Personal_Orig_Hire_DTU)
    end-if
    if rtrim(&JB.TERMINATION_DT,' ') <> ''
     Do Convert-to-DTU-Date(&JB.TERMINATION_DT, $Personal_Orig_Trm_DTU)
    end-if
  #endif
 
  #if {SITE_ID} = 'PRD1'
   let $job_acct_cd         = rtrim(&JB.ACCT_CD,' ')
   let $Job_Employment_type = rtrim(&JB.Employment_type,' ')
  #endif
 
  let $SAL_ADMIN_PLAN  = rtrim(&JB.SAL_ADMIN_PLAN,' ')  !10/25/2011 added for GE01
 
  #if {SITE_ID} = 'MAC1'
   let $JOB_UNION_CD         = rtrim(&JB.UNION_CD,' ')
  #endif
 
  let $officer_cd = rtrim(&JB.OFFICER_CD,' ')
  if $officer_cd   = 'C'  OR  !Chairman
       $officer_cd = 'D'  OR  !Director
       $officer_cd = 'O'  OR  !Officer
       $officer_cd = 'V'  OR  !VP
       $officer_cd = 'P'      !Pres
     let $Corp_officer = 'Y'
  else
     let $Corp_Officer = 'N'
  end-if
 
  #if {SITE_ID} = 'PFZ1'
     do PFE-Corp-Officer-Selection
  #endif
 
   if rtrim(&JB.EMPL_CLASS,' ') = 'G'
     let $Seasonal_Worker = 'Y'
   else
     let $Seasonal_Worker = 'N'
   end-if
 
   if rtrim(&JB.FULL_PART_TIME,' ') = 'F'
     let $full_part_time = 'F'
   else
     let $full_part_time = 'P'
   end-if
 
   #if {SITE_ID} = 'PFZ1'
     if  rtrim(&JB.REG_TEMP,' ')   = 'T'
       do PFE-Get-Reg-Temp-Class
       if rtrim($Z_Reg_Temp_Class,' ') = '003' or
          rtrim(&JB.EMPL_CLASS,' ') = ''
         let $Seasonal_Worker = 'Y'
       else
         let $Seasonal_Worker = 'N'
       end-if
     else
       let $Seasonal_Worker = 'N'
     end-if
   #endif
 
   let $Empl_Type     = rtrim(&JB.EMPL_TYPE,' ')
   let $Deptid        = rtrim(&JB.DEPTID,' ')
   let $JOB_Deptid    = rtrim(&JB.DEPTID,' ')
   let $Empl_status   = rtrim(&JB.EMPL_STATUS,' ')
   let $JOB_SETID     = rtrim(&JB.SETID_JOBCODE,' ')
   let $Job_FICA_Status = rtrim(&JB.FICA_STATUS_EE,' ')
   let $Job_FICA_Status_KMT1 = $Job_FICA_Status
   let #Job_empl_rcd = &JB.{emp_rec}
 
   #if {SITE_ID} = 'EOP1' !10/24/05 --> paygroup is 'BWE', the employee is salaried. Otherwise the employee is hourly.
     if rtrim(&JB.PAYGROUP,' ') = 'BWE'
       let $Empl_Type   = 'S'
     else
       let $Empl_Type   = 'H'
     end-if
   #endif
 
   !20150720 - Hourly rate for all associates, not just hourly.  The hourly rate is always valid
   let #Hourly_rt = &JB.HOURLY_RT

   if $Empl_Type = 'H'
     #if {SITE_ID} = 'WFG1'
       or $Empl_Type = 'E'                   !wells custom - add 'E'
      let $Empl_Type   = 'H'
     #endif
!     let #Hourly_rt = &JB.HOURLY_RT
   else
     let $Empl_Type = 'S'                  !9/21/01 force to 'S' if not 'H'
     let #Hourly_rt = 0
   end-if
 
  
   #if {SITE_ID} = 'AMN1'
    if &JB.COMPRATE <> 0
     !Comprate is always a monthly frequency...
      let #Hourly_Rt = (&JB.COMPRATE * 12) / 2080
    end-if
   #endif
 
   #ifdef CUSTOM_HOURLY_RT
      do custom-hourly-rt  !set the #Hourly_Rt variable for $Current_Emplid
   #endif
   
   let #t =  #Hourly_rt * 10000   !$112.345 / hr ---> 1123450
   do Format-Number(#t, $Hourly_rt,   '9999999999')
 
   if (&JB.STD_HOURS > 0)
     let #Std_Hours = &JB.STD_HOURS
   end-if
 
   #if {SITE_ID} = 'AXA1'
    if #Std_hours <= 1   !(AXA, sets this to 1 for commisioned Salesmen...)
       let #Std_hours = 36.25
    end-if
   #endif
 
   #if {SITE_ID} = 'AGI1'
    if #Std_hours = 10       !1/5/2010 per client request
       let #Std_hours = 40
    end-if
   #endif
 
   #if {SITE_ID} = 'RSI1'
       let #Std_hours = 40  !takes care of BiWeekly and Weekly associates
   #endif
 
   let $Current_Paygroup = rtrim(&JB.PAYGROUP,' ')
   let $Input_Jobcode    = rtrim(&JB.JOBCODE,' ')
   let #Comprate         = &JB.COMPRATE
 
   let $Location        = rtrim(&JB.LOCATION,' ')
   #if {Peoplesoft_Version} >= '8'
     let $Setid_loc       = rtrim(&JB.SETID_LOCATION,' ')
   #endif
   let $Tax_Location_cd = rtrim(&JB.TAX_LOCATION_CD,' ')
   let $Job_Paygroup    = rtrim(&JB.PAYGROUP,' ')
 
   let $IA_Current_Paygroup = rtrim(&JB.PAYGROUP,' ')
   let $Job_Business_Unit = rtrim(&JB.BUSINESS_UNIT,' ')
 
 
   #ifdef USE_LOCATION_CD
    #ifdef USE_SETID_LOCATION
     let $Worksite_cd  = $Setid_loc || '-' || $Location
    #else
     let $Worksite_cd  = $Location
    #endif
   #else
     #ifdef USE_DEPTID_CD                             !For JCP, Use the DEPTID (Store Unit #) as the worksite id
       let $Worksite_cd  = $Location
     #else
      #ifdef USE_DEPTID_FOR_WORKSITE
        #if {SITE_ID} = 'SCR1'
         move $deptid to $deptidcd
         do get-SCR1-rollup-deptid
         let $worksite_cd = rtrim($Main_Deptid,' ')
        #else
         let $Worksite_cd = $Deptid
        #endif
      #else
       let $Worksite_cd  = $Tax_Location_cd
      #endif
    #endif
   #endif
 
   #if {SITE_ID} = 'JCP1'
      let $first_char_worksite = substr($Worksite_cd,1,1)
      if $first_char_worksite = 'A'
        let $Worksite_cd = '0' || substr($Worksite_cd,2,length($Worksite_cd)-1)
      end-if
   #endif
 
   let $EstabID     = rtrim(&JB.ESTABID,' ')
   #ifdef USE_ESTABID
     let $Worksite_cd = $EstabID
   #endif
 
   #ifdef USE_STATE_WIDE_WORKSITE_CD  !08262013 reworked MLN1
        if rtrim($Worksite_cd,' ')   =  rtrim('{USE_STATE_WIDE_WORKSITE_CD}',' ')
         let $Worksite_cd = rtrim('{USE_STATE_WIDE_WORKSITE_CD}',' ')
         show 'In Get-Job. Emplid, State-Wide ({USE_STATE_WIDE_WORKSITE_CD}) associate:  ' $Current_Emplid ', Company '$C_Company ' Worksite --> ' $worksite_cd
        end-if
   #endif
 
   if $SelectEmplid <> ''
       add 1 to #SelectEmplid_JOB_Retrieve
       show #SelectEmplid_JOB_Retrieve edit 999 '. Job Data Retrieved --> '
       show '     Emplid ' $Current_Emplid ', Company '&JB.COMPANY ' Location ' $location ' Tax Location ' $Tax_Location_cd ' Worksite ' $worksite_cd ' BusUnit ' $Job_Business_Unit
       show '     Paygrp ' $Current_Paygroup ', EstabID '$EstabID ' JobCode ' $Input_Jobcode ' Effdt ' &JB.EFFDT ' Empl_type ' $Empl_type ' Empl_status ' $empl_status ' empl rcd ' #Job_empl_rcd edit 999
       show '     HireDt ' $Personal_Orig_Hire_DTU ', TermDt ' $Personal_Orig_Trm_DTU
   end-if
 
  from  PS_JOB JB {NOLOCK_SQL}
 
  Where JB.EMPLID     = $Current_Emplid
 
    #if {SITE_ID} <> 'AXA1'
     #if {SITE_ID} <> 'HWL1'   ! 'ALLSIG'
      #if {SITE_ID} <> 'LAN1'
       #if {SITE_ID} <> 'ACS1'
        AND JB.COMPANY  = $C_Company
       #endif
      #endif
     #endif
    #endif
 
    #if {SITE_ID} = 'TUH1'            !3/18/2010 per Tanesha
       AND JB.PAYGROUP > ' '
    #endif
 
    #if {SITE_ID} = 'CMG1'  !5/1/08
       AND JB.PER_ORG = 'EMP'
    #endif
 
    #if {SITE_ID} = 'EXE1'  !12/12/16
        AND JB.PER_ORG = 'EMP'
    #endif
 
    #ifdef PRIMARY_JOBS_ONLY
      AND JB.JOB_INDICATOR = 'P'
    #endif
 
    AND JB.EFFDT =
      (SELECT MAX(JB1.EFFDT)
       FROM   PS_JOB JB1 {NOLOCK_SQL}
       WHERE JB1.EMPLID    = JB.EMPLID
         AND JB1.COMPANY   = JB.COMPANY
         #if {SITE_ID} = 'TUH1'
          AND JB1.PAYGROUP = JB.PAYGROUP
         #endif
         !AND JB1.{emp_rec} = JB.{emp_rec}      !11/6/08 commented out
         !AND JB1.EFFDT <= $Personal_AsOfDate)  !10/23/08... or, (PWC)
         AND JB1.EFFDT <= $Qtr_End_Native)
         AND JB.EFFSEQ =
          (SELECT MAX(JB2.EFFSEQ)
           FROM  PS_JOB JB2 {NOLOCK_SQL}
           WHERE JB2.EMPLID   = JB.EMPLID
            AND JB2.COMPANY   = JB.COMPANY
            !AND JB2.{emp_rec} = JB.{emp_rec}   !11/6/08 commented out
            AND JB2.EFFDT     = JB.EFFDT)
 
   #if {SITE_ID} = 'AXA1'
     AND JB.COMPANY || '' = $C_Company
   #endif
 
   #if {SITE_ID} = 'LAN1'
     AND JB.COMPANY||NULL  = $C_Company
     AND JB.{emp_rec} = 0
   #endif
 
   #if {SITE_ID} = 'WKN1'  !1/26/2012
     AND JB.{emp_rec} = 0
   #endif
 
   #if {SITE_ID} = 'AMN1'
    ORDER BY  JB.{emp_rec}, JB.EFFDT, JB.EFFSEQ
   #else
     #if {SITE_ID} = 'SCM1'
       ORDER by JB.{emp_rec} DESC
     #else
       #if {SITE_ID} = 'MIB1'
         ORDER by JB.EFFDT, JB.EFFSEQ, JB.{emp_rec}             !10/7/10 added the JB.{emp_rec}
       #else
         ORDER by JB.EFFDT, JB.EFFSEQ
       #endif
     #endif
   #endif
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select

  #ifdef SUBTOTAL_BUSINESS_UNIT_EXTRACT
    if rtrim($Job_Business_unit,' ') = ''
      add 1 to #Job_Business_unit_warning
      show #Job_Business_unit_warning edit 999999 '. Warning: blank business unit for ' $current_emplid ' = ' $Job_Business_unit ' setting to emplid ' $Current_Emplid
      let $Job_Business_unit = $Current_Emplid
    end-if
  #endif
 
#ifndef STRIPPED_PBZQTR_REPORT
 if $Job_record_retrieved <> 'T'
 
        if (#Missing_Qtr_Data_count < {MISSING_QTR_DATA_LIMIT})
          Put $C_Company                              -
              $Current_Emplid                               -
               'Missing Job Data'                            -
           Into Missing_Qtr_Data(#Missing_Qtr_Data_count)   -
              Company                                       -
              Emplid
              Message
          add 1 to #Missing_Qtr_Data_count
        end-if
 end-if
#endif
 
 #ifdef show_selects
    #debugd show '...finished PS_JOB Select...'
 #endif
 
end-procedure
 
#ifdef USE_UI_RPT_CD_FOR_MN_MI_LOCATION
 
!***********************************************************************
begin-procedure Get-Rpt-Unit-Number       ! Called to get UI_RPT_CODE (5 chars) into extract
!***********************************************************************
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 move ' ' to $UiRptCode
 move '00000' to $UiRptCode5
 
 if $State_trimmed = 'NM'
  move '{NM_UI_LOCATION_DFLT}' to $UiRptCode5
 end-if
 
 let $uirptcd_read = 'f'
 
begin-SELECT
U.UI_RPT_CODE
#ifdef USE_EMPLOYER_ID_EXT_FOR_MN_MI
U.EMPLOYER_ID_EXT
#endif
 
 #ifdef USE_EMPLOYER_ID_EXT_FOR_MN_MI
  move &U.EMPLOYER_ID_EXT to $UiRptCode
 #else
  move &U.UI_RPT_CODE to $UiRptCode
 #endif
 
  #ifdef USE_UI_RPT_CODE_FOR_OTHER_STATES
    #if {SITE_ID} <> 'SUR1'
      move &U.UI_RPT_CODE to $UiRptCode
    #else
      if $State_trimmed <> 'MN'
        move &U.UI_RPT_CODE to $UiRptCode
      end-if
    #endif
  #endif
 
 do Convert-UiRptCode
 let $uirptcd_read = 't'
 
!10/9/2013 - add subquery to make sure UI Location query (PS_CO_UI_RPTCD_TBL) ties to the right state
!-----------------------------------------------------------------
 #ifdef USE_LOCATION_CD
  FROM PS_CO_UI_RPTCD_TBL U {NOLOCK_SQL}, PS_LOCATION_TBL UI9 {NOLOCK_SQL}
 #else
  FROM PS_CO_UI_RPTCD_TBL U {NOLOCK_SQL}, PS_TAX_LOCATION1 UI9 {NOLOCK_SQL}
 #endif
   WHERE U.COMPANY  = $C_Company
   #ifdef USE_LOCATION_CD
        AND U.LOCATION = $location
   #else
        AND U.LOCATION = $tax_location_cd
   #endif
   #ifdef USE_LOCATION_CD
        AND U.LOCATION = UI9.LOCATION
   #else
        AND U.LOCATION = UI9.TAX_LOCATION_CD
   #endif
   AND UI9.STATE         = $state_trimmed
   AND U.EFFDT  =  (SELECT MAX(EFFDT)
       FROM PS_CO_UI_RPTCD_TBL {NOLOCK_SQL}
       WHERE COMPANY    = U.COMPANY
         AND LOCATION   = U.LOCATION
         AND EFFDT     <= $Qtr_End_Native )
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
   if $SelectEmplid <> ''
    if rtrim($uirptcd_read,' ') <> 't'
      show 'No UiRptCode retrieved for ' $C_Company ' $Tax_Location_cd ' $Tax_Location_cd ' $location ' $Location ' state ' $state_trimmed
    else
      show 'Retrieved UiRptCode for    ' $C_Company ' $Tax_Location_cd ' $Tax_Location_cd ' $location ' $Location ' state ' $state_trimmed ' ---> ' $UiRptCode ' ---> ' $UiRptCode5
    end-if
   end-if
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Rpt-Unit-Number' to $debug-proc1
     move 'PS_CO_UI_RPTCD_TBL'    to $debug-table1
     do log-delta-time
 #endif
 
end-procedure
 
!***********************************************************************
begin-procedure Convert-UiRptCode    !$UiRptCode --> $UiRptCode5
!***********************************************************************
 
  let $w = rtrim(translate($UiRptCode,'#&*-,./','       '),' ')
  unstring $w by ' ' into $w1 $w2 $w3 $w4 $w5
  string $w1 $w2 $w3 $w4 $w5 by '' into $w
  let #l = length($w)
  if #l < 5                           ! may have alpha
    let $UiRptCode5     = substr('00000',1,5 - #l) || $w
  else
    let $UiRptCode5     = substr($w,1,5)
  end-if
 
end-procedure
 
#endif
 
begin-procedure Get-Area-Code
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
   move '99' to $Area_Code_AK
   move '99' to $Area_Code_AK_default
 
  if $SelectEmplid <> ''
   #ifdef USE_GEO_CODE_FOR_AK_AREA_CODE
    #debugd show 'Get-Area-Code: using GEO CODE from PS_LOCATION_TBL for AK area code'
   #else
    #debugd show 'Get-Area-Code: using AK_AREA_CD from PS_LOCATION_TBL for AK area code'
   #endif
  end-if
 
 
begin-SELECT
L.AK_AREA_CD
L.GEO_CODE
 
  #ifdef USE_GEO_CODE_FOR_AK_AREA_CODE
    if rtrim(&L.GEO_CODE,' ') <> ''
      move &L.GEO_CODE to $Area_Code_AK
    end-if
  #else
    if rtrim(&L.AK_Area_Cd,' ') <> ''
      move &L.AK_Area_Cd to $Area_Code_AK
    end-if
  #endif
 
    if $SelectEmplid <> ''
     #debugd show 'Retrieved Area_Code_AK: '  $Area_Code_AK ' for Tax location code ' $TAX_LOCATION_CD
    end-if
 
 FROM  PS_TAX_LOCATION1 L {NOLOCK_SQL}
 WHERE L.TAX_LOCATION_CD = $TAX_LOCATION_CD
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
 
end-select
 
!NBC: Occupational Code to 272011 and the Geographic Code to 62
#if {SITE_ID} = 'GEC1'
  move '62' to $Area_Code_AK
#endif
 
 if rtrim($Area_Code_AK,' ') = ''
   let $Area_Code_AK = $Area_Code_AK_default
 end-if
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Area-Code' to $debug-proc1
     move 'PS_TAX_LOCATION1'    to $debug-table1
     do log-delta-time
 #endif
 
end-procedure
 
#if {CLIENT_ID} = 'SGB'  !Wyoming workers comp code
 
begin-procedure Get-Occupational-Data-SGB1
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 
 let $wc_code     = ''
 
begin-Select
sgwc.workers_comp_cd
 
    let $wc_code     = rtrim(&sgwc.workers_comp_cd,' ')
 
 From ps_job sgjob left outer join ps_sg_pos_workcomp sgwc on
  sgjob.position_nbr = sgwc.position_nbr
 
 Where sgjob.emplid = $Current_emplid
  and  sgjob.effdt = (Select max(sgb.effdt)
    From ps_job sgb
    Where sgjob.emplid = sgb.emplid
      and sgjob.empl_rcd = sgb.empl_rcd)
      and sgjob.effseq = (Select max(sgc.effseq)
      From ps_job sgc
       Where sgjob.emplid = sgc.emplid
         and sgjob.empl_rcd = sgc.empl_rcd
         and sgjob.effdt = sgc.effdt)
         and sgwc.effdt = (Select max(sgd.effdt)
          From ps_sg_pos_workcomp sgd
           Where sgwc.position_nbr = sgd.position_nbr
           and sgd.effdt <= sgjob.effdt)
 
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Occupational-Data-SGB1' to $debug-proc1
     move 'PS_JOB'    to $debug-table1
     do log-delta-time
 #endif
 
 
 end-procedure
 
#endif
 
#if {PeopleSoft_Version} = '8'
#if {SITE_ID} = 'HWL1'
begin-procedure Get-Occupational-Data-honeywell
 
 let $occup_code     = ''
 
Begin-Select
JTB.H_US_SOC_CD
 
    let $occup_code     = rtrim(&JTB.H_US_SOC_CD,' ')
 
  FROM PS_H_OCCUP_CD_TBL JTB
   WHERE JTB.STATE = $state_trimmed
     AND JTB.JOBCODE = $input_jobcode
 
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
#endif
#endif
 
#if {SITE_ID} = 'SIE1'
 
begin-procedure Get-Occupational-Data-SIE1
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 let $wc_code     = ''
 
Begin-Select
JTB.WORKERS_COMP_CD
 
    let $wc_code     = substr(&JTB.WORKERS_COMP_CD,1,6)
 
  FROM PS_JOB JTA, PS_JOBCODE_TBL JTB
  WHERE	JTA.EMPLID	= $Current_Emplid
    AND JTA.COMPANY	= $Current_Company
    AND JTA.EFFDT	= (SELECT MAX(A_ED.EFFDT) FROM PS_JOB A_ED
	WHERE JTA.EMPLID	= A_ED.EMPLID AND
              JTA.EMPL_RCD	= A_ED.EMPL_RCD   AND
  	      A_ED.EFFDT	<= $Qtr_End_Native)
         AND	JTA.EFFSEQ	= (SELECT MAX(A_ES.EFFSEQ) FROM PS_JOB A_ES
	WHERE JTA.EMPLID = A_ES.EMPLID AND
              JTA.EMPL_RCD	= A_ES.EMPL_RCD AND
              JTA.EFFDT		= A_ES.EFFDT)
	 AND 	JTB.JOBCODE	= JTA.JOBCODE
	 AND 	JTB.EFFDT	= (SELECT MAX(B_ED.EFFDT) FROM PS_JOBCODE_TBL B_ED
 
		WHERE JTB.SETID	= B_ED.SETID AND
		JTB.JOBCODE	= B_ED.JOBCODE AND
		B_ED.EFFDT	<= $Qtr_End_Native)
 
	 AND 	JTA.SETID_JOBCODE = JTB.SETID
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
 
 #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Occupational-Data-SIE1' to $debug-proc1
     move 'PS_JOB'    to $debug-table1
     do log-delta-time
 #endif
 
end-procedure
 
#endif
 
!----------------------------------------------------------------------     !
begin-procedure get-local-rate
 
     let #wc_rate = 0
     let #nonres_wc_rate = 0
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
begin-select
WCR.RESIDENT_TAX_RT
WCR.NONRESIDENT_TAX_RT
WCR.LOCALITY
 
      let #wc_rate        = &WCR.RESIDENT_TAX_RT
      let #nonres_wc_rate = &WCR.NONRESIDENT_TAX_RT
 
 FROM  PS_LOCAL_TAX_TBL WCR {NOLOCK_SQL}
 WHERE WCR.STATE      = $State_Trimmed
  AND WCR.LOCALITY    = $get_local_rate
  AND WCR.EFFDT =
      (SELECT MAX(EFFDT)
       FROM   PS_LOCAL_TAX_TBL {NOLOCK_SQL}
       WHERE  STATE    = WCR.STATE
         AND  LOCALITY = WCR.LOCALITY
         AND  EFFDT   <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Oth-Locality-for-Class-Code' to $debug-proc1
     move 'PS_LOCAL_TAX_TBL'    to $debug-table1
     do log-delta-time
  #endif
 
     let #t = #wc_rate * {WC_RATE_FACTOR}                !eg. .017 should be reported as '000017000', .0046 as '0000004600'
     do Format-Number(#t,$wc_rate,  '9999999999')
 
     if $SelectEmplid <> ''
       #debugd show 'get-local-rate: rate: ' #wc_rate ' converted to --> ' $wc_rate ' ' $State_Trimmed $get_local_rate
     end-if
 
end-procedure
!----------------------------------------------------------------------     !
 
#ifdef USE_OTH_LOCALITY_FOR_WY_CLASS_CODE           !Pier 1, May 18, 2007
 
begin-procedure Get-Oth-Locality-for-Class-Code
 
 let $wc_code     = ''
 
BEGIN-SELECT
WCA.OTH_LOCALITY_NAME
 
  let $wc_code = &WCA.OTH_LOCALITY_NAME
  #ifdef USE_OTH_LOCALITY_FOR_AK_Occup_Code
   let $occup_code = &WCA.OTH_LOCALITY_NAME
  #endif
 
  FROM PS_LOCAL_TAX_TBL WCA  {NOLOCK_SQL}
  WHERE   WCA.STATE = $State_trimmed
      AND WCA.EFFDT = (SELECT MAX(WCA1.EFFDT)
        FROM PS_LOCAL_TAX_TBL WCA1 {NOLOCK_SQL}
        WHERE WCA.STATE    = WCA1.STATE
          AND WCA.LOCALITY = WCA1.LOCALITY
          AND WCA1.EFFDT  <= $Qtr_End_Native)
end-select
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Oth-Locality-for-Class-Code' to $debug-proc1
     move 'PS_LOCAL_TAX_TBL'    to $debug-table1
     do log-delta-time
  #endif
 
end-procedure
 
#endif
 
!----------------------------------------------------------------------     !
! Procedure: Get-Occupational-Data                                          !
! Descr:     Get The Occupation code, and Title                             !
!                                                                           !
!----------------------------------------------------------------------     !
begin-procedure Get-Occupational-Data
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
 
 move '99-9999' to $Occup_Code
 move '99-9999' to $Occup_Code_default
 move ' ' to $occup_title
 move ' ' to $wc_code
 
 #if {SITE_ID} = 'BCD1'  !10/9/7 hardcoded occup code
     let $occup_code =  '41-4012'
 #endif
 
 if rtrim($Input_Jobcode,' ') = ''
   goto GetJobTlExit
 end-if
 
Begin-Select
JT.DESCR
JT.JOBCODE
JT.WORKERS_COMP_CD
JT.US_SOC_CD
#ifdef USE_JOB_PROFILE_ID_FOR_AK_OCCUP_CD
#if {SITE_ID} <> 'KPG1'
JT.JOB_PROFILE_ID
#else
' '                &JT.JOB_PROFILE_ID                   !KPMG Customization - 9.1 Upgrade
#endif
#endif
#ifdef USE_US_OCC_CD
JT.US_OCC_CD
#endif
 
  let $Occup_Title  = rtrim(&JT.DESCR,' ')
  let $Occup_Code   = rtrim(&JT.JOBCODE,' ')
 
  #ifdef USE_US_SOC_CD_for_AK_OCCUP_CODE
   let $Occup_Code     = substr(&JT.US_SOC_CD,1,20)
  #endif
 
  #ifdef USE_US_OCC_CD
   let $Occup_Code     = substr(&JT.US_OCC_CD,1,20)
  #endif
 
  #ifdef USE_JOB_PROFILE_ID_FOR_AK_OCCUP_CD
   let $Occup_Code     = substr(&JT.JOB_PROFILE_ID,1,20)
  #endif
 
    if $SelectEmplid <> ''
      #debugd show 'Get-Occupational-Data: record retrieved for jobcode ' $input_jobcode ', Occup_title = ' $occup_title ', code = ' $occup_code
    end-if
 
  let $WrkComp_Code = rtrim(&JT.WORKERS_COMP_CD,' ')
  let $Occup_Title  = substr($Occup_Title,1,20)
  let $Occup_Code   = substr($Occup_Code,1,20)    !5/7/01
 
  #ifdef USE_OTH_LOCALITY_FOR_WY_CLASS_CODE
      do Get-Oth-Locality-for-Class-Code
  #else
    #if {SITE_ID} = 'SIE1'
      do Get-Occupational-Data-SIE1
    #else
  ! Wells MC10162 - Begin
      #if {SITE_ID} = 'WFG1'
        do Get-Occupational-Data-Wells
      #else
  ! Wells MC10162 - End
      #ifdef USE_US_SOC_CD
        let $wc_code     = substr(&JT.US_SOC_CD,1,7)   !9/9/9 change to 7 due to '-' getting inserted and dropping last character
      #else
        let $wc_code     = substr($WrkComp_Code,1,7)
        #endif
      #endif
    #endif
  #endif
 
    if $SelectEmplid <> ''
      #debugd show 'Get-Occupational-Data: wc_code = ' $wc_code
    end-if
 
  FROM PS_JOBCODE_TBL JT {NOLOCK_SQL}
   WHERE JT.JOBCODE = $Input_Jobcode     AND
 
      #if {SITE_ID} = 'LAN1'
        JT.SETID = 'LWW'                 AND
      #else
        JT.SETID = $JOB_SETID            AND                 !4/6/7 DMonroe added for speed
      #endif
 
      #ifdef USE_JOBCODE_STATUS                              !1/30/8 DMonroe, we shouldn't care if it's active
      JT.EFF_STATUS = 'A'                AND                 !                this allows us to get jobcode for
      #endif                                                 !                a jobcode that's been deactivated
 
      JT.EFFDT=(SELECT MAX(EFFDT)
 
      FROM PS_JOBCODE_TBL JT1 {NOLOCK_SQL}
      WHERE JT1.JOBCODE = $Input_Jobcode AND
            JT1.SETID = JT.SETID         AND                 ! 4/6/7 DMonroe added for speed
            JT1.EFFDT <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
  ! -----------------------------------------------------------------------------
  #if {SITE_ID} = 'SCR1'
 
   if $State_trimmed = 'AK'
 
    if substr($Input_Jobcode,1,1) = '5'
     let $Occup_Code = '33-9032'
    else
 
     let $Input_Jobcode4 = substr($Input_Jobcode,1,4)
     evaluate $Input_Jobcode4
 
      when = '6200'
      when = '6239'
       let $Occup_Code = '43-3051'
       break
 
 
      when = '6216'
      when = '6217'
      when = '6218'
      when = '6220'
      when = '6229'
       let $Occup_Code = '43-4051'
       break
 
      when = '6248'
      when = '6602'
      when = '6606'
      when = '6660'
      when = '6230'
      when = '6603'
       let $Occup_Code = '11-3011'
       break
 
      when-other
       let $Occup_Code = '99-9999'
 
      end-evaluate
     end-if
    end-if
 
    if $SelectEmplid <> ''
     #debugd show 'Get-Occupational-Data, SCR1: reported occupational code (jobcode): ' $Occup_Code
    end-if
   #endif
 
   #if {PeopleSoft_Version} = '8'
    #if {SITE_ID} = 'HWL1'
      do Get-Occupational-Data-honeywell
    #endif
   #endif
 
   #if {CLIENT_ID} = 'SGB'
     if $State_trimmed = 'WY'
          do Get-Occupational-Data-SGB1
     end-if
   #endif
 
   #if {SITE_ID} = 'SSG1'
     if $State_trimmed = 'WY'
      let $Input_Jobcode3 = substr($Input_Jobcode,1,3)
      evaluate $Input_Jobcode3
      when = '252'
       let $wc_code = '621999'   ! or should it be '8833' ?
       break
      when-other
       break
      end-evaluate
     end-if
   #endif
 
  !8/20/7 added to format occup code
  !----------------------------------
  if $State_trimmed = 'AK'
   if rtrim($occup_code,' ') = ''
     let $occup_code = $Occup_Code_default
   else
     let #len_occup_cod    = length($Occup_Code)
     let #len_occup_cod_m2 = #len_occup_cod - 2
     let #pos_dash         = instr($Occup_Code,'-',1)
 
     if #pos_dash = 0
      !if no '-' .. insert it   123456 --> 12-3456
      !----------------------------------------------------
      let $Occup_Code = substr($Occup_Code,1,2) || '-' || substr($Occup_Code,3,#len_occup_cod_m2)
     end-if
 
     !strip out '.00'
     !----------------
     let #len_occup_cod    = length($Occup_Code)
     let #len_occup_cod_m2 = #len_occup_cod - 2
     let $dot_00_check     = substr($Occup_Code,#len_occup_cod_m2,3)
     if $dot_00_check = '.00'
       let $occup_code = substr($occup_code,1,#len_occup_cod_m2 - 1)
     end-if
     !-----------------
 
   end-if
  end-if
 
  !NBC: Occupational Code to 272011 and the Geographic Code to 62
  #if {SITE_ID} = 'GEC1'
    if $State_trimmed = 'AK'
       let $occup_code =  '27-2011'
       move '62' to $Area_Code_AK
    end-if
  #endif
 
  #if {SITE_ID} = 'MDT1'
    if $State_trimmed = 'AK'
       let $occup_code =  '41-9099'
       move '62' to $Area_Code_AK
    end-if
  #endif
 
  #if {SITE_ID} = 'BCD1'  !10/9/7 hardcoded occup code
       let $occup_code =  '41-4012'
  #endif
 
  #if {SITE_ID} = 'GEC1'
    if $State_trimmed = 'AK'
       let $occup_code =  '27-2011'
       move '62' to $Area_Code_AK
    end-if
  #endif
 
  #if {SITE_ID} = 'MAC1'  !12/20/07
       let $occup_code =  '31-9099'
       let $wc_code    =  '000020'
  #endif
 
  #if {SITE_ID} = 'VZN1'            !added 10/2/09
    if $State_trimmed = 'WY'
     if $Current_Company = '151'
        let $wc_code = '517110'
     end-if
 
     if $Current_Company = '001'
        let $wc_code = '517911'
     end-if
    end-if
  #endif
 
  #if {SITE_ID} = 'IRC1'            !added 10/2/09
    if $State_trimmed = 'WY'
     if rtrim($Input_jobcode,' ') = 'S022' OR rtrim($Input_jobcode,' ') = 'S020'
        let $wc_code = '811000'
     end-if
 
     if rtrim($Input_jobcode,' ') = 'S067'
        let $wc_code = '561000'
     end-if
    end-if
  #endif
 
   if $SelectEmplid <> ''
     #debugd show 'Occup Data for ' $Current_emplid ', Jobcode ' $Input_Jobcode ', Occup Title ' $occup_title ', Occup Code ' $occup_code ',  wc_code ' $wc_code ', SETID ' $JOB_SETID
    end-if
 
GetJobTlExit:
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Get-Occupational-Data' to $debug-proc1
     move 'PS_JOBCODE_TBL'    to $debug-table1
     do log-delta-time
  #endif
 
end-procedure
 
begin-procedure Sort-TaxBalance-Recap
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  let #balinx = 1
  while #balinx <= #Last_TaxTotal_Cnt
 
    !find least string
    !-------------------
    let #s = #balinx
    let $best_yet = 'ZZ'
    while #s <= #Last_TaxTotal_Cnt
     get $taxcode_test from TAXTOTAL(#s)    TaxTotal_Taxcode_sort
     if $taxcode_Test < $best_yet
       let #best_yet = #s
       let $best_yet = $taxcode_test
     end-if
     add 1 to #s
    end-while
 
    !save least into a holding location
    !-----------------------------------
    let #holding = 0
 
    get $TBalance_State        -
         $TBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TBalance_RESIDENT        -
         #endif
         $TBalance_Tax_Class       -
         $TBtaxcode_sort           -
         from TAXTOTAL(#best_yet)    -
             TaxTotal_State          -
             TaxTotal_Locality       -
             #ifdef LOCAL_RECIPROCITY
             TaxTotal_RESIDENT       -
             #endif
             TaxTotal_Tax_Class      -
             TaxTotal_Taxcode_sort
 
    Put $TBalance_State        -
         $TBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TBalance_RESIDENT        -
         #endif
         $TBalance_Tax_Class       -
         $TBtaxcode_sort           -
         Into TAXTOTAL(#holding)   -
           TaxTotal_State          -
           TaxTotal_Locality       -
           #ifdef LOCAL_RECIPROCITY
           TaxTotal_RESIDENT        -
           #endif
           TaxTotal_Tax_Class      -
           TaxTotal_Taxcode_sort
 
     let #L2 = 0
     While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
 
         get  #TBalance_Nlgrs_Qtd      -
              #TBalance_Txgrs_Qtd      -
              #TBalance_Tax_Qtd        -
              #TBalance_Nlgrs_Ytd      -
              #TBalance_Txgrs_Ytd      -
              #TBalance_Tax_Ytd        -
              #TBExcess_Qtd            -
              #TBExcess_Ytd            -
         from TaxTotal(#best_yet)         -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         put  #TBalance_Nlgrs_Qtd      -
              #TBalance_Txgrs_Qtd      -
              #TBalance_Tax_Qtd        -
              #TBalance_Nlgrs_Ytd      -
              #TBalance_Txgrs_Ytd      -
              #TBalance_Tax_Ytd        -
              #TBExcess_Qtd            -
              #TBExcess_Ytd            -
         into TaxTotal(#holding)            -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         Add 1 to #L2
 
      End-While
 
      !shift everything after balinx up one
      !------------------------------------
      let #count = #best_yet - 1
 
      while #count >= #balinx
        get $TBalance_State        -
         $TBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TBalance_RESIDENT        -
         #endif
         $TBalance_Tax_Class       -
         $TBtaxcode_sort           -
         from TAXTOTAL(#count)       -
             TaxTotal_State          -
             TaxTotal_Locality       -
             #ifdef LOCAL_RECIPROCITY
             TaxTotal_RESIDENT       -
             #endif
             TaxTotal_Tax_Class      -
             TaxTotal_Taxcode_sort
 
        let #so = #count + 1
 
        Put $TBalance_State        -
         $TBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TBalance_RESIDENT        -
         #endif
         $TBalance_Tax_Class       -
         $TBtaxcode_sort           -
         Into TAXTOTAL(#so)          -
           TaxTotal_State          -
           TaxTotal_Locality       -
           #ifdef LOCAL_RECIPROCITY
           TaxTotal_RESIDENT        -
           #endif
           TaxTotal_Tax_Class      -
           TaxTotal_Taxcode_sort
 
        let #L2 = 0
        While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
 
         get  #TBalance_Nlgrs_Qtd      -
              #TBalance_Txgrs_Qtd      -
              #TBalance_Tax_Qtd        -
              #TBalance_Nlgrs_Ytd      -
              #TBalance_Txgrs_Ytd      -
              #TBalance_Tax_Ytd        -
              #TBExcess_Qtd            -
              #TBExcess_Ytd            -
         from TaxTotal(#count)         -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         put  #TBalance_Nlgrs_Qtd      -
              #TBalance_Txgrs_Qtd      -
              #TBalance_Tax_Qtd        -
              #TBalance_Nlgrs_Ytd      -
              #TBalance_Txgrs_Ytd      -
              #TBalance_Tax_Ytd        -
              #TBExcess_Qtd            -
              #TBExcess_Ytd            -
         into TaxTotal(#so)            -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         Add 1 to #L2
 
        End-While
 
        let #count = #count - 1
 
      end-while
 
      !move from holding to the current index
      !---------------------------------------
      get $TBalance_State        -
         $TBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TBalance_RESIDENT        -
         #endif
         $TBalance_Tax_Class       -
         $TBtaxcode_sort           -
         from TAXTOTAL(#holding)    -
             TaxTotal_State          -
             TaxTotal_Locality       -
             #ifdef LOCAL_RECIPROCITY
             TaxTotal_RESIDENT       -
             #endif
             TaxTotal_Tax_Class      -
             TaxTotal_Taxcode_sort
 
      Put $TBalance_State        -
         $TBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TBalance_RESIDENT        -
         #endif
         $TBalance_Tax_Class       -
         $TBtaxcode_sort           -
         Into TAXTOTAL(#balinx)   -
           TaxTotal_State          -
           TaxTotal_Locality       -
           #ifdef LOCAL_RECIPROCITY
           TaxTotal_RESIDENT        -
           #endif
           TaxTotal_Tax_Class      -
           TaxTotal_Taxcode_sort
 
      let #L2 = 0
      While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
 
         get  #TBalance_Nlgrs_Qtd      -
              #TBalance_Txgrs_Qtd      -
              #TBalance_Tax_Qtd        -
              #TBalance_Nlgrs_Ytd      -
              #TBalance_Txgrs_Ytd      -
              #TBalance_Tax_Ytd        -
              #TBExcess_Qtd            -
              #TBExcess_Ytd            -
         from TaxTotal(#holding)         -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         put  #TBalance_Nlgrs_Qtd      -
              #TBalance_Txgrs_Qtd      -
              #TBalance_Tax_Qtd        -
              #TBalance_Nlgrs_Ytd      -
              #TBalance_Txgrs_Ytd      -
              #TBalance_Tax_Ytd        -
              #TBExcess_Qtd            -
              #TBExcess_Ytd            -
         into TaxTotal(#balinx)            -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         Add 1 to #L2
 
        End-While
 
     add 1 to #balinx
 
  end-while
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Sort-TaxBalance-Recap' to $debug-proc1
     move ' '    to $debug-table1
     do log-delta-time
  #endif
 
end-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Update-TaxBalance-Recap                                   !
! Desc:      This procedure Updates the PAYGROUP and COMPANY Recap     !
!            of Tax Balances for Balancing Report.                     !
!----------------------------------------------------------------------!
begin-procedure Update-TaxBalance-Recap
 
 #ifdef  enable_performance_monitor
    do Get-Current-Time
    move $display_dt to $display_dt0
 #endif
 
  Let #L1 = 1
  Let $MatchFound = 'N'
 
  while #L1 <= #LAST_TAXTOTAL_CNT
 
     get $TEST_ST                    -
         $TEST_LOCALITY              -
         #ifdef LOCAL_RECIPROCITY
         $TEST_RESIDENT              -
         #endif
         $TEST_TAX_CLASS             -
         from TAXTOTAL(#L1)          -
              TaxTotal_State         -
              TaxTotal_Locality      -
              #ifdef LOCAL_RECIPROCITY
              TaxTotal_RESIDENT      -
              #endif
              TaxTotal_Tax_Class
 
    if $Test_St =  $TaxBalance_State
     And $Test_Locality = $TaxBalance_Locality
     And $Test_Tax_Class = $TaxBalance_Tax_Class
     #ifdef LOCAL_RECIPROCITY
     And $TEST_RESIDENT = $TaxBalance_Resident
     #endif
 
         Let $MatchFound = 'Y'
         break
    End-if
    Add 1 to #L1
 
  end-while
 
  !new balance
  !------------
  If $MatchFound = 'N'
 
    let $taxcode_sort = $TaxBalance_State || $TaxBalance_Tax_Class || $TaxBalance_Locality
    let $taxcode_sort = rtrim($taxcode_sort,' ')
    let $taxcode_sort = rpad($taxcode_sort,14,' ') || $Resident
 
    Add 1 to #Last_TaxTotal_Cnt
    let #L1 = #Last_TaxTotal_Cnt
    If  #Last_TaxTotal_Cnt >= {TAX_LIMIT}
         Display 'Exceeded Maximum Tax Balances -- Expand Array'
         #if {SITE_ID} = 'SRC1'
           Move 8 to #Return-Status
         #endif
         #if {SITE_ID} = 'TCN1'
           Move 5 to #Return-Status
         #endif
         Stop
     End-if
 
     Put $TaxBalance_State           -
         $TaxBalance_Locality        -
         #ifdef LOCAL_RECIPROCITY
         $TaxBalance_RESIDENT        -
         #endif
         $TaxBalance_Tax_Class       -
         $taxcode_sort               -
         Into TAXTOTAL(#L1)          -
              TaxTotal_State         -
              TaxTotal_Locality      -
              #ifdef LOCAL_RECIPROCITY
              TaxTotal_Resident      -
              #endif
              TaxTotal_Tax_Class     -
              TaxTotal_Taxcode_sort
 
        let #L2 = 0
        While #L2 < 4  !Paygroup(0), Company(1), Fein(2), Grand(3)
         put  0      -
              0      -
              0      -
              0      -
              0      -
              0      -
              0      -
              0      -
          into TaxTotal(#L1)             -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
         Add 1 to #L2
        End-While
 
  End-if
 
  let #L2 = 1
 
  While #L2 < 4   !(0) Paygroup, (1) Company, (2) Fein, (3) Grand
 
    Array-Add #TaxBalance_Nlgrs_Qtd      -
              #TaxBalance_Txgrs_Qtd      -
              #TaxBalance_Tax_Qtd        -
              #TaxBalance_Nlgrs_Ytd      -
              #TaxBalance_Txgrs_Ytd      -
              #TaxBalance_Tax_Ytd        -
              #Excess_Qtd                -
              #Excess_Ytd                -
          to TaxTotal(#L1)             -
              TaxTotal_Nlgrs_Qtd(#L2)   -
              TaxTotal_Txgrs_Qtd(#L2)   -
              TaxTotal_Tax_Qtd(#L2)     -
              TaxTotal_Nlgrs_Ytd(#L2)   -
              TaxTotal_Txgrs_Ytd(#L2)   -
              TaxTotal_Tax_Ytd (#L2)    -
              TaxTotal_Excess_Qtd(#L2)  -
              TaxTotal_Excess_Ytd(#L2)
 
    Add 1 to #L2
 
  End-While
 
  #ifdef  enable_performance_monitor
     do Get-Current-Time
     move 'Update-TaxBalance-Recap' to $debug-proc1
     move ' '    to $debug-table1
     do log-delta-time
  #endif
 
End-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: ProBusiness-TaxCode-Lookup                                !
! Desc:      This procedure converts the PeopleSoft Tax Code to        !
!            a ProBusiness State Tax Code.                             !
!----------------------------------------------------------------------!
begin-procedure ProBusiness-TaxCode-Lookup
 
  ! build the tax code by appending State+Tax_class+locality together.
  ! this is the excact string which is used as the tax code in the
  ! salta table
 
  let $Output_TaxCode = $State_Trimmed || $Class_Trimmed || $Local_Trimmed
  Let $Output_TaxCode = rpad($Output_TaxCode,15,' ')
 
end-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Build-TaxTotal-Taxcode                                    !
!----------------------------------------------------------------------!
begin-procedure Build-TaxTotal-Taxcode
 
  let $TaxTotal_Taxcode   = '               '
  let $SourceVal   =   rtrim($TAXTOTAL_STATE,' ') ||      -
                       rtrim($TAXTOTAL_TAX_CLASS,' ') ||  -
                       rtrim($TAXTOTAL_LOCALITY,' ')
 
  Let $SourceVal = rpad($SourceVal,15,' ')
  let $TaxTotal_Taxcode = $SourceVal
 
end-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: SQLError                                                  !
! Descr:     Reports SQL Errors                                        !
!                                                                      !
!               Called by vareous procedures.                          !
!----------------------------------------------------------------------!
 
begin-procedure SQLError
 
     evaluate #sql-status
     #ifdef DB2ALL
       when = 6100
       break
     #endif
       when = -9999
        break
       when-other
 
        print 'SQL Error:'   (+1,1)
        print #Sql-Status    (+1,1) edit 9999999
        print $Sql-Error     (0,+2)
        print $Sql-Msg       (0,+2)
 
end-evaluate
 
end-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Wrap-Up                                                   !
! Descr:     If errors are found this procedure will Rollback all      !
!            work and the journal table will not be updated. An output !
!            report is generated identfying the file rows containing   !
!            errors along with a total of the transactions read and    !
!            errors found, if any.                                     !
!            Called by Report procedure.                               !
!----------------------------------------------------------------------!
 
begin-procedure Wrap-Up
 
    if #open1 = -1
        close 1
    end-if
 
  #if {SITE_ID} = 'CHP1'
    Let $OutputFile = $FHandler_filename
    do Push-Output-File	!File Handler changes
  #endif
  ! TMG110517 moved this here from open-quarterly-extract-file procedure
  #ifdef CREATE_TRIGGER_FILE
    let $Trigger_Filename = $Filename || '.trigger'
    #debugd show 'CREATE_TRIGGER_FILE, creating ' $Trigger_Filename
    open $Trigger_Filename as 11 for-writing record=700:vary status=#filestat
    close 11
  #endif
 
  #debugd show 'Wrap-up complete: Extract filename ' $filename ' closed.'
 
end-procedure
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Convert-To-Dos
! Descr:     Converts the UNIX file created to a DOS format file       !
!            Called by Report procedure.                               !
!----------------------------------------------------------------------!
!Dec. 15, 1997
! KO Modification: Added $FilePrefix
 
begin-procedure Convert-To-Dos
 
  let $Run_Command = 'mcvt '|| $Filename
  call system using $Run_Command #status
 
end-procedure
 
begin-procedure Delete-Extract-File
#if {SITE_ID} <> 'RSS1'
   #ifdef UNIX
     let $Run_Command = 'rm ' || $Filename
     call system using $Run_Command #status
     #debugd show 'Delete-Extract-File: ' $Run_Command ', status = ' #status
   #else
     let $Run_Command = 'del ' || $Filename
     call system using $Run_Command #status
     #debugd show 'Delete-Extract-File: ' $Run_Command ', status = ' #status
   #endif
#endif
 
end-procedure
 
 
#if {SITE_ID} = 'STV1'
 
!************************************************************************
!----------------------------------------------------------------------!
! Procedure: Create-ProBiz-FTP-CMD-Text                                !
! Descr:     New procedure, added 05/09/2001.  Creates text file used  !
!            to transfer periodic.dat and txpbzper.lis to the ProBiz   !
!            server.                                                   !
!----------------------------------------------------------------------!
Begin-Procedure Create-ProBiz-FTP-CMD-Text
   Let $File-Creation-Error = 'N'
 
   ! Open a variable length text file on channel 3.
   Open 'c:\temp\FTPPBQTR.bat'
      as 3
      FOR-WRITING
      RECORD=80:VARY
      STATUS=#FileStatus
 
   ! Check file status.
   If #FileStatus <> 0
      #debugd show ''
      #debugd show 'Error opening FTPPBQTR.BAT.'
      #debugd show 'Can not transfer file to ProBiz server.'
      #debugd show ''
 
      Let $File-Creation-Error = 'Y'
 
      Goto Exit-Create-ProBiz-FTP-CMD-Text
   End-If
 
   Write 3 From 'ftp -n -s:C:\TEMP\FTPPBQTR.TXT > C:\TEMP\FTPPBQTR.LOG'
   Write 3 From 'del c:\temp\dummy.lis'
   Write 3 From 'del c:\temp\FTPPBQTR.txt'
 
   ! Close file.
   Close 3
 
   ! Open a variable length text file on channel 3.
   Open 'c:\temp\FTPPBQTR.txt'
        as 3
        FOR-WRITING
        RECORD=80:VARY
        STATUS=#FileStatus
 
   ! Check file status.
   If #FileStatus <> 0
      #debugd show ''
      #debugd show 'Error opening FTPPBQTR.TXT.'
      #debugd show 'Can not transfer file to ProBiz server.'
      #debugd show ''
 
      Let $File-Creation-Error = 'Y'
 
      Goto Exit-Create-ProBiz-FTP-CMD-Text
   End-If
 
   Write 3 From 'open 206.151.44.101'
   Write 3 From 'user'
   Write 3 From 'hosvin'
 
   Let $ExclamationPoint = chr(033)
   Let $Password = 'F1x4pA' || $ExclamationPoint || 'n'
   Write 3 From $Password
 
   Let $PutLine = 'put ' || $FileName || ' ' || 'quarter.dat'
   Write 3 From $PutLine
 
   Let $PutLine = 'put ' || $LisFile || ' ' || 'txpbzqtr.lis'
   Write 3 From $PutLine
 
   Write 3 From 'quit'
 
   ! Close file.
   Close 3
 
Exit-Create-ProBiz-FTP-CMD-Text:
End-Procedure ! Create-ProBiz-FTP-CMD-Text
 
#endif
 
 
begin-procedure Log-TaxBalance-Adjustments
 
       if #YE_Adjustments <  {MAX_YE_BAL_ADJ}   !was {MAX_TAX_BAL_ERRORS} prior to 8/22/05
 
           let $tc = $state_trimmed || $class_trimmed || $local_Trimmed
           put $Current_Company        into YE_BalAdj(#YE_Adjustments) Company
           put $Current_Emplid         into YE_BalAdj(#YE_Adjustments) Emplid
           put $tc                     into YE_BalAdj(#YE_Adjustments) Taxcode
           put $TaxBal_typ             into YE_BalAdj(#YE_Adjustments) Type
           put #Amount                 into YE_BalAdj(#YE_Adjustments) YE_Amount
 
           if rtrim($TaxBal_typ,' ') = 'TXGRS'
             put #TaxBalance_Txgrs_Orig  into YE_BalAdj(#YE_Adjustments) TaxBal
           else
             put #TaxBalance_Tax_Orig    into YE_BalAdj(#YE_Adjustments) TaxBal
           end-if
 
           add 1 to #YE_Adjustments
 
           #ifdef debug_box_data
             #debugd show 'adjustment logged for emplid : ' $Current_emplid
             #debugd show '                      type   : ' $TaxBal_typ
             #debugd show '                      tax    : ' $tc
             #debugd show '                      cnt    : ' #YE_Adjustments
             #debugd show '                      amt    : ' #Amount
           #endif
 
       end-if
 
end-procedure
 
begin-procedure Print-TaxBalance-Adjustments
 
 if #YE_Adjustments >  0
 
   move '$$$,$$$,$$9.99mi' to $Fmt
 
   let $ReportTitle  = '{REPORT_PREFIX} W-2 Year-End Adjustments to Tax Balances: ' || $AsOfDate
   print 'Following are the Employees with YE Adjustments (using YE_Amounts instead of TAX_Balances) '  (+2,4)
   print 'Company  Emplid         Taxcode         Type          TaxBalance-YTD          YE-Amount        Difference' (+2,1)
   print ' ' (+1,1)
 
   let #i=0
   while (#i < #YE_Adjustments)
 
      get $C           from YE_BalAdj(#i) Company
      get $E           from YE_BalAdj(#i) Emplid
      get $t           from YE_BalAdj(#i) Taxcode
      get $typ         from YE_BalAdj(#i) Type
      get #Tb          from YE_BalAdj(#i) TaxBal
      get #Y           from YE_BalAdj(#i) YE_Amount
 
      let #D = #Y - #Tb
      do Format-Number(#Tb, $tb, $Fmt)
      do Format-Number(#Y, $Y, $Fmt)
      do Format-Number(#D, $d, $Fmt)
 
      if #current-line > 56
        New-Page
        print 'Company  Emplid         Taxcode         Type          TaxBalance-YTD          YE-Amount        Difference' (+2,1)
      end-if
 
      print $C                 (+1,1)
      print $E                 (,10)
      print $t                 (,25)
      print $typ               (,41)
      print $Tb                (,55)
      print $Y                 (,79)
      print $D                 (,96)
 
      add 1 to #i
 
    end-while
 
    New-Page
 
  end-if
 
end-procedure
 
#ifdef ADP_TAX_AMEND
#if {SITE_ID} = 'DOW1'
 
begin-procedure Read-Misc-Employee-Data-W-2Cs  !W-2C data, but not YE_Data.. called from pbzqtr.sqr
 
  do Init-W2C-Company
 
begin-select
NEW2C.W2C_ADD_EMPLID
 
      let $Current_Emplid = rtrim(&NEW2C.W2C_ADD_EMPLID,' ')
 
      let $Cur_State    = '$U'               !so we populate a row in the tax balances, so the W-2C module gets called
      let $Cur_Tax_Class = 'H'               !from Process-employee-record
      let $Cur_Locality = ''
      let #TXGRS_YTD_T  = 0
 
      if $SelectEmplid <> ''
        #debugd show 'In procedure Read-Misc-Employee-Data-W-2Cs ... insert-w2-amount-into-taxbalances...'
      end-if
      do insert-w2-amount-into-taxbalances
 
      let $skip_report_detail = 't'   !this eliminates the emcare issue (no tb ee, with detail on)
 
      do Init-Job-Data
      do get-job-data
      do Extract-Personal-Data
      do Process-Quarterly-Record
 
      let #Last_TaxBalance_Cnt= 0
      clear-array name=TaxBalance
 
 FROM  PS_YE_W2C_DATA NEW2C
 
  WHERE NEW2C.COMPANY = $W2CA.W2_REPORTING_CO or NEW2C.W2C_ADD_EMPLID = $SelectEmplid
   #ifdef USE_INT_CRITERIA
    AND NEW2C.CALENDAR_YEAR    = int(\$RptYearZ\)
   #else
    AND NEW2C.CALENDAR_YEAR    = #RptYear
   #endif
    AND NEW2C.W2C_STATUS       = 'C'   !Closed only data is pulled
 
  AND NOT EXISTS (select 'x' from PS_YE_DATA NYE_DATA
   WHERE NYE_DATA.CALENDAR_YEAR   = NEW2C.CALENDAR_YEAR
     AND NYE_DATA.COMPANY         = NEW2C.COMPANY
     AND NYE_DATA.EMPLID          = NEW2C.W2C_ADD_EMPLID )
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
#endif
#endif
 
! --------------------------------------------------------------------
 
#ifdef  enable_performance_monitor
 
!***********************************************************************
begin-procedure Get-Current-time
!***********************************************************************
#ifdef ORACLE
 
!old: to_char(sysdate,'YYYYMMDD,HH:MI:SS A.M.') &ora_tmp_time
 
! ------------------------------------------------------------------------------------------
! oracle: select to_char(sysdate,'MM/DD/YY HH24:MI:SSSSS') Time_Sec_past_midnigt from dual;
! ------------------------------------------------------------------------------------------
 
! ------------------------------------
! mm/dd/yy hh:mm:xxxxx is the format !
! ------------------------------------
 
begin-select
to_char(sysdate,'MM/DD/YY HH24:MI:SSSSS') &Time_Sec_past_midnigt
 
 let $display_dt =  &Time_Sec_past_midnigt
 if $first_get_current_time = ''
   #debugd show 'Get-Current-time (Oracle formatting) = ' $display_dt
   move 't' to $first_get_current_time
 end-if
 
 from dual
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
#else
  do Get-Current-DateTime
  let $display_dt = $SysDateTime
#endif
 
end-procedure
 
#endif
 
#ifdef USE_DEPTID_FOR_WORKSITE
 
begin-procedure Get-Deptid-Name
 
BEGIN-SELECT
LOC4.DESCR
 
  let $LocationName = rtrim(&LOC4.DESCR,' ')
 
 FROM PS_DEPT_TBL LOC4 {NOLOCK_SQL}
 WHERE LOC4.SETID = 'COMMN'
   AND LOC4.DEPTID = $DeptidCd
   AND LOC4.EFFDT = (SELECT MAX (EFFDT)
             FROM PS_DEPT_TBL
            WHERE SETID = LOC4.SETID
              AND DEPTID = LOC4.DEPTID
              AND EFFDT <= $Qtr_End_Native)
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
#endif
 
#ifdef USE_ESTABID
 
begin-procedure Get-Estabid-Name
 
 let $LocationName = ''
 
begin-select
LOC4.BUS_ACTIVITY_LINE1
 
   let $LocationName       = rtrim(&LOC4.BUS_ACTIVITY_LINE1,' ')
 
   if $SelectEmplid <> ''
     show 'Get-Estabid-Name: ' $LocationName ' for worksite ' $w
   end-if
 
   FROM PS_ESTAB_TBL LOC44 {NOLOCK_SQL}, PS_ESTAB_TBL_USA LOC4 {NOLOCK_SQL}
      WHERE  LOC44.EFF_STATUS = 'A'
        AND  LOC44.ESTABID    = $w
        AND  LOC44.EFFDT      = LOC4.EFFDT
        AND  LOC44.ESTABID    = LOC4.ESTABID
        AND  LOC44.EFFDT      = (SELECT MAX(EFFDT)
          FROM PS_ESTAB_TBL {NOLOCK_SQL}
          WHERE EFF_STATUS = LOC44.EFF_STATUS
           AND  ESTABID    = LOC44.ESTABID
           AND  EFFDT     <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
#endif
 
#if {SITE_ID} = 'SCR1'
 
begin-procedure get-SCR1-rollup-deptid
 
begin-select
LOC5.PKT_MAIN_DEPTID              !Rollup Deptid
 
 let $Main_Deptid = rtrim(&LOC5.PKT_MAIN_DEPTID,' ')
 
 #ifdef TEST_EMPLID
   #debugd show '  $Main_Deptid  ' $Main_Deptid
 #endif
 
 FROM PS_PKT_EE_CONTRACT LOC5
 WHERE LOC5.EMPLID = $Current_Emplid
   AND LOC5.EFFDT = (SELECT MAX (EFFDT)
       FROM PS_PKT_EE_CONTRACT
       WHERE DEPTID = LOC5.DEPTID
         AND EMPLID = LOC5.EMPLID
         AND EFFDT <= $Qtr_End_Native)
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
end-procedure
 
begin-procedure get-SCR1-MN-MI-location
 
  let $SCR1_mn_mi_location = '00000'
  if $state_trimmed = 'NM'
    let $SCR1_mn_mi_location = '{NM_UI_LOCATION_DFLT}'
  end-if
 
!TABLE: ps_pkt_empl_rptcd
 
!NAME                           Null?                Type
 
!COMPANY                    NOT NULL         VARCHAR2(3)
!EMPLID                     NOT NULL         VARCHAR2(11)
!PAY_END_DT                                  DATE
!BALANCE_QTR                NOT NULL         NUMBER(*,0)
!BALANCE_YEAR               NOT NULL         NUMBER(*,0)
!STATE                      NOT NULL         VARCHAR2(6)
!UI_RPT_CODE                NOT NULL         VARCHAR2(9)
 
!The ADP program should get the UI_RPT_CODE from this table.
!The data is stored for each employee if they worked in a State where we are tracking the UI code.
 
begin-select
LOC6.UI_RPT_CODE
 
 let $SCR1_mn_mi_location = rtrim(&LOC6.UI_RPT_CODE,' ')
 
 FROM PS_PKT_EMPL_RPTCD LOC6
 WHERE  LOC6.COMPANY      = $Current_Company
         AND LOC6.EMPLID       = $Current_Emplid
         #ifdef USE_INT_CRITERIA
          AND LOC6.BALANCE_YEAR  = int(\$RptYearZ\) 
          AND LOC6.BALANCE_QTR   = int(\$RptQtrZ\) 
         #else
          AND LOC6.BALANCE_YEAR = #RptYear
          AND LOC6.BALANCE_QTR  = #RptQtr
         #endif
         AND LOC6.STATE        = $state_trimmed
 
    AND LOC6.PAY_END_DT = (SELECT MAX (PAY_END_DT)
       FROM PS_PKT_EMPL_RPTCD
       WHERE COMPANY      = LOC6.COMPANY
         AND EMPLID       = LOC6.EMPLID
         AND BALANCE_QTR  = LOC6.BALANCE_QTR
         AND BALANCE_YEAR = LOC6.BALANCE_YEAR
         AND STATE        = LOC6.STATE
         AND PAY_END_DT <= $Qtr_End_Native)
 
#ifdef SELECT_WITH_UR
 {SELECT_WITH_UR} with ur
#endif
end-select
 
end-procedure
 
#endif
 
begin-procedure Init-taxes-bypassed
 
  #ifndef BYPASSED_LIMIT
   #define BYPASSED_LIMIT 10000
  #endif
  #debugd show 'Init-taxes-bypassed: BYPASSED_LIMIT = {BYPASSED_LIMIT}'
 
  create-array name=TaxesBypassed size={BYPASSED_LIMIT} -
    field=Fein:number     -
    field=CompId:char     -
    field=Taxes:number    -
    field=Txgrs:number    -
    field=Nlgrs:number    -
    field=Taxes_YTD:number    -
    field=Txgrs_YTD:number    -
    field=Nlgrs_YTD:number    -
    field=Taxcode:char
 
end-procedure
 
begin-procedure insert-taxes-into-bypassed-totals
 
   let #i = 0
   let $found = 'f'
 
   let $save_Company = $Company
   let $Company = $C.Company_bypass
 
   do get-company-data
   let $Company = $Save_Company
 
   while (#i < #num_taxes_bypassed)
     get $CompID             -
         $txcode             -
     from TaxesBypassed(#i)  -
          CompID             -
          Taxcode
 
     if ($CompID = $C.Company_bypass) and ($txcode = $C.Trimmed_Taxcode)
       let $found = 't'
       break
     end-if
 
     add 1 to #i
   end-while
 
   if substr($txcode,3,1) = 'H'                     !prior to 7/7/09, this was if &C.NLGRS_QTD = 0
     #ifdef NLGRS_FROM_CHECK_YTD_AMOUNT
       do calc-gross99
       let #C.NLGRS_QTD = #Total_Gross_qtd
       let #C.NLGRS_YTD = #Total_Gross_ytd
     #else
       Let #C.NLGRS_QTD = #C.TXGRS_QTD
       Let #C.NLGRS_YTD = #C.TXGRS_YTD
     #endif
   end-if
 
   if $found = 'f'
 
     put   #CT.FEDERAL_EIN           -
           $C.Company_bypass         -
           #C.TAX_QTD                -
           #C.TXGRS_QTD              -
           #C.NLGRS_QTD              -
           #C.TAX_YTD                -
           #C.TXGRS_YTD              -
           #C.NLGRS_YTD              -
           $C.Trimmed_Taxcode        -
     into TaxesBypassed(#i)          -
           Fein                      -
           CompId                    -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           Taxes_YTD                 -
           Txgrs_YTD                 -
           Nlgrs_YTD                 -
           Taxcode
 
     add 1 to #num_taxes_bypassed
   else
 
     Array-Add #C.TAX_QTD            -
           #C.TXGRS_QTD              -
           #C.NLGRS_QTD              -
           #C.TAX_YTD                -
           #C.TXGRS_YTD              -
           #C.NLGRS_YTD              -
       to TaxesBypassed(#i)          -
           Taxes                     -
           Txgrs                     -
           Nlgrs                     -
           Taxes_YTD                 -
           Txgrs_YTD                 -
           Nlgrs_YTD
   end-if
 
end-procedure
 
begin-procedure Hash-Taxes-Bypassed-Breakout
 
  let #header_type = 7
  let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Taxes Bypassed'
 
 if #num_taxes_bypassed < 1
  print 'There were no Taxes Bypassed in the extract' (+2,1)
 else
 
  let #i = 0
  while (#i < #num_taxes_bypassed)
   get #Fein            -
       $CompId          -
       #Taxes           -
       #Txgrs           -
       #Nlgrs           -
       #Taxes_YTD       -
       #Txgrs_YTD       -
       #Nlgrs_YTD       -
       $Taxcode         -
   from TaxesBypassed(#i)  -
      Fein              -
      CompID            -
      Taxes             -
      Txgrs             -
      Nlgrs             -
      Taxes_YTD         -
      Txgrs_YTD         -
      Nlgrs_YTD         -
      Taxcode
 
   if #Fein <> 0
     let $Fein = translate(edit(#Fein,'999999999'),' 0123456789','00123456789')
     print $Fein             (+1,1) edit  xx-xxxxxxx
   else
     print '          '      (+1,1)
   end-if
 
!Fed-Ein        Company             QTD-Withheld        QTD-Taxable        QTD-Subject       YTD-Withheld        YTD-Taxable      YTD-Subject     Taxcode
 
   print $CompId           (0,16)
   Print #Taxes            (0,29)  edit $$,$$$,$$$,$$9.99mi
   Print #Txgrs            (0,48)  edit $$,$$$,$$$,$$9.99mi
   Print #Nlgrs            (0,67)  edit $$,$$$,$$$,$$9.99mi
   Print #Taxes_YTD        (0,86)  edit $$,$$$,$$$,$$9.99mi
   Print #Txgrs_YTD        (0,105) edit $$,$$$,$$$,$$9.99mi
   Print #Nlgrs_YTD        (0,124) edit $$,$$$,$$$,$$9.99mi
   print $Taxcode          (0,146)
 
   add #Taxes to #Taxes_tot
   add #Txgrs to #Txgrs_tot
   add #Nlgrs to #Nlgrs_tot
   add #Taxes_YTD to #Taxes_tot_YTD
   add #Txgrs_YTD to #Txgrs_tot_YTD
   add #Nlgrs_YTD to #Nlgrs_tot_YTD
 
   Add 1 to #i
 
  end-while
 
  Print '    Bypassed Totals --> ' (+2,1)
  Print #Taxes_tot            (0,29) edit $$,$$$,$$$,$$9.99mi
  Print #Txgrs_tot            (0,48) edit $$,$$$,$$$,$$9.99mi
  Print #Nlgrs_tot            (0,67) edit $$,$$$,$$$,$$9.99mi
  Print #Taxes_tot_YTD        (0,86)  edit $$,$$$,$$$,$$9.99mi
  Print #Txgrs_tot_YTD        (0,105) edit $$,$$$,$$$,$$9.99mi
  Print #Nlgrs_tot_YTD        (0,124) edit $$,$$$,$$$,$$9.99mi
 
  Print '    (NOTE, See bypass-tax-check-quarterly, in adpbypas.sqc)' (+2,1)
 end-if
 
 New-Page
 
end-procedure
 
#ifdef enable_performance_monitor  !1/31/07
 
begin-procedure calc-delta-time
 
  if #first_delta_time = 0
    #debugd show 'calc-delta-time: ' $display_dt '..' $display_dt0
    #ifdef DB2ALL
     #debugd show 'calc-delta-time: DB2ALL'
    #endif
    #ifdef MICROSOFT
     #debugd show 'calc-delta-time: MICROSOFT'
    #endif
    #ifdef ORACLE
     #debugd show 'calc-delta-time: ORACLE'
    #endif
  end-if
 
 
  #ifdef DB2ALL   !2008-09-04-12.04.15.924099
 
  !--------------------------------------------
  ! MVS @YRCW / DB2
  !               123456789012345678901234567
  !if format is : 2008-01-31-14.34.01.ddddddd
  ! Sears       : 2008-09-08-09.09.25.476996
  !--------------------------------------------
 
  let $hh1 = substr($display_dt,12,2)
  let $mm1 = substr($display_dt,15,2)
  let $ss1 = substr($display_dt,18,9)
  move $hh1 to #hh1
  move $mm1 to #mm1
  move $ss1 to #ss1
  let #t1 = #hh1 * 3600 + #mm1 * 60 + #ss1
 
  let $hh0 = substr($display_dt0,12,2)
  let $mm0 = substr($display_dt0,15,2)
  let $ss0 = substr($display_dt0,18,9)
  move $hh0 to #hh0
  move $mm0 to #mm0
  move $ss0 to #ss0
  let #t0 = #hh0 * 3600 + #mm0 * 60 + #ss0
  let #delta_time = #t1 - #t0
 
  ! #debugd show 'calcing delta... ' $display_dt ' - ' $display_dt0 ' = ' #delta_time ' seconds'
#endif
 
#ifdef MICROSOFT        ! 2008-05-29 10:27:25.893
 
  let $hh1 = substr($display_dt,12,2)
  let $mm1 = substr($display_dt,15,2)
  let $ss1 = substr($display_dt,18,6)
  move $hh1 to #hh1
  move $mm1 to #mm1
  move $ss1 to #ss1
  let #t1 = #hh1 * 3600 + #mm1 * 60 + #ss1
 
  let $hh0 = substr($display_dt0,12,2)
  let $mm0 = substr($display_dt0,15,2)
  let $ss0 = substr($display_dt0,18,6)
  move $hh0 to #hh0
  move $mm0 to #mm0
  move $ss0 to #ss0
  let #t0 = #hh0 * 3600 + #mm0 * 60 + #ss0
  let #delta_time = #t1 - #t0
 
#endif
 
#ifdef ORACLE
 
! mm/dd/yy hh:mm:xxxxxx is the format
 
  let $hh1 = substr($display_dt,10,2)
  let $mm1 = substr($display_dt,13,2)
  let $ss1 = substr($display_dt,16,5)
  move $hh1 to #hh1
  move $mm1 to #mm1
  move $ss1 to #ss1
  let #t1 = #hh1 * 3600 + #mm1 * 60 + ( #ss1 / 1000)
 
  let $hh0 = substr($display_dt0,10,2)
  let $mm0 = substr($display_dt0,13,2)
  let $ss0 = substr($display_dt0,16,5)
  move $hh0 to #hh0
  move $mm0 to #mm0
  move $ss0 to #ss0
  let #t0 = #hh0 * 3600 + #mm0 * 60 + ( #ss0 / 1000)
  let #delta_time = #t1 - #t0
 
#endif
 
  if #first_delta_time = 0
    #debugd show 'calc-delta-time = ' #delta_time
    add 1 to #first_delta_time
  end-if
 
end-procedure
 
begin-procedure log-delta-time  !$debug-proc1, $debug-table1, $display_dt, $display_dt0
 
  do Get-Current-Time
  move $display_dt to $display_dt_delta
 
  let #debug_found = 0
 
  do calc-delta-time
 
  let #dbg = 0
  while #dbg < #timing_debug_entries
 
   get $debug-proc1_chk  from debug_entry(#dbg)  PROC1
   get $debug-table1_chk from debug_entry(#dbg)  TABLE1
 
   if rtrim($debug-proc1_chk,' ') = rtrim($debug-proc1,' ') and rtrim($debug-table1_chk,' ') = rtrim($debug-table1,' ')
 
    let #ccc = 1
 
    array-add  #ccc           -
               #delta_time    -
        to debug_entry(#dbg)  -
               COUNT1         -
               RUNNING1
 
    add #delta_time to #delta_time_hash
    let #debug_found = 1
    break
   end-if
 
   add 1 to #dbg
  end-while
 
 
  if #debug_found < 1
   if #timing_debug_entries < {MAX_timing_debug_entries}
 
    let $debug-proc1_rtrim = rtrim($debug-proc1,' ')
    let $debug-table1_rtrim = rtrim($debug-table1,' ')
 
    let #debug-count1 = 1
    put $debug-proc1_rtrim     into debug_entry(#timing_debug_entries)  PROC1
    put $debug-table1_rtrim    into debug_entry(#timing_debug_entries)  TABLE1
    put #debug-count1          into debug_entry(#timing_debug_entries)  COUNT1
    put #delta_time            into debug_entry(#timing_debug_entries)  RUNNING1
    add #delta_time to #delta_time_hash
    add 1 to #timing_debug_entries
   end-if
  end-if
 
  move 'log-delta-time' to $debug-proc1
  move ' '    to $debug-table1
  do log-delta-time1
 
end-procedure
 
begin-procedure log-delta-time1  !$debug-proc1, $debug-table1, $display_dt, $display_dt0
 
 
  let #debug_found = 0
 
  let #dbg = 0
  while #dbg < #timing_debug_entries
 
   get $debug-proc1_chk  from debug_entry(#dbg)  PROC1
   get $debug-table1_chk from debug_entry(#dbg)  TABLE1
 
   if rtrim($debug-proc1_chk,' ') = rtrim($debug-proc1,' ') and rtrim($debug-table1_chk,' ') = rtrim($debug-table1,' ')
 
    do Get-Current-Time
    do calc-delta-time
 
    let #ccc = 1
    array-add #ccc   -
       #delta_time   -
     to debug_entry(#dbg)   -
       COUNT1               -
       RUNNING1
 
    add #delta_time to #delta_time_hash
    let #debug_found = 1
    break
   end-if
 
   add 1 to #dbg
  end-while
 
  if #debug_found < 1
   if #timing_debug_entries < {MAX_timing_debug_entries}
 
    move $display_dt_delta to $display_dt0
    do Get-Current-Time
    do calc-delta-time
 
    let $debug-proc1_rtrim = rtrim($debug-proc1,' ')
    let $debug-table1_rtrim = rtrim($debug-table1,' ')
 
    let #debug-count1 = 1
    put $debug-proc1_rtrim     into debug_entry(#timing_debug_entries)  PROC1
    put $debug-table1_rtrim    into debug_entry(#timing_debug_entries)  TABLE1
    put #debug-count1          into debug_entry(#timing_debug_entries)  COUNT1
    put #delta_time            into debug_entry(#timing_debug_entries)  RUNNING1
    add #delta_time to #delta_time_hash
 
    add 1 to #timing_debug_entries
   end-if
  end-if
 
end-procedure
 
begin-procedure print-debug-entries !enable_performance_monitor
 
    #debugd show 'enable_performance_monitor: print-debug-entries: timing_debug_entries = ' #timing_debug_entries
 
    if #timing_debug_entries > 0
 
      let #header_type = 20
      let $ReportTitle  = '{REPORT_PREFIX} ADP Employment Tax Quarterly. Performance Monitor'
 
      let #i = 0
      while (#i < #timing_debug_entries)
 
        let #j = 0
        let #biggest = 0
        while (#j < #timing_debug_entries)
          Get #r from debug_entry(#j) RUNNING1
          if #r > #biggest
            let #nextinx = #j
            let #biggest = #r
          end-if
          add 1 to #j
        end-while
 
        Get $p    from debug_entry(#nextinx) PROC1
        Get $t    from debug_entry(#nextinx) TABLE1
        Get #c    from debug_entry(#nextinx) COUNT1
        Get #r    from debug_entry(#nextinx) RUNNING1
 
        if #current-line > 56
          New-Page
        end-if
 
     if #r > 0
 
        if #delta_time_hash > 0
          let #r_percent = (#r / #delta_time_hash) * 100
        end-if
 
        print $p         (+1,1)
        print $t         (0,51)
        print #c         (0,81)   edit 999999999
        print #r         (0,91)   edit 9999999.99999
        print #r_percent (0,105)  edit 99.99
        print '%'        ()
 
        ! show#i '. ' $p '   ' $t '   ' #c '   ' #r
 
        put 0 into debug_entry(#nextinx) RUNNING1
        add #r to #r_total
 
     end-if
 
        add 1 to #i
 
      end-while
 
      print 'Total Seconds tracked = ' (+2,1)
      print #r_total                (0,91)    edit 9999999.99
      #debugd show '#delta_time_hash = ' #delta_time_hash
 
      New-Page
 
   end-if
 
end-procedure
 
#endif
 
#if {SITE_ID} = 'PFZ1'
 
begin-procedure PFE-Corp-Officer-Selection
 
  ! default to 'N', not a corp officer
  let $Corp_Officer = 'N'
 
begin-SELECT
PFE_OFFICER.Z_SPEX_CD
 
    evaluate &PFE_OFFICER.Z_Spex_Cd
      when = '17'
      when = '18'
        let $Corp_Officer = 'Y'
        break
      when-other
        break
    end-evaluate
 
 FROM PS_JOBCODE_TBL PFE_OFFICER {NOLOCK_SQL}
WHERE PFE_OFFICER.SETID      = &JB.Setid_Jobcode
  AND PFE_OFFICER.JOBCODE    = &JB.Jobcode
  AND PFE_OFFICER.EFF_STATUS = 'A'
  AND PFE_OFFICER.EFFDT      =
      (SELECT MAX(EFFDT)
       FROM PS_JOBCODE_TBL {NOLOCK_SQL}
       WHERE SETID           = PFE_OFFICER.SETID
         AND JOBCODE         = PFE_OFFICER.JOBCODE
         AND EFFDT          <= $Qtr_End_Native)
end-SELECT
 
end-procedure
 
begin-procedure PFE-Get-Reg-Temp-Class
 
  let $Z_Reg_Temp_Class = ''
 
#ifdef USE_INT_CRITERIA
     Let $empl_rcd = &JB.{emp_rec}
#endif

begin-SELECT
Z_REG_TEMP_CLASS
 
    let $Z_Reg_Temp_Class = &Z_Reg_Temp_Class
 
 FROM PS_Z_JOB_DATA_HR
WHERE EMPLID   = $Current_Emplid

 #ifdef USE_INT_CRITERIA
  AND EMPL_RCD = int(\$empl_rcd\)
 #else
  AND EMPL_RCD = &JB.{emp_rec}
 #endif
  AND EFFDT    = &JB.Effdt
  AND EFFSEQ   = &JB.Effseq
end-SELECT
 
end-procedure
 
#endif !PFE Specific Procedures
 
#if {SITE_ID} = 'WHS1'
!**********************************************************************
! Name:         WEY-Transmit-File
! Description:  Call the publishing adapter to transmit the file.
! Parameters:   None.
!**********************************************************************
begin-procedure WEY-Transmit-File
 
! Note: we could not use the standard call to the WINTOCOM-WIA-Publishing-Adapter procedure, since this
!       pushed the total number of program lines past the SQR maximum.
 
! initialization
let $work.wey_folder_path = ' '
let $work.wey_unix_command = ' '
let $work.parms_found_ind = 'N'
 
! get the adapter parameters
begin-select
wey_folder_path,
wey_unix_command,
wey_int_adapt_sts
 
    let $work.wey_folder_path = &wey_folder_path
    let $work.wey_unix_command = &wey_unix_command
    let $work.wey_int_adapt_sts = &wey_int_adapt_sts
    let $work.adapter_full_name = $work.wey_folder_path || '/' || $work.wey_unix_command
    let $work.parms_found_ind = 'Y'
 
from ps_wey_int_adapter
where wey_int_is_adapter = 'ZIP'
end-select
 
#debugd show ' '
#debugd show '*****************************************************************'
#debugd show 'WHS1 File Publication'
#debugd show ' '
#debugd show 'File Name: ' $Filename
#debugd show ' '
 
! error if parms missing
if $work.parms_found_ind = 'N'
    #debugd show 'Error: Interface Parameters not found for the zipping adapter.'
else
 
    if $work.wey_int_adapt_sts = 'I'
        #debugd show 'Error: adapter turned off.  File not published.'
    else
 
        ! Change the UNIX Permissions on the data file to allow the WIA adapter read the interface file
        let $work.command = 'chmod 660 ' || '{FILEPREFIX_WIA_OUT}' || $work.wey_filename
        call system using $work.command #work.command_return_code WAIT
        if #work.command_return_code <> 0
            #debugd show 'Error:  could not reset UNIX permission on data file: ' $work.wey_filename
        else
 
            ! verify the adapter exists
            let #work.adapter_exists_status = exists($work.adapter_full_name)
            if #work.adapter_exists_status <> 0
                #debugd show 'Error: adapter not found: ' $work.adapter_full_name
            else
 
                ! call the publishing adapter
                let $work.command = $work.adapter_full_name || '  ' || $work.wey_filename
                call system using $work.command #work.command_return_code
                if #work.command_return_code <> 0
                    let $out.return_code = '5'
                    #debugd show 'Error: call to publising adapter ' $work.wey_unix_command ' failed with return code ' #work.command_return_code
                else
                    #debugd show 'File successfully published using the zipping adapter.'
                end-if
 
            end-if
        end-if
    end-if
end-if
 
#debugd show ' '
#debugd show '*****************************************************************'
 
end-procedure WEY-Transmit-File
#endif ! end WHS1
 
 
!************************************************************************
!----------------------------------------------------------------------!
! Called SQC Procedures                                                !
!----------------------------------------------------------------------!
#Include 'getpgdta.sqc'  !Get-PayGroup-Data procedure
#include 'curdttim.sqc'  !Get-Current-DateTime procedure
#include 'datetime.sqc'  !general date and time formatting procedures
#include 'datemath.sqc'  !Date Functions
#include 'number.sqc'    !general number formatting procedures
 
!*****************************************************************
! Freddie Mac Customization for backup and transfer files.....!!!!
#if {SITE_ID} = 'FHL1'
 #Include 'fmpbbkft.sqc'  !kmr
#endif
!*************************************************
 
#if {SITE_ID} <> 'SOL1'
 #include 'stdapi.sqc'    !StdAPI-Init procedure
#else
  #include 'stdvar.sqc'    !PeopleSoft Standard Var Routine
#endif
#include 'reset.sqc'     !Reset printer procedure
#Include 'getstdta.sqc'  !Get-State-Tax-Data procedure
#Include 'getlcdta.sqc'  !Get-Local-Tax-Data procedure
 
#include 'getcodta.sqc'  !get-company-data
#Include 'getbalid.sqc'  !Get-Calendar-Year-Id
 
#if {SITE_ID} = 'PFZ1'
   #include 'getjobin.sqc'  !Get-Job-Info procedure
!   #include 'tweaktxb.sqc'  !tweak/untweak
#endif
 
#if {Peoplesoft_Version} >= '8.8'
 #Include 'readxlat.sqc'
 #if {SITE_ID} = 'WFG1'
  #Include 'PRCSLNG.sqc'
 #endif
#endif
 
#if {SITE_ID} = 'FTO1'
  #include 'getparm.sqc'
#endif
 
#ifdef USE_LOCATION_CD
 #include 'getlocnm.sqc'  !Get-Location-Name
#else
 #Include 'gettxlnm.sqc'  !Get-Tax-Location-Name procedure
#endif
 
#if {SITE_ID} = 'AXA1'
#include 'axrunloc.sqc'
#Include 'useprntr.sqc'
#endif
 
#if {SITE_ID} = 'CSB1'
#Include 'chkservr.sqc'  !Get Output Destination for Server-Run programs
#endif
 
#if {SITE_ID} = 'ALB1'
#Include 'axc0011.sqc'   !Get-Run-Location                   ! Pete 5/05/00
#endif
 
#if {SITE_ID} = 'WCH1'
#Include 'fusqrenv.sqc'   !Environment vars
#endif
 
#if {SITE_ID} = 'DOW1'
 #Include 'setup07.sqc'
#endif
 
#if {SITE_ID} = 'STV1'
 #Include 'stvfilestr.sqc' !Venu Tirumala - Stvincent Addition
#endif
 
#if {SITE_ID} = 'DBS1'
 #Include 'dreports.sqc'  !NEW-FILE-NAME Procedure MOD 0003
#endif
 
#if {SITE_ID} = 'PFG1'
 #include 'usgftp.sqc'    !FTP to NT procedure
#endif
 
#if {SITE_ID} = 'MCK1'
 #include 'msetdir.sqc'
#endif
 
! GNT set variables for file paths.
#if {SITE_ID} = 'GTI1'
  #Include 'gntfilepath.sqc' !Output Directory path
#endif
 
#if {SITE_ID} = 'SIE1'
  #include 'siemens.sqc'
#endif
 
#if {SITE_ID} = 'SOL1'
  #include 'tranctrl.sqc'  !Transaction Control          !tmschn: added SQC
  #include 'sqlerror.sqc'
  #include 'prcslng.sqc'   !Get-PSOptions-Language
#endif
 
#if {SITE_ID} = 'PMT1'   !**** John King - Paramount specific output paths
 #include 'z_common.sqc'  !**** John King - Paramount specific output paths
#endif                    !**** John King - Paramount specific output paths
 
#if {SITE_ID} = 'RTG1'
 #include 'rtifileloc.sqc'
#endif
 
#if {SITE_ID} = 'AMP1'
  #include 'axfilepaths.sqc'
#endif
 
#if {SITE_ID} = 'KFC_OLD'
  #include 'adp_tax_split.sqc'
#endif
 
#if {SITE_ID} = 'WFG1'
 #Include 'tranctrl.sqc'  !commit-transation
 #Include 'wftfctrl.sqc'  !Wells-custom procedures
 #Include 'wftfctr2.sqc'  !Wells-custom procedures for weeks calculation
#endif
 
#ifdef BYPASS_QUARTERLY_TAXES
  #if {SITE_ID} = 'PMT1'
     #include 'z_adpbypas.sqc'  !do bypass-tax-check
  #else
     #include 'adpbypas.sqc'  !do bypass-tax-check
  #endif
  #ifdef BYPASS_ZERO_LOCALS_QUARTERLY
    #include 'adplocbp.sqc'
  #endif
#endif
 
#ifdef SUBTOTAL_ADP_COMPID_EXTRACT
  #if {SITE_ID} = 'PMT1'
    #include 'z_adpcompid.sqc'  !procedure Init-ADPCompid
  #else
    #ifdef MVS    !MVS accept only 8 character length of file name
      #include 'adpcompi.sqc'  !procedure Init-ADPCompid
    #else
      #include 'adpcompid.sqc'  !procedure Init-ADPCompid
    #endif
  #endif
#endif
 
#if {SITE_ID} = 'ELR1'
 #include 'getpath.sqc'
#endif
 
#if {SITE_ID} = 'ICI1'
  #include 'getprcsd.sqc'
#endif
 
#if {CLIENT_ID} = 'SGB'
  #Include 'sgdbname.sqc'  !Get File Path
#endif
 
#ifdef LOCAL_RECIPROCITY_SPECIAL_REPORT
  #include 'adpsprec.sqc'
#endif
 
#if {SITE_ID} = 'JLL1'
 #include 'lpl1.sqc'      !LP custom sqc to get the server outbox folder
#endif
 
#if {SITE_ID} = 'LFG1'
  #include 'lxmap001.SQC'		     					
#endif
 
#if {SITE_ID} = 'FRB1'							!FRB 02/13/2006
  #include 'ZZU0001.SQC'		     					!FRB 02/13/2006
#endif
 
#if {SITE_ID} = 'ACL1'
  #include 'amc.sqc'
  #include 'amcxlat.sqc'	 !AMC Translate Procedures
#endif
 
#ifndef NO_ADPSTDNM_INCLUDE                   !this works for simple filenames, standard names... but not the SFTP names, shrinks code.. see GE01 adpcusnm.sqc
  #include 'adpstdnm.sqc'                     !existing (pre 2/16/09) custom extract naming, and standard naming conventions
#endif
 
#include 'adpcusnm.sqc'                     !new custom naming logic
 
#if {SITE_ID} = 'WUV1'
#include 'wes_prcsapi_set_path_names.sqc'
#include 'wes_unix_commands.sqc'
#include 'wes_gnupg.sqc' !GNUPG Encryption & Decryption
#endif
 
#if {SITE_ID} = 'ITE1'
    #include 'pbzqtr.sqc'
    #include 'transmit.sqc'
    #include 'ziadp.sqc'
#endif
 
#if {SITE_ID} = 'SOL1'
  #include 'adpsol1.sqc'
#endif
 
#if {SITE_ID} = 'SQP1'
  #include 'hrsecty.sqc'   !Get SQR Security parameters, sets $SecurityClauseWithERN
#endif
 
#if {SITE_ID} = 'USB1'
  #include 'mtrcksqr.sqc'  ! Track SQR run
#endif
 
#ifdef INCLUDE_W2C
 #if {SITE_ID} = 'GE01'              !in adpgew2c.sqc - only pull in companies with W-2C data (Taxform_id = 'C' for GE01)
   #include 'adpgew2c.sqc'
 #endif
#endif
 
#if {SITE_ID} = 'AHM1'
  #include 'z_ftpfil.sqc' !Routine for encryption & FTP transmission
#endif
 
#if {SITE_ID} = 'TFF1'
  #include 'tygetprm.SQC'		     					
  #include 'tysqrpns.SQC'		     					
#endif
 
 
 
! ----------------- PBZQTR.SQR: The End ---------------------!
