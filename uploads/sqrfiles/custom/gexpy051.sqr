!***********************************************************************
! GEXPY051:  This program prints out employees whose wages were        *
!            garnished to make up the payment.  This report will be    *
!            sent to the payee.                                        * 
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
! This module is the confidential and proprietary information of       *
! Giant Eagle, Inc.; it is not to be copied, reproduced, or transmitted*
! in any form, by any means, in whole or in part, nor is it to be used *
! for any purpose other than that for which it is expressly provided   *
! without the written permission of Giant Eagle.                       *
!                                                                      *
!                                                                      *
!***********************************************************************
!                         MODIFICATION HISTORY                         *
!***********************************************************************
!  ID#     INITIALS    DATE           DESCRIPTION OF THE CHANGE        *        
!***********************************************************************
!  GPYC051   SXK       12/18/1997     INITIAL CREATION                 *
!                                                                      *
!            SXK       09/22/1998     Added New Mobius ReportID        *  
!                                                                      *
!	     SXK       10/29/1998     Modified page break logic and    *
!                                     address                          *
!                                                                      *
!            SXK       02/01/1999     Looking not only for checks,     * 
!                                     but for everything               *
!                                                                      *
!	     SXK       03/24/1999     Modified to look for adjustments *
!                                                                      *
!            SXK       06/28/1999     Modified to sum all the online   *
!				      and offcycle pay sheets to avoid *
!				      printing negative checks         *
!                                                                      *
!	     SXK       09/02/1999     Modified to pick adjusted checks *
!                                     in the first select itself.      *
!                                                                      *
!	     SXK       11/18/1999     Modified main select to have     *
!				      $pay_end_dt (selected previously)*
!				      rather than getting              *
!                                     max(pay_end_dt) from ps_pay_check*
!                                                                      *
!	     SXK       12/13/1999     Modified zip reference to postal *
!                                                                      *
!            AXL       01/14/2000     Suppressed the Payment & Fee amts*
!                                     from showing on the rpt if the   *
!                                     Total Payment was zero.  Rpt to  *
!                                     show zero for those columns.     *
!                                                                      *
!            AXL       10/30/2000     Added variable COURT_DOC_ID2 to  *
!                                     printed output.                  *
!                                                                      *
!            CWB       04/05/2001     Added new procedure to get correct
!                                     payee name for certain Ohio      *
!                                     garnishments.                    * 
!	     SRK       11/11/2002     Modified table name from         *
!                                     garn_payee_tbl to gex_garn_payee.*
!            CWB       02/26/2003     Corrected $pay_end_dt logic and  *
!                                     #empl_rcd# variable in the       *   
!                                     get-garn-amount procedure. v8.3  * 
!                                     				       *
!HR-10861   ISDVSRC    03/14/2005     Captured $GARN_PAYEE_NAME from   * 
!				      Process-Employee-Data and passed *
!                                     to get-payee-name to get the     *
!                                     single row. GARN_PAYEE_NAME is   *
!                                     the key column on                *
!                                     PS_GEX_GARN_PAYEE Table          *
!                                                                      *
!HR-10955    AXL       09/26/2005     Added new procedure that resolves*
!                                     the GARN_PAYEE_NAME when it is   *
!                                     not found on GEX_GARN_PAYEE tbl. *
!                                     The 2nd pass goes to the main    *
!                                     GARN_SPEC table.                 *
!                                                                      *
!ITG-42313  RXD        07/19/2007     To print Payee Name Accurately   *
! PY227     MANISH     08/08/07       HCM 9.0 Upgrade                  *
!           ISDVNPK    11/12/07       HCM 9.0 Upgrade - Changed        *
!                                     GEX_GARN_PAYEE to GARN_SPEC      *
!           ISDVDXS    06/18/2008     PSXLATITEM was wrongly coded as  *
!                                     PSXLATITEMLANG
! ITG 66163 VENDKXY    09/11/2009     Done the changes for the existing*
!				     													report PY051GRN and created two  *
!				      												new reports PY051OIR and PY051CHS*
!ITG 70341 VENDKXY 										Done changes for report issue    *
!          1289792      09/14/2016      Print last 4 digits of SSN     *
!***********************************************************************


#include 'setenv.sqc' !Set environment

begin-setup

!#include 'setupdb.sqc'
#include 'setup32a.sqc'

!declare-layout General-layout
!   orientation=LANDSCAPE
!   MAX-LINES=50
!   MAX-COLUMNS=132
!end-declare

declare-report Garn-Payee-report
Printer-Type=HPLASERJET
  layout=DEFAULT
end-declare

declare-report Report-log
Printer-Type=HPLASERJET
  layout=DEFAULT
end-declare

!VENDKXY Done changes for the ITG 66163
declare-report Garn-Payee-report1
Printer-Type=HPLASERJET
  layout=DEFAULT
end-declare

!VENDKXY Done changes for the ITG 66163
declare-report Garn-Payee-report2
Printer-Type=HPLASERJET
  layout=DEFAULT
end-declare

end-setup

!*********************************************************************
!Initial processing, retrieving current dates and calls the main 
!procedure to do the processing.                                     
!*********************************************************************
begin-report

  !use-report Garn-Payee-Report  !VENDKXY Done changes for the ITG 66163
  

  do Init-DateTime
  do Init-Number
  do stdapi-init
  !do Alter-Session   ! Set Session to RULE Optimizer  !Manish,08/08/2007,PY227-Giant Eagle commented on 08/08/2007 for HCM 9.0 Upgrade
  
  move 'GEXPY051' to $ReportID
  move 'Garnishment Employee Detail Report - Payee' to $ReportTitle
  display $ReportTitle

  do Get-Current-DateTime
!  let $reportdate_mm = substr($reportdate,1,2)
!  let $reportdate_dd = substr($reportdate,4,2)
!  let $reportdate_yy = substr($reportdate,7,2)
!  do MakeYear4Digits ($reportdate_yy)

!  let $reportdate_ccyyyy = $reportdate_mm||'/'||$reportdate_dd||'/'||$reportdate_yy

!  do format-datetime($reportdate_ccyyyy,$reportdate_ccyy,{DEFMDY},'','NATIVE') 

!VENDKXY Done changes for the ITG 66163
  !do Report               	
  
  show '$GEXXX901_INCLUDE_COMPANY_PAYGROUP_CRITERIA = ' $GEXXX901_INCLUDE_COMPANY_PAYGROUP_CRITERIA
  show '$GEXXX902_INCLUDE_DEPTID_CRITERIA ='  $GEXXX902_INCLUDE_DEPTID_CRITERIA
  show '$ap_vendor_id =' $ap_vendor_id
            
  do py051grn                   !VENDKXY Done changes for the ITG 66163 
            
  do py051oir			!VENDKXY Done changes for the ITG 66163 
  
  do py051chs			!VENDKXY Done changes for the ITG 66163 
  !VENDKXY Done changes for the ITG 66163
  
  do Commit-Transaction
  date-time () hh:mi:ss &timeEnded
  display 'Report Ended: ' noline
  display &timeEnded
  do stdapi-term
  do reset

end-report

Begin-procedure py051grn
 Let $Clause = 'AND D.DEDUCT_GARN_AMT <> 0' || ' AND  C.GARN_TYPE <> ' || '''C'''|| ' AND (D.STATE_GARN_LAW <> ' || '''OH''' || 'or D.GARN_RULE_ID <>  '|| '''GENERAL''' || ')'
 !Let $order_by = 'ORDER BY C.GARN_TYPE,C.AP_VENDOR_ID,B.COMPANY'
 !Let $order_by = 'ORDER BY B.COMPANY,C.AP_VENDOR_ID,B.NAME' 
 Let $order_by = 'ORDER BY B.COMPANY,C.GARN_TYPE,C.AP_VENDOR_ID,B.NAME'
 use-report Garn-Payee-Report
 Let $report='PY051GRN'
 Let $paycheckstatus = 'B.PAYCHECK_STATUS in ' || '(' || '''F''' || ',' || '''A''' || ')'
 Let $deptidclause = ' '
 Let $groupby = ' '
 Let $having = ' '
 show $Clause
 do Report  

  
 show 'PY051GRN== ' $order_by $paycheckstatus $deptidclause $groupby $having
 
End-Procedure


Begin-procedure py051oir

 Let $Clause = 'AND D.STATE_GARN_LAW = ' || '''OH''' || ' And D.GARN_RULE_ID =  '|| '''GENERAL''' || 'AND D.DEDUCT_GARN_AMT <> 0' || ' AND  C.GARN_TYPE <> ' || '''C'''

 Let $order_by = 'ORDER BY B.COMPANY,C.AP_VENDOR_ID,B.NAME'  
 use-report Garn-Payee-Report1
 Let $report='PY051OIR'
 Let $paycheckstatus = 'B.PAYCHECK_STATUS in ' || '(' || '''F''' || ',' || '''A''' || ')'
  show $Clause
 Let $deptidclause = ' '
 Let $groupby = ' '
 Let $having = ' '
 
 do Report  
 
 
 show 'PY051OIR== ' $order_by $paycheckstatus $deptidclause $groupby $having
End-Procedure

Begin-procedure py051chs
 Let $Clause = 'AND  C1.GARN_TYPE = ' || '''C''' || ' AND D1.DEDUCT_GARN_AMT <> 0'
 Let $order_by = 'ORDER BY B1.COMPANY,UPPER(C1.GARN_PAYEE_NAME),B1.name' 
 use-report Garn-Payee-Report2
 Let $report='PY051CHS'
 Let $paycheckstatus = 'B1.PAYCHECK_STATUS in ' || '(' || '''F''' || ',' || '''A''' ||',' || '''R''' || ')'
! Let $deptidclause =  'AND b1.deptid in (select e.deptid from PS_GEX_DEPT_TBL e where e.effdt = (SELECT MAX(e1.effdt)
!		   FROM ps_gex_dept_tbl e1
!		   WHERE e1.setid = e.setid
!		   AND e1.deptid = e.deptid
!		   AND e1.effdt <= ' || '(''' || $pay_end_dt|| ''')' ||')' || 'AND e.sequence_number = (SELECT MAX(e2.sequence_number)
!	   		   FROM ps_gex_dept_tbl e2
!			   WHERE e2.setid = e.setid
!			   AND e2.deptid = e.deptid
!			   AND e2.effdt = e.effdt) AND e.setid =' ||  '''COMMN''' || ')'
 Let $groupby = 'group by B1.COMPANY,C1.GARN_PAYEE_NAME,B1.PAYGROUP,C1.AP_VENDOR_ID,B1.EMPLID,B1.NAME,B1.DEPTID,B1.EMPL_RCD,B1.PAY_END_DT,C1.GARNID,C1.GARN_TYPE,C1.COURT_DOC_ID,C1.COURT_DOC_ID2 '
 !Let $having = ' having d1.DEDUCT_GARN_AMT > 0    '
 do Report
 
   show $Clause
 show 'PY051chs== ' $order_by $paycheckstatus $deptidclause $groupby $having
 
End-Procedure



!*********************************************************************
!If this Program is being executed through process scheduler, 
!the run control parameters and calls the main processing procedure.
!Otherwise, interrogates the user for the run control parameters and 
!validates them. If the run control parameters are invalid, stops the
!execution.
!*********************************************************************
begin-procedure Report
  
date-time () hh:mi:ss &timeBegan
display 'Report Began: ' noline
display &timeBegan

 move 'N' to $Errorfound

  if $prcs_process_instance = ''
     let $GEXXX901_INCLUDE_COMPANY_PAYGROUP_CRITERIA = '1=1'
   let $GEXXX902_INCLUDE_DEPTID_CRITERIA = '1=1'
   let $ap_vendor_id = '1=1'
   let $reportdate_ccyy = $AsOfToday
  else
      Do GEXXX922-Select-Parameters
      let $reportdate_ccyy = $GEX_RC_PAY.ASOFDATE
      if rtrim($GEX_RC_PAY.ASOFDATE,' ') = ''
	let $reportdate_ccyy = $asoftoday
      end-if
      !VENDKXY Done changes for ITG 66163--Begin 
      if RTRIM($GEX_RC_PAY.AP_VENDOR_ID,' ') = ''
         if $report <> 'PY051CHS'
         let $GEX_RC_PAY.AP_VENDOR_ID = 'C.AP_VENDOR_ID'
         ELSE 
         let $GEX_RC_PAY.AP_VENDOR_ID = 'C1.AP_VENDOR_ID'
         END-IF
      end-if
       if $report <> 'PY051CHS'
      let $ap_vendor_id = 'C.AP_VENDOR_ID = '||$GEX_RC_PAY.AP_VENDOR_ID
	Let $GEXXX901_Company_Alias  = 'B.COMPANY'
	Let $GEXXX901_Paygroup_Alias = 'B.PAYGROUP'
	Let $GEXXX902_Deptid_Alias = 'B.DEPTID'
	ELSE 
         let $ap_vendor_id = 'C1.AP_VENDOR_ID = '||$GEX_RC_PAY.AP_VENDOR_ID
	Let $GEXXX901_Company_Alias  = 'B1.COMPANY'
	Let $GEXXX901_Paygroup_Alias = 'B1.PAYGROUP'
	Let $GEXXX902_Deptid_Alias = 'B1.DEPTID'
      END-IF
      	
	Do GEXXX901-Select-Company-Paygroup-Parameters 
	
	Do GEXXX902-Select-Deptid-Parameters 
   end-if
!VENDKXY Done changes for ITG 66163--End
let $rnctl_Date = $reportdate_ccyy

let $rnctl_mm = substr($rnctl_Date,1,2)
let $rnctl_dd = substr($rnctl_Date,4,2)
let $rnctl_yyyy = substr($rnctl_Date,7,4)       
let $rnctl_yy  = substr($rnctl_date,9,2)
move $rnctl_yyyy to #rnctl_yyyy
move $rnctl_yy to #rnctl_yy
 
!VENDKXY Done changes for ITG 66163--Begin 
 if $report <> 'PY051CHS'
    do process-employee-data
 else 
    do process-employee-data1   
 end-if 
!VENDKXY Done changes for ITG 66163--End   

 if $sev-error = 'Y'
    goto report-exit
 end-if
  
Report-Exit:


  date-time () hh:mi:ss &timeProcess
  display #InputTran 99999 noline
  display ' Transactions Processed: ' noline
  display &timeProcess

end-procedure

!*********************************************************************
!Prints the header information in the report log.
!*********************************************************************

begin-heading 6 for-reports=(report-log)
LET $REPORTID = 'PY051LOG'
 move 'Report Log' to $ReportTitle
 #Include 'stdhdg01.sqc'

!  print 'Report ID:  '    (1,1)
!  print $ReportID         ()

!  uppercase $ReportTitle
!  print $ReportTitle      ()          center bold
!  print 'Run Date:'       (0,108)
!  date-time () DD-MON-YYYY &curr_Date 
!  print &curr_Date ()
!  position (+1)
!  print 'Report Log' () center bold

  position (+2)
  print 'Trans#' (,1) bold
  print 'Emplid' (,18) bold
  print 'Message' (,50) bold
  print '-' (+1,1,176) fill
 
end-heading

!*********************************************************************
!Prints the header information in the Garn-Payee-Report
!*********************************************************************

begin-heading 9 for-reports=(Garn-Payee-Report)
#debug9 display 'Garn-Payee-Report Heading Section'

move 'Garnishments Report by Payee' to $ReportTitle

LET $REPORTID = 'PY051GRN'

 #Include 'stdhdg01.sqc'

!  print 'Report ID:  '    (1,1)
!  print $ReportID         ()

!  uppercase $ReportTitle
!  print $ReportTitle      ()          center bold
!  print 'Run Date:'       (0,108)
!  date-time () DD-MON-YYYY &curr_Date 
!  print &curr_Date ()

  position (-1)

! CWB 04/05/2001 BEGIN
  if $prev_payee = '0001030372-001'
    do get-payee-name-ohio
  else
    do get-payee-name  
  end-if


!  do get-payee-name  
! CWB 04/05/2001 END

 Uppercase $prev_payee_name  ! VENDKXY Done changes for the ITG 66163
 Uppercase $prev_payee       ! VENDKXY Done changes for the ITG 66163
 
  string $prev_payee_name $prev_payee by '/' into $desc
  print $desc () center bold
  
 
  position (+1)

! CWB 04/05/2001 BEGIN
!  print &I.ADDRESS1 () center bold
  print $ADDRESS1 () center bold
  
! CWB 04/05/2001 END

!  position (+1)
!  print &I.ADDRESS2 () center bold
!  position (+1)
!  print &I.ADDRESS3 () center bold
!  position (+1)
!  print &I.ADDRESS4 () center bold
  position (+1)
  move ' ' to $desc_zip

! CWB 04/05/2001 BEGIN
!  move &i.postal to $zip	!SXK 12/13/1999 Changed from zip to postal
!  string &I.CITY &I.STATE $zip by ' ' into $desc_zip
  string $CITY $STATE $zip by ' ' into $desc_zip
! CWB 04/05/2001 END

  print $desc_zip () center bold
  position (+1)
  
  move $company to $save_company
  move $paygroup to $save_paygroup
  move $prev_company to $company
  move $prev_paygroup to $paygroup
  
  do get-company-desc
  do get-paygroup-desc

  !string $company_Desc $paygroup_Desc by '/' into $sub_desc   ! VENDKXY Done changes for the ITG 66163
  string $company $company_Desc by '/' into $sub_desc   ! VENDKXY Done changes for the ITG 66163
  print $sub_desc (,1)
  
  move $save_company to $company
  move $save_paygroup to $paygroup

  position (+2)
  
  ! VENDKXY Done changes for the ITG 66163-- Begin

  !print 'Name' 		(,8) bold
  !print 'SSN' 		(,55) bold
  !print 'Garn Type' 	(,67) bold
  !print 'Court Document ID''s' (,82) bold
  !print 'Payment' 	(,121) bold  !AXL-10/30/2000 - Changed from 101
  !print 'Fee (Co)' 	(,136) bold  !AXL-10/30/2000 - Changed from 116	
  !print 'Total Payment' (,149) bold  !AXL-10/30/2000 - Changed from 129
  !print '-' 		(+1,1,176) fill
  
  print 'Company'       (,1)  
  print 'Deptid'        (,09)
  print 'Name' 		(,16) bold
  print 'SSN' 		(,47) bold
  print 'Garn Type' 	(,57) bold
  print 'Court Document IDs' (,68) bold
  print 'Payee Name'    (,110) bold
  print 'Payment' 	(,141) bold  
  print 'Fee (Co)' 	(,153) bold  	
  print 'Total Payment' (,165) bold  
  print '-' 		(+1,1,177) fill
 
 ! VENDKXY Done changes for the ITG 66163-- End
 
end-heading


 ! VENDKXY Done changes for the ITG 66163-- Begin
!*********************************************************************
!Prints the header information in the Garn-Payee-Report1
!*********************************************************************

begin-heading 9 for-reports=(Garn-Payee-Report1)
#debug9 display 'Garn-Payee-Report1 Heading Section'

move 'Garnishments Report by Payee' to $ReportTitle

LET $REPORTID = 'PY051OIR'

 #Include 'stdhdg01.sqc'

  position (-1)

  if $prev_payee = '0001030372-001'
    do get-payee-name-ohio
  else
    do get-payee-name  
  end-if
  
  Uppercase $prev_payee_name  ! VENDKXY Done changes for the ITG 66163
 Uppercase $prev_payee       ! VENDKXY Done changes for the ITG 66163

  string $prev_payee_name $prev_payee by '/' into $desc
  print $desc () center bold
 
  position (+1)

  print $ADDRESS1 () center bold
  
  position (+1)
  move ' ' to $desc_zip

  string $CITY $STATE $zip by ' ' into $desc_zip


  print $desc_zip () center bold
  position (+1)
  
  move $company to $save_company
  move $paygroup to $save_paygroup
  move $prev_company to $company
  move $prev_paygroup to $paygroup
  
  do get-company-desc
  do get-paygroup-desc

  !string $company_Desc $paygroup_Desc by '/' into $sub_desc   ! VENDKXY Done changes for the ITG 66163
  string $company $company_Desc by '/' into $sub_desc   ! VENDKXY Done changes for the ITG 66163
  print $sub_desc (,1)
  
  move $save_company to $company
  move $save_paygroup to $paygroup

  position (+2)
 
  print 'Company'       (,1)  
  print 'Deptid'        (,09)
  print 'Name' 		(,16) bold
  print 'SSN' 		(,47) bold
  print 'Court Document ID' (,57) bold
  print 'Judgment Creditor' (,83) bold
  print 'Payee Name'    (,110) bold
  print 'Payment' 	(,141) bold  
  print 'Fee (Co)' 	(,153) bold  	
  print 'Total Payment' (,165) bold  
  print '-' 		(+1,1,177) fill
 
end-heading



!*********************************************************************
!Prints the header information in the Garn-Payee-Report2
!*********************************************************************

begin-heading 9 for-reports=(Garn-Payee-Report2)
#debug9 display 'Garn-Payee-Report1 Heading Section'

move 'Garnishments Report by Payee' to $ReportTitle

LET $REPORTID = 'PY051CHS'

 #Include 'stdhdg01.sqc'

  position (-1)

  if $prev_payee = '0001030372-001'
    do get-payee-name-ohio
  else
    do get-payee-name  
  end-if
  
  Uppercase $prev_payee_name  ! VENDKXY Done changes for the ITG 66163
 Uppercase $prev_payee       ! VENDKXY Done changes for the ITG 66163

 ! string $prev_payee_name $prev_payee by '/' into $desc
 ! print $desc () center bold
 
 if $prev_payee_name <> ' '
 print $prev_payee_name () center bold
 else 
 print $prev_payee () center bold
 end-if
 
  position (+1)

  print $ADDRESS1 () center bold
  
  position (+1)
  move ' ' to $desc_zip

  string $CITY $STATE $zip by ' ' into $desc_zip


  print $desc_zip () center bold
  position (+1)
  
  move $company to $save_company
  move $paygroup to $save_paygroup
  move $prev_company to $company
  move $prev_paygroup to $paygroup
  
  do get-company-desc
  do get-paygroup-desc

 !string $company_Desc $paygroup_Desc by '/' into $sub_desc   ! VENDKXY Done changes for the ITG 66163
  string $company $company_Desc by '/' into $sub_desc   ! VENDKXY Done changes for the ITG 66163
  print $sub_desc (,1)
  
  move $save_company to $company
  move $save_paygroup to $paygroup

  position (+2)
  print 'Company'       (,1)  
  print 'Deptid'        (,09)
  print 'Name' 		(,16) bold
  print 'SSN' 		(,47) bold
  print 'Court Document ID' (,57) bold
  print 'Court Document ID2' (,83) bold
  print 'Payee Name'    (,110) bold
  print 'Payment' 	(,141) bold  
  print 'Fee (Co)' 	(,153) bold  	
  print 'Total Payment' (,165) bold  
  print '-' 		(+1,1,177) fill
 
end-heading

 ! VENDKXY Done changes for the ITG 66163-- End



!*********************************************************************
!Prints the footer in the report log
!*********************************************************************

begin-footing 2 for-reports=(Report-log)
page-number (1,160) 'Page '  
last-page () ' of ' '.'

end-footing

!*********************************************************************
!Prints the footer in the Garn-Payee-Report
!*********************************************************************

begin-footing 2 for-reports=(Garn-Payee-Report)
page-number (1,160) 'Page '  
last-page () ' of ' '.'

end-footing

  ! VENDKXY Done changes for the ITG 66163-- Begin
  
!*********************************************************************
!Prints the footer in the Garn-Payee-Report1
!*********************************************************************

begin-footing 2 for-reports=(Garn-Payee-Report1)
page-number (1,160) 'Page '  
last-page () ' of ' '.'

end-footing  

!*********************************************************************
!Prints the footer in the Garn-Payee-Report2
!*********************************************************************

begin-footing 2 for-reports=(Garn-Payee-Report2)
page-number (1,160) 'Page '  
last-page () ' of ' '.'

end-footing
  
  
!*********************************************************************
!Retrieves the employees with latest paychecks and with garnishment 
!deductions.
!*********************************************************************

Begin-Procedure Process-Employee-Data
move 'N' to $errorfound
move 'N' to $found
move 'N' to $new_page
let #inputtran = 0
position (1)
!SXK 11/17/1999
do select-pay-end-dt
show 'Pay End Date ' $pay_end_dt
!SXK 11/17/1999
 
begin-SELECT
/*+ RULE */
B.COMPANY () on-break print=never level=1 save=$prev_company after=company-change
C.AP_VENDOR_ID () on-break print=never level=2 save=$prev_payee after=payee-change  ! Vendkxy Changed to level 2
B.PAYGROUP !() on-break print=never level=2 save=$prev_paygroup after=paygroup-change !VENDKXY Done changes for ITG 66163
B.EMPLID   
B.NAME  !VENDKXY Done changes for ITG 66163
B.DEPTID    !VENDKXY Done changes for ITG 66163
B.EMPL_RCD  
B.PAY_END_DT
!B.OFF_CYCLE	!VENDKXY Done changes for ITG 66163
!B.PAGE_NUM	!VENDKXY Done changes for ITG 66163
!B.LINE_NUM	!VENDKXY Done changes for ITG 66163
!B.SEPCHK	!VENDKXY Done changes for ITG 66163
C.GARNID 
C.GARN_TYPE 
C.COURT_DOC_ID !(,82)
C.COURT_DOC_ID2		!AXL    - 10/30/2000
C.GARN_PAYEE_NAME       !ISDVSRC- 03/15/2005
!D.DEDUCT_GARN_AMT	!VENDKXY Done changes for ITG 66163

  !ISDVRXD 07-19-2007 Start
  move 'N' to $Auto_Brk_Pay_Chg
  !ISDVRXD 07-19-2007 End
                               
  Let $deptid = &B.DEPTID    !VENDKXY Done changes for ITG 66163  
  move &B.COMPANY to $company  !VENDKXY Done changes for ITG 66163 
  move &B.paygroup to $paygroup  !VENDKXY Done changes for ITG 66163 
  move &C.AP_VENDOR_ID to $VendorID !VENDKXY Done changes for ITG 66163
  move &B.pay_end_dt to $pay_end_dt  !VENDKXY Done changes for ITG 66163 
  Let   $court_doc_id =   &C.COURT_DOC_ID     !VENDKXY Done changes for ITG 66163
  Let   $court_doc_id2 =   &C.COURT_DOC_ID2    !VENDKXY Done changes for ITG 66163               
  Let $GARN_PAYEE_NAME  = &C.GARN_PAYEE_NAME    !ISDVSRC 03/15/2005

  add 1 to #inputtran

  move 'Y' to $found
  move 'GARN_TYPE' to $FIELDNAME
  move &C.GARN_TYPE to $FIELDVALUE

  !AXL - 10/30/2000 - Begin
  if isblank(&C.COURT_DOC_ID2) = 0
     let $court_doc_ids = rtrim(&C.COURT_DOC_ID, ' ') || ' / ' || rtrim(&C.COURT_DOC_ID2, ' ')
  else
     let $court_doc_ids = &C.COURT_DOC_ID
  end-if
  !AXL - 10/30/2000 - Begin

!  display &b.emplid

  if #inputtran = 1
  
     move &b.emplid to $prev_emplid
     move &b.empl_Rcd to #prev_empl_Rcd#
     move &c.garnid to $prev_garnid
     
     !ISDVRXD 07-19-2007 Start
     move &B.COMPANY to $Pre_Company_Chck
     move &B.PAYGROUP to $Pre_Paygroup_Chck
     move &C.AP_VENDOR_ID to $Pre_Vendor_Chck
     move &C.GARN_PAYEE_NAME to $Pre_Payee_Name_Chck
     !ISDVRXD 07-19-2007 End
          
    do emplid-change !VENDKXY Done changes for ITG 66163
  else
     if rtrim($prev_emplid,' ') <> &b.emplid or  !VENDKXY Done changes for ITG 66163 
! CWB 02/26/2003 BEGIN
!        #prev_empl_rcd <> &b.empl_rcd or 
        #prev_empl_rcd# <> &b.empl_rcd  or       !VENDKXY Done changes for ITG 66163 
! CWB 02/26/2003 END

       rtrim($prev_garnid,' ') <> &c.garnid  !VENDKXY Done changes for ITG 66163  !VENDKXY Done changes for ITG 70341
          move &b.emplid to $prev_emplid
          move &b.empl_Rcd to #prev_empl_Rcd#
          move &c.garnid to $prev_garnid
          
          !ISDVRXD 07-19-2007 Start
          move &B.COMPANY to $Curr_Company_Chck
          move &B.PAYGROUP to $Curr_Paygroup_Chck
          move &C.AP_VENDOR_ID to $Curr_Vendor_Chck
          move &C.GARN_PAYEE_NAME to $Curr_Payee_Name_Chck
          
          do emplid-change 
          
          !VENDKXY Done changes for ITG 66163 
          !If ($Pre_Company_Chck = $Curr_Company_Chck And 
          !   ! $Pre_Paygroup_Chck = $Curr_Paygroup_Chck And    !VENDKXY Done changes for ITG 66163
           !$Pre_Vendor_Chck  <> $Curr_Vendor_Chck ) !And  !VENDKXY Done changes for ITG 66163
          !    !$Curr_Payee_Name_Chck <> $Pre_Payee_Name_Chck)  !VENDKXY Done changes for ITG 66163
          !    !show 'Break Here Empl ID ' &b.emplid
           !   move 'Y' to $Auto_Brk_Pay_Chg
           !   let $GARN_PAYEE_NAME = $Pre_Payee_Name_Chck
          !    do payee-change
          !    let $GARN_PAYEE_NAME = $Curr_Payee_Name_Chck
          !end-if
          !VENDKXY Done changes for ITG 66163 
         let $Pre_Company_Chck = $Curr_Company_Chck
         let $Pre_Paygroup_Chck = $Curr_Paygroup_Chck 
         let $Pre_Vendor_Chck  = $Curr_Vendor_Chck
         let $Pre_Payee_Name_Chck = $Curr_Payee_Name_Chck
         !ISDVRXD 07-19-2007 End
     end-if  !VENDKXY Done changes for ITG 66163
  end-if
 
! do emplid-change 
 
!  do get-xlat-desc
!  print $field_desc (,67)

!  do get-empl-name
!  do Get-Garn-Amounts

  move 'N' to $new_page

FROM  
!PS_PAY_CALENDAR A, PS_PAY_CAL_BAL_ID A1,
      PS_PAY_CHECK    B,
      PS_GARN_SPEC C,
      PS_PAY_GARNISH D   
WHERE [$GEXXX901_INCLUDE_COMPANY_PAYGROUP_CRITERIA]
  AND [$GEXXX902_INCLUDE_DEPTID_CRITERIA]
  AND [$ap_vendor_id]
!SXK 11/17/1999 Begin - Commented following lines as pay_calendar
!	and pay_cal_bal_id are not being used
!  AND A.COMPANY = A1.COMPANY AND A.PAYGROUP = A1.PAYGROUP
!  AND A.PAY_END_DT = A1.PAY_END_DT AND A1.BALANCE_ID = 'CY'
!  AND B.COMPANY         = A.COMPANY
!  AND B.PAYGROUP        = A.PAYGROUP
  AND B.PAY_END_DT      = $pay_end_dt   
!  AND B.PAY_END_DT = (SELECT MAX(PAY_END_DT)
!			FROM PS_PAY_CHECK 
!		       WHERE COMPANY = B.COMPANY
!			 AND PAYGROUP = B.PAYGROUP
!			 AND PAY_END_DT <= $rnctl_date)
!SXK 11/17/1999 End
  AND B.PAYCHECK_NBR         <> 0
!  AND B.PAYCHECK_OPTION IN ('C','&')
  AND B.PAYCHECK_STATUS in ('F','A') !added status Adjust 09/02/99 !VENDKXY Done changes for ITG 66163
 ! AND [$paycheckstatus]				!VENDKXY Done changes for ITG 66163
  AND C.COMPANY         = B.COMPANY
  AND C.EMPLID          = B.EMPLID
  AND D.COMPANY         = B.COMPANY
  AND D.PAYGROUP        = B.PAYGROUP
  AND D.OFF_CYCLE       = B.OFF_CYCLE
  AND D.PAGE_NUM        = B.PAGE_NUM
  AND D.LINE_NUM        = B.LINE_NUM
  AND D.SEPCHK          = B.SEPCHK
  AND D.GARNID          = C.GARNID
  AND D.PAY_END_DT      = B.PAY_END_DT
  [$Clause]   !VENDKXY Done changes for ITG 66163
!SXK 03/24/99 Begin
! AND D.DEDUCT_GARN_AMT > 0
!SXK 03/24/99 End
 ! [$deptidclause]		!VENDKXY Done changes for ITG 66163
 ! [$groupby]			!VENDKXY Done changes for ITG 66163
 ! [$having]			!VENDKXY Done changes for ITG 66163

!ORDER BY B.COMPANY, B.PAYGROUP, C.AP_VENDOR_ID, C.GARN_PAYEE_NAME, B.EMPLID, B.EMPL_RCD,C.GARNID  !VENDKXY Done changes for ITG 66163
[$order_by]  !VENDKXY Done changes for ITG 66163

end-SELECT

if $found = 'N'
   do error-found
   print 'No Garnishments found for the latest payroll run'(,34)
   
!VENDKXY Done changes for ITG 66163--Begin   
   !use-report Garn-Payee-Report
  if $report = 'PY051GRN'
  use-report Garn-Payee-Report
  else 
  if $report = 'PY051OIR'
  use-report Garn-Payee-Report1
  else
  use-report Garn-Payee-Report2
  end-if
  end-if 
  
!VENDKXY Done changes for ITG 66163--End  
!else

!print 'Total for Paygroup'  (+2,1)

!print #paygroup_garn_Amt (,70)
!print #paygroup_fee (,85)
!print #paygroup_ded_amt (,100)

!print 'Total for Company'  (+2,1)

!print #company_garn_amt (,70)
!print #company_fee (,85)
!print #company_ded_amt (,100)

!print 'Total for Payee'  (+2,1)

!print #Payee_garn_Amt (,70)
!print #payee_fee    (,85)
!print #payee_ded_amt    (,100)

end-if

end-procedure

!VENDKXY Done changes for ITG 66163--Begin   
!*********************************************************************
! Process-Employee-Data1 is used for processing of PY051CHS
!*********************************************************************

Begin-Procedure Process-Employee-Data1
move 'N' to $errorfound
move 'N' to $found
move 'N' to $new_page
let #inputtran = 0
position (1)
do select-pay-end-dt
show 'Pay End Date ' $pay_end_dt

begin-SELECT
/*+ RULE */
B1.COMPANY () on-break print=never level=1 save=$prev_company after=company-change
upper(C1.GARN_PAYEE_NAME) &C1.GARN_PAYEE_NAME () on-break print=never level=2 save=$prev_payee1 after=payee-change
B1.PAYGROUP
C1.AP_VENDOR_ID 
B1.EMPLID   
B1.NAME  
B1.DEPTID    
B1.EMPL_RCD  
B1.PAY_END_DT
C1.GARNID 
C1.GARN_TYPE 
C1.COURT_DOC_ID 
C1.COURT_DOC_ID2
  move 'N' to $Auto_Brk_Pay_Chg
  Let $deptid = &B1.DEPTID    !VENDKXY Done changes for ITG 66163  
  move &B1.COMPANY to $company  !VENDKXY Done changes for ITG 66163 
   move &B1.paygroup to $paygroup  !VENDKXY Done changes for ITG 66163 
     move &C1.AP_VENDOR_ID to $prev_payee !VENDKXY Done changes for ITG 66163
  move &B1.pay_end_dt to $pay_end_dt  !VENDKXY Done changes for ITG 66163
  Let   $court_doc_id =   &C1.COURT_DOC_ID     !VENDKXY Done changes for ITG 66163
   Let   $court_doc_id2 =   &C1.COURT_DOC_ID2    !VENDKXY Done changes for ITG 66163               
  Let $GARN_PAYEE_NAME  = &C1.GARN_PAYEE_NAME    !ISDVSRC 03/15/2005

  add 1 to #inputtran

  move 'Y' to $found
  move 'GARN_TYPE' to $FIELDNAME
  move &C1.GARN_TYPE to $FIELDVALUE

  if #inputtran = 1
  
     move &B1.emplid to $prev_emplid
     move &B1.empl_Rcd to #prev_empl_Rcd#
     move &C1.garnid to $prev_garnid
     move &B1.COMPANY to $Pre_Company_Chck
     move &B1.PAYGROUP to $Pre_Paygroup_Chck
     move &C1.AP_VENDOR_ID to $Pre_Vendor_Chck
     move &C1.GARN_PAYEE_NAME to $Pre_Payee_Name_Chck

    do emplid-change 
  else
     !VENDKXY Done changes for ITG 70341-- Begin
     if rtrim($prev_emplid,' ') <> &B1.emplid or 
        #prev_empl_rcd# <> &B1.empl_rcd  or  rtrim($prev_garnid,' ') <> &c1.garnid
     !VENDKXY Done changes for ITG 70341--End
         move &B1.emplid to $prev_emplid
          move &B1.empl_Rcd to #prev_empl_Rcd#
          move &C1.garnid to $prev_garnid
          
          
          move &B1.COMPANY to $Curr_Company_Chck
          move &B1.PAYGROUP to $Curr_Paygroup_Chck
          move &C1.AP_VENDOR_ID to $Curr_Vendor_Chck
          move &C1.GARN_PAYEE_NAME to $Curr_Payee_Name_Chck
          
          do emplid-change 
         let $Pre_Company_Chck = $Curr_Company_Chck
         let $Pre_Paygroup_Chck = $Curr_Paygroup_Chck 
         let $Pre_Vendor_Chck  = $Curr_Vendor_Chck
         let $Pre_Payee_Name_Chck = $Curr_Payee_Name_Chck
 
    end-if  !VENDKXY Done changes for ITG 70341
  end-if
   move 'N' to $new_page

FROM  PS_PAY_CHECK    B1,
      PS_GARN_SPEC C1,
      PS_PAY_GARNISH D1,
      ps_gex_dept_tbl e    
WHERE [$GEXXX901_INCLUDE_COMPANY_PAYGROUP_CRITERIA]
  AND [$GEXXX902_INCLUDE_DEPTID_CRITERIA]
  AND [$ap_vendor_id]
  AND B1.PAYCHECK_NBR         <> 0
  AND [$paycheckstatus]				
  AND C1.COMPANY         = B1.COMPANY
  AND C1.EMPLID          = B1.EMPLID
  AND D1.COMPANY         = B1.COMPANY
  AND D1.PAYGROUP        = B1.PAYGROUP
  AND D1.OFF_CYCLE       = B1.OFF_CYCLE
  AND D1.PAGE_NUM        = B1.PAGE_NUM
  AND D1.LINE_NUM        = B1.LINE_NUM
  AND D1.SEPCHK          = B1.SEPCHK
  AND D1.GARNID          = C1.GARNID
  AND D1.PAY_END_DT      = B1.PAY_END_DT
  and B1.PAY_END_DT = $pay_end_dt
  AND e.setid = 'COMMN'
   AND e.deptid = b1.deptid
   AND e.effdt = (SELECT MAX(e1.effdt)
		   FROM ps_gex_dept_tbl e1
		   WHERE e1.setid = e.setid
		   AND e1.deptid = e.deptid
		   AND e1.effdt <= $pay_end_dt)
   AND e.sequence_number = (SELECT MAX(e2.sequence_number)
	   		   FROM ps_gex_dept_tbl e2
			   WHERE e2.setid = e.setid
			   AND e2.deptid = e.deptid
			   AND e2.effdt = e.effdt) 
  [$Clause]   
  [$groupby]			
  [$order_by] 
end-SELECT

if $found = 'N'
   do error-found
   print 'No Garnishments found for the latest payroll run'(,34)
   use-report Garn-Payee-Report2
end-if 
 
end-procedure
!VENDKXY Done changes for ITG 66163--End 

!***********************************************************************   

Begin-Procedure select-pay-end-dt
let $pay_End_dt = ''
begin-select distinct
py.pay_end_dt
  move &py.pay_end_dt to $pay_end_dt
from ps_pay_calendar py
where py.pay_confirm_run = 'Y'
and py.pay_end_Dt = (select max(pay_end_dt)
		from ps_pay_calendar
! CWB 02/26/2003 BEGIN
!		where company = py.company
!		and paygroup = py.paygroup
                where pay_confirm_run = 'Y'
! CWB 02/26/2003 END
		and pay_End_dt <= $rnctl_date) 
	
		
end-select

end-procedure



!***********************************************************************
begin-procedure Get-Garn-Amounts
!***********************************************************************

move 'N' to $errorfound
move 'N' to $found

begin-SELECT ON-ERROR=sql-error-found('Get-Garn-Amounts')
/*+ RULE */
SUM(GR.DEDUCT_GARN_AMT) &ded_garn_amt
SUM(GR.DEDUCT_CMPNY_FEE) &ded_cmpny_fee
SUM(GR.DEDUCT_AMT) &ded_amt

    move 'Y' to $found

    !AXL 1/14/2000 Added per user request Begin
    if &ded_amt = 0
       move 0 to #ded_garn_amt
       move 0 to #ded_cmpny_fee
    else
       move &ded_garn_amt to #ded_garn_amt
       move &ded_cmpny_fee to #ded_cmpny_fee
    end-if
    !AXL 1/14/2000 Added per user request End

    move &ded_Amt to #ded_amt
    
    !VENDKXY done changes for ITG 66163-Begin

    !print #ded_garn_amt (,119) edit 99990.99	!AXL-10/30/2000 - Changed from 99
    !print #ded_cmpny_fee (,135) edit 99990.99	!AXL-10/30/2000 - Changed from 115
    !print #ded_amt (,152) edit 99990.99		!AXL-10/30/2000 - Changed from 132
    
    print #ded_garn_amt (,141) edit 99990.99	
    print #ded_cmpny_fee (,153) edit 99990.99	
    print #ded_amt (,165) edit 99990.99	        
    
    !VENDKXY done changes for ITG 66163-End
    
    add #ded_garn_amt to #paygroup_garn_amt
    add #ded_cmpny_fee to #paygroup_fee
    add #ded_amt to #paygroup_ded_amt

    add #ded_garn_amt to #company_garn_amt
    add #ded_cmpny_fee to #company_fee
    add #ded_amt to #company_ded_amt
    
    add #ded_garn_amt to #payee_garn_amt
    add #ded_cmpny_fee to #payee_fee
    add #ded_amt to #payee_ded_amt
    
     position (+1)

FROM PS_PAY_GARNISH GR, PS_PAY_CHECK GR1 !SXK Added pay check join 06/28/1999
!WHERE GR.COMPANY = &B.COMPANY
!  AND GR.PAYGROUP = &B.PAYGROUP
!  AND GR.PAY_END_DT = &B.PAY_END_DT
WHERE GR.COMPANY = $COMPANY
  AND GR.PAYGROUP = $PAYGROUP
  AND GR.PAY_END_DT = $PAY_END_DT
!SXK 06/28/1999 begin
  AND GR1.EMPLID = $prev_EMPLID  
! CWB 02/26/2003 BEGIN
!  AND GR1.EMPL_RCD = #prev_EMPL_RCD
  AND GR1.EMPL_RCD = #prev_EMPL_RCD#
! CWB 02/26/2003 END
  AND GR.COMPANY = GR1.COMPANY
  AND GR.PAYGROUP = GR1.PAYGROUP
  AND GR.PAY_END_DT = GR1.PAY_END_DT
  AND GR.OFF_CYCLE = GR1.OFF_CYCLE
  AND GR.PAGE_NUM = GR1.PAGE_NUM
  AND GR.LINE_NUM = GR1.LINE_NUM
  AND GR.SEPCHK = GR1.SEPCHK
  AND GR1.PAYCHECK_NBR <> 0
!SXK 06/28/1999 End
  AND GR.GARNID = $prev_GARNID
  
end-select

if $found = 'N'
   do error-found
   print 'No Garnishment amounts found for Garn ID: '(,34)
   print &C.GARNID ()
 !VENDKXY Done changes for ITG 66163--Begin   
   !use-report Garn-Payee-Report
  if $report = 'PY051GRN'
  use-report Garn-Payee-Report
  else 
  if $report = 'PY051OIR'
  use-report Garn-Payee-Report1
  else
  use-report Garn-Payee-Report2
  end-if
  end-if 
  
!VENDKXY Done changes for ITG 66163--End  
end-if

end-procedure

begin-procedure emplid-change     

  !VENDKXY Done changes for ITG 66163-Begin
  
  !do get-company-desc
   ! print $company_Desc       (,1)  
   
   print $company  (+1,1)
   
   print $Deptid    (,9)
   
   !print $prev_emplid (,52)
   ! 1289792 09/14/2016 Begins
   !print $prev_emplid (,47)
   !GEX_SEC_REENG 2016-09-23 Vahini Katta Begins
    do Get-Emp-Ssn ($prev_emplid, $Ssn_Out)
    !print 'xxxxx'||substr($prev_emplid,6,4) (,47)
   ! 1289792 09/28/2016- Report displaying 0 amounts- Begins
    !let $prev_emplid= 'xxxxx'||substr($Ssn_Out,6,4)
    !print $prev_emplid (,47)
    let $maskedSSN = 'xxxxx'||substr($Ssn_Out,6,4)
    print $maskedSSN (,47)
   ! 1289792 09/28/2016- Report displaying 0 amounts- End
   !GEX_SEC_REENG 2016-09-23 Vahini Katta Ends
   ! 1289792 09/14/2016 Ends
  if $report = 'PY051GRN'
  
   do get-xlat-desc
  !print $field_desc (,67)   
  
  print $field_desc (,57)
  
  !print &c.court_doc_id (,82)
  !print $court_doc_ids (,82)	!AXL - 10/30/2000
  
  print $court_doc_ids (,68)
 
  else 
  if $report = 'PY051OIR' or $report = 'PY051CHS'
  
  print $court_doc_id (,57)
  print $court_doc_id2 (,83)
    
  end-if
  end-if 
  !VENDKXY Done changes for ITG 66163--End
  
  print $GARN_PAYEE_NAME (,110) 
  
  do get-empl-name
  do Get-Garn-Amounts
  
  position (-1)

   !show ' $company = ' $company  ' $Deptid = ' $Deptid  '$prev_EMPLid = ' $prev_EMPLID  ' #ded_garn_amt = ' #ded_garn_amt ' #ded_cmpny_fee = ' #ded_cmpny_fee ' #ded_amt =' #ded_amt !testing 
end-procedure
!*********************************************************************
!If there is a change in the Company Codes of the employees, prints 
!the running totals of the balances and starts calculating for the 
!newly read Company Code
!*********************************************************************

begin-procedure company-change

move 'N' to $company_change

!  if RTRIM(&B.COMPANY,' ') <> ''
!     if &B.COMPANY = $prev_company
!	goto proc-exit
!     else
!        move 'Y' to $company_change
!       move &B.COMPANY to $company
!       do get-company-desc
!     end-if
!  end-if

print 'Total for Company:'  (+2,1)
print $prev_company ()

!VENDKXY done changes for ITG 66163--Begin

!print #company_garn_amt (,119) edit 99990.99	!AXL-10/30/2000 - Changed from 99
!print #company_fee (,135) edit 99990.99		!AXL-10/30/2000 - Changed from 115
!print #company_ded_amt (,152) edit 99990.99	!AXL-10/30/2000 - Changed from 132   

print #company_garn_amt (,141) edit 99990.99     
print #company_fee (,153) edit 99990.99		
print #company_ded_amt (,165) edit 99990.99     

!VENDKXY done changes for ITG 66163--End

move 0 to #company_garn_amt
move 0 to #company_fee
move 0 to #company_ded_amt

!if ($paygroup_change = 'Y' or $company_change = 'Y' or 
!   $payee_change = 'Y') and $new_page = 'N' 
!   if RTRIM(&C.AP_VENDOR_ID,' ') <> ''
!     if &C.AP_VENDOR_ID <> $prev_payee
!        move 'N' to $new_page
!     else
!        move 'Y' to $new_page
!        new-page
!     end-if
!   else
!     move 'Y' to $new_page
!     new-page
!   end-if
!end-if


   new-page

proc-exit:

end-procedure

!*********************************************************************
!If there is a change in the Paygroup of the employees, prints 
!the running totals of the balances and starts calculating for the 
!newly read Paygroup Code
!*********************************************************************

begin-procedure paygroup-change

move 'N' to $paygroup_change

!  if RTRIM(&B.PAYGROUP,' ') <> ''
!    if &B.PAYGROUP = $prev_paygroup
!       goto paygroup-exit
!    else
!      move 'Y' to $paygroup_change
!      move &B.PAYGROUP to $paygroup
!      do get-paygroup-desc
!    end-if
!  end-if

print 'Total for Paygroup:'  (+2,1)
print $prev_paygroup ()

!VENDKXY Done changes for ITG 66163-Begin           
           
!print #paygroup_garn_Amt (,119) edit 99990.99	!AXL-10/30/2000 - Changed from 99
!print #paygroup_fee (,135) edit 99990.99	!AXL-10/30/2000 - Changed from 115		
!print #paygroup_ded_amt (,152) edit 99990.99	!AXL-10/30/2000 - Changed from 132          

print #paygroup_garn_Amt (,141) edit 99990.99	
print #paygroup_fee (,153) edit 99990.99	
print #paygroup_ded_amt (,165) edit 99990.99	

!VENDKXY Done changes for ITG 66163-End

move 0 to #paygroup_garn_Amt
move 0 to #paygroup_fee
move 0 to #paygroup_ded_amt
  if &B.PAYGROUP <> $prev_paygroup
     if &B.COMPANY <> $prev_company
        move 'N' to $new_page
     else
         move 'Y' to $new_page
         new-page
     end-if
  end-if

paygroup-exit:

end-procedure

!*********************************************************************
!If there is a change in the Payee Codes of the employees, prints 
!the running totals of the balances and starts calculating for the 
!newly read Payee Code
!*********************************************************************

begin-procedure Payee-change
!SHOW ' Payee-change-----------------------------' 
move 'N' to $payee_change
move 'N' to $brk_chck
!  if RTRIM(&C.AP_VENDOR_ID,' ') <> ''
!    if &C.AP_VENDOR_ID = $prev_payee
!       goto payee-exit
!    else
!       move 'Y' to $payee_change
!    end-if
!  end-if

print 'Total for Payee:'  (+2,1)

!VENDKXY Done changes for ITG 66163--Begin

!print #Payee_garn_Amt (,119) edit 99990.99	!AXL-10/30/2000 - Changed from 99
!print #payee_fee    (,135) edit 99990.99	!AXL-10/30/2000 - Changed from 115
!print #payee_ded_amt    (,152) edit 99990.99	!AXL-10/30/2000 - Changed from 132   

print #Payee_garn_Amt (,141) edit 99990.99	
print #payee_fee    (,153) edit 99990.99	
print #payee_ded_amt    (,165) edit 99990.99    

!VENDKXY Done changes for ITG 66163--End

move 0 to #payee_garn_Amt
move 0 to #payee_fee
move 0 to #payee_ded_amt

!if ($paygroup_change = 'Y' or $company_change = 'Y' or 
!   $payee_change = 'Y') and
!VENDKXY Done changes for ITG 66163
 if $report = 'PY051CHS'
   if  &C1.GARN_PAYEE_NAME  <> $prev_payee1
      if &B1.COMPANY <> $prev_company 
           move 'N' to $new_page
           else
              move 'Y' to $new_page
              move 'Y' to $brk_chck
              new-page
           end-if
      end-if
 else 
 if  &C.AP_VENDOR_ID <> $prev_payee !VENDKXY Done changes for ITG 66163
       !if &B.PAYGROUP <> $prev_paygroup    !VENDKXY Done changes for ITG 66163
     !   move 'N' to $new_page		   !VENDKXY Done changes for ITG 66163
     !else				   !VENDKXY Done changes for ITG 66163
           if &B.COMPANY <> $prev_company  
               move 'N' to $new_page
           else
              move 'Y' to $new_page
              move 'Y' to $brk_chck
              new-page
           end-if
     !end-if				  !VENDKXY Done changes for ITG 66163
  end-if
  end-if
  
!VENDKXY Done changes for ITG 66163  
  !ISDVRXD 07-19-2007 Start
  if $Auto_Brk_Pay_Chg = 'Y' And $brk_chck = 'N'
    move 'Y' to $new_page
    new-page
  end-if
  !ISDVRXD 07-19-2007 End
  
payee-exit:

end-procedure

!*********************************************************************
!Retrieves the Company Description from the database
!*********************************************************************

begin-procedure get-company-desc

move ' ' to $company_desc

!  display $company

begin-select on-error=sql-error-found('get-company-desc')
/*+ RULE */
J.DESCR

  move &J.DESCR to $company_Desc
  

from PS_COMPANY_TBL J

WHERE J.COMPANY = $COMPANY
  AND J.EFFDT =
      (SELECT MAX(EFFDT)
	 FROM PS_COMPANY_TBL
	WHERE COMPANY = $COMPANY)
end-select

end-procedure

!*********************************************************************
!Retrieves the Paygroup Description from the database
!*********************************************************************

begin-procedure get-paygroup-desc

move ' ' to $paygroup_Desc

!display $paygroup

begin-select on-error=sql-error-found('get-paygroup-desc')
/*+ RULE */
K.DESCR

   move &K.DESCR to $paygroup_desc
   
FROM PS_PAYGROUP_TBL K

WHERE K.PAYGROUP = $PAYGROUP
  AND K.EFFDT =
       (SELECT MAX(EFFDT)
	  FROM PS_PAYGROUP_TBL 
	 WHERE PAYGROUP = $paygroup)
end-select

end-procedure

!*********************************************************************
!Retrieves the Employee Name from the database
!*********************************************************************

begin-procedure get-empl-name

move ' ' to $name

begin-select on-error=sql-error-found('get-empl-name')
/*+ RULE */
H.NAME

   move &H.NAME to $name
   !print $name (,1)      	!VENDKXY done changes for ITG 66163
   print $name (,15)    	!VENDKXY done changes for ITG 66163

FROM PS_PERSONAL_DATA H

WHERE H.EMPLID = $prev_EMPLID
end-select

end-procedure


!*********************************************************************
!Retrieves the Payee Name from the database
!*********************************************************************
begin-procedure get-payee-name
#debug9 display 'get-payee-name'

  move ' ' to $prev_payee_name
  
  !AXL 9/26/2005 - Begin
  #ifdef debug8
    show '$prev_company ' $prev_company
    show '$prev_payee ' $prev_payee
    show 'C.AP_VENDOR_ID ' &C.AP_VENDOR_ID
    show '$GARN_PAYEE_NAME ' $GARN_PAYEE_NAME
  #endif

  let $found_payee_name='N'
  !AXL 9/26/2005 - End

begin-select on-error=sql-error-found('get-payee-name')
/*+ RULE */
I.GARN_PAYEE_NAME
I.ADDRESS1
!I.ADDRESS2
!I.ADDRESS3
!I.ADDRESS4
I.CITY
I.STATE
!SXK 12/13/1999 Changed from zip to postal
I.POSTAL

   move &I.GARN_PAYEE_NAME to $prev_payee_name
  let $found_payee_name='Y'	!AXL 9/26/2005

! CWB 04/05/2001 BEGIN
   Let $ADDRESS1 = &I.ADDRESS1
   Let $CITY = &I.CITY
   Let $STATE = &I.STATE
   Let $ZIP = &I.POSTAL
! CWB 04/05/2001 END
  
FROM PS_GARN_SPEC I  ! GEX ISDVNPK 11/12/2007    PS_GEX_GARN_PAYEE I		!SRK 11/11/2002 Modified from garn_payee_tbl to 
					!gex_garn_payee. 
WHERE I.AP_VENDOR_ID    = $prev_payee
 AND  upper(I.GARN_PAYEE_NAME) = upper($GARN_PAYEE_NAME)  !ISDVSRC 03/15/2005  !vendkxy done changes for ITG 66163
end-select

   !AXL 9/26/2005 - Begin
   if $found_payee_name='N'
      do get-payee-name2
   end-if
   !AXL 9/26/2005 - End

end-procedure
!*********************************************************************

!AXL 9/26/2005 - New Procedure - Begin
!*********************************************************************
!Retrieves the Payee Name from PS_GARN_SPEC instead
!*********************************************************************
begin-procedure get-payee-name2
#debug9 display 'get-payee-name2'

   move ' ' to $prev_payee_name

   #ifdef debug8
      show 'B.EMPLID ' &B.EMPLID
      show '$prev_emplid ' $prev_emplid
      show '$prev_payee ' $prev_payee
      show 'C.AP_VENDOR_ID ' &C.AP_VENDOR_ID
      show '$GARN_PAYEE_NAME ' $GARN_PAYEE_NAME
   #endif

   let $found_payee_name2='N'
   
begin-select on-error=sql-error-found('get-payee-name2')
/*+ RULE */
I2.GARN_PAYEE_NAME
I2.ADDRESS1
I2.CITY
I2.STATE
I2.POSTAL

   move &I2.GARN_PAYEE_NAME to $prev_payee_name
   let $found_payee_name2='Y'

   Let $ADDRESS1 = &I2.ADDRESS1
   Let $CITY = &I2.CITY
   Let $STATE = &I2.STATE
   Let $ZIP = &I2.POSTAL
  
FROM PS_GARN_SPEC I2		
WHERE I2.AP_VENDOR_ID    = $prev_payee
AND  upper(I2.GARN_PAYEE_NAME) = upper($GARN_PAYEE_NAME)  !vendkxy done changes for ITG 66163
 and  I2.COMPANY         = $prev_company
 and  I2.emplid          = $prev_emplid
end-select

   if $found_payee_name2='N'
      show 'GARN PAYEE NAME not found after 2nd pass'
   end-if

end-procedure
!AXL 9/26/2005 - New Procedure - end

! CWB 04/05/2001 BEGIN

begin-procedure get-payee-name-ohio

move ' ' to $prev_payee_name

begin-select on-error=sql-error-found('get-payee-name-ohio')
/*+ RULE */
IX.GARN_PAYEE_NAME
IX.ADDRESS1
IX.CITY
IX.STATE
IX.POSTAL

   move &IX.GARN_PAYEE_NAME to $prev_payee_name
   Let $ADDRESS1 = &IX.ADDRESS1
   Let $CITY = &IX.CITY
   Let $STATE = &IX.STATE
   Let $ZIP = &IX.POSTAL

FROM PS_GARN_SPEC IX  ! GEX ISDVNPK 11/12/2007 PS_GEX_GARN_PAYEE IX

WHERE IX.AP_VENDOR_ID = $prev_payee
and substr(IX.GARN_PAYEE_NAME,1,4) <> 'CSEA' 
end-select

end-procedure

! CWB 04/05/2001 END

!*********************************************************************
!Retrieves the Garn Type Desc from the database
!*********************************************************************

begin-procedure get-xlat-desc

move ' ' to $FILED_desc

begin-select on-error=sql-error-found('get-xlat-desc')
L.XLATSHORTNAME &field_desc

   move &field_desc to $field_desc
!Manish,08/08/2007,PY227-Giant Eagle commented on 08/08/2007 for HCM 9.0 Upgrade-Begin 
!FROM XLATTABLE L	!Giant Eagle Commented
FROM PSXLATITEM L     ! DXS, 06/18/08,was wrongly coded ad PSXLATITEMLANG
!Manish,08/08/2007,PY227-Giant Eagle modified on 08/08/2007 for HCM 9.0 Upgrade-End
WHERE L.FIELDNAME = $FIELDNAME
  !AND L.LANGUAGE_CD = 'ENG'	!Giant Eagle commented on 08/08/2007 for HCM Upgrade9.0	
  AND L.FIELDVALUE = $FIELDVALUE

end-select

end-procedure

!********************************************************************
!This procedure displays in the error report if there are any sql erros
!happened in the program
!********************************************************************

begin-procedure SQL-Error-Found($Proc_Name) 
  do error-found
  print 'SQL Error in ' (,34)
  print $Proc_Name ()  
  print $_sql-error () 
  print 'sql-status:' ()
  print #_sql-status () edit 99999 
  !VENDKXY Done changes for ITG 66163--Begin   
   !use-report Garn-Payee-Report
  if $report = 'PY051GRN'
  use-report Garn-Payee-Report
  else 
  if $report = 'PY051OIR'
  use-report Garn-Payee-Report1
  else 
  use-report Garn-Payee-Report2
  end-if
  end-if 
  
!VENDKXY Done changes for ITG 66163--End  
end-procedure

!*********************************************************************
!This procedure displays the error message for the records that are in
!progress
!*********************************************************************

begin-procedure Error-Found
  move 'Y' to $ErrorFound
  use-report report-log
  do Format-Number(#InputTran, $out, '99999')
  print $out (+1,1)
  !GEX_SEC_REENG 09/23/2016 Vahini Katta Begins
  !let $EmplId_1st3 = substr($EmplId,1,3)
  !let $EmplId_mid2 = substr($EmplId,4,2)
  !let $EmplId_last4 = substr($EmplId,6,4)
 
  !String $EmplId_1st3 $EmplID_mid2 $EmplId_last4 by '-' into $EmplId11

  !print $EmplID11 (,16)
  print $EmplID (,16)
  !GEX_SEC_REENG 09/23/2016 Vahini Katta Ends
end-procedure

#Include 'tranctrl.sqc'  !Common Transaction Control Procedures
#Include 'reset.sqc'     !Reset printer procedure
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'payrnctl.sqc'  !Select-Parameters
#Include 'stdapi.sqc'    !Get_Run_Control Procedure
#Include 'datemath.sqc'  !Does the date-math functions

#include 'gexxx901.sqc'  !Get company/paygroup multiple row table
#include 'gexxx902.sqc'  !Get deptid multiple row table
#include 'gexxx922.sqc'  !Get pay single row run control
#include 'gexaltse.sqc'  ! Alter session SQC
#Include 'getgeid.sqc'   !GEX_SEC_REENG 