!***********************************************************************
!  CTX910VP:   PRINT  RL-2 Supplementary from Tax Extract Table        *
!***********************************************************************
!***********************************************************************
!                                                                      *
!                                                                      *
!                                                                      *
!                                                                      *
! This software and related documentation are provided under a         *
! license agreement containing restrictions on use and                 *
! disclosure and are protected by intellectual property                *
! laws. Except as expressly permitted in your license agreement        *
! or allowed by law, you may not use, copy, reproduce,                 *
! translate, broadcast, modify, license, transmit, distribute,         *
! exhibit, perform, publish or display any part, in any form or        *
! by any means. Reverse engineering, disassembly, or                   *
! decompilation of this software, unless required by law for           *
! interoperability, is prohibited.                                     *
! The information contained herein is subject to change without        *
! notice and is not warranted to be error-free. If you find any        *
! errors, please report them to us in writing.                         *
!                                                                      *
!                                                                      *
! Copyright (C) 1988, 2013, Oracle and/or its affiliates.              *
! All Rights Reserved.                                                 *
!***********************************************************************
!***********************************************************************
!                                                                      *
!          $Date:  2013/01/07:17:51:35                                 !
!       $Release:  HR9                                                 !
!    $Resolution:  885414                                              !
!                                                                      *
!***********************************************************************

#include 'setenv.sqc' !Set environment
#include 'setup07.sqc'
#Include 'ctxrnctl.sqc'  !Get-Tax-Reporting-Run-Controls procedure
#define TAXFORM_NOTES
#include 'rellang.sqc'

#DEFINE FORMS/PAGE      3
#DEFINE LASTPRINTLINE   17

begin-setup
!#include 'setupdb.sqc'               ! Database specific setup

DECLARE-LAYOUT  DEFAULT
PAPER-SIZE      =(150,150)
FORMFEED        =NO
ORIENTATION     =PORTRAIT
TOP-MARGIN      =0.0
LEFT-MARGIN     =0.25
LINE-HEIGHT     = 6pt
END-DECLARE

#ifdef TAXTEST

#ifndef MVS
#ifndef OS400
  declare-printer DEFAULT-HP
  end-declare
  declare-printer DEFAULT-LP
  init-string   =<27>E<27>(10U<27>&l0O<27>&l6D<27>&l0E<27>&l80F<27>(s10.0H
  end-declare
#else
  declare-printer DEFAULT-HP
  end-declare
  declare-printer DEFAULT-LP
  init-string   =<39>E<39>(10U<39>&l0O<39>&l6D<39>&l0E<39>&l80F<39>(s10.0H
  end-declare
#endif
#else
  declare-printer DEFAULT-HP
  end-declare
  declare-printer DEFAULT-LP
  init-string   =<39>E<39>(10U<39>&l0O<39>&l6D<39>&l0E<39>&l80F<39>(s10.0H
  end-declare
#endif

#endif


#ifndef MVS
#ifndef OS400
  declare-printer DEFAULT-HP
  end-declare
 !              |     !--> Perforation Skip
 !              --> Reset
  declare-printer DEFAULT-LP
  init-string   =<27>E<27>&l0L
  end-declare
#else
  declare-printer DEFAULT-HP
  end-declare
  declare-printer DEFAULT-LP
  init-string   =<39>E<39>&l0L
  end-declare
#endif
#else
  declare-printer DEFAULT-HP
  end-declare
  declare-printer DEFAULT-LP
  init-string   =<39>E<39>&l0L
  end-declare
#endif

  declare-procedure
    before-report = Init-Page-Size
  end-declare



end-setup

!***********************************************************************
begin-procedure Init-Page-Size
!***********************************************************************
! This sends a 'Perforation Skip' command to disable any bottom
! margin and obtain the maximum PCL page.  This is required in
! the printing of the Releve 2 laser form.

#ifndef MVS
#ifndef OS400
 encode '<27>&l0L<27>&l2E' into $perforation_skip
#else
 encode '<39>&l0L<39>&l2E' into $perforation_skip
#endif
#else
 encode '<39>&l0L<39>&l2E' into $perforation_skip
#endif

 print $perforation_skip () code

end-procedure

begin-report

  do Init-Report
  do Process-Main

  if $SelectEEs = 'R' or $SelectEEs = 'A' or $SelectEEs = 'C'
    close 1
  end-if

#ifdef PRCSSCHD
  do StdAPI-Term
#endif

end-report


begin-procedure Init-Report

  display 'PRINT RL-2'
  display '  '
  do Init-DateTime
  do Init-Number
#ifdef PRCSSCHD
  do StdAPI-Init
#endif

 do Initialization


 use-printer-type HPLASERJET
 do Declare-Printer-RV2
 do Set-RV2-Row-Pointers
!**
!     do Laser-Print-Alignment


end-procedure

begin-procedure Initialization

  move 'Y' to $FirstRecord
  do Get-Current-DateTime

  do Array-Create

  move '1' to $Year4
  move '-' to $DDelimiter
  move '1' to $MMLZero
  display $AsOfToday
  do Format-DateTime($AsOfToday, $AsOfDateYMD, {DEFYMD},'','')
  move $AsOfDateYMD to $AsOfYear xxxx
  display $AsOfYear

  move $AsOfYear  to #AsOfYear
  subtract 1 from #AsOfYear

   do Get-Can-Tax-Processing-Params  !TX.Balance_Year


  move &TX.Balance_Year to #TaxYear
  move &TX.Balance_Year to $TaxYear
  let #CalendarYear = &TX.Balance_Year

  move &TX.Balance_Year to $CalYear 9999
  let $AsOfDate = $CalYear || '1231'
  do Format-DateTime($AsOfDate, $AsOfDate, {DEFCMP}, '', 'native')

  do Array-Setup-FootNotes

  if &TX.Balance_Year <> #AsOfYear and $Prcs_Process_Instance = ''
    display ''
    display 'Current Year is ' noline
    display $AsOfYear
    display 'Tax Reporting Year is ' noline
    display $TaxYear
    display 'Current Year is not one greater than Tax Reporting Year.'
    input $Answer maxlen=1 'Current Year is not one greater than Tax Reporting Year. Do you want to continue? (Y/N)'
    uppercase $Answer

    if $Answer <> 'Y'
      stop
    end-if
  end-if

  if $Prcs_Process_Instance = ''
     do Prompts
  else
#ifdef PRCSSCHD
      do Select-Canadian-YrEnd-Parameters
      do Convert-Parameters
#endif
  end-if

  if $SelectEEs = 'R' or $SelectEEs = 'A' or $SelectEEs = 'C'
#ifdef MPE
  let $feq='FILE CTX910V1.DAT; REC=-250,,F,ASCII'
  call system using $feq #status
  open 'CTX910V1.DAT' as 1 for-writing record=250:fixed
#else
  open '{IMPORTPREFIX}CTX910V1{IMPORTSUFFIX}' as 1 for-writing record=250:vary
#endif
  end-if

  do Initialize-OtherInfo-Array

end-procedure


begin-procedure Prompts

  display ' '
  display ' '
  display ' '
  display 'Select the type of form to use for your RL-2 printing '
  display ' '

  while $FormType = ''
    input $FormType 'Enter L(Laser Form), or S(Standard Tractor Feed), or enter Q to quit'
    uppercase $FormType
    if INSTR('LSQ',$FormType, 1) = 0
      display ' '
      display '***** Enter L, S, or Q to quit *****'
      display ' '
      move '' to $FormType
    end-if
  end-while

  if $FormType = 'Q'
     stop
  end-if

  display ' '
  display ' '
  display ' '
  display 'If this job will print forms to send to the Quebec '
  display 'government, enter 1 and the system will establish the '
  display 'correct sort sequence.'
  display ' '
  display 'If this job will print forms for another use (such as '
  display 'self-mailers, laser forms, employer copy, etc., you '
  display 'may select the sort sequence you prefer.  Enter 2 to '
  display 'see the sort options.  You will be shown three levels '
  display 'of sorting options, one level at a time.'
  display ' '

  while $SortInd = ''
    input $SortInd 'Enter 1(Std Govt Sort Sequence) or 2(Other Sort Options), or enter Q to quit'
    uppercase $SortInd
    if INSTR('12Q',$SortInd, 1) = 0
      display ' '
      display '***** Enter 1, 2, or Q to quit *****'
      display ' '
      move '' to $SortInd
    end-if
  end-while

  if $SortInd = 'Q'
     stop
  end-if

 if $SortInd = '1'
     let $SortSequence = 'SL.REPORTING_ID ASC, ' ||
       'EE.SLIP_SURNAME ASC, EE.SLIP_FIRST_NAME ASC, EE.EMPLID ASC'

 else
  display ' '
  display ' '
  display ' '
  display 'Select the Primary Sort Sequence for your Releve 2 slips.'
  display 'To sequence by Quebec Identification number, enter 1.'
  display 'To sequence by company, enter 2.'
  display ' '

  while $SortInd1 = ''
    input $SortInd1 '1st Sort Field : Enter 1(by QID), or 2(by Company), or enter Q to quit'
    uppercase $SortInd1
    if INSTR('12Q',$SortInd1, 1) = 0
      display ' '
      display '***** Enter 1, 2, or Q to quit *****'
      display ' '
      move '' to $SortInd1
    end-if
  end-while

  if $SortInd1 = 'Q'
     stop
  end-if

  if $SortInd1 = '1'
     let $Sort1 = 'SL.REPORTING_ID ASC'
     let $DispSort1 = 'Quebec ID Number; '
  end-if

  if $SortInd1 = '2'
     let $Sort1 = 'SL.COMPANY ASC'
     let $DispSort1 = 'Company; '
  end-if


  display ' '
  display ' '
  display ' '
  display 'Within the previous sort, select the second sort sequence.'
  display '    To sort by Location Code                 - enter 1'
  display '    To sort by Department Code               - enter 2'
  display '    To sort by Mail Drop                     - enter 3'
  display '    To sort by Postal Code                   - enter 4'
  display '    To sort by none of the above             - enter 5'
  display '    To quit                                  - enter Q'
  display ' '

  while $SortInd2 = ''
    input $SortInd2 '2nd Sort Field : 1(by LocCode), 2(by DeptCode), 3(by MailDrop), 4(by PostCode), 5(None), or Q to quit'
    uppercase $SortInd2
    if INSTR('12345Q',$SortInd2, 1) = 0
      display ' '
      display '***** Enter 1, 2, 3, 4, 5, or Q to quit *****'
      display ' '
      move '' to $SortInd2
    end-if
  end-while

  if $SortInd2 = 'Q'
     stop
  end-if

  if $SortInd2 = '1'
     let $Sort2 = 'EE.LOCATION  ASC'
     let $DispSort2 = 'Location; '
  end-if

  if $SortInd2 = '2'
     let $Sort2 = 'EE.DEPTID  ASC'
     let $DispSort2 = 'Department; '
  end-if

  if $SortInd2 = '3'
     let $Sort2 = 'EE.MAIL_DROP  ASC'
     let $DispSort2 = 'Mail Drop; '
  end-if

  if $SortInd2 = '4'
     let $Sort2 = 'EE.POSTAL ASC'
     let $DispSort2 = 'Postal Code; '
  end-if

  if $SortInd2 = '5'
     let $Sort2 = 'N'
  end-if

  display ' '
  display ' '
  display ' '
  display 'Within the previous sorts, select the third sort sequence.'
  display '   To sort by Employee Name            - enter 1'
  display '   To sort by Employee ID              - enter 2'
  display '   To sort by Employee SIN             - enter 3'
  display '   To quit                             - enter Q'
  display ' '

  while $SortInd3 = ''
    input $SortInd3 '3rd Sort Field : 1(by Empl Name), 2(by Empl ID), 3(by Empl SIN), or enter Q to quit'
    uppercase $SortInd3
    if INSTR('123Q',$SortInd3, 1) = 0
      display ' '
      display '***** Enter 1, 2, 3, or Q to quit *****'
      display ' '
      move '' to $SortInd3
    end-if
  end-while

  if $SortInd3 = 'Q'
     stop
  end-if

  if $SortInd3 = '1'
     let $Sort3 = 'EE.SLIP_SURNAME ASC, EE.SLIP_FIRST_NAME ASC, EE.EMPLID ASC'
     let $DispSort3 = 'Employee Name; Employee ID'
  end-if

  if $SortInd3 = '2'
     let $Sort3 = 'EE.EMPLID ASC'
     let $DispSort3 = 'Employee ID'
  end-if

  if $SortInd3 = '3'
     let $Sort3 = 'EE.SIN ASC'
     let $DispSort3 = 'Employee SIN'
  end-if

  if $Sort2 = 'N'
     let $SortSequence =  $Sort1 || ', ' ||  $Sort3
     let $DisplaySeq = $DispSort1 || $DispSort3
  else
     let $SortSequence = $Sort1 || ', ' || $Sort2 || ', ' || $Sort3
     let $DisplaySeq = $DispSort1 || $DispSort2 || $DispSort3
  end-if
 end-if

   if $SortInd = '2' and $SortInd1 = '1'
      move 'R' to $SortCode
   else
      if $SortInd = '2' and $SortInd1 = '2'
         move 'C' to $SortCode
      else
         move ' ' to $SortCode
      end-if
   end-if

   if $SortInd <> '1'
      display '  '
      display '  '
      display 'Your sort sequence is ' noline
      display $DisplaySeq
      display '  '
      display '  '
     display 'Is this sequence correct?'
     display 'If the sequence is correct, enter Y'

      while $Response = ''
        input $Response 'Enter Y to continue or enter Q to quit'
        uppercase $Response
        if INSTR('YQ',$Response, 1) = 0
          display ' '
          display '***** Enter Y or Q to quit *****'
          display ' '
          move '' to $Response
        end-if
      end-while

     if $Response = 'Q'
        stop
     end-if
   else
     display 'Standard Government sort selected.'
   end-if

  while $SelectEEs = ''
    display ''
    display 'Regular processing or Select employees?'
    input $SelectEEs 'Enter R or S'
    uppercase $SelectEEs
    if INSTR('RS',$SelectEEs,1) = 0
      display 'Enter R or S'
      move '' to $SelectEEs
    end-if
  end-while

  if $SelectEEs = 'S'
    display 'Enter EmplID or hit ENTER to stop selecting'
    move 'AND EE.EMPLID in (''' to $E.SelectedEEs
    move ' ' to $SelectedEmplID
    while $SelectedEmplID <> ''
      input $SelectedEmplID ' '
      if $SelectedEmplID <> ''
        uppercase $SelectedEmplID
        let $E.SelectedEEs = $E.SelectedEEs || $SelectedEmplID || ''','''
        move 'Y' to $EE_Selected
      end-if
    end-while

    if $EE_Selected <> 'Y'
      display ''
      display 'No employees selected. Program stopped.'
      display ''
      stop
    end-if

    let $E.SelectedEEs = SUBSTR($E.SelectedEEs,1,LENGTH($E.SelectedEEs) - 2)
    let $E.SelectedEEs = $E.SelectedEEs || ')'
  else
    move '' to $E.SelectedEEs
  end-if

end-procedure

begin-procedure Array-Create

  create-array name=FootNotes size=100 -
    field=FN_Box_Num:char              -
    field=FN_Box_Priority:number       -
    field=FN_Text:char

  create-array name=FormNotes size=100 -
    field=Box_Num:char                 -
    field=Box_Priority:number          -
    field=Text:char                    -
    field=Box_Value:char               -
    field=Box_Amount:number

   create-array name=OtherInfo size=40   -
      field=OtherInfo_Box_Num:char       -
      field=OtherInfo_Box_Amt:number

end-procedure


begin-procedure Initialize-OtherInfo-Array

   move 0 to #load
   move 0 to #loadamt
   move ' ' to $loadspace

   move 40 to #MaxOtherInfo

   while #load < #MaxOtherInfo

      put $loadspace #loadamt into OtherInfo(#load)
          OtherInfo_Box_Num OtherInfo_Box_Amt

      add 1 to #load

   end-while

end-procedure


begin-procedure Array-Setup-FootNotes

  let #i = 0

begin-SELECT
FN.BOX
FN.BOX_NOTE_SEQ
FN.BOX_NOTE_TEXT
FN.EFFDT

  let $TAXFORM_NOTES-BOX_NOTE_TEXT = &FN.BOX_NOTE_TEXT
  do Get_Related_TAXFORM_NOTES(&FN.BOX,&FN.EFFDT,'V')

  PUT  &FN.Box &FN.Box_Note_Seq $TAXFORM_NOTES-BOX_NOTE_TEXT
          INTO FOOTNOTES(#I) FN_BOX_NUM FN_BOX_PRIORITY FN_TEXT

  move #i to #max_i
  add 1 to #i


FROM  PS_TAXFORM_NOTES  FN
WHERE FN.TAXFORM_ID  =  'V'
  AND FN.EFFDT = (SELECT
      MAX(EFFDT)
      FROM PS_TAXFORM_NOTES
      WHERE EFFDT <= $AsOfDate
        AND TAXFORM_ID = 'V')
end-SELECT
end-procedure


begin-procedure  Process-Main

begin-SELECT
SL.REPORTING_ID
SL.RELEVE2_SLIP_NO
SL.COMPANY
SL.WAGE_LOSS_PLAN
SL.EMPLID
SL.CALENDAR_YEAR
SL.PROVINCE
SL.SEQUENCE_NUMBER
SL.YE_SLIP_PROCESS
SL.PROVENANCE
SL.SIN_CONTRB_SPOUSE
SL.CAN_YE_SLIP_SEQ
EE.SIN
EE.EMPLID
EE.SLIP_SURNAME
EE.SLIP_FIRST_NAME
EE.SLIP_INITIAL
EE.ADDRESS1
EE.ADDRESS2
EE.CITY
EE.PROVINCE
EE.COUNTRY
EE.POSTAL
EE.LOCATION
EE.DEPTID
EE.MAIL_DROP

 if $Proc_Amend_Cancel = 'Y'
  do Check-Status
 end-if

 if $StatusOpen = 'Y'

  if $FirstRecord = 'N'
    if $SortInd = '1'

      if &EE.EmplID <> $EmplID or
         &SL.CAN_YE_SLIP_SEQ <> #YE_Slip_Seq or
         &SL.Reporting_ID <> $ReportID
         do Print-RV2-Data
         do Finish-Printing

         if &SL.Reporting_ID <> $ReportID
            if $SelectEEs = 'R' or $SelectEEs = 'A' or $SelectEEs = 'C'
              do Write-Summary-Record
            end-if
         end-if
         do Initialize-Employee-Data
         move 0 to #j
      end-if
    else
      if $SortInd1 = '1'
         if &SL.Reporting_ID <> $ReportID or
            &EE.EmplID <> $EmplID or
            &SL.CAN_YE_SLIP_SEQ <> #YE_Slip_Seq
            do Print-RV2-Data
            do Finish-Printing
            if &SL.Reporting_ID <> $ReportID
               if $SelectEEs = 'R' or $SelectEEs = 'A' or $SelectEEs = 'C'
                 do Write-Summary-Record
               end-if
            end-if
            do Initialize-Employee-Data
            move 0 to #j
         end-if
      else
         if &SL.Company <> $Company or
            &SL.Reporting_ID <> $ReportID or
            &EE.EmplID <> $EmplID or
            &SL.CAN_YE_SLIP_SEQ <> #YE_Slip_Seq
            do Print-RV2-Data
            do Finish-Printing
            if &SL.Company <> $Company
               if $SelectEEs = 'R' or $SelectEEs = 'A' or $SelectEEs = 'C'
                 do Write-Summary-Record
               end-if
            end-if
            do Initialize-Employee-Data
            move 0 to #j
         end-if
      end-if
    end-if
  else
    move 'N' to $FirstRecord
  end-if

  do Check-Releve-Start-No
  do Format-Employee-Data
  do Get-Slip-Detail

  if $SelectEEs = 'A' or
     $SelectEEs = 'E'

     do Get-Original-Slip-No
  end-if

  if &SL.Company <> $PriorCompany
      move &SL.Company to $Company
      do Get-Company-Data
      move $Company to $PriorCompany
      move 'Y'      to $Compbrk
  end-if

  if $Proc_Amend_Cancel = 'Y' and $RC_CAN_YE.RL2_Final_Print = 'Y'
    do Close-Amend-Cancel-RL-2
  end-if

 end-if

FROM   PS_CAN_YE_SLIP  SL,
       PS_CAN_YE_EMPL  EE
WHERE  SL.CALENDAR_YEAR = &TX.Balance_Year
  AND  SL.TAXFORM_ID = 'V'
  AND  SL.PROCESS_FLAG <> 'V'
  AND  EE.CALENDAR_YEAR = &TX.Balance_Year
  AND  EE.EMPLID = SL.EMPLID
#ifdef MVS
  \$E.SelectedEEs\
#else
  [$E.SelectedEEs]             !NULL string if SELECT EEs option not used
#endif
  AND  EE.COMPANY = SL.COMPANY
  AND  EE.SEQUENCE_NUMBER = SL.SEQUENCE_NUMBER
  AND  SL.SEQUENCE_NUMBER = (SELECT MAX(SL1.SEQUENCE_NUMBER)
               FROM PS_CAN_YE_SLIP SL1
               WHERE SL1.COMPANY = SL.COMPANY
                 AND SL1.EMPLID  = SL.EMPLID
                 AND SL1.CALENDAR_YEAR = SL.CALENDAR_YEAR
#ifdef MVS
  \$seq_number\
#else
  [$seq_number]
#endif
#ifdef MVS
  \$ye_slip_process\
#else
  [$ye_slip_process]
#endif
#ifdef MVS
  ORDER by \$SORTSEQUENCE\
#else
  ORDER by [$SortSequence]
#endif
end-SELECT

   if $EmplID <> ''
     do Print-RV2-Data
     do Finish-Printing

     if $SelectEEs = 'R' or $SelectEEs = 'A' or $SelectEEs = 'C'
       do Write-Summary-Record
     end-if
   end-if

end-procedure

begin-procedure Check-Releve-Start-No

begin-SELECT
RV.RELEVE2_SERIAL_BEG
RV.RELEVE2_SERIAL_END

  if &RV.Releve2_Serial_Beg > 0  and
     &RV.Releve2_Serial_End = 0
        display 'If you plan to file by magnetic media, you must run '
        display 'job CTX910VM.SQR first to calculate the Releve Serial '
        display 'numbers to be printed on the paper forms.  If you do  '
        display 'not plan to file by magnetic media, set the Beginning '
        display 'Serial Number to 0 on the PQ_REPTNG_TBL. Then run this job.'
      STOP
  end-if


FROM PS_PQ_REPTNG_TBL  RV
WHERE RV.COMPANY = &SL.COMPANY
  AND EFFDT =
  (SELECT MAX(EFFDT)
     FROM PS_PQ_REPTNG_TBL
     WHERE  COMPANY = RV.COMPANY
       AND  EFFDT  <= $AsOfDate)
end-SELECT

end-procedure


begin-procedure Get-SLIP-Detail

   let #OtherInfoBoxCount = 0
   let #OtherInfo_i       = 0

begin-SELECT
DE.BOX
DE.CAN_YE_BOX_TEXT
DE.CAN_YE_BOX_AMT

  EXTRACT $FN_Ind from &DE.Box 4 1
  if $FN_Ind = '' or $FN_Ind = ' '
    do Accumulate-Employee-Data
  else
    do Insert-EmplNote-Data
  end-if

FROM  PS_CAN_YE_DETAIL DE
WHERE EMPLID            = &EE.EmplID
  AND TAXFORM_ID        = 'V'
  AND WAGE_LOSS_PLAN    = &SL.Wage_Loss_Plan
  AND CALENDAR_YEAR     = &TX.Balance_Year
  AND COMPANY           = &SL.Company
  AND SEQUENCE_NUMBER   = &SL.Sequence_Number
  AND CAN_YE_SLIP_SEQ   = &SL.Can_YE_Slip_Seq
end-SELECT

end-procedure


begin-procedure Insert-EmplNote-Data

  move 0 to #k
  move 50 to #max_k

  while #k <= #max_k
     get $FindBox from FormNotes(#k) Box_Num
     if $FindBox = &DE.Box
        array-add #DE.Can_YE_Box_Amt to FormNotes(#k) Box_Amount
        break
     else
       if $FindBox = ' ' or $FindBox = ''
          put  &DE.Box &DE.Can_YE_Box_Text &DE.Can_YE_Box_Amt
             into FormNotes(#k) Box_Num Box_Value Box_Amount
           let #max_j = #k + 1

          move 0 to #i
          while #i <= #max_i
            do Get-FootNotes
            if $FN_Box = &DE.Box
               put #FN_Priority $FN_Text
                 into FormNotes(#k) Box_Priority Text
               break
            else
              if $FN_Box = '' or $FN_Box = ' '
                 break
              else
                 add 1 to #i
              end-if
            end-if
          end-while
       else
          add 1 to #k
       end-if
    end-if
  end-while

end-procedure

begin-procedure Get-FootNotes

  get  $FN_Box
       #FN_Priority
       $FN_Text
  from FootNotes(#i)
        FN_Box_Num
        FN_Box_Priority
        FN_Text

end-procedure


begin-procedure Accumulate-Employee-Data


    let $Box = RTRIM(&DE.Box, ' ')
    let #BoxAmt = &DE.Can_YE_Box_Amt
    let $BoxText = &DE.Can_YE_Box_Text

    evaluate $Box

       when = 'A'
         if #BoxAmt > 0
            add #BoxAmt to #TotLAPayment
            add #BoxAmt to #LAPayment
         end-if

       when = 'B'
         if #BoxAmt > 0
            add #BoxAmt to #TotMBenefits
            add #BoxAmt to #MBenefits
         end-if

       when = 'C'
         if #BoxAmt > 0
            add #BoxAmt to #TotOPayments
            add #BoxAmt to #OPayments
         end-if

       when = 'D'
         if #BoxAmt > 0
            add #BoxAmt to #TotRefRRSP
            add #BoxAmt to #RefRRSP
         end-if

       when = 'E'
         if #BoxAmt > 0
            add #BoxAmt to #TotAmtPriorD
            add #BoxAmt to #AmtPriorD
         end-if

       when = 'F'
         if #BoxAmt > 0
            add #BoxAmt to #TotRExcessRRSP
            add #BoxAmt to #RExcessRRSP
         end-if

       when = 'G'
         if #BoxAmt > 0
           add #BoxAmt to #TotRecRevRRP
           add #BoxAmt to #RecRevRRP
         end-if

       when = 'H'
         if #BoxAmt > 0
            add #BoxAmt to #TotOtherIncome
            add #BoxAmt to #OtherIncome
         end-if

       when = 'I'
         if #BoxAmt > 0
            add #BoxAmt to #TotEntlDed
            add #BoxAmt to #EntlDed
         end-if

       when = 'J'
         if #BoxAmt > 0
            add #BoxAmt to #TotQITWithheld
            add #BoxAmt to #QITWithheld
         end-if

       when = 'K'
         if #BoxAmt > 0
            add #BoxAmt to #TotIncDeath
            add #BoxAmt to #IncDeath
         end-if

       when = 'L'
         if #BoxAmt > 0
            add #BoxAmt to #TotWthdrwlLLP
            add #BoxAmt to #WthdrwlLLP
         end-if

       when = 'M'
         if #BoxAmt > 0
            add #BoxAmt to #TotTaxPaid
            add #BoxAmt to #TaxPaid
         end-if

      when = 'O'
         if #BoxAmt > 0
            add #BoxAmt to #TotWthdrwlHBP
            add #BoxAmt to #WthdrwlHBP
         end-if

      when = 'B-1'
      when = 'B-2'
      when = 'B-3'
      when = 'B-4'
      when = 'C-1'
      when = 'C-2'
      when = 'C-3'
      when = 'C-4A'
      when = 'C-4B'
      when = 'C-4C'
      when = 'C-4D'
      when = 'C-4E'
      when = 'C-4F'
      when = 'C-9'
      when = '210'
      when = '235'
         do Save-RL2_Other_Info
         move #OtherInfo_i to #OtherInfoBoxCount

      end-evaluate

end-procedure


begin-procedure Save-RL2_Other_Info

   put $Box #BoxAmt into OtherInfo(#OtherInfo_i)
       OtherInfo_Box_Num OtherInfo_Box_Amt

   add 1 to #OtherInfo_i

end-procedure


begin-procedure Get-Original-Slip-No

begin-SELECT

OS.RELEVE_SLIP_NO

  move &OS.Releve_Slip_No to $OriginalSlipNo

FROM PS_CAN_YE_SLIP OS
WHERE OS.COMPANY         = &SL.COMPANY
  AND OS.EMPLID          = &EE.EMPLID
  AND OS.CALENDAR_YEAR   = &TX.BALANCE_YEAR
  AND OS.TAXFORM_ID      = 'R'
  AND OS.YE_SLIP_PROCESS <> 'D'
  AND OS.CAN_YE_SLIP_SEQ = &SL.CAN_YE_SLIP_SEQ
  AND OS.SEQUENCE_NUMBER =
      (SELECT MAX(OS1.SEQUENCE_NUMBER)
         FROM PS_CAN_YE_SLIP OS1
         WHERE OS1.COMPANY = OS.COMPANY
           AND OS1.EMPLID  = OS.EMPLID
           AND OS1.CALENDAR_YEAR = OS.CALENDAR_YEAR
           AND OS1.TAXFORM_ID    = OS.TAXFORM_ID
           AND OS1.YE_SLIP_PROCESS <> 'D'
           AND OS1.CAN_YE_SLIP_SEQ = OS.CAN_YE_SLIP_SEQ
           AND OS1.SEQUENCE_NUMBER < &SL.SEQUENCE_NUMBER)

end-SELECT
end-procedure


begin-procedure Print-RV2-Data

  add 1 to #RV2Count

  do Format-Number(#Releve2_Slip_No,$Releve2_Slip_No,'099999999')
  let $RV2SlipNo = edit($Releve2_Slip_No, 'xxxbxxxbxxx')

  print $RV2SlipNo (#Slip1_Row3,66)
  print $RV2SlipNo (#Slip2_Row3,66)

  if $SelectEEs = 'S' or $SelectEEs = 'E'
     let #Dup1_Row =  #Slip1_Row2
     let #Dup2_Row =  #Slip2_Row2
     print 'DOUBLE' (#Dup1_Row,20)
     print 'DOUBLE' (#Dup2_Row,20)
  end-if

  print $TaxYear (#Slip1_Row5,30)
  print $TaxYear (#Slip2_Row5,30)


         if #LAPayment > 0
            do Format-Number (#LAPayment, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row11,1)              ! Box 'A' - print all depends on layout
         print $BoxAmt (#Slip2_Row11,1)


         if #MBenefits > 0
            do Format-Number (#MBenefits, $BoxAmt, '99999999.00')
         else
            move ' ' to $BoxAmt
         end-if


         print $BoxAmt (#Slip1_Row11,14)             ! Box 'B'
         print $BoxAmt (#Slip2_Row11,14)


         if #OPayments > 0
            do Format-Number (#OPayments, $BoxAmt, '99999999.00')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row11,27)             ! Box 'C'
         print $BoxAmt (#Slip2_Row11,27)


         if #RefRRSP > 0
            do Format-Number (#RefRRSP, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row11,40)             ! Box 'D'
         print $BoxAmt (#Slip2_Row11,40)


         if #AmtPriorD > 0
            do Format-Number (#AmtPriorD, $BoxAmt, '99999999.00')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row11,53)             ! Box 'E'
         print $BoxAmt (#Slip2_Row11,53)


         if #RExcessRRSP > 0
            do Format-Number (#RExcessRRSP, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row11,67)             ! Box 'F'
         print $BoxAmt (#Slip2_Row11,67)


         if #RecRevRRP > 0
            do Format-Number (#RecRevRRP, $BoxAmt, '99999999.00')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row17,1)              ! Box 'G'
         print $BoxAmt (#Slip2_Row17,1)


         if #OtherIncome > 0
            do Format-Number (#OtherIncome, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row17,14)             ! Box 'H'
         print $BoxAmt (#Slip2_Row17,14)


         if #EntlDed > 0
            do Format-Number (#EntlDed, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row17,27)             ! Box 'I'
         print $BoxAmt (#Slip2_Row17,27)


         if #QITWithheld > 0
            do Format-Number (#QITWithheld, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row17,40)             ! Box 'J'
         print $BoxAmt (#Slip2_Row17,40)


         if #IncDeath > 0
            do Format-Number (#IncDeath, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row17,53)            ! Box 'K'
         print $BoxAmt (#Slip2_Row17,53)


         if #WthdrwlLLP > 0
            do Format-Number (#WthdrwlLLP, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row17,67)           ! Box 'L'
         print $BoxAmt (#Slip2_Row17,67)


         if #TaxPaid > 0
            do Format-Number (#TaxPaid, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row21,1)            ! Box 'M'
         print $BoxAmt (#Slip2_Row21,1)


         if #WthdrwlHBP > 0
            do Format-Number (#WthdrwlHBP, $BoxAmt, '99999999.99')
         else
            move ' ' to $BoxAmt
         end-if

         print $BoxAmt (#Slip1_Row21,14)         ! Box 'O'
         print $BoxAmt (#Slip2_Row21,14)



!*******************************************************************************
!* Provenance field change
!* for a fixed value in the provenance field fill in the $BoxAmt value and                                                      !* uncomment the next two lines .....
!  move ' ' to $BoxAmt
!  print $BoxAmt (3,45)                                 ! Provenance field
!*******************************************************************************


   print $Provenance (#Slip1_Row5,45)                  ! Provenance field
   print $Provenance (#Slip2_Row5,45)

   print $SIN_Contrb_Spouse (#Slip1_Row37,63)          ! Box 'N'
   print $SIN_Contrb_Spouse (#Slip2_Row37,63)

   print $Code_du_Releve (#Slip1_Row5,38)              ! Code du Releve field
   print $Code_du_Releve (#Slip2_Row5,38)

   do Print-Other-Info

end-procedure


begin-procedure Print-Other-Info

   let #BoxCol = 0
   let #j = 0

   while #j < #OtherInfoBoxCount
      get $OtherInfo_Box_Num #OtherInfo_Box_Amt from OtherInfo(#j)
        OtherInfo_Box_Num OtherInfo_Box_Amt

        evaluate #j
          when = 0
            print $OtherInfo_Box_Num (#Slip1_Row21, 44)
            print #OtherInfo_Box_Amt (#Slip1_Row21, 54)
            print $OtherInfo_Box_Num (#Slip2_Row21, 44)
            print #OtherInfo_Box_Amt (#Slip2_Row21, 54)
          when = 1
            print $OtherInfo_Box_Num (#Slip1_Row21, 61)
            print #OtherInfo_Box_Amt (#Slip1_Row21, 72)
            print $OtherInfo_Box_Num (#Slip2_Row21, 61)
            print #OtherInfo_Box_Amt (#Slip2_Row21, 72)
          when = 2
            print $OtherInfo_Box_Num (#Slip1_Row25, 44)
            print #OtherInfo_Box_Amt (#Slip1_Row25, 54)
            print $OtherInfo_Box_Num (#Slip2_Row25, 44)
            print #OtherInfo_Box_Amt (#Slip2_Row25, 54)
          when = 3
            print $OtherInfo_Box_Num (#Slip1_Row25, 61)
            print #OtherInfo_Box_Amt (#Slip1_Row25, 72)
            print $OtherInfo_Box_Num (#Slip2_Row25, 61)
            print #OtherInfo_Box_Amt (#Slip2_Row25, 72)
        end-evaluate

      add 1 to #j
   end-while

end-procedure


begin-procedure Format-Employee-Data

  let $SIN = edit(&EE.SIN, 'xxxbxxxbxxx')

  let $LastName = &EE.SLIP_Surname
  let $LastName = RTRIM($LastName, ' ')
  let $FirstName = &EE.SLIP_First_Name
  let $FirstName = RTRIM($FirstName, ' ')
  let $MidInitial = &EE.SLIP_Initial

  let $Name = $LastName || ', ' || $FirstName || ' ' || $MidInitial
  do convert-to-char($Name, $Name)
  let $Street1 =  &EE.Address1
  do convert-to-char($Street1, $Street1)
  let $Street2 =  &EE.Address2
  let $Street2 = RTRIM(&EE.Address2, ' ')
  do convert-to-char($Street2, $Street2)

  let $EeAddr = RTRIM(&EE.City, ' ')
  do convert-to-char($EeAddr, $EeAddr)
  let $ProvCd = rtrim(&EE.Province, ' ')
  if $ProvCd = 'ZZ'
     move ' ' to $ProvCd
  end-if
  concat $ProvCd with $EeAddr ,bxx
  if &EE.Country <> 'CAN'
     move &EE.Country to $Country
     concat $Country with $EeAddr bxxxxxxxxxx
  end-if
  let $TempAddr = RTRIM($EeAddr, ' ')

  unstring &EE.POSTAL by ' ' into $ZIP1 $ZIP2
  let $ZIP1 = $ZIP1  || $ZIP2

  if &EE.Country = 'CAN'
     let $ZipValue = edit($ZIP1, 'xxxbxxx')
     let $PrintAddr = $TempAddr || '  ' || $ZipValue
     let $PrintZip = ' '
  else
     let $PrintAddr = $TempAddr
     let $PrintZip = rtrim(&EE.POSTAL, ' ')
  end-if

  let $ReportID =  &SL.Reporting_ID
  let $Provenance = edit(&SL.Provenance, 'xxxxxx')

  let $SIN_Contrb_Spouse  = edit(&SL.SIN_Contrb_Spouse,'xxxbxxxbxxx')

  let $Releve2_Slip_No = &SL.Releve2_Slip_No
  let #Releve2_Slip_No = &SL.Releve2_Slip_No
  do Format-Number(#Releve2_Slip_No,$Releve2_Slip_No,'099999999')
  let $EmplID =  &EE.EmplID
  let $Slip_Process = &SL.YE_Slip_Process
  let #YE_Slip_Seq = &SL.CAN_YE_SLIP_SEQ

  evaluate $SelectEEs
     when = 'R'
     when = 'S'
        let $Code_du_Releve  = 'R'
        break
     when = 'A'
     when = 'E'
        if $Slip_Process = 'A'
           let $Code_du_Releve  = 'A'
        end-if
        break
     when-other
        let $Code_du_Releve  = 'D'
        break
  end-evaluate

end-procedure

begin-procedure Finish-Printing


  let $OriginalSlipNo = edit($OriginalSlipNo, 'xxxbxxxbxxx')


  if ($SelectEEs = 'A' or $SelectEEs = 'E') and $Slip_Process = 'A'
    print 'MODIFIÉ' (#Slip1_Row4,20)
    print 'MODIFIÉ' (#Slip2_Row4,20)
    print $OriginalSlipNo (#Slip1_Row5,53)
    print $OriginalSlipNo (#Slip2_Row5,53)
  end-if

  if ($SelectEEs = 'C' or $SelectEEs = 'E') and $Slip_Process = 'C'
    print 'ANNULÉ' (#Slip1_Row4,20)
    print 'ANNULÉ' (#Slip2_Row4,20)
  end-if


  print $SIN (#Slip1_Row37,43)
  print $SIN (#Slip2_Row37,43)


! print $ReportID (15,62)


  print $Name    (#Slip1_Row42,3)
  print $Street1 (#Slip1_Row44,3)
  print $Name    (#Slip2_Row42,3)
  print $Street1 (#Slip2_Row44,3)


  if $Street2 <> ''

    print $Street2   (#Slip1_Row46,3)
    print $PrintAddr (#Slip1_Row48,3)
    print $PrintZip  (#Slip1_Row50,3)

    print $Street2   (#Slip2_Row46,3)
    print $PrintAddr (#Slip2_Row48,3)
    print $PrintZip  (#Slip2_Row50,3)

  else

    print $PrintAddr (#Slip1_Row46,3)
    print $PrintZip  (#Slip1_Row48,3)

    print $PrintAddr (#Slip2_Row46,3)
    print $PrintZip  (#Slip2_Row48,3)

  end-if

  do Format-Company-Data

  print $CompanyName   (#Slip1_Row42,43)
  print $CompStreet1   (#Slip1_Row44,43)
  print $PrintCompAddr (#Slip1_Row46,43)

  print $CompanyName   (#Slip2_Row42,43)
  print $CompStreet1   (#Slip2_Row44,43)
  print $PrintCompAddr (#Slip2_Row46,43)


  if #max_j > 0
     do Print-Footnotes
  end-if

  do Insert-FormFeed

  new-page

end-procedure

begin-procedure Format-Company-Data
  do convert-to-char($CompanyName, $CompanyName)
  let $CompStreet1 = $CompnyAdd1
  do convert-to-char($CompStreet1, $CompStreet1)

  let $ErAddr = RTRIM($CompnyCity, ' ')
  let $ProvCd = rtrim(&CT.State, ' ')
  concat $ProvCd with $ErAddr ,bxx
  do convert-to-char($ErAddr, $ErAddr)
  if &CT.Country <> 'CAN'
     move &CT.Country to $Country
     concat $Country with $ErAddr bxxxxxxxxxx
  end-if
  let $TempCompAddr = RTRIM($ErAddr, ' ')

  unstring &CT.POSTAL by ' ' into $ErZIP1 $ErZIP2
  let $ErZIP1 = $ErZIP1 || $ErZIP2
  let $ErZipValue = edit($ErZIP1, 'xxxbxxx')
  do convert-to-char($ErZipValue, $ErZipValue)
  let $PrintCompAddr = $TempCompAddr || '  ' || $ErZipValue


end-procedure

begin-procedure Print-Footnotes


  move 'Y' to $MoreFootnotes
  move 0 to #NoteCount

  move 2 to #MaxFootnotes

  while #NoteCount < #MaxFootnotes
     if #NoteCount > #max_j  or $MoreFootnotes = 'N'
        break
     end-if
     move 999 to #HoldPriority
     move 0 to #j

     while #j <= #max_j
        get $CkBox #BoxPriority from FormNotes(#j) Box_Num Box_Priority
        move #BoxPriority to $BoxPriority
        if $CkBox = ' ' or
           $CkBox = ''
           break
        else
          if #BoxPriority < #HoldPriority and
             #BoxPriority <> 0
             let #HoldIdx = #j
             move #BoxPriority to #HoldPriority
          end-if
          add 1 to #j
        end-if
     end-while
      if #HoldPriority <> 999 and
         #HoldPriority <> 0
        put 999 into FormNotes (#HoldIdx) Box_Priority

        get $Note_Box from FormNotes (#HoldIdx) Box_Num
        get $Note_Text from FormNotes (#HoldIdx) Text
        get #Note_Amt from FormNotes (#HoldIdx) Box_Amount
        get $Note_Value from FormNotes (#HoldIdx) Box_Value

        add 1 to #NoteCount
        evaluate #NoteCount
           when = 1
              let #Slip1_FNLine = 26
              let #Slip_FNCol  = 43

           when = 2
              let #Slip1_FNLine = 28
              let #Slip_FNCol  = 43

        end-evaluate

       if $FormType = 'L'
          let #Slip2_FNLine = #Slip1_FNLine + 66
       end-if

       let $Note_Text = RTRIM($Note_Text, ' ')
       let $Note_Text = SUBSTR($Note_Text,1,30)

       if #Note_Amt <> 0
         do Format-Number(#Note_Amt, $Note_Amt, '999999.99')
         let $Note_Amt = LTRIM($Note_Amt, ' ')
         let $PrintAmt =  '$' || $Note_Amt || ' ' || $Note_Text

         print $PrintAmt (#Slip1_FNLine,#Slip_FNCol)
         print $PrintAmt (#Slip2_FNLine,#Slip_FNCol)

       else
         if $Note_Text <> ''
           let $PrintAmt = $Note_Text

           print $Note_Text (#Slip1_FNLine,#Slip_FNCol)
           print $Note_Text (#Slip2_FNLine,#Slip_FNCol)

         end-if
       end-if

      else
         move 'N' to $MoreFootnotes
      end-if

  end-while
  do Initialize-FormNotes-Array

end-procedure

begin-procedure Initialize-FormNotes-Array

  let #i = 0
  let $InitSpace = ' '
  let #InitNumber = 0

  while #i <= #max_i
   put $InitSpace #InitNumber $InitSpace $InitSpace #InitNumber
    into FormNotes(#i) Box_Num Box_Priority Text Box_Value Box_Amount

    add 1 to #i
  end-while

end-procedure


begin-procedure Initialize-Employee-Data

  move 0 to #LAPayment                ! box A
  move 0 to #MBenefits                ! box B
  move 0 to #OPayments                ! box C
  move 0 to #RefRRSP                  ! box D
  move 0 to #AmtPriorD                ! box E
  move 0 to #RExcessRRSP              ! box F
  move 0 to #RecRevRRP                ! box G
  move 0 to #OtherIncome              ! box H
  move 0 to #EntlDed                  ! box I
  move 0 to #QITWithheld              ! box J
  move 0 to #IncDeath                 ! box K
  move 0 to #WthdrwlLLP               ! box L
  move 0 to #TaxPaid                  ! box M
  move 0 to #WthdrwlHBP               ! box O

end-procedure

begin-procedure Write-Summary-Record

!Totals Formatting

  do format-number(#CalendarYear, $TaxYear, '9999')
  do format-number(#RV2Count, $TotalSupplementary, '0999999')
  do format-number(#TotLAPayment, $TotalLAPayment, '0999999999.99')
  do format-number(#TotMBenefits, $TotalMBenefits, '09999999.99')
  do format-number(#TotOPayments, $TotalOPayments, '09999999.99')
  do format-number(#TotRefRRSP, $TotalRefRRSP, '09999999.99')
  do format-number(#TotAmtPriorD, $TotAmtPriorD, '09999999.99')
  do format-number(#TotRExcessRRSP, $TotalRExcessRRSP, '09999999.99')
  do format-number(#TotRecRevRRP, $TotalRecRevRRP, '0999999999.99')
  do format-number(#TotOtherIncome, $TotalOtherIncome, '09999999.99')
  do format-number(#TotEntlDed, $TotEntlDed, '09999999.99')
  do format-number(#TotQITWithheld, $TotQITWithheld, '09999999.99')
  do format-number(#TotIncDeath, $TotIncDeath, '0999999999.99')
  do format-number(#TotWthdrwlLLP, $TotWthdrwlLLP, '0999999999.99')
  do format-number(#TotTaxPaid, $TotTaxPaid, '09999999.99')
  do format-number(#TotWthdrwlHBP, $TotWthdrwlHBP, '0999999999.99')

  write 1 from $CompanyName:30          -    ! 1   thru  30  Summary record
               $TaxYear:4               -    ! 31  thru 34
               $TotalSupplementary:7    -    ! 35  thru 41
               $TotalLAPayment:13       -    ! 42  thru 54   Box A
               $TotalMBenefits:11       -    ! 55  thru 65   Box B
               $TotalOPayments:11       -    ! 66  thru 76   Box C
               $TotalRefRRSP:11         -    ! 77  thru 87   Box D
               $TotAmtPriorD:11         -    ! 88  thru 98   Box E
               $TotalRExcessRRSP:11     -    ! 99  thru 109  Box F
               $TotalRecRevRRP:13       -    ! 110 thru 122  Box G
               $TotalOtherIncome:11     -    ! 123 thru 133  Box H
               $TotEntlDed:11           -    ! 134 thru 144  Box I
               $TotQITWithheld:11       -    ! 145 thru 155  Box J
               $TotIncDeath:13          -    ! 156 thru 168  Box K
               $TotWthdrwlLLP:13        -    ! 169 thru 181  Box L
               $TotTaxPaid:11           -    ! 182 thru 192  Box M
               $TotWthdrwlHBP:15        -    ! 193 thru 207  Box O
               $ReportID:16             -    ! 208 thru 223  no box
               $ReportType:1                 ! 224 thru 224  original/amended/cancelled

  do Init-Summary-Values

end-procedure


begin-procedure Init-Summary-Values

  move 0 to #RV2Count                 ! box no equiv
  move 0 to #TotLAPayment             ! box A
  move 0 to #TotMBenefits             ! box B
  move 0 to #TotOPayments             ! box C
  move 0 to #TotRefRRSP               ! box D
  move 0 to #TotAmtPriorD             ! box E
  move 0 to #TotRExcessRRSP           ! box F
  move 0 to #TotRecRevRRP             ! box G
  move 0 to #TotOtherIncome           ! box H
  move 0 to #TotEntlDed               ! box I
  move 0 to #TotQITWithheld           ! box J
  move 0 to #TotIncDeath              ! box K
  move 0 to #TotWthdrwlLLP            ! box L
  move 0 to #TotTaxPaid               ! box M
  move 0 to #TotWthdrwlHBP            ! box O

end-procedure


begin-procedure Insert-FormFeed

#ifndef MVS
#ifndef OS400
 encode '<27>&k2G' into $FormFeed
#else
 encode '<39>&k2G' into $FormFeed
#endif
#else
 encode '<39>&k2G' into $FormFeed
#endif

 print $FormFeed () code
 print ' ' (140,01)

end-procedure

begin-procedure Set-RV2-Row-Pointers

  let #Slip1_Row1 = 1
  let #Slip1_Row2 = 2
  let #Slip1_Row3 = 3
  let #Slip1_Row4 = 4
  let #Slip1_Row5 = 5
  let #Slip1_Row8 = 8
  let #Slip1_Row9 = 9
  let #Slip1_Row10 = 10
  let #Slip1_Row11 = 11
  let #Slip1_Row12 = 12
  let #Slip1_Row14 = 14
  let #Slip1_Row15 = 15
  let #Slip1_Row16 = 16
  let #Slip1_Row17 = 17
  let #Slip1_Row18 = 18
  let #Slip1_Row19 = 19
  let #Slip1_Row20 = 20
  let #Slip1_Row21 = 21
  let #Slip1_Row22 = 22
  let #Slip1_Row24 = 24
  let #Slip1_Row25 = 25
  let #Slip1_Row26 = 26
  let #Slip1_Row27 = 27
  let #Slip1_Row28 = 28
  let #Slip1_Row29 = 29
  let #Slip1_Row30 = 30
  let #Slip1_Row31 = 31
  let #Slip1_Row32 = 32
  let #Slip1_Row33 = 33
  let #Slip1_Row34 = 34
  let #Slip1_Row35 = 35
  let #Slip1_Row36 = 36
  let #Slip1_Row37 = 37
  let #Slip1_Row38 = 38
  let #Slip1_Row40 = 40
  let #Slip1_Row42 = 42
  let #Slip1_Row44 = 44
  let #Slip1_Row46 = 46
  let #Slip1_Row48 = 48
  let #Slip1_Row50 = 50

  let #Slip2_Row1  = #Slip1_Row1 + 66
  let #Slip2_Row2  = #Slip1_Row2 + 66
  let #Slip2_Row3  = #Slip1_Row3 + 66
  let #Slip2_Row4  = #Slip1_Row4 + 66
  let #Slip2_Row5  = #Slip1_Row5 + 66
  let #Slip2_Row8 =  #Slip1_Row8 + 66
  let #Slip2_Row9 =  #Slip1_Row9 + 66
  let #Slip2_Row10 = #Slip1_Row10 + 66
  let #Slip2_Row11 = #Slip1_Row11 + 66
  let #Slip2_Row12 = #Slip1_Row12 + 66
  let #Slip2_Row14 = #Slip1_Row14 + 66
  let #Slip2_Row15 = #Slip1_Row15 + 66
  let #Slip2_Row16 = #Slip1_Row16 + 66
  let #Slip2_Row17 = #Slip1_Row17 + 66
  let #Slip2_Row18 = #Slip1_Row18 + 66
  let #Slip2_Row19 = #Slip1_Row19 + 66
  let #Slip2_Row20 = #Slip1_Row20 + 66
  let #Slip2_Row21 = #Slip1_Row21 + 66
  let #Slip2_Row22 = #Slip1_Row22 + 66
  let #Slip2_Row24 = #Slip1_Row24 + 66
  let #Slip2_Row25 = #Slip1_Row25 + 66
  let #Slip2_Row26 = #Slip1_Row26 + 66
  let #Slip2_Row27 = #Slip1_Row27 + 66
  let #Slip2_Row28 = #Slip1_Row28 + 66
  let #Slip2_Row29 = #Slip1_Row29 + 66
  let #Slip2_Row31 = #Slip1_Row31 + 66
  let #Slip2_Row33 = #Slip1_Row33 + 66
  let #Slip2_Row35 = #Slip1_Row35 + 66
  let #Slip2_Row37 = #Slip1_Row37 + 66
  let #Slip2_Row30 = #Slip1_Row30 + 66
  let #Slip2_Row31 = #Slip1_Row31 + 66
  let #Slip2_Row32 = #Slip1_Row32 + 66
  let #Slip2_Row34 = #Slip1_Row34 + 66
  let #Slip2_Row36 = #Slip1_Row36 + 66
  let #Slip2_Row38 = #Slip1_Row38 + 66
  let #Slip2_Row40 = #Slip1_Row40 + 66
  let #Slip2_Row42 = #Slip1_Row42 + 66
  let #Slip2_Row44 = #Slip1_Row44 + 66
  let #Slip2_Row46 = #Slip1_Row46 + 66
  let #Slip2_Row48 = #Slip1_Row48 + 66
  let #Slip2_Row50 = #Slip1_Row50 + 66


end-procedure


begin-procedure Convert-Parameters

 if $RC_CAN_YE.RV2_Primary_Sort  = '1'
       let $SortSequence = 'SL.REPORTING_ID ASC, ' ||
       'EE.SLIP_SURNAME ASC, EE.SLIP_FIRST_NAME ASC, EE.EMPLID ASC, SL.CAN_YE_SLIP_SEQ ASC'

 else

      if $RC_CAN_YE.RV2_Primary_Sort  = '2'
         let $Sort1 = 'SL.REPORTING_ID ASC'
         let $DispSort1 = 'Quebec ID Number; '
      end-if

      if $RC_CAN_YE.RV2_Primary_Sort  = '3'
         let $Sort1 = 'SL.COMPANY ASC'
         let $DispSort1 = 'Company; '
      end-if

      if $RC_CAN_YE.RV2_Sec_Sort  = '1'
          let $Sort2 = 'EE.LOCATION ASC'
          let $DispSort2 = 'Location; '
      end-if

      if $RC_CAN_YE.RV2_Sec_Sort  = '2'
         let $Sort2 = 'EE.DEPTID ASC'
         let $DispSort2 = 'Department; '
      end-if

      if $RC_CAN_YE.RV2_Sec_Sort  = '3'
         let $Sort2 = 'EE.MAIL_DROP  ASC'
         let $DispSort2 = 'Mail Drop; '
      end-if

      if $RC_CAN_YE.RV2_Sec_Sort  = '4'
          let $Sort2 = 'EE.POSTAL  ASC'
          let $DispSort2 = 'Postal Code; '
      end-if

      if $RC_CAN_YE.RV2_SEC_SORT  = '5'
          let $Sort2 = 'N'
      end-if

      if $RC_CAN_YE.RV2_Third_Sort  = '1'
          let $Sort3 = 'EE.SLIP_SURNAME ASC, EE.SLIP_FIRST_NAME ASC, EE.EMPLID ASC, SL.CAN_YE_SLIP_SEQ ASC'
          let $DispSort3 = 'Employee Name; Employee ID'
      end-if

      if $RC_CAN_YE.RV2_Third_Sort  = '2'
         let $Sort3 = 'EE.EMPLID ASC, SL.CAN_YE_SLIP_SEQ ASC'
         let $DispSort3 = 'Employee ID'
      end-if

      if $RC_CAN_YE.RV2_Third_Sort  = '3'
         let $Sort3 = 'EE.SIN ASC , SL.CAN_YE_SLIP_SEQ ASC'
         let $DispSort3 = 'Employee SIN'
      end-if

  if $Sort2 = 'N'
     let $SortSequence =  $Sort1 || ', ' ||  $Sort3
     let $DisplaySeq = $DispSort1 || $DispSort3
  else
     let $SortSequence = $Sort1 || ', ' || $Sort2 || ', ' || $Sort3
     let $DisplaySeq = $DispSort1 || $DispSort2 || $DispSort3
  end-if

end-if

    if $RC_CAN_YE.RV2_Primary_Sort  = '2'
          move 'R' to $SortCode
   else
      if $RC_CAN_YE.RV2_Primary_Sort  = '3'
         move 'C' to $SortCode
      else
         move ' ' to $SortCode
      end-if
   end-if

  let $FormType = $RC_CAN_YE.RV2_Form_Type
  let $SelectEEs = $RC_CAN_YE.RL2_Processing_Flg

  if $SelectEEs = 'S' or $SelectEEs = 'E'
    do Read-EEs
  end-if


  let $ye_slip_process = ' '
  let $seq_number      = ' '

  evaluate $SelectEEs
  when = 'A'                    ! Amended slips
    let $ye_slip_process = ' AND SL.YE_SLIP_PROCESS = ''A'' '
    let $seq_number      = ')'
    let $ReportType      = 'A'
    break
  when = 'C'                    ! Cancelled slips
    let $ye_slip_process = ' AND SL.YE_SLIP_PROCESS = ''C'' '
    let $seq_number      = ')'
    let $ReportType      = 'C'
    break
  when = 'E'
    let $ye_slip_process = ' AND SL.YE_SLIP_PROCESS IN (''A'', ''C'') '
    let $seq_number      = ' AND SL1.TAXFORM_ID = SL.TAXFORM_ID AND SL1.YE_SLIP_PROCESS = SL.YE_SLIP_PROCESS) '
    break
  when = 'R'
  when = 'S'
    let $ye_slip_process = ' AND SL.YE_SLIP_PROCESS = ''O'' '
    let $seq_number      = ' AND SL1.YE_SLIP_PROCESS = SL.YE_SLIP_PROCESS) '
    let $ReportType      = 'O'
    break
  end-evaluate

  if $SelectEEs = 'A' or $SelectEEs = 'C'
    let $Proc_Amend_Cancel = 'Y'
  else
    let $StatusOpen = 'Y'
  end-if

end-procedure

!***********************************************************************
begin-procedure Declare-Printer-RV2
!***********************************************************************

  alter-printer
    symbol-set    = 10U
    font          = 3
    point-size    = 12

end-procedure

begin-procedure Read-EEs

move 'AND EE.EMPLID in (''' to $E.SelectedEEs
move ' ' to $SelectedEmplID

begin-SELECT
CT.EMPLID

  move &CT.EMPLID     to $SelectedEmplID

  let $E.SelectedEEs = $E.SelectedEEs || $SelectedEmplID || ''','''

  move 'Y' to $EE_Selected

FROM  PS_RC_CTX910VP CT
WHERE CT.OPRID         = $Prcs_OprID
  AND CT.RUN_CNTL_ID   = $Prcs_Run_Cntl_ID
end-SELECT


let $E.SelectedEEs = SUBSTR($E.SelectedEEs,1,LENGTH($E.SelectedEEs) - 2)
let $E.SelectedEEs = $E.SelectedEEs || ')'

end-procedure


begin-procedure Check-Status

  move 'N' to $StatusOpen

begin-SELECT
CS.EMPLID

  move 'Y' to $StatusOpen

FROM PS_CAN_AMEND_RL2_S CS
WHERE CS.COMPANY         = &SL.COMPANY
  AND CS.EMPLID          = &SL.EMPLID
  AND CS.CALENDAR_YEAR   = &SL.CALENDAR_YEAR
  AND CS.SEQUENCE_NUMBER = &SL.SEQUENCE_NUMBER
  AND CS.WAGE_LOSS_PLAN  = &SL.WAGE_LOSS_PLAN
  AND CS.PROVINCE        = &SL.PROVINCE
  AND CS.AMEND_STATUS    = 'O'
  AND CS.CAN_YE_SLIP_SEQ = &SL.CAN_YE_SLIP_SEQ


end-SELECT

end-procedure


begin-procedure Close-Amend-Cancel-RL-2

begin-SQL

  UPDATE PS_CAN_AMEND_RL2_S
  SET AMEND_STATUS       = 'C'
  WHERE COMPANY          = &SL.COMPANY
    AND EMPLID           = &SL.EMPLID
    AND CALENDAR_YEAR    = &SL.CALENDAR_YEAR
    AND SEQUENCE_NUMBER  = &SL.SEQUENCE_NUMBER
    AND WAGE_LOSS_PLAN   = &SL.WAGE_LOSS_PLAN
    AND PROVINCE         = &SL.PROVINCE
    AND CAN_YE_SLIP_SEQ  = &SL.CAN_YE_SLIP_SEQ

end-SQL

end-procedure


!begin-procedure Laser-Print-Alignment
!
!  print '20XX' (#Slip1_Row4,54)
!  print '20XX' (#Slip2_Row4,54)
!  print '20XX' (#Slip3_Row4,54)
!
!  print '999 999 999' (#Slip1_Row2,61)
!  print '999 999 999' (#Slip2_Row2,61)
!  print '999 999 999' (#Slip3_Row2,61)
!
!  move 99999999.99 to #BoxAmt
!  do Format-Number (#BoxAmt, $BoxAmt, '99999999.99')
!
!  print $BoxAmt (#Slip1_Row10,1)              ! Box 'A'
!  print $BoxAmt (#Slip2_Row10,1)
!  print $BoxAmt (#Slip3_Row10,1)
!
!  print $BoxAmt (#Slip1_Row10,14)             ! Box 'B'
!  print $BoxAmt (#Slip2_Row10,14)
!  print $BoxAmt (#Slip3_Row10,14)
!
!  print $BoxAmt (#Slip1_Row10,26)             ! Box 'C'
!  print $BoxAmt (#Slip2_Row10,26)
!  print $BoxAmt (#Slip3_Row10,26)
!
!  print $BoxAmt (#Slip1_Row10,39)             ! Box 'D'
!  print $BoxAmt (#Slip2_Row10,39)
!  print $BoxAmt (#Slip3_Row10,39)
!
!  print $BoxAmt (#Slip1_Row10,52)             ! Box 'E'
!  print $BoxAmt (#Slip2_Row10,52)
!  print $BoxAmt (#Slip3_Row10,52)
!
!  print $BoxAmt (#Slip1_Row10,64)             ! Box 'F'
!  print $BoxAmt (#Slip2_Row10,64)
!  print $BoxAmt (#Slip3_Row10,64)
!
!  print $BoxAmt (#Slip1_Row16,1)              ! Box 'G'
!  print $BoxAmt (#Slip2_Row16,1)
!  print $BoxAmt (#Slip3_Row16,1)
!
!  print $BoxAmt (#Slip1_Row16,14)             ! Box 'H'
!  print $BoxAmt (#Slip2_Row16,14)
!  print $BoxAmt (#Slip3_Row16,14)
!
!  print $BoxAmt (#Slip1_Row16,26)             ! Box 'I'
!  print $BoxAmt (#Slip2_Row16,26)
!  print $BoxAmt (#Slip3_Row16,26)
!  print $BoxAmt (#Slip1_Row16,39)             ! Box 'J'
!  print $BoxAmt (#Slip2_Row16,39)
!  print $BoxAmt (#Slip3_Row16,39)
!
!  print $BoxAmt (#Slip1_Row16,52)             ! Box 'K'
!  print $BoxAmt (#Slip2_Row16,52)
!  print $BoxAmt (#Slip3_Row16,52)
!
!  print $BoxAmt (#Slip1_Row16,64)             ! Box 'L'
!  print $BoxAmt (#Slip2_Row16,64)
!  print $BoxAmt (#Slip3_Row16,64)
!
!  print $BoxAmt (#Slip1_Row20,48)             ! Box 'M'
!  print $BoxAmt (#Slip2_Row20,48)
!  print $BoxAmt (#Slip3_Row20,48)
!
!  print '123 456 789' (#Slip1_Row22,61)       ! Box 'N'
!  print '123 456 789' (#Slip2_Row22,61)
!  print '123 456 789' (#Slip3_Row22,61)
!
!  print  'XXXXXXXXXXXX' (#Slip1_Row26,61)     ! Box 'O'
!  print  'XXXXXXXXXXXX' (#Slip2_Row26,61)
!  print  'XXXXXXXXXXXX' (#Slip3_Row26,61)
!
!  print 'XXXX' (#Slip1_Row4,44)               ! Provenance field
!  print 'XXXX' (#Slip2_Row4,44)
!  print 'XXXX' (#Slip3_Row4,44)
!
!  print '123 456 789' (#Slip1_Row26,43)       ! SIN
!  print '123 456 789' (#Slip2_Row26,43)
!  print '123 456 789' (#Slip3_Row26,43)
!
!  print 'NAMExxxxxxxxxxxxxxxx'    (#Slip1_Row25,3)
!  print 'STREET1xxxxxxxxxxxxx'    (#Slip1_Row27,3)
!
!  print 'NAMExxxxxxxxxxxxxxxx'    (#Slip2_Row26,3)
!  print 'STREET1xxxxxxxxxxxxx'    (#Slip2_Row28,3)
!
!  print 'NAMExxxxxxxxxxxxxxxx'    (#Slip3_Row25,3)
!  print 'STREET1xxxxxxxxxxxxx'    (#Slip3_Row27,3)
!
!  print 'STREET2xxxxxxxxxxxxx'    (#Slip1_Row29,3)
!  print 'ADDRESSxxxxxxxxxxxxx'    (#Slip1_Row31,3)
!  print 'ZIPxxxxxxxxxxxxxxxxx'    (#Slip1_Row33,3)
!
!  print 'STREET2xxxxxxxxxxxxx'    (#Slip2_Row30,3)
!  print 'ADDRESSxxxxxxxxxxxxx'    (#Slip2_Row32,3)
!  print 'ZIPxxxxxxxxxxxxxxxxx'    (#Slip2_Row34,3)
!
!  print 'STREET2xxxxxxxxxxxxx'    (#Slip3_Row29,3)
!  print 'ADDRESSxxxxxxxxxxxxx'    (#Slip3_Row31,3)
!  print 'ZIPxxxxxxxxxxxxxxxxx'    (#Slip3_Row33,3)
!
!  print 'COMPANYxxxxxxxxxxxxx'    (#Slip1_Row30,44)
!  print 'STREET1xxxxxxxxxxxxx'    (#Slip1_Row32,44)
!  print 'ADDRESSxxxxxxxxxxxxx'    (#Slip1_Row34,44)
!
!  print 'COMPANYxxxxxxxxxxxxx'    (#Slip2_Row30,44)
!  print 'STREET1xxxxxxxxxxxxx'    (#Slip2_Row32,44)
!  print 'ADDRESSxxxxxxxxxxxxx'    (#Slip2_Row34,44)
!
!  print 'COMPANYxxxxxxxxxxxxx'    (#Slip3_Row30,44)
!  print 'STREET1xxxxxxxxxxxxx'    (#Slip3_Row32,44)
!  print 'ADDRESSxxxxxxxxxxxxx'    (#Slip3_Row34,44)
!
!  let #Slip1_FNLine = 20
!  let #Slip2_FNLine = #Slip1_FNLine + 44
!  let #Slip3_FNLine = #Slip2_FNLine + 44
!
!  let #Slip_FNCol   = 1
!  print 'Footnote1xxxxxxxxxxxxxxxx' (#Slip1_FNLine,#Slip_FNCol)
!  print 'Footnote1xxxxxxxxxxxxxxxx' (#Slip2_FNLine,#Slip_FNCol)
!  print 'Footnote1xxxxxxxxxxxxxxxx' (#Slip3_FNLine,#Slip_FNCol)
!
!  let #Slip1_FNLine = 22
!  let #Slip2_FNLine = #Slip1_FNLine + 44
!  let #Slip3_FNLine = #Slip2_FNLine + 44
!  print 'Footnote2xxxxxxxxxxxxxxxx' (#Slip1_FNLine,#Slip_FNCol)
!  print 'Footnote2xxxxxxxxxxxxxxxx' (#Slip2_FNLine,#Slip_FNCol)
!  print 'Footnote2xxxxxxxxxxxxxxxx' (#Slip3_FNLine,#Slip_FNCol)
!
!  let #Dup1_Row =  #Slip1_Row1
!  let #Dup2_Row =  #Slip2_Row1
!  let #Dup3_Row =  #Slip3_Row1
!  print 'DUPLICATE' (#Dup1_Row,33)
!  print 'DUPLICATE' (#Dup2_Row,33)
!  print 'DUPLICATE' (#Dup3_Row,33)
!
!  print 'AMENDED' (#Slip1_Row3,33)
!  print 'AMENDED' (#Slip2_Row3,33)
!  print 'AMENDED' (#Slip3_Row3,33)
!
!  if $FormType <> 'L'
!     print '  ' (24,5)
!  else
!     do Insert-FormFeed
!  end-if
!
!  new-page
!
!end-procedure


#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#Include 'getcodta.sqc'  !Get-Company-Data procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'getdptnm.sqc'  !Get-Department-Name
#ifdef PRCSSCHD
#Include 'ctxrctl1.sqc'   !Get-Can-Tax YE Report Parameters
#Include 'stdapi.sqc'    !Update Process API
#Include 'txrnctl1.sqc'  !Process Scheduler Run Controls
#endif

