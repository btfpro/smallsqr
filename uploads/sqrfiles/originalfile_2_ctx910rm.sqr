
!***********************************************************************
!  CTX910RM: CANADA Magnetic Media Reporting - RL-1 XML                *
!                                                                      *
!***********************************************************************
!                                                                      *
!               Confidentiality Information:                           *
!                                                                      *
!                                                                      *
! This module contains confidential and proprietary information        *
! of Oracle; it is not to be copied, reproduced, or transmitted        *
! in any form, by any means, in whole or in part, nor is it to         *
! be used for any purpose other than that for which it is              *
! expressly provided under the applicable license agreement.           *
!                                                                      *
! Copyright (C) 2007 Oracle. All Rights Reserved.                      *
!                                                                      *
!***********************************************************************
!***********************************************************************
!                                                                      *
!          $Date:  2007/01/17:11:18:11                                 !
!       $Release:  HR9                                                 !
!    $Resolution:  654914                                              !
!                                                                      *
!***********************************************************************

#include 'setenv.sqc' !Set environment

#Include 'setup32.sqc'  !printer and page-size init
#Include 'ctxrnctl.sqc'  !Get-Tax-Reporting-Run-Controls procedure

begin-report
  do Init-Report

  do Process-Main

  if $FileType = 'D'
    close 20
  else
    close 10
  end-if

 #ifdef PRCSSCHD
  do StdAPI-Term
 #endif
end-report


begin-heading 3
  #Include 'stdhdg01.sqc'
  print $CTX910RM_Quebec_Report_Num    (3,1)
  print $ReportingID       (0,33)
  print $CalYear           (3,,)      center
end-heading


begin-procedure Init-Report
  do Init-DateTime
  do Init-Number
  do Get-Current-DateTime

 #ifdef PRCSSCHD
  do StdAPI-Init
 #endif


  move 'CTX910RM' to $ReportID
  do Get-Report-Language          ! Procedure that decides the report language
                                  ! and then calls 'Report-Translation' procedure
                                  ! that reads the language dep. text.
  do Initialization

 if $FileType = 'D'
  display ''
  display 'Creating Diskette File for RL-1 Reporting'
 else
  display ''
  display 'Creating CD-ROM/DVD File for RL-1 Reporting'
 end-if

end-procedure


begin-procedure Initialization

  do Get-Current-DateTime
  move ' ' to $TaxYear
  move '1' to $MMLZero
  move '1' to $Year4
  do Format-DateTime($AsOfToday, $910Date, {DEFYMD},'','')

  move ' '  to $PriorCompany

  move $910Date to $AsOfYear xxxx   !extract the current year
  move $AsOfYear  to #AsOfYear
  move #AsOfYear  to #saveAsOfYear
  subtract 1    from #AsOfYear

  do Get-Can-Tax-Processing-Params

  move $CTX910RM_Report_Title to $ReportTitle
  move &TX.Balance_Year to $RptYear 9999
  move $RptYear          to $CalendarYr
  move $RptYear          to $RptYear ~~xx
  move $PeriodEndDate    to $AsOfDate

  move &TX.Balance_Year to $CalYear 9999
  let $AsOfDate = $CalYear || '1231'
  do Format-DateTime($AsOfDate, $AsOfDate, {DEFCMP}, '', 'native')

  if &TX.Balance_Year <> #AsOfYear and $Prcs_Process_Instance = ''
    display ''
    display 'Current Year is not one greater than Tax Reporting Year.'
    display 'Current Year is    ' noline
    display  #saveAsOfYear  9999
    display 'Tax Reporting Year ' noline
    display &TX.Balance_Year
    input $Answer maxlen=1 'Current Year is not one greater than Tax Reporting Year. Do you want to continue? (Y/N)'
    uppercase $Answer
    if $Answer <> 'Y'
      stop
    end-if
  end-if

  #ifdef PRCSSCHD
    do Select-Canadian-YrEnd-Parameters
    do Convert-Parameters
  #endif

  if $FileType = 'D'
    move 200 to #RecordLength
    do Calculate-Diskette-Capacity               !npa
  end-if

  do Open-File

  do Initialize-Detail
  do Initialize-Summary

  let $xml_cntrl_begin = '<'
  let $xml_cntrl_end   = '>'
  let $xml_text_delim  = '"'
  let $xml_tag_end     = '/'
  let $xml_tag         = ''
  let $xml_content     = ''
  let $xml_output_line = ''

end-procedure


begin-procedure Report-Translation

  do Init_Report_Translation($ReportID,$Language_Cd)

  do Get_Field_Information ('CTX910RM', 'QUEBEC_REPORT_NUM' , $CTX910RM_Quebec_Report_Num , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'REPORT_TITLE'      , $CTX910RM_Report_Title , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'NEGATIVE_VALUE_FND', $CTX910RM_negative_value_fnd , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'NO_RL1_REC_CREATED', $CTX910RM_no_rl1_rec_created , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'SUMMARY_DATA'      , $CTX910RM_summary_data , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TYPE_CODE'         , $CTX910RM_type_code , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_SLIPS'       , $CTX910RM_total_slips , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_A'       , $CTX910RM_total_box_A , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_B'       , $CTX910RM_total_box_B , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_C'       , $CTX910RM_total_box_C , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_D'       , $CTX910RM_total_box_D , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_E'       , $CTX910RM_total_box_E , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_F'       , $CTX910RM_total_box_F , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_G'       , $CTX910RM_total_box_G , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_H'       , $CTX910RM_total_box_H , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_I'       , $CTX910RM_total_box_I , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_J'       , $CTX910RM_total_box_J , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_K'       , $CTX910RM_total_box_K , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_L'       , $CTX910RM_total_box_L , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_M'       , $CTX910RM_total_box_M , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_N'       , $CTX910RM_total_box_N , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_O'       , $CTX910RM_total_box_O , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_P'       , $CTX910RM_total_box_P , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_Q'       , $CTX910RM_total_box_Q , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_R'       , $CTX910RM_total_box_R , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_S'       , $CTX910RM_total_box_S , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_T'       , $CTX910RM_total_box_T , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_BOX_U'       , $CTX910RM_total_box_U , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_CPP_CONTR'   , $CTX910RM_total_CPP_contr , #dummy_width)
  do Get_Field_Information ('CTX910RM', 'TOTAL_DED_FORCE'   , $CTX910RM_total_ded_force , #dummy_width)

end-procedure


begin-procedure Open-File
if $FileType = 'D'
   move 0 to #RecordCount
   if #FileExtension <> 0
      close 20
   else
#ifdef MPE
  let $feq='FILE CTXRM.DAT; REC=-200,,F,ASCII'
  call system using $feq #status
  open 'CTXRM.DAT' as 10 for-writing record=200:vary
#else
  open '{IMPORTPREFIX}CTXRM{IMPORTSUFFIX}' as 10 for-writing record=200:vary
#endif

   end-if
   add 1 to #FileExtension
#ifdef MPE
   move #FileExtension to $FileExtension 9
   let $FileID = 'CTXRM' || $FileExtension || '.DAT'
   let $feq='FILE ' || $FileID || '; REC=-200,,F,ASCII'
   call system using $feq #status
#else
   #ifdef OS400
      move #FileExtension to $FileExtension 099
      let $FileID = 'CTXRM' || '(D' || $FileExtension || ')'
   #else
      #ifdef MVS
         move #FileExtension to $FileExtension 099
         let $FileID = 'CTXRM' || $FileExtension
      #else
         move #FileExtension to $FileExtension 099
         let $FileID = '{IMPORTPREFIX}' || 'CTXRM.' || $FileExtension
      #endif
   #endif
#endif
   open $FileID as 20 for-writing record=200:vary
else
#ifdef MPE
  let $feq='FILE CTXRM.DAT; REC=-200,,F,ASCII'
  call system using $feq #status
  open 'CTXRM.DAT' as 10 for-writing record=200:vary
#else
  open '{IMPORTPREFIX}CTXRM{IMPORTSUFFIX}' as 10 for-writing record=200:vary
#endif

end-if
end-procedure


begin-procedure Process-Main

  do Check-RL-Slip-Exists

  if $RL-Slip-Exists = 'Y'
    do Write-Transmitter-Record
    do Process-Year-End-Records
    let $xml_tag = 'Transmission'
    do Process-XML-Tag-End
  else
    display 'No slips processed'
    display ''
  end-if

end-procedure


begin-procedure Process-Year-End-Records

begin-SELECT
S.COMPANY
S.REPORTING_ID   () on-break print=never after=Write-Summary-Record
S.WAGE_LOSS_PLAN
S.PROVINCE
S.SEQUENCE_NUMBER
S.TAXFORM_ID
S.CALENDAR_YEAR
S.RELEVE_SLIP_NO
S.EMPLID
E.EMPLID
E.SIN
E.SLIP_SURNAME
E.SLIP_FIRST_NAME
E.SLIP_INITIAL
E.ADDRESS1
E.ADDRESS2
E.CITY
E.PROVINCE
E.COUNTRY
E.POSTAL
E.DECEASED

 if $Proc_Amend_Cancel = 'Y'
  do Check-Status
 end-if

 if $StatusOpen = 'Y'

     do Save-Employee-Data
     let $FoundNegative = 'N'
     if $Proc_Type = 'O' or $Proc_Type = 'A'
       do Check-For-Negative-Amt

       if $FoundNegative = 'N'
         do Get-Detail-Data
         if $Proc_Type = 'O'
           do Write-Releve1-Record
           let $xml_tag      = $TypeData
           do Process-XML-Tag-End
         else
           if $Proc_Type = 'A'
             do Write-RL-1-Data-Amend
           end-if
         end-if
       else
         do Error-Report
         move 'N' to $FoundNegative
       end-if

     else
       if $Proc_Type = 'C'
         do Write-RL-1-Data-Cancel
       end-if
     end-if

     do Initialize-Detail

 end-if

FROM PS_CAN_YE_EMPL  E,
     PS_CAN_YE_SLIP  S
WHERE E.CALENDAR_YEAR = &TX.Balance_Year
  AND S.CALENDAR_YEAR = &TX.Balance_Year
  AND S.TAXFORM_ID = 'R'
  AND S.COMPANY = E.COMPANY
  AND E.EMPLID = S.EMPLID
  AND E.SEQUENCE_NUMBER = S.SEQUENCE_NUMBER
  AND S.SEQUENCE_NUMBER = (SELECT MAX(S1.SEQUENCE_NUMBER)
               FROM PS_CAN_YE_SLIP S1
               WHERE S1.COMPANY = S.COMPANY
                 AND S1.EMPLID  = S.EMPLID
                 AND S1.CALENDAR_YEAR = S.CALENDAR_YEAR
                 AND S1.TAXFORM_ID    = S.TAXFORM_ID
#ifdef MVS
  \$seq_number\
#else
  [$seq_number]
#endif
#ifdef MVS
  \$ye_slip_process\
#else
  [$ye_slip_process]
#endif

ORDER by S.REPORTING_ID ASC, S.COMPANY ASC, E.SLIP_SURNAME ASC,
        E.SLIP_FIRST_NAME ASC, E.EMPLID ASC
end-SELECT

 if $Proc_Type = 'O' and $BegSlipNo_Found = 'Y'
   do Write-Releve-Serial-End
 else
   if $Proc_Type = 'A' and $EndSlipNo_Found = 'Y'
     do Write-Releve-Serial-End-Amend
   end-if
 end-if

end-procedure


begin-procedure Save-Employee-Data

  if &S.Company <> $PriorCompany

          if $Proc_Type = 'O'
            if $PriorCompany <> ' '    ! first time through, no serial end yet
              and $BegSlipNo_Found = 'Y'
                do Write-Releve-Serial-End
            end-if
          end-if

          if $Proc_Type = 'A'
            if $PriorCompany <> ' '    ! first time through, no serial end yet
              and $EndSlipNo_Found = 'Y'
                do Write-Releve-Serial-End-Amend
            end-if
          end-if

          if $Proc_Type = 'O'
            do Get-Begin-Releve-Slip-No
          else
            if $Proc_Type = 'A'
              do Get-End-Releve-Slip-No
            end-if
          end-if



     move &S.Company to $Company
     move &S.Company to $PriorCompany
     do Get-Company-Data
     move &CT.Descr to $CompanyName
  end-if

 if rtrim(&S.Reporting_ID, ' ') <> rtrim($PriorReporting_ID, ' ')
   let $PrintGroupe = 'Y'
 end-if
 move &S.Reporting_ID          to $PriorReporting_ID

 move &S.Reporting_ID          to $ReportingID
 move &E.SLIP_Surname          to $E_LastName
 move &E.SLIP_First_Name       to $E_FirstName
 move &E.SLIP_Initial          to $E_Initial
 move &E.Address1              to $E_AddrLine1
 move &E.Address2              to $E_AddrLine2
 move &E.City                  to $E_City
 let $E_Province = rtrim(&E.Province,' ')
 move &E.Postal                to $E_PostalCode
 move &E.EmplID                to $EmplID
 move &E.SIN                   to $E_SIN
 if  rtrim($E_SIN, ' ') = '' OR
     rtrim($E_SIN, ' ') = '999999999'
      move ' ' to $E_SIN
 end-if
 move &E.COUNTRY               to $E_Country
 if $E_Province = 'ZZ' and $E_Country <> 'CAN' and $E_Country <> 'USA'
    do Get-Country-Name
 end-if

 if $Proc_Type = 'O' or $Proc_Type = 'A'
   do Update-Slip-Detail
 end-if

 if $Proc_Type = 'C'
   move &S.Releve_Slip_No      to #Releve_Slip_No
 end-if


 do Format-Number(#Releve_Slip_No,$ReleveSlipNo,'999999999')

  if $E_Country = 'CAN'
     move &E.Postal to $PostalCd
     do Check-Postal-Code
     move $PostalCd to $E_PostalCode
  else
     move &E.Postal to $E_PostalCode
  end-if

end-procedure


begin-procedure Get-Begin-Releve-Slip-No

move 7 to #CheckDigit_Calc_Value ! as per Quebec guidelines

let $BegSlipNo_Found = 'N'

begin-SELECT
T.RELEVE_SERIAL_BEG
T.COMPANY
T.EFFDT

  let $BegSlipNo_Found = 'Y'

FROM  PS_PQ_REPTNG_TBL T
 WHERE &S.Company = T.COMPANY
AND   T.EFFDT = (SELECT
      MAX(EFFDT)
      FROM PS_PQ_REPTNG_TBL
      WHERE EFFDT <= $AsOfDate
        AND COMPANY = &S.Company)
end-SELECT

 move &T.Releve_Serial_Beg to #Releve_Serial_No

end-procedure

begin-procedure Get-Country-Name

move ' ' to $Country_name

begin-SELECT
CN.DESCR,
CN.DESCRSHORT

 move &CN.DESCR to $Country_name

 FROM  PS_COUNTRY_TBL CN
 WHERE CN.COUNTRY = $E_Country
end-SELECT

let  $E_Province = substr($Country_name, 1, 20)

if  $E_Province = ' '
    move $E_Country to $E_Province
end-if

end-procedure

begin-procedure Get-End-Releve-Slip-No

move 7 to #CheckDigit_Calc_Value ! as per Quebec guidelines

let $EndSlipNo_Found = 'N'

begin-SELECT
TE.RELEVE_SERIAL_END
TE.COMPANY
TE.EFFDT

  let $EndSlipNo_Found = 'Y'

FROM  PS_PQ_REPTNG_TBL TE
 WHERE &S.Company = TE.COMPANY
AND   TE.EFFDT = (SELECT
      MAX(TE1.EFFDT)
      FROM PS_PQ_REPTNG_TBL TE1
      WHERE TE1.EFFDT <= $AsOfDate
        AND TE1.COMPANY = &S.Company)
end-SELECT

 move &TE.Releve_Serial_End to #Releve_Serial_No
 let #Releve_Serial_No = #Releve_Serial_No / 10
 let #Releve_Serial_No = trunc (#Releve_Serial_No,0)

 add 1 to #Releve_Serial_No

end-procedure


begin-procedure Update-Slip-Detail

do Calculate-Releve-Slip-No

begin-sql
UPDATE PS_CAN_YE_SLIP
SET RELEVE_SLIP_NO = $Releve_Slip_No
WHERE COMPANY         = &S.COMPANY
AND   EMPLID          = &S.EMPLID
AND   CALENDAR_YEAR   = &TX.BALANCE_YEAR
AND   TAXFORM_ID      = 'R'
AND   WAGE_LOSS_PLAN  = &S.WAGE_LOSS_PLAN
AND   PROVINCE        = &S.PROVINCE
AND   SEQUENCE_NUMBER = &S.SEQUENCE_NUMBER
end-SQL

end-procedure

begin-procedure Calculate-Releve-Slip-No

let #Releve_Add_Value = mod(#Releve_Serial_No,#CheckDigit_Calc_Value)

do Format-Number (#Releve_Serial_No,$Releve_Serial_No,'99999999')
do Format-Number (#Releve_Add_Value,$Releve_Add_Value,'9')

let $Releve_Slip_No = $Releve_Serial_No || $Releve_Add_Value

let #Releve_Slip_No = $Releve_Slip_No

add 1 to #Releve_Serial_No

end-procedure

begin-procedure Write-Releve-Serial-End

begin-sql
UPDATE PS_PQ_REPTNG_TBL
SET  RELEVE_SERIAL_END = #Releve_Slip_No
WHERE COMPANY = &T.Company
AND   EFFDT = &T.Effdt
end-SQL

 move 0 to #Releve_Slip_No

end-procedure


begin-procedure Write-Releve-Serial-End-Amend

begin-sql
UPDATE PS_PQ_REPTNG_TBL
SET  RELEVE_SERIAL_END = #Releve_Slip_No
WHERE COMPANY = &TE.Company
AND   EFFDT = &TE.Effdt
end-SQL

 move 0 to #Releve_Slip_No

end-procedure


begin-procedure Check-For-Negative-Amt

begin-SELECT
NA.BOX
NA.CAN_YE_BOX_AMT

  if &NA.CAN_YE_BOX_AMT < 0
    move 'Y' to $FoundNegative
  end-if

FROM PS_CAN_YE_DETAIL  NA
WHERE NA.COMPANY = &S.Company
  AND NA.EMPLID  = &E.EmplID
  AND NA.CALENDAR_YEAR = &TX.Balance_Year
  AND NA.TAXFORM_ID = &S.Taxform_ID
  AND NA.WAGE_LOSS_PLAN = &S.Wage_Loss_Plan
  AND NA.PROVINCE = &S.Province
  AND NA.SEQUENCE_NUMBER = &S.Sequence_Number

end-SELECT

end-procedure


begin-procedure Get-Detail-Data

begin-SELECT
D.BOX
D.CAN_YE_BOX_TEXT
D.CAN_YE_BOX_AMT

  do Save-Detail-Data

FROM PS_CAN_YE_DETAIL  D
WHERE D.COMPANY = &S.Company
  AND D.EMPLID  = &E.EmplID
  AND D.CALENDAR_YEAR = &TX.Balance_Year
  AND D.TAXFORM_ID = &S.Taxform_ID
  AND D.WAGE_LOSS_PLAN = &S.Wage_Loss_Plan
  AND D.PROVINCE = &S.Province
  AND D.SEQUENCE_NUMBER = &S.Sequence_Number
ORDER by D.BOX ASC

end-SELECT

end-procedure

begin-procedure Save-Detail-Data

  let $Box = RTRIM(&D.Box, ' ')

  let #BoxAmt = &D.CAN_YE_Box_Amt

  if #BoxAmt > 0 and $FoundNegative = 'N'

    evaluate $Box

       when = 'A'
          do Format-Number(#BoxAmt, $EmplIncome, '9999999.99')
          add #BoxAmt to #SumEmplIncome

          let #BoxA = #BoxAmt

       when = 'B'
          do Format-Number(#BoxAmt, $QPPContrib,  '9999999.99')
          add #BoxAmt to #SumQPPContrib

          let #BoxB = #BoxAmt

       when = 'B01'
          do Format-Number(#BoxAmt, $CPPContrib,  '9999999.99')
          add #BoxAmt to #SumCPPContrib

       when = 'C'
          do Format-Number(#BoxAmt, $UICPremiums, '9999999.99')
          add #BoxAmt to #SumUICPremiums

       when = 'D'
          do Format-Number(#BoxAmt, $RRPContrib,  '9999999.99')
          add #BoxAmt to #SumRRPContrib

       when = 'E'
          do Format-Number(#BoxAmt, $QITWithheldSource, '9999999.99')
          add #BoxAmt to #SumQITWithheldSource

       when = 'F'
          do Format-Number(#BoxAmt, $UnionDues, '9999999.99')
          add #BoxAmt to #SumUnionDues

       when = 'G'
          if #BoxA = #BoxAmt
            let $QPPPensEarns = ' '
          else
            do Format-Number(#BoxAmt, $QPPPensEarns, '9999999.99')
            add #BoxAmt to #SumBoxG
          end-if

          add #BoxAmt to #SumQPPPensEarns

       when = 'H'
          do Format-Number(#BoxAmt, $MealsAndAccom, '9999999.99')
          add #BoxAmt to #SumMealsAndAccom

       when = 'I'
          do Format-Number(#BoxAmt, $AutoUse, '9999999.99')
          add #BoxAmt to #SumAutoUse

       when = 'J'
          do Format-Number(#BoxAmt, $HealthServPlan, '9999999.99')
          add #BoxAmt to #SumHealthServPlan

       when = 'K'
          do Format-Number(#BoxAmt, $TripsToRemoteAreas , '9999999.99')
          add #BoxAmt to #SumTripsToRemoteAreas

      when = 'L'
          do Format-Number(#BoxAmt, $OtherBenefits , '9999999.99')
          add #BoxAmt to #SumOtherBenefits

       when = 'M'
          do Format-Number(#BoxAmt, $Commissions , '9999999.99')
          add #BoxAmt to #SumCommissions

       when = 'N'
          do Format-Number(#BoxAmt, $CharitableDonatns, '9999999.99')
          add #BoxAmt to #SumCharitableDonatns

       when = 'O'
          do Format-Number(#BoxAmt, $OtherTaxIncome, '9999999.99')
          add #BoxAmt to #SumOtherTaxIncome

       when = 'P'
          do Format-Number(#BoxAmt, $ContribMEInsPlan, '9999999.99')
          add #BoxAmt to #SumContribMEInsPlan

       when = 'Q'
          do Format-Number(#BoxAmt, $DefrdSalaryWages, '9999999.99')
          add #BoxAmt to #SumDefrdSalaryWages

       when = 'R'
          do Format-Number(#BoxAmt, $Indian, '9999999.99')
          add #BoxAmt to #SumIndian

       when = 'S'
          do Format-Number(#BoxAmt, $Tip, '9999999.99')
          add #BoxAmt to #SumTip

       when = 'T'
          do Format-Number(#BoxAmt, $TipsAllocated, '9999999.99')
          add #BoxAmt to #SumTipsAllocated

       when = 'U'
          do Format-Number(#BoxAmt, $PhasedRetire, '9999999.99')
          add #BoxAmt to #SumPhasedRetire

       when = 'A43'
       when = 'A44'
          add #BoxAmt to #DedForce
          do Format-Number(#DedForce, $DedForce, '9999999.99')
          add #BoxAmt to #SumDedForce

    end-evaluate
  end-if

  if $Box = 'G' and #BoxAmt = 0 and #BoxB = 0
    do Format-Number(#BoxAmt, $QPPPensEarns, '9999999.99')
  end-if

  if $Box = 'CDO'
    move &D.CAN_YE_BOX_TEXT to $Code
  end-if

end-procedure


begin-Procedure Write-Transmitter-Record
  move &TX.Rlv_Company       to $Company  !TX.Rlv_Company is the Transmitter
  if RTRIM($Company,' ') = ''
    display '*** Company field blank on Tax Run Control Record ***'
    display '***************** Processing stopped ****************'
    stop
  end-if

  do Get-Company-Data                           !Transmitter identifying data

  move &TX.Rlv_Transm_ID                        to $TransmitterID

  move &TX.Balance_Year                         to $TaxYear

  move &TX.Rlv_Tech_Res_Name                    to $Name
  do Rotate-Name
  do Rotate-Name-for-Mag-Media

  if $SuffixFound <> 'Y'
   let $Name = SUBSTR($LastName,1,LENGTH($LastName) - 1) || ' ' || $FirstName
  else
     let $Name = $LastName || ' ' || $FirstName
  end-if

  let $TechResourceName = substr($Name,1,30)

  move &TX.Rlv_Tech_Res_ACode                   to #TechResourceAreaCode
  do format-number(#TechResourceAreaCode, $TechResourceAreaCode, '999')

  move &TX.Rlv_Tech_Res_Phone                   to #TechResourcePhone
  do format-number(#TechResourcePhone, $TechResourcePhone, '9999999')

  move &TX.Rlv_Tech_Res_Ext                     to #TechResourceExtNo
  do format-number(#TechResourceExtNo, $TechResourceExtNo, '99999')

  move &TX.Rlv_Tech_Res_Lang                    to $TechResourceLanguage
  move &TX.Rlv_Acct_Res_Name                    to $Name
  do Rotate-Name
  do Rotate-Name-for-Mag-Media
  if $SuffixFound <> 'Y'
    let $Name = SUBSTR($LastName,1,LENGTH($LastName) - 1) || ' ' || $FirstName
  else
    let $Name = $LastName || ' ' || $FirstName
  end-if

  let $AcctingResourceName = substr($Name,1,30)

  move &TX.Rlv_Acct_Res_ACode                   to #AcctingResourceAreaCode
  do format-number(#AcctingResourceAreaCode, $AcctingResourceAreaCode , '999')

  move &TX.Rlv_Acct_Res_Phone                   to #AcctingResourcePhone
  do format-number(#AcctingResourcePhone, $AcctingResourcePhone, '9999999')

  move &TX.Rlv_Acct_Res_Ext                     to #AcctingResourceExtNo
  do format-number(#AcctingResourceExtNo, $AcctingResourceExtNo, '99999')

  move &TX.Rlv_Acct_Res_Lang                    to $AcctingResourceLanguage
  move &TX.Rlv_Package_Type                     to $PackageType
  move &TX.Rlv_Transm_Type                      to $TransmitterType
  move &TX.Rlv_Source                           to $ReleveSource

  If $CO_FOUND = 'Y'
        move &CT.Descr to $CompanyName
        move $CompanyName                            to $TransmitterNameLine1
        move $CompnyAdd1                             to $TransmitterAddrLine1
        move $CompnyADD2                             to $TransmitterAddrLine2
        move $CompnyCity                             to $TransmitterCity
        let $TransmitterProvince = rtrim(&CT.State, ' ')

        if &CT.Country = 'CAN'
                move &CT.Postal to $PostalCd
                do Check-Postal-Code
                move $PostalCd to $TransmitterPostalCode
        else
                move &CT.Postal to $TransmitterPostalCode
        end-if
  else

        move &TX.Descr        to  $TransmitterNameLine1
        move &TX.Address1     to  $TransmitterAddrLine1
        move &TX.Address2     to  $TransmitterAddrLine2
        move &TX.City         to  $TransmitterCity

        let $TransmitterProvince = rtrim(&TX.Province, ' ')
        move &TX.Country      to $TransmitterCountry
        if &TX.Country = 'CAN'
           move &TX.Postal to $PostalCd
           do Check-Postal-Code
           move $PostalCd to $TransmitterPostalCode
        else
           move &TX.Postal to $TransmitterPostalCode
        end-if
  end-if

  do Count-ReportingID-Numbers

  do format-number(#SummaryCounter, $SummaryCounter, '999999')
  display ' '
  display 'Total number of RL-1 summary is : ' noline
  display $SummaryCounter
  display ' '


   write 10 from '<?xml version="1.0" encoding="iso-8859-1"?>'
   if $FileType = 'D'
     write 20 from '<?xml version="1.0" encoding="iso-8859-1"?>'
     add 1 to #RecordCount
   end-if

   write 10 from '<Transmission VersionSchema="2005.1.3" xmlns="http://www.mrq.gouv.qc.ca/T5">'
   if $FileType = 'D'
     write 20 from '<Transmission VersionSchema="2005.1.3" xmlns="http://www.mrq.gouv.qc.ca/T5">'
     add 1 to #RecordCount
   end-if

   let $xml_tag      = 'P'
   do Process-XML-Tag-Beg

   if rtrim($TaxYear, ' ') <> ''
     let $xml_tag      = 'Annee'
     let $xml_content  = $TaxYear
     do Process-XML-Tag-Content
   end-if

   if rtrim($PackageType, ' ') <> ''
     let $xml_tag      = 'TypeEnvoi'
     let $xml_content  = $PackageType
     do Process-XML-Tag-Content
   end-if

   if rtrim($ReleveSource, ' ') <> ''
     let $xml_tag      = 'Provenance'
     let $xml_content  = $ReleveSource
     do Process-XML-Tag-Content
   end-if

   let $xml_tag      = 'Preparateur'
   do Process-XML-Tag-Beg

   if rtrim($TransmitterID, ' ') <> ''
     let $xml_tag      = 'No'
     let $xml_content  = rtrim($TransmitterID, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TransmitterType, ' ') <> ''
     let $xml_tag      = 'Type'
     let $xml_content  = rtrim($TransmitterType, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TransmitterNameLine1, ' ') <> ''
     let $xml_tag      = 'Nom1'
     let $TransmitterNameLine1 =  substr($TransmitterNameLine1, 1, 30)
     let $xml_content  = rtrim($TransmitterNameLine1, ' ')
     do Process-XML-Tag-Content
   end-if

   let $xml_tag      = 'Adresse'
   do Process-XML-Tag-Beg

   if rtrim($TransmitterAddrLine1, ' ') <> ''
     let $xml_tag      = 'Ligne1'
     let $TransmitterAddrLine1 =  substr($TransmitterAddrLine1, 1, 30)
     let $xml_content  = rtrim($TransmitterAddrLine1, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TransmitterAddrLine2, ' ') <> ''
     let $xml_tag      = 'Ligne2'
     let $TransmitterAddrLine2 = substr($TransmitterAddrLine2, 1, 30)
     let $xml_content  = rtrim($TransmitterAddrLine2, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TransmitterCity, ' ') <> ''
     let $xml_tag      = 'Ville'
     let $TransmitterCity =  substr($TransmitterCity, 1, 30)
     let $xml_content  = rtrim($TransmitterCity, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TransmitterProvince, ' ') <> ''
     let $xml_tag      = 'Province'
     let $xml_content  = rtrim($TransmitterProvince, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TransmitterPostalCode, ' ') <> ''
     let $xml_tag      = 'CodePostal'
     let $xml_content  = rtrim($TransmitterPostalCode, ' ')
     do Process-XML-Tag-Content
   end-if

   let $xml_tag      = 'Adresse'
   do Process-XML-Tag-End

   let $xml_tag      = 'Preparateur'
   do Process-XML-Tag-End


   if rtrim($TechResourceName, ' ') <> ''      or
      ltrim($TechResourceAreaCode, ' ') <> '0' or
      ltrim($TechResourcePhone, ' ') <> '0'    or
      ltrim($TechResourceExtNo, ' ') <> '0'    or
      rtrim($TechResourceLanguage, ' ') <> ''

     let $xml_tag      = 'Informatique'
     do Process-XML-Tag-Beg
   end-if

   if rtrim($TechResourceName, ' ') <> ''
     let $xml_tag      = 'Nom'
     let $xml_content  = rtrim($TechResourceName, ' ')
     do Process-XML-Tag-Content
   end-if

   if ltrim($TechResourceAreaCode, ' ') <> '0'
     let $xml_tag      = 'IndRegional'
     let $xml_content  = ltrim($TechResourceAreaCode, ' ')
     do Process-XML-Tag-Content
   end-if

   if ltrim($TechResourcePhone, ' ') <> '0'
     let $xml_tag      = 'Tel'
     let $xml_content = edit($TechResourcePhone,'xxx-xxxx')
     do Process-XML-Tag-Content
   end-if

   if ltrim($TechResourceExtNo, ' ') <> '0'
     let $xml_tag      = 'PosteTel'
     let $xml_content  = ltrim($TechResourceExtNo, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($TechResourceLanguage, ' ') <> ''
     let $xml_tag      = 'Langue'
     let $xml_content  = $TechResourceLanguage
     do Process-XML-Tag-Content
   end-if


   if rtrim($TechResourceName, ' ') <> ''      or
      ltrim($TechResourceAreaCode, ' ') <> '0' or
      ltrim($TechResourcePhone, ' ') <> '0'    or
      ltrim($TechResourceExtNo, ' ') <> '0'    or
      rtrim($TechResourceLanguage, ' ') <> ''

     let $xml_tag      = 'Informatique'
     do Process-XML-Tag-End
   end-if


   if rtrim($AcctingResourceName, ' ') <> ''      or
      ltrim($AcctingResourceAreaCode, ' ') <> '0' or
      ltrim($AcctingResourcePhone, ' ') <> '0'    or
      ltrim($AcctingResourceExtNo, ' ') <> '0'    or
      rtrim($AcctingResourceLanguage, ' ') <> ''

     let $xml_tag      = 'Comptabilite'
     do Process-XML-Tag-Beg
   end-if


   if rtrim($AcctingResourceName, ' ') <> ''
     let $xml_tag      = 'Nom'
     let $xml_content  = rtrim($AcctingResourceName, ' ')
     do Process-XML-Tag-Content
   end-if

   if ltrim($AcctingResourceAreaCode, ' ') <> '0'
     let $xml_tag      = 'IndRegional'
     let $xml_content  = ltrim($AcctingResourceAreaCode, ' ')
     do Process-XML-Tag-Content
   end-if

   if ltrim($AcctingResourcePhone, ' ') <> '0'
     let $xml_tag      = 'Tel'
     let $xml_content = edit($AcctingResourcePhone,'xxx-xxxx')
     do Process-XML-Tag-Content
   end-if

   if ltrim($AcctingResourceExtNo, ' ') <> '0'
     let $xml_tag      = 'PosteTel'
     let $xml_content  = ltrim($AcctingResourceExtNo, ' ')
     do Process-XML-Tag-Content
   end-if

   if rtrim($AcctingResourceLanguage, ' ') <> ''
     let $xml_tag      = 'Langue'
     let $xml_content  = $AcctingResourceLanguage
     do Process-XML-Tag-Content
   end-if

   if rtrim($AcctingResourceName, ' ') <> ''      or
      ltrim($AcctingResourceAreaCode, ' ') <> '0' or
      ltrim($AcctingResourcePhone, ' ') <> '0'    or
      ltrim($AcctingResourceExtNo, ' ') <> '0'    or
      rtrim($AcctingResourceLanguage, ' ') <> ''

     let $xml_tag      = 'Comptabilite'
     do Process-XML-Tag-End
   end-if

   let $RL1ApprovalNum = 'RQ-05-01-070'
   if rtrim($RL1ApprovalNum, ' ') <> ''
     let $xml_tag      = 'NoConcepteur'
     let $xml_content  = ltrim($RL1ApprovalNum, ' ')
     do Process-XML-Tag-Content
   end-if

   let $xml_tag      = 'P'
   do Process-XML-Tag-End

end-procedure


begin-procedure Write-Releve1-Record

  if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
  end-if

  add 1 to #RV1Count

  if $PrintGroupe = 'Y'
    let $xml_tag = 'Groupe01'
    do Process-XML-Tag-Beg
    let $PrintGroupe = 'N'
  end-if

  let $xml_tag      = $TypeData
  do Process-XML-Tag-Beg

  let $xml_tag      = 'Annee'
  let $xml_content  = $TaxYear
  do Process-XML-Tag-Content

  if ltrim($ReleveSlipNo, ' ') <> ''
    let $xml_tag      = 'NoReleve'
    let $xml_content  = ltrim($ReleveSlipNo,' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Employe'
  do Process-XML-Tag-Beg

  let $xml_tag      = 'NAS'
  let $xml_content  = rtrim($E_SIN, ' ')
  do Process-XML-Tag-Content

  if rtrim($EmplID, ' ') <> ''
    let $xml_tag      = 'No'
    let $xml_content  = rtrim($EmplID, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'NomFamille'
  let $E_LastName   = substr($E_LastName, 1, 30)
  let $xml_content  = rtrim($E_LastName, ' ')
  do Process-XML-Tag-Content

  let $xml_tag      = 'Prenom'
  let $E_FirstName  = substr($E_FirstName, 1, 30)
  let $xml_content  = rtrim($E_FirstName, ' ')
  do Process-XML-Tag-Content

  if rtrim($E_Initial, ' ') <> ''
    let $xml_tag      = 'Initiale'
    let $xml_content  = rtrim($E_Initial, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Adresse'
  do Process-XML-Tag-Beg

  if rtrim($E_AddrLine1, ' ') <> ''
    let $xml_tag      = 'Ligne1'
    let $E_AddrLine1  = substr($E_AddrLine1, 1, 30)
    let $xml_content  = rtrim($E_AddrLine1, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($E_AddrLine2, ' ') <> ''
    let $xml_tag      = 'Ligne2'
    let $E_AddrLine2  = substr($E_AddrLine2, 1, 30)
    let $xml_content  = rtrim($E_AddrLine2, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($E_City, ' ') <> ''
    let $xml_tag      = 'Ville'
    let $E_City       = substr($E_City, 1, 30)
    let $xml_content  = rtrim($E_City, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($E_Province, ' ') <> ''
    let $xml_tag      = 'Province'
    let $xml_content  = rtrim($E_Province, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($E_PostalCode, ' ') <> ''
    let $xml_tag      = 'CodePostal'
    let $xml_content  = rtrim($E_PostalCode, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Adresse'
  do Process-XML-Tag-End

  let $xml_tag      = 'Employe'
  do Process-XML-Tag-End

  let $xml_tag      = 'Montants'
  do Process-XML-Tag-Beg

  if ltrim($EmplIncome, ' ') <> ''
    let $xml_tag      = 'A_RevenuEmploi'
    let $xml_content  = ltrim($EmplIncome, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($QPPContrib, ' ') <> ''
    let $xml_tag      = 'B_CotisationRRQ'
    let $xml_content  = ltrim($QPPContrib, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($UICPremiums, ' ') <> ''
    let $xml_tag      = 'C_CotisationAssEmploi'
    let $xml_content  = ltrim($UICPremiums, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($RRPContrib, ' ') <> ''
    let $xml_tag      = 'D_CotisationRPA'
    let $xml_content  = ltrim($RRPContrib, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($QITWithheldSource, ' ') <> ''
    let $xml_tag      = 'E_ImpotQue'
    let $xml_content  = ltrim($QITWithheldSource, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($UnionDues, ' ') <> ''
    let $xml_tag      = 'F_CotisationSyndicale'
    let $xml_content  = ltrim($UnionDues, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($QPPPensEarns, ' ') <> ''
    let $xml_tag      = 'G_SalaireAdmisRRQ'
    let $xml_content  = ltrim($QPPPensEarns, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($MealsAndAccom, ' ') <> ''
    let $xml_tag      = 'H_NourritureLogement'
    let $xml_content  = ltrim($MealsAndAccom, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($AutoUse, ' ') <> ''
    let $xml_tag      = 'I_Vehicule'
    let $xml_content  = ltrim($AutoUse, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($HealthServPlan, ' ') <> ''
    let $xml_tag      = 'J_RegimeAssMaladie'
    let $xml_content  = ltrim($HealthServPlan, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($TripsToRemoteAreas, ' ') <> ''
    let $xml_tag      = 'K_Voyage'
    let $xml_content  = ltrim($TripsToRemoteAreas, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($OtherBenefits, ' ') <> ''
    let $xml_tag      = 'L_AutreAvantage'
    let $xml_content  = ltrim($OtherBenefits, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($Commissions, ' ') <> ''
    let $xml_tag      = 'M_Commission'
    let $xml_content  = ltrim($Commissions, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($CharitableDonatns, ' ') <> ''
    let $xml_tag      = 'N_DonBienfaisance'
    let $xml_content  = ltrim($CharitableDonatns, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($OtherTaxIncome, ' ') <> ''
    let $xml_tag      = 'O_AutreRevenu'
    let $xml_content  = ltrim($OtherTaxIncome, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($Code, ' ') <> ''
    let $xml_tag      = 'SourceCaseO'
    let $xml_content  = rtrim($Code, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($ContribMEInsPlan, ' ') <> ''
    let $xml_tag      = 'P_RegimeAssInterEntr'
    let $xml_content  = ltrim($ContribMEInsPlan, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($DefrdSalaryWages, ' ') <> ''
    let $xml_tag      = 'Q_SalaireDiffere'
    let $xml_content  = ltrim($DefrdSalaryWages, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($Indian, ' ') <> ''
    let $xml_tag      = 'R_RevenuIndien'
    let $xml_content  = ltrim($Indian, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($Tip, ' ') <> ''
    let $xml_tag      = 'S_PourboireRecu'
    let $xml_content  = ltrim($Tip, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($TipsAllocated, ' ') <> ''
    let $xml_tag      = 'T_PourboireAttribue'
    let $xml_content  = ltrim($TipsAllocated, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($PhasedRetire, ' ') <> ''
    let $xml_tag      = 'U_RetraiteProgressive'
    let $xml_content  = ltrim($PhasedRetire, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($CPPContrib, ' ') <> ''
    let $xml_tag      = 'CotisationRPC'
    let $xml_content  = ltrim($CPPContrib, ' ')
    do Process-XML-Tag-Content
  end-if

  if ltrim($DedForce, ' ') <> ''
    let $xml_tag      = 'DeductionForce'
    let $xml_content  = ltrim($DedForce, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Montants'
  do Process-XML-Tag-End

end-procedure


begin-procedure Initialize-Detail

  move ' '         to $EmplIncome
  move ' '         to $QPPContrib
  move ' '         to $CPPContrib
  move ' '         to $UICPremiums
  move ' '         to $RRPContrib
  move ' '         to $QITWithheldSource
  move ' '         to $UnionDues
  move ' '         to $MealsAndAccom
  move ' '         to $AutoUse
  move ' '         to $HealthServPlan
  move ' '         to $TripsToRemoteAreas
  move ' '         to $OtherBenefits
  move ' '         to $Commissions
  move ' '         to $CharitableDonatns
  move ' '         to $OtherTaxIncome
  move ' '         to $ContribMEInsPlan
  move ' '         to $DefrdSalaryWages
  move ' '         to $Indian
  move ' '         to $Tip
  move ' '         to $TipsAllocated
  move ' '         to $PhasedRetire
  move ' '         to $DedForce

  move ' '         to $Code

  move ' '         to $ReleveSlipNo
  move ' '         to $LastTransSlipNo
  move ' '         to $E_SIN
  move ' '         to $E_LastName
  move ' '         to $E_FirstName
  move ' '         to $E_Initial
  move ' '         to $E_AddrLine1
  move ' '         to $E_AddrLine2
  move ' '         to $E_City
  move ' '         to $E_Province
  move ' '         to $E_PostalCode
  move ' '         to $EmplID
  move ' '         to $QPPPensEarns
  move ' '         to $TipInd
  move ' '         to $SumEmplIncome
  move ' '         to $SumQPPContrib
  move ' '         to $SumCPPContrib
  move ' '         to $SumUICPremiums
  move ' '         to $SumRRPContrib
  move ' '         to $SumQITWithheldSource
  move ' '         to $SumUnionDues
  move ' '         to $SumQPPPensEarns
  move ' '         to $SumAutoUse
  move ' '         to $SumMealsAndAccom
  move ' '         to $SumHealthServPlan
  move ' '         to $SumTripsToRemoteAreas
  move ' '         to $SumOtherBenefits
  move ' '         to $SumCommissions
  move ' '         to $SumCharitableDonatns
  move ' '         to $SumOtherTaxIncome
  move ' '         to $SumContribMEInsPlan
  move ' '         to $SumDefrdSalaryWages
  move ' '         to $SumIndian
  move ' '         to $SumTip
  move ' '         to $SumTipsAllocated
  move ' '         to $SumPhasedRetire
  move ' '         to $SumDedForce

  move 0           to #BoxA
  move 0           to #BoxB
  move 0           to #DedForce

end-procedure


begin-procedure Write-RL-1-Data-Cancel

  if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
  end-if

  add 1 to #RV1Count

  if $PrintGroupe = 'Y'
    let $xml_tag = 'Groupe01'
    do Process-XML-Tag-Beg
    let $PrintGroupe = 'N'
  end-if

  let $xml_tag      = $TypeData
  do Process-XML-Tag-Beg

  let $xml_tag      = 'Annee'
  let $xml_content  = $TaxYear
  do Process-XML-Tag-Content

  if rtrim($ReleveSlipNo, ' ') <> ''
    let $xml_tag      = 'NoReleve'
    let $xml_content  = $ReleveSlipNo
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Employe'
  do Process-XML-Tag-Beg

  if rtrim($E_SIN, ' ') <> ''
    let $xml_tag      = 'NAS'
    let $xml_content  = $E_SIN
    do Process-XML-Tag-Content
  end-if

  if rtrim($E_LastName, ' ') <> ''
    let $xml_tag      = 'NomFamille'
    let $E_LastName   = substr($E_LastName,1,30)
    let $xml_content  = rtrim($E_LastName, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($E_FirstName, ' ') <> ''
    let $xml_tag      = 'Prenom'
    let $E_FirstName  = substr($E_FirstName,1,30)
    let $xml_content  = rtrim($E_FirstName, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Employe'
  do Process-XML-Tag-End

  let $xml_tag      = $TypeData
  do Process-XML-Tag-End

end-procedure


begin-procedure Write-RL-1-Data-Amend

  do Get-Original-Slip-No

  if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
  end-if

  do Write-Releve1-Record

  if rtrim($LastTransSlipNo, ' ') <> ''
    let $xml_tag      = 'NoReleveDerniereTrans'
    let $xml_content  = rtrim($LastTransSlipNo, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = $TypeData
  do Process-XML-Tag-End

end-procedure


begin-procedure Write-Summary-Record

 if #RV1Count > 0
  do Format-Number(#SumEmplIncome, $SumEmplIncome, '9999999999.99')
  do Format-Number(#SumQPPContrib, $SumQPPContrib, '9999999999.99')
  do Format-Number(#SumCPPContrib, $SumCPPContrib, '9999999999.99')
  do Format-Number(#SumUICPremiums, $SumUICPremiums, '9999999999.99')
  do Format-Number(#SumRRPContrib, $SumRRPContrib, '9999999999.99')
  do Format-Number(#SumQITWithheldSource, $SumQITWithheldSource, '9999999999.99')
  do Format-Number(#SumUnionDues, $SumUnionDues, '9999999999.99')
  if #SumQPPPensEarns = #SumEmplIncome
    let $SumQPPPensEarns = ' '
    let #SumQPPPensEarns = 0
  else
    let #SumQPPPensEarns = #SumBoxG
    do Format-Number(#SumQPPPensEarns, $SumQPPPensEarns, '9999999999.99')
  end-if
  do Format-Number(#SumMealsAndAccom,$SumMealsAndAccom,'9999999999.99')
  do Format-Number(#SumAutoUse, $SumAutoUse, '9999999999.99')
  do Format-Number(#SumHealthServPlan, $SumHealthServPlan, '9999999999.99')
  do Format-Number(#SumTripsToRemoteAreas, $SumTripsToRemoteAreas, '9999999999.99')
  do Format-Number(#SumOtherBenefits,$SumOtherBenefits,'9999999999.99')
  do Format-Number(#SumCommissions,$SumCommissions,'9999999999.99')
  do Format-Number(#SumCharitableDonatns,$SumCharitableDonatns,'9999999999.99')
  do Format-Number(#SumOtherTaxIncome,$SumOtherTaxIncome,'9999999999.99')
  do Format-Number(#SumContribMEInsPlan,$SumContribMEInsPlan,'9999999999.99')
  do Format-Number(#SumDefrdSalaryWages,$SumDefrdSalaryWages,'9999999999.99')
  do Format-Number(#SumIndian,$SumIndian,'9999999999.99')
  do Format-Number(#SumTip,$SumTip,'9999999999.99')
  do Format-Number(#SumTipsAllocated, $SumTipsAllocated,'9999999999.99')
  do Format-Number(#SumPhasedRetire, $SumPhasedRetire, '9999999999.99')
  do Format-Number(#SumDedForce , $SumDedForce , '9999999999.99')

  do Format-Number(#RV1Count, $RV1Count, '999999999')

  move &CT.Descr to $CompanyName
  move $CompnyAdd1 to $C_Street1
  move $CompnyADD2 to $C_Street2
  move $CompnyCity to $C_City
  let $C_Province = rtrim(&CT.State, ' ')
  move &CT.Country to $C_Country

  move &CT.Postal to $PostalCd
  do Check-Postal-Code
  move $PostalCd to $C_PostalCode

  let $ID_Employer       = substr($ReportingID, 1, 10)
  let $File_Num_Employer = substr($ReportingID, 13, 4)


  let $xml_tag      = 'T'
  do Process-XML-Tag-Beg

  let $xml_tag      = 'Annee'
  let $xml_content  = $TaxYear
  do Process-XML-Tag-Content

  let $xml_tag      = 'NbReleves'
  let $xml_content  = ltrim($RV1Count, ' ')
  do Process-XML-Tag-Content

  let $xml_tag      = 'Employeur'
  do Process-XML-Tag-Beg

  if rtrim($ID_Employer, ' ') <> ''
    let $xml_tag      = 'NoId'
    let $xml_content  = rtrim($ID_Employer, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'TypeDossier'
  let $xml_content  = 'RS'
  do Process-XML-Tag-Content

  if rtrim($File_Num_Employer, ' ') <> ''
    let $xml_tag      = 'NoDossier'
    let $xml_content  = rtrim($File_Num_Employer, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($NEQ, ' ') <> ''
    let $xml_tag      = 'NEQ'
    let $xml_content  = rtrim($NEQ, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($CompanyName, ' ') <> ''
    let $xml_tag      = 'Nom1'
    let $CompanyName  = substr($CompanyName, 1, 30)
    let $xml_content  = rtrim($CompanyName, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Adresse'
  do Process-XML-Tag-Beg

  if rtrim($C_Street1, ' ') <> ''
    let $xml_tag      = 'Ligne1'
    let $C_Street1    = substr($C_Street1, 1, 30)
    let $xml_content  = rtrim($C_Street1, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($C_Street2, ' ') <> ''
    let $xml_tag      = 'Ligne2'
    let $C_Street2    = substr($C_Street2, 1, 30)
    let $xml_content  = rtrim($C_Street2, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($C_City, ' ') <> ''
    let $xml_tag      = 'Ville'
    let $C_City       = substr($C_City, 1, 30)
    let $xml_content  = rtrim($C_City, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($C_Province, ' ') <> ''
    let $xml_tag      = 'Province'
    let $xml_content  = rtrim($C_Province, ' ')
    do Process-XML-Tag-Content
  end-if

  if rtrim($C_PostalCode, ' ') <> ''
    let $xml_tag      = 'CodePostal'
    let $xml_content  = rtrim($C_PostalCode, ' ')
    do Process-XML-Tag-Content
  end-if

  let $xml_tag      = 'Adresse'
  do Process-XML-Tag-End

  let $xml_tag      = 'Employeur'
  do Process-XML-Tag-End

  if #SumEmplIncome  > 0           or
     #SumQPPContrib  > 0           or
     #SumUICPremiums > 0           or
     #SumRRPContrib  > 0           or
     #SumQITWithheldSource > 0     or
     #SumUnionDues         > 0     or
     #SumQPPPensEarns      > 0     or
     #SumMealsAndAccom     > 0     or
     #SumAutoUse           > 0     or
     #SumHealthServPlan    > 0     or
     #SumTripsToRemoteAreas > 0    or
     #SumOtherBenefits     > 0     or
     #SumCommissions       > 0     or
     #SumCharitableDonatns > 0     or
     #SumOtherTaxIncome    > 0     or
     #SumContribMEInsPlan  > 0     or
     #SumDefrdSalaryWages  > 0     or
     #SumIndian            > 0     or
     #SumTip               > 0     or
     #SumTipsAllocated     > 0     or
     #SumPhasedRetire      > 0     or
     #SumCPPContrib        > 0     or
     #SumDedForce          > 0


    let $xml_tag      = 'Montants'
    do Process-XML-Tag-Beg

    if #SumEmplIncome   > 0
      let $xml_tag      = 'A_RevenuEmploi'
      let $xml_content  = ltrim($SumEmplIncome, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumQPPContrib   > 0
      let $xml_tag      = 'B_CotisationRRQ'
      let $xml_content  = ltrim($SumQPPContrib, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumUICPremiums  > 0
      let $xml_tag      = 'C_CotisationAssEmploi'
      let $xml_content  = ltrim($SumUICPremiums, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumRRPContrib   > 0
      let $xml_tag      = 'D_CotisationRPA'
      let $xml_content  = ltrim($SumRRPContrib, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumQITWithheldSource   > 0
      let $xml_tag      = 'E_ImpotQue'
      let $xml_content  = ltrim($SumQITWithheldSource, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumUnionDues    > 0
      let $xml_tag      = 'F_CotisationSyndicale'
      let $xml_content  = ltrim($SumUnionDues, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumQPPPensEarns > 0
      let $xml_tag      = 'G_SalaireAdmisRRQ'
      let $xml_content  = ltrim($SumQPPPensEarns, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumMealsAndAccom > 0
      let $xml_tag      = 'H_NourritureLogement'
      let $xml_content  = ltrim($SumMealsAndAccom, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumAutoUse      > 0
      let $xml_tag      = 'I_Vehicule'
      let $xml_content  = ltrim($SumAutoUse, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumHealthServPlan > 0
      let $xml_tag      = 'J_RegimeAssMaladie'
      let $xml_content  = ltrim($SumHealthServPlan, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumTripsToRemoteAreas > 0
      let $xml_tag      = 'K_Voyage'
      let $xml_content  = ltrim($SumTripsToRemoteAreas, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumOtherBenefits > 0
      let $xml_tag      = 'L_AutreAvantage'
      let $xml_content  = ltrim($SumOtherBenefits, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumCommissions  > 0
      let $xml_tag      = 'M_Commission'
      let $xml_content  = ltrim($SumCommissions, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumCharitableDonatns > 0
      let $xml_tag      = 'N_DonBienfaisance'
      let $xml_content  = ltrim($SumCharitableDonatns, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumOtherTaxIncome > 0
      let $xml_tag      = 'O_AutreRevenu'
      let $xml_content  = ltrim($SumOtherTaxIncome, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumContribMEInsPlan > 0
      let $xml_tag      = 'P_RegimeAssInterEntr'
      let $xml_content  = ltrim($SumContribMEInsPlan, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumDefrdSalaryWages > 0
      let $xml_tag      = 'Q_SalaireDiffere'
      let $xml_content  = ltrim($SumDefrdSalaryWages, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumIndian       > 0
      let $xml_tag      = 'R_RevenuIndien'
      let $xml_content  = ltrim($SumIndian, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumTip          > 0
      let $xml_tag      = 'S_PourboireRecu'
      let $xml_content  = ltrim($SumTip, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumTipsAllocated > 0
      let $xml_tag      = 'T_PourboireAttribue'
      let $xml_content  = ltrim($SumTipsAllocated, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumPhasedRetire > 0
      let $xml_tag      = 'U_RetraiteProgressive'
      let $xml_content  = ltrim($SumPhasedRetire, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumCPPContrib   > 0
      let $xml_tag      = 'CotisationRPC'
      let $xml_content  = ltrim($SumCPPContrib, ' ')
      do Process-XML-Tag-Content
    end-if

    if #SumDedForce > 0
      let $xml_tag      = 'DeductionForce'
      let $xml_content  = ltrim($SumDedForce, ' ')
      do Process-XML-Tag-Content
    end-if


    let $xml_tag      = 'Montants'
    do Process-XML-Tag-End

  end-if

  let $xml_tag      = 'T'
  do Process-XML-Tag-End

  let $xml_tag      = 'Groupe01'
  do Process-XML-Tag-End

  do Print-Summary-Data
  do Initialize-Summary
  let $Error-Report = 'N'

 end-if

end-procedure


begin-procedure Initialize-Summary

   move 0 to #SumEmplIncome
   move 0 to #SumQPPContrib
   move 0 to #SumCPPContrib
   move 0 to #SumUICPremiums
   move 0 to #SumRRPContrib
   move 0 to #SumQITWithheldSource
   move 0 to #SumUnionDues
   move 0 to #SumQPPPensEarns
   move 0 to #SumBoxG
   move 0 to #SumMealsAndAccom
   move 0 to #SumAutoUse
   move 0 to #SumHealthServPlan
   move 0 to #SumTripsToRemoteAreas
   move 0 to #SumOtherBenefits
   move 0 to #SumCommissions
   move 0 to #SumCharitableDonatns
   move 0 to #SumOtherTaxIncome
   move 0 to #SumContribMEInsPlan
   move 0 to #SumDefrdSalaryWages
   move 0 to #SumIndian
   move 0 to #SumTip
   move 0 to #SumTipsAllocated
   move 0 to #SumPhasedRetire
   move 0 to #SumDedForce

   move 0  to #RV1Count

   move ' ' to $ReportingID
   move ' ' to $RV1Count
   move ' ' to $CompanyName
   move ' ' to $C_Street1
   move ' ' to $C_Street2
   move ' ' to $C_City
   move ' ' to $C_Province
   move ' ' to $C_Country
   move ' ' to $C_PostalCode
   move ' ' to $NEQ
   move ' ' to $ID_Employer
   move ' ' to $File_Num_Employer

end-procedure


begin-procedure Get-Original-Slip-No

begin-SELECT

OS.RELEVE_SLIP_NO

  move &OS.Releve_Slip_No to $LastTransSlipNo

FROM PS_CAN_YE_SLIP OS
WHERE OS.COMPANY         = &S.COMPANY
  AND OS.EMPLID          = &S.EMPLID
  AND OS.CALENDAR_YEAR   = &S.CALENDAR_YEAR
  AND OS.TAXFORM_ID      = &S.TAXFORM_ID
  AND OS.YE_SLIP_PROCESS <> 'D'
  AND OS.SEQUENCE_NUMBER =
      (SELECT MAX(OS1.SEQUENCE_NUMBER)
         FROM PS_CAN_YE_SLIP OS1
         WHERE OS1.COMPANY = OS.COMPANY
           AND OS1.EMPLID  = OS.EMPLID
           AND OS1.CALENDAR_YEAR = OS.CALENDAR_YEAR
           AND OS1.TAXFORM_ID    = OS.TAXFORM_ID
           AND OS1.YE_SLIP_PROCESS <> 'D'
           AND OS1.SEQUENCE_NUMBER < &S.SEQUENCE_NUMBER)

end-SELECT

end-procedure


begin-procedure Process-XML-Tag-Content

   let $xml_content   = replace($xml_content, '&',  '&amp;')
   let $xml_content   = replace($xml_content, '"',  '&quot;')
   let $xml_content   = replace($xml_content, '<',  '&lt;')
   let $xml_content   = replace($xml_content, '>',  '&gt;')
   let $xml_content   = replace($xml_content, '''', '&apos;')


   let $xml_content   = ltrim($xml_content, ' ')
   let $xml_content   = rtrim($xml_content, ' ')

   let $xml_output_line = ''
   let $xml_output_line = $xml_cntrl_begin || $xml_tag || $xml_cntrl_end  || $xml_content
                || $xml_cntrl_begin || $xml_tag_end || $xml_tag || $xml_cntrl_end
   write 10 from $xml_output_line


   if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
   end-if

   if $FileType = 'D'
     write 20 from $xml_output_line
     add 1 to #RecordCount
   end-if

end-procedure


begin-procedure Process-XML-Tag-Beg

   let $xml_output_line = ''
   let $xml_output_line = $xml_cntrl_begin || $xml_tag|| $xml_cntrl_end
   write 10 from $xml_output_line

   if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
   end-if

   if $FileType = 'D'
     write 20 from $xml_output_line
     add 1 to #RecordCount
   end-if

end-procedure


begin-procedure Process-XML-Tag-End

  let $xml_output_line = ''
  let $xml_output_line = $xml_cntrl_begin || $xml_tag_end || $xml_tag|| $xml_cntrl_end
  write 10 from $xml_output_line

  if $FileType = 'D'
     if #RecordCount >= #MaxRecordsPerDiskette
        do Open-File
     end-if
  end-if

  if $FileType = 'D'
    write 20 from $xml_output_line
    add 1 to #RecordCount
  end-if

end-procedure


begin-procedure Check-RL-Slip-Exists

  let $RL-Slip-Exists = 'N'

begin-SELECT
'X'

  let $RL-Slip-Exists = 'Y'
  exit-SELECT

FROM PS_CAN_YE_SLIP C
WHERE C.CALENDAR_YEAR = &TX.Balance_Year
AND   C.TAXFORM_ID = 'R'
AND   C.SEQUENCE_NUMBER = (SELECT MAX(C1.SEQUENCE_NUMBER)
                            FROM PS_CAN_YE_SLIP C1
                            WHERE C1.COMPANY         = C.COMPANY
                              AND C1.EMPLID          = C.EMPLID
                              AND C1.CALENDAR_YEAR   = C.CALENDAR_YEAR
                              AND C1.YE_SLIP_PROCESS = C.YE_SLIP_PROCESS)
AND C.YE_SLIP_PROCESS = $Proc_Type

end-SELECT
end-procedure


begin-procedure Count-ReportingID-Numbers

  move 0     to #SummaryCounter
  move 'xxx' to $PriorID

begin-SELECT

SL.REPORTING_ID

  if rtrim(&SL.Reporting_ID, ' ') <> rtrim($PriorID, ' ')
     add 1 to #SummaryCounter
     move &SL.Reporting_ID to $PriorID
  end-if

FROM PS_CAN_YE_SLIP SL
WHERE SL.TAXFORM_ID = 'R'
AND   SL.CALENDAR_YEAR = &TX.Balance_Year
AND   SL.SEQUENCE_NUMBER = (SELECT MAX(SL1.SEQUENCE_NUMBER)
               FROM PS_CAN_YE_SLIP SL1
               WHERE SL1.COMPANY       = SL.COMPANY
                 AND SL1.EMPLID        = SL.EMPLID
                 AND SL1.CALENDAR_YEAR = SL.CALENDAR_YEAR
#ifdef MVS
  \$seq_number2\
#else
  [$seq_number2]
#endif
#ifdef MVS
  \$ye_slip_process2\
#else
  [$ye_slip_process2]
#endif
ORDER BY SL.REPORTING_ID ASC

end-SELECT

end-procedure


begin-procedure Convert-Parameters

  move $RC_CAN_YE.RV_Rpt_Medium to $FileType

  if $RC_CAN_YE.RV_Rpt_Medium = 'D'
        move $RC_CAN_YE.Diskette_Type    to $DisketteType
  end-if

  move $RC_CAN_YE.RL1_File_Proc_Type     to $Proc_Type

  evaluate $Proc_Type
  when = 'A'
    let $ye_slip_process = ' AND S.YE_SLIP_PROCESS = ''A'' '
    let $ye_slip_process2 = ' AND SL.YE_SLIP_PROCESS = ''A'' '
    let $seq_number      = ')'
    let $seq_number2     = ')'
    let $TypeData        = 'A'
    break
  when = 'C'
    let $ye_slip_process = ' AND S.YE_SLIP_PROCESS = ''C'' '
    let $ye_slip_process2 = ' AND SL.YE_SLIP_PROCESS = ''C'' '
    let $seq_number      = ')'
    let $seq_number2     = ')'
    let $TypeData        = 'D'
    break
  when = 'O'
    let $ye_slip_process = ' AND S.YE_SLIP_PROCESS = ''O'' '
    let $ye_slip_process2 = ' AND SL.YE_SLIP_PROCESS = ''O'' '
    let $seq_number      = ' AND S1.YE_SLIP_PROCESS = S.YE_SLIP_PROCESS) '
    let $seq_number2     = ' AND SL1.YE_SLIP_PROCESS = SL.YE_SLIP_PROCESS) '
    let $TypeData        = 'R'
    break
  end-evaluate

  if $Proc_Type = 'A' or $Proc_Type = 'C'
    let $Proc_Amend_Cancel = 'Y'
  else
    let $StatusOpen = 'Y'
  end-if

end-procedure


begin-procedure Print-Summary-Data

  if $Error-Report = 'Y'
    new-page
  end-if

  move 'T' to $TypeCode

  do Format-Number(#SumEmplIncome, $SumEmplIncome, '9999999999999.99')
  do Format-Number(#SumQPPContrib, $SumQPPContrib, '9999999999999.99')
  do Format-Number(#SumCPPContrib, $SumCPPContrib, '9999999999999.99')
  do Format-Number(#SumUICPremiums, $SumUICPremiums, '9999999999999.99')
  do Format-Number(#SumRRPContrib, $SumRRPContrib, '9999999999999.99')
  do Format-Number(#SumQITWithheldSource, $SumQITWithheldSource, '9999999999999.99')
  do Format-Number(#SumUnionDues, $SumUnionDues, '9999999999999.99')
  do Format-Number(#SumQPPPensEarns, $SumQPPPensEarns, '9999999999999.99')
  do Format-Number(#SumMealsAndAccom,$SumMealsAndAccom,'9999999999999.99')
  do Format-Number(#SumAutoUse, $SumAutoUse, '9999999999999.99')
  do Format-Number(#SumHealthServPlan, $SumHealthServPlan, '9999999999999.99')
  do Format-Number(#SumTripsToRemoteAreas , $SumTripsToRemoteAreas , '9999999999999.99')
  do Format-Number(#SumOtherBenefits,$SumOtherBenefits,'9999999999999.99')
  do Format-Number(#SumCommissions,$SumCommissions,'9999999999999.99')
  do Format-Number(#SumCharitableDonatns,$SumCharitableDonatns,'9999999999999.99')
  do Format-Number(#SumOtherTaxIncome,$SumOtherTaxIncome,'9999999999999.99')
  do Format-Number(#SumContribMEInsPlan,$SumContribMEInsPlan,'9999999999999.99')
  do Format-Number(#SumDefrdSalaryWages,$SumDefrdSalaryWages,'9999999999999.99')
  do Format-Number(#SumIndian,$SumIndian,'9999999999999.99')
  do Format-Number(#SumTip,$SumTip,'9999999999999.99')
  do Format-Number(#SumTipsAllocated, $SumTipsAllocated,'9999999999999.99')
  do Format-Number(#SumPhasedRetire, $SumPhasedRetire, '9999999999999.99')
  do Format-Number(#SumDedForce, $SumDedForce, '9999999999999.99')

  do Format-Number(#RV1Count, $RV1Count, '9999999')

     print    $CTX910RM_summary_data                    (+1,1)
     print    $CTX910RM_type_code                       (+1,1)
     print    $TypeCode                                 (0,80)
     print    $CTX910RM_total_slips                     (+1,1)
     print    $RV1Count                                 (0,80)
     print    $CTX910RM_total_box_A                     (+1,1)
     print    $SumEmplIncome                            (0,80)
     print    $CTX910RM_total_box_B                     (+1,1)
     print    $SumQPPContrib                            (0,80)
     print    $CTX910RM_total_box_C                     (+1,1)
     print    $SumUICPremiums                           (0,80)
     print    $CTX910RM_total_box_D                     (+1,1)
     print    $SumRRPContrib                            (0,80)
     print    $CTX910RM_total_box_E                     (+1,1)
     print    $SumQITWithheldSource                     (0,80)
     print    $CTX910RM_total_box_F                     (+1,1)
     print    $SumUnionDues                             (0,80)
     print    $CTX910RM_total_box_G                     (+1,1)
     print    $SumQPPPensEarns                          (0,80)
     print    $CTX910RM_total_box_H                     (+1,1)
     print    $SumMealsAndAccom                         (0,80)
     print    $CTX910RM_total_box_I                     (+1,1)
     print    $SumAutoUse                               (0,80)
     print    $CTX910RM_total_box_J                     (+1,1)
     print    $SumHealthServPlan                        (0,80)
     print    $CTX910RM_total_box_K                     (+1,1)
     print    $SumTripsToRemoteAreas                    (0,80)
     print    $CTX910RM_total_box_L                     (+1,1)
     print    $SumOtherBenefits                         (0,80)
     print    $CTX910RM_total_box_M                     (+1,1)
     print    $SumCommissions                           (0,80)
     print    $CTX910RM_total_box_N                     (+1,1)
     print    $SumCharitableDonatns                     (0,80)
     print    $CTX910RM_total_box_O                     (+1,1)
     print    $SumOtherTaxIncome                        (0,80)
     print    $CTX910RM_total_box_P                     (+1,1)
     print    $SumContribMEInsPlan                      (0,80)
     print    $CTX910RM_total_box_Q                     (+1,1)
     print    $SumDefrdSalaryWages                      (0,80)
     print    $CTX910RM_total_box_R                     (+1,1)
     print    $SumIndian                                (0,80)
     print    $CTX910RM_total_box_S                     (+1,1)
     print    $SumTip                                   (0,80)
     print    $CTX910RM_total_box_T                     (+1,1)
     print    $SumTipsAllocated                         (0,80)
     print    $CTX910RM_total_box_U                     (+1,1)
     print    $SumPhasedRetire                          (0,80)
     print    $CTX910RM_total_CPP_contr                 (+1,1)
     print    $SumCPPContrib                            (0,80)
     print    $CTX910RM_total_ded_force                 (+1,1)
     print    $SumDedForce                              (0,80)

     new-page

end-procedure


begin-procedure Check-Postal-Code

  find ' ' in $PostalCd 0 #space_loc
  if #space_loc > 0 and #space_loc < 5
     let $Postal1 = substr($PostalCd, 1, #space_loc)
     let #start = #space_loc + 2
     let $Postal2 = substr($PostalCd, #start, 3)
     let $PostalCd = $Postal1 || $Postal2
  end-if

end-procedure


begin-procedure Check-Status

  move 'N' to $StatusOpen

begin-SELECT
CS.EMPLID

  move 'Y' to $StatusOpen

FROM PS_CAN_AMEND_RL1_S CS
WHERE CS.COMPANY         = &S.COMPANY
  AND CS.EMPLID          = &S.EMPLID
  AND CS.CALENDAR_YEAR   = &S.CALENDAR_YEAR
  AND CS.SEQUENCE_NUMBER = &S.SEQUENCE_NUMBER
  AND CS.WAGE_LOSS_PLAN  = &S.WAGE_LOSS_PLAN
  AND CS.PROVINCE        = &S.PROVINCE
  AND CS.AMEND_STATUS    = 'O'

end-SELECT

end-procedure


begin-procedure Error-Report

  let $EmployeeId = rtrim(&E.Emplid, ' ')
  print $CTX910RM_negative_value_fnd           (+2,1)
  print $EmployeeId                            (0,+1)
  print $CTX910RM_no_rl1_rec_created           (0,+1)

  let $Error-Report = 'Y'
end-procedure


begin-procedure Rotate-Name-for-Mag-Media
  move '' to $Suffix
  move 'N' to $SuffixFound

  let $SuffixString =
    'JR.,JR,SR.,SR,III,II,I,IV,MD,M.D.,CPA,C.P.A.,ESQ.,ESQ,' ||
    '2ND.,2ND,SECOND,3RD.,3RD,THIRD,4TH.,4TH,FOURTH'

  let $Name = rtrim($Name,' ')
  find ',' in $Name 0 #locn
  let $LastName = SUBSTR($Name,1,#locn + 1)
  find ' ' in $LastName 0 #locnblank
  if #locnblank <> -1
    let #i = 1
    while INSTR($SuffixString,',',#i) > 0
      let #j = INSTR($SuffixString,',',#i)
      let $Suffix = SUBSTR($SuffixString,#i,#j - #i)

      let #locnsuffix = INSTR($LastName, $Suffix || ',', 1)
      if #locnsuffix > 0
        let $LastName = SUBSTR($LastName,1,#locnsuffix - 2)
        move 'Y' to $SuffixFound
      end-if
  let #i = #j + 1
      if $SuffixFound = 'Y'
        break
      end-if
    end-while
  end-if

  add 1 to #locn
  extract $FirstName from $Name #locn 40  !40 is the maximum length of Name

  if $Remove_Blanks_From_Surname = 'Y'
    while INSTR($LastName,' ',1)
      let #locnblank = INSTR($LastName,' ',1)
      let $LastName = SUBSTR($LastName,1,#locnblank - 1)   ||
                      SUBSTR($LastName,#locnblank + 1,40)
    end-while
    while INSTR($LastName,'-',1)
      let #locndash = INSTR($LastName,'-',1)
      let $LastName = SUBSTR($LastName,1,#locndash - 1)   ||
                      SUBSTR($LastName,#locndash + 1,40)
    end-while
    while INSTR($LastName,'.',1)
      let #locnper = INSTR($LastName,'.',1)
      let $LastName = SUBSTR($LastName,1,#locnper - 1)   ||
                      SUBSTR($LastName,#locnper + 1,40)
    end-while
    while INSTR($LastName,'''',1)
      let #locnhyphen = INSTR($LastName,'''',1)
      let $LastName = SUBSTR($LastName,1,#locnhyphen - 1)   ||
                      SUBSTR($LastName,#locnhyphen + 1,40)
    end-while
  end-if

  if $SuffixFound <> 'Y'

   let $Name = SUBSTR($LastName,1,LENGTH($LastName) - 1) || '  ' || $FirstName
  else
     let $Name = $LastName || '  ' || $FirstName
 end-if
end-procedure


begin-procedure Rotate-Name
  move '' to $Suffix
  move 'N' to $SuffixFound

  let $SuffixString =
    'JR.,JR,SR.,SR,III,II,I,IV,MD,M.D.,CPA,C.P.A.,ESQ.,ESQ,' ||
    '2ND.,2ND,SECOND,3RD.,3RD,THIRD,4TH.,4TH,FOURTH,PHD,PHD.,P.H.D.'

  let $Name = rtrim($Name,' ')
  let $Sufsw = 'N'
  Unstring $Name by ' ' into $LastN $MidI $FirstN $Suf1 $Suf2
  let $CommaFound = 'N'
  let #k = 1
  while INSTR($MidI,',',#k) > 0
    let #l = INSTR($MidI,',',#k)
    move 'Y' to $CommaFound
    let #k = #l + 1
  end-while

  if $CommaFound = 'Y'
    Unstring $Name by ' ' into $LastN $FirstN $Suf1 $Suf2
  end-if

  if $Suf2 <> ''
     let $Suftest = $Suf2
     let $Sufsw = 'Y'
     do Test-Suffix
     let $Suf2 = $Suftest
  end-if

  if $Suf1 <> '' and $Sufsw = 'N'
     let $Suftest = $Suf1
     let $Sufsw = 'Y'
     do Test-Suffix
     let $Suf1 = $Suftest
  end-if

  if $LastN <> '' and $Sufsw = 'N'
     let $Suftest = $LastN
     let $Sufsw = 'Y'
     do Test-Suffix
     let $LastN = $Suftest
  end-if

  String $LastN $FirstN  by '  ' into $Name
end-procedure

begin-procedure Test-Suffix
  let #i = 1
  while INSTR($SuffixString,',',#i) > 0
    let #j = INSTR($SuffixString,',',#i)
    let $Suffix = SUBSTR($SuffixString,#i,#j - #i)
    let #locnsuffix = INSTR($SufTest, $Suffix, 1)

    if #locnsuffix > 0
      if $SufTest = $Suffix
         move ' ' to $SufTest
         move 'Y' to $SuffixFound
      end-if
    end-if

    let #i = #j + 1
    if $SuffixFound = 'Y'
       break
    end-if
  end-while
end-procedure


#Include 'getcodta.sqc'  !Get-Company-Data procedure
#Include 'datetime.sqc'  !Routines for date and time formatting
#Include 'number.sqc'    !Routines to format numbers
#Include 'getfrmat.sqc'  !Get-Diskette-Format procedure
#Include 'curdttim.sqc'  !Get-Current-DateTime procedure
#ifdef PRCSSCHD
#Include 'ctxrctl1.sqc'  !Get-Canadian-Year-End Parameters
#Include 'stdapi.sqc'    !Update Process API
#Include 'sqrtrans.sqc'  !Translate SQR strings to given language
#Include 'getrplng.sqc'  !Get the Report language
#Include 'txrnctl1.sqc'  !Process Scheduler Run Controls
#endif

